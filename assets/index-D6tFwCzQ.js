(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=t(i);fetch(i.href,r)}})();const f={WOOD:"WOOD",WHEAT:"WHEAT",BRICK:"BRICK",GLASS:"GLASS",STONE:"STONE",NONE:"NONE"},J={COTTAGE:"COTTAGE",TAVERN:"TAVERN",BARRETT_CASTLE:"BARRETT_CASTLE"};class Ls{grid;size=4;metadata=new Map;constructor(){this.grid=Array(this.size).fill(null).map(()=>Array(this.size).fill(f.NONE))}place(e,t,s){if(!this.isValid(e,t))throw new Error(`Invalid coordinate: ${e}, ${t}`);if(this.grid[e][t]!==f.NONE)throw new Error("Spot already occupied");this.grid[e][t]=s}placeBuilding(e,t,s){this.isValid(e,t)&&(this.grid[e][t]=s)}constructBuilding(e,t,s,i){if(!e.some(o=>o.row===t&&o.col===s)&&this.grid[t][s]!=="NONE")throw new Error("Building must be placed on one of the pattern squares.");this.clear(e),this.grid[t][s]=i}clear(e){e.forEach(({row:t,col:s})=>{this.isValid(t,s)&&(this.grid[t][s]=f.NONE,this.metadata.delete(`${t},${s}`))})}getGrid(){return this.grid.map(e=>[...e])}isValid(e,t){return e>=0&&e<this.size&&t>=0&&t<this.size}remove(e,t){this.isValid(e,t)&&(this.grid[e][t]="NONE",this.metadata.delete(`${e},${t}`))}setMetadata(e,t,s){this.metadata.set(`${e},${t}`,s)}getMetadata(e,t){return this.metadata.get(`${e},${t}`)}}class uo{static rotate(e){return e[0].map((t,s)=>e.map(i=>i[s]).reverse())}static flip(e){return e.map(t=>[...t].reverse())}static getSymmetries(e){const t=new Set;let s=e;for(let i=0;i<4;i++)t.add(JSON.stringify(s)),t.add(JSON.stringify(this.flip(s))),s=this.rotate(s);return Array.from(t).map(i=>JSON.parse(i))}static findMatches(e,t,s){const i=this.getSymmetries(t.pattern),r=[];for(const o of i){const a=o.length,l=o[0].length;for(let c=0;c<=4-a;c++)for(let d=0;d<=4-l;d++)this.isMatch(e,o,c,d,s)&&r.push({row:c,col:d,pattern:o})}return r}static isMatch(e,t,s,i,r){return t.every((o,a)=>o.every((l,c)=>{const d=s+a,u=i+c,h=e[d][u];if(l==="NONE"||h===l||h&&h.toUpperCase().replace("_"," ")==="TRADING POST")return!0;if(r){const p=`${d},${u}`,m=r instanceof Map?r.get(p):r[p];if(m&&m.storedResource===l)return!0}return!1}))}}class fo{static calculateScore(e,t,s,i,r=0){const l={},c=C=>s.find(x=>x.name.toUpperCase()===C.toUpperCase()),d={};let u=0,h=0;const p=new Set;for(let C=0;C<4;C++)for(let x=0;x<4;x++){const H=e[C][x];if(!this.isBuilding(H)){u++;continue}d[H]=(d[H]||0)+1;const Q=c(H);if(Q&&Q.feeder){const X=Q.feeder.getFedPositions(C,x,e);X.length>0&&X[0].r===-1?h+=X.length:X.forEach(j=>p.add(`${j.r},${j.c}`))}}const m=new Set;let _=0;for(let C=0;C<4;C++)for(let x=0;x<4;x++){const H=e[C][x];if(!this.isBuilding(H))continue;const Q=c(H);if(Q&&Q.feedCost){const X=`${C},${x}`;let j=!1;p.has(X)?j=!0:h>=Q.feedCost&&(h-=Q.feedCost,j=!0),j&&(m.add(X),H===J.COTTAGE&&_++,H===J.BARRETT_CASTLE&&(_+=2))}}const E=s.map(C=>C.name);for(let C=0;C<4;C++)for(let x=0;x<4;x++){const H=e[C][x];if(!this.isBuilding(H))continue;const Q=c(H);if(Q){if(Q.scorer){const X={grid:e,row:C,col:x,counts:d,fedState:m.has(`${C},${x}`),metadata:t,validBuildingNames:E,allFedPositions:m,registry:s,fedCottageCount:_,finishRank:i,rightNeighborFeastHallCount:r},j=Q.scorer.score(X);l[H]=(l[H]||0)+j}if(H.toUpperCase()==="WAREHOUSE"){const X=`${C},${x}`,j=t instanceof Map?t.get(X):t[X];if(j&&j.storedResources&&Array.isArray(j.storedResources)){const ho=j.storedResources.length;l[H]=(l[H]||0)-ho}}}}if(d[J.TAVERN]){const C=[0,2,5,9,14,20],x=Math.min(d[J.TAVERN],5);l[J.TAVERN]=C[x]}let R=0;Object.values(l).forEach(C=>R+=C);const L=(d.CATHEDRAL||0)>0?0:u;return{total:R-L,breakdown:l,penaltyCount:L}}static isBuilding(e){return!["NONE","WOOD","WHEAT","BRICK","GLASS","STONE"].includes(e)}}class de{points;requiresFood;constructor(e,t=!1){this.points=e,this.requiresFood=t}score(e){return this.requiresFood&&!e.fedState?0:this.points}}class po{targetTypes;pointsPerNeighbor;constructor(e,t){this.targetTypes=e,this.pointsPerNeighbor=t}score(e){let t=0;const s=[[-1,0],[1,0],[0,-1],[0,1]];for(const[i,r]of s){const o=e.row+i,a=e.col+r;if(o>=0&&o<4&&a>=0&&a<4){const l=e.grid[o][a];this.targetTypes.includes(l)&&(t+=this.pointsPerNeighbor)}}return t}}class mo{score(e){const t=new Set;for(let s=0;s<4;s++)s!==e.col&&this.addIfBuilding(t,e.grid[e.row][s]);for(let s=0;s<4;s++)s!==e.row&&this.addIfBuilding(t,e.grid[s][e.col]);return t.size}addIfBuilding(e,t){["NONE","WOOD","WHEAT","BRICK","GLASS","STONE"].includes(t)||e.add(t)}}class go{score(e){let t=0;return Object.values(e.counts).forEach(s=>{s===1&&(t+=1)}),t}}class _o{multiplier;constructor(e){this.multiplier=e}score(e){const t=new Set,s=[[-1,0],[1,0],[0,-1],[0,1]],i=["NONE","WOOD","WHEAT","BRICK","GLASS","STONE"];for(const[r,o]of s){const a=e.row+r,l=e.col+o;if(a>=0&&a<4&&l>=0&&l<4){const c=e.grid[a][l];i.includes(c)||t.add(c)}}return t.size*this.multiplier}}class yo{score(e){const t=`${e.row},${e.col}`,s=e.metadata.get(t);return s&&s.savedScore||0}}class Eo{score(e){let t=0;for(const s of e.validBuildingNames){const i=s.toUpperCase();e.counts[i]||t++}return t*2}}class Co{score(e){let t=0;const s=new Set,i=["NONE","WOOD","WHEAT","BRICK","GLASS","STONE"],r=[[-1,0],[1,0],[0,-1],[0,1]];for(let o=0;o<4;o++)for(let a=0;a<4;a++){const l=`${o},${a}`,c=e.grid[o][a];if(s.has(l)||i.includes(c))continue;let d=0;const u=[{r:o,c:a}];for(s.add(l);u.length>0;){const h=u.pop();d++;for(const[p,m]of r){const _=h.r+p,E=h.c+m,R=`${_},${E}`;_>=0&&_<4&&E>=0&&E<4&&!s.has(R)&&e.grid[_][E]===c&&(s.add(R),u.push({r:_,c:E}))}}d>t&&(t=d)}return 1+t}}class vo{score(e){let t=0;for(let s=0;s<4;s++)for(let i=0;i<4;i++){const r=e.grid[s][i],o=`${s},${i}`;r==="COTTAGE"&&(e.allFedPositions.has(o)||t++)}return t*3}}class So{targetTypes;scoreAmount;constructor(e,t){this.targetTypes=e,this.scoreAmount=t}score(e){const t=[[-1,0],[1,0],[0,-1],[0,1]];for(const[s,i]of t){const r=e.row+s,o=e.col+i;if(r>=0&&r<4&&o>=0&&o<4){const a=e.grid[r][o];if(this.targetTypes.includes(a))return this.scoreAmount}}return 0}}class Oi{targetCategories;scoreAmount;constructor(e,t){this.targetCategories=e,this.scoreAmount=t}score(e){const t=[[-1,0],[1,0],[0,-1],[0,1]];for(const[s,i]of t){const r=e.row+s,o=e.col+i;if(r>=0&&r<4&&o>=0&&o<4){const a=e.grid[r][o],l=e.registry.find(c=>c.name.toUpperCase()===a.toUpperCase());if(l&&this.targetCategories.includes(l.type))return this.scoreAmount}}return 0}}class bo{score(e){let t=0;const s=e.grid[e.row][e.col];for(let i=0;i<4;i++)i!==e.col&&e.grid[e.row][i]===s&&t++;for(let i=0;i<4;i++)i!==e.row&&e.grid[i][e.col]===s&&t++;return t}}class wo{score(e){let t=1;const s=["1,1","1,2","2,1","2,2"],i=`${e.row},${e.col}`,r=e.grid[e.row][e.col];return s.forEach(o=>{if(o===i)return;const[a,l]=o.split(",").map(Number);e.grid[a][l]===r&&t++}),t}}class Io{score(e){const t=e.grid[e.row][e.col],s=e.counts[t]||e.counts[t.toUpperCase()]||0;return s===0?0:s%2!==0?-1:({2:5,4:15,6:26,8:40}[s]??s*5)/s}}class To{score(e){const t=e.grid[e.row][e.col];for(let s=0;s<4;s++)if(s!==e.col&&e.grid[e.row][s]===t)return 0;for(let s=0;s<4;s++)if(s!==e.row&&e.grid[s][e.col]===t)return 0;return 3}}class No{score(e){return e.fedCottageCount}}class Ro{requiredNeighbors;scoreAmount;constructor(e,t){this.requiredNeighbors=e,this.scoreAmount=t}score(e){let t=0;const s=[[-1,0],[1,0],[0,-1],[0,1]];for(const[i,r]of s){const o=e.row+i,a=e.col+r;o>=0&&o<4&&a>=0&&a<4&&e.allFedPositions.has(`${o},${a}`)&&t++}return t>=this.requiredNeighbors?this.scoreAmount:0}}class Oo{targetName;constructor(e){this.targetName=e}score(e){const t=[{r:0,c:0},{r:0,c:3},{r:3,c:0},{r:3,c:3}];let s=0;return t.forEach(i=>{e.grid[i.r][i.c]===this.targetName&&s++}),s}}class Ao{restrictedCategories;scoreAmount;constructor(e,t){this.restrictedCategories=e,this.scoreAmount=t}score(e){const t=[[-1,0],[1,0],[0,-1],[0,1]];for(const[s,i]of t){const r=e.row+s,o=e.col+i;if(r>=0&&r<4&&o>=0&&o<4){const a=e.grid[r][o],l=e.registry.find(c=>c.name.toUpperCase()===a.toUpperCase());if(l&&this.restrictedCategories.includes(l.type))return 0}}return this.scoreAmount}}class ko{score(e){if(!e.finishRank)return 0;const t=e.finishRank;return t===1?6:t===2?3:t===3?2:0}}class Lo{score(e){const t=e.counts["FEAST HALL"]||0,s=e.rightNeighborFeastHallCount||0;return t>s?3:2}}const Ai={name:"Cottage",type:"BLUE",pattern:[[f.NONE,f.WHEAT],[f.BRICK,f.GLASS]],scorer:new de(3,!0),feedCost:1,description:"3 points if fed."},Do=[Ai];class Mo{amount;constructor(e){this.amount=e}getFedPositions(e,t,s){return Array(this.amount).fill({r:-1,c:-1})}}class Po{getFedPositions(e,t,s){const i=[];return[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]].forEach(([o,a])=>{const l=e+o,c=t+a;l>=0&&l<4&&c>=0&&c<4&&i.push({r:l,c})}),i}}class xo{getFedPositions(e,t,s){const o=new Set,a=[],l=(c,d)=>{const u=s[c][d];return u===J.COTTAGE||u===J.BARRETT_CASTLE};for(let c=0;c<4;c++)for(let d=0;d<4;d++){const u=`${c},${d}`;if(o.has(u)||!l(c,d))continue;const h=[],p=[{r:c,c:d}];for(o.add(u);p.length>0;){const m=p.pop();h.push(m);const _=[[-1,0],[1,0],[0,-1],[0,1]];for(const[E,R]of _){const T=m.r+E,L=m.c+R,C=`${T},${L}`;T>=0&&T<4&&L>=0&&L<4&&!o.has(C)&&l(T,L)&&(o.add(C),p.push({r:T,c:L}))}}a.push(h)}return a.length===0?[]:(a.sort((c,d)=>d.length-c.length),a[0])}}class Bo{getFedPositions(e,t,s){const i=[];for(let r=0;r<4;r++)r!==t&&i.push({r:e,c:r});for(let r=0;r<4;r++)r!==e&&i.push({r,c:t});return i}}const Fo={name:"Farm",type:"RED",pattern:[[f.WHEAT,f.WHEAT],[f.WOOD,f.WOOD]],feeder:new Mo(4),description:"Feeds 4 cottages anywhere on the board."},Wo={name:"Granary",type:"RED",pattern:[[f.WHEAT,f.WHEAT],[f.WOOD,f.BRICK]],feeder:new Po,description:"Feeds all buildings in the 8 squares surrounding it."},Go={name:"Greenhouse",type:"RED",pattern:[[f.WHEAT,f.GLASS],[f.WOOD,f.WOOD]],feeder:new xo,description:"Feeds one contiguous group of Cottages."},Uo={name:"Orchard",type:"RED",description:"Feeds Cottages in the same row and column.",pattern:[[f.STONE,f.WHEAT],[f.WHEAT,f.WOOD]],feeder:new Bo},ki=[Fo,Wo,Go,Uo],Ho={name:"Well",type:"GRAY",pattern:[[f.WOOD,f.STONE]],description:"1 point for each adjacent cottage.",scorer:new po([J.COTTAGE,J.BARRETT_CASTLE],1)},$o={name:"Fountain",type:"GRAY",description:"2 points if adjacent to a Cottage.",pattern:[[f.WOOD,f.STONE]],scorer:new So([J.COTTAGE,J.BARRETT_CASTLE],2)},Vo={name:"Millstone",type:"GRAY",description:"2 points if adjacent to a Red or Yellow building.",pattern:[[f.WOOD,f.STONE]],scorer:new Oi(["RED","YELLOW"],2)},Ko={name:"Shed",type:"GRAY",description:"Worth 1 point. Can be placed anywhere.",pattern:[[f.WOOD,f.STONE]],scorer:new de(1)},Li=[Ho,$o,Vo,Ko],zo={name:"Almshouse",type:"GREEN",pattern:[[f.STONE,f.STONE,f.GLASS]],description:"Score increasing points for each Almshouse you have built.",scorer:new Io},Yo={name:"Inn",type:"GREEN",pattern:[[f.WHEAT,f.STONE,f.GLASS]],description:"Get 3 points if not in a row or column with another Inn.",scorer:new To},jo={name:"Feast Hall",type:"GREEN",pattern:[[f.WOOD,f.WOOD,f.GLASS]],description:"Get 2 points, and an extra 1 if you have more Feast Halls than the player on your right.",scorer:new Lo},qo={name:"Tavern",type:"GREEN",pattern:[[f.BRICK,f.BRICK,f.GLASS]],description:"Score increasing points for each Tavern you have built."},Di=[qo,Yo,zo,jo],Qo={name:"Theater",type:"YELLOW",pattern:[[f.NONE,f.STONE,f.NONE],[f.WOOD,f.GLASS,f.WOOD]],scorer:new mo,description:"1 point for each unique building type in the same row and column."},Xo={name:"Bakery",type:"YELLOW",description:"3 points if adjacent to a Food (Red) building.",pattern:[[f.NONE,f.WHEAT,f.NONE],[f.BRICK,f.GLASS,f.BRICK]],scorer:new Oi(["RED"],3)},Jo={name:"Market",type:"YELLOW",description:"1 point for each other Market in the same row or column.",pattern:[[f.NONE,f.WOOD,f.NONE],[f.STONE,f.GLASS,f.STONE]],scorer:new bo},Zo={name:"Tailor",type:"YELLOW",description:"1 point. +1 point for each other Tailor in the 4 center squares.",pattern:[[f.NONE,f.WHEAT,f.NONE],[f.STONE,f.GLASS,f.STONE]],scorer:new wo},Mi=[Qo,Xo,Jo,Zo];class ea{type="FACTORY";description="Stores a resource. Allows swapping that resource when chosen by others.";canSwap(e,t){return e===t}}class ta{type="BANK";description="Stores a resource. You cannot choose this resource as Master Builder."}class na{type="WAREHOUSE";description="Stores up to 3 resources. You can Swap the current resource with one in storage. -1 point for each resource left at the end.";capacity=3}class sa{type="STATUE_BONDMAKER";description="When another player names a resource, you may place it on a square with a Cottage."}class ia{type="GROVE_UNIVERSITY";description="Immediately place a building on an empty square in your town."}class ra{type="FORT_IRONWEED";description="Unless you are the last player in the game, you can no longer take turns as the Master Builder."}class oa{type="ARCHITECTS_GUILD";description="Replace up to 2 buildings in your town with any other building types."}class aa{type="OPALEYE_WATCH";description="Place 3 unique buildings on this card. When neighbors build them, you get them."}const la={name:"Factory",type:"BLACK",pattern:[[f.WOOD,f.NONE,f.NONE,f.NONE],[f.BRICK,f.STONE,f.STONE,f.BRICK]],description:"Place 1 resource on the factory, whenever another player chooses that resource, play a different one instead.",effect:new ea},ca={name:"Trading Post",type:"BLACK",description:"1 point. Counts as a WILD (any) resource for future buildings.",pattern:[[f.STONE,f.WOOD,f.NONE],[f.STONE,f.WOOD,f.BRICK]],scorer:new de(1)},ha={name:"Bank",type:"BLACK",description:"4 points. Place a resource on this building - you can no longer select this resource as master builder.",pattern:[[f.WHEAT,f.WHEAT,f.NONE],[f.WOOD,f.GLASS,f.BRICK]],scorer:new de(4),effect:new ta},da={name:"Warehouse",type:"BLACK",description:"-1 for each resource on this building. When another player chooses a resource, you may place that resource on the warehouse, or swap it with a resource already stored here. It can store 3 resources.",pattern:[[f.WHEAT,f.WOOD,f.WHEAT],[f.BRICK,f.NONE,f.BRICK]],effect:new na},Pi=[la,ca,ha,da],ua={name:"Chapel",type:"ORANGE",pattern:[[f.NONE,f.NONE,f.GLASS],[f.STONE,f.GLASS,f.STONE]],description:"Scores 1 point for each fed cottage.",scorer:new No},fa={name:"Abbey",type:"ORANGE",pattern:[[f.NONE,f.NONE,f.GLASS],[f.BRICK,f.STONE,f.STONE]],description:"3 points if not adjacent to a black, green or yellow building.",scorer:new Ao(["BLACK","GREEN","YELLOW"],3)},pa={name:"Cloister",type:"ORANGE",pattern:[[f.NONE,f.NONE,f.GLASS],[f.WOOD,f.BRICK,f.STONE]],description:"Scores 1 point for each cloister in a corner of your town.",scorer:new Oo("CLOISTER")},ma={name:"Temple",type:"ORANGE",pattern:[[f.NONE,f.NONE,f.GLASS],[f.BRICK,f.BRICK,f.STONE]],description:"4 points if adjacent to 2 or more fed cottages.",scorer:new Ro(2,4)},xi=[ua,fa,pa,ma],ga={name:"Archive of the Second Age",type:"PURPLE",pattern:[[f.WHEAT,f.WHEAT],[f.BRICK,f.GLASS]],scorer:new go,isMonument:!0,description:"Scores 1 point for each unique building type on the board."},_a={name:"Barrett Castle",type:"PURPLE",pattern:[[f.WHEAT,f.NONE,f.NONE,f.STONE],[f.WOOD,f.GLASS,f.GLASS,f.BRICK]],scorer:new de(5,!0),feedCost:1,countsAs:[J.COTTAGE],isMonument:!0,description:"Scores 5 points if fed. Counts as 2 cottages."},ya={name:"Obelisk of the Crescent",type:"PURPLE",pattern:[[f.WHEAT,f.NONE,f.NONE],[f.BRICK,f.GLASS,f.BRICK]],isMonument:!0,description:"You may place all future buildings on any empty square in your town."},Ea={name:"Mandras Palace",type:"PURPLE",pattern:[[f.WHEAT,f.GLASS],[f.BRICK,f.WOOD]],scorer:new _o(2),isMonument:!0,description:"Scores 2 points for each unique adjacent building type."},Ca={name:"Shrine of the Elder Tree",type:"PURPLE",pattern:[[f.BRICK,f.WHEAT,f.STONE],[f.WOOD,f.GLASS,f.WOOD]],isMonument:!0,scorer:new yo,description:"Gain points based on the number of buildings in your town when constructed."},va={name:"The Sky Baths",type:"PURPLE",pattern:[[f.NONE,f.WHEAT,f.NONE],[f.STONE,f.GLASS,f.WOOD],[f.BRICK,f.NONE,f.BRICK]],isMonument:!0,scorer:new Eo,description:"Scores 2 points for each building type your town is missing."},Sa={name:"Silva Forum",type:"PURPLE",pattern:[[f.NONE,f.NONE,f.WHEAT,f.NONE],[f.BRICK,f.BRICK,f.STONE,f.WOOD]],isMonument:!0,scorer:new Co,description:"Gain 1 point, plus 1 for each building in the largest contiguous group of buildings of the same type in your town."},ba={name:"Grand Mausoleum of the Rodina",type:"PURPLE",pattern:[[f.WOOD,f.WOOD],[f.BRICK,f.STONE]],isMonument:!0,scorer:new vo,description:"Your unfed cottages are worth 3 points each."},wa={name:"Cathedral of Caterina",type:"PURPLE",pattern:[[f.NONE,f.WHEAT],[f.STONE,f.GLASS]],isMonument:!0,scorer:new de(2,!1),description:"2 points. Empty squares in your town are worth 0 points (instead of -1)."},Ia={name:"Statue of the Bondmaker",type:"PURPLE",pattern:[[f.WOOD,f.STONE,f.STONE,f.GLASS],[f.WHEAT,f.NONE,f.NONE,f.NONE]],isMonument:!0,description:"When another player names a resource, you may choose to place it on a square with a cottage. Each of your cottages can hold 1 resource.",effect:new sa},Ta={name:"Architect's Guild",type:"PURPLE",pattern:[[f.NONE,f.NONE,f.GLASS],[f.NONE,f.WHEAT,f.STONE],[f.WOOD,f.BRICK,f.NONE]],isMonument:!0,scorer:new de(1,!1),description:"1 point. When constructed, replace up to 2 buildings in your town with any other building types.",effect:new oa},Na={name:"Grove University",type:"PURPLE",pattern:[[f.NONE,f.BRICK,f.NONE],[f.STONE,f.GLASS,f.STONE]],isMonument:!0,scorer:new de(3,!1),description:"3 points. Immediately place a building on an empty square in your town.",effect:new ia},Ra={name:"Opaleye's Watch",type:"PURPLE",pattern:[[f.WOOD,f.NONE,f.NONE,f.NONE],[f.BRICK,f.GLASS,f.WHEAT,f.WHEAT],[f.STONE,f.NONE,f.NONE,f.NONE]],isMonument:!0,description:"Immediately place 3 unique buildings on this card. Whenever a player on the left or right of you constructs 1 of those buildings, take the building from here and place it on an empty square in your town.",effect:new aa},Oa={name:"Fort Ironweed",type:"PURPLE",pattern:[[f.WHEAT,f.NONE,f.BRICK],[f.STONE,f.WOOD,f.STONE]],isMonument:!0,scorer:new de(7,!1),description:"7 points. Unless you are the last player in the game you can no longer take turns as the master builder.",effect:new ra},Aa={name:"The Starloom",type:"PURPLE",pattern:[[f.GLASS,f.GLASS],[f.WOOD,f.WHEAT]],isMonument:!0,description:"Gain points based on how early you complete your town.",scorer:new ko},nt=[ga,Oa,_a,ya,Ia,Ta,Na,Ra,Ea,Ca,va,Sa,ba,wa,Aa],st=[...Do,...ki,...Li,...Di,...Mi,...Pi,...xi,...nt],fn=[{id:"RED",label:"Farm (Red)",options:ki},{id:"GRAY",label:"Well (Gray)",options:Li},{id:"YELLOW",label:"Theater (Yellow)",options:Mi},{id:"GREEN",label:"Tavern (Green)",options:Di},{id:"ORANGE",label:"Chapel (Orange)",options:xi},{id:"BLACK",label:"Factory (Black)",options:Pi}],Ds=Ai;class ka{board;currentResource=null;availableMatches=[];activeMonument=null;gameRegistry=[];rightNeighborFeastHallCount=0;lastMove=null;constructor(){this.board=new Ls}setRightNeighborFeastHallCount(e){this.rightNeighborFeastHallCount=e}setMonument(e,t){this.activeMonument=e,this.gameRegistry=[...t,this.activeMonument],this.scanForMatches()}start(){if(this.board=new Ls,this.currentResource=null,this.lastMove=null,this.availableMatches=[],this.gameRegistry.length===0){const e=st.filter(s=>s.isMonument),t=st.filter(s=>!s.isMonument);this.activeMonument=e[Math.floor(Math.random()*e.length)],this.gameRegistry=[...t,this.activeMonument]}}placeResource(e,t){if(!this.currentResource)throw new Error("No resource selected");const i=this.board.getGrid()[e][t];if(i==="NONE")this.board.place(e,t,this.currentResource);else if(i==="COTTAGE"&&this.hasStatueOfBondmaker()){const r=this.board.getMetadata(e,t);if(r&&r.storedResource)throw new Error("This Cottage is already holding a resource!");this.board.setMetadata(e,t,{...r,storedResource:this.currentResource})}else throw new Error("Cannot place resource here.");this.lastMove={r:e,c:t},this.currentResource=null,this.scanForMatches()}constructBuilding(e,t,s){const i=[];let r=0,o=!1;if(e.pattern.forEach((l,c)=>{l.forEach((d,u)=>{d&&d!=="NONE"&&i.push({row:e.row+c,col:e.col+u})})}),e.buildingName.toUpperCase()==="SHRINE OF THE ELDER TREE"){o=!0;const c=this.countBuildingsOnBoard()+1;c<6?r=c:r=8}i.forEach(l=>{const c=this.board.getGrid()[l.row][l.col],d=c&&c.toUpperCase().replace("_"," ")==="TRADING POST",u=this.board.getMetadata(l.row,l.col);u&&u.storedResource?this.board.setMetadata(l.row,l.col,{...u,storedResource:null}):d||this.board.remove(l.row,l.col)}),this.board.placeBuilding(t,s,e.buildingName),o&&this.board.setMetadata(t,s,{savedScore:r}),this.lastMove=null,this.scanForMatches();const a=st.find(l=>l.name.toUpperCase()===e.buildingName.toUpperCase());return a&&a.effect?{type:"TRIGGER_EFFECT",effectType:a.effect.type}:{type:"SUCCESS"}}undo(){this.lastMove&&(this.board.remove(this.lastMove.r,this.lastMove.c),this.lastMove=null,this.scanForMatches())}canUndo(){return this.lastMove!==null}scanForMatches(){this.availableMatches=[];const e=this.board.getGrid(),t=e.some(s=>s.some(i=>this.gameRegistry.find(o=>o.name.toUpperCase()===i.toUpperCase())?.isMonument));for(const s of this.gameRegistry){if(t&&s.isMonument)continue;uo.findMatches(e,s,this.board.metadata).forEach(r=>{this.availableMatches.push({...r,buildingName:s.name.toUpperCase()})})}}checkGameOver(){const t=this.board.getGrid().some(i=>i.some(r=>r==="NONE")),s=this.availableMatches.length>0;return!t&&!s}getScore(e){return fo.calculateScore(this.board.getGrid(),this.board.metadata,this.gameRegistry,e,this.rightNeighborFeastHallCount)}countBuildingsOnBoard(){const e=this.board.getGrid();let t=0;const s=["WOOD","WHEAT","BRICK","GLASS","STONE","NONE"];return e.forEach(i=>{i.forEach(r=>{s.includes(r)||t++})}),t}hasObeliskAbility(){return this.board.getGrid().some(t=>t.some(s=>s.toUpperCase().includes("OBELISK")))}findEffectBuildings(e,t=!0){const s=this.board.getGrid(),i=[];return s.forEach((r,o)=>{r.forEach((a,l)=>{if(["WOOD","WHEAT","BRICK","GLASS","STONE","NONE"].includes(a))return;const c=this.gameRegistry.find(d=>d.name.toUpperCase()===a.toUpperCase());if(c&&c.effect&&c.effect.type===e){const d=this.board.getMetadata(o,l),u=d?d.storedResource:null;t?u&&i.push({r:o,c:l,storedRes:u}):i.push({r:o,c:l,storedRes:u})}})}),i}setBuildingStorage(e,t,s){this.board.setMetadata(e,t,{storedResource:s})}canFactorySwap(e){const s=this.findEffectBuildings("FACTORY").find(i=>i.storedRes===e);return s?{r:s.r,c:s.c}:null}getForbiddenResources(){return this.findEffectBuildings("BANK").map(t=>t.storedRes).filter(t=>t!==null)}storeInWarehouse(e,t,s){const i=this.board.getMetadata(e,t)||{},r=i.storedResources||[];return r.length>=3?!1:(r.push(s),this.board.setMetadata(e,t,{...i,storedResources:r}),!0)}swapInWarehouse(e,t,s,i){const r=this.board.getMetadata(e,t);if(!r||!r.storedResources)return null;const o=[...r.storedResources];if(s<0||s>=o.length)return null;const a=o[s];return o[s]=i,this.board.setMetadata(e,t,{...r,storedResources:o}),a}getWarehouseContents(e,t){return this.board.getMetadata(e,t)?.storedResources||[]}hasStatueOfBondmaker(){const e=this.findEffectBuildings("STATUE_BONDMAKER",!1);return console.log(`Checking for Bondmaker. Found: ${e.length}`,e),e.length>0}placeFreeBuilding(e,t,s){if(this.board.getGrid()[e][t]!=="NONE")throw new Error("Target square must be empty!");this.board.placeBuilding(e,t,s),this.scanForMatches()}replaceBuilding(e,t,s){const r=this.board.getGrid()[e][t];if(r==="NONE"||["WOOD","WHEAT","BRICK","GLASS","STONE"].includes(r))throw new Error("Must select an existing building!");this.board.placeBuilding(e,t,s),this.board.setMetadata(e,t,{}),this.scanForMatches()}initializeOpaleye(e,t,s){this.board.setMetadata(e,t,{opaleyeBuildings:s})}checkOpaleyeMatch(e){const t=this.board.getGrid(),s=e.toUpperCase();for(let i=0;i<4;i++)for(let r=0;r<4;r++)if(t[i][r].toUpperCase().includes("OPALEYE")){const o=this.board.getMetadata(i,r);if(o&&o.opaleyeBuildings&&o.opaleyeBuildings.some(l=>l.toUpperCase()===s))return{r:i,c:r}}return null}removeOpaleyeItem(e,t,s){const i=this.board.getMetadata(e,t);if(!i||!i.opaleyeBuildings){console.error("[Opaleye] No metadata found at",e,t);return}console.log("[Opaleye] Attempting remove:",s),console.log("[Opaleye] Current List:",i.opaleyeBuildings);const r=s.trim().toUpperCase(),o=i.opaleyeBuildings.filter(a=>a.trim().toUpperCase()!==r);console.log("[Opaleye] Updated List:",o),o.length===i.opaleyeBuildings.length&&console.warn("[Opaleye] WARNING: Nothing was removed! Name mismatch?"),this.board.setMetadata(e,t,{...i,opaleyeBuildings:o})}}class La{boardEl=document.getElementById("board");buildMenuEl=document.getElementById("build-menu");msgLabel=document.getElementById("message");paletteEl=document.getElementById("resource-palette");scoreEl=document.getElementById("score-display");undoBtn=document.getElementById("undo-btn");deckDisplayEl=document.getElementById("deck-display");factoryBar=document.getElementById("factory-action-bar");swapBtn=document.getElementById("factory-swap-btn");swapResLabel=document.getElementById("swap-res-name");onCellClick=()=>{};onResourceSelect=()=>{};onBuildClick=()=>{};onCancelClick=()=>{};onSwapClick=()=>{};constructor(){this.swapBtn.onclick=()=>this.onSwapClick()}render(e,t,s,i,r=[]){this.renderHeader(e),this.renderBoard(e,t,s,i),this.renderSidebar(e,t),this.renderControls(e,t,r)}renderHeader(e){const t=e.getScore(),s=t.total+t.penaltyCount;this.scoreEl.innerHTML=`Score: ${s} <span style="font-size:12px; color:#999">(-${t.penaltyCount} empty)</span>`}renderBoard(e,t,s,i){const r=e.board.getGrid(),o=["WOOD","WHEAT","BRICK","GLASS","STONE"];this.boardEl.children.length===0&&r.forEach((l,c)=>{l.forEach((d,u)=>{const h=document.createElement("div");h.dataset.r=c.toString(),h.dataset.c=u.toString(),h.onclick=()=>this.onCellClick(c,u),this.boardEl.appendChild(h)})}),Array.from(this.boardEl.children).forEach(l=>{const c=parseInt(l.dataset.r),d=parseInt(l.dataset.c),u=r[c][d];if(l.className="cell",l.style.backgroundColor="",l.innerHTML="",u==="NONE")l.classList.add("empty");else if(o.includes(u))l.classList.add(u),l.textContent=u;else{const p=e.gameRegistry.find(m=>m.name.toUpperCase()===u.toUpperCase());if(p){if(l.classList.add("constructed"),p.isMonument)l.classList.add("MONUMENT");else{const m=u.replace(/ /g,"-").replace(/'/g,"").toUpperCase();l.classList.add(m)}p.color&&(l.style.backgroundColor=p.color)}}const h=e.board.getMetadata(c,d);if(h&&h.storedResource){const p=document.createElement("div");p.className=`stored-resource-icon ${h.storedResource}`,p.title=`Stored: ${h.storedResource}`,l.appendChild(p)}if(h&&h.storedResources&&Array.isArray(h.storedResources)){const p=document.createElement("div");p.className="warehouse-storage",h.storedResources.forEach(m=>{const _=document.createElement("div");_.className=`mini-resource ${m}`,p.appendChild(_)}),l.appendChild(p)}if(h&&h.opaleyeBuildings&&Array.isArray(h.opaleyeBuildings)){const p=document.createElement("div");p.className="warehouse-storage",h.opaleyeBuildings.forEach(m=>{const _=document.createElement("div"),E=m.replace(/ /g,"-").replace(/'/g,"").toUpperCase();_.className=`mini-cell ${E} on-board-mini`,_.title=m,p.appendChild(_)}),l.appendChild(p)}if(e.currentResource&&!t&&u.toUpperCase()==="WAREHOUSE"&&(l.classList.add("interactive-building"),l.title="Click to Store or Swap"),t){const p=s.some(T=>T.row===c&&T.col===d),m=e.hasObeliskAbility(),_=t.buildingName.toUpperCase()==="SHED",E=(m||_)&&u==="NONE",R=u&&u.toUpperCase().replace("_"," ")==="TRADING POST";(p&&!R||E)&&l.classList.add("match-highlight")}u==="NONE"&&e.currentResource&&!t?(l.onmouseenter=()=>{l.classList.add("ghost",e.currentResource)},l.onmouseleave=()=>{l.classList.remove("ghost","WOOD","WHEAT","BRICK","GLASS","STONE")}):(l.onmouseenter=null,l.onmouseleave=null)}),t?(this.msgLabel.textContent=`Select a highlighted square to build your ${t.buildingName}!`,this.msgLabel.style.color="#d32f2f"):i?(this.msgLabel.textContent=i,i.includes("Waiting")?this.msgLabel.style.color="#d32f2f":i.includes("YOU")?this.msgLabel.style.color="#2e7d32":this.msgLabel.style.color="#333"):e.availableMatches.length>0?(this.msgLabel.textContent="Matches available!",this.msgLabel.style.color="#333"):e.currentResource?(this.msgLabel.textContent=`Place ${e.currentResource}...`,this.msgLabel.style.color="#333"):(this.msgLabel.textContent="Select a Resource...",this.msgLabel.style.color="#1976d2")}renderSidebar(e,t){if(this.buildMenuEl.innerHTML="",e.availableMatches.length===0){const s=document.createElement("p");s.textContent="No patterns found.",s.style.color="#777",s.style.fontStyle="italic",this.buildMenuEl.appendChild(s)}else e.availableMatches.forEach(s=>{const i=document.createElement("button");i.textContent=`Build ${s.buildingName}`;const r=s.buildingName.replace(/ /g,"-").replace(/'/g,"").toUpperCase();i.className=`build-btn ${r}`,i.onclick=()=>this.onBuildClick(s);const o=[];s.pattern&&Array.isArray(s.pattern)?s.pattern.forEach((a,l)=>{a.forEach((c,d)=>{c&&c!=="NONE"&&o.push({row:s.row+l,col:s.col+d})})}):o.push({row:s.row,col:s.col}),i.onmouseenter=()=>this.togglePreview(o,!0),i.onmouseleave=()=>this.togglePreview(o,!1),this.buildMenuEl.appendChild(i)});if(t){const s=document.createElement("button");s.textContent="Cancel Construction",s.className="secondary-btn",s.style.marginTop="10px",s.style.width="100%",s.onclick=()=>this.onCancelClick(),this.buildMenuEl.appendChild(s)}}togglePreview(e,t){e.forEach(s=>{const i=`div[data-r="${s.row}"][data-c="${s.col}"]`,r=this.boardEl.querySelector(i);r&&(t?r.classList.add("preview-target"):r.classList.remove("preview-target"))})}renderControls(e,t,s){this.paletteEl.innerHTML="",[f.WOOD,f.WHEAT,f.BRICK,f.GLASS,f.STONE].forEach(r=>{const o=document.createElement("div");let a=`res-btn ${r}`;e.currentResource===r&&!t&&(a+=" selected"),s.includes(r)&&(a+=" disabled",o.title="Blocked by bank"),o.className=a,o.textContent=r.charAt(0),s.includes(r)||(o.onclick=()=>this.onResourceSelect(r)),this.paletteEl.appendChild(o)}),e.canUndo()&&!t?this.undoBtn.removeAttribute("disabled"):this.undoBtn.setAttribute("disabled","true")}renderDeck(e){this.deckDisplayEl&&(this.deckDisplayEl.innerHTML="",e.forEach(t=>{const s=document.createElement("div");t.isMonument?s.className="building-card MONUMENT":s.className=`building-card ${t.name.toUpperCase()}`;const i=document.createElement("header");i.className="card-header";const r=document.createElement("span");r.textContent=t.name;const o=document.createElement("div"),a=t.name.replace(/ /g,"-").replace(/'/g,"").toUpperCase();o.className=`card-icon ${a}`,i.appendChild(r),i.appendChild(o),s.appendChild(i);const l=document.createElement("div");l.className="card-body";const c=document.createElement("div");c.className="mini-pattern";const d=t.pattern[0].length;c.style.gridTemplateColumns=`repeat(${d}, 15px)`,t.pattern.forEach(h=>{h.forEach(p=>{const m=document.createElement("div"),_=p==="NONE"?"pattern-empty":p;m.className=`pattern-cell ${_}`,c.appendChild(m)})});const u=document.createElement("div");u.className="card-text",u.textContent=t.description||"Unique scoring rules.",l.appendChild(c),l.appendChild(u),s.appendChild(l),this.deckDisplayEl.appendChild(s)}))}toggleFactoryAction(e,t=""){e?(this.factoryBar.classList.remove("hidden"),this.swapResLabel.textContent=t):this.factoryBar.classList.add("hidden")}}const Da=()=>{};var Ms={};const Bi={NODE_ADMIN:!1,SDK_VERSION:"${JSCORE_VERSION}"};const g=function(n,e){if(!n)throw Ye(e)},Ye=function(n){return new Error("Firebase Database ("+Bi.SDK_VERSION+") INTERNAL ASSERT FAILED: "+n)};const Fi=function(n){const e=[];let t=0;for(let s=0;s<n.length;s++){let i=n.charCodeAt(s);i<128?e[t++]=i:i<2048?(e[t++]=i>>6|192,e[t++]=i&63|128):(i&64512)===55296&&s+1<n.length&&(n.charCodeAt(s+1)&64512)===56320?(i=65536+((i&1023)<<10)+(n.charCodeAt(++s)&1023),e[t++]=i>>18|240,e[t++]=i>>12&63|128,e[t++]=i>>6&63|128,e[t++]=i&63|128):(e[t++]=i>>12|224,e[t++]=i>>6&63|128,e[t++]=i&63|128)}return e},Ma=function(n){const e=[];let t=0,s=0;for(;t<n.length;){const i=n[t++];if(i<128)e[s++]=String.fromCharCode(i);else if(i>191&&i<224){const r=n[t++];e[s++]=String.fromCharCode((i&31)<<6|r&63)}else if(i>239&&i<365){const r=n[t++],o=n[t++],a=n[t++],l=((i&7)<<18|(r&63)<<12|(o&63)<<6|a&63)-65536;e[s++]=String.fromCharCode(55296+(l>>10)),e[s++]=String.fromCharCode(56320+(l&1023))}else{const r=n[t++],o=n[t++];e[s++]=String.fromCharCode((i&15)<<12|(r&63)<<6|o&63)}}return e.join("")},jn={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:typeof atob=="function",encodeByteArray(n,e){if(!Array.isArray(n))throw Error("encodeByteArray takes an array as a parameter");this.init_();const t=e?this.byteToCharMapWebSafe_:this.byteToCharMap_,s=[];for(let i=0;i<n.length;i+=3){const r=n[i],o=i+1<n.length,a=o?n[i+1]:0,l=i+2<n.length,c=l?n[i+2]:0,d=r>>2,u=(r&3)<<4|a>>4;let h=(a&15)<<2|c>>6,p=c&63;l||(p=64,o||(h=64)),s.push(t[d],t[u],t[h],t[p])}return s.join("")},encodeString(n,e){return this.HAS_NATIVE_SUPPORT&&!e?btoa(n):this.encodeByteArray(Fi(n),e)},decodeString(n,e){return this.HAS_NATIVE_SUPPORT&&!e?atob(n):Ma(this.decodeStringToByteArray(n,e))},decodeStringToByteArray(n,e){this.init_();const t=e?this.charToByteMapWebSafe_:this.charToByteMap_,s=[];for(let i=0;i<n.length;){const r=t[n.charAt(i++)],a=i<n.length?t[n.charAt(i)]:0;++i;const c=i<n.length?t[n.charAt(i)]:64;++i;const u=i<n.length?t[n.charAt(i)]:64;if(++i,r==null||a==null||c==null||u==null)throw new Pa;const h=r<<2|a>>4;if(s.push(h),c!==64){const p=a<<4&240|c>>2;if(s.push(p),u!==64){const m=c<<6&192|u;s.push(m)}}}return s},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let n=0;n<this.ENCODED_VALS.length;n++)this.byteToCharMap_[n]=this.ENCODED_VALS.charAt(n),this.charToByteMap_[this.byteToCharMap_[n]]=n,this.byteToCharMapWebSafe_[n]=this.ENCODED_VALS_WEBSAFE.charAt(n),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[n]]=n,n>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(n)]=n,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(n)]=n)}}};class Pa extends Error{constructor(){super(...arguments),this.name="DecodeBase64StringError"}}const Wi=function(n){const e=Fi(n);return jn.encodeByteArray(e,!0)},kt=function(n){return Wi(n).replace(/\./g,"")},Rn=function(n){try{return jn.decodeString(n,!0)}catch(e){console.error("base64Decode failed: ",e)}return null};function xa(n){return Gi(void 0,n)}function Gi(n,e){if(!(e instanceof Object))return e;switch(e.constructor){case Date:const t=e;return new Date(t.getTime());case Object:n===void 0&&(n={});break;case Array:n=[];break;default:return e}for(const t in e)!e.hasOwnProperty(t)||!Ba(t)||(n[t]=Gi(n[t],e[t]));return n}function Ba(n){return n!=="__proto__"}function Fa(){if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global;throw new Error("Unable to locate global object.")}const Wa=()=>Fa().__FIREBASE_DEFAULTS__,Ga=()=>{if(typeof process>"u"||typeof Ms>"u")return;const n=Ms.__FIREBASE_DEFAULTS__;if(n)return JSON.parse(n)},Ua=()=>{if(typeof document>"u")return;let n;try{n=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch{return}const e=n&&Rn(n[1]);return e&&JSON.parse(e)},Ui=()=>{try{return Da()||Wa()||Ga()||Ua()}catch(n){console.info(`Unable to get __FIREBASE_DEFAULTS__ due to: ${n}`);return}},Ha=n=>Ui()?.emulatorHosts?.[n],$a=n=>{const e=Ha(n);if(!e)return;const t=e.lastIndexOf(":");if(t<=0||t+1===e.length)throw new Error(`Invalid host ${e} with no separate hostname and port!`);const s=parseInt(e.substring(t+1),10);return e[0]==="["?[e.substring(1,t-1),s]:[e.substring(0,t),s]},Hi=()=>Ui()?.config;class ee{constructor(){this.reject=()=>{},this.resolve=()=>{},this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}wrapCallback(e){return(t,s)=>{t?this.reject(t):this.resolve(s),typeof e=="function"&&(this.promise.catch(()=>{}),e.length===1?e(t):e(t,s))}}}function qn(n){try{return(n.startsWith("http://")||n.startsWith("https://")?new URL(n).hostname:n).endsWith(".cloudworkstations.dev")}catch{return!1}}async function Va(n){return(await fetch(n,{credentials:"include"})).ok}function Ka(n,e){if(n.uid)throw new Error('The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.');const t={alg:"none",type:"JWT"},s=e||"demo-project",i=n.iat||0,r=n.sub||n.user_id;if(!r)throw new Error("mockUserToken must contain 'sub' or 'user_id' field!");const o={iss:`https://securetoken.google.com/${s}`,aud:s,iat:i,exp:i+3600,auth_time:i,sub:r,user_id:r,firebase:{sign_in_provider:"custom",identities:{}},...n};return[kt(JSON.stringify(t)),kt(JSON.stringify(o)),""].join(".")}const it={};function za(){const n={prod:[],emulator:[]};for(const e of Object.keys(it))it[e]?n.emulator.push(e):n.prod.push(e);return n}function Ya(n){let e=document.getElementById(n),t=!1;return e||(e=document.createElement("div"),e.setAttribute("id",n),t=!0),{created:t,element:e}}let Ps=!1;function ja(n,e){if(typeof window>"u"||typeof document>"u"||!qn(window.location.host)||it[n]===e||it[n]||Ps)return;it[n]=e;function t(h){return`__firebase__banner__${h}`}const s="__firebase__banner",r=za().prod.length>0;function o(){const h=document.getElementById(s);h&&h.remove()}function a(h){h.style.display="flex",h.style.background="#7faaf0",h.style.position="fixed",h.style.bottom="5px",h.style.left="5px",h.style.padding=".5em",h.style.borderRadius="5px",h.style.alignItems="center"}function l(h,p){h.setAttribute("width","24"),h.setAttribute("id",p),h.setAttribute("height","24"),h.setAttribute("viewBox","0 0 24 24"),h.setAttribute("fill","none"),h.style.marginLeft="-6px"}function c(){const h=document.createElement("span");return h.style.cursor="pointer",h.style.marginLeft="16px",h.style.fontSize="24px",h.innerHTML=" &times;",h.onclick=()=>{Ps=!0,o()},h}function d(h,p){h.setAttribute("id",p),h.innerText="Learn more",h.href="https://firebase.google.com/docs/studio/preview-apps#preview-backend",h.setAttribute("target","__blank"),h.style.paddingLeft="5px",h.style.textDecoration="underline"}function u(){const h=Ya(s),p=t("text"),m=document.getElementById(p)||document.createElement("span"),_=t("learnmore"),E=document.getElementById(_)||document.createElement("a"),R=t("preprendIcon"),T=document.getElementById(R)||document.createElementNS("http://www.w3.org/2000/svg","svg");if(h.created){const L=h.element;a(L),d(E,_);const C=c();l(T,R),L.append(T,m,E,C),document.body.appendChild(L)}r?(m.innerText="Preview backend disconnected.",T.innerHTML=`<g clip-path="url(#clip0_6013_33858)">
<path d="M4.8 17.6L12 5.6L19.2 17.6H4.8ZM6.91667 16.4H17.0833L12 7.93333L6.91667 16.4ZM12 15.6C12.1667 15.6 12.3056 15.5444 12.4167 15.4333C12.5389 15.3111 12.6 15.1667 12.6 15C12.6 14.8333 12.5389 14.6944 12.4167 14.5833C12.3056 14.4611 12.1667 14.4 12 14.4C11.8333 14.4 11.6889 14.4611 11.5667 14.5833C11.4556 14.6944 11.4 14.8333 11.4 15C11.4 15.1667 11.4556 15.3111 11.5667 15.4333C11.6889 15.5444 11.8333 15.6 12 15.6ZM11.4 13.6H12.6V10.4H11.4V13.6Z" fill="#212121"/>
</g>
<defs>
<clipPath id="clip0_6013_33858">
<rect width="24" height="24" fill="white"/>
</clipPath>
</defs>`):(T.innerHTML=`<g clip-path="url(#clip0_6083_34804)">
<path d="M11.4 15.2H12.6V11.2H11.4V15.2ZM12 10C12.1667 10 12.3056 9.94444 12.4167 9.83333C12.5389 9.71111 12.6 9.56667 12.6 9.4C12.6 9.23333 12.5389 9.09444 12.4167 8.98333C12.3056 8.86111 12.1667 8.8 12 8.8C11.8333 8.8 11.6889 8.86111 11.5667 8.98333C11.4556 9.09444 11.4 9.23333 11.4 9.4C11.4 9.56667 11.4556 9.71111 11.5667 9.83333C11.6889 9.94444 11.8333 10 12 10ZM12 18.4C11.1222 18.4 10.2944 18.2333 9.51667 17.9C8.73889 17.5667 8.05556 17.1111 7.46667 16.5333C6.88889 15.9444 6.43333 15.2611 6.1 14.4833C5.76667 13.7056 5.6 12.8778 5.6 12C5.6 11.1111 5.76667 10.2833 6.1 9.51667C6.43333 8.73889 6.88889 8.06111 7.46667 7.48333C8.05556 6.89444 8.73889 6.43333 9.51667 6.1C10.2944 5.76667 11.1222 5.6 12 5.6C12.8889 5.6 13.7167 5.76667 14.4833 6.1C15.2611 6.43333 15.9389 6.89444 16.5167 7.48333C17.1056 8.06111 17.5667 8.73889 17.9 9.51667C18.2333 10.2833 18.4 11.1111 18.4 12C18.4 12.8778 18.2333 13.7056 17.9 14.4833C17.5667 15.2611 17.1056 15.9444 16.5167 16.5333C15.9389 17.1111 15.2611 17.5667 14.4833 17.9C13.7167 18.2333 12.8889 18.4 12 18.4ZM12 17.2C13.4444 17.2 14.6722 16.6944 15.6833 15.6833C16.6944 14.6722 17.2 13.4444 17.2 12C17.2 10.5556 16.6944 9.32778 15.6833 8.31667C14.6722 7.30555 13.4444 6.8 12 6.8C10.5556 6.8 9.32778 7.30555 8.31667 8.31667C7.30556 9.32778 6.8 10.5556 6.8 12C6.8 13.4444 7.30556 14.6722 8.31667 15.6833C9.32778 16.6944 10.5556 17.2 12 17.2Z" fill="#212121"/>
</g>
<defs>
<clipPath id="clip0_6083_34804">
<rect width="24" height="24" fill="white"/>
</clipPath>
</defs>`,m.innerText="Preview backend running in this workspace."),m.setAttribute("id",p)}document.readyState==="loading"?window.addEventListener("DOMContentLoaded",u):u()}function qa(){return typeof navigator<"u"&&typeof navigator.userAgent=="string"?navigator.userAgent:""}function $i(){return typeof window<"u"&&!!(window.cordova||window.phonegap||window.PhoneGap)&&/ios|iphone|ipod|ipad|android|blackberry|iemobile/i.test(qa())}function Qa(){return typeof navigator=="object"&&navigator.product==="ReactNative"}function Xa(){return Bi.NODE_ADMIN===!0}function Ja(){try{return typeof indexedDB=="object"}catch{return!1}}function Za(){return new Promise((n,e)=>{try{let t=!0;const s="validate-browser-context-for-indexeddb-analytics-module",i=self.indexedDB.open(s);i.onsuccess=()=>{i.result.close(),t||self.indexedDB.deleteDatabase(s),n(!0)},i.onupgradeneeded=()=>{t=!1},i.onerror=()=>{e(i.error?.message||"")}}catch(t){e(t)}})}const el="FirebaseError";class Ct extends Error{constructor(e,t,s){super(t),this.code=e,this.customData=s,this.name=el,Object.setPrototypeOf(this,Ct.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,Vi.prototype.create)}}class Vi{constructor(e,t,s){this.service=e,this.serviceName=t,this.errors=s}create(e,...t){const s=t[0]||{},i=`${this.service}/${e}`,r=this.errors[e],o=r?tl(r,s):"Error",a=`${this.serviceName}: ${o} (${i}).`;return new Ct(i,a,s)}}function tl(n,e){return n.replace(nl,(t,s)=>{const i=e[s];return i!=null?String(i):`<${s}?>`})}const nl=/\{\$([^}]+)}/g;function ht(n){return JSON.parse(n)}function B(n){return JSON.stringify(n)}const Ki=function(n){let e={},t={},s={},i="";try{const r=n.split(".");e=ht(Rn(r[0])||""),t=ht(Rn(r[1])||""),i=r[2],s=t.d||{},delete t.d}catch{}return{header:e,claims:t,data:s,signature:i}},sl=function(n){const e=Ki(n),t=e.claims;return!!t&&typeof t=="object"&&t.hasOwnProperty("iat")},il=function(n){const e=Ki(n).claims;return typeof e=="object"&&e.admin===!0};function ie(n,e){return Object.prototype.hasOwnProperty.call(n,e)}function Ne(n,e){if(Object.prototype.hasOwnProperty.call(n,e))return n[e]}function On(n){for(const e in n)if(Object.prototype.hasOwnProperty.call(n,e))return!1;return!0}function Lt(n,e,t){const s={};for(const i in n)Object.prototype.hasOwnProperty.call(n,i)&&(s[i]=e.call(t,n[i],i,n));return s}function Dt(n,e){if(n===e)return!0;const t=Object.keys(n),s=Object.keys(e);for(const i of t){if(!s.includes(i))return!1;const r=n[i],o=e[i];if(xs(r)&&xs(o)){if(!Dt(r,o))return!1}else if(r!==o)return!1}for(const i of s)if(!t.includes(i))return!1;return!0}function xs(n){return n!==null&&typeof n=="object"}function rl(n){const e=[];for(const[t,s]of Object.entries(n))Array.isArray(s)?s.forEach(i=>{e.push(encodeURIComponent(t)+"="+encodeURIComponent(i))}):e.push(encodeURIComponent(t)+"="+encodeURIComponent(s));return e.length?"&"+e.join("&"):""}class ol{constructor(){this.chain_=[],this.buf_=[],this.W_=[],this.pad_=[],this.inbuf_=0,this.total_=0,this.blockSize=512/8,this.pad_[0]=128;for(let e=1;e<this.blockSize;++e)this.pad_[e]=0;this.reset()}reset(){this.chain_[0]=1732584193,this.chain_[1]=4023233417,this.chain_[2]=2562383102,this.chain_[3]=271733878,this.chain_[4]=3285377520,this.inbuf_=0,this.total_=0}compress_(e,t){t||(t=0);const s=this.W_;if(typeof e=="string")for(let u=0;u<16;u++)s[u]=e.charCodeAt(t)<<24|e.charCodeAt(t+1)<<16|e.charCodeAt(t+2)<<8|e.charCodeAt(t+3),t+=4;else for(let u=0;u<16;u++)s[u]=e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3],t+=4;for(let u=16;u<80;u++){const h=s[u-3]^s[u-8]^s[u-14]^s[u-16];s[u]=(h<<1|h>>>31)&4294967295}let i=this.chain_[0],r=this.chain_[1],o=this.chain_[2],a=this.chain_[3],l=this.chain_[4],c,d;for(let u=0;u<80;u++){u<40?u<20?(c=a^r&(o^a),d=1518500249):(c=r^o^a,d=1859775393):u<60?(c=r&o|a&(r|o),d=2400959708):(c=r^o^a,d=3395469782);const h=(i<<5|i>>>27)+c+l+d+s[u]&4294967295;l=a,a=o,o=(r<<30|r>>>2)&4294967295,r=i,i=h}this.chain_[0]=this.chain_[0]+i&4294967295,this.chain_[1]=this.chain_[1]+r&4294967295,this.chain_[2]=this.chain_[2]+o&4294967295,this.chain_[3]=this.chain_[3]+a&4294967295,this.chain_[4]=this.chain_[4]+l&4294967295}update(e,t){if(e==null)return;t===void 0&&(t=e.length);const s=t-this.blockSize;let i=0;const r=this.buf_;let o=this.inbuf_;for(;i<t;){if(o===0)for(;i<=s;)this.compress_(e,i),i+=this.blockSize;if(typeof e=="string"){for(;i<t;)if(r[o]=e.charCodeAt(i),++o,++i,o===this.blockSize){this.compress_(r),o=0;break}}else for(;i<t;)if(r[o]=e[i],++o,++i,o===this.blockSize){this.compress_(r),o=0;break}}this.inbuf_=o,this.total_+=t}digest(){const e=[];let t=this.total_*8;this.inbuf_<56?this.update(this.pad_,56-this.inbuf_):this.update(this.pad_,this.blockSize-(this.inbuf_-56));for(let i=this.blockSize-1;i>=56;i--)this.buf_[i]=t&255,t/=256;this.compress_(this.buf_);let s=0;for(let i=0;i<5;i++)for(let r=24;r>=0;r-=8)e[s]=this.chain_[i]>>r&255,++s;return e}}function We(n,e){return`${n} failed: ${e} argument `}const al=function(n){const e=[];let t=0;for(let s=0;s<n.length;s++){let i=n.charCodeAt(s);if(i>=55296&&i<=56319){const r=i-55296;s++,g(s<n.length,"Surrogate pair missing trail surrogate.");const o=n.charCodeAt(s)-56320;i=65536+(r<<10)+o}i<128?e[t++]=i:i<2048?(e[t++]=i>>6|192,e[t++]=i&63|128):i<65536?(e[t++]=i>>12|224,e[t++]=i>>6&63|128,e[t++]=i&63|128):(e[t++]=i>>18|240,e[t++]=i>>12&63|128,e[t++]=i>>6&63|128,e[t++]=i&63|128)}return e},Qt=function(n){let e=0;for(let t=0;t<n.length;t++){const s=n.charCodeAt(t);s<128?e++:s<2048?e+=2:s>=55296&&s<=56319?(e+=4,t++):e+=3}return e};function ue(n){return n&&n._delegate?n._delegate:n}class dt{constructor(e,t,s){this.name=e,this.instanceFactory=t,this.type=s,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(e){return this.instantiationMode=e,this}setMultipleInstances(e){return this.multipleInstances=e,this}setServiceProps(e){return this.serviceProps=e,this}setInstanceCreatedCallback(e){return this.onInstanceCreated=e,this}}const be="[DEFAULT]";class ll{constructor(e,t){this.name=e,this.container=t,this.component=null,this.instances=new Map,this.instancesDeferred=new Map,this.instancesOptions=new Map,this.onInitCallbacks=new Map}get(e){const t=this.normalizeInstanceIdentifier(e);if(!this.instancesDeferred.has(t)){const s=new ee;if(this.instancesDeferred.set(t,s),this.isInitialized(t)||this.shouldAutoInitialize())try{const i=this.getOrInitializeService({instanceIdentifier:t});i&&s.resolve(i)}catch{}}return this.instancesDeferred.get(t).promise}getImmediate(e){const t=this.normalizeInstanceIdentifier(e?.identifier),s=e?.optional??!1;if(this.isInitialized(t)||this.shouldAutoInitialize())try{return this.getOrInitializeService({instanceIdentifier:t})}catch(i){if(s)return null;throw i}else{if(s)return null;throw Error(`Service ${this.name} is not available`)}}getComponent(){return this.component}setComponent(e){if(e.name!==this.name)throw Error(`Mismatching Component ${e.name} for Provider ${this.name}.`);if(this.component)throw Error(`Component for ${this.name} has already been provided`);if(this.component=e,!!this.shouldAutoInitialize()){if(hl(e))try{this.getOrInitializeService({instanceIdentifier:be})}catch{}for(const[t,s]of this.instancesDeferred.entries()){const i=this.normalizeInstanceIdentifier(t);try{const r=this.getOrInitializeService({instanceIdentifier:i});s.resolve(r)}catch{}}}}clearInstance(e=be){this.instancesDeferred.delete(e),this.instancesOptions.delete(e),this.instances.delete(e)}async delete(){const e=Array.from(this.instances.values());await Promise.all([...e.filter(t=>"INTERNAL"in t).map(t=>t.INTERNAL.delete()),...e.filter(t=>"_delete"in t).map(t=>t._delete())])}isComponentSet(){return this.component!=null}isInitialized(e=be){return this.instances.has(e)}getOptions(e=be){return this.instancesOptions.get(e)||{}}initialize(e={}){const{options:t={}}=e,s=this.normalizeInstanceIdentifier(e.instanceIdentifier);if(this.isInitialized(s))throw Error(`${this.name}(${s}) has already been initialized`);if(!this.isComponentSet())throw Error(`Component ${this.name} has not been registered yet`);const i=this.getOrInitializeService({instanceIdentifier:s,options:t});for(const[r,o]of this.instancesDeferred.entries()){const a=this.normalizeInstanceIdentifier(r);s===a&&o.resolve(i)}return i}onInit(e,t){const s=this.normalizeInstanceIdentifier(t),i=this.onInitCallbacks.get(s)??new Set;i.add(e),this.onInitCallbacks.set(s,i);const r=this.instances.get(s);return r&&e(r,s),()=>{i.delete(e)}}invokeOnInitCallbacks(e,t){const s=this.onInitCallbacks.get(t);if(s)for(const i of s)try{i(e,t)}catch{}}getOrInitializeService({instanceIdentifier:e,options:t={}}){let s=this.instances.get(e);if(!s&&this.component&&(s=this.component.instanceFactory(this.container,{instanceIdentifier:cl(e),options:t}),this.instances.set(e,s),this.instancesOptions.set(e,t),this.invokeOnInitCallbacks(s,e),this.component.onInstanceCreated))try{this.component.onInstanceCreated(this.container,e,s)}catch{}return s||null}normalizeInstanceIdentifier(e=be){return this.component?this.component.multipleInstances?e:be:e}shouldAutoInitialize(){return!!this.component&&this.component.instantiationMode!=="EXPLICIT"}}function cl(n){return n===be?void 0:n}function hl(n){return n.instantiationMode==="EAGER"}class dl{constructor(e){this.name=e,this.providers=new Map}addComponent(e){const t=this.getProvider(e.name);if(t.isComponentSet())throw new Error(`Component ${e.name} has already been registered with ${this.name}`);t.setComponent(e)}addOrOverwriteComponent(e){this.getProvider(e.name).isComponentSet()&&this.providers.delete(e.name),this.addComponent(e)}getProvider(e){if(this.providers.has(e))return this.providers.get(e);const t=new ll(e,this);return this.providers.set(e,t),t}getProviders(){return Array.from(this.providers.values())}}var k;(function(n){n[n.DEBUG=0]="DEBUG",n[n.VERBOSE=1]="VERBOSE",n[n.INFO=2]="INFO",n[n.WARN=3]="WARN",n[n.ERROR=4]="ERROR",n[n.SILENT=5]="SILENT"})(k||(k={}));const ul={debug:k.DEBUG,verbose:k.VERBOSE,info:k.INFO,warn:k.WARN,error:k.ERROR,silent:k.SILENT},fl=k.INFO,pl={[k.DEBUG]:"log",[k.VERBOSE]:"log",[k.INFO]:"info",[k.WARN]:"warn",[k.ERROR]:"error"},ml=(n,e,...t)=>{if(e<n.logLevel)return;const s=new Date().toISOString(),i=pl[e];if(i)console[i](`[${s}]  ${n.name}:`,...t);else throw new Error(`Attempted to log a message with an invalid logType (value: ${e})`)};class zi{constructor(e){this.name=e,this._logLevel=fl,this._logHandler=ml,this._userLogHandler=null}get logLevel(){return this._logLevel}set logLevel(e){if(!(e in k))throw new TypeError(`Invalid value "${e}" assigned to \`logLevel\``);this._logLevel=e}setLogLevel(e){this._logLevel=typeof e=="string"?ul[e]:e}get logHandler(){return this._logHandler}set logHandler(e){if(typeof e!="function")throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=e}get userLogHandler(){return this._userLogHandler}set userLogHandler(e){this._userLogHandler=e}debug(...e){this._userLogHandler&&this._userLogHandler(this,k.DEBUG,...e),this._logHandler(this,k.DEBUG,...e)}log(...e){this._userLogHandler&&this._userLogHandler(this,k.VERBOSE,...e),this._logHandler(this,k.VERBOSE,...e)}info(...e){this._userLogHandler&&this._userLogHandler(this,k.INFO,...e),this._logHandler(this,k.INFO,...e)}warn(...e){this._userLogHandler&&this._userLogHandler(this,k.WARN,...e),this._logHandler(this,k.WARN,...e)}error(...e){this._userLogHandler&&this._userLogHandler(this,k.ERROR,...e),this._logHandler(this,k.ERROR,...e)}}const gl=(n,e)=>e.some(t=>n instanceof t);let Bs,Fs;function _l(){return Bs||(Bs=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function yl(){return Fs||(Fs=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const Yi=new WeakMap,An=new WeakMap,ji=new WeakMap,pn=new WeakMap,Qn=new WeakMap;function El(n){const e=new Promise((t,s)=>{const i=()=>{n.removeEventListener("success",r),n.removeEventListener("error",o)},r=()=>{t(me(n.result)),i()},o=()=>{s(n.error),i()};n.addEventListener("success",r),n.addEventListener("error",o)});return e.then(t=>{t instanceof IDBCursor&&Yi.set(t,n)}).catch(()=>{}),Qn.set(e,n),e}function Cl(n){if(An.has(n))return;const e=new Promise((t,s)=>{const i=()=>{n.removeEventListener("complete",r),n.removeEventListener("error",o),n.removeEventListener("abort",o)},r=()=>{t(),i()},o=()=>{s(n.error||new DOMException("AbortError","AbortError")),i()};n.addEventListener("complete",r),n.addEventListener("error",o),n.addEventListener("abort",o)});An.set(n,e)}let kn={get(n,e,t){if(n instanceof IDBTransaction){if(e==="done")return An.get(n);if(e==="objectStoreNames")return n.objectStoreNames||ji.get(n);if(e==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return me(n[e])},set(n,e,t){return n[e]=t,!0},has(n,e){return n instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in n}};function vl(n){kn=n(kn)}function Sl(n){return n===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(e,...t){const s=n.call(mn(this),e,...t);return ji.set(s,e.sort?e.sort():[e]),me(s)}:yl().includes(n)?function(...e){return n.apply(mn(this),e),me(Yi.get(this))}:function(...e){return me(n.apply(mn(this),e))}}function bl(n){return typeof n=="function"?Sl(n):(n instanceof IDBTransaction&&Cl(n),gl(n,_l())?new Proxy(n,kn):n)}function me(n){if(n instanceof IDBRequest)return El(n);if(pn.has(n))return pn.get(n);const e=bl(n);return e!==n&&(pn.set(n,e),Qn.set(e,n)),e}const mn=n=>Qn.get(n);function wl(n,e,{blocked:t,upgrade:s,blocking:i,terminated:r}={}){const o=indexedDB.open(n,e),a=me(o);return s&&o.addEventListener("upgradeneeded",l=>{s(me(o.result),l.oldVersion,l.newVersion,me(o.transaction),l)}),t&&o.addEventListener("blocked",l=>t(l.oldVersion,l.newVersion,l)),a.then(l=>{r&&l.addEventListener("close",()=>r()),i&&l.addEventListener("versionchange",c=>i(c.oldVersion,c.newVersion,c))}).catch(()=>{}),a}const Il=["get","getKey","getAll","getAllKeys","count"],Tl=["put","add","delete","clear"],gn=new Map;function Ws(n,e){if(!(n instanceof IDBDatabase&&!(e in n)&&typeof e=="string"))return;if(gn.get(e))return gn.get(e);const t=e.replace(/FromIndex$/,""),s=e!==t,i=Tl.includes(t);if(!(t in(s?IDBIndex:IDBObjectStore).prototype)||!(i||Il.includes(t)))return;const r=async function(o,...a){const l=this.transaction(o,i?"readwrite":"readonly");let c=l.store;return s&&(c=c.index(a.shift())),(await Promise.all([c[t](...a),i&&l.done]))[0]};return gn.set(e,r),r}vl(n=>({...n,get:(e,t,s)=>Ws(e,t)||n.get(e,t,s),has:(e,t)=>!!Ws(e,t)||n.has(e,t)}));class Nl{constructor(e){this.container=e}getPlatformInfoString(){return this.container.getProviders().map(t=>{if(Rl(t)){const s=t.getImmediate();return`${s.library}/${s.version}`}else return null}).filter(t=>t).join(" ")}}function Rl(n){return n.getComponent()?.type==="VERSION"}const Ln="@firebase/app",Gs="0.14.7";const ce=new zi("@firebase/app"),Ol="@firebase/app-compat",Al="@firebase/analytics-compat",kl="@firebase/analytics",Ll="@firebase/app-check-compat",Dl="@firebase/app-check",Ml="@firebase/auth",Pl="@firebase/auth-compat",xl="@firebase/database",Bl="@firebase/data-connect",Fl="@firebase/database-compat",Wl="@firebase/functions",Gl="@firebase/functions-compat",Ul="@firebase/installations",Hl="@firebase/installations-compat",$l="@firebase/messaging",Vl="@firebase/messaging-compat",Kl="@firebase/performance",zl="@firebase/performance-compat",Yl="@firebase/remote-config",jl="@firebase/remote-config-compat",ql="@firebase/storage",Ql="@firebase/storage-compat",Xl="@firebase/firestore",Jl="@firebase/ai",Zl="@firebase/firestore-compat",ec="firebase",tc="12.8.0";const Dn="[DEFAULT]",nc={[Ln]:"fire-core",[Ol]:"fire-core-compat",[kl]:"fire-analytics",[Al]:"fire-analytics-compat",[Dl]:"fire-app-check",[Ll]:"fire-app-check-compat",[Ml]:"fire-auth",[Pl]:"fire-auth-compat",[xl]:"fire-rtdb",[Bl]:"fire-data-connect",[Fl]:"fire-rtdb-compat",[Wl]:"fire-fn",[Gl]:"fire-fn-compat",[Ul]:"fire-iid",[Hl]:"fire-iid-compat",[$l]:"fire-fcm",[Vl]:"fire-fcm-compat",[Kl]:"fire-perf",[zl]:"fire-perf-compat",[Yl]:"fire-rc",[jl]:"fire-rc-compat",[ql]:"fire-gcs",[Ql]:"fire-gcs-compat",[Xl]:"fire-fst",[Zl]:"fire-fst-compat",[Jl]:"fire-vertex","fire-js":"fire-js",[ec]:"fire-js-all"};const Mt=new Map,sc=new Map,Mn=new Map;function Us(n,e){try{n.container.addComponent(e)}catch(t){ce.debug(`Component ${e.name} failed to register with FirebaseApp ${n.name}`,t)}}function Pt(n){const e=n.name;if(Mn.has(e))return ce.debug(`There were multiple attempts to register component ${e}.`),!1;Mn.set(e,n);for(const t of Mt.values())Us(t,n);for(const t of sc.values())Us(t,n);return!0}function ic(n,e){const t=n.container.getProvider("heartbeat").getImmediate({optional:!0});return t&&t.triggerHeartbeat(),n.container.getProvider(e)}function rc(n){return n==null?!1:n.settings!==void 0}const oc={"no-app":"No Firebase App '{$appName}' has been created - call initializeApp() first","bad-app-name":"Illegal App name: '{$appName}'","duplicate-app":"Firebase App named '{$appName}' already exists with different options or config","app-deleted":"Firebase App named '{$appName}' already deleted","server-app-deleted":"Firebase Server App has been deleted","no-options":"Need to provide options, when not being deployed to hosting via source.","invalid-app-argument":"firebase.{$appName}() takes either no argument or a Firebase App instance.","invalid-log-argument":"First argument to `onLog` must be null or a function.","idb-open":"Error thrown when opening IndexedDB. Original error: {$originalErrorMessage}.","idb-get":"Error thrown when reading from IndexedDB. Original error: {$originalErrorMessage}.","idb-set":"Error thrown when writing to IndexedDB. Original error: {$originalErrorMessage}.","idb-delete":"Error thrown when deleting from IndexedDB. Original error: {$originalErrorMessage}.","finalization-registry-not-supported":"FirebaseServerApp deleteOnDeref field defined but the JS runtime does not support FinalizationRegistry.","invalid-server-app-environment":"FirebaseServerApp is not for use in browser environments."},ge=new Vi("app","Firebase",oc);class ac{constructor(e,t,s){this._isDeleted=!1,this._options={...e},this._config={...t},this._name=t.name,this._automaticDataCollectionEnabled=t.automaticDataCollectionEnabled,this._container=s,this.container.addComponent(new dt("app",()=>this,"PUBLIC"))}get automaticDataCollectionEnabled(){return this.checkDestroyed(),this._automaticDataCollectionEnabled}set automaticDataCollectionEnabled(e){this.checkDestroyed(),this._automaticDataCollectionEnabled=e}get name(){return this.checkDestroyed(),this._name}get options(){return this.checkDestroyed(),this._options}get config(){return this.checkDestroyed(),this._config}get container(){return this._container}get isDeleted(){return this._isDeleted}set isDeleted(e){this._isDeleted=e}checkDestroyed(){if(this.isDeleted)throw ge.create("app-deleted",{appName:this._name})}}const lc=tc;function qi(n,e={}){let t=n;typeof e!="object"&&(e={name:e});const s={name:Dn,automaticDataCollectionEnabled:!0,...e},i=s.name;if(typeof i!="string"||!i)throw ge.create("bad-app-name",{appName:String(i)});if(t||(t=Hi()),!t)throw ge.create("no-options");const r=Mt.get(i);if(r){if(Dt(t,r.options)&&Dt(s,r.config))return r;throw ge.create("duplicate-app",{appName:i})}const o=new dl(i);for(const l of Mn.values())o.addComponent(l);const a=new ac(t,s,o);return Mt.set(i,a),a}function cc(n=Dn){const e=Mt.get(n);if(!e&&n===Dn&&Hi())return qi();if(!e)throw ge.create("no-app",{appName:n});return e}function xe(n,e,t){let s=nc[n]??n;t&&(s+=`-${t}`);const i=s.match(/\s|\//),r=e.match(/\s|\//);if(i||r){const o=[`Unable to register library "${s}" with version "${e}":`];i&&o.push(`library name "${s}" contains illegal characters (whitespace or "/")`),i&&r&&o.push("and"),r&&o.push(`version name "${e}" contains illegal characters (whitespace or "/")`),ce.warn(o.join(" "));return}Pt(new dt(`${s}-version`,()=>({library:s,version:e}),"VERSION"))}const hc="firebase-heartbeat-database",dc=1,ut="firebase-heartbeat-store";let _n=null;function Qi(){return _n||(_n=wl(hc,dc,{upgrade:(n,e)=>{switch(e){case 0:try{n.createObjectStore(ut)}catch(t){console.warn(t)}}}}).catch(n=>{throw ge.create("idb-open",{originalErrorMessage:n.message})})),_n}async function uc(n){try{const t=(await Qi()).transaction(ut),s=await t.objectStore(ut).get(Xi(n));return await t.done,s}catch(e){if(e instanceof Ct)ce.warn(e.message);else{const t=ge.create("idb-get",{originalErrorMessage:e?.message});ce.warn(t.message)}}}async function Hs(n,e){try{const s=(await Qi()).transaction(ut,"readwrite");await s.objectStore(ut).put(e,Xi(n)),await s.done}catch(t){if(t instanceof Ct)ce.warn(t.message);else{const s=ge.create("idb-set",{originalErrorMessage:t?.message});ce.warn(s.message)}}}function Xi(n){return`${n.name}!${n.options.appId}`}const fc=1024,pc=30;class mc{constructor(e){this.container=e,this._heartbeatsCache=null;const t=this.container.getProvider("app").getImmediate();this._storage=new _c(t),this._heartbeatsCachePromise=this._storage.read().then(s=>(this._heartbeatsCache=s,s))}async triggerHeartbeat(){try{const t=this.container.getProvider("platform-logger").getImmediate().getPlatformInfoString(),s=$s();if(this._heartbeatsCache?.heartbeats==null&&(this._heartbeatsCache=await this._heartbeatsCachePromise,this._heartbeatsCache?.heartbeats==null)||this._heartbeatsCache.lastSentHeartbeatDate===s||this._heartbeatsCache.heartbeats.some(i=>i.date===s))return;if(this._heartbeatsCache.heartbeats.push({date:s,agent:t}),this._heartbeatsCache.heartbeats.length>pc){const i=yc(this._heartbeatsCache.heartbeats);this._heartbeatsCache.heartbeats.splice(i,1)}return this._storage.overwrite(this._heartbeatsCache)}catch(e){ce.warn(e)}}async getHeartbeatsHeader(){try{if(this._heartbeatsCache===null&&await this._heartbeatsCachePromise,this._heartbeatsCache?.heartbeats==null||this._heartbeatsCache.heartbeats.length===0)return"";const e=$s(),{heartbeatsToSend:t,unsentEntries:s}=gc(this._heartbeatsCache.heartbeats),i=kt(JSON.stringify({version:2,heartbeats:t}));return this._heartbeatsCache.lastSentHeartbeatDate=e,s.length>0?(this._heartbeatsCache.heartbeats=s,await this._storage.overwrite(this._heartbeatsCache)):(this._heartbeatsCache.heartbeats=[],this._storage.overwrite(this._heartbeatsCache)),i}catch(e){return ce.warn(e),""}}}function $s(){return new Date().toISOString().substring(0,10)}function gc(n,e=fc){const t=[];let s=n.slice();for(const i of n){const r=t.find(o=>o.agent===i.agent);if(r){if(r.dates.push(i.date),Vs(t)>e){r.dates.pop();break}}else if(t.push({agent:i.agent,dates:[i.date]}),Vs(t)>e){t.pop();break}s=s.slice(1)}return{heartbeatsToSend:t,unsentEntries:s}}class _c{constructor(e){this.app=e,this._canUseIndexedDBPromise=this.runIndexedDBEnvironmentCheck()}async runIndexedDBEnvironmentCheck(){return Ja()?Za().then(()=>!0).catch(()=>!1):!1}async read(){if(await this._canUseIndexedDBPromise){const t=await uc(this.app);return t?.heartbeats?t:{heartbeats:[]}}else return{heartbeats:[]}}async overwrite(e){if(await this._canUseIndexedDBPromise){const s=await this.read();return Hs(this.app,{lastSentHeartbeatDate:e.lastSentHeartbeatDate??s.lastSentHeartbeatDate,heartbeats:e.heartbeats})}else return}async add(e){if(await this._canUseIndexedDBPromise){const s=await this.read();return Hs(this.app,{lastSentHeartbeatDate:e.lastSentHeartbeatDate??s.lastSentHeartbeatDate,heartbeats:[...s.heartbeats,...e.heartbeats]})}else return}}function Vs(n){return kt(JSON.stringify({version:2,heartbeats:n})).length}function yc(n){if(n.length===0)return-1;let e=0,t=n[0].date;for(let s=1;s<n.length;s++)n[s].date<t&&(t=n[s].date,e=s);return e}function Ec(n){Pt(new dt("platform-logger",e=>new Nl(e),"PRIVATE")),Pt(new dt("heartbeat",e=>new mc(e),"PRIVATE")),xe(Ln,Gs,n),xe(Ln,Gs,"esm2020"),xe("fire-js","")}Ec("");var Cc="firebase",vc="12.8.0";xe(Cc,vc,"app");var Ks={};const zs="@firebase/database",Ys="1.1.0";let Ji="";function Sc(n){Ji=n}class bc{constructor(e){this.domStorage_=e,this.prefix_="firebase:"}set(e,t){t==null?this.domStorage_.removeItem(this.prefixedName_(e)):this.domStorage_.setItem(this.prefixedName_(e),B(t))}get(e){const t=this.domStorage_.getItem(this.prefixedName_(e));return t==null?null:ht(t)}remove(e){this.domStorage_.removeItem(this.prefixedName_(e))}prefixedName_(e){return this.prefix_+e}toString(){return this.domStorage_.toString()}}class wc{constructor(){this.cache_={},this.isInMemoryStorage=!0}set(e,t){t==null?delete this.cache_[e]:this.cache_[e]=t}get(e){return ie(this.cache_,e)?this.cache_[e]:null}remove(e){delete this.cache_[e]}}const Zi=function(n){try{if(typeof window<"u"&&typeof window[n]<"u"){const e=window[n];return e.setItem("firebase:sentinel","cache"),e.removeItem("firebase:sentinel"),new bc(e)}}catch{}return new wc},Ie=Zi("localStorage"),Ic=Zi("sessionStorage");const Be=new zi("@firebase/database"),er=(function(){let n=1;return function(){return n++}})(),tr=function(n){const e=al(n),t=new ol;t.update(e);const s=t.digest();return jn.encodeByteArray(s)},vt=function(...n){let e="";for(let t=0;t<n.length;t++){const s=n[t];Array.isArray(s)||s&&typeof s=="object"&&typeof s.length=="number"?e+=vt.apply(null,s):typeof s=="object"?e+=B(s):e+=s,e+=" "}return e};let rt=null,js=!0;const Tc=function(n,e){g(!0,"Can't turn on custom loggers persistently."),Be.logLevel=k.VERBOSE,rt=Be.log.bind(Be)},G=function(...n){if(js===!0&&(js=!1,rt===null&&Ic.get("logging_enabled")===!0&&Tc()),rt){const e=vt.apply(null,n);rt(e)}},St=function(n){return function(...e){G(n,...e)}},Pn=function(...n){const e="FIREBASE INTERNAL ERROR: "+vt(...n);Be.error(e)},he=function(...n){const e=`FIREBASE FATAL ERROR: ${vt(...n)}`;throw Be.error(e),new Error(e)},z=function(...n){const e="FIREBASE WARNING: "+vt(...n);Be.warn(e)},Nc=function(){typeof window<"u"&&window.location&&window.location.protocol&&window.location.protocol.indexOf("https:")!==-1&&z("Insecure Firebase access from a secure page. Please use https in calls to new Firebase().")},Xt=function(n){return typeof n=="number"&&(n!==n||n===Number.POSITIVE_INFINITY||n===Number.NEGATIVE_INFINITY)},Rc=function(n){if(document.readyState==="complete")n();else{let e=!1;const t=function(){if(!document.body){setTimeout(t,Math.floor(10));return}e||(e=!0,n())};document.addEventListener?(document.addEventListener("DOMContentLoaded",t,!1),window.addEventListener("load",t,!1)):document.attachEvent&&(document.attachEvent("onreadystatechange",()=>{document.readyState==="complete"&&t()}),window.attachEvent("onload",t))}},Ge="[MIN_NAME]",Re="[MAX_NAME]",ke=function(n,e){if(n===e)return 0;if(n===Ge||e===Re)return-1;if(e===Ge||n===Re)return 1;{const t=qs(n),s=qs(e);return t!==null?s!==null?t-s===0?n.length-e.length:t-s:-1:s!==null?1:n<e?-1:1}},Oc=function(n,e){return n===e?0:n<e?-1:1},Je=function(n,e){if(e&&n in e)return e[n];throw new Error("Missing required key ("+n+") in object: "+B(e))},Xn=function(n){if(typeof n!="object"||n===null)return B(n);const e=[];for(const s in n)e.push(s);e.sort();let t="{";for(let s=0;s<e.length;s++)s!==0&&(t+=","),t+=B(e[s]),t+=":",t+=Xn(n[e[s]]);return t+="}",t},nr=function(n,e){const t=n.length;if(t<=e)return[n];const s=[];for(let i=0;i<t;i+=e)i+e>t?s.push(n.substring(i,t)):s.push(n.substring(i,i+e));return s};function U(n,e){for(const t in n)n.hasOwnProperty(t)&&e(t,n[t])}const sr=function(n){g(!Xt(n),"Invalid JSON number");const e=11,t=52,s=(1<<e-1)-1;let i,r,o,a,l;n===0?(r=0,o=0,i=1/n===-1/0?1:0):(i=n<0,n=Math.abs(n),n>=Math.pow(2,1-s)?(a=Math.min(Math.floor(Math.log(n)/Math.LN2),s),r=a+s,o=Math.round(n*Math.pow(2,t-a)-Math.pow(2,t))):(r=0,o=Math.round(n/Math.pow(2,1-s-t))));const c=[];for(l=t;l;l-=1)c.push(o%2?1:0),o=Math.floor(o/2);for(l=e;l;l-=1)c.push(r%2?1:0),r=Math.floor(r/2);c.push(i?1:0),c.reverse();const d=c.join("");let u="";for(l=0;l<64;l+=8){let h=parseInt(d.substr(l,8),2).toString(16);h.length===1&&(h="0"+h),u=u+h}return u.toLowerCase()},Ac=function(){return!!(typeof window=="object"&&window.chrome&&window.chrome.extension&&!/^chrome/.test(window.location.href))},kc=function(){return typeof Windows=="object"&&typeof Windows.UI=="object"};function Lc(n,e){let t="Unknown Error";n==="too_big"?t="The data requested exceeds the maximum size that can be accessed with a single request.":n==="permission_denied"?t="Client doesn't have permission to access the desired data.":n==="unavailable"&&(t="The service is unavailable");const s=new Error(n+" at "+e._path.toString()+": "+t);return s.code=n.toUpperCase(),s}const Dc=new RegExp("^-?(0*)\\d{1,10}$"),Mc=-2147483648,Pc=2147483647,qs=function(n){if(Dc.test(n)){const e=Number(n);if(e>=Mc&&e<=Pc)return e}return null},je=function(n){try{n()}catch(e){setTimeout(()=>{const t=e.stack||"";throw z("Exception was thrown by user callback.",t),e},Math.floor(0))}},xc=function(){return(typeof window=="object"&&window.navigator&&window.navigator.userAgent||"").search(/googlebot|google webmaster tools|bingbot|yahoo! slurp|baiduspider|yandexbot|duckduckbot/i)>=0},ot=function(n,e){const t=setTimeout(n,e);return typeof t=="number"&&typeof Deno<"u"&&Deno.unrefTimer?Deno.unrefTimer(t):typeof t=="object"&&t.unref&&t.unref(),t};class Bc{constructor(e,t){this.appCheckProvider=t,this.appName=e.name,rc(e)&&e.settings.appCheckToken&&(this.serverAppAppCheckToken=e.settings.appCheckToken),this.appCheck=t?.getImmediate({optional:!0}),this.appCheck||t?.get().then(s=>this.appCheck=s)}getToken(e){if(this.serverAppAppCheckToken){if(e)throw new Error("Attempted reuse of `FirebaseServerApp.appCheckToken` after previous usage failed.");return Promise.resolve({token:this.serverAppAppCheckToken})}return this.appCheck?this.appCheck.getToken(e):new Promise((t,s)=>{setTimeout(()=>{this.appCheck?this.getToken(e).then(t,s):t(null)},0)})}addTokenChangeListener(e){this.appCheckProvider?.get().then(t=>t.addTokenListener(e))}notifyForInvalidToken(){z(`Provided AppCheck credentials for the app named "${this.appName}" are invalid. This usually indicates your app was not initialized correctly.`)}}class Fc{constructor(e,t,s){this.appName_=e,this.firebaseOptions_=t,this.authProvider_=s,this.auth_=null,this.auth_=s.getImmediate({optional:!0}),this.auth_||s.onInit(i=>this.auth_=i)}getToken(e){return this.auth_?this.auth_.getToken(e).catch(t=>t&&t.code==="auth/token-not-initialized"?(G("Got auth/token-not-initialized error.  Treating as null token."),null):Promise.reject(t)):new Promise((t,s)=>{setTimeout(()=>{this.auth_?this.getToken(e).then(t,s):t(null)},0)})}addTokenChangeListener(e){this.auth_?this.auth_.addAuthTokenListener(e):this.authProvider_.get().then(t=>t.addAuthTokenListener(e))}removeTokenChangeListener(e){this.authProvider_.get().then(t=>t.removeAuthTokenListener(e))}notifyForInvalidToken(){let e='Provided authentication credentials for the app named "'+this.appName_+'" are invalid. This usually indicates your app was not initialized correctly. ';"credential"in this.firebaseOptions_?e+='Make sure the "credential" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':"serviceAccount"in this.firebaseOptions_?e+='Make sure the "serviceAccount" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':e+='Make sure the "apiKey" and "databaseURL" properties provided to initializeApp() match the values provided for your app at https://console.firebase.google.com/.',z(e)}}class At{constructor(e){this.accessToken=e}getToken(e){return Promise.resolve({accessToken:this.accessToken})}addTokenChangeListener(e){e(this.accessToken)}removeTokenChangeListener(e){}notifyForInvalidToken(){}}At.OWNER="owner";const Jn="5",ir="v",rr="s",or="r",ar="f",lr=/(console\.firebase|firebase-console-\w+\.corp|firebase\.corp)\.google\.com/,cr="ls",hr="p",xn="ac",dr="websocket",ur="long_polling";class fr{constructor(e,t,s,i,r=!1,o="",a=!1,l=!1,c=null){this.secure=t,this.namespace=s,this.webSocketOnly=i,this.nodeAdmin=r,this.persistenceKey=o,this.includeNamespaceInQueryParams=a,this.isUsingEmulator=l,this.emulatorOptions=c,this._host=e.toLowerCase(),this._domain=this._host.substr(this._host.indexOf(".")+1),this.internalHost=Ie.get("host:"+e)||this._host}isCacheableHost(){return this.internalHost.substr(0,2)==="s-"}isCustomHost(){return this._domain!=="firebaseio.com"&&this._domain!=="firebaseio-demo.com"}get host(){return this._host}set host(e){e!==this.internalHost&&(this.internalHost=e,this.isCacheableHost()&&Ie.set("host:"+this._host,this.internalHost))}toString(){let e=this.toURLString();return this.persistenceKey&&(e+="<"+this.persistenceKey+">"),e}toURLString(){const e=this.secure?"https://":"http://",t=this.includeNamespaceInQueryParams?`?ns=${this.namespace}`:"";return`${e}${this.host}/${t}`}}function Wc(n){return n.host!==n.internalHost||n.isCustomHost()||n.includeNamespaceInQueryParams}function pr(n,e,t){g(typeof e=="string","typeof type must == string"),g(typeof t=="object","typeof params must == object");let s;if(e===dr)s=(n.secure?"wss://":"ws://")+n.internalHost+"/.ws?";else if(e===ur)s=(n.secure?"https://":"http://")+n.internalHost+"/.lp?";else throw new Error("Unknown connection type: "+e);Wc(n)&&(t.ns=n.namespace);const i=[];return U(t,(r,o)=>{i.push(r+"="+o)}),s+i.join("&")}class Gc{constructor(){this.counters_={}}incrementCounter(e,t=1){ie(this.counters_,e)||(this.counters_[e]=0),this.counters_[e]+=t}get(){return xa(this.counters_)}}const yn={},En={};function Zn(n){const e=n.toString();return yn[e]||(yn[e]=new Gc),yn[e]}function Uc(n,e){const t=n.toString();return En[t]||(En[t]=e()),En[t]}class Hc{constructor(e){this.onMessage_=e,this.pendingResponses=[],this.currentResponseNum=0,this.closeAfterResponse=-1,this.onClose=null}closeAfter(e,t){this.closeAfterResponse=e,this.onClose=t,this.closeAfterResponse<this.currentResponseNum&&(this.onClose(),this.onClose=null)}handleResponse(e,t){for(this.pendingResponses[e]=t;this.pendingResponses[this.currentResponseNum];){const s=this.pendingResponses[this.currentResponseNum];delete this.pendingResponses[this.currentResponseNum];for(let i=0;i<s.length;++i)s[i]&&je(()=>{this.onMessage_(s[i])});if(this.currentResponseNum===this.closeAfterResponse){this.onClose&&(this.onClose(),this.onClose=null);break}this.currentResponseNum++}}}const Qs="start",$c="close",Vc="pLPCommand",Kc="pRTLPCB",mr="id",gr="pw",_r="ser",zc="cb",Yc="seg",jc="ts",qc="d",Qc="dframe",yr=1870,Er=30,Xc=yr-Er,Jc=25e3,Zc=3e4;class Pe{constructor(e,t,s,i,r,o,a){this.connId=e,this.repoInfo=t,this.applicationId=s,this.appCheckToken=i,this.authToken=r,this.transportSessionId=o,this.lastSessionId=a,this.bytesSent=0,this.bytesReceived=0,this.everConnected_=!1,this.log_=St(e),this.stats_=Zn(t),this.urlFn=l=>(this.appCheckToken&&(l[xn]=this.appCheckToken),pr(t,ur,l))}open(e,t){this.curSegmentNum=0,this.onDisconnect_=t,this.myPacketOrderer=new Hc(e),this.isClosed_=!1,this.connectTimeoutTimer_=setTimeout(()=>{this.log_("Timed out trying to connect."),this.onClosed_(),this.connectTimeoutTimer_=null},Math.floor(Zc)),Rc(()=>{if(this.isClosed_)return;this.scriptTagHolder=new es((...r)=>{const[o,a,l,c,d]=r;if(this.incrementIncomingBytes_(r),!!this.scriptTagHolder)if(this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null),this.everConnected_=!0,o===Qs)this.id=a,this.password=l;else if(o===$c)a?(this.scriptTagHolder.sendNewPolls=!1,this.myPacketOrderer.closeAfter(a,()=>{this.onClosed_()})):this.onClosed_();else throw new Error("Unrecognized command received: "+o)},(...r)=>{const[o,a]=r;this.incrementIncomingBytes_(r),this.myPacketOrderer.handleResponse(o,a)},()=>{this.onClosed_()},this.urlFn);const s={};s[Qs]="t",s[_r]=Math.floor(Math.random()*1e8),this.scriptTagHolder.uniqueCallbackIdentifier&&(s[zc]=this.scriptTagHolder.uniqueCallbackIdentifier),s[ir]=Jn,this.transportSessionId&&(s[rr]=this.transportSessionId),this.lastSessionId&&(s[cr]=this.lastSessionId),this.applicationId&&(s[hr]=this.applicationId),this.appCheckToken&&(s[xn]=this.appCheckToken),typeof location<"u"&&location.hostname&&lr.test(location.hostname)&&(s[or]=ar);const i=this.urlFn(s);this.log_("Connecting via long-poll to "+i),this.scriptTagHolder.addTag(i,()=>{})})}start(){this.scriptTagHolder.startLongPoll(this.id,this.password),this.addDisconnectPingFrame(this.id,this.password)}static forceAllow(){Pe.forceAllow_=!0}static forceDisallow(){Pe.forceDisallow_=!0}static isAvailable(){return Pe.forceAllow_?!0:!Pe.forceDisallow_&&typeof document<"u"&&document.createElement!=null&&!Ac()&&!kc()}markConnectionHealthy(){}shutdown_(){this.isClosed_=!0,this.scriptTagHolder&&(this.scriptTagHolder.close(),this.scriptTagHolder=null),this.myDisconnFrame&&(document.body.removeChild(this.myDisconnFrame),this.myDisconnFrame=null),this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null)}onClosed_(){this.isClosed_||(this.log_("Longpoll is closing itself"),this.shutdown_(),this.onDisconnect_&&(this.onDisconnect_(this.everConnected_),this.onDisconnect_=null))}close(){this.isClosed_||(this.log_("Longpoll is being closed."),this.shutdown_())}send(e){const t=B(e);this.bytesSent+=t.length,this.stats_.incrementCounter("bytes_sent",t.length);const s=Wi(t),i=nr(s,Xc);for(let r=0;r<i.length;r++)this.scriptTagHolder.enqueueSegment(this.curSegmentNum,i.length,i[r]),this.curSegmentNum++}addDisconnectPingFrame(e,t){this.myDisconnFrame=document.createElement("iframe");const s={};s[Qc]="t",s[mr]=e,s[gr]=t,this.myDisconnFrame.src=this.urlFn(s),this.myDisconnFrame.style.display="none",document.body.appendChild(this.myDisconnFrame)}incrementIncomingBytes_(e){const t=B(e).length;this.bytesReceived+=t,this.stats_.incrementCounter("bytes_received",t)}}class es{constructor(e,t,s,i){this.onDisconnect=s,this.urlFn=i,this.outstandingRequests=new Set,this.pendingSegs=[],this.currentSerial=Math.floor(Math.random()*1e8),this.sendNewPolls=!0;{this.uniqueCallbackIdentifier=er(),window[Vc+this.uniqueCallbackIdentifier]=e,window[Kc+this.uniqueCallbackIdentifier]=t,this.myIFrame=es.createIFrame_();let r="";this.myIFrame.src&&this.myIFrame.src.substr(0,11)==="javascript:"&&(r='<script>document.domain="'+document.domain+'";<\/script>');const o="<html><body>"+r+"</body></html>";try{this.myIFrame.doc.open(),this.myIFrame.doc.write(o),this.myIFrame.doc.close()}catch(a){G("frame writing exception"),a.stack&&G(a.stack),G(a)}}}static createIFrame_(){const e=document.createElement("iframe");if(e.style.display="none",document.body){document.body.appendChild(e);try{e.contentWindow.document||G("No IE domain setting required")}catch{const s=document.domain;e.src="javascript:void((function(){document.open();document.domain='"+s+"';document.close();})())"}}else throw"Document body has not initialized. Wait to initialize Firebase until after the document is ready.";return e.contentDocument?e.doc=e.contentDocument:e.contentWindow?e.doc=e.contentWindow.document:e.document&&(e.doc=e.document),e}close(){this.alive=!1,this.myIFrame&&(this.myIFrame.doc.body.textContent="",setTimeout(()=>{this.myIFrame!==null&&(document.body.removeChild(this.myIFrame),this.myIFrame=null)},Math.floor(0)));const e=this.onDisconnect;e&&(this.onDisconnect=null,e())}startLongPoll(e,t){for(this.myID=e,this.myPW=t,this.alive=!0;this.newRequest_(););}newRequest_(){if(this.alive&&this.sendNewPolls&&this.outstandingRequests.size<(this.pendingSegs.length>0?2:1)){this.currentSerial++;const e={};e[mr]=this.myID,e[gr]=this.myPW,e[_r]=this.currentSerial;let t=this.urlFn(e),s="",i=0;for(;this.pendingSegs.length>0&&this.pendingSegs[0].d.length+Er+s.length<=yr;){const o=this.pendingSegs.shift();s=s+"&"+Yc+i+"="+o.seg+"&"+jc+i+"="+o.ts+"&"+qc+i+"="+o.d,i++}return t=t+s,this.addLongPollTag_(t,this.currentSerial),!0}else return!1}enqueueSegment(e,t,s){this.pendingSegs.push({seg:e,ts:t,d:s}),this.alive&&this.newRequest_()}addLongPollTag_(e,t){this.outstandingRequests.add(t);const s=()=>{this.outstandingRequests.delete(t),this.newRequest_()},i=setTimeout(s,Math.floor(Jc)),r=()=>{clearTimeout(i),s()};this.addTag(e,r)}addTag(e,t){setTimeout(()=>{try{if(!this.sendNewPolls)return;const s=this.myIFrame.doc.createElement("script");s.type="text/javascript",s.async=!0,s.src=e,s.onload=s.onreadystatechange=function(){const i=s.readyState;(!i||i==="loaded"||i==="complete")&&(s.onload=s.onreadystatechange=null,s.parentNode&&s.parentNode.removeChild(s),t())},s.onerror=()=>{G("Long-poll script failed to load: "+e),this.sendNewPolls=!1,this.close()},this.myIFrame.doc.body.appendChild(s)}catch{}},Math.floor(1))}}const eh=16384,th=45e3;let xt=null;typeof MozWebSocket<"u"?xt=MozWebSocket:typeof WebSocket<"u"&&(xt=WebSocket);class te{constructor(e,t,s,i,r,o,a){this.connId=e,this.applicationId=s,this.appCheckToken=i,this.authToken=r,this.keepaliveTimer=null,this.frames=null,this.totalFrames=0,this.bytesSent=0,this.bytesReceived=0,this.log_=St(this.connId),this.stats_=Zn(t),this.connURL=te.connectionURL_(t,o,a,i,s),this.nodeAdmin=t.nodeAdmin}static connectionURL_(e,t,s,i,r){const o={};return o[ir]=Jn,typeof location<"u"&&location.hostname&&lr.test(location.hostname)&&(o[or]=ar),t&&(o[rr]=t),s&&(o[cr]=s),i&&(o[xn]=i),r&&(o[hr]=r),pr(e,dr,o)}open(e,t){this.onDisconnect=t,this.onMessage=e,this.log_("Websocket connecting to "+this.connURL),this.everConnected_=!1,Ie.set("previous_websocket_failure",!0);try{let s;Xa(),this.mySock=new xt(this.connURL,[],s)}catch(s){this.log_("Error instantiating WebSocket.");const i=s.message||s.data;i&&this.log_(i),this.onClosed_();return}this.mySock.onopen=()=>{this.log_("Websocket connected."),this.everConnected_=!0},this.mySock.onclose=()=>{this.log_("Websocket connection was disconnected."),this.mySock=null,this.onClosed_()},this.mySock.onmessage=s=>{this.handleIncomingFrame(s)},this.mySock.onerror=s=>{this.log_("WebSocket error.  Closing connection.");const i=s.message||s.data;i&&this.log_(i),this.onClosed_()}}start(){}static forceDisallow(){te.forceDisallow_=!0}static isAvailable(){let e=!1;if(typeof navigator<"u"&&navigator.userAgent){const t=/Android ([0-9]{0,}\.[0-9]{0,})/,s=navigator.userAgent.match(t);s&&s.length>1&&parseFloat(s[1])<4.4&&(e=!0)}return!e&&xt!==null&&!te.forceDisallow_}static previouslyFailed(){return Ie.isInMemoryStorage||Ie.get("previous_websocket_failure")===!0}markConnectionHealthy(){Ie.remove("previous_websocket_failure")}appendFrame_(e){if(this.frames.push(e),this.frames.length===this.totalFrames){const t=this.frames.join("");this.frames=null;const s=ht(t);this.onMessage(s)}}handleNewFrameCount_(e){this.totalFrames=e,this.frames=[]}extractFrameCount_(e){if(g(this.frames===null,"We already have a frame buffer"),e.length<=6){const t=Number(e);if(!isNaN(t))return this.handleNewFrameCount_(t),null}return this.handleNewFrameCount_(1),e}handleIncomingFrame(e){if(this.mySock===null)return;const t=e.data;if(this.bytesReceived+=t.length,this.stats_.incrementCounter("bytes_received",t.length),this.resetKeepAlive(),this.frames!==null)this.appendFrame_(t);else{const s=this.extractFrameCount_(t);s!==null&&this.appendFrame_(s)}}send(e){this.resetKeepAlive();const t=B(e);this.bytesSent+=t.length,this.stats_.incrementCounter("bytes_sent",t.length);const s=nr(t,eh);s.length>1&&this.sendString_(String(s.length));for(let i=0;i<s.length;i++)this.sendString_(s[i])}shutdown_(){this.isClosed_=!0,this.keepaliveTimer&&(clearInterval(this.keepaliveTimer),this.keepaliveTimer=null),this.mySock&&(this.mySock.close(),this.mySock=null)}onClosed_(){this.isClosed_||(this.log_("WebSocket is closing itself"),this.shutdown_(),this.onDisconnect&&(this.onDisconnect(this.everConnected_),this.onDisconnect=null))}close(){this.isClosed_||(this.log_("WebSocket is being closed"),this.shutdown_())}resetKeepAlive(){clearInterval(this.keepaliveTimer),this.keepaliveTimer=setInterval(()=>{this.mySock&&this.sendString_("0"),this.resetKeepAlive()},Math.floor(th))}sendString_(e){try{this.mySock.send(e)}catch(t){this.log_("Exception thrown from WebSocket.send():",t.message||t.data,"Closing connection."),setTimeout(this.onClosed_.bind(this),0)}}}te.responsesRequiredToBeHealthy=2;te.healthyTimeout=3e4;class ft{static get ALL_TRANSPORTS(){return[Pe,te]}static get IS_TRANSPORT_INITIALIZED(){return this.globalTransportInitialized_}constructor(e){this.initTransports_(e)}initTransports_(e){const t=te&&te.isAvailable();let s=t&&!te.previouslyFailed();if(e.webSocketOnly&&(t||z("wss:// URL used, but browser isn't known to support websockets.  Trying anyway."),s=!0),s)this.transports_=[te];else{const i=this.transports_=[];for(const r of ft.ALL_TRANSPORTS)r&&r.isAvailable()&&i.push(r);ft.globalTransportInitialized_=!0}}initialTransport(){if(this.transports_.length>0)return this.transports_[0];throw new Error("No transports available")}upgradeTransport(){return this.transports_.length>1?this.transports_[1]:null}}ft.globalTransportInitialized_=!1;const nh=6e4,sh=5e3,ih=10*1024,rh=100*1024,Cn="t",Xs="d",oh="s",Js="r",ah="e",Zs="o",ei="a",ti="n",ni="p",lh="h";class ch{constructor(e,t,s,i,r,o,a,l,c,d){this.id=e,this.repoInfo_=t,this.applicationId_=s,this.appCheckToken_=i,this.authToken_=r,this.onMessage_=o,this.onReady_=a,this.onDisconnect_=l,this.onKill_=c,this.lastSessionId=d,this.connectionCount=0,this.pendingDataMessages=[],this.state_=0,this.log_=St("c:"+this.id+":"),this.transportManager_=new ft(t),this.log_("Connection created"),this.start_()}start_(){const e=this.transportManager_.initialTransport();this.conn_=new e(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,null,this.lastSessionId),this.primaryResponsesRequired_=e.responsesRequiredToBeHealthy||0;const t=this.connReceiver_(this.conn_),s=this.disconnReceiver_(this.conn_);this.tx_=this.conn_,this.rx_=this.conn_,this.secondaryConn_=null,this.isHealthy_=!1,setTimeout(()=>{this.conn_&&this.conn_.open(t,s)},Math.floor(0));const i=e.healthyTimeout||0;i>0&&(this.healthyTimeout_=ot(()=>{this.healthyTimeout_=null,this.isHealthy_||(this.conn_&&this.conn_.bytesReceived>rh?(this.log_("Connection exceeded healthy timeout but has received "+this.conn_.bytesReceived+" bytes.  Marking connection healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()):this.conn_&&this.conn_.bytesSent>ih?this.log_("Connection exceeded healthy timeout but has sent "+this.conn_.bytesSent+" bytes.  Leaving connection alive."):(this.log_("Closing unhealthy connection after timeout."),this.close()))},Math.floor(i)))}nextTransportId_(){return"c:"+this.id+":"+this.connectionCount++}disconnReceiver_(e){return t=>{e===this.conn_?this.onConnectionLost_(t):e===this.secondaryConn_?(this.log_("Secondary connection lost."),this.onSecondaryConnectionLost_()):this.log_("closing an old connection")}}connReceiver_(e){return t=>{this.state_!==2&&(e===this.rx_?this.onPrimaryMessageReceived_(t):e===this.secondaryConn_?this.onSecondaryMessageReceived_(t):this.log_("message on old connection"))}}sendRequest(e){const t={t:"d",d:e};this.sendData_(t)}tryCleanupConnection(){this.tx_===this.secondaryConn_&&this.rx_===this.secondaryConn_&&(this.log_("cleaning up and promoting a connection: "+this.secondaryConn_.connId),this.conn_=this.secondaryConn_,this.secondaryConn_=null)}onSecondaryControl_(e){if(Cn in e){const t=e[Cn];t===ei?this.upgradeIfSecondaryHealthy_():t===Js?(this.log_("Got a reset on secondary, closing it"),this.secondaryConn_.close(),(this.tx_===this.secondaryConn_||this.rx_===this.secondaryConn_)&&this.close()):t===Zs&&(this.log_("got pong on secondary."),this.secondaryResponsesRequired_--,this.upgradeIfSecondaryHealthy_())}}onSecondaryMessageReceived_(e){const t=Je("t",e),s=Je("d",e);if(t==="c")this.onSecondaryControl_(s);else if(t==="d")this.pendingDataMessages.push(s);else throw new Error("Unknown protocol layer: "+t)}upgradeIfSecondaryHealthy_(){this.secondaryResponsesRequired_<=0?(this.log_("Secondary connection is healthy."),this.isHealthy_=!0,this.secondaryConn_.markConnectionHealthy(),this.proceedWithUpgrade_()):(this.log_("sending ping on secondary."),this.secondaryConn_.send({t:"c",d:{t:ni,d:{}}}))}proceedWithUpgrade_(){this.secondaryConn_.start(),this.log_("sending client ack on secondary"),this.secondaryConn_.send({t:"c",d:{t:ei,d:{}}}),this.log_("Ending transmission on primary"),this.conn_.send({t:"c",d:{t:ti,d:{}}}),this.tx_=this.secondaryConn_,this.tryCleanupConnection()}onPrimaryMessageReceived_(e){const t=Je("t",e),s=Je("d",e);t==="c"?this.onControl_(s):t==="d"&&this.onDataMessage_(s)}onDataMessage_(e){this.onPrimaryResponse_(),this.onMessage_(e)}onPrimaryResponse_(){this.isHealthy_||(this.primaryResponsesRequired_--,this.primaryResponsesRequired_<=0&&(this.log_("Primary connection is healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()))}onControl_(e){const t=Je(Cn,e);if(Xs in e){const s=e[Xs];if(t===lh){const i={...s};this.repoInfo_.isUsingEmulator&&(i.h=this.repoInfo_.host),this.onHandshake_(i)}else if(t===ti){this.log_("recvd end transmission on primary"),this.rx_=this.secondaryConn_;for(let i=0;i<this.pendingDataMessages.length;++i)this.onDataMessage_(this.pendingDataMessages[i]);this.pendingDataMessages=[],this.tryCleanupConnection()}else t===oh?this.onConnectionShutdown_(s):t===Js?this.onReset_(s):t===ah?Pn("Server Error: "+s):t===Zs?(this.log_("got pong on primary."),this.onPrimaryResponse_(),this.sendPingOnPrimaryIfNecessary_()):Pn("Unknown control packet command: "+t)}}onHandshake_(e){const t=e.ts,s=e.v,i=e.h;this.sessionId=e.s,this.repoInfo_.host=i,this.state_===0&&(this.conn_.start(),this.onConnectionEstablished_(this.conn_,t),Jn!==s&&z("Protocol version mismatch detected"),this.tryStartUpgrade_())}tryStartUpgrade_(){const e=this.transportManager_.upgradeTransport();e&&this.startUpgrade_(e)}startUpgrade_(e){this.secondaryConn_=new e(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,this.sessionId),this.secondaryResponsesRequired_=e.responsesRequiredToBeHealthy||0;const t=this.connReceiver_(this.secondaryConn_),s=this.disconnReceiver_(this.secondaryConn_);this.secondaryConn_.open(t,s),ot(()=>{this.secondaryConn_&&(this.log_("Timed out trying to upgrade."),this.secondaryConn_.close())},Math.floor(nh))}onReset_(e){this.log_("Reset packet received.  New host: "+e),this.repoInfo_.host=e,this.state_===1?this.close():(this.closeConnections_(),this.start_())}onConnectionEstablished_(e,t){this.log_("Realtime connection established."),this.conn_=e,this.state_=1,this.onReady_&&(this.onReady_(t,this.sessionId),this.onReady_=null),this.primaryResponsesRequired_===0?(this.log_("Primary connection is healthy."),this.isHealthy_=!0):ot(()=>{this.sendPingOnPrimaryIfNecessary_()},Math.floor(sh))}sendPingOnPrimaryIfNecessary_(){!this.isHealthy_&&this.state_===1&&(this.log_("sending ping on primary."),this.sendData_({t:"c",d:{t:ni,d:{}}}))}onSecondaryConnectionLost_(){const e=this.secondaryConn_;this.secondaryConn_=null,(this.tx_===e||this.rx_===e)&&this.close()}onConnectionLost_(e){this.conn_=null,!e&&this.state_===0?(this.log_("Realtime connection failed."),this.repoInfo_.isCacheableHost()&&(Ie.remove("host:"+this.repoInfo_.host),this.repoInfo_.internalHost=this.repoInfo_.host)):this.state_===1&&this.log_("Realtime connection lost."),this.close()}onConnectionShutdown_(e){this.log_("Connection shutdown command received. Shutting down..."),this.onKill_&&(this.onKill_(e),this.onKill_=null),this.onDisconnect_=null,this.close()}sendData_(e){if(this.state_!==1)throw"Connection is not connected";this.tx_.send(e)}close(){this.state_!==2&&(this.log_("Closing realtime connection."),this.state_=2,this.closeConnections_(),this.onDisconnect_&&(this.onDisconnect_(),this.onDisconnect_=null))}closeConnections_(){this.log_("Shutting down all connections"),this.conn_&&(this.conn_.close(),this.conn_=null),this.secondaryConn_&&(this.secondaryConn_.close(),this.secondaryConn_=null),this.healthyTimeout_&&(clearTimeout(this.healthyTimeout_),this.healthyTimeout_=null)}}class Cr{put(e,t,s,i){}merge(e,t,s,i){}refreshAuthToken(e){}refreshAppCheckToken(e){}onDisconnectPut(e,t,s){}onDisconnectMerge(e,t,s){}onDisconnectCancel(e,t){}reportStats(e){}}class vr{constructor(e){this.allowedEvents_=e,this.listeners_={},g(Array.isArray(e)&&e.length>0,"Requires a non-empty array")}trigger(e,...t){if(Array.isArray(this.listeners_[e])){const s=[...this.listeners_[e]];for(let i=0;i<s.length;i++)s[i].callback.apply(s[i].context,t)}}on(e,t,s){this.validateEventType_(e),this.listeners_[e]=this.listeners_[e]||[],this.listeners_[e].push({callback:t,context:s});const i=this.getInitialEvent(e);i&&t.apply(s,i)}off(e,t,s){this.validateEventType_(e);const i=this.listeners_[e]||[];for(let r=0;r<i.length;r++)if(i[r].callback===t&&(!s||s===i[r].context)){i.splice(r,1);return}}validateEventType_(e){g(this.allowedEvents_.find(t=>t===e),"Unknown event: "+e)}}class Bt extends vr{static getInstance(){return new Bt}constructor(){super(["online"]),this.online_=!0,typeof window<"u"&&typeof window.addEventListener<"u"&&!$i()&&(window.addEventListener("online",()=>{this.online_||(this.online_=!0,this.trigger("online",!0))},!1),window.addEventListener("offline",()=>{this.online_&&(this.online_=!1,this.trigger("online",!1))},!1))}getInitialEvent(e){return g(e==="online","Unknown event type: "+e),[this.online_]}currentlyOnline(){return this.online_}}const si=32,ii=768;class I{constructor(e,t){if(t===void 0){this.pieces_=e.split("/");let s=0;for(let i=0;i<this.pieces_.length;i++)this.pieces_[i].length>0&&(this.pieces_[s]=this.pieces_[i],s++);this.pieces_.length=s,this.pieceNum_=0}else this.pieces_=e,this.pieceNum_=t}toString(){let e="";for(let t=this.pieceNum_;t<this.pieces_.length;t++)this.pieces_[t]!==""&&(e+="/"+this.pieces_[t]);return e||"/"}}function w(){return new I("")}function v(n){return n.pieceNum_>=n.pieces_.length?null:n.pieces_[n.pieceNum_]}function Ee(n){return n.pieces_.length-n.pieceNum_}function O(n){let e=n.pieceNum_;return e<n.pieces_.length&&e++,new I(n.pieces_,e)}function ts(n){return n.pieceNum_<n.pieces_.length?n.pieces_[n.pieces_.length-1]:null}function hh(n){let e="";for(let t=n.pieceNum_;t<n.pieces_.length;t++)n.pieces_[t]!==""&&(e+="/"+encodeURIComponent(String(n.pieces_[t])));return e||"/"}function pt(n,e=0){return n.pieces_.slice(n.pieceNum_+e)}function Sr(n){if(n.pieceNum_>=n.pieces_.length)return null;const e=[];for(let t=n.pieceNum_;t<n.pieces_.length-1;t++)e.push(n.pieces_[t]);return new I(e,0)}function P(n,e){const t=[];for(let s=n.pieceNum_;s<n.pieces_.length;s++)t.push(n.pieces_[s]);if(e instanceof I)for(let s=e.pieceNum_;s<e.pieces_.length;s++)t.push(e.pieces_[s]);else{const s=e.split("/");for(let i=0;i<s.length;i++)s[i].length>0&&t.push(s[i])}return new I(t,0)}function S(n){return n.pieceNum_>=n.pieces_.length}function K(n,e){const t=v(n),s=v(e);if(t===null)return e;if(t===s)return K(O(n),O(e));throw new Error("INTERNAL ERROR: innerPath ("+e+") is not within outerPath ("+n+")")}function dh(n,e){const t=pt(n,0),s=pt(e,0);for(let i=0;i<t.length&&i<s.length;i++){const r=ke(t[i],s[i]);if(r!==0)return r}return t.length===s.length?0:t.length<s.length?-1:1}function ns(n,e){if(Ee(n)!==Ee(e))return!1;for(let t=n.pieceNum_,s=e.pieceNum_;t<=n.pieces_.length;t++,s++)if(n.pieces_[t]!==e.pieces_[s])return!1;return!0}function Z(n,e){let t=n.pieceNum_,s=e.pieceNum_;if(Ee(n)>Ee(e))return!1;for(;t<n.pieces_.length;){if(n.pieces_[t]!==e.pieces_[s])return!1;++t,++s}return!0}class uh{constructor(e,t){this.errorPrefix_=t,this.parts_=pt(e,0),this.byteLength_=Math.max(1,this.parts_.length);for(let s=0;s<this.parts_.length;s++)this.byteLength_+=Qt(this.parts_[s]);br(this)}}function fh(n,e){n.parts_.length>0&&(n.byteLength_+=1),n.parts_.push(e),n.byteLength_+=Qt(e),br(n)}function ph(n){const e=n.parts_.pop();n.byteLength_-=Qt(e),n.parts_.length>0&&(n.byteLength_-=1)}function br(n){if(n.byteLength_>ii)throw new Error(n.errorPrefix_+"has a key path longer than "+ii+" bytes ("+n.byteLength_+").");if(n.parts_.length>si)throw new Error(n.errorPrefix_+"path specified exceeds the maximum depth that can be written ("+si+") or object contains a cycle "+we(n))}function we(n){return n.parts_.length===0?"":"in property '"+n.parts_.join(".")+"'"}class ss extends vr{static getInstance(){return new ss}constructor(){super(["visible"]);let e,t;typeof document<"u"&&typeof document.addEventListener<"u"&&(typeof document.hidden<"u"?(t="visibilitychange",e="hidden"):typeof document.mozHidden<"u"?(t="mozvisibilitychange",e="mozHidden"):typeof document.msHidden<"u"?(t="msvisibilitychange",e="msHidden"):typeof document.webkitHidden<"u"&&(t="webkitvisibilitychange",e="webkitHidden")),this.visible_=!0,t&&document.addEventListener(t,()=>{const s=!document[e];s!==this.visible_&&(this.visible_=s,this.trigger("visible",s))},!1)}getInitialEvent(e){return g(e==="visible","Unknown event type: "+e),[this.visible_]}}const Ze=1e3,mh=300*1e3,ri=30*1e3,gh=1.3,_h=3e4,yh="server_kill",oi=3;class le extends Cr{constructor(e,t,s,i,r,o,a,l){if(super(),this.repoInfo_=e,this.applicationId_=t,this.onDataUpdate_=s,this.onConnectStatus_=i,this.onServerInfoUpdate_=r,this.authTokenProvider_=o,this.appCheckTokenProvider_=a,this.authOverride_=l,this.id=le.nextPersistentConnectionId_++,this.log_=St("p:"+this.id+":"),this.interruptReasons_={},this.listens=new Map,this.outstandingPuts_=[],this.outstandingGets_=[],this.outstandingPutCount_=0,this.outstandingGetCount_=0,this.onDisconnectRequestQueue_=[],this.connected_=!1,this.reconnectDelay_=Ze,this.maxReconnectDelay_=mh,this.securityDebugCallback_=null,this.lastSessionId=null,this.establishConnectionTimer_=null,this.visible_=!1,this.requestCBHash_={},this.requestNumber_=0,this.realtime_=null,this.authToken_=null,this.appCheckToken_=null,this.forceTokenRefresh_=!1,this.invalidAuthTokenCount_=0,this.invalidAppCheckTokenCount_=0,this.firstConnection_=!0,this.lastConnectionAttemptTime_=null,this.lastConnectionEstablishedTime_=null,l)throw new Error("Auth override specified in options, but not supported on non Node.js platforms");ss.getInstance().on("visible",this.onVisible_,this),e.host.indexOf("fblocal")===-1&&Bt.getInstance().on("online",this.onOnline_,this)}sendRequest(e,t,s){const i=++this.requestNumber_,r={r:i,a:e,b:t};this.log_(B(r)),g(this.connected_,"sendRequest call when we're not connected not allowed."),this.realtime_.sendRequest(r),s&&(this.requestCBHash_[i]=s)}get(e){this.initConnection_();const t=new ee,i={action:"g",request:{p:e._path.toString(),q:e._queryObject},onComplete:o=>{const a=o.d;o.s==="ok"?t.resolve(a):t.reject(a)}};this.outstandingGets_.push(i),this.outstandingGetCount_++;const r=this.outstandingGets_.length-1;return this.connected_&&this.sendGet_(r),t.promise}listen(e,t,s,i){this.initConnection_();const r=e._queryIdentifier,o=e._path.toString();this.log_("Listen called for "+o+" "+r),this.listens.has(o)||this.listens.set(o,new Map),g(e._queryParams.isDefault()||!e._queryParams.loadsAllData(),"listen() called for non-default but complete query"),g(!this.listens.get(o).has(r),"listen() called twice for same path/queryId.");const a={onComplete:i,hashFn:t,query:e,tag:s};this.listens.get(o).set(r,a),this.connected_&&this.sendListen_(a)}sendGet_(e){const t=this.outstandingGets_[e];this.sendRequest("g",t.request,s=>{delete this.outstandingGets_[e],this.outstandingGetCount_--,this.outstandingGetCount_===0&&(this.outstandingGets_=[]),t.onComplete&&t.onComplete(s)})}sendListen_(e){const t=e.query,s=t._path.toString(),i=t._queryIdentifier;this.log_("Listen on "+s+" for "+i);const r={p:s},o="q";e.tag&&(r.q=t._queryObject,r.t=e.tag),r.h=e.hashFn(),this.sendRequest(o,r,a=>{const l=a.d,c=a.s;le.warnOnListenWarnings_(l,t),(this.listens.get(s)&&this.listens.get(s).get(i))===e&&(this.log_("listen response",a),c!=="ok"&&this.removeListen_(s,i),e.onComplete&&e.onComplete(c,l))})}static warnOnListenWarnings_(e,t){if(e&&typeof e=="object"&&ie(e,"w")){const s=Ne(e,"w");if(Array.isArray(s)&&~s.indexOf("no_index")){const i='".indexOn": "'+t._queryParams.getIndex().toString()+'"',r=t._path.toString();z(`Using an unspecified index. Your data will be downloaded and filtered on the client. Consider adding ${i} at ${r} to your security rules for better performance.`)}}}refreshAuthToken(e){this.authToken_=e,this.log_("Auth token refreshed"),this.authToken_?this.tryAuth():this.connected_&&this.sendRequest("unauth",{},()=>{}),this.reduceReconnectDelayIfAdminCredential_(e)}reduceReconnectDelayIfAdminCredential_(e){(e&&e.length===40||il(e))&&(this.log_("Admin auth credential detected.  Reducing max reconnect time."),this.maxReconnectDelay_=ri)}refreshAppCheckToken(e){this.appCheckToken_=e,this.log_("App check token refreshed"),this.appCheckToken_?this.tryAppCheck():this.connected_&&this.sendRequest("unappeck",{},()=>{})}tryAuth(){if(this.connected_&&this.authToken_){const e=this.authToken_,t=sl(e)?"auth":"gauth",s={cred:e};this.authOverride_===null?s.noauth=!0:typeof this.authOverride_=="object"&&(s.authvar=this.authOverride_),this.sendRequest(t,s,i=>{const r=i.s,o=i.d||"error";this.authToken_===e&&(r==="ok"?this.invalidAuthTokenCount_=0:this.onAuthRevoked_(r,o))})}}tryAppCheck(){this.connected_&&this.appCheckToken_&&this.sendRequest("appcheck",{token:this.appCheckToken_},e=>{const t=e.s,s=e.d||"error";t==="ok"?this.invalidAppCheckTokenCount_=0:this.onAppCheckRevoked_(t,s)})}unlisten(e,t){const s=e._path.toString(),i=e._queryIdentifier;this.log_("Unlisten called for "+s+" "+i),g(e._queryParams.isDefault()||!e._queryParams.loadsAllData(),"unlisten() called for non-default but complete query"),this.removeListen_(s,i)&&this.connected_&&this.sendUnlisten_(s,i,e._queryObject,t)}sendUnlisten_(e,t,s,i){this.log_("Unlisten on "+e+" for "+t);const r={p:e},o="n";i&&(r.q=s,r.t=i),this.sendRequest(o,r)}onDisconnectPut(e,t,s){this.initConnection_(),this.connected_?this.sendOnDisconnect_("o",e,t,s):this.onDisconnectRequestQueue_.push({pathString:e,action:"o",data:t,onComplete:s})}onDisconnectMerge(e,t,s){this.initConnection_(),this.connected_?this.sendOnDisconnect_("om",e,t,s):this.onDisconnectRequestQueue_.push({pathString:e,action:"om",data:t,onComplete:s})}onDisconnectCancel(e,t){this.initConnection_(),this.connected_?this.sendOnDisconnect_("oc",e,null,t):this.onDisconnectRequestQueue_.push({pathString:e,action:"oc",data:null,onComplete:t})}sendOnDisconnect_(e,t,s,i){const r={p:t,d:s};this.log_("onDisconnect "+e,r),this.sendRequest(e,r,o=>{i&&setTimeout(()=>{i(o.s,o.d)},Math.floor(0))})}put(e,t,s,i){this.putInternal("p",e,t,s,i)}merge(e,t,s,i){this.putInternal("m",e,t,s,i)}putInternal(e,t,s,i,r){this.initConnection_();const o={p:t,d:s};r!==void 0&&(o.h=r),this.outstandingPuts_.push({action:e,request:o,onComplete:i}),this.outstandingPutCount_++;const a=this.outstandingPuts_.length-1;this.connected_?this.sendPut_(a):this.log_("Buffering put: "+t)}sendPut_(e){const t=this.outstandingPuts_[e].action,s=this.outstandingPuts_[e].request,i=this.outstandingPuts_[e].onComplete;this.outstandingPuts_[e].queued=this.connected_,this.sendRequest(t,s,r=>{this.log_(t+" response",r),delete this.outstandingPuts_[e],this.outstandingPutCount_--,this.outstandingPutCount_===0&&(this.outstandingPuts_=[]),i&&i(r.s,r.d)})}reportStats(e){if(this.connected_){const t={c:e};this.log_("reportStats",t),this.sendRequest("s",t,s=>{if(s.s!=="ok"){const r=s.d;this.log_("reportStats","Error sending stats: "+r)}})}}onDataMessage_(e){if("r"in e){this.log_("from server: "+B(e));const t=e.r,s=this.requestCBHash_[t];s&&(delete this.requestCBHash_[t],s(e.b))}else{if("error"in e)throw"A server-side error has occurred: "+e.error;"a"in e&&this.onDataPush_(e.a,e.b)}}onDataPush_(e,t){this.log_("handleServerMessage",e,t),e==="d"?this.onDataUpdate_(t.p,t.d,!1,t.t):e==="m"?this.onDataUpdate_(t.p,t.d,!0,t.t):e==="c"?this.onListenRevoked_(t.p,t.q):e==="ac"?this.onAuthRevoked_(t.s,t.d):e==="apc"?this.onAppCheckRevoked_(t.s,t.d):e==="sd"?this.onSecurityDebugPacket_(t):Pn("Unrecognized action received from server: "+B(e)+`
Are you using the latest client?`)}onReady_(e,t){this.log_("connection ready"),this.connected_=!0,this.lastConnectionEstablishedTime_=new Date().getTime(),this.handleTimestamp_(e),this.lastSessionId=t,this.firstConnection_&&this.sendConnectStats_(),this.restoreState_(),this.firstConnection_=!1,this.onConnectStatus_(!0)}scheduleConnect_(e){g(!this.realtime_,"Scheduling a connect when we're already connected/ing?"),this.establishConnectionTimer_&&clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=setTimeout(()=>{this.establishConnectionTimer_=null,this.establishConnection_()},Math.floor(e))}initConnection_(){!this.realtime_&&this.firstConnection_&&this.scheduleConnect_(0)}onVisible_(e){e&&!this.visible_&&this.reconnectDelay_===this.maxReconnectDelay_&&(this.log_("Window became visible.  Reducing delay."),this.reconnectDelay_=Ze,this.realtime_||this.scheduleConnect_(0)),this.visible_=e}onOnline_(e){e?(this.log_("Browser went online."),this.reconnectDelay_=Ze,this.realtime_||this.scheduleConnect_(0)):(this.log_("Browser went offline.  Killing connection."),this.realtime_&&this.realtime_.close())}onRealtimeDisconnect_(){if(this.log_("data client disconnected"),this.connected_=!1,this.realtime_=null,this.cancelSentTransactions_(),this.requestCBHash_={},this.shouldReconnect_()){this.visible_?this.lastConnectionEstablishedTime_&&(new Date().getTime()-this.lastConnectionEstablishedTime_>_h&&(this.reconnectDelay_=Ze),this.lastConnectionEstablishedTime_=null):(this.log_("Window isn't visible.  Delaying reconnect."),this.reconnectDelay_=this.maxReconnectDelay_,this.lastConnectionAttemptTime_=new Date().getTime());const e=Math.max(0,new Date().getTime()-this.lastConnectionAttemptTime_);let t=Math.max(0,this.reconnectDelay_-e);t=Math.random()*t,this.log_("Trying to reconnect in "+t+"ms"),this.scheduleConnect_(t),this.reconnectDelay_=Math.min(this.maxReconnectDelay_,this.reconnectDelay_*gh)}this.onConnectStatus_(!1)}async establishConnection_(){if(this.shouldReconnect_()){this.log_("Making a connection attempt"),this.lastConnectionAttemptTime_=new Date().getTime(),this.lastConnectionEstablishedTime_=null;const e=this.onDataMessage_.bind(this),t=this.onReady_.bind(this),s=this.onRealtimeDisconnect_.bind(this),i=this.id+":"+le.nextConnectionId_++,r=this.lastSessionId;let o=!1,a=null;const l=function(){a?a.close():(o=!0,s())},c=function(u){g(a,"sendRequest call when we're not connected not allowed."),a.sendRequest(u)};this.realtime_={close:l,sendRequest:c};const d=this.forceTokenRefresh_;this.forceTokenRefresh_=!1;try{const[u,h]=await Promise.all([this.authTokenProvider_.getToken(d),this.appCheckTokenProvider_.getToken(d)]);o?G("getToken() completed but was canceled"):(G("getToken() completed. Creating connection."),this.authToken_=u&&u.accessToken,this.appCheckToken_=h&&h.token,a=new ch(i,this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,e,t,s,p=>{z(p+" ("+this.repoInfo_.toString()+")"),this.interrupt(yh)},r))}catch(u){this.log_("Failed to get token: "+u),o||(this.repoInfo_.nodeAdmin&&z(u),l())}}}interrupt(e){G("Interrupting connection for reason: "+e),this.interruptReasons_[e]=!0,this.realtime_?this.realtime_.close():(this.establishConnectionTimer_&&(clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=null),this.connected_&&this.onRealtimeDisconnect_())}resume(e){G("Resuming connection for reason: "+e),delete this.interruptReasons_[e],On(this.interruptReasons_)&&(this.reconnectDelay_=Ze,this.realtime_||this.scheduleConnect_(0))}handleTimestamp_(e){const t=e-new Date().getTime();this.onServerInfoUpdate_({serverTimeOffset:t})}cancelSentTransactions_(){for(let e=0;e<this.outstandingPuts_.length;e++){const t=this.outstandingPuts_[e];t&&"h"in t.request&&t.queued&&(t.onComplete&&t.onComplete("disconnect"),delete this.outstandingPuts_[e],this.outstandingPutCount_--)}this.outstandingPutCount_===0&&(this.outstandingPuts_=[])}onListenRevoked_(e,t){let s;t?s=t.map(r=>Xn(r)).join("$"):s="default";const i=this.removeListen_(e,s);i&&i.onComplete&&i.onComplete("permission_denied")}removeListen_(e,t){const s=new I(e).toString();let i;if(this.listens.has(s)){const r=this.listens.get(s);i=r.get(t),r.delete(t),r.size===0&&this.listens.delete(s)}else i=void 0;return i}onAuthRevoked_(e,t){G("Auth token revoked: "+e+"/"+t),this.authToken_=null,this.forceTokenRefresh_=!0,this.realtime_.close(),(e==="invalid_token"||e==="permission_denied")&&(this.invalidAuthTokenCount_++,this.invalidAuthTokenCount_>=oi&&(this.reconnectDelay_=ri,this.authTokenProvider_.notifyForInvalidToken()))}onAppCheckRevoked_(e,t){G("App check token revoked: "+e+"/"+t),this.appCheckToken_=null,this.forceTokenRefresh_=!0,(e==="invalid_token"||e==="permission_denied")&&(this.invalidAppCheckTokenCount_++,this.invalidAppCheckTokenCount_>=oi&&this.appCheckTokenProvider_.notifyForInvalidToken())}onSecurityDebugPacket_(e){this.securityDebugCallback_?this.securityDebugCallback_(e):"msg"in e&&console.log("FIREBASE: "+e.msg.replace(`
`,`
FIREBASE: `))}restoreState_(){this.tryAuth(),this.tryAppCheck();for(const e of this.listens.values())for(const t of e.values())this.sendListen_(t);for(let e=0;e<this.outstandingPuts_.length;e++)this.outstandingPuts_[e]&&this.sendPut_(e);for(;this.onDisconnectRequestQueue_.length;){const e=this.onDisconnectRequestQueue_.shift();this.sendOnDisconnect_(e.action,e.pathString,e.data,e.onComplete)}for(let e=0;e<this.outstandingGets_.length;e++)this.outstandingGets_[e]&&this.sendGet_(e)}sendConnectStats_(){const e={};let t="js";e["sdk."+t+"."+Ji.replace(/\./g,"-")]=1,$i()?e["framework.cordova"]=1:Qa()&&(e["framework.reactnative"]=1),this.reportStats(e)}shouldReconnect_(){const e=Bt.getInstance().currentlyOnline();return On(this.interruptReasons_)&&e}}le.nextPersistentConnectionId_=0;le.nextConnectionId_=0;class b{constructor(e,t){this.name=e,this.node=t}static Wrap(e,t){return new b(e,t)}}class Jt{getCompare(){return this.compare.bind(this)}indexedValueChanged(e,t){const s=new b(Ge,e),i=new b(Ge,t);return this.compare(s,i)!==0}minPost(){return b.MIN}}let Rt;class wr extends Jt{static get __EMPTY_NODE(){return Rt}static set __EMPTY_NODE(e){Rt=e}compare(e,t){return ke(e.name,t.name)}isDefinedOn(e){throw Ye("KeyIndex.isDefinedOn not expected to be called.")}indexedValueChanged(e,t){return!1}minPost(){return b.MIN}maxPost(){return new b(Re,Rt)}makePost(e,t){return g(typeof e=="string","KeyIndex indexValue must always be a string."),new b(e,Rt)}toString(){return".key"}}const Fe=new wr;class Ot{constructor(e,t,s,i,r=null){this.isReverse_=i,this.resultGenerator_=r,this.nodeStack_=[];let o=1;for(;!e.isEmpty();)if(e=e,o=t?s(e.key,t):1,i&&(o*=-1),o<0)this.isReverse_?e=e.left:e=e.right;else if(o===0){this.nodeStack_.push(e);break}else this.nodeStack_.push(e),this.isReverse_?e=e.right:e=e.left}getNext(){if(this.nodeStack_.length===0)return null;let e=this.nodeStack_.pop(),t;if(this.resultGenerator_?t=this.resultGenerator_(e.key,e.value):t={key:e.key,value:e.value},this.isReverse_)for(e=e.left;!e.isEmpty();)this.nodeStack_.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack_.push(e),e=e.left;return t}hasNext(){return this.nodeStack_.length>0}peek(){if(this.nodeStack_.length===0)return null;const e=this.nodeStack_[this.nodeStack_.length-1];return this.resultGenerator_?this.resultGenerator_(e.key,e.value):{key:e.key,value:e.value}}}class W{constructor(e,t,s,i,r){this.key=e,this.value=t,this.color=s??W.RED,this.left=i??Y.EMPTY_NODE,this.right=r??Y.EMPTY_NODE}copy(e,t,s,i,r){return new W(e??this.key,t??this.value,s??this.color,i??this.left,r??this.right)}count(){return this.left.count()+1+this.right.count()}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||!!e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min_(){return this.left.isEmpty()?this:this.left.min_()}minKey(){return this.min_().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,s){let i=this;const r=s(e,i.key);return r<0?i=i.copy(null,null,null,i.left.insert(e,t,s),null):r===0?i=i.copy(null,t,null,null,null):i=i.copy(null,null,null,null,i.right.insert(e,t,s)),i.fixUp_()}removeMin_(){if(this.left.isEmpty())return Y.EMPTY_NODE;let e=this;return!e.left.isRed_()&&!e.left.left.isRed_()&&(e=e.moveRedLeft_()),e=e.copy(null,null,null,e.left.removeMin_(),null),e.fixUp_()}remove(e,t){let s,i;if(s=this,t(e,s.key)<0)!s.left.isEmpty()&&!s.left.isRed_()&&!s.left.left.isRed_()&&(s=s.moveRedLeft_()),s=s.copy(null,null,null,s.left.remove(e,t),null);else{if(s.left.isRed_()&&(s=s.rotateRight_()),!s.right.isEmpty()&&!s.right.isRed_()&&!s.right.left.isRed_()&&(s=s.moveRedRight_()),t(e,s.key)===0){if(s.right.isEmpty())return Y.EMPTY_NODE;i=s.right.min_(),s=s.copy(i.key,i.value,null,null,s.right.removeMin_())}s=s.copy(null,null,null,null,s.right.remove(e,t))}return s.fixUp_()}isRed_(){return this.color}fixUp_(){let e=this;return e.right.isRed_()&&!e.left.isRed_()&&(e=e.rotateLeft_()),e.left.isRed_()&&e.left.left.isRed_()&&(e=e.rotateRight_()),e.left.isRed_()&&e.right.isRed_()&&(e=e.colorFlip_()),e}moveRedLeft_(){let e=this.colorFlip_();return e.right.left.isRed_()&&(e=e.copy(null,null,null,null,e.right.rotateRight_()),e=e.rotateLeft_(),e=e.colorFlip_()),e}moveRedRight_(){let e=this.colorFlip_();return e.left.left.isRed_()&&(e=e.rotateRight_(),e=e.colorFlip_()),e}rotateLeft_(){const e=this.copy(null,null,W.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight_(){const e=this.copy(null,null,W.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip_(){const e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth_(){const e=this.check_();return Math.pow(2,e)<=this.count()+1}check_(){if(this.isRed_()&&this.left.isRed_())throw new Error("Red node has red child("+this.key+","+this.value+")");if(this.right.isRed_())throw new Error("Right child of ("+this.key+","+this.value+") is red");const e=this.left.check_();if(e!==this.right.check_())throw new Error("Black depths differ");return e+(this.isRed_()?0:1)}}W.RED=!0;W.BLACK=!1;class Eh{copy(e,t,s,i,r){return this}insert(e,t,s){return new W(e,t,null)}remove(e,t){return this}count(){return 0}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}check_(){return 0}isRed_(){return!1}}class Y{constructor(e,t=Y.EMPTY_NODE){this.comparator_=e,this.root_=t}insert(e,t){return new Y(this.comparator_,this.root_.insert(e,t,this.comparator_).copy(null,null,W.BLACK,null,null))}remove(e){return new Y(this.comparator_,this.root_.remove(e,this.comparator_).copy(null,null,W.BLACK,null,null))}get(e){let t,s=this.root_;for(;!s.isEmpty();){if(t=this.comparator_(e,s.key),t===0)return s.value;t<0?s=s.left:t>0&&(s=s.right)}return null}getPredecessorKey(e){let t,s=this.root_,i=null;for(;!s.isEmpty();)if(t=this.comparator_(e,s.key),t===0){if(s.left.isEmpty())return i?i.key:null;for(s=s.left;!s.right.isEmpty();)s=s.right;return s.key}else t<0?s=s.left:t>0&&(i=s,s=s.right);throw new Error("Attempted to find predecessor key for a nonexistent key.  What gives?")}isEmpty(){return this.root_.isEmpty()}count(){return this.root_.count()}minKey(){return this.root_.minKey()}maxKey(){return this.root_.maxKey()}inorderTraversal(e){return this.root_.inorderTraversal(e)}reverseTraversal(e){return this.root_.reverseTraversal(e)}getIterator(e){return new Ot(this.root_,null,this.comparator_,!1,e)}getIteratorFrom(e,t){return new Ot(this.root_,e,this.comparator_,!1,t)}getReverseIteratorFrom(e,t){return new Ot(this.root_,e,this.comparator_,!0,t)}getReverseIterator(e){return new Ot(this.root_,null,this.comparator_,!0,e)}}Y.EMPTY_NODE=new Eh;function Ch(n,e){return ke(n.name,e.name)}function is(n,e){return ke(n,e)}let Bn;function vh(n){Bn=n}const Ir=function(n){return typeof n=="number"?"number:"+sr(n):"string:"+n},Tr=function(n){if(n.isLeafNode()){const e=n.val();g(typeof e=="string"||typeof e=="number"||typeof e=="object"&&ie(e,".sv"),"Priority must be a string or number.")}else g(n===Bn||n.isEmpty(),"priority of unexpected type.");g(n===Bn||n.getPriority().isEmpty(),"Priority nodes can't have a priority of their own.")};let ai;class F{static set __childrenNodeConstructor(e){ai=e}static get __childrenNodeConstructor(){return ai}constructor(e,t=F.__childrenNodeConstructor.EMPTY_NODE){this.value_=e,this.priorityNode_=t,this.lazyHash_=null,g(this.value_!==void 0&&this.value_!==null,"LeafNode shouldn't be created with null/undefined value."),Tr(this.priorityNode_)}isLeafNode(){return!0}getPriority(){return this.priorityNode_}updatePriority(e){return new F(this.value_,e)}getImmediateChild(e){return e===".priority"?this.priorityNode_:F.__childrenNodeConstructor.EMPTY_NODE}getChild(e){return S(e)?this:v(e)===".priority"?this.priorityNode_:F.__childrenNodeConstructor.EMPTY_NODE}hasChild(){return!1}getPredecessorChildName(e,t){return null}updateImmediateChild(e,t){return e===".priority"?this.updatePriority(t):t.isEmpty()&&e!==".priority"?this:F.__childrenNodeConstructor.EMPTY_NODE.updateImmediateChild(e,t).updatePriority(this.priorityNode_)}updateChild(e,t){const s=v(e);return s===null?t:t.isEmpty()&&s!==".priority"?this:(g(s!==".priority"||Ee(e)===1,".priority must be the last token in a path"),this.updateImmediateChild(s,F.__childrenNodeConstructor.EMPTY_NODE.updateChild(O(e),t)))}isEmpty(){return!1}numChildren(){return 0}forEachChild(e,t){return!1}val(e){return e&&!this.getPriority().isEmpty()?{".value":this.getValue(),".priority":this.getPriority().val()}:this.getValue()}hash(){if(this.lazyHash_===null){let e="";this.priorityNode_.isEmpty()||(e+="priority:"+Ir(this.priorityNode_.val())+":");const t=typeof this.value_;e+=t+":",t==="number"?e+=sr(this.value_):e+=this.value_,this.lazyHash_=tr(e)}return this.lazyHash_}getValue(){return this.value_}compareTo(e){return e===F.__childrenNodeConstructor.EMPTY_NODE?1:e instanceof F.__childrenNodeConstructor?-1:(g(e.isLeafNode(),"Unknown node type"),this.compareToLeafNode_(e))}compareToLeafNode_(e){const t=typeof e.value_,s=typeof this.value_,i=F.VALUE_TYPE_ORDER.indexOf(t),r=F.VALUE_TYPE_ORDER.indexOf(s);return g(i>=0,"Unknown leaf type: "+t),g(r>=0,"Unknown leaf type: "+s),i===r?s==="object"?0:this.value_<e.value_?-1:this.value_===e.value_?0:1:r-i}withIndex(){return this}isIndexed(){return!0}equals(e){if(e===this)return!0;if(e.isLeafNode()){const t=e;return this.value_===t.value_&&this.priorityNode_.equals(t.priorityNode_)}else return!1}}F.VALUE_TYPE_ORDER=["object","boolean","number","string"];let Nr,Rr;function Sh(n){Nr=n}function bh(n){Rr=n}class wh extends Jt{compare(e,t){const s=e.node.getPriority(),i=t.node.getPriority(),r=s.compareTo(i);return r===0?ke(e.name,t.name):r}isDefinedOn(e){return!e.getPriority().isEmpty()}indexedValueChanged(e,t){return!e.getPriority().equals(t.getPriority())}minPost(){return b.MIN}maxPost(){return new b(Re,new F("[PRIORITY-POST]",Rr))}makePost(e,t){const s=Nr(e);return new b(t,new F("[PRIORITY-POST]",s))}toString(){return".priority"}}const D=new wh;const Ih=Math.log(2);class Th{constructor(e){const t=r=>parseInt(Math.log(r)/Ih,10),s=r=>parseInt(Array(r+1).join("1"),2);this.count=t(e+1),this.current_=this.count-1;const i=s(this.count);this.bits_=e+1&i}nextBitIsOne(){const e=!(this.bits_&1<<this.current_);return this.current_--,e}}const Ft=function(n,e,t,s){n.sort(e);const i=function(l,c){const d=c-l;let u,h;if(d===0)return null;if(d===1)return u=n[l],h=t?t(u):u,new W(h,u.node,W.BLACK,null,null);{const p=parseInt(d/2,10)+l,m=i(l,p),_=i(p+1,c);return u=n[p],h=t?t(u):u,new W(h,u.node,W.BLACK,m,_)}},r=function(l){let c=null,d=null,u=n.length;const h=function(m,_){const E=u-m,R=u;u-=m;const T=i(E+1,R),L=n[E],C=t?t(L):L;p(new W(C,L.node,_,null,T))},p=function(m){c?(c.left=m,c=m):(d=m,c=m)};for(let m=0;m<l.count;++m){const _=l.nextBitIsOne(),E=Math.pow(2,l.count-(m+1));_?h(E,W.BLACK):(h(E,W.BLACK),h(E,W.RED))}return d},o=new Th(n.length),a=r(o);return new Y(s||e,a)};let vn;const Me={};class ae{static get Default(){return g(Me&&D,"ChildrenNode.ts has not been loaded"),vn=vn||new ae({".priority":Me},{".priority":D}),vn}constructor(e,t){this.indexes_=e,this.indexSet_=t}get(e){const t=Ne(this.indexes_,e);if(!t)throw new Error("No index defined for "+e);return t instanceof Y?t:null}hasIndex(e){return ie(this.indexSet_,e.toString())}addIndex(e,t){g(e!==Fe,"KeyIndex always exists and isn't meant to be added to the IndexMap.");const s=[];let i=!1;const r=t.getIterator(b.Wrap);let o=r.getNext();for(;o;)i=i||e.isDefinedOn(o.node),s.push(o),o=r.getNext();let a;i?a=Ft(s,e.getCompare()):a=Me;const l=e.toString(),c={...this.indexSet_};c[l]=e;const d={...this.indexes_};return d[l]=a,new ae(d,c)}addToIndexes(e,t){const s=Lt(this.indexes_,(i,r)=>{const o=Ne(this.indexSet_,r);if(g(o,"Missing index implementation for "+r),i===Me)if(o.isDefinedOn(e.node)){const a=[],l=t.getIterator(b.Wrap);let c=l.getNext();for(;c;)c.name!==e.name&&a.push(c),c=l.getNext();return a.push(e),Ft(a,o.getCompare())}else return Me;else{const a=t.get(e.name);let l=i;return a&&(l=l.remove(new b(e.name,a))),l.insert(e,e.node)}});return new ae(s,this.indexSet_)}removeFromIndexes(e,t){const s=Lt(this.indexes_,i=>{if(i===Me)return i;{const r=t.get(e.name);return r?i.remove(new b(e.name,r)):i}});return new ae(s,this.indexSet_)}}let et;class y{static get EMPTY_NODE(){return et||(et=new y(new Y(is),null,ae.Default))}constructor(e,t,s){this.children_=e,this.priorityNode_=t,this.indexMap_=s,this.lazyHash_=null,this.priorityNode_&&Tr(this.priorityNode_),this.children_.isEmpty()&&g(!this.priorityNode_||this.priorityNode_.isEmpty(),"An empty node cannot have a priority")}isLeafNode(){return!1}getPriority(){return this.priorityNode_||et}updatePriority(e){return this.children_.isEmpty()?this:new y(this.children_,e,this.indexMap_)}getImmediateChild(e){if(e===".priority")return this.getPriority();{const t=this.children_.get(e);return t===null?et:t}}getChild(e){const t=v(e);return t===null?this:this.getImmediateChild(t).getChild(O(e))}hasChild(e){return this.children_.get(e)!==null}updateImmediateChild(e,t){if(g(t,"We should always be passing snapshot nodes"),e===".priority")return this.updatePriority(t);{const s=new b(e,t);let i,r;t.isEmpty()?(i=this.children_.remove(e),r=this.indexMap_.removeFromIndexes(s,this.children_)):(i=this.children_.insert(e,t),r=this.indexMap_.addToIndexes(s,this.children_));const o=i.isEmpty()?et:this.priorityNode_;return new y(i,o,r)}}updateChild(e,t){const s=v(e);if(s===null)return t;{g(v(e)!==".priority"||Ee(e)===1,".priority must be the last token in a path");const i=this.getImmediateChild(s).updateChild(O(e),t);return this.updateImmediateChild(s,i)}}isEmpty(){return this.children_.isEmpty()}numChildren(){return this.children_.count()}val(e){if(this.isEmpty())return null;const t={};let s=0,i=0,r=!0;if(this.forEachChild(D,(o,a)=>{t[o]=a.val(e),s++,r&&y.INTEGER_REGEXP_.test(o)?i=Math.max(i,Number(o)):r=!1}),!e&&r&&i<2*s){const o=[];for(const a in t)o[a]=t[a];return o}else return e&&!this.getPriority().isEmpty()&&(t[".priority"]=this.getPriority().val()),t}hash(){if(this.lazyHash_===null){let e="";this.getPriority().isEmpty()||(e+="priority:"+Ir(this.getPriority().val())+":"),this.forEachChild(D,(t,s)=>{const i=s.hash();i!==""&&(e+=":"+t+":"+i)}),this.lazyHash_=e===""?"":tr(e)}return this.lazyHash_}getPredecessorChildName(e,t,s){const i=this.resolveIndex_(s);if(i){const r=i.getPredecessorKey(new b(e,t));return r?r.name:null}else return this.children_.getPredecessorKey(e)}getFirstChildName(e){const t=this.resolveIndex_(e);if(t){const s=t.minKey();return s&&s.name}else return this.children_.minKey()}getFirstChild(e){const t=this.getFirstChildName(e);return t?new b(t,this.children_.get(t)):null}getLastChildName(e){const t=this.resolveIndex_(e);if(t){const s=t.maxKey();return s&&s.name}else return this.children_.maxKey()}getLastChild(e){const t=this.getLastChildName(e);return t?new b(t,this.children_.get(t)):null}forEachChild(e,t){const s=this.resolveIndex_(e);return s?s.inorderTraversal(i=>t(i.name,i.node)):this.children_.inorderTraversal(t)}getIterator(e){return this.getIteratorFrom(e.minPost(),e)}getIteratorFrom(e,t){const s=this.resolveIndex_(t);if(s)return s.getIteratorFrom(e,i=>i);{const i=this.children_.getIteratorFrom(e.name,b.Wrap);let r=i.peek();for(;r!=null&&t.compare(r,e)<0;)i.getNext(),r=i.peek();return i}}getReverseIterator(e){return this.getReverseIteratorFrom(e.maxPost(),e)}getReverseIteratorFrom(e,t){const s=this.resolveIndex_(t);if(s)return s.getReverseIteratorFrom(e,i=>i);{const i=this.children_.getReverseIteratorFrom(e.name,b.Wrap);let r=i.peek();for(;r!=null&&t.compare(r,e)>0;)i.getNext(),r=i.peek();return i}}compareTo(e){return this.isEmpty()?e.isEmpty()?0:-1:e.isLeafNode()||e.isEmpty()?1:e===bt?-1:0}withIndex(e){if(e===Fe||this.indexMap_.hasIndex(e))return this;{const t=this.indexMap_.addIndex(e,this.children_);return new y(this.children_,this.priorityNode_,t)}}isIndexed(e){return e===Fe||this.indexMap_.hasIndex(e)}equals(e){if(e===this)return!0;if(e.isLeafNode())return!1;{const t=e;if(this.getPriority().equals(t.getPriority()))if(this.children_.count()===t.children_.count()){const s=this.getIterator(D),i=t.getIterator(D);let r=s.getNext(),o=i.getNext();for(;r&&o;){if(r.name!==o.name||!r.node.equals(o.node))return!1;r=s.getNext(),o=i.getNext()}return r===null&&o===null}else return!1;else return!1}}resolveIndex_(e){return e===Fe?null:this.indexMap_.get(e.toString())}}y.INTEGER_REGEXP_=/^(0|[1-9]\d*)$/;class Nh extends y{constructor(){super(new Y(is),y.EMPTY_NODE,ae.Default)}compareTo(e){return e===this?0:1}equals(e){return e===this}getPriority(){return this}getImmediateChild(e){return y.EMPTY_NODE}isEmpty(){return!1}}const bt=new Nh;Object.defineProperties(b,{MIN:{value:new b(Ge,y.EMPTY_NODE)},MAX:{value:new b(Re,bt)}});wr.__EMPTY_NODE=y.EMPTY_NODE;F.__childrenNodeConstructor=y;vh(bt);bh(bt);const Rh=!0;function M(n,e=null){if(n===null)return y.EMPTY_NODE;if(typeof n=="object"&&".priority"in n&&(e=n[".priority"]),g(e===null||typeof e=="string"||typeof e=="number"||typeof e=="object"&&".sv"in e,"Invalid priority type found: "+typeof e),typeof n=="object"&&".value"in n&&n[".value"]!==null&&(n=n[".value"]),typeof n!="object"||".sv"in n){const t=n;return new F(t,M(e))}if(!(n instanceof Array)&&Rh){const t=[];let s=!1;if(U(n,(o,a)=>{if(o.substring(0,1)!=="."){const l=M(a);l.isEmpty()||(s=s||!l.getPriority().isEmpty(),t.push(new b(o,l)))}}),t.length===0)return y.EMPTY_NODE;const r=Ft(t,Ch,o=>o.name,is);if(s){const o=Ft(t,D.getCompare());return new y(r,M(e),new ae({".priority":o},{".priority":D}))}else return new y(r,M(e),ae.Default)}else{let t=y.EMPTY_NODE;return U(n,(s,i)=>{if(ie(n,s)&&s.substring(0,1)!=="."){const r=M(i);(r.isLeafNode()||!r.isEmpty())&&(t=t.updateImmediateChild(s,r))}}),t.updatePriority(M(e))}}Sh(M);class Oh extends Jt{constructor(e){super(),this.indexPath_=e,g(!S(e)&&v(e)!==".priority","Can't create PathIndex with empty path or .priority key")}extractChild(e){return e.getChild(this.indexPath_)}isDefinedOn(e){return!e.getChild(this.indexPath_).isEmpty()}compare(e,t){const s=this.extractChild(e.node),i=this.extractChild(t.node),r=s.compareTo(i);return r===0?ke(e.name,t.name):r}makePost(e,t){const s=M(e),i=y.EMPTY_NODE.updateChild(this.indexPath_,s);return new b(t,i)}maxPost(){const e=y.EMPTY_NODE.updateChild(this.indexPath_,bt);return new b(Re,e)}toString(){return pt(this.indexPath_,0).join("/")}}class Ah extends Jt{compare(e,t){const s=e.node.compareTo(t.node);return s===0?ke(e.name,t.name):s}isDefinedOn(e){return!0}indexedValueChanged(e,t){return!e.equals(t)}minPost(){return b.MIN}maxPost(){return b.MAX}makePost(e,t){const s=M(e);return new b(t,s)}toString(){return".value"}}const kh=new Ah;function Or(n){return{type:"value",snapshotNode:n}}function Ue(n,e){return{type:"child_added",snapshotNode:e,childName:n}}function mt(n,e){return{type:"child_removed",snapshotNode:e,childName:n}}function gt(n,e,t){return{type:"child_changed",snapshotNode:e,childName:n,oldSnap:t}}function Lh(n,e){return{type:"child_moved",snapshotNode:e,childName:n}}class rs{constructor(e){this.index_=e}updateChild(e,t,s,i,r,o){g(e.isIndexed(this.index_),"A node must be indexed if only a child is updated");const a=e.getImmediateChild(t);return a.getChild(i).equals(s.getChild(i))&&a.isEmpty()===s.isEmpty()||(o!=null&&(s.isEmpty()?e.hasChild(t)?o.trackChildChange(mt(t,a)):g(e.isLeafNode(),"A child remove without an old child only makes sense on a leaf node"):a.isEmpty()?o.trackChildChange(Ue(t,s)):o.trackChildChange(gt(t,s,a))),e.isLeafNode()&&s.isEmpty())?e:e.updateImmediateChild(t,s).withIndex(this.index_)}updateFullNode(e,t,s){return s!=null&&(e.isLeafNode()||e.forEachChild(D,(i,r)=>{t.hasChild(i)||s.trackChildChange(mt(i,r))}),t.isLeafNode()||t.forEachChild(D,(i,r)=>{if(e.hasChild(i)){const o=e.getImmediateChild(i);o.equals(r)||s.trackChildChange(gt(i,r,o))}else s.trackChildChange(Ue(i,r))})),t.withIndex(this.index_)}updatePriority(e,t){return e.isEmpty()?y.EMPTY_NODE:e.updatePriority(t)}filtersNodes(){return!1}getIndexedFilter(){return this}getIndex(){return this.index_}}class _t{constructor(e){this.indexedFilter_=new rs(e.getIndex()),this.index_=e.getIndex(),this.startPost_=_t.getStartPost_(e),this.endPost_=_t.getEndPost_(e),this.startIsInclusive_=!e.startAfterSet_,this.endIsInclusive_=!e.endBeforeSet_}getStartPost(){return this.startPost_}getEndPost(){return this.endPost_}matches(e){const t=this.startIsInclusive_?this.index_.compare(this.getStartPost(),e)<=0:this.index_.compare(this.getStartPost(),e)<0,s=this.endIsInclusive_?this.index_.compare(e,this.getEndPost())<=0:this.index_.compare(e,this.getEndPost())<0;return t&&s}updateChild(e,t,s,i,r,o){return this.matches(new b(t,s))||(s=y.EMPTY_NODE),this.indexedFilter_.updateChild(e,t,s,i,r,o)}updateFullNode(e,t,s){t.isLeafNode()&&(t=y.EMPTY_NODE);let i=t.withIndex(this.index_);i=i.updatePriority(y.EMPTY_NODE);const r=this;return t.forEachChild(D,(o,a)=>{r.matches(new b(o,a))||(i=i.updateImmediateChild(o,y.EMPTY_NODE))}),this.indexedFilter_.updateFullNode(e,i,s)}updatePriority(e,t){return e}filtersNodes(){return!0}getIndexedFilter(){return this.indexedFilter_}getIndex(){return this.index_}static getStartPost_(e){if(e.hasStart()){const t=e.getIndexStartName();return e.getIndex().makePost(e.getIndexStartValue(),t)}else return e.getIndex().minPost()}static getEndPost_(e){if(e.hasEnd()){const t=e.getIndexEndName();return e.getIndex().makePost(e.getIndexEndValue(),t)}else return e.getIndex().maxPost()}}class Dh{constructor(e){this.withinDirectionalStart=t=>this.reverse_?this.withinEndPost(t):this.withinStartPost(t),this.withinDirectionalEnd=t=>this.reverse_?this.withinStartPost(t):this.withinEndPost(t),this.withinStartPost=t=>{const s=this.index_.compare(this.rangedFilter_.getStartPost(),t);return this.startIsInclusive_?s<=0:s<0},this.withinEndPost=t=>{const s=this.index_.compare(t,this.rangedFilter_.getEndPost());return this.endIsInclusive_?s<=0:s<0},this.rangedFilter_=new _t(e),this.index_=e.getIndex(),this.limit_=e.getLimit(),this.reverse_=!e.isViewFromLeft(),this.startIsInclusive_=!e.startAfterSet_,this.endIsInclusive_=!e.endBeforeSet_}updateChild(e,t,s,i,r,o){return this.rangedFilter_.matches(new b(t,s))||(s=y.EMPTY_NODE),e.getImmediateChild(t).equals(s)?e:e.numChildren()<this.limit_?this.rangedFilter_.getIndexedFilter().updateChild(e,t,s,i,r,o):this.fullLimitUpdateChild_(e,t,s,r,o)}updateFullNode(e,t,s){let i;if(t.isLeafNode()||t.isEmpty())i=y.EMPTY_NODE.withIndex(this.index_);else if(this.limit_*2<t.numChildren()&&t.isIndexed(this.index_)){i=y.EMPTY_NODE.withIndex(this.index_);let r;this.reverse_?r=t.getReverseIteratorFrom(this.rangedFilter_.getEndPost(),this.index_):r=t.getIteratorFrom(this.rangedFilter_.getStartPost(),this.index_);let o=0;for(;r.hasNext()&&o<this.limit_;){const a=r.getNext();if(this.withinDirectionalStart(a))if(this.withinDirectionalEnd(a))i=i.updateImmediateChild(a.name,a.node),o++;else break;else continue}}else{i=t.withIndex(this.index_),i=i.updatePriority(y.EMPTY_NODE);let r;this.reverse_?r=i.getReverseIterator(this.index_):r=i.getIterator(this.index_);let o=0;for(;r.hasNext();){const a=r.getNext();o<this.limit_&&this.withinDirectionalStart(a)&&this.withinDirectionalEnd(a)?o++:i=i.updateImmediateChild(a.name,y.EMPTY_NODE)}}return this.rangedFilter_.getIndexedFilter().updateFullNode(e,i,s)}updatePriority(e,t){return e}filtersNodes(){return!0}getIndexedFilter(){return this.rangedFilter_.getIndexedFilter()}getIndex(){return this.index_}fullLimitUpdateChild_(e,t,s,i,r){let o;if(this.reverse_){const u=this.index_.getCompare();o=(h,p)=>u(p,h)}else o=this.index_.getCompare();const a=e;g(a.numChildren()===this.limit_,"");const l=new b(t,s),c=this.reverse_?a.getFirstChild(this.index_):a.getLastChild(this.index_),d=this.rangedFilter_.matches(l);if(a.hasChild(t)){const u=a.getImmediateChild(t);let h=i.getChildAfterChild(this.index_,c,this.reverse_);for(;h!=null&&(h.name===t||a.hasChild(h.name));)h=i.getChildAfterChild(this.index_,h,this.reverse_);const p=h==null?1:o(h,l);if(d&&!s.isEmpty()&&p>=0)return r?.trackChildChange(gt(t,s,u)),a.updateImmediateChild(t,s);{r?.trackChildChange(mt(t,u));const _=a.updateImmediateChild(t,y.EMPTY_NODE);return h!=null&&this.rangedFilter_.matches(h)?(r?.trackChildChange(Ue(h.name,h.node)),_.updateImmediateChild(h.name,h.node)):_}}else return s.isEmpty()?e:d&&o(c,l)>=0?(r!=null&&(r.trackChildChange(mt(c.name,c.node)),r.trackChildChange(Ue(t,s))),a.updateImmediateChild(t,s).updateImmediateChild(c.name,y.EMPTY_NODE)):e}}class os{constructor(){this.limitSet_=!1,this.startSet_=!1,this.startNameSet_=!1,this.startAfterSet_=!1,this.endSet_=!1,this.endNameSet_=!1,this.endBeforeSet_=!1,this.limit_=0,this.viewFrom_="",this.indexStartValue_=null,this.indexStartName_="",this.indexEndValue_=null,this.indexEndName_="",this.index_=D}hasStart(){return this.startSet_}isViewFromLeft(){return this.viewFrom_===""?this.startSet_:this.viewFrom_==="l"}getIndexStartValue(){return g(this.startSet_,"Only valid if start has been set"),this.indexStartValue_}getIndexStartName(){return g(this.startSet_,"Only valid if start has been set"),this.startNameSet_?this.indexStartName_:Ge}hasEnd(){return this.endSet_}getIndexEndValue(){return g(this.endSet_,"Only valid if end has been set"),this.indexEndValue_}getIndexEndName(){return g(this.endSet_,"Only valid if end has been set"),this.endNameSet_?this.indexEndName_:Re}hasLimit(){return this.limitSet_}hasAnchoredLimit(){return this.limitSet_&&this.viewFrom_!==""}getLimit(){return g(this.limitSet_,"Only valid if limit has been set"),this.limit_}getIndex(){return this.index_}loadsAllData(){return!(this.startSet_||this.endSet_||this.limitSet_)}isDefault(){return this.loadsAllData()&&this.index_===D}copy(){const e=new os;return e.limitSet_=this.limitSet_,e.limit_=this.limit_,e.startSet_=this.startSet_,e.startAfterSet_=this.startAfterSet_,e.indexStartValue_=this.indexStartValue_,e.startNameSet_=this.startNameSet_,e.indexStartName_=this.indexStartName_,e.endSet_=this.endSet_,e.endBeforeSet_=this.endBeforeSet_,e.indexEndValue_=this.indexEndValue_,e.endNameSet_=this.endNameSet_,e.indexEndName_=this.indexEndName_,e.index_=this.index_,e.viewFrom_=this.viewFrom_,e}}function Mh(n){return n.loadsAllData()?new rs(n.getIndex()):n.hasLimit()?new Dh(n):new _t(n)}function li(n){const e={};if(n.isDefault())return e;let t;if(n.index_===D?t="$priority":n.index_===kh?t="$value":n.index_===Fe?t="$key":(g(n.index_ instanceof Oh,"Unrecognized index type!"),t=n.index_.toString()),e.orderBy=B(t),n.startSet_){const s=n.startAfterSet_?"startAfter":"startAt";e[s]=B(n.indexStartValue_),n.startNameSet_&&(e[s]+=","+B(n.indexStartName_))}if(n.endSet_){const s=n.endBeforeSet_?"endBefore":"endAt";e[s]=B(n.indexEndValue_),n.endNameSet_&&(e[s]+=","+B(n.indexEndName_))}return n.limitSet_&&(n.isViewFromLeft()?e.limitToFirst=n.limit_:e.limitToLast=n.limit_),e}function ci(n){const e={};if(n.startSet_&&(e.sp=n.indexStartValue_,n.startNameSet_&&(e.sn=n.indexStartName_),e.sin=!n.startAfterSet_),n.endSet_&&(e.ep=n.indexEndValue_,n.endNameSet_&&(e.en=n.indexEndName_),e.ein=!n.endBeforeSet_),n.limitSet_){e.l=n.limit_;let t=n.viewFrom_;t===""&&(n.isViewFromLeft()?t="l":t="r"),e.vf=t}return n.index_!==D&&(e.i=n.index_.toString()),e}class Wt extends Cr{reportStats(e){throw new Error("Method not implemented.")}static getListenId_(e,t){return t!==void 0?"tag$"+t:(g(e._queryParams.isDefault(),"should have a tag if it's not a default query."),e._path.toString())}constructor(e,t,s,i){super(),this.repoInfo_=e,this.onDataUpdate_=t,this.authTokenProvider_=s,this.appCheckTokenProvider_=i,this.log_=St("p:rest:"),this.listens_={}}listen(e,t,s,i){const r=e._path.toString();this.log_("Listen called for "+r+" "+e._queryIdentifier);const o=Wt.getListenId_(e,s),a={};this.listens_[o]=a;const l=li(e._queryParams);this.restRequest_(r+".json",l,(c,d)=>{let u=d;if(c===404&&(u=null,c=null),c===null&&this.onDataUpdate_(r,u,!1,s),Ne(this.listens_,o)===a){let h;c?c===401?h="permission_denied":h="rest_error:"+c:h="ok",i(h,null)}})}unlisten(e,t){const s=Wt.getListenId_(e,t);delete this.listens_[s]}get(e){const t=li(e._queryParams),s=e._path.toString(),i=new ee;return this.restRequest_(s+".json",t,(r,o)=>{let a=o;r===404&&(a=null,r=null),r===null?(this.onDataUpdate_(s,a,!1,null),i.resolve(a)):i.reject(new Error(a))}),i.promise}refreshAuthToken(e){}restRequest_(e,t={},s){return t.format="export",Promise.all([this.authTokenProvider_.getToken(!1),this.appCheckTokenProvider_.getToken(!1)]).then(([i,r])=>{i&&i.accessToken&&(t.auth=i.accessToken),r&&r.token&&(t.ac=r.token);const o=(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host+e+"?ns="+this.repoInfo_.namespace+rl(t);this.log_("Sending REST request for "+o);const a=new XMLHttpRequest;a.onreadystatechange=()=>{if(s&&a.readyState===4){this.log_("REST Response for "+o+" received. status:",a.status,"response:",a.responseText);let l=null;if(a.status>=200&&a.status<300){try{l=ht(a.responseText)}catch{z("Failed to parse JSON response for "+o+": "+a.responseText)}s(null,l)}else a.status!==401&&a.status!==404&&z("Got unsuccessful REST response for "+o+" Status: "+a.status),s(a.status);s=null}},a.open("GET",o,!0),a.send()})}}class Ph{constructor(){this.rootNode_=y.EMPTY_NODE}getNode(e){return this.rootNode_.getChild(e)}updateSnapshot(e,t){this.rootNode_=this.rootNode_.updateChild(e,t)}}function Gt(){return{value:null,children:new Map}}function qe(n,e,t){if(S(e))n.value=t,n.children.clear();else if(n.value!==null)n.value=n.value.updateChild(e,t);else{const s=v(e);n.children.has(s)||n.children.set(s,Gt());const i=n.children.get(s);e=O(e),qe(i,e,t)}}function Fn(n,e){if(S(e))return n.value=null,n.children.clear(),!0;if(n.value!==null){if(n.value.isLeafNode())return!1;{const t=n.value;return n.value=null,t.forEachChild(D,(s,i)=>{qe(n,new I(s),i)}),Fn(n,e)}}else if(n.children.size>0){const t=v(e);return e=O(e),n.children.has(t)&&Fn(n.children.get(t),e)&&n.children.delete(t),n.children.size===0}else return!0}function Wn(n,e,t){n.value!==null?t(e,n.value):xh(n,(s,i)=>{const r=new I(e.toString()+"/"+s);Wn(i,r,t)})}function xh(n,e){n.children.forEach((t,s)=>{e(s,t)})}class Bh{constructor(e){this.collection_=e,this.last_=null}get(){const e=this.collection_.get(),t={...e};return this.last_&&U(this.last_,(s,i)=>{t[s]=t[s]-i}),this.last_=e,t}}const hi=10*1e3,Fh=30*1e3,Wh=300*1e3;class Gh{constructor(e,t){this.server_=t,this.statsToReport_={},this.statsListener_=new Bh(e);const s=hi+(Fh-hi)*Math.random();ot(this.reportStats_.bind(this),Math.floor(s))}reportStats_(){const e=this.statsListener_.get(),t={};let s=!1;U(e,(i,r)=>{r>0&&ie(this.statsToReport_,i)&&(t[i]=r,s=!0)}),s&&this.server_.reportStats(t),ot(this.reportStats_.bind(this),Math.floor(Math.random()*2*Wh))}}var ne;(function(n){n[n.OVERWRITE=0]="OVERWRITE",n[n.MERGE=1]="MERGE",n[n.ACK_USER_WRITE=2]="ACK_USER_WRITE",n[n.LISTEN_COMPLETE=3]="LISTEN_COMPLETE"})(ne||(ne={}));function as(){return{fromUser:!0,fromServer:!1,queryId:null,tagged:!1}}function ls(){return{fromUser:!1,fromServer:!0,queryId:null,tagged:!1}}function cs(n){return{fromUser:!1,fromServer:!0,queryId:n,tagged:!0}}class Ut{constructor(e,t,s){this.path=e,this.affectedTree=t,this.revert=s,this.type=ne.ACK_USER_WRITE,this.source=as()}operationForChild(e){if(S(this.path)){if(this.affectedTree.value!=null)return g(this.affectedTree.children.isEmpty(),"affectedTree should not have overlapping affected paths."),this;{const t=this.affectedTree.subtree(new I(e));return new Ut(w(),t,this.revert)}}else return g(v(this.path)===e,"operationForChild called for unrelated child."),new Ut(O(this.path),this.affectedTree,this.revert)}}class yt{constructor(e,t){this.source=e,this.path=t,this.type=ne.LISTEN_COMPLETE}operationForChild(e){return S(this.path)?new yt(this.source,w()):new yt(this.source,O(this.path))}}class Oe{constructor(e,t,s){this.source=e,this.path=t,this.snap=s,this.type=ne.OVERWRITE}operationForChild(e){return S(this.path)?new Oe(this.source,w(),this.snap.getImmediateChild(e)):new Oe(this.source,O(this.path),this.snap)}}class He{constructor(e,t,s){this.source=e,this.path=t,this.children=s,this.type=ne.MERGE}operationForChild(e){if(S(this.path)){const t=this.children.subtree(new I(e));return t.isEmpty()?null:t.value?new Oe(this.source,w(),t.value):new He(this.source,w(),t)}else return g(v(this.path)===e,"Can't get a merge for a child not on the path of the operation"),new He(this.source,O(this.path),this.children)}toString(){return"Operation("+this.path+": "+this.source.toString()+" merge: "+this.children.toString()+")"}}class Ce{constructor(e,t,s){this.node_=e,this.fullyInitialized_=t,this.filtered_=s}isFullyInitialized(){return this.fullyInitialized_}isFiltered(){return this.filtered_}isCompleteForPath(e){if(S(e))return this.isFullyInitialized()&&!this.filtered_;const t=v(e);return this.isCompleteForChild(t)}isCompleteForChild(e){return this.isFullyInitialized()&&!this.filtered_||this.node_.hasChild(e)}getNode(){return this.node_}}class Uh{constructor(e){this.query_=e,this.index_=this.query_._queryParams.getIndex()}}function Hh(n,e,t,s){const i=[],r=[];return e.forEach(o=>{o.type==="child_changed"&&n.index_.indexedValueChanged(o.oldSnap,o.snapshotNode)&&r.push(Lh(o.childName,o.snapshotNode))}),tt(n,i,"child_removed",e,s,t),tt(n,i,"child_added",e,s,t),tt(n,i,"child_moved",r,s,t),tt(n,i,"child_changed",e,s,t),tt(n,i,"value",e,s,t),i}function tt(n,e,t,s,i,r){const o=s.filter(a=>a.type===t);o.sort((a,l)=>Vh(n,a,l)),o.forEach(a=>{const l=$h(n,a,r);i.forEach(c=>{c.respondsTo(a.type)&&e.push(c.createEvent(l,n.query_))})})}function $h(n,e,t){return e.type==="value"||e.type==="child_removed"||(e.prevName=t.getPredecessorChildName(e.childName,e.snapshotNode,n.index_)),e}function Vh(n,e,t){if(e.childName==null||t.childName==null)throw Ye("Should only compare child_ events.");const s=new b(e.childName,e.snapshotNode),i=new b(t.childName,t.snapshotNode);return n.index_.compare(s,i)}function Zt(n,e){return{eventCache:n,serverCache:e}}function at(n,e,t,s){return Zt(new Ce(e,t,s),n.serverCache)}function Ar(n,e,t,s){return Zt(n.eventCache,new Ce(e,t,s))}function Ht(n){return n.eventCache.isFullyInitialized()?n.eventCache.getNode():null}function Ae(n){return n.serverCache.isFullyInitialized()?n.serverCache.getNode():null}let Sn;const Kh=()=>(Sn||(Sn=new Y(Oc)),Sn);class A{static fromObject(e){let t=new A(null);return U(e,(s,i)=>{t=t.set(new I(s),i)}),t}constructor(e,t=Kh()){this.value=e,this.children=t}isEmpty(){return this.value===null&&this.children.isEmpty()}findRootMostMatchingPathAndValue(e,t){if(this.value!=null&&t(this.value))return{path:w(),value:this.value};if(S(e))return null;{const s=v(e),i=this.children.get(s);if(i!==null){const r=i.findRootMostMatchingPathAndValue(O(e),t);return r!=null?{path:P(new I(s),r.path),value:r.value}:null}else return null}}findRootMostValueAndPath(e){return this.findRootMostMatchingPathAndValue(e,()=>!0)}subtree(e){if(S(e))return this;{const t=v(e),s=this.children.get(t);return s!==null?s.subtree(O(e)):new A(null)}}set(e,t){if(S(e))return new A(t,this.children);{const s=v(e),r=(this.children.get(s)||new A(null)).set(O(e),t),o=this.children.insert(s,r);return new A(this.value,o)}}remove(e){if(S(e))return this.children.isEmpty()?new A(null):new A(null,this.children);{const t=v(e),s=this.children.get(t);if(s){const i=s.remove(O(e));let r;return i.isEmpty()?r=this.children.remove(t):r=this.children.insert(t,i),this.value===null&&r.isEmpty()?new A(null):new A(this.value,r)}else return this}}get(e){if(S(e))return this.value;{const t=v(e),s=this.children.get(t);return s?s.get(O(e)):null}}setTree(e,t){if(S(e))return t;{const s=v(e),r=(this.children.get(s)||new A(null)).setTree(O(e),t);let o;return r.isEmpty()?o=this.children.remove(s):o=this.children.insert(s,r),new A(this.value,o)}}fold(e){return this.fold_(w(),e)}fold_(e,t){const s={};return this.children.inorderTraversal((i,r)=>{s[i]=r.fold_(P(e,i),t)}),t(e,this.value,s)}findOnPath(e,t){return this.findOnPath_(e,w(),t)}findOnPath_(e,t,s){const i=this.value?s(t,this.value):!1;if(i)return i;if(S(e))return null;{const r=v(e),o=this.children.get(r);return o?o.findOnPath_(O(e),P(t,r),s):null}}foreachOnPath(e,t){return this.foreachOnPath_(e,w(),t)}foreachOnPath_(e,t,s){if(S(e))return this;{this.value&&s(t,this.value);const i=v(e),r=this.children.get(i);return r?r.foreachOnPath_(O(e),P(t,i),s):new A(null)}}foreach(e){this.foreach_(w(),e)}foreach_(e,t){this.children.inorderTraversal((s,i)=>{i.foreach_(P(e,s),t)}),this.value&&t(e,this.value)}foreachChild(e){this.children.inorderTraversal((t,s)=>{s.value&&e(t,s.value)})}}class se{constructor(e){this.writeTree_=e}static empty(){return new se(new A(null))}}function lt(n,e,t){if(S(e))return new se(new A(t));{const s=n.writeTree_.findRootMostValueAndPath(e);if(s!=null){const i=s.path;let r=s.value;const o=K(i,e);return r=r.updateChild(o,t),new se(n.writeTree_.set(i,r))}else{const i=new A(t),r=n.writeTree_.setTree(e,i);return new se(r)}}}function Gn(n,e,t){let s=n;return U(t,(i,r)=>{s=lt(s,P(e,i),r)}),s}function di(n,e){if(S(e))return se.empty();{const t=n.writeTree_.setTree(e,new A(null));return new se(t)}}function Un(n,e){return Le(n,e)!=null}function Le(n,e){const t=n.writeTree_.findRootMostValueAndPath(e);return t!=null?n.writeTree_.get(t.path).getChild(K(t.path,e)):null}function ui(n){const e=[],t=n.writeTree_.value;return t!=null?t.isLeafNode()||t.forEachChild(D,(s,i)=>{e.push(new b(s,i))}):n.writeTree_.children.inorderTraversal((s,i)=>{i.value!=null&&e.push(new b(s,i.value))}),e}function _e(n,e){if(S(e))return n;{const t=Le(n,e);return t!=null?new se(new A(t)):new se(n.writeTree_.subtree(e))}}function Hn(n){return n.writeTree_.isEmpty()}function $e(n,e){return kr(w(),n.writeTree_,e)}function kr(n,e,t){if(e.value!=null)return t.updateChild(n,e.value);{let s=null;return e.children.inorderTraversal((i,r)=>{i===".priority"?(g(r.value!==null,"Priority writes must always be leaf nodes"),s=r.value):t=kr(P(n,i),r,t)}),!t.getChild(n).isEmpty()&&s!==null&&(t=t.updateChild(P(n,".priority"),s)),t}}function en(n,e){return Pr(e,n)}function zh(n,e,t,s,i){g(s>n.lastWriteId,"Stacking an older write on top of newer ones"),i===void 0&&(i=!0),n.allWrites.push({path:e,snap:t,writeId:s,visible:i}),i&&(n.visibleWrites=lt(n.visibleWrites,e,t)),n.lastWriteId=s}function Yh(n,e,t,s){g(s>n.lastWriteId,"Stacking an older merge on top of newer ones"),n.allWrites.push({path:e,children:t,writeId:s,visible:!0}),n.visibleWrites=Gn(n.visibleWrites,e,t),n.lastWriteId=s}function jh(n,e){for(let t=0;t<n.allWrites.length;t++){const s=n.allWrites[t];if(s.writeId===e)return s}return null}function qh(n,e){const t=n.allWrites.findIndex(a=>a.writeId===e);g(t>=0,"removeWrite called with nonexistent writeId.");const s=n.allWrites[t];n.allWrites.splice(t,1);let i=s.visible,r=!1,o=n.allWrites.length-1;for(;i&&o>=0;){const a=n.allWrites[o];a.visible&&(o>=t&&Qh(a,s.path)?i=!1:Z(s.path,a.path)&&(r=!0)),o--}if(i){if(r)return Xh(n),!0;if(s.snap)n.visibleWrites=di(n.visibleWrites,s.path);else{const a=s.children;U(a,l=>{n.visibleWrites=di(n.visibleWrites,P(s.path,l))})}return!0}else return!1}function Qh(n,e){if(n.snap)return Z(n.path,e);for(const t in n.children)if(n.children.hasOwnProperty(t)&&Z(P(n.path,t),e))return!0;return!1}function Xh(n){n.visibleWrites=Lr(n.allWrites,Jh,w()),n.allWrites.length>0?n.lastWriteId=n.allWrites[n.allWrites.length-1].writeId:n.lastWriteId=-1}function Jh(n){return n.visible}function Lr(n,e,t){let s=se.empty();for(let i=0;i<n.length;++i){const r=n[i];if(e(r)){const o=r.path;let a;if(r.snap)Z(t,o)?(a=K(t,o),s=lt(s,a,r.snap)):Z(o,t)&&(a=K(o,t),s=lt(s,w(),r.snap.getChild(a)));else if(r.children){if(Z(t,o))a=K(t,o),s=Gn(s,a,r.children);else if(Z(o,t))if(a=K(o,t),S(a))s=Gn(s,w(),r.children);else{const l=Ne(r.children,v(a));if(l){const c=l.getChild(O(a));s=lt(s,w(),c)}}}else throw Ye("WriteRecord should have .snap or .children")}}return s}function Dr(n,e,t,s,i){if(!s&&!i){const r=Le(n.visibleWrites,e);if(r!=null)return r;{const o=_e(n.visibleWrites,e);if(Hn(o))return t;if(t==null&&!Un(o,w()))return null;{const a=t||y.EMPTY_NODE;return $e(o,a)}}}else{const r=_e(n.visibleWrites,e);if(!i&&Hn(r))return t;if(!i&&t==null&&!Un(r,w()))return null;{const o=function(c){return(c.visible||i)&&(!s||!~s.indexOf(c.writeId))&&(Z(c.path,e)||Z(e,c.path))},a=Lr(n.allWrites,o,e),l=t||y.EMPTY_NODE;return $e(a,l)}}}function Zh(n,e,t){let s=y.EMPTY_NODE;const i=Le(n.visibleWrites,e);if(i)return i.isLeafNode()||i.forEachChild(D,(r,o)=>{s=s.updateImmediateChild(r,o)}),s;if(t){const r=_e(n.visibleWrites,e);return t.forEachChild(D,(o,a)=>{const l=$e(_e(r,new I(o)),a);s=s.updateImmediateChild(o,l)}),ui(r).forEach(o=>{s=s.updateImmediateChild(o.name,o.node)}),s}else{const r=_e(n.visibleWrites,e);return ui(r).forEach(o=>{s=s.updateImmediateChild(o.name,o.node)}),s}}function ed(n,e,t,s,i){g(s||i,"Either existingEventSnap or existingServerSnap must exist");const r=P(e,t);if(Un(n.visibleWrites,r))return null;{const o=_e(n.visibleWrites,r);return Hn(o)?i.getChild(t):$e(o,i.getChild(t))}}function td(n,e,t,s){const i=P(e,t),r=Le(n.visibleWrites,i);if(r!=null)return r;if(s.isCompleteForChild(t)){const o=_e(n.visibleWrites,i);return $e(o,s.getNode().getImmediateChild(t))}else return null}function nd(n,e){return Le(n.visibleWrites,e)}function sd(n,e,t,s,i,r,o){let a;const l=_e(n.visibleWrites,e),c=Le(l,w());if(c!=null)a=c;else if(t!=null)a=$e(l,t);else return[];if(a=a.withIndex(o),!a.isEmpty()&&!a.isLeafNode()){const d=[],u=o.getCompare(),h=r?a.getReverseIteratorFrom(s,o):a.getIteratorFrom(s,o);let p=h.getNext();for(;p&&d.length<i;)u(p,s)!==0&&d.push(p),p=h.getNext();return d}else return[]}function id(){return{visibleWrites:se.empty(),allWrites:[],lastWriteId:-1}}function $t(n,e,t,s){return Dr(n.writeTree,n.treePath,e,t,s)}function hs(n,e){return Zh(n.writeTree,n.treePath,e)}function fi(n,e,t,s){return ed(n.writeTree,n.treePath,e,t,s)}function Vt(n,e){return nd(n.writeTree,P(n.treePath,e))}function rd(n,e,t,s,i,r){return sd(n.writeTree,n.treePath,e,t,s,i,r)}function ds(n,e,t){return td(n.writeTree,n.treePath,e,t)}function Mr(n,e){return Pr(P(n.treePath,e),n.writeTree)}function Pr(n,e){return{treePath:n,writeTree:e}}class od{constructor(){this.changeMap=new Map}trackChildChange(e){const t=e.type,s=e.childName;g(t==="child_added"||t==="child_changed"||t==="child_removed","Only child changes supported for tracking"),g(s!==".priority","Only non-priority child changes can be tracked.");const i=this.changeMap.get(s);if(i){const r=i.type;if(t==="child_added"&&r==="child_removed")this.changeMap.set(s,gt(s,e.snapshotNode,i.snapshotNode));else if(t==="child_removed"&&r==="child_added")this.changeMap.delete(s);else if(t==="child_removed"&&r==="child_changed")this.changeMap.set(s,mt(s,i.oldSnap));else if(t==="child_changed"&&r==="child_added")this.changeMap.set(s,Ue(s,e.snapshotNode));else if(t==="child_changed"&&r==="child_changed")this.changeMap.set(s,gt(s,e.snapshotNode,i.oldSnap));else throw Ye("Illegal combination of changes: "+e+" occurred after "+i)}else this.changeMap.set(s,e)}getChanges(){return Array.from(this.changeMap.values())}}class ad{getCompleteChild(e){return null}getChildAfterChild(e,t,s){return null}}const xr=new ad;class us{constructor(e,t,s=null){this.writes_=e,this.viewCache_=t,this.optCompleteServerCache_=s}getCompleteChild(e){const t=this.viewCache_.eventCache;if(t.isCompleteForChild(e))return t.getNode().getImmediateChild(e);{const s=this.optCompleteServerCache_!=null?new Ce(this.optCompleteServerCache_,!0,!1):this.viewCache_.serverCache;return ds(this.writes_,e,s)}}getChildAfterChild(e,t,s){const i=this.optCompleteServerCache_!=null?this.optCompleteServerCache_:Ae(this.viewCache_),r=rd(this.writes_,i,t,1,s,e);return r.length===0?null:r[0]}}function ld(n){return{filter:n}}function cd(n,e){g(e.eventCache.getNode().isIndexed(n.filter.getIndex()),"Event snap not indexed"),g(e.serverCache.getNode().isIndexed(n.filter.getIndex()),"Server snap not indexed")}function hd(n,e,t,s,i){const r=new od;let o,a;if(t.type===ne.OVERWRITE){const c=t;c.source.fromUser?o=$n(n,e,c.path,c.snap,s,i,r):(g(c.source.fromServer,"Unknown source."),a=c.source.tagged||e.serverCache.isFiltered()&&!S(c.path),o=Kt(n,e,c.path,c.snap,s,i,a,r))}else if(t.type===ne.MERGE){const c=t;c.source.fromUser?o=ud(n,e,c.path,c.children,s,i,r):(g(c.source.fromServer,"Unknown source."),a=c.source.tagged||e.serverCache.isFiltered(),o=Vn(n,e,c.path,c.children,s,i,a,r))}else if(t.type===ne.ACK_USER_WRITE){const c=t;c.revert?o=md(n,e,c.path,s,i,r):o=fd(n,e,c.path,c.affectedTree,s,i,r)}else if(t.type===ne.LISTEN_COMPLETE)o=pd(n,e,t.path,s,r);else throw Ye("Unknown operation type: "+t.type);const l=r.getChanges();return dd(e,o,l),{viewCache:o,changes:l}}function dd(n,e,t){const s=e.eventCache;if(s.isFullyInitialized()){const i=s.getNode().isLeafNode()||s.getNode().isEmpty(),r=Ht(n);(t.length>0||!n.eventCache.isFullyInitialized()||i&&!s.getNode().equals(r)||!s.getNode().getPriority().equals(r.getPriority()))&&t.push(Or(Ht(e)))}}function Br(n,e,t,s,i,r){const o=e.eventCache;if(Vt(s,t)!=null)return e;{let a,l;if(S(t))if(g(e.serverCache.isFullyInitialized(),"If change path is empty, we must have complete server data"),e.serverCache.isFiltered()){const c=Ae(e),d=c instanceof y?c:y.EMPTY_NODE,u=hs(s,d);a=n.filter.updateFullNode(e.eventCache.getNode(),u,r)}else{const c=$t(s,Ae(e));a=n.filter.updateFullNode(e.eventCache.getNode(),c,r)}else{const c=v(t);if(c===".priority"){g(Ee(t)===1,"Can't have a priority with additional path components");const d=o.getNode();l=e.serverCache.getNode();const u=fi(s,t,d,l);u!=null?a=n.filter.updatePriority(d,u):a=o.getNode()}else{const d=O(t);let u;if(o.isCompleteForChild(c)){l=e.serverCache.getNode();const h=fi(s,t,o.getNode(),l);h!=null?u=o.getNode().getImmediateChild(c).updateChild(d,h):u=o.getNode().getImmediateChild(c)}else u=ds(s,c,e.serverCache);u!=null?a=n.filter.updateChild(o.getNode(),c,u,d,i,r):a=o.getNode()}}return at(e,a,o.isFullyInitialized()||S(t),n.filter.filtersNodes())}}function Kt(n,e,t,s,i,r,o,a){const l=e.serverCache;let c;const d=o?n.filter:n.filter.getIndexedFilter();if(S(t))c=d.updateFullNode(l.getNode(),s,null);else if(d.filtersNodes()&&!l.isFiltered()){const p=l.getNode().updateChild(t,s);c=d.updateFullNode(l.getNode(),p,null)}else{const p=v(t);if(!l.isCompleteForPath(t)&&Ee(t)>1)return e;const m=O(t),E=l.getNode().getImmediateChild(p).updateChild(m,s);p===".priority"?c=d.updatePriority(l.getNode(),E):c=d.updateChild(l.getNode(),p,E,m,xr,null)}const u=Ar(e,c,l.isFullyInitialized()||S(t),d.filtersNodes()),h=new us(i,u,r);return Br(n,u,t,i,h,a)}function $n(n,e,t,s,i,r,o){const a=e.eventCache;let l,c;const d=new us(i,e,r);if(S(t))c=n.filter.updateFullNode(e.eventCache.getNode(),s,o),l=at(e,c,!0,n.filter.filtersNodes());else{const u=v(t);if(u===".priority")c=n.filter.updatePriority(e.eventCache.getNode(),s),l=at(e,c,a.isFullyInitialized(),a.isFiltered());else{const h=O(t),p=a.getNode().getImmediateChild(u);let m;if(S(h))m=s;else{const _=d.getCompleteChild(u);_!=null?ts(h)===".priority"&&_.getChild(Sr(h)).isEmpty()?m=_:m=_.updateChild(h,s):m=y.EMPTY_NODE}if(p.equals(m))l=e;else{const _=n.filter.updateChild(a.getNode(),u,m,h,d,o);l=at(e,_,a.isFullyInitialized(),n.filter.filtersNodes())}}}return l}function pi(n,e){return n.eventCache.isCompleteForChild(e)}function ud(n,e,t,s,i,r,o){let a=e;return s.foreach((l,c)=>{const d=P(t,l);pi(e,v(d))&&(a=$n(n,a,d,c,i,r,o))}),s.foreach((l,c)=>{const d=P(t,l);pi(e,v(d))||(a=$n(n,a,d,c,i,r,o))}),a}function mi(n,e,t){return t.foreach((s,i)=>{e=e.updateChild(s,i)}),e}function Vn(n,e,t,s,i,r,o,a){if(e.serverCache.getNode().isEmpty()&&!e.serverCache.isFullyInitialized())return e;let l=e,c;S(t)?c=s:c=new A(null).setTree(t,s);const d=e.serverCache.getNode();return c.children.inorderTraversal((u,h)=>{if(d.hasChild(u)){const p=e.serverCache.getNode().getImmediateChild(u),m=mi(n,p,h);l=Kt(n,l,new I(u),m,i,r,o,a)}}),c.children.inorderTraversal((u,h)=>{const p=!e.serverCache.isCompleteForChild(u)&&h.value===null;if(!d.hasChild(u)&&!p){const m=e.serverCache.getNode().getImmediateChild(u),_=mi(n,m,h);l=Kt(n,l,new I(u),_,i,r,o,a)}}),l}function fd(n,e,t,s,i,r,o){if(Vt(i,t)!=null)return e;const a=e.serverCache.isFiltered(),l=e.serverCache;if(s.value!=null){if(S(t)&&l.isFullyInitialized()||l.isCompleteForPath(t))return Kt(n,e,t,l.getNode().getChild(t),i,r,a,o);if(S(t)){let c=new A(null);return l.getNode().forEachChild(Fe,(d,u)=>{c=c.set(new I(d),u)}),Vn(n,e,t,c,i,r,a,o)}else return e}else{let c=new A(null);return s.foreach((d,u)=>{const h=P(t,d);l.isCompleteForPath(h)&&(c=c.set(d,l.getNode().getChild(h)))}),Vn(n,e,t,c,i,r,a,o)}}function pd(n,e,t,s,i){const r=e.serverCache,o=Ar(e,r.getNode(),r.isFullyInitialized()||S(t),r.isFiltered());return Br(n,o,t,s,xr,i)}function md(n,e,t,s,i,r){let o;if(Vt(s,t)!=null)return e;{const a=new us(s,e,i),l=e.eventCache.getNode();let c;if(S(t)||v(t)===".priority"){let d;if(e.serverCache.isFullyInitialized())d=$t(s,Ae(e));else{const u=e.serverCache.getNode();g(u instanceof y,"serverChildren would be complete if leaf node"),d=hs(s,u)}d=d,c=n.filter.updateFullNode(l,d,r)}else{const d=v(t);let u=ds(s,d,e.serverCache);u==null&&e.serverCache.isCompleteForChild(d)&&(u=l.getImmediateChild(d)),u!=null?c=n.filter.updateChild(l,d,u,O(t),a,r):e.eventCache.getNode().hasChild(d)?c=n.filter.updateChild(l,d,y.EMPTY_NODE,O(t),a,r):c=l,c.isEmpty()&&e.serverCache.isFullyInitialized()&&(o=$t(s,Ae(e)),o.isLeafNode()&&(c=n.filter.updateFullNode(c,o,r)))}return o=e.serverCache.isFullyInitialized()||Vt(s,w())!=null,at(e,c,o,n.filter.filtersNodes())}}class gd{constructor(e,t){this.query_=e,this.eventRegistrations_=[];const s=this.query_._queryParams,i=new rs(s.getIndex()),r=Mh(s);this.processor_=ld(r);const o=t.serverCache,a=t.eventCache,l=i.updateFullNode(y.EMPTY_NODE,o.getNode(),null),c=r.updateFullNode(y.EMPTY_NODE,a.getNode(),null),d=new Ce(l,o.isFullyInitialized(),i.filtersNodes()),u=new Ce(c,a.isFullyInitialized(),r.filtersNodes());this.viewCache_=Zt(u,d),this.eventGenerator_=new Uh(this.query_)}get query(){return this.query_}}function _d(n){return n.viewCache_.serverCache.getNode()}function yd(n){return Ht(n.viewCache_)}function Ed(n,e){const t=Ae(n.viewCache_);return t&&(n.query._queryParams.loadsAllData()||!S(e)&&!t.getImmediateChild(v(e)).isEmpty())?t.getChild(e):null}function gi(n){return n.eventRegistrations_.length===0}function Cd(n,e){n.eventRegistrations_.push(e)}function _i(n,e,t){const s=[];if(t){g(e==null,"A cancel should cancel all event registrations.");const i=n.query._path;n.eventRegistrations_.forEach(r=>{const o=r.createCancelEvent(t,i);o&&s.push(o)})}if(e){let i=[];for(let r=0;r<n.eventRegistrations_.length;++r){const o=n.eventRegistrations_[r];if(!o.matches(e))i.push(o);else if(e.hasAnyCallback()){i=i.concat(n.eventRegistrations_.slice(r+1));break}}n.eventRegistrations_=i}else n.eventRegistrations_=[];return s}function yi(n,e,t,s){e.type===ne.MERGE&&e.source.queryId!==null&&(g(Ae(n.viewCache_),"We should always have a full cache before handling merges"),g(Ht(n.viewCache_),"Missing event cache, even though we have a server cache"));const i=n.viewCache_,r=hd(n.processor_,i,e,t,s);return cd(n.processor_,r.viewCache),g(r.viewCache.serverCache.isFullyInitialized()||!i.serverCache.isFullyInitialized(),"Once a server snap is complete, it should never go back"),n.viewCache_=r.viewCache,Fr(n,r.changes,r.viewCache.eventCache.getNode(),null)}function vd(n,e){const t=n.viewCache_.eventCache,s=[];return t.getNode().isLeafNode()||t.getNode().forEachChild(D,(r,o)=>{s.push(Ue(r,o))}),t.isFullyInitialized()&&s.push(Or(t.getNode())),Fr(n,s,t.getNode(),e)}function Fr(n,e,t,s){const i=s?[s]:n.eventRegistrations_;return Hh(n.eventGenerator_,e,t,i)}let zt;class Wr{constructor(){this.views=new Map}}function Sd(n){g(!zt,"__referenceConstructor has already been defined"),zt=n}function bd(){return g(zt,"Reference.ts has not been loaded"),zt}function wd(n){return n.views.size===0}function fs(n,e,t,s){const i=e.source.queryId;if(i!==null){const r=n.views.get(i);return g(r!=null,"SyncTree gave us an op for an invalid query."),yi(r,e,t,s)}else{let r=[];for(const o of n.views.values())r=r.concat(yi(o,e,t,s));return r}}function Gr(n,e,t,s,i){const r=e._queryIdentifier,o=n.views.get(r);if(!o){let a=$t(t,i?s:null),l=!1;a?l=!0:s instanceof y?(a=hs(t,s),l=!1):(a=y.EMPTY_NODE,l=!1);const c=Zt(new Ce(a,l,!1),new Ce(s,i,!1));return new gd(e,c)}return o}function Id(n,e,t,s,i,r){const o=Gr(n,e,s,i,r);return n.views.has(e._queryIdentifier)||n.views.set(e._queryIdentifier,o),Cd(o,t),vd(o,t)}function Td(n,e,t,s){const i=e._queryIdentifier,r=[];let o=[];const a=ve(n);if(i==="default")for(const[l,c]of n.views.entries())o=o.concat(_i(c,t,s)),gi(c)&&(n.views.delete(l),c.query._queryParams.loadsAllData()||r.push(c.query));else{const l=n.views.get(i);l&&(o=o.concat(_i(l,t,s)),gi(l)&&(n.views.delete(i),l.query._queryParams.loadsAllData()||r.push(l.query)))}return a&&!ve(n)&&r.push(new(bd())(e._repo,e._path)),{removed:r,events:o}}function Ur(n){const e=[];for(const t of n.views.values())t.query._queryParams.loadsAllData()||e.push(t);return e}function ye(n,e){let t=null;for(const s of n.views.values())t=t||Ed(s,e);return t}function Hr(n,e){if(e._queryParams.loadsAllData())return tn(n);{const s=e._queryIdentifier;return n.views.get(s)}}function $r(n,e){return Hr(n,e)!=null}function ve(n){return tn(n)!=null}function tn(n){for(const e of n.views.values())if(e.query._queryParams.loadsAllData())return e;return null}let Yt;function Nd(n){g(!Yt,"__referenceConstructor has already been defined"),Yt=n}function Rd(){return g(Yt,"Reference.ts has not been loaded"),Yt}let Od=1;class Ei{constructor(e){this.listenProvider_=e,this.syncPointTree_=new A(null),this.pendingWriteTree_=id(),this.tagToQueryMap=new Map,this.queryToTagMap=new Map}}function ps(n,e,t,s,i){return zh(n.pendingWriteTree_,e,t,s,i),i?Qe(n,new Oe(as(),e,t)):[]}function Ad(n,e,t,s){Yh(n.pendingWriteTree_,e,t,s);const i=A.fromObject(t);return Qe(n,new He(as(),e,i))}function pe(n,e,t=!1){const s=jh(n.pendingWriteTree_,e);if(qh(n.pendingWriteTree_,e)){let r=new A(null);return s.snap!=null?r=r.set(w(),!0):U(s.children,o=>{r=r.set(new I(o),!0)}),Qe(n,new Ut(s.path,r,t))}else return[]}function wt(n,e,t){return Qe(n,new Oe(ls(),e,t))}function kd(n,e,t){const s=A.fromObject(t);return Qe(n,new He(ls(),e,s))}function Ld(n,e){return Qe(n,new yt(ls(),e))}function Dd(n,e,t){const s=ms(n,t);if(s){const i=gs(s),r=i.path,o=i.queryId,a=K(r,e),l=new yt(cs(o),a);return _s(n,r,l)}else return[]}function jt(n,e,t,s,i=!1){const r=e._path,o=n.syncPointTree_.get(r);let a=[];if(o&&(e._queryIdentifier==="default"||$r(o,e))){const l=Td(o,e,t,s);wd(o)&&(n.syncPointTree_=n.syncPointTree_.remove(r));const c=l.removed;if(a=l.events,!i){const d=c.findIndex(h=>h._queryParams.loadsAllData())!==-1,u=n.syncPointTree_.findOnPath(r,(h,p)=>ve(p));if(d&&!u){const h=n.syncPointTree_.subtree(r);if(!h.isEmpty()){const p=xd(h);for(let m=0;m<p.length;++m){const _=p[m],E=_.query,R=Yr(n,_);n.listenProvider_.startListening(ct(E),Et(n,E),R.hashFn,R.onComplete)}}}!u&&c.length>0&&!s&&(d?n.listenProvider_.stopListening(ct(e),null):c.forEach(h=>{const p=n.queryToTagMap.get(sn(h));n.listenProvider_.stopListening(ct(h),p)}))}Bd(n,c)}return a}function Vr(n,e,t,s){const i=ms(n,s);if(i!=null){const r=gs(i),o=r.path,a=r.queryId,l=K(o,e),c=new Oe(cs(a),l,t);return _s(n,o,c)}else return[]}function Md(n,e,t,s){const i=ms(n,s);if(i){const r=gs(i),o=r.path,a=r.queryId,l=K(o,e),c=A.fromObject(t),d=new He(cs(a),l,c);return _s(n,o,d)}else return[]}function Kn(n,e,t,s=!1){const i=e._path;let r=null,o=!1;n.syncPointTree_.foreachOnPath(i,(h,p)=>{const m=K(h,i);r=r||ye(p,m),o=o||ve(p)});let a=n.syncPointTree_.get(i);a?(o=o||ve(a),r=r||ye(a,w())):(a=new Wr,n.syncPointTree_=n.syncPointTree_.set(i,a));let l;r!=null?l=!0:(l=!1,r=y.EMPTY_NODE,n.syncPointTree_.subtree(i).foreachChild((p,m)=>{const _=ye(m,w());_&&(r=r.updateImmediateChild(p,_))}));const c=$r(a,e);if(!c&&!e._queryParams.loadsAllData()){const h=sn(e);g(!n.queryToTagMap.has(h),"View does not exist, but we have a tag");const p=Fd();n.queryToTagMap.set(h,p),n.tagToQueryMap.set(p,h)}const d=en(n.pendingWriteTree_,i);let u=Id(a,e,t,d,r,l);if(!c&&!o&&!s){const h=Hr(a,e);u=u.concat(Wd(n,e,h))}return u}function nn(n,e,t){const i=n.pendingWriteTree_,r=n.syncPointTree_.findOnPath(e,(o,a)=>{const l=K(o,e),c=ye(a,l);if(c)return c});return Dr(i,e,r,t,!0)}function Pd(n,e){const t=e._path;let s=null;n.syncPointTree_.foreachOnPath(t,(c,d)=>{const u=K(c,t);s=s||ye(d,u)});let i=n.syncPointTree_.get(t);i?s=s||ye(i,w()):(i=new Wr,n.syncPointTree_=n.syncPointTree_.set(t,i));const r=s!=null,o=r?new Ce(s,!0,!1):null,a=en(n.pendingWriteTree_,e._path),l=Gr(i,e,a,r?o.getNode():y.EMPTY_NODE,r);return yd(l)}function Qe(n,e){return Kr(e,n.syncPointTree_,null,en(n.pendingWriteTree_,w()))}function Kr(n,e,t,s){if(S(n.path))return zr(n,e,t,s);{const i=e.get(w());t==null&&i!=null&&(t=ye(i,w()));let r=[];const o=v(n.path),a=n.operationForChild(o),l=e.children.get(o);if(l&&a){const c=t?t.getImmediateChild(o):null,d=Mr(s,o);r=r.concat(Kr(a,l,c,d))}return i&&(r=r.concat(fs(i,n,s,t))),r}}function zr(n,e,t,s){const i=e.get(w());t==null&&i!=null&&(t=ye(i,w()));let r=[];return e.children.inorderTraversal((o,a)=>{const l=t?t.getImmediateChild(o):null,c=Mr(s,o),d=n.operationForChild(o);d&&(r=r.concat(zr(d,a,l,c)))}),i&&(r=r.concat(fs(i,n,s,t))),r}function Yr(n,e){const t=e.query,s=Et(n,t);return{hashFn:()=>(_d(e)||y.EMPTY_NODE).hash(),onComplete:i=>{if(i==="ok")return s?Dd(n,t._path,s):Ld(n,t._path);{const r=Lc(i,t);return jt(n,t,null,r)}}}}function Et(n,e){const t=sn(e);return n.queryToTagMap.get(t)}function sn(n){return n._path.toString()+"$"+n._queryIdentifier}function ms(n,e){return n.tagToQueryMap.get(e)}function gs(n){const e=n.indexOf("$");return g(e!==-1&&e<n.length-1,"Bad queryKey."),{queryId:n.substr(e+1),path:new I(n.substr(0,e))}}function _s(n,e,t){const s=n.syncPointTree_.get(e);g(s,"Missing sync point for query tag that we're tracking");const i=en(n.pendingWriteTree_,e);return fs(s,t,i,null)}function xd(n){return n.fold((e,t,s)=>{if(t&&ve(t))return[tn(t)];{let i=[];return t&&(i=Ur(t)),U(s,(r,o)=>{i=i.concat(o)}),i}})}function ct(n){return n._queryParams.loadsAllData()&&!n._queryParams.isDefault()?new(Rd())(n._repo,n._path):n}function Bd(n,e){for(let t=0;t<e.length;++t){const s=e[t];if(!s._queryParams.loadsAllData()){const i=sn(s),r=n.queryToTagMap.get(i);n.queryToTagMap.delete(i),n.tagToQueryMap.delete(r)}}}function Fd(){return Od++}function Wd(n,e,t){const s=e._path,i=Et(n,e),r=Yr(n,t),o=n.listenProvider_.startListening(ct(e),i,r.hashFn,r.onComplete),a=n.syncPointTree_.subtree(s);if(i)g(!ve(a.value),"If we're adding a query, it shouldn't be shadowed");else{const l=a.fold((c,d,u)=>{if(!S(c)&&d&&ve(d))return[tn(d).query];{let h=[];return d&&(h=h.concat(Ur(d).map(p=>p.query))),U(u,(p,m)=>{h=h.concat(m)}),h}});for(let c=0;c<l.length;++c){const d=l[c];n.listenProvider_.stopListening(ct(d),Et(n,d))}}return o}class ys{constructor(e){this.node_=e}getImmediateChild(e){const t=this.node_.getImmediateChild(e);return new ys(t)}node(){return this.node_}}class Es{constructor(e,t){this.syncTree_=e,this.path_=t}getImmediateChild(e){const t=P(this.path_,e);return new Es(this.syncTree_,t)}node(){return nn(this.syncTree_,this.path_)}}const Gd=function(n){return n=n||{},n.timestamp=n.timestamp||new Date().getTime(),n},Ci=function(n,e,t){if(!n||typeof n!="object")return n;if(g(".sv"in n,"Unexpected leaf node or priority contents"),typeof n[".sv"]=="string")return Ud(n[".sv"],e,t);if(typeof n[".sv"]=="object")return Hd(n[".sv"],e);g(!1,"Unexpected server value: "+JSON.stringify(n,null,2))},Ud=function(n,e,t){if(n==="timestamp")return t.timestamp;g(!1,"Unexpected server value: "+n)},Hd=function(n,e,t){n.hasOwnProperty("increment")||g(!1,"Unexpected server value: "+JSON.stringify(n,null,2));const s=n.increment;typeof s!="number"&&g(!1,"Unexpected increment value: "+s);const i=e.node();if(g(i!==null&&typeof i<"u","Expected ChildrenNode.EMPTY_NODE for nulls"),!i.isLeafNode())return s;const o=i.getValue();return typeof o!="number"?s:o+s},jr=function(n,e,t,s){return vs(e,new Es(t,n),s)},Cs=function(n,e,t){return vs(n,new ys(e),t)};function vs(n,e,t){const s=n.getPriority().val(),i=Ci(s,e.getImmediateChild(".priority"),t);let r;if(n.isLeafNode()){const o=n,a=Ci(o.getValue(),e,t);return a!==o.getValue()||i!==o.getPriority().val()?new F(a,M(i)):n}else{const o=n;return r=o,i!==o.getPriority().val()&&(r=r.updatePriority(new F(i))),o.forEachChild(D,(a,l)=>{const c=vs(l,e.getImmediateChild(a),t);c!==l&&(r=r.updateImmediateChild(a,c))}),r}}class Ss{constructor(e="",t=null,s={children:{},childCount:0}){this.name=e,this.parent=t,this.node=s}}function rn(n,e){let t=e instanceof I?e:new I(e),s=n,i=v(t);for(;i!==null;){const r=Ne(s.node.children,i)||{children:{},childCount:0};s=new Ss(i,s,r),t=O(t),i=v(t)}return s}function De(n){return n.node.value}function bs(n,e){n.node.value=e,zn(n)}function qr(n){return n.node.childCount>0}function $d(n){return De(n)===void 0&&!qr(n)}function on(n,e){U(n.node.children,(t,s)=>{e(new Ss(t,n,s))})}function Qr(n,e,t,s){t&&e(n),on(n,i=>{Qr(i,e,!0)})}function Vd(n,e,t){let s=n.parent;for(;s!==null;){if(e(s))return!0;s=s.parent}return!1}function It(n){return new I(n.parent===null?n.name:It(n.parent)+"/"+n.name)}function zn(n){n.parent!==null&&Kd(n.parent,n.name,n)}function Kd(n,e,t){const s=$d(t),i=ie(n.node.children,e);s&&i?(delete n.node.children[e],n.node.childCount--,zn(n)):!s&&!i&&(n.node.children[e]=t.node,n.node.childCount++,zn(n))}const zd=/[\[\].#$\/\u0000-\u001F\u007F]/,Yd=/[\[\].#$\u0000-\u001F\u007F]/,bn=10*1024*1024,ws=function(n){return typeof n=="string"&&n.length!==0&&!zd.test(n)},Xr=function(n){return typeof n=="string"&&n.length!==0&&!Yd.test(n)},jd=function(n){return n&&(n=n.replace(/^\/*\.info(\/|$)/,"/")),Xr(n)},Is=function(n){return n===null||typeof n=="string"||typeof n=="number"&&!Xt(n)||n&&typeof n=="object"&&ie(n,".sv")},qt=function(n,e,t,s){s&&e===void 0||Tt(We(n,"value"),e,t)},Tt=function(n,e,t){const s=t instanceof I?new uh(t,n):t;if(e===void 0)throw new Error(n+"contains undefined "+we(s));if(typeof e=="function")throw new Error(n+"contains a function "+we(s)+" with contents = "+e.toString());if(Xt(e))throw new Error(n+"contains "+e.toString()+" "+we(s));if(typeof e=="string"&&e.length>bn/3&&Qt(e)>bn)throw new Error(n+"contains a string greater than "+bn+" utf8 bytes "+we(s)+" ('"+e.substring(0,50)+"...')");if(e&&typeof e=="object"){let i=!1,r=!1;if(U(e,(o,a)=>{if(o===".value")i=!0;else if(o!==".priority"&&o!==".sv"&&(r=!0,!ws(o)))throw new Error(n+" contains an invalid key ("+o+") "+we(s)+`.  Keys must be non-empty strings and can't contain ".", "#", "$", "/", "[", or "]"`);fh(s,o),Tt(n,a,s),ph(s)}),i&&r)throw new Error(n+' contains ".value" child '+we(s)+" in addition to actual children.")}},qd=function(n,e){let t,s;for(t=0;t<e.length;t++){s=e[t];const r=pt(s);for(let o=0;o<r.length;o++)if(!(r[o]===".priority"&&o===r.length-1)){if(!ws(r[o]))throw new Error(n+"contains an invalid key ("+r[o]+") in path "+s.toString()+`. Keys must be non-empty strings and can't contain ".", "#", "$", "/", "[", or "]"`)}}e.sort(dh);let i=null;for(t=0;t<e.length;t++){if(s=e[t],i!==null&&Z(i,s))throw new Error(n+"contains a path "+i.toString()+" that is ancestor of another path "+s.toString());i=s}},Jr=function(n,e,t,s){const i=We(n,"values");if(!(e&&typeof e=="object")||Array.isArray(e))throw new Error(i+" must be an object containing the children to replace.");const r=[];U(e,(o,a)=>{const l=new I(o);if(Tt(i,a,P(t,l)),ts(l)===".priority"&&!Is(a))throw new Error(i+"contains an invalid value for '"+l.toString()+"', which must be a valid Firebase priority (a string, finite number, server value, or null).");r.push(l)}),qd(i,r)},Qd=function(n,e,t){if(Xt(e))throw new Error(We(n,"priority")+"is "+e.toString()+", but must be a valid Firebase priority (a string, finite number, server value, or null).");if(!Is(e))throw new Error(We(n,"priority")+"must be a valid Firebase priority (a string, finite number, server value, or null).")},Zr=function(n,e,t,s){if(!Xr(t))throw new Error(We(n,e)+'was an invalid path = "'+t+`". Paths must be non-empty strings and can't contain ".", "#", "$", "[", or "]"`)},Xd=function(n,e,t,s){t&&(t=t.replace(/^\/*\.info(\/|$)/,"/")),Zr(n,e,t)},Te=function(n,e){if(v(e)===".info")throw new Error(n+" failed = Can't modify data under /.info/")},Jd=function(n,e){const t=e.path.toString();if(typeof e.repoInfo.host!="string"||e.repoInfo.host.length===0||!ws(e.repoInfo.namespace)&&e.repoInfo.host.split(":")[0]!=="localhost"||t.length!==0&&!jd(t))throw new Error(We(n,"url")+`must be a valid firebase URL and the path can't contain ".", "#", "$", "[", or "]".`)};class Zd{constructor(){this.eventLists_=[],this.recursionDepth_=0}}function an(n,e){let t=null;for(let s=0;s<e.length;s++){const i=e[s],r=i.getPath();t!==null&&!ns(r,t.path)&&(n.eventLists_.push(t),t=null),t===null&&(t={events:[],path:r}),t.events.push(i)}t&&n.eventLists_.push(t)}function eo(n,e,t){an(n,t),to(n,s=>ns(s,e))}function q(n,e,t){an(n,t),to(n,s=>Z(s,e)||Z(e,s))}function to(n,e){n.recursionDepth_++;let t=!0;for(let s=0;s<n.eventLists_.length;s++){const i=n.eventLists_[s];if(i){const r=i.path;e(r)?(eu(n.eventLists_[s]),n.eventLists_[s]=null):t=!1}}t&&(n.eventLists_=[]),n.recursionDepth_--}function eu(n){for(let e=0;e<n.events.length;e++){const t=n.events[e];if(t!==null){n.events[e]=null;const s=t.getEventRunner();rt&&G("event: "+t.toString()),je(s)}}}const tu="repo_interrupt",nu=25;class su{constructor(e,t,s,i){this.repoInfo_=e,this.forceRestClient_=t,this.authTokenProvider_=s,this.appCheckProvider_=i,this.dataUpdateCount=0,this.statsListener_=null,this.eventQueue_=new Zd,this.nextWriteId_=1,this.interceptServerDataCallback_=null,this.onDisconnect_=Gt(),this.transactionQueueTree_=new Ss,this.persistentConnection_=null,this.key=this.repoInfo_.toURLString()}toString(){return(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host}}function iu(n,e,t){if(n.stats_=Zn(n.repoInfo_),n.forceRestClient_||xc())n.server_=new Wt(n.repoInfo_,(s,i,r,o)=>{vi(n,s,i,r,o)},n.authTokenProvider_,n.appCheckProvider_),setTimeout(()=>Si(n,!0),0);else{if(typeof t<"u"&&t!==null){if(typeof t!="object")throw new Error("Only objects are supported for option databaseAuthVariableOverride");try{B(t)}catch(s){throw new Error("Invalid authOverride provided: "+s)}}n.persistentConnection_=new le(n.repoInfo_,e,(s,i,r,o)=>{vi(n,s,i,r,o)},s=>{Si(n,s)},s=>{ru(n,s)},n.authTokenProvider_,n.appCheckProvider_,t),n.server_=n.persistentConnection_}n.authTokenProvider_.addTokenChangeListener(s=>{n.server_.refreshAuthToken(s)}),n.appCheckProvider_.addTokenChangeListener(s=>{n.server_.refreshAppCheckToken(s.token)}),n.statsReporter_=Uc(n.repoInfo_,()=>new Gh(n.stats_,n.server_)),n.infoData_=new Ph,n.infoSyncTree_=new Ei({startListening:(s,i,r,o)=>{let a=[];const l=n.infoData_.getNode(s._path);return l.isEmpty()||(a=wt(n.infoSyncTree_,s._path,l),setTimeout(()=>{o("ok")},0)),a},stopListening:()=>{}}),Ts(n,"connected",!1),n.serverSyncTree_=new Ei({startListening:(s,i,r,o)=>(n.server_.listen(s,r,i,(a,l)=>{const c=o(a,l);q(n.eventQueue_,s._path,c)}),[]),stopListening:(s,i)=>{n.server_.unlisten(s,i)}})}function no(n){const t=n.infoData_.getNode(new I(".info/serverTimeOffset")).val()||0;return new Date().getTime()+t}function Nt(n){return Gd({timestamp:no(n)})}function vi(n,e,t,s,i){n.dataUpdateCount++;const r=new I(e);t=n.interceptServerDataCallback_?n.interceptServerDataCallback_(e,t):t;let o=[];if(i)if(s){const l=Lt(t,c=>M(c));o=Md(n.serverSyncTree_,r,l,i)}else{const l=M(t);o=Vr(n.serverSyncTree_,r,l,i)}else if(s){const l=Lt(t,c=>M(c));o=kd(n.serverSyncTree_,r,l)}else{const l=M(t);o=wt(n.serverSyncTree_,r,l)}let a=r;o.length>0&&(a=Ve(n,r)),q(n.eventQueue_,a,o)}function Si(n,e){Ts(n,"connected",e),e===!1&&cu(n)}function ru(n,e){U(e,(t,s)=>{Ts(n,t,s)})}function Ts(n,e,t){const s=new I("/.info/"+e),i=M(t);n.infoData_.updateSnapshot(s,i);const r=wt(n.infoSyncTree_,s,i);q(n.eventQueue_,s,r)}function ln(n){return n.nextWriteId_++}function ou(n,e,t){const s=Pd(n.serverSyncTree_,e);return s!=null?Promise.resolve(s):n.server_.get(e).then(i=>{const r=M(i).withIndex(e._queryParams.getIndex());Kn(n.serverSyncTree_,e,t,!0);let o;if(e._queryParams.loadsAllData())o=wt(n.serverSyncTree_,e._path,r);else{const a=Et(n.serverSyncTree_,e);o=Vr(n.serverSyncTree_,e._path,r,a)}return q(n.eventQueue_,e._path,o),jt(n.serverSyncTree_,e,t,null,!0),r},i=>(Xe(n,"get for query "+B(e)+" failed: "+i),Promise.reject(new Error(i))))}function au(n,e,t,s,i){Xe(n,"set",{path:e.toString(),value:t,priority:s});const r=Nt(n),o=M(t,s),a=nn(n.serverSyncTree_,e),l=Cs(o,a,r),c=ln(n),d=ps(n.serverSyncTree_,e,l,c,!0);an(n.eventQueue_,d),n.server_.put(e.toString(),o.val(!0),(h,p)=>{const m=h==="ok";m||z("set at "+e+" failed: "+h);const _=pe(n.serverSyncTree_,c,!m);q(n.eventQueue_,e,_),Se(n,i,h,p)});const u=Rs(n,e);Ve(n,u),q(n.eventQueue_,u,[])}function lu(n,e,t,s){Xe(n,"update",{path:e.toString(),value:t});let i=!0;const r=Nt(n),o={};if(U(t,(a,l)=>{i=!1,o[a]=jr(P(e,a),M(l),n.serverSyncTree_,r)}),i)G("update() called with empty data.  Don't do anything."),Se(n,s,"ok",void 0);else{const a=ln(n),l=Ad(n.serverSyncTree_,e,o,a);an(n.eventQueue_,l),n.server_.merge(e.toString(),t,(c,d)=>{const u=c==="ok";u||z("update at "+e+" failed: "+c);const h=pe(n.serverSyncTree_,a,!u),p=h.length>0?Ve(n,e):e;q(n.eventQueue_,p,h),Se(n,s,c,d)}),U(t,c=>{const d=Rs(n,P(e,c));Ve(n,d)}),q(n.eventQueue_,e,[])}}function cu(n){Xe(n,"onDisconnectEvents");const e=Nt(n),t=Gt();Wn(n.onDisconnect_,w(),(i,r)=>{const o=jr(i,r,n.serverSyncTree_,e);qe(t,i,o)});let s=[];Wn(t,w(),(i,r)=>{s=s.concat(wt(n.serverSyncTree_,i,r));const o=Rs(n,i);Ve(n,o)}),n.onDisconnect_=Gt(),q(n.eventQueue_,w(),s)}function hu(n,e,t){n.server_.onDisconnectCancel(e.toString(),(s,i)=>{s==="ok"&&Fn(n.onDisconnect_,e),Se(n,t,s,i)})}function bi(n,e,t,s){const i=M(t);n.server_.onDisconnectPut(e.toString(),i.val(!0),(r,o)=>{r==="ok"&&qe(n.onDisconnect_,e,i),Se(n,s,r,o)})}function du(n,e,t,s,i){const r=M(t,s);n.server_.onDisconnectPut(e.toString(),r.val(!0),(o,a)=>{o==="ok"&&qe(n.onDisconnect_,e,r),Se(n,i,o,a)})}function uu(n,e,t,s){if(On(t)){G("onDisconnect().update() called with empty data.  Don't do anything."),Se(n,s,"ok",void 0);return}n.server_.onDisconnectMerge(e.toString(),t,(i,r)=>{i==="ok"&&U(t,(o,a)=>{const l=M(a);qe(n.onDisconnect_,P(e,o),l)}),Se(n,s,i,r)})}function fu(n,e,t){let s;v(e._path)===".info"?s=Kn(n.infoSyncTree_,e,t):s=Kn(n.serverSyncTree_,e,t),eo(n.eventQueue_,e._path,s)}function pu(n,e,t){let s;v(e._path)===".info"?s=jt(n.infoSyncTree_,e,t):s=jt(n.serverSyncTree_,e,t),eo(n.eventQueue_,e._path,s)}function mu(n){n.persistentConnection_&&n.persistentConnection_.interrupt(tu)}function Xe(n,...e){let t="";n.persistentConnection_&&(t=n.persistentConnection_.id+":"),G(t,...e)}function Se(n,e,t,s){e&&je(()=>{if(t==="ok")e(null);else{const i=(t||"error").toUpperCase();let r=i;s&&(r+=": "+s);const o=new Error(r);o.code=i,e(o)}})}function gu(n,e,t,s,i,r){Xe(n,"transaction on "+e);const o={path:e,update:t,onComplete:s,status:null,order:er(),applyLocally:r,retryCount:0,unwatcher:i,abortReason:null,currentWriteId:null,currentInputSnapshot:null,currentOutputSnapshotRaw:null,currentOutputSnapshotResolved:null},a=Ns(n,e,void 0);o.currentInputSnapshot=a;const l=o.update(a.val());if(l===void 0)o.unwatcher(),o.currentOutputSnapshotRaw=null,o.currentOutputSnapshotResolved=null,o.onComplete&&o.onComplete(null,!1,o.currentInputSnapshot);else{Tt("transaction failed: Data returned ",l,o.path),o.status=0;const c=rn(n.transactionQueueTree_,e),d=De(c)||[];d.push(o),bs(c,d);let u;typeof l=="object"&&l!==null&&ie(l,".priority")?(u=Ne(l,".priority"),g(Is(u),"Invalid priority returned by transaction. Priority must be a valid string, finite number, server value, or null.")):u=(nn(n.serverSyncTree_,e)||y.EMPTY_NODE).getPriority().val();const h=Nt(n),p=M(l,u),m=Cs(p,a,h);o.currentOutputSnapshotRaw=p,o.currentOutputSnapshotResolved=m,o.currentWriteId=ln(n);const _=ps(n.serverSyncTree_,e,m,o.currentWriteId,o.applyLocally);q(n.eventQueue_,e,_),cn(n,n.transactionQueueTree_)}}function Ns(n,e,t){return nn(n.serverSyncTree_,e,t)||y.EMPTY_NODE}function cn(n,e=n.transactionQueueTree_){if(e||hn(n,e),De(e)){const t=io(n,e);g(t.length>0,"Sending zero length transaction queue"),t.every(i=>i.status===0)&&_u(n,It(e),t)}else qr(e)&&on(e,t=>{cn(n,t)})}function _u(n,e,t){const s=t.map(c=>c.currentWriteId),i=Ns(n,e,s);let r=i;const o=i.hash();for(let c=0;c<t.length;c++){const d=t[c];g(d.status===0,"tryToSendTransactionQueue_: items in queue should all be run."),d.status=1,d.retryCount++;const u=K(e,d.path);r=r.updateChild(u,d.currentOutputSnapshotRaw)}const a=r.val(!0),l=e;n.server_.put(l.toString(),a,c=>{Xe(n,"transaction put response",{path:l.toString(),status:c});let d=[];if(c==="ok"){const u=[];for(let h=0;h<t.length;h++)t[h].status=2,d=d.concat(pe(n.serverSyncTree_,t[h].currentWriteId)),t[h].onComplete&&u.push(()=>t[h].onComplete(null,!0,t[h].currentOutputSnapshotResolved)),t[h].unwatcher();hn(n,rn(n.transactionQueueTree_,e)),cn(n,n.transactionQueueTree_),q(n.eventQueue_,e,d);for(let h=0;h<u.length;h++)je(u[h])}else{if(c==="datastale")for(let u=0;u<t.length;u++)t[u].status===3?t[u].status=4:t[u].status=0;else{z("transaction at "+l.toString()+" failed: "+c);for(let u=0;u<t.length;u++)t[u].status=4,t[u].abortReason=c}Ve(n,e)}},o)}function Ve(n,e){const t=so(n,e),s=It(t),i=io(n,t);return yu(n,i,s),s}function yu(n,e,t){if(e.length===0)return;const s=[];let i=[];const o=e.filter(a=>a.status===0).map(a=>a.currentWriteId);for(let a=0;a<e.length;a++){const l=e[a],c=K(t,l.path);let d=!1,u;if(g(c!==null,"rerunTransactionsUnderNode_: relativePath should not be null."),l.status===4)d=!0,u=l.abortReason,i=i.concat(pe(n.serverSyncTree_,l.currentWriteId,!0));else if(l.status===0)if(l.retryCount>=nu)d=!0,u="maxretry",i=i.concat(pe(n.serverSyncTree_,l.currentWriteId,!0));else{const h=Ns(n,l.path,o);l.currentInputSnapshot=h;const p=e[a].update(h.val());if(p!==void 0){Tt("transaction failed: Data returned ",p,l.path);let m=M(p);typeof p=="object"&&p!=null&&ie(p,".priority")||(m=m.updatePriority(h.getPriority()));const E=l.currentWriteId,R=Nt(n),T=Cs(m,h,R);l.currentOutputSnapshotRaw=m,l.currentOutputSnapshotResolved=T,l.currentWriteId=ln(n),o.splice(o.indexOf(E),1),i=i.concat(ps(n.serverSyncTree_,l.path,T,l.currentWriteId,l.applyLocally)),i=i.concat(pe(n.serverSyncTree_,E,!0))}else d=!0,u="nodata",i=i.concat(pe(n.serverSyncTree_,l.currentWriteId,!0))}q(n.eventQueue_,t,i),i=[],d&&(e[a].status=2,(function(h){setTimeout(h,Math.floor(0))})(e[a].unwatcher),e[a].onComplete&&(u==="nodata"?s.push(()=>e[a].onComplete(null,!1,e[a].currentInputSnapshot)):s.push(()=>e[a].onComplete(new Error(u),!1,null))))}hn(n,n.transactionQueueTree_);for(let a=0;a<s.length;a++)je(s[a]);cn(n,n.transactionQueueTree_)}function so(n,e){let t,s=n.transactionQueueTree_;for(t=v(e);t!==null&&De(s)===void 0;)s=rn(s,t),e=O(e),t=v(e);return s}function io(n,e){const t=[];return ro(n,e,t),t.sort((s,i)=>s.order-i.order),t}function ro(n,e,t){const s=De(e);if(s)for(let i=0;i<s.length;i++)t.push(s[i]);on(e,i=>{ro(n,i,t)})}function hn(n,e){const t=De(e);if(t){let s=0;for(let i=0;i<t.length;i++)t[i].status!==2&&(t[s]=t[i],s++);t.length=s,bs(e,t.length>0?t:void 0)}on(e,s=>{hn(n,s)})}function Rs(n,e){const t=It(so(n,e)),s=rn(n.transactionQueueTree_,e);return Vd(s,i=>{wn(n,i)}),wn(n,s),Qr(s,i=>{wn(n,i)}),t}function wn(n,e){const t=De(e);if(t){const s=[];let i=[],r=-1;for(let o=0;o<t.length;o++)t[o].status===3||(t[o].status===1?(g(r===o-1,"All SENT items should be at beginning of queue."),r=o,t[o].status=3,t[o].abortReason="set"):(g(t[o].status===0,"Unexpected transaction status in abort"),t[o].unwatcher(),i=i.concat(pe(n.serverSyncTree_,t[o].currentWriteId,!0)),t[o].onComplete&&s.push(t[o].onComplete.bind(null,new Error("set"),!1,null))));r===-1?bs(e,void 0):t.length=r+1,q(n.eventQueue_,It(e),i);for(let o=0;o<s.length;o++)je(s[o])}}function Eu(n){let e="";const t=n.split("/");for(let s=0;s<t.length;s++)if(t[s].length>0){let i=t[s];try{i=decodeURIComponent(i.replace(/\+/g," "))}catch{}e+="/"+i}return e}function Cu(n){const e={};n.charAt(0)==="?"&&(n=n.substring(1));for(const t of n.split("&")){if(t.length===0)continue;const s=t.split("=");s.length===2?e[decodeURIComponent(s[0])]=decodeURIComponent(s[1]):z(`Invalid query segment '${t}' in query '${n}'`)}return e}const wi=function(n,e){const t=vu(n),s=t.namespace;t.domain==="firebase.com"&&he(t.host+" is no longer supported. Please use <YOUR FIREBASE>.firebaseio.com instead"),(!s||s==="undefined")&&t.domain!=="localhost"&&he("Cannot parse Firebase url. Please use https://<YOUR FIREBASE>.firebaseio.com"),t.secure||Nc();const i=t.scheme==="ws"||t.scheme==="wss";return{repoInfo:new fr(t.host,t.secure,s,i,e,"",s!==t.subdomain),path:new I(t.pathString)}},vu=function(n){let e="",t="",s="",i="",r="",o=!0,a="https",l=443;if(typeof n=="string"){let c=n.indexOf("//");c>=0&&(a=n.substring(0,c-1),n=n.substring(c+2));let d=n.indexOf("/");d===-1&&(d=n.length);let u=n.indexOf("?");u===-1&&(u=n.length),e=n.substring(0,Math.min(d,u)),d<u&&(i=Eu(n.substring(d,u)));const h=Cu(n.substring(Math.min(n.length,u)));c=e.indexOf(":"),c>=0?(o=a==="https"||a==="wss",l=parseInt(e.substring(c+1),10)):c=e.length;const p=e.slice(0,c);if(p.toLowerCase()==="localhost")t="localhost";else if(p.split(".").length<=2)t=p;else{const m=e.indexOf(".");s=e.substring(0,m).toLowerCase(),t=e.substring(m+1),r=s}"ns"in h&&(r=h.ns)}return{host:e,port:l,domain:t,subdomain:s,secure:o,scheme:a,pathString:i,namespace:r}};const Ii="-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz",Su=(function(){let n=0;const e=[];return function(t){const s=t===n;n=t;let i;const r=new Array(8);for(i=7;i>=0;i--)r[i]=Ii.charAt(t%64),t=Math.floor(t/64);g(t===0,"Cannot push at time == 0");let o=r.join("");if(s){for(i=11;i>=0&&e[i]===63;i--)e[i]=0;e[i]++}else for(i=0;i<12;i++)e[i]=Math.floor(Math.random()*64);for(i=0;i<12;i++)o+=Ii.charAt(e[i]);return g(o.length===20,"nextPushId: Length should be 20."),o}})();class bu{constructor(e,t,s,i){this.eventType=e,this.eventRegistration=t,this.snapshot=s,this.prevName=i}getPath(){const e=this.snapshot.ref;return this.eventType==="value"?e._path:e.parent._path}getEventType(){return this.eventType}getEventRunner(){return this.eventRegistration.getEventRunner(this)}toString(){return this.getPath().toString()+":"+this.eventType+":"+B(this.snapshot.exportVal())}}class wu{constructor(e,t,s){this.eventRegistration=e,this.error=t,this.path=s}getPath(){return this.path}getEventType(){return"cancel"}getEventRunner(){return this.eventRegistration.getEventRunner(this)}toString(){return this.path.toString()+":cancel"}}class oo{constructor(e,t){this.snapshotCallback=e,this.cancelCallback=t}onValue(e,t){this.snapshotCallback.call(null,e,t)}onCancel(e){return g(this.hasCancelCallback,"Raising a cancel event on a listener with no cancel callback"),this.cancelCallback.call(null,e)}get hasCancelCallback(){return!!this.cancelCallback}matches(e){return this.snapshotCallback===e.snapshotCallback||this.snapshotCallback.userCallback!==void 0&&this.snapshotCallback.userCallback===e.snapshotCallback.userCallback&&this.snapshotCallback.context===e.snapshotCallback.context}}class Iu{constructor(e,t){this._repo=e,this._path=t}cancel(){const e=new ee;return hu(this._repo,this._path,e.wrapCallback(()=>{})),e.promise}remove(){Te("OnDisconnect.remove",this._path);const e=new ee;return bi(this._repo,this._path,null,e.wrapCallback(()=>{})),e.promise}set(e){Te("OnDisconnect.set",this._path),qt("OnDisconnect.set",e,this._path,!1);const t=new ee;return bi(this._repo,this._path,e,t.wrapCallback(()=>{})),t.promise}setWithPriority(e,t){Te("OnDisconnect.setWithPriority",this._path),qt("OnDisconnect.setWithPriority",e,this._path,!1),Qd("OnDisconnect.setWithPriority",t);const s=new ee;return du(this._repo,this._path,e,t,s.wrapCallback(()=>{})),s.promise}update(e){Te("OnDisconnect.update",this._path),Jr("OnDisconnect.update",e,this._path);const t=new ee;return uu(this._repo,this._path,e,t.wrapCallback(()=>{})),t.promise}}class Os{constructor(e,t,s,i){this._repo=e,this._path=t,this._queryParams=s,this._orderByCalled=i}get key(){return S(this._path)?null:ts(this._path)}get ref(){return new re(this._repo,this._path)}get _queryIdentifier(){const e=ci(this._queryParams),t=Xn(e);return t==="{}"?"default":t}get _queryObject(){return ci(this._queryParams)}isEqual(e){if(e=ue(e),!(e instanceof Os))return!1;const t=this._repo===e._repo,s=ns(this._path,e._path),i=this._queryIdentifier===e._queryIdentifier;return t&&s&&i}toJSON(){return this.toString()}toString(){return this._repo.toString()+hh(this._path)}}class re extends Os{constructor(e,t){super(e,t,new os,!1)}get parent(){const e=Sr(this._path);return e===null?null:new re(this._repo,e)}get root(){let e=this;for(;e.parent!==null;)e=e.parent;return e}}class Ke{constructor(e,t,s){this._node=e,this.ref=t,this._index=s}get priority(){return this._node.getPriority().val()}get key(){return this.ref.key}get size(){return this._node.numChildren()}child(e){const t=new I(e),s=ze(this.ref,e);return new Ke(this._node.getChild(t),s,D)}exists(){return!this._node.isEmpty()}exportVal(){return this._node.val(!0)}forEach(e){return this._node.isLeafNode()?!1:!!this._node.forEachChild(this._index,(s,i)=>e(new Ke(i,ze(this.ref,s),D)))}hasChild(e){const t=new I(e);return!this._node.getChild(t).isEmpty()}hasChildren(){return this._node.isLeafNode()?!1:!this._node.isEmpty()}toJSON(){return this.exportVal()}val(){return this._node.val()}}function $(n,e){return n=ue(n),n._checkNotDeleted("ref"),e!==void 0?ze(n._root,e):n._root}function ze(n,e){return n=ue(n),v(n._path)===null?Xd("child","path",e):Zr("child","path",e),new re(n._repo,P(n._path,e))}function Ti(n){return n=ue(n),new Iu(n._repo,n._path)}function Tu(n,e){n=ue(n),Te("push",n._path),qt("push",e,n._path,!0);const t=no(n._repo),s=Su(t),i=ze(n,s),r=ze(n,s);let o;return o=Promise.resolve(r),i.then=o.then.bind(o),i.catch=o.then.bind(o,void 0),i}function In(n,e){n=ue(n),Te("set",n._path),qt("set",e,n._path,!1);const t=new ee;return au(n._repo,n._path,e,null,t.wrapCallback(()=>{})),t.promise}function oe(n,e){Jr("update",e,n._path);const t=new ee;return lu(n._repo,n._path,e,t.wrapCallback(()=>{})),t.promise}function Tn(n){n=ue(n);const e=new oo(()=>{}),t=new dn(e);return ou(n._repo,n,t).then(s=>new Ke(s,new re(n._repo,n._path),n._queryParams.getIndex()))}class dn{constructor(e){this.callbackContext=e}respondsTo(e){return e==="value"}createEvent(e,t){const s=t._queryParams.getIndex();return new bu("value",this,new Ke(e.snapshotNode,new re(t._repo,t._path),s))}getEventRunner(e){return e.getEventType()==="cancel"?()=>this.callbackContext.onCancel(e.error):()=>this.callbackContext.onValue(e.snapshot,null)}createCancelEvent(e,t){return this.callbackContext.hasCancelCallback?new wu(this,e,t):null}matches(e){return e instanceof dn?!e.callbackContext||!this.callbackContext?!0:e.callbackContext.matches(this.callbackContext):!1}hasAnyCallback(){return this.callbackContext!==null}}function Nu(n,e,t,s,i){const r=new oo(t,void 0),o=new dn(r);return fu(n._repo,n,o),()=>pu(n._repo,n,o)}function ao(n,e,t,s){return Nu(n,"value",e)}Sd(re);Nd(re);const Ru="FIREBASE_DATABASE_EMULATOR_HOST",Yn={};let Ou=!1;function Au(n,e,t,s){const i=e.lastIndexOf(":"),r=e.substring(0,i),o=qn(r);n.repoInfo_=new fr(e,o,n.repoInfo_.namespace,n.repoInfo_.webSocketOnly,n.repoInfo_.nodeAdmin,n.repoInfo_.persistenceKey,n.repoInfo_.includeNamespaceInQueryParams,!0,t),s&&(n.authTokenProvider_=s)}function ku(n,e,t,s,i){let r=s||n.options.databaseURL;r===void 0&&(n.options.projectId||he("Can't determine Firebase Database URL. Be sure to include  a Project ID when calling firebase.initializeApp()."),G("Using default host for project ",n.options.projectId),r=`${n.options.projectId}-default-rtdb.firebaseio.com`);let o=wi(r,i),a=o.repoInfo,l;typeof process<"u"&&Ks&&(l=Ks[Ru]),l?(r=`http://${l}?ns=${a.namespace}`,o=wi(r,i),a=o.repoInfo):o.repoInfo.secure;const c=new Fc(n.name,n.options,e);Jd("Invalid Firebase Database URL",o),S(o.path)||he("Database URL must point to the root of a Firebase Database (not including a child path).");const d=Du(a,n,c,new Bc(n,t));return new Mu(d,n)}function Lu(n,e){const t=Yn[e];(!t||t[n.key]!==n)&&he(`Database ${e}(${n.repoInfo_}) has already been deleted.`),mu(n),delete t[n.key]}function Du(n,e,t,s){let i=Yn[e.name];i||(i={},Yn[e.name]=i);let r=i[n.toURLString()];return r&&he("Database initialized multiple times. Please make sure the format of the database URL matches with each database() call."),r=new su(n,Ou,t,s),i[n.toURLString()]=r,r}class Mu{constructor(e,t){this._repoInternal=e,this.app=t,this.type="database",this._instanceStarted=!1}get _repo(){return this._instanceStarted||(iu(this._repoInternal,this.app.options.appId,this.app.options.databaseAuthVariableOverride),this._instanceStarted=!0),this._repoInternal}get _root(){return this._rootInternal||(this._rootInternal=new re(this._repo,w())),this._rootInternal}_delete(){return this._rootInternal!==null&&(Lu(this._repo,this.app.name),this._repoInternal=null,this._rootInternal=null),Promise.resolve()}_checkNotDeleted(e){this._rootInternal===null&&he("Cannot call "+e+" on a deleted database.")}}function Pu(n=cc(),e){const t=ic(n,"database").getImmediate({identifier:e});if(!t._instanceStarted){const s=$a("database");s&&xu(t,...s)}return t}function xu(n,e,t,s={}){n=ue(n),n._checkNotDeleted("useEmulator");const i=`${e}:${t}`,r=n._repoInternal;if(n._instanceStarted){if(i===n._repoInternal.repoInfo_.host&&Dt(s,r.repoInfo_.emulatorOptions))return;he("connectDatabaseEmulator() cannot initialize or alter the emulator configuration after the database instance has started.")}let o;if(r.repoInfo_.nodeAdmin)s.mockUserToken&&he('mockUserToken is not supported by the Admin SDK. For client access with mock users, please use the "firebase" package instead of "firebase-admin".'),o=new At(At.OWNER);else if(s.mockUserToken){const a=typeof s.mockUserToken=="string"?s.mockUserToken:Ka(s.mockUserToken,n.app.options.projectId);o=new At(a)}qn(e)&&(Va(e),ja("Database",!0)),Au(r,i,s,o)}function Bu(n){Sc(lc),Pt(new dt("database",(e,{instanceIdentifier:t})=>{const s=e.getProvider("app").getImmediate(),i=e.getProvider("auth-internal"),r=e.getProvider("app-check-internal");return ku(s,i,r,t)},"PUBLIC").setMultipleInstances(!0)),xe(zs,Ys,n),xe(zs,Ys,"esm2020")}class Fu{constructor(e,t){this.committed=e,this.snapshot=t}toJSON(){return{committed:this.committed,snapshot:this.snapshot.toJSON()}}}function Wu(n,e,t){if(n=ue(n),Te("Reference.transaction",n._path),n.key===".length"||n.key===".keys")throw"Reference.transaction failed: "+n.key+" is a read-only object.";const s=!0,i=new ee,r=(a,l,c)=>{let d=null;a?i.reject(a):(d=new Ke(c,new re(n._repo,n._path),D),i.resolve(new Fu(l,d)))},o=ao(n,()=>{});return gu(n._repo,n._path,e,r,o,s),i.promise}le.prototype.simpleListen=function(n,e){this.sendRequest("q",{p:n},e)};le.prototype.echo=function(n,e){this.sendRequest("echo",{d:n},e)};Bu();const Gu={apiKey:"AIzaSyDhDhpFMVbXOq04J2jZkGrfjeovdTT6U2o",authDomain:"tiny-towns-multiplayer.firebaseapp.com",databaseURL:"https://tiny-towns-multiplayer-default-rtdb.europe-west1.firebasedatabase.app",projectId:"tiny-towns-multiplayer",storageBucket:"tiny-towns-multiplayer.firebasestorage.app",messagingSenderId:"374830147876",appId:"1:374830147876:web:93ffbe5825d8d3af982bb1"},Uu=qi(Gu),V=Pu(Uu);class Hu{gameId=null;playerId;isHost=!1;localGame;masterBuilderId=null;myName="Unknown";currentRound=1;lastNeighborCounts={};myFinishRank=null;onOpaleyeBonus=null;onStateChange=null;onGameStart=null;constructor(e){this.localGame=e,this.playerId="player_"+Math.random().toString(36).substr(2,9)}async createGame(e,t){const s=$(V,"games"),i=Tu(s);this.gameId=i.key,this.isHost=!0,this.myName=e;const r={status:"LOBBY",hostId:this.playerId,deck:t,currentResource:null,masterBuilderIndex:0,roundNumber:1,playerOrder:[this.playerId],players:{[this.playerId]:{name:e,score:0,isReady:!0,placedRound:0,isGameOver:!1,board:this.serializeBoard()}}};return await In(i,r),this.subscribeToGame(),Ti(i).remove(),this.gameId}async joinGame(e,t){const s=$(V,`games/${e}`),i=await Tn(s);if(!i.exists())throw new Error("Game not found");const r=i.val();if(t==="Guest"){const d=r.players||{};let u=1;for(;;){const h=`Guest ${u}`;if(!Object.values(d).some(m=>m.name===h)){t=h;break}u++}}this.gameId=e,this.isHost=!1,this.myName=t;const o=$(V,`games/${e}/players/${this.playerId}`);await In(o,{name:t,score:0,isReady:!0,placedRound:0,isGameOver:!1,board:this.serializeBoard()});const a=$(V,`games/${e}/playerOrder`),c=(await Tn(a)).val()||[];c.includes(this.playerId)||(c.push(this.playerId),await In(a,c)),Ti(o).remove(),this.subscribeToGame()}async startGame(){if(!this.gameId)return;const e=$(V,`games/${this.gameId}`),s=(await Tn(ze(e,"players"))).val()||{},i=Object.keys(s),r=[...nt].sort(()=>Math.random()-.5),o={status:"PLAYING",currentResource:null,roundNumber:1,masterBuilderIndex:0,playerOrder:i};i.forEach(a=>{const l=r.pop(),c=r.pop();l&&c&&(o[`players/${a}/monumentOptions`]=[l.name,c.name],o[`players/${a}/monumentChosen`]=!1)}),await oe(e,o)}async selectMonument(e){if(!this.gameId||!this.playerId)return;const t=$(V,`games/${this.gameId}/players/${this.playerId}`);await oe(t,{activeMonument:e,monumentChosen:!0})}async updateDeck(e){!this.isHost||!this.gameId||await oe($(V,`games/${this.gameId}`),{deck:e})}subscribeToGame(){if(!this.gameId)return;const e=$(V,`games/${this.gameId}`);ao(e,t=>{const s=t.val();if(!s)return;s.status==="PLAYING"&&this.localGame.gameRegistry.length===0&&(this.syncDeck(s.deck),this.onGameStart&&this.onGameStart());const i=s.playerOrder||[],r=Array.isArray(i)?i:Object.values(i);if(r.length>0){const o=(s.masterBuilderIndex||0)%r.length;this.masterBuilderId=r[o]}if(s.currentResource===void 0||s.currentResource===""?this.localGame.currentResource=null:this.localGame.currentResource=s.currentResource,this.currentRound=s.roundNumber||1,s.status==="PLAYING"&&s.players&&s.playerOrder&&(this.checkNeighborsForOpaleye(s.players,s.playerOrder),this.updateNeighborFeastHallStats(s.players,s.playerOrder)),s.players&&s.players[this.playerId]){const o=s.players[this.playerId];if(o.finishRank&&(this.myFinishRank=o.finishRank),o.board&&o.board.metadata){const a=new Map;Object.entries(o.board.metadata).forEach(([l,c])=>{a.set(l,c)}),this.localGame.board.metadata=a}}this.onStateChange&&this.onStateChange(s),this.isHost&&s.status==="PLAYING"&&setTimeout(()=>this.checkTurnComplete(s),10)})}async setGlobalResource(e){if(!this.gameId||this.playerId!==this.masterBuilderId)return;const t={};t[`games/${this.gameId}/currentResource`]=e,await oe($(V),t)}async commitTurn(){if(!this.gameId)return;const e={},t=`games/${this.gameId}/players/${this.playerId}`;e[`${t}/board`]=this.serializeBoard(),e[`${t}/score`]=this.localGame.getScore().total,e[`${t}/placedRound`]=this.currentRound,await oe($(V),e)}async saveBoardOnly(){if(!this.gameId)return;console.log("Saving board state (Turn not finished)...");const e={},t=`games/${this.gameId}/players/${this.playerId}`;e[`${t}/board`]=this.serializeBoard(),e[`${t}/score`]=this.localGame.getScore().total,await oe($(V),e)}async declareGameOver(){if(!this.gameId)return;const e=$(V,`games/${this.gameId}/finishedCount`),s=(await Wu(e,a=>(a||0)+1)).snapshot.val();this.myFinishRank=s;const i={},r=`games/${this.gameId}/players/${this.playerId}`;i[`${r}/isGameOver`]=!0,i[`${r}/placedRound`]=this.currentRound,i[`${r}/finishRank`]=s;const o=this.localGame.getScore(s).total;i[`${r}/score`]=o,await oe($(V),i),this.isHost&&setTimeout(()=>{},10)}async checkTurnComplete(e){if(!e||!e.players)return;const t=Object.values(e.players),s=e.roundNumber||1,i=e.playerOrder||[];if(t.every(h=>h.isGameOver===!0)){e.status!=="FINISHED"&&(console.log("GAME OVER FOR EVERYONE"),await oe($(V,`games/${this.gameId}`),{status:"FINISHED"}));return}const o=e.currentResource!==void 0&&e.currentResource!==null,a=t.every(h=>h.placedRound===s||h.isGameOver===!0),l=(e.masterBuilderIndex||0)%i.length,c=i[l],d=e.players[c]&&e.players[c].isGameOver;let u=!1;if(o&&a?(console.log(`Round ${s} Complete. Rotating.`),u=!0):!o&&d&&(console.log("Current Master Builder is finished. Skipping their turn."),u=!0),u){let h=e.masterBuilderIndex||0,p=h,m=!1;const _=t.filter(R=>!R.isGameOver).length;for(let R=1;R<=i.length;R++){const T=(h+R)%i.length,L=i[T],C=e.players[L];if(C&&!C.isGameOver){if(this.playerHasBuilding(C.board,"FORT IRONWEED")&&_>1){console.log(`Skipping ${C.name} due to Fort Ironweed.`);continue}p=T,m=!0;break}}m||(p=(h+1)%i.length);const E={};E[`games/${this.gameId}/currentResource`]=null,E[`games/${this.gameId}/masterBuilderIndex`]=p,E[`games/${this.gameId}/roundNumber`]=s+1,await oe($(V),E)}}playerHasBuilding(e,t){return!e||!Array.isArray(e)?!1:e.some(s=>s.some(i=>typeof i=="string"&&i.toUpperCase().includes(t.toUpperCase())))}syncDeck(e){e&&(this.localGame.gameRegistry=st.filter(t=>e.includes(t.name)),this.localGame.scanForMatches())}serializeBoard(){const e={};return this.localGame.board.metadata.forEach((t,s)=>{e[s]=t}),{grid:this.localGame.board.getGrid(),metadata:e}}checkNeighborsForOpaleye(e,t){const s=t.indexOf(this.playerId);if(s===-1)return;const i=t.length;if(i<2)return;const r=(s-1+i)%i,o=(s+1)%i;new Set([t[r],t[o]]).forEach(l=>{if(l===this.playerId)return;const c=e[l];if(!c||!c.board)return;const d=this.countBuildings(c.board),u=this.lastNeighborCounts[l];u&&Object.keys(d).forEach(h=>{if((d[h]||0)-(u[h]||0)>0){const m=this.localGame.checkOpaleyeMatch(h);m&&this.onOpaleyeBonus&&(console.log(`[Opaleye] Bonus! Building: ${h} at Watch Coords:`,m),this.onOpaleyeBonus(h,m))}}),this.lastNeighborCounts[l]=d})}countBuildings(e){const t={},s=["WOOD","WHEAT","BRICK","GLASS","STONE","NONE"],i=e&&e.grid?e.grid:e;return Array.isArray(i)&&i.forEach(r=>{Array.isArray(r)&&r.forEach(o=>{typeof o=="string"&&!s.includes(o)&&(t[o]=(t[o]||0)+1)})}),t}updateNeighborFeastHallStats(e,t){const s=t.indexOf(this.playerId);if(s===-1||t.length<2){this.localGame.setRightNeighborFeastHallCount(0);return}const i=(s+1)%t.length,r=t[i],o=e[r];if(o&&o.board){const l=this.countBuildings(o.board)["FEAST HALL"]||0;this.localGame.setRightNeighborFeastHallCount(l)}else this.localGame.setRightNeighborFeastHallCount(0)}}class $u{sounds={};muted=!1;constructor(){const e="/tiny-towns/";this.load("place",`${e}sounds/place.mp3`),this.load("build",`${e}sounds/build.mp3`),this.load("error",`${e}sounds/error.mp3`),this.load("fanfare",`${e}sounds/fanfare.mp3`),this.load("click",`${e}sounds/click.mp3`)}load(e,t){const s=new Audio(t);this.sounds[e]=s}play(e){if(this.muted)return;const t=this.sounds[e];t&&(t.currentTime=0,e==="build"&&(t.volume=.5),t.play().catch(s=>console.warn("Audio play failed:",s)))}toggleMute(){return this.muted=!this.muted,this.muted}}function N(n,e="info",t){const s=document.getElementById("toast-container");if(!s)return;e==="error"&&t&&t.play("error");const i=document.createElement("div");i.className=`toast ${e}`,i.textContent=n,s.appendChild(i),setTimeout(()=>{i.remove()},4e3)}function fe(n){const e=document.getElementById("resource-palette");e&&(n?(e.style.opacity="1",e.style.pointerEvents="auto"):(e.style.opacity="0.5",e.style.pointerEvents="none"))}function Nn(n,e,t,s=[]){const i=document.getElementById("resource-picker-modal"),r=document.getElementById("picker-title"),o=document.getElementById("picker-message"),a=document.getElementById("picker-options");r.textContent=n,o.textContent=e,a.innerHTML="",["WOOD","WHEAT","BRICK","GLASS","STONE"].forEach(c=>{if(s.includes(c))return;const d=document.createElement("div");d.className=`res-btn ${c}`,d.onclick=()=>{i.classList.add("hidden"),t(c)},a.appendChild(d)}),i.classList.remove("hidden")}function Vu(n,e){e.innerHTML="<strong>Players:</strong><br>",Object.values(n).forEach(t=>{const s=document.createElement("div");s.textContent=` ${t.name}`,e.appendChild(s)})}function Ku(n,e){e.innerHTML="",Object.values(n).sort((s,i)=>i.score-s.score).forEach((s,i)=>{const r=document.createElement("li");r.className="leaderboard-row",i===0&&r.classList.add("winner");const o=i+1;r.innerHTML=`
            <div style="display:flex; align-items:center;">
                <div class="rank-badge">${o}</div>
                <div class="player-info">
                    <span class="player-name">${s.name}</span>
                    <span class="player-details">
                        ${s.isGameOver?"Finished":"Playing"} 
                    </span>
                </div>
            </div>
            <div class="final-total">${s.score}</div>
        `,e.appendChild(r)})}function zu(n,e,t,s,i,r,o=[]){s.classList.remove("hidden"),i.innerHTML="";let a=null,l=null;if(o.length>1){const h=o.indexOf(t);if(h!==-1){const p=o.length;a=o[(h-1+p)%p],l=o[(h+1)%p]}}const c=[],d=[];if((o.length>0?o:Object.keys(n)).forEach(h=>{h!==t&&n[h]&&(h===a||h===l?c.push(h):d.push(h))}),c.length>0){const h=document.createElement("div");h.className="opponent-section-title",h.textContent="Your Neighbors",i.appendChild(h),c.forEach(p=>{const m=Ni(p,n[p],e,r,p===a,p===l);i.appendChild(m)})}if(d.length>0){const h=document.createElement("div");h.className="opponent-section-title",h.textContent="Other Towns",h.style.marginTop="15px",i.appendChild(h),d.forEach(p=>{const m=Ni(p,n[p],e,r,!1,!1);i.appendChild(m)})}}function Ni(n,e,t,s,i,r){const o=e.placedRound===t||e.isGameOver,a=o?"done":"thinking",l=n===s,c=document.createElement("div");c.className="opponent-card",l&&(c.style.border="2px solid #ff9800",c.style.background="#fff3e0");const d=document.createElement("div");d.className="opponent-name";const u=l?'<span title="Master Builder" style="font-size:1.2em; margin-right:4px;"></span>':"";let h=i?'<span title="Left Neighbor" style="font-size:1.2em; margin-right:6px;"></span>':"",p=r?'<span title="Right Neighbor" style="font-size:1.2em; margin-left:6px;"></span>':"";d.innerHTML=`
        <div style="display:flex; align-items:center;">
            ${h} ${u} ${e.name} ${p}
        </div>
        <span class="status-dot ${a}" title="${o?"Waiting":"Thinking"}"></span>
    `,c.appendChild(d);const m=document.createElement("div");m.className="mini-board";const _=e.board,E=_&&_.grid?_.grid:_;return E&&Array.isArray(E)&&E.forEach(R=>{R.forEach(T=>{const L=document.createElement("div");if(L.className="mini-cell",T!=="NONE")if(["WOOD","WHEAT","BRICK","GLASS","STONE"].includes(T))L.classList.add(T);else{const C=T.replace(/ /g,"-").replace(/'/g,"").toUpperCase();L.classList.add(C),L.title=T,["COTTAGE","FARM","GRANARY","GREENHOUSE","ORCHARD","WELL","FOUNTAIN","MILLSTONE","SHED","CHAPEL","ABBEY","CLOISTER","TEMPLE","TAVERN","ALMSHOUSE","INN","FEAST-HALL","THEATER","BAKERY","TAILOR","MARKET","FACTORY","BANK","WAREHOUSE","TRADING-POST"].includes(C)||L.classList.add("MONUMENT")}m.appendChild(L)})}),c.appendChild(m),c}function Yu(n,e){n.innerHTML="";const t=document.createElement("div");t.className="setup-grid",e.forEach(s=>{const i=document.createElement("div");i.className="setup-group";const r=document.createElement("label");r.className="setup-label",r.textContent=s.label,i.appendChild(r);const o=document.createElement("select");o.className=`setup-select ${s.id}`,o.dataset.category=s.id;const a=document.createElement("option");a.value="RANDOM",a.textContent="Random",o.appendChild(a),s.options.forEach(l=>{const c=document.createElement("option");c.value=l.name,c.textContent=l.name,o.appendChild(c)}),i.appendChild(o),t.appendChild(i)}),n.appendChild(t)}function ju(n,e){const t=document.getElementById("resource-picker-modal"),s=document.getElementById("picker-title"),i=document.getElementById("picker-message"),r=document.getElementById("picker-options");s.textContent="Choose Your Monument",i.textContent="You have been granted two options. Choose one to construct in your town.",r.innerHTML="",r.style.display="flex",r.style.gap="20px",r.style.justifyContent="center",r.style.flexWrap="wrap",n.forEach(o=>{const a=document.createElement("div");a.className="monument-card-choice",a.style.border="2px solid #9c27b0",a.style.borderRadius="8px",a.style.padding="15px",a.style.cursor="pointer",a.style.background="white",a.style.width="180px",a.style.textAlign="center",a.style.transition="transform 0.2s",a.onmouseenter=()=>a.style.transform="scale(1.05)",a.onmouseleave=()=>a.style.transform="scale(1)",a.innerHTML=`
            <h4 style="color:#6a1b9a; margin:0 0 10px 0;">${o.name}</h4>
            <div class="mini-grid" style="margin: 0 auto 10px auto;">
                ${qu(o.pattern)}
            </div>
            <p style="font-size:0.8em; color:#555;">${o.description||"Unique Scoring"}</p>
        `,a.onclick=()=>{r.style.display="",r.style.gap="",r.style.justifyContent="",t.classList.add("hidden"),e(o)},r.appendChild(a)}),t.classList.remove("hidden")}function qu(n){let e='<div style="display:flex; flex-direction:column; gap:2px; align-items:center;">';return n.forEach(t=>{e+='<div style="display:flex; gap:2px;">',t.forEach(s=>{let i="transparent",r="1px solid transparent";s!=="NONE"&&(r="1px solid rgba(0,0,0,0.1)",s==="WOOD"&&(i="#5d4037"),s==="WHEAT"&&(i="#fdd835"),s==="BRICK"&&(i="#ef5350"),s==="GLASS"&&(i="#29b6f6"),s==="STONE"&&(i="#757575")),e+=`<div style="width:15px; height:15px; background:${i}; border:${r}; border-radius:2px;"></div>`}),e+="</div>"}),e+="</div>",e}function Ri(n,e){const t=document.getElementById("resource-picker-modal"),s=document.getElementById("picker-title"),i=document.getElementById("picker-message"),r=document.getElementById("picker-options");s.textContent="Grove University Scholarship",i.textContent="Choose a building to construct immediately for free:",r.innerHTML="",r.parentElement&&(r.parentElement.style.maxWidth="600px",r.parentElement.style.width="95%"),r.style.display="flex",r.style.gap="15px",r.style.justifyContent="center",r.style.flexWrap="wrap",r.style.padding="10px",r.style.maxHeight="70vh",r.style.overflowY="auto",n.forEach(o=>{if(o.isMonument)return;const a=document.createElement("div");a.style.border="1px solid #e0e0e0",a.style.borderRadius="12px",a.style.padding="15px 10px",a.style.cursor="pointer",a.style.background="white",a.style.width="110px",a.style.height="130px",a.style.display="flex",a.style.flexDirection="column",a.style.alignItems="center",a.style.justifyContent="space-between",a.style.transition="all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1)",a.style.boxShadow="0 2px 5px rgba(0,0,0,0.05)";let l="#ccc";o.type==="RED"?l="#ef5350":o.type==="BLUE"?l="#42a5f5":o.type==="YELLOW"?l="#fdd835":o.type==="GREEN"?l="#66bb6a":o.type==="GRAY"?l="#bdbdbd":o.type==="ORANGE"?l="#ffca28":o.type==="BLACK"&&(l="#424242"),a.style.borderBottom=`5px solid ${l}`;const c=document.createElement("div");c.style.flex="1",c.style.display="flex",c.style.alignItems="center",c.style.justifyContent="center",c.style.width="100%";const d=document.createElement("div"),u=o.name.replace(/ /g,"-").replace(/'/g,"").toUpperCase();d.className=`mini-cell ${u}`,d.style.width="50px",d.style.height="50px",d.style.transform="none",d.style.margin="0",d.style.backgroundSize="contain",d.style.backgroundRepeat="no-repeat",d.style.backgroundPosition="center",d.style.border="none",c.appendChild(d);const h=document.createElement("span");h.textContent=o.name,h.style.fontSize="0.85em",h.style.fontWeight="600",h.style.color="#333",h.style.textAlign="center",h.style.marginTop="5px",a.appendChild(c),a.appendChild(h),a.onmouseenter=()=>{a.style.transform="translateY(-4px)",a.style.boxShadow="0 8px 15px rgba(0,0,0,0.1)"},a.onmouseleave=()=>{a.style.transform="translateY(0)",a.style.boxShadow="0 2px 5px rgba(0,0,0,0.05)"},a.onclick=()=>{r.style.display="",r.style.gap="",r.style.justifyContent="",r.style.maxHeight="",r.style.overflowY="",r.style.padding="",r.parentElement&&(r.parentElement.style.maxWidth="",r.parentElement.style.width=""),t.classList.add("hidden"),e(o)},r.appendChild(a)}),t.classList.remove("hidden")}function Qu(n,e,t){const s=document.getElementById("resource-picker-modal"),i=document.getElementById("picker-title"),r=document.getElementById("picker-message"),o=document.getElementById("picker-options");i.textContent="Opaleye's Watch Setup",r.textContent=`Select exactly ${e} unique buildings to place on your Watch.`,o.innerHTML="",o.parentElement&&(o.parentElement.style.maxWidth="700px",o.parentElement.style.width="95%"),o.style.display="flex",o.style.gap="10px",o.style.justifyContent="center",o.style.flexWrap="wrap";const a=new Set,l="multi-picker-confirm-btn",c=()=>{Array.from(o.children).forEach(p=>{if(p.id===l)return;const m=p.dataset.name;a.has(m)?(p.style.border="3px solid #2e7d32",p.style.background="#e8f5e9",p.style.transform="scale(1.05)"):(p.style.border="1px solid #e0e0e0",p.style.background="white",p.style.transform="scale(1)")});const h=document.getElementById(l);h&&(h.disabled=a.size!==e,h.textContent=a.size!==e?`Select ${a.size}/${e}`:"Confirm Selection",h.style.opacity=a.size!==e?"0.5":"1")};n.forEach(h=>{if(h.isMonument||h.name==="Opaleye's Watch")return;const p=document.createElement("div");p.dataset.name=h.name,p.style.borderRadius="8px",p.style.padding="10px",p.style.cursor="pointer",p.style.width="100px",p.style.height="120px",p.style.display="flex",p.style.flexDirection="column",p.style.alignItems="center",p.style.textAlign="center",p.style.transition="all 0.2s";const m=document.createElement("div"),_=h.name.replace(/ /g,"-").replace(/'/g,"").toUpperCase();m.className=`mini-cell ${_}`,m.style.width="40px",m.style.height="40px",m.style.marginBottom="5px",m.style.backgroundSize="contain",m.style.border="none";const E=document.createElement("span");E.textContent=h.name,E.style.fontSize="0.75em",E.style.fontWeight="bold",p.appendChild(m),p.appendChild(E),p.onclick=()=>{a.has(h.name)?a.delete(h.name):a.size<e&&a.add(h.name),c()},o.appendChild(p)});const d=document.createElement("div");d.style.width="100%",d.style.marginTop="20px",d.style.textAlign="center";const u=document.createElement("button");u.id=l,u.className="primary-btn",u.textContent=`Select 0/${e}`,u.disabled=!0,u.onclick=()=>{o.parentElement&&(o.parentElement.style.maxWidth="",o.parentElement.style.width=""),s.classList.add("hidden"),t(Array.from(a))},d.appendChild(u),o.appendChild(d),s.classList.remove("hidden")}function Xu(n,e){const t=document.getElementById("resource-picker-modal"),s=document.getElementById("picker-title"),i=document.getElementById("picker-message"),r=document.getElementById("picker-options");s.textContent="Opaleye's Watch Triggered!",i.innerHTML=`Your neighbor constructed a <strong>${n}</strong>.<br>You may place one immediately!`,r.innerHTML="",r.style.display="flex",r.style.flexDirection="column",r.style.alignItems="center",r.style.gap="20px";const o=document.createElement("div"),a=n.replace(/ /g,"-").replace(/'/g,"").toUpperCase();o.className=`mini-cell ${a}`,o.style.width="80px",o.style.height="80px",o.style.borderRadius="12px",o.style.boxShadow="0 4px 10px rgba(0,0,0,0.1)",o.style.backgroundSize="60%",o.style.border="2px solid #7b1fa2",r.appendChild(o);const l=document.createElement("button");l.className="primary-btn",l.textContent="Select Square to Build",l.onclick=()=>{r.style.display="",r.style.flexDirection="",r.style.alignItems="",r.style.gap="",t.classList.add("hidden"),e()},r.appendChild(l),t.classList.remove("hidden")}function Ju(n,e,t){const s=document.getElementById("confirmation-modal"),i=document.getElementById("confirm-title"),r=document.getElementById("confirm-message"),o=document.getElementById("confirm-cancel-btn"),a=document.getElementById("confirm-ok-btn");!s||!i||!r||!o||!a||(i.textContent=n,r.textContent=e,o.onclick=()=>{s.classList.add("hidden")},a.onclick=()=>{s.classList.add("hidden"),t()},s.classList.remove("hidden"))}class Zu{multiplayer;audio;landingUI=document.getElementById("landing-ui");lobbyUI=document.getElementById("lobby-ui");playerNameInput=document.getElementById("player-name-input");createGameBtn=document.getElementById("create-game-ui-btn");joinGameBtn=document.getElementById("join-game-btn");gameIdInput=document.getElementById("game-id-input");shareCodeDisplay=document.getElementById("share-code-display");hostSettings=document.getElementById("host-settings");guestWaitingMsg=document.getElementById("guest-waiting-msg");startGameBtn=document.getElementById("start-game-btn");copyLinkBtn=document.getElementById("copy-link-btn");setupContainer=document.getElementById("setup-container");lobbyPlayerList=document.getElementById("lobby-player-list");activeGameId=null;constructor(e,t){this.multiplayer=e,this.audio=t,this.bindEvents(),this.checkUrlForInvite()}update(e){e.players&&Vu(e.players,this.lobbyPlayerList)}bindEvents(){this.createGameBtn.onclick=async()=>{const e=this.playerNameInput.value||"Host";try{const t=this.generateRandomDeck(),s=await this.multiplayer.createGame(e,t.map(i=>i.name));this.enterLobbyMode(s,!0)}catch(t){console.error("Firebase Error:",t),N("Error creating game.","error",this.audio)}},this.joinGameBtn.onclick=async()=>{const e=this.playerNameInput.value||"Guest",t=this.gameIdInput.value.trim();if(!t){N("Please enter a code!","error",this.audio);return}try{await this.multiplayer.joinGame(t,e),this.enterLobbyMode(t,!1)}catch(s){N("Could not join game: "+s,"error",this.audio)}},this.startGameBtn.onclick=async()=>{const e=this.buildDeckFromUI();await this.multiplayer.updateDeck(e.map(t=>t.name)),await this.multiplayer.startGame()},this.shareCodeDisplay.onclick=()=>{const e=this.shareCodeDisplay.innerText.replace("Code: ","");navigator.clipboard.writeText(e),N("Code copied!","success",this.audio)},this.copyLinkBtn.onclick=()=>{if(!this.activeGameId)return;const e=`${window.location.origin}${window.location.pathname}?gameId=${this.activeGameId}`;navigator.clipboard.writeText(e).then(()=>{N("Invite Link copied!","success",this.audio)})}}enterLobbyMode(e,t){this.activeGameId=e,this.landingUI.classList.add("hidden"),this.lobbyUI.classList.remove("hidden"),this.shareCodeDisplay.innerText=`Code: ${e}`,t?(this.hostSettings.classList.remove("hidden"),this.guestWaitingMsg.classList.add("hidden"),Yu(this.setupContainer,fn)):(this.hostSettings.classList.add("hidden"),this.guestWaitingMsg.classList.remove("hidden"))}checkUrlForInvite(){const t=new URLSearchParams(window.location.search).get("gameId");t&&(this.gameIdInput.value=t,this.playerNameInput.focus(),N(`Invite code ${t} detected! Enter your name to join.`,"success",this.audio),this.createGameBtn.parentElement&&this.createGameBtn.parentElement.classList.add("hidden"))}buildDeckFromUI(){const e=[Ds],t=document.querySelectorAll(".setup-select");return t.length===0?this.generateRandomDeck():(t.forEach(s=>{const i=s.dataset.category;if(!i)return;const r=fn.find(a=>a.id===i);if(!r)return;let o;s.value==="RANDOM"?o=this.pickRandom(r.options):o=r.options.find(a=>a.name===s.value),o&&e.push(o)}),e)}generateRandomDeck(){const e=[Ds];return fn.forEach(t=>{e.push(this.pickRandom(t.options))}),e}pickRandom(e){return e[Math.floor(Math.random()*e.length)]}}class ef{game;renderer;multiplayer;audio;activeConstruction=null;activePatternCoords=[];multiplayerStatusMessage="";hasActedThisTurn=!1;hasDeclaredGameOver=!1;pendingFreeBuildName=null;guildReplacementsLeft=0;activeOpaleyeSource=null;pendingState=null;elements={startModal:document.getElementById("start-screen-modal"),opponentsSidebar:document.getElementById("opponents-sidebar"),opponentsList:document.getElementById("opponents-list"),scoreDisplay:document.getElementById("score-display"),undoBtn:document.getElementById("undo-btn"),confirmBtn:document.getElementById("confirm-btn"),finishTownBtn:document.getElementById("finish-town-btn"),finishGuildBtn:document.getElementById("finish-guild-btn"),gameOverModal:document.getElementById("game-over-modal"),finalScore:document.getElementById("final-score"),scoreList:document.getElementById("score-breakdown-list"),restartBtn:document.getElementById("restart-btn"),multiplayerResultsModal:document.getElementById("multiplayer-results-modal"),leaderboardList:document.getElementById("leaderboard-list"),mpRestartBtn:document.getElementById("mp-restart-btn"),muteBtn:document.getElementById("mute-btn"),sidebarToggle:document.getElementById("sidebar-toggle-btn"),sidebar:document.getElementById("sidebar"),opponentsToggle:document.getElementById("opponents-toggle-btn")};constructor(e,t,s,i){this.game=e,this.renderer=t,this.multiplayer=s,this.audio=i,this.bindEvents()}handleGameUpdate(e){this.elements.startModal.classList.contains("hidden")||this.elements.startModal.classList.add("hidden"),this.checkMonumentSelection(e),this.syncActiveMonument(e),this.updateOpponentUI(e),this.updateTurnStatus(e),e.status==="FINISHED"&&this.handleGlobalGameOver(e),this.game.currentResource=e.currentResource||null,this.renderAll()}bindEvents(){this.renderer.onResourceSelect=e=>this.onResourceSelect(e),this.renderer.onCellClick=(e,t)=>this.onCellClick(e,t),this.renderer.onBuildClick=e=>this.onBuildClick(e),this.renderer.onCancelClick=()=>this.onCancelClick(),this.renderer.onSwapClick=()=>this.handleSwapClick(),this.elements.confirmBtn.onclick=()=>this.onConfirm(),this.elements.undoBtn.onclick=()=>this.onUndo(),this.elements.finishGuildBtn.onclick=()=>this.finishGuildAction(),this.elements.finishTownBtn.onclick=()=>this.onFinishTown(),this.elements.restartBtn.onclick=()=>location.reload(),this.elements.mpRestartBtn.onclick=()=>location.reload(),this.elements.muteBtn.onclick=()=>{const e=this.audio.toggleMute();this.elements.muteBtn.textContent=e?"":""},this.multiplayer.onOpaleyeBonus=(e,t)=>this.onOpaleyeBonus(e,t),this.elements.sidebarToggle&&(this.elements.sidebarToggle.onclick=e=>{e.stopPropagation(),this.elements.sidebar.classList.toggle("sidebar-open"),this.elements.opponentsSidebar.classList.remove("opponents-open")},this.elements.opponentsToggle.onclick=e=>{e.stopPropagation(),this.elements.opponentsSidebar.classList.toggle("opponents-open"),this.elements.sidebar.classList.remove("sidebar-open")},document.addEventListener("click",e=>{const t=e.target;this.elements.sidebar.classList.contains("sidebar-open")&&!this.elements.sidebar.contains(t)&&this.elements.sidebar.classList.remove("sidebar-open"),this.elements.opponentsSidebar.classList.contains("opponents-open")&&!this.elements.opponentsSidebar.contains(t)&&this.elements.opponentsSidebar.classList.remove("opponents-open")})),document.addEventListener("click",e=>{const t=e.target,s=this.elements.sidebar.contains(t),i=this.elements.sidebarToggle.contains(t);this.elements.sidebar.classList.contains("sidebar-open")&&!s&&!i&&(this.elements.sidebar.classList.remove("sidebar-open"),this.elements.sidebarToggle.textContent="")})}onResourceSelect(e){this.activeConstruction||(!this.game.currentResource||this.pendingState&&this.pendingState.type==="SELECT_RESOURCE"?(this.pendingState={type:"SELECT_RESOURCE",data:e},this.game.currentResource=e,this.renderAll()):console.log("Blocked: Resource already active"))}onCellClick(e,t){const i=this.game.board.getGrid()[e][t];if(this.pendingFreeBuildName){this.handleFreeBuild(e,t,i);return}if(this.guildReplacementsLeft>0){this.handleGuildReplacement(e,t,i);return}if(i&&i.toUpperCase()==="WAREHOUSE"){this.handleWarehouseClick(e,t);return}try{this.activeConstruction?this.handleConstructionClick(e,t):this.handleResourceClick(e,t)}catch(r){this.audio.play("error"),N(r.message,"error",this.audio)}}handleResourceClick(e,t){if(this.hasActedThisTurn){N("You have already placed a resource this turn!","error",this.audio);return}if(this.pendingState?.type==="SELECT_RESOURCE"){N("Please confirm your resource selection first!","error",this.audio);return}if(!this.game.currentResource){N("Waiting for Master Builder...","info");return}const s=this.multiplayer.masterBuilderId===this.multiplayer.playerId;if(this.game.board.getGrid()[e][t].toUpperCase()==="COTTAGE"&&this.game.hasStatueOfBondmaker()){const r=this.game.board.getMetadata(e,t);if(r&&r.storedResource){N("Cottage is full!","error",this.audio);return}if(s){N("Bondmaker only works on others' turns!","error",this.audio);return}}this.game.placeResource(e,t),this.audio.play("click"),this.multiplayer.commitTurn(),this.renderAll(),this.checkAndShowGameOver()}handleConstructionClick(e,t){const i=this.game.board.getGrid()[e][t],r=this.activePatternCoords.some(d=>d.row===e&&d.col===t),o=this.activeConstruction?this.activeConstruction.buildingName.toUpperCase():"",c=(this.game.hasObeliskAbility()||o==="SHED")&&i==="NONE";if(r||c){if(i&&i.toUpperCase().replace("_"," ")==="TRADING POST"){N("Cannot build on Trading Post.","error",this.audio);return}const d=this.game.constructBuilding(this.activeConstruction,e,t);this.multiplayer.saveBoardOnly(),this.resetConstructionState(),d.type==="TRIGGER_EFFECT"&&this.handleBuildingEffect(d.effectType,e,t),this.audio.play("build"),this.renderAll(),this.checkAndShowGameOver()}}handleBuildingEffect(e,t,s){if(e==="FACTORY")Nn("Setup Factory","Choose a resource to store:",i=>{this.game.setBuildingStorage(t,s,i),this.multiplayer.saveBoardOnly(),this.renderAll()});else if(e==="BANK"){const i=this.game.getForbiddenResources();Nn("Setup Bank","Choose a resource to ban:",r=>{this.game.setBuildingStorage(t,s,r),this.multiplayer.saveBoardOnly(),this.renderAll()},i)}else e==="ARCHITECTS_GUILD"?(this.guildReplacementsLeft=2,N("Select a building to replace (2 remaining).","info"),this.multiplayerStatusMessage="Select a building to replace.",this.multiplayer.saveBoardOnly(),this.renderAll()):e==="GROVE_UNIVERSITY"?Ri(this.game.gameRegistry,i=>{this.pendingFreeBuildName=i.name,N(`Select an empty square for ${i.name}.`,"success"),this.renderAll()}):e==="OPALEYE_WATCH"&&Qu(this.game.gameRegistry,3,i=>{this.game.initializeOpaleye(t,s,i),this.multiplayer.saveBoardOnly(),this.renderAll(),N("Opaleye's Watch prepared!","success")})}handleFreeBuild(e,t,s){if(s!=="NONE"){N("Must be empty!","error",this.audio);return}try{this.game.placeFreeBuilding(e,t,this.pendingFreeBuildName),this.activeOpaleyeSource&&(this.game.removeOpaleyeItem(this.activeOpaleyeSource.r,this.activeOpaleyeSource.c,this.pendingFreeBuildName),this.activeOpaleyeSource=null),this.pendingFreeBuildName=null,this.multiplayer.saveBoardOnly(),this.audio.play("build"),this.renderAll(),this.checkAndShowGameOver(),N("Building constructed!","success")}catch{this.audio.play("error"),N("Error placing building.","error",this.audio)}}handleGuildReplacement(e,t,s){if(!(s!=="NONE"&&!["WOOD","WHEAT","BRICK","GLASS","STONE"].includes(s))){N("Select a building!","error",this.audio);return}Ri(this.game.gameRegistry,r=>{this.game.replaceBuilding(e,t,r.name),this.guildReplacementsLeft--,this.guildReplacementsLeft<=0?this.finishGuildAction():N(`Replaced! ${this.guildReplacementsLeft} left.`,"success"),this.multiplayer.saveBoardOnly(),this.audio.play("build"),this.renderAll()})}handleWarehouseClick(e,t){if(this.hasActedThisTurn||!this.game.currentResource)return;const s=this.game.getWarehouseContents(e,t),i=s.length<3,r=this.game.currentResource,o=document.getElementById("resource-picker-modal"),a=document.getElementById("picker-options");if(document.getElementById("picker-title").textContent="Warehouse Manager",document.getElementById("picker-message").textContent=`Current: ${r}`,a.innerHTML="",i){const l=document.createElement("button");l.className="primary-btn",l.style.marginBottom="20px",l.innerHTML=` <strong>Store ${r}</strong>`,l.onclick=()=>{this.game.storeInWarehouse(e,t,r),this.commitWarehouseAction(!0),o.classList.add("hidden")},a.appendChild(l)}if(s.length>0){const l=document.createElement("div");l.style.display="flex",l.style.gap="15px",l.style.justifyContent="center",s.forEach((c,d)=>{const u=document.createElement("div");u.className=`res-btn ${c}`,u.onclick=()=>{const h=this.game.swapInWarehouse(e,t,d,r);h&&(this.game.currentResource=h,N(`Swapped for ${h}`,"success"),this.commitWarehouseAction(!1),o.classList.add("hidden"))},l.appendChild(u)}),a.appendChild(l)}o.classList.remove("hidden")}async commitWarehouseAction(e){e?await this.multiplayer.commitTurn():await this.multiplayer.saveBoardOnly(),this.renderAll(),this.checkAndShowGameOver()}async onConfirm(){if(this.pendingState)try{if(this.pendingState.type==="SELECT_RESOURCE"){const e=this.pendingState.data;await this.multiplayer.setGlobalResource(e),this.audio.play("place"),N("Confirmed!","success")}this.pendingState=null,this.renderAll()}catch(e){this.audio.play("error"),N("Error: "+e,"error",this.audio)}}onUndo(){N("Undo not available.","info")}onBuildClick(e){this.activeConstruction=e,this.activePatternCoords=this.getPatternCoords(e),this.renderAll()}onCancelClick(){this.resetConstructionState(),this.renderAll()}handleSwapClick(){Nn("Factory Swap","Select resource:",async e=>{this.game.currentResource=e,N(`Swapped for ${e}.`,"success"),this.renderAll()})}onFinishTown(){Ju("Finish Town?","Are you sure?",()=>{this.multiplayer.declareGameOver().then(()=>{this.hasDeclaredGameOver=!0,this.audio.play("fanfare"),this.renderAll(),this.checkAndShowGameOver(!0)})})}finishGuildAction(){this.guildReplacementsLeft=0,this.elements.finishGuildBtn.classList.add("hidden"),this.multiplayer.commitTurn(),this.renderAll(),this.checkAndShowGameOver()}onOpaleyeBonus(e,t){Xu(e,()=>{this.pendingFreeBuildName=e,this.activeOpaleyeSource=t,this.renderAll(),N(`Place your ${e}.`,"info")})}renderAll(){let e=!1;if(this.game.currentResource&&!this.hasActedThisTurn){const h=this.multiplayer.masterBuilderId===this.multiplayer.playerId,p=this.game.canFactorySwap(this.game.currentResource);!h&&p&&(e=!0)}this.renderer.toggleFactoryAction(e,this.game.currentResource||"");let t=[];this.multiplayer.masterBuilderId===this.multiplayer.playerId&&!this.game.currentResource&&(t=this.game.getForbiddenResources()),this.guildReplacementsLeft>0?(this.elements.finishGuildBtn.classList.remove("hidden"),this.elements.finishGuildBtn.textContent=`Done (${this.guildReplacementsLeft})`,fe(!1),this.multiplayerStatusMessage="Select a building to replace."):this.elements.finishGuildBtn.classList.add("hidden");let i=this.multiplayerStatusMessage;this.pendingState&&this.pendingState.type==="SELECT_RESOURCE"?(this.elements.confirmBtn.classList.remove("hidden"),this.elements.undoBtn.classList.add("hidden"),fe(!0),i=`Selected ${this.pendingState.data}. Confirm or change.`):(this.elements.confirmBtn.classList.add("hidden"),this.elements.undoBtn.classList.add("hidden")),this.pendingFreeBuildName&&(i=`BONUS: Place your ${this.pendingFreeBuildName}!`,fe(!1));const r=this.game.availableMatches.length,o=document.getElementById("match-badge"),a=this.elements.sidebarToggle;r>0?(o&&(o.innerText=r.toString(),o.style.display="flex"),a&&a.classList.add("can-build")):(o&&(o.style.display="none"),a&&a.classList.remove("can-build"));const l=this.multiplayer.myFinishRank||void 0,c=this.game.getScore(l),d=c.total+c.penaltyCount,u=l?` (Rank: ${l})`:"";this.elements.scoreDisplay.innerHTML=`Score: ${d} <span style="font-size:12px; color:#999">(-${c.penaltyCount} empty)</span>${u}`,this.hasDeclaredGameOver?this.elements.finishTownBtn.classList.add("hidden"):this.elements.finishTownBtn.classList.remove("hidden"),this.renderer.render(this.game,this.activeConstruction,this.activePatternCoords,i,t)}checkAndShowGameOver(e=!1){if(!this.hasDeclaredGameOver&&this.game.checkGameOver()&&!this.activeConstruction&&(this.multiplayer.declareGameOver(),this.hasDeclaredGameOver=!0,this.audio.play("fanfare"),e=!0),this.hasDeclaredGameOver&&e){const t=this.game.getScore(this.multiplayer.myFinishRank||void 0);this.elements.finalScore.textContent=t.total.toString(),this.elements.scoreList.innerHTML="",Object.entries(t.breakdown).forEach(([s,i])=>{i!==0&&this.addScoreListItem(s,i)}),t.penaltyCount>0&&this.addScoreListItem("Empty Spaces",-t.penaltyCount,!0),this.elements.gameOverModal.classList.remove("hidden"),fe(!1)}}checkMonumentSelection(e){const t=e.players?e.players[this.multiplayer.playerId]:null;if(t&&t.monumentOptions&&!t.monumentChosen){const s=document.getElementById("resource-picker-modal");if(s&&s.classList.contains("hidden")){const i=t.monumentOptions.map(r=>nt.find(o=>o.name===r)).filter(r=>!!r);i.length>0&&ju(i,r=>{this.multiplayer.selectMonument(r.name)})}}}syncActiveMonument(e){const t=e.players?e.players[this.multiplayer.playerId]:null;if(t&&t.activeMonument&&!this.game.activeMonument){const s=nt.find(o=>o.name===t.activeMonument),r=(e.deck||[]).map(o=>st.find(a=>a.name===o)).filter(o=>!!o);s&&(this.game.setMonument(s,r),this.renderer.renderDeck(this.game.gameRegistry))}}updateOpponentUI(e){const t=e.playerOrder||[],s=Array.isArray(t)?t:Object.values(t);let i=null;if(s.length>0){const r=(e.masterBuilderIndex||0)%s.length;i=s[r]}e.players&&zu(e.players,e.roundNumber||1,this.multiplayer.playerId,this.elements.opponentsSidebar,this.elements.opponentsList,i,s)}updateTurnStatus(e){const t=this.multiplayer.masterBuilderId===this.multiplayer.playerId,s=e.currentResource!==void 0&&e.currentResource!==null,i=e.roundNumber||1,r=e.players?e.players[this.multiplayer.playerId]:null;r&&(this.hasActedThisTurn=Number(r.placedRound)===Number(i)),s?this.hasActedThisTurn?(this.multiplayerStatusMessage="Waiting for other players...",fe(!1)):(this.multiplayerStatusMessage="",fe(!1)):t?(this.multiplayerStatusMessage="YOU are the Master Builder! Choose a resource.",fe(!0)):(this.multiplayerStatusMessage="Waiting for Master Builder...",fe(!1))}handleGlobalGameOver(e){this.elements.gameOverModal.classList.add("hidden"),Ku(e.players,this.elements.leaderboardList),this.elements.multiplayerResultsModal.classList.remove("hidden")}getPatternCoords(e){const t=[];return e.pattern.forEach((s,i)=>{s.forEach((r,o)=>{r!=="NONE"&&t.push({row:e.row+i,col:e.col+o})})}),t}addScoreListItem(e,t,s=!1){const i=document.createElement("li");i.className="score-item",s&&(i.classList.add("penalty-text"),i.style.color="#ef5350"),i.style.display="flex",i.style.justifyContent="space-between",i.innerHTML=`<span>${e.toLowerCase()}</span><strong>${t}</strong>`,this.elements.scoreList.appendChild(i)}resetConstructionState(){this.activeConstruction=null,this.activePatternCoords=[]}debugSetMonument(e){const t=nt.find(s=>s.name.toUpperCase().includes(e.toUpperCase()));if(t){const s=this.game.gameRegistry.filter(i=>!i.isMonument);this.game.setMonument(t,s),this.renderer.renderDeck(this.game.gameRegistry),this.renderAll(),this.multiplayer.gameId&&this.multiplayer.selectMonument(t.name),N(`Debug: Switched to ${t.name}`,"success",this.audio)}else console.error("Monument not found")}}const As=new ka,lo=new La,un=new Hu(As),co=new $u,tf=new Zu(un,co),ks=new ef(As,lo,un,co);un.onStateChange=n=>{try{n.status==="LOBBY"?tf.update(n):ks.handleGameUpdate(n)}catch(e){console.error("State Sync Error:",e)}};un.onGameStart=()=>{const n=document.getElementById("start-screen-modal");n&&n.classList.add("hidden"),lo.renderDeck(As.gameRegistry),ks.renderAll()};window.setMonument=n=>ks.debugSetMonument(n);console.log(" Tiny Towns Initialized.");
