(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=t(i);fetch(i.href,r)}})();const d={WOOD:"WOOD",WHEAT:"WHEAT",BRICK:"BRICK",GLASS:"GLASS",STONE:"STONE",NONE:"NONE"},q={COTTAGE:"COTTAGE",TAVERN:"TAVERN",BARRETT_CASTLE:"BARRETT_CASTLE"};class fo{amount;constructor(e){this.amount=e}getFedPositions(e,t,s){return Array(this.amount).fill({r:-1,c:-1})}}class po{getFedPositions(e,t,s){const i=[];return[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]].forEach(([o,a])=>{const l=e+o,c=t+a;l>=0&&l<4&&c>=0&&c<4&&i.push({r:l,c})}),i}}class _o{getFedPositions(e,t,s){const o=new Set,a=[],l=(c,f)=>{const u=s[c][f];return u===q.COTTAGE||u===q.BARRETT_CASTLE};for(let c=0;c<4;c++)for(let f=0;f<4;f++){const u=`${c},${f}`;if(o.has(u)||!l(c,f))continue;const h=[],p=[{r:c,c:f}];for(o.add(u);p.length>0;){const m=p.pop();h.push(m);const g=[[-1,0],[1,0],[0,-1],[0,1]];for(const[w,P]of g){const E=m.r+w,b=m.c+P,M=`${E},${b}`;E>=0&&E<4&&b>=0&&b<4&&!o.has(M)&&l(E,b)&&(o.add(M),p.push({r:E,c:b}))}}a.push(h)}return a.length===0?[]:(a.sort((c,f)=>f.length-c.length),a[0])}}class mo{getFedPositions(e,t,s){const i=[];for(let r=0;r<4;r++)r!==t&&i.push({r:e,c:r});for(let r=0;r<4;r++)r!==e&&i.push({r,c:t});return i}}class Se{points;requiresFood;constructor(e,t=!1){this.points=e,this.requiresFood=t}score(e){return this.requiresFood&&!e.fedState?0:this.points}}class go{targetTypes;pointsPerNeighbor;constructor(e,t){this.targetTypes=e,this.pointsPerNeighbor=t}score(e){let t=0;const s=[[-1,0],[1,0],[0,-1],[0,1]];for(const[i,r]of s){const o=e.row+i,a=e.col+r;if(o>=0&&o<4&&a>=0&&a<4){const l=e.grid[o][a];this.targetTypes.includes(l)&&(t+=this.pointsPerNeighbor)}}return t}}class yo{score(e){const t=new Set;for(let s=0;s<4;s++)s!==e.col&&this.addIfBuilding(t,e.grid[e.row][s]);for(let s=0;s<4;s++)s!==e.row&&this.addIfBuilding(t,e.grid[s][e.col]);return t.size}addIfBuilding(e,t){["NONE","WOOD","WHEAT","BRICK","GLASS","STONE"].includes(t)||e.add(t)}}class Eo{score(e){let t=0;return Object.values(e.counts).forEach(s=>{s===1&&(t+=1)}),t}}class Co{multiplier;constructor(e){this.multiplier=e}score(e){const t=new Set,s=[[-1,0],[1,0],[0,-1],[0,1]],i=["NONE","WOOD","WHEAT","BRICK","GLASS","STONE"];for(const[r,o]of s){const a=e.row+r,l=e.col+o;if(a>=0&&a<4&&l>=0&&l<4){const c=e.grid[a][l];i.includes(c)||t.add(c)}}return t.size*this.multiplier}}class vo{score(e){const t=`${e.row},${e.col}`,s=e.metadata.get(t);return s&&s.savedScore||0}}class So{score(e){let t=0;for(const s of e.validBuildingNames){const i=s.toUpperCase();e.counts[i]||t++}return t*2}}class Io{score(e){let t=0;const s=new Set,i=["NONE","WOOD","WHEAT","BRICK","GLASS","STONE"],r=[[-1,0],[1,0],[0,-1],[0,1]];for(let o=0;o<4;o++)for(let a=0;a<4;a++){const l=`${o},${a}`,c=e.grid[o][a];if(s.has(l)||i.includes(c))continue;let f=0;const u=[{r:o,c:a}];for(s.add(l);u.length>0;){const h=u.pop();f++;for(const[p,m]of r){const g=h.r+p,w=h.c+m,P=`${g},${w}`;g>=0&&g<4&&w>=0&&w<4&&!s.has(P)&&e.grid[g][w]===c&&(s.add(P),u.push({r:g,c:w}))}}f>t&&(t=f)}return 1+t}}class bo{score(e){let t=0;for(let s=0;s<4;s++)for(let i=0;i<4;i++){const r=e.grid[s][i],o=`${s},${i}`;r==="COTTAGE"&&(e.allFedPositions.has(o)||t++)}return t*3}}class wo{targetTypes;scoreAmount;constructor(e,t){this.targetTypes=e,this.scoreAmount=t}score(e){const t=[[-1,0],[1,0],[0,-1],[0,1]];for(const[s,i]of t){const r=e.row+s,o=e.col+i;if(r>=0&&r<4&&o>=0&&o<4){const a=e.grid[r][o];if(this.targetTypes.includes(a))return this.scoreAmount}}return 0}}class Ti{targetCategories;scoreAmount;constructor(e,t){this.targetCategories=e,this.scoreAmount=t}score(e){const t=[[-1,0],[1,0],[0,-1],[0,1]];for(const[s,i]of t){const r=e.row+s,o=e.col+i;if(r>=0&&r<4&&o>=0&&o<4){const a=e.grid[r][o],l=e.registry.find(c=>c.name.toUpperCase()===a.toUpperCase());if(l&&this.targetCategories.includes(l.type))return this.scoreAmount}}return 0}}class To{score(e){let t=0;const s=e.grid[e.row][e.col];for(let i=0;i<4;i++)i!==e.col&&e.grid[e.row][i]===s&&t++;for(let i=0;i<4;i++)i!==e.row&&e.grid[i][e.col]===s&&t++;return t}}class No{score(e){let t=1;const s=["1,1","1,2","2,1","2,2"],i=`${e.row},${e.col}`,r=e.grid[e.row][e.col];return s.forEach(o=>{if(o===i)return;const[a,l]=o.split(",").map(Number);e.grid[a][l]===r&&t++}),t}}class Ro{score(e){const t=e.grid[e.row][e.col],s=e.counts[t]||e.counts[t.toUpperCase()]||0;return s===0?0:s%2!==0?-1:({2:5,4:15,6:26,8:40}[s]??s*5)/s}}class Ao{score(e){const t=e.grid[e.row][e.col];for(let s=0;s<4;s++)if(s!==e.col&&e.grid[e.row][s]===t)return 0;for(let s=0;s<4;s++)if(s!==e.row&&e.grid[s][e.col]===t)return 0;return 3}}class Oo{score(e){return e.fedCottageCount}}class Do{requiredNeighbors;scoreAmount;constructor(e,t){this.requiredNeighbors=e,this.scoreAmount=t}score(e){let t=0;const s=[[-1,0],[1,0],[0,-1],[0,1]];for(const[i,r]of s){const o=e.row+i,a=e.col+r;o>=0&&o<4&&a>=0&&a<4&&e.allFedPositions.has(`${o},${a}`)&&t++}return t>=this.requiredNeighbors?this.scoreAmount:0}}class ko{targetName;constructor(e){this.targetName=e}score(e){const t=[{r:0,c:0},{r:0,c:3},{r:3,c:0},{r:3,c:3}];let s=0;return t.forEach(i=>{e.grid[i.r][i.c]===this.targetName&&s++}),s}}class Po{restrictedCategories;scoreAmount;constructor(e,t){this.restrictedCategories=e,this.scoreAmount=t}score(e){const t=[[-1,0],[1,0],[0,-1],[0,1]];for(const[s,i]of t){const r=e.row+s,o=e.col+i;if(r>=0&&r<4&&o>=0&&o<4){const a=e.grid[r][o],l=e.registry.find(c=>c.name.toUpperCase()===a.toUpperCase());if(l&&this.restrictedCategories.includes(l.type))return 0}}return this.scoreAmount}}const zn={name:"Cottage",type:"BLUE",pattern:[[d.NONE,d.WHEAT],[d.BRICK,d.GLASS]],scorer:new Se(3,!0),feedCost:1,description:"3 points if fed."},Lo=[zn],Mo={name:"Farm",type:"RED",pattern:[[d.WHEAT,d.WHEAT],[d.WOOD,d.WOOD]],feeder:new fo(4),description:"Feeds 4 cottages anywhere on the board."},xo={name:"Granary",type:"RED",pattern:[[d.WHEAT,d.WHEAT],[d.WOOD,d.BRICK]],feeder:new po,description:"Feeds all buildings in the 8 squares surrounding it."},Bo={name:"Greenhouse",type:"RED",pattern:[[d.WHEAT,d.GLASS],[d.WOOD,d.WOOD]],feeder:new _o,description:"Feeds one contiguous group of Cottages."},Fo={name:"Orchard",type:"RED",description:"Feeds Cottages in the same row and column.",pattern:[[d.STONE,d.WHEAT],[d.WHEAT,d.WOOD]],feeder:new mo},Ni=[Mo,xo,Bo,Fo],Wo={name:"Well",type:"GRAY",pattern:[[d.WOOD,d.STONE]],description:"1 point for each adjacent cottage.",scorer:new go([q.COTTAGE,q.BARRETT_CASTLE],1)},Go={name:"Fountain",type:"GRAY",description:"2 points if adjacent to a Cottage.",pattern:[[d.WOOD,d.STONE]],scorer:new wo([q.COTTAGE,q.BARRETT_CASTLE],2)},Uo={name:"Millstone",type:"GRAY",description:"2 points if adjacent to a Red or Yellow building.",pattern:[[d.WOOD,d.STONE]],scorer:new Ti(["RED","YELLOW"],2)},Ho={name:"Shed",type:"GRAY",description:"Worth 1 point. (Standard placement rules apply).",pattern:[[d.WOOD,d.STONE]],scorer:new Se(1)},Ri=[Wo,Go,Uo,Ho],$o={name:"Almshouse",type:"GREEN",pattern:[[d.STONE,d.STONE,d.GLASS]],description:"Score increasing points for each Almshouse you have built.",scorer:new Ro},Vo={name:"Inn",type:"GREEN",pattern:[[d.WHEAT,d.STONE,d.GLASS]],description:"Get 3 points if not in a row or column with another Inn.",scorer:new Ao},Ko={name:"Feast Hall",type:"GREEN",pattern:[[d.WOOD,d.WOOD,d.GLASS]],description:"Get 2 points, and an extra 1 if you have more Feast Halls than the player on your right.",scorer:new Se(2)},zo={name:"Tavern",type:"GREEN",pattern:[[d.BRICK,d.BRICK,d.GLASS]],description:"Score increasing points for each Tavern you have built."},Ai=[zo,Vo,$o,Ko],jo={name:"Theater",type:"YELLOW",pattern:[[d.NONE,d.STONE,d.NONE],[d.WOOD,d.GLASS,d.WOOD]],scorer:new yo,description:"1 point for each unique building type in the same row and column."},Yo={name:"Bakery",type:"YELLOW",description:"3 points if adjacent to a Food (Red) building.",pattern:[[d.NONE,d.WHEAT,d.NONE],[d.BRICK,d.GLASS,d.BRICK]],scorer:new Ti(["RED"],3)},qo={name:"Market",type:"YELLOW",description:"1 point for each other Market in the same row or column.",pattern:[[d.NONE,d.WOOD,d.NONE],[d.STONE,d.GLASS,d.STONE]],scorer:new To},Qo={name:"Tailor",type:"YELLOW",description:"1 point. +1 point for each other Tailor in the 4 center squares.",pattern:[[d.NONE,d.WHEAT,d.NONE],[d.STONE,d.GLASS,d.STONE]],scorer:new No},Oi=[jo,Yo,qo,Qo],Xo={name:"Factory",type:"BLACK",pattern:[[d.WOOD,d.NONE,d.NONE,d.NONE],[d.BRICK,d.STONE,d.STONE,d.BRICK]],description:"Place 1 resource on the factory, whenever another player chooses that resource, play a different one instead."},Jo={name:"Trading Post",type:"BLACK",description:"1 point. Counts as a WILD (any) resource for future buildings.",pattern:[[d.STONE,d.STONE,d.NONE],[d.WOOD,d.WOOD,d.BRICK]],scorer:new Se(1)},Zo={name:"Bank",type:"BLACK",description:"4 points. Place a resource on this building - you can no longer select this resource as master builder.",pattern:[[d.STONE,d.STONE,d.NONE],[d.WOOD,d.WOOD,d.BRICK]],scorer:new Se(4)},ea={name:"Warehouse",type:"BLACK",description:"-1 for each resource on this building. YADA YADA YADA",pattern:[[d.STONE,d.STONE,d.NONE],[d.WOOD,d.WOOD,d.BRICK]],scorer:new Se(1)},Di=[Xo,Jo,Zo,ea],ta={name:"Chapel",type:"ORANGE",pattern:[[d.NONE,d.NONE,d.GLASS],[d.STONE,d.GLASS,d.STONE]],description:"Scores 1 point for each fed cottage.",scorer:new Oo},na={name:"Abbey",type:"ORANGE",pattern:[[d.NONE,d.NONE,d.GLASS],[d.BRICK,d.STONE,d.STONE]],description:"3 points if not adjacent to a black, green or yellow building.",scorer:new Po(["BLACK","GREEN","YELLOW"],3)},sa={name:"Cloister",type:"ORANGE",pattern:[[d.NONE,d.NONE,d.GLASS],[d.WOOD,d.BRICK,d.STONE]],description:"Scores 1 point for each cloister in a corner of your town.",scorer:new ko("CLOISTER")},ia={name:"Temple",type:"ORANGE",pattern:[[d.NONE,d.NONE,d.GLASS],[d.BRICK,d.BRICK,d.STONE]],description:"4 points if adjacent to 2 or more fed cottages.",scorer:new Do(2,4)},ki=[ta,na,sa,ia],ra={name:"Archive",type:"PURPLE",pattern:[[d.WHEAT,d.WHEAT],[d.BRICK,d.GLASS]],scorer:new Eo,isMonument:!0},oa={name:"Barrett Castle",type:"PURPLE",pattern:[[d.WHEAT,d.NONE,d.NONE,d.STONE],[d.WOOD,d.GLASS,d.GLASS,d.BRICK]],scorer:new Se(5,!0),feedCost:1,countsAs:[q.COTTAGE],isMonument:!0},aa={name:"Obelisk of the Crescent",type:"PURPLE",pattern:[[d.WHEAT,d.NONE,d.NONE],[d.BRICK,d.GLASS,d.BRICK]],isMonument:!0},la={name:"Mandras",type:"PURPLE",pattern:[[d.WHEAT,d.GLASS],[d.BRICK,d.WOOD]],scorer:new Co(2),isMonument:!0},ca={name:"Shrine of the Elder Tree",type:"PURPLE",pattern:[[d.BRICK,d.WHEAT,d.STONE],[d.WOOD,d.GLASS,d.WOOD]],isMonument:!0,scorer:new vo},ha={name:"Baths",type:"PURPLE",pattern:[[d.NONE,d.WHEAT,d.NONE],[d.STONE,d.GLASS,d.WOOD],[d.BRICK,d.NONE,d.BRICK]],isMonument:!0,scorer:new So},ua={name:"Forum",type:"PURPLE",pattern:[[d.NONE,d.NONE,d.WHEAT,d.NONE],[d.BRICK,d.BRICK,d.STONE,d.WOOD]],isMonument:!0,scorer:new Io},da={name:"Mausoleum",type:"PURPLE",pattern:[[d.WOOD,d.WOOD],[d.BRICK,d.STONE]],isMonument:!0,scorer:new bo},fa={name:"Cathedral",type:"PURPLE",pattern:[[d.NONE,d.WHEAT],[d.STONE,d.GLASS]],isMonument:!0,scorer:new Se(2,!1)},pa=[ra,oa,aa,la,ca,ha,ua,da,fa],kt=[...Lo,...Ni,...Ri,...Ai,...Oi,...Di,...ki,...pa];class As{grid;size=4;metadata=new Map;constructor(){this.grid=Array(this.size).fill(null).map(()=>Array(this.size).fill(d.NONE))}place(e,t,s){if(!this.isValid(e,t))throw new Error(`Invalid coordinate: ${e}, ${t}`);if(this.grid[e][t]!==d.NONE)throw new Error("Spot already occupied");this.grid[e][t]=s}placeBuilding(e,t,s){this.isValid(e,t)&&(this.grid[e][t]=s)}constructBuilding(e,t,s,i){if(!e.some(o=>o.row===t&&o.col===s)&&this.grid[t][s]!=="NONE")throw new Error("Building must be placed on one of the pattern squares.");this.clear(e),this.grid[t][s]=i}clear(e){e.forEach(({row:t,col:s})=>{this.isValid(t,s)&&(this.grid[t][s]=d.NONE,this.metadata.delete(`${t},${s}`))})}getGrid(){return this.grid.map(e=>[...e])}isValid(e,t){return e>=0&&e<this.size&&t>=0&&t<this.size}remove(e,t){this.isValid(e,t)&&(this.grid[e][t]="NONE",this.metadata.delete(`${e},${t}`))}setMetadata(e,t,s){this.metadata.set(`${e},${t}`,s)}getMetadata(e,t){return this.metadata.get(`${e},${t}`)}}class _a{static rotate(e){return e[0].map((t,s)=>e.map(i=>i[s]).reverse())}static flip(e){return e.map(t=>[...t].reverse())}static getSymmetries(e){const t=new Set;let s=e;for(let i=0;i<4;i++)t.add(JSON.stringify(s)),t.add(JSON.stringify(this.flip(s))),s=this.rotate(s);return Array.from(t).map(i=>JSON.parse(i))}static findMatches(e,t){const s=this.getSymmetries(t.pattern),i=[];for(const r of s){const o=r.length,a=r[0].length;for(let l=0;l<=4-o;l++)for(let c=0;c<=4-a;c++)this.isMatch(e,r,l,c)&&i.push({row:l,col:c,pattern:r})}return i}static isMatch(e,t,s,i){return t.every((r,o)=>r.every((a,l)=>{const c=e[s+o][i+l];return!!(a==="NONE"||c===a||c&&c.toUpperCase().replace("_"," ")==="TRADING POST")}))}}class ma{static calculateScore(e,t,s){const o={},a=E=>s.find(b=>b.name.toUpperCase()===E.toUpperCase()),l={};let c=0,f=0;const u=new Set;for(let E=0;E<4;E++)for(let b=0;b<4;b++){const M=e[E][b];if(!this.isBuilding(M)){c++;continue}l[M]=(l[M]||0)+1;const Y=a(M);if(Y&&Y.feeder){const ie=Y.feeder.getFedPositions(E,b,e);ie.length>0&&ie[0].r===-1?f+=ie.length:ie.forEach(ue=>u.add(`${ue.r},${ue.c}`))}}const h=new Set;let p=0;for(let E=0;E<4;E++)for(let b=0;b<4;b++){const M=e[E][b];if(!this.isBuilding(M))continue;const Y=a(M);if(Y&&Y.feedCost){const ie=`${E},${b}`;let ue=!1;u.has(ie)?ue=!0:f>=Y.feedCost&&(f-=Y.feedCost,ue=!0),ue&&(h.add(ie),M===q.COTTAGE&&p++,M===q.BARRETT_CASTLE&&(p+=2))}}const m=s.map(E=>E.name);for(let E=0;E<4;E++)for(let b=0;b<4;b++){const M=e[E][b];if(!this.isBuilding(M))continue;const Y=a(M);if(Y&&Y.scorer){const ie={grid:e,row:E,col:b,counts:l,fedState:h.has(`${E},${b}`),metadata:t,validBuildingNames:m,allFedPositions:h,registry:s,fedCottageCount:p},ue=Y.scorer.score(ie);o[M]=(o[M]||0)+ue}}if(l[q.TAVERN]){const E=[0,2,5,9,14,20],b=Math.min(l[q.TAVERN],5);o[q.TAVERN]=E[b]}let g=0;Object.values(o).forEach(E=>g+=E);const P=(l.CATHEDRAL||0)>0?0:c;return{total:g-P,breakdown:o,penaltyCount:P}}static isBuilding(e){return!["NONE","WOOD","WHEAT","BRICK","GLASS","STONE"].includes(e)}}class ga{board;currentResource=null;availableMatches=[];activeMonument=null;gameRegistry=[];lastMove=null;constructor(){this.board=new As}start(){if(this.board=new As,this.currentResource=null,this.lastMove=null,this.availableMatches=[],this.gameRegistry.length===0){const e=kt.filter(s=>s.isMonument),t=kt.filter(s=>!s.isMonument);this.activeMonument=e[Math.floor(Math.random()*e.length)],this.gameRegistry=[...t,this.activeMonument]}}placeResource(e,t){if(!this.currentResource)throw new Error("No resource selected");this.board.place(e,t,this.currentResource),this.lastMove={r:e,c:t},this.currentResource=null,this.scanForMatches()}constructBuilding(e,t,s){const i=[];let r=0,o=!1;if(e.pattern.forEach((a,l)=>{a.forEach((c,f)=>{c&&c!=="NONE"&&i.push({row:e.row+l,col:e.col+f})})}),e.buildingName.toUpperCase()==="SHRINE OF THE ELDER TREE"){o=!0;const l=this.countBuildingsOnBoard()+1;l<6?r=l:r=8}i.forEach(a=>{const l=this.board.getGrid()[a.row][a.col];l&&l.toUpperCase().replace("_"," ")==="TRADING POST"||this.board.remove(a.row,a.col)}),this.board.placeBuilding(t,s,e.buildingName),o&&this.board.setMetadata(t,s,{savedScore:r}),this.lastMove=null,this.scanForMatches()}undo(){this.lastMove&&(this.board.remove(this.lastMove.r,this.lastMove.c),this.lastMove=null,this.scanForMatches())}canUndo(){return this.lastMove!==null}scanForMatches(){this.availableMatches=[];const e=this.board.getGrid(),t=e.some(s=>s.some(i=>this.gameRegistry.find(o=>o.name.toUpperCase()===i.toUpperCase())?.isMonument));for(const s of this.gameRegistry){if(t&&s.isMonument)continue;_a.findMatches(e,s).forEach(r=>{this.availableMatches.push({...r,buildingName:s.name.toUpperCase()})})}}checkGameOver(){const t=this.board.getGrid().some(i=>i.some(r=>r==="NONE")),s=this.availableMatches.length>0;return!t&&!s}getScore(){return ma.calculateScore(this.board.getGrid(),this.board.metadata,this.gameRegistry)}countBuildingsOnBoard(){const e=this.board.getGrid();let t=0;const s=["WOOD","WHEAT","BRICK","GLASS","STONE","NONE"];return e.forEach(i=>{i.forEach(r=>{s.includes(r)||t++})}),t}hasObeliskAbility(){return this.board.getGrid().some(t=>t.some(s=>s.toUpperCase().includes("OBELISK")))}}class ya{boardEl=document.getElementById("board");buildMenuEl=document.getElementById("build-menu");msgLabel=document.getElementById("message");paletteEl=document.getElementById("resource-palette");scoreEl=document.getElementById("score-display");undoBtn=document.getElementById("undo-btn");deckDisplayEl=document.getElementById("deck-display");onCellClick=()=>{};onResourceSelect=()=>{};onBuildClick=()=>{};onCancelClick=()=>{};constructor(){}render(e,t,s,i){this.renderHeader(e),this.renderBoard(e,t,s,i),this.renderSidebar(e,t),this.renderControls(e,t)}renderHeader(e){const t=e.getScore(),s=t.total+t.penaltyCount;this.scoreEl.innerHTML=`Score: ${s} <span style="font-size:12px; color:#999">(-${t.penaltyCount} empty)</span>`}renderBoard(e,t,s,i){const r=e.board.getGrid(),o=["WOOD","WHEAT","BRICK","GLASS","STONE"];this.boardEl.children.length===0&&r.forEach((l,c)=>{l.forEach((f,u)=>{const h=document.createElement("div");h.dataset.r=c.toString(),h.dataset.c=u.toString(),h.onclick=()=>this.onCellClick(c,u),this.boardEl.appendChild(h)})}),Array.from(this.boardEl.children).forEach(l=>{const c=parseInt(l.dataset.r),f=parseInt(l.dataset.c),u=r[c][f];if(l.className="cell",l.style.backgroundColor="",u==="NONE")l.classList.add("empty"),l.textContent="";else if(o.includes(u))l.classList.add(u),l.textContent=u;else{l.textContent="";const h=e.gameRegistry.find(p=>p.name.toUpperCase()===u.toUpperCase());if(h){if(l.classList.add("constructed"),h.isMonument)l.classList.add("MONUMENT");else{const p=u.replace(/ /g,"-").replace(/'/g,"").toUpperCase();l.classList.add(p)}h.color&&(l.style.backgroundColor=h.color)}}if(t){const h=s.some(P=>P.row===c&&P.col===f),p=e.hasObeliskAbility(),m=t.buildingName.toUpperCase()==="SHED",g=(p||m)&&u==="NONE",w=u&&u.toUpperCase().replace("_"," ")==="TRADING POST";(h&&!w||g)&&l.classList.add("match-highlight")}u==="NONE"&&e.currentResource&&!t?(l.onmouseenter=()=>{l.classList.add("ghost",e.currentResource)},l.onmouseleave=()=>{l.classList.remove("ghost","WOOD","WHEAT","BRICK","GLASS","STONE")}):(l.onmouseenter=null,l.onmouseleave=null)}),t?(this.msgLabel.textContent=`Select a highlighted square to build your ${t.buildingName}!`,this.msgLabel.style.color="#d32f2f"):i?(this.msgLabel.textContent=i,i.includes("Waiting")?this.msgLabel.style.color="#d32f2f":i.includes("YOU")?this.msgLabel.style.color="#2e7d32":this.msgLabel.style.color="#333"):e.availableMatches.length>0?(this.msgLabel.textContent="Matches available!",this.msgLabel.style.color="#333"):e.currentResource?(this.msgLabel.textContent=`Place ${e.currentResource}...`,this.msgLabel.style.color="#333"):(this.msgLabel.textContent="Select a Resource...",this.msgLabel.style.color="#1976d2")}renderSidebar(e,t){if(this.buildMenuEl.innerHTML="",e.availableMatches.length===0){const s=document.createElement("p");s.textContent="No patterns found.",s.style.color="#777",s.style.fontStyle="italic",this.buildMenuEl.appendChild(s)}else e.availableMatches.forEach(s=>{const i=document.createElement("button");i.textContent=`Build ${s.buildingName}`;const r=s.buildingName.replace(/ /g,"-").replace(/'/g,"").toUpperCase();i.className=`build-btn ${r}`,i.onclick=()=>this.onBuildClick(s);const o=[];s.pattern&&Array.isArray(s.pattern)?s.pattern.forEach((a,l)=>{a.forEach((c,f)=>{c&&c!=="NONE"&&o.push({row:s.row+l,col:s.col+f})})}):o.push({row:s.row,col:s.col}),i.onmouseenter=()=>this.togglePreview(o,!0),i.onmouseleave=()=>this.togglePreview(o,!1),this.buildMenuEl.appendChild(i)});if(t){const s=document.createElement("button");s.textContent="Cancel Construction",s.className="secondary-btn",s.style.marginTop="10px",s.style.width="100%",s.onclick=()=>this.onCancelClick(),this.buildMenuEl.appendChild(s)}}togglePreview(e,t){e.forEach(s=>{const i=`div[data-r="${s.row}"][data-c="${s.col}"]`,r=this.boardEl.querySelector(i);r&&(t?r.classList.add("preview-target"):r.classList.remove("preview-target"))})}renderControls(e,t){this.paletteEl.innerHTML="",[d.WOOD,d.WHEAT,d.BRICK,d.GLASS,d.STONE].forEach(i=>{const r=document.createElement("div");let o=`res-btn ${i}`;e.currentResource===i&&!t&&(o+=" selected"),r.className=o,r.textContent=i.charAt(0),r.onclick=()=>this.onResourceSelect(i),this.paletteEl.appendChild(r)}),e.canUndo()&&!t?this.undoBtn.removeAttribute("disabled"):this.undoBtn.setAttribute("disabled","true")}renderDeck(e){this.deckDisplayEl&&(this.deckDisplayEl.innerHTML="",e.forEach(t=>{const s=document.createElement("div");t.isMonument?s.className="building-card MONUMENT":s.className=`building-card ${t.name.toUpperCase()}`;const i=document.createElement("header");i.className="card-header";const r=document.createElement("span");r.textContent=t.name;const o=document.createElement("div"),a=t.name.replace(/ /g,"-").replace(/'/g,"").toUpperCase();o.className=`card-icon ${a}`,i.appendChild(r),i.appendChild(o),s.appendChild(i);const l=document.createElement("div");l.className="card-body";const c=document.createElement("div");c.className="mini-pattern";const f=t.pattern[0].length;c.style.gridTemplateColumns=`repeat(${f}, 15px)`,t.pattern.forEach(h=>{h.forEach(p=>{const m=document.createElement("div"),g=p==="NONE"?"pattern-empty":p;m.className=`pattern-cell ${g}`,c.appendChild(m)})});const u=document.createElement("div");u.className="card-text",u.textContent=t.description||"Unique scoring rules.",l.appendChild(c),l.appendChild(u),s.appendChild(l),this.deckDisplayEl.appendChild(s)}))}}const Ea=()=>{};var Os={};const Pi={NODE_ADMIN:!1,SDK_VERSION:"${JSCORE_VERSION}"};const _=function(n,e){if(!n)throw je(e)},je=function(n){return new Error("Firebase Database ("+Pi.SDK_VERSION+") INTERNAL ASSERT FAILED: "+n)};const Li=function(n){const e=[];let t=0;for(let s=0;s<n.length;s++){let i=n.charCodeAt(s);i<128?e[t++]=i:i<2048?(e[t++]=i>>6|192,e[t++]=i&63|128):(i&64512)===55296&&s+1<n.length&&(n.charCodeAt(s+1)&64512)===56320?(i=65536+((i&1023)<<10)+(n.charCodeAt(++s)&1023),e[t++]=i>>18|240,e[t++]=i>>12&63|128,e[t++]=i>>6&63|128,e[t++]=i&63|128):(e[t++]=i>>12|224,e[t++]=i>>6&63|128,e[t++]=i&63|128)}return e},Ca=function(n){const e=[];let t=0,s=0;for(;t<n.length;){const i=n[t++];if(i<128)e[s++]=String.fromCharCode(i);else if(i>191&&i<224){const r=n[t++];e[s++]=String.fromCharCode((i&31)<<6|r&63)}else if(i>239&&i<365){const r=n[t++],o=n[t++],a=n[t++],l=((i&7)<<18|(r&63)<<12|(o&63)<<6|a&63)-65536;e[s++]=String.fromCharCode(55296+(l>>10)),e[s++]=String.fromCharCode(56320+(l&1023))}else{const r=n[t++],o=n[t++];e[s++]=String.fromCharCode((i&15)<<12|(r&63)<<6|o&63)}}return e.join("")},jn={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:typeof atob=="function",encodeByteArray(n,e){if(!Array.isArray(n))throw Error("encodeByteArray takes an array as a parameter");this.init_();const t=e?this.byteToCharMapWebSafe_:this.byteToCharMap_,s=[];for(let i=0;i<n.length;i+=3){const r=n[i],o=i+1<n.length,a=o?n[i+1]:0,l=i+2<n.length,c=l?n[i+2]:0,f=r>>2,u=(r&3)<<4|a>>4;let h=(a&15)<<2|c>>6,p=c&63;l||(p=64,o||(h=64)),s.push(t[f],t[u],t[h],t[p])}return s.join("")},encodeString(n,e){return this.HAS_NATIVE_SUPPORT&&!e?btoa(n):this.encodeByteArray(Li(n),e)},decodeString(n,e){return this.HAS_NATIVE_SUPPORT&&!e?atob(n):Ca(this.decodeStringToByteArray(n,e))},decodeStringToByteArray(n,e){this.init_();const t=e?this.charToByteMapWebSafe_:this.charToByteMap_,s=[];for(let i=0;i<n.length;){const r=t[n.charAt(i++)],a=i<n.length?t[n.charAt(i)]:0;++i;const c=i<n.length?t[n.charAt(i)]:64;++i;const u=i<n.length?t[n.charAt(i)]:64;if(++i,r==null||a==null||c==null||u==null)throw new va;const h=r<<2|a>>4;if(s.push(h),c!==64){const p=a<<4&240|c>>2;if(s.push(p),u!==64){const m=c<<6&192|u;s.push(m)}}}return s},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let n=0;n<this.ENCODED_VALS.length;n++)this.byteToCharMap_[n]=this.ENCODED_VALS.charAt(n),this.charToByteMap_[this.byteToCharMap_[n]]=n,this.byteToCharMapWebSafe_[n]=this.ENCODED_VALS_WEBSAFE.charAt(n),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[n]]=n,n>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(n)]=n,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(n)]=n)}}};class va extends Error{constructor(){super(...arguments),this.name="DecodeBase64StringError"}}const Mi=function(n){const e=Li(n);return jn.encodeByteArray(e,!0)},Pt=function(n){return Mi(n).replace(/\./g,"")},wn=function(n){try{return jn.decodeString(n,!0)}catch(e){console.error("base64Decode failed: ",e)}return null};function Sa(n){return xi(void 0,n)}function xi(n,e){if(!(e instanceof Object))return e;switch(e.constructor){case Date:const t=e;return new Date(t.getTime());case Object:n===void 0&&(n={});break;case Array:n=[];break;default:return e}for(const t in e)!e.hasOwnProperty(t)||!Ia(t)||(n[t]=xi(n[t],e[t]));return n}function Ia(n){return n!=="__proto__"}function ba(){if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global;throw new Error("Unable to locate global object.")}const wa=()=>ba().__FIREBASE_DEFAULTS__,Ta=()=>{if(typeof process>"u"||typeof Os>"u")return;const n=Os.__FIREBASE_DEFAULTS__;if(n)return JSON.parse(n)},Na=()=>{if(typeof document>"u")return;let n;try{n=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch{return}const e=n&&wn(n[1]);return e&&JSON.parse(e)},Bi=()=>{try{return Ea()||wa()||Ta()||Na()}catch(n){console.info(`Unable to get __FIREBASE_DEFAULTS__ due to: ${n}`);return}},Ra=n=>Bi()?.emulatorHosts?.[n],Aa=n=>{const e=Ra(n);if(!e)return;const t=e.lastIndexOf(":");if(t<=0||t+1===e.length)throw new Error(`Invalid host ${e} with no separate hostname and port!`);const s=parseInt(e.substring(t+1),10);return e[0]==="["?[e.substring(1,t-1),s]:[e.substring(0,t),s]},Fi=()=>Bi()?.config;class te{constructor(){this.reject=()=>{},this.resolve=()=>{},this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}wrapCallback(e){return(t,s)=>{t?this.reject(t):this.resolve(s),typeof e=="function"&&(this.promise.catch(()=>{}),e.length===1?e(t):e(t,s))}}}function Yn(n){try{return(n.startsWith("http://")||n.startsWith("https://")?new URL(n).hostname:n).endsWith(".cloudworkstations.dev")}catch{return!1}}async function Oa(n){return(await fetch(n,{credentials:"include"})).ok}function Da(n,e){if(n.uid)throw new Error('The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.');const t={alg:"none",type:"JWT"},s=e||"demo-project",i=n.iat||0,r=n.sub||n.user_id;if(!r)throw new Error("mockUserToken must contain 'sub' or 'user_id' field!");const o={iss:`https://securetoken.google.com/${s}`,aud:s,iat:i,exp:i+3600,auth_time:i,sub:r,user_id:r,firebase:{sign_in_provider:"custom",identities:{}},...n};return[Pt(JSON.stringify(t)),Pt(JSON.stringify(o)),""].join(".")}const it={};function ka(){const n={prod:[],emulator:[]};for(const e of Object.keys(it))it[e]?n.emulator.push(e):n.prod.push(e);return n}function Pa(n){let e=document.getElementById(n),t=!1;return e||(e=document.createElement("div"),e.setAttribute("id",n),t=!0),{created:t,element:e}}let Ds=!1;function La(n,e){if(typeof window>"u"||typeof document>"u"||!Yn(window.location.host)||it[n]===e||it[n]||Ds)return;it[n]=e;function t(h){return`__firebase__banner__${h}`}const s="__firebase__banner",r=ka().prod.length>0;function o(){const h=document.getElementById(s);h&&h.remove()}function a(h){h.style.display="flex",h.style.background="#7faaf0",h.style.position="fixed",h.style.bottom="5px",h.style.left="5px",h.style.padding=".5em",h.style.borderRadius="5px",h.style.alignItems="center"}function l(h,p){h.setAttribute("width","24"),h.setAttribute("id",p),h.setAttribute("height","24"),h.setAttribute("viewBox","0 0 24 24"),h.setAttribute("fill","none"),h.style.marginLeft="-6px"}function c(){const h=document.createElement("span");return h.style.cursor="pointer",h.style.marginLeft="16px",h.style.fontSize="24px",h.innerHTML=" &times;",h.onclick=()=>{Ds=!0,o()},h}function f(h,p){h.setAttribute("id",p),h.innerText="Learn more",h.href="https://firebase.google.com/docs/studio/preview-apps#preview-backend",h.setAttribute("target","__blank"),h.style.paddingLeft="5px",h.style.textDecoration="underline"}function u(){const h=Pa(s),p=t("text"),m=document.getElementById(p)||document.createElement("span"),g=t("learnmore"),w=document.getElementById(g)||document.createElement("a"),P=t("preprendIcon"),E=document.getElementById(P)||document.createElementNS("http://www.w3.org/2000/svg","svg");if(h.created){const b=h.element;a(b),f(w,g);const M=c();l(E,P),b.append(E,m,w,M),document.body.appendChild(b)}r?(m.innerText="Preview backend disconnected.",E.innerHTML=`<g clip-path="url(#clip0_6013_33858)">
<path d="M4.8 17.6L12 5.6L19.2 17.6H4.8ZM6.91667 16.4H17.0833L12 7.93333L6.91667 16.4ZM12 15.6C12.1667 15.6 12.3056 15.5444 12.4167 15.4333C12.5389 15.3111 12.6 15.1667 12.6 15C12.6 14.8333 12.5389 14.6944 12.4167 14.5833C12.3056 14.4611 12.1667 14.4 12 14.4C11.8333 14.4 11.6889 14.4611 11.5667 14.5833C11.4556 14.6944 11.4 14.8333 11.4 15C11.4 15.1667 11.4556 15.3111 11.5667 15.4333C11.6889 15.5444 11.8333 15.6 12 15.6ZM11.4 13.6H12.6V10.4H11.4V13.6Z" fill="#212121"/>
</g>
<defs>
<clipPath id="clip0_6013_33858">
<rect width="24" height="24" fill="white"/>
</clipPath>
</defs>`):(E.innerHTML=`<g clip-path="url(#clip0_6083_34804)">
<path d="M11.4 15.2H12.6V11.2H11.4V15.2ZM12 10C12.1667 10 12.3056 9.94444 12.4167 9.83333C12.5389 9.71111 12.6 9.56667 12.6 9.4C12.6 9.23333 12.5389 9.09444 12.4167 8.98333C12.3056 8.86111 12.1667 8.8 12 8.8C11.8333 8.8 11.6889 8.86111 11.5667 8.98333C11.4556 9.09444 11.4 9.23333 11.4 9.4C11.4 9.56667 11.4556 9.71111 11.5667 9.83333C11.6889 9.94444 11.8333 10 12 10ZM12 18.4C11.1222 18.4 10.2944 18.2333 9.51667 17.9C8.73889 17.5667 8.05556 17.1111 7.46667 16.5333C6.88889 15.9444 6.43333 15.2611 6.1 14.4833C5.76667 13.7056 5.6 12.8778 5.6 12C5.6 11.1111 5.76667 10.2833 6.1 9.51667C6.43333 8.73889 6.88889 8.06111 7.46667 7.48333C8.05556 6.89444 8.73889 6.43333 9.51667 6.1C10.2944 5.76667 11.1222 5.6 12 5.6C12.8889 5.6 13.7167 5.76667 14.4833 6.1C15.2611 6.43333 15.9389 6.89444 16.5167 7.48333C17.1056 8.06111 17.5667 8.73889 17.9 9.51667C18.2333 10.2833 18.4 11.1111 18.4 12C18.4 12.8778 18.2333 13.7056 17.9 14.4833C17.5667 15.2611 17.1056 15.9444 16.5167 16.5333C15.9389 17.1111 15.2611 17.5667 14.4833 17.9C13.7167 18.2333 12.8889 18.4 12 18.4ZM12 17.2C13.4444 17.2 14.6722 16.6944 15.6833 15.6833C16.6944 14.6722 17.2 13.4444 17.2 12C17.2 10.5556 16.6944 9.32778 15.6833 8.31667C14.6722 7.30555 13.4444 6.8 12 6.8C10.5556 6.8 9.32778 7.30555 8.31667 8.31667C7.30556 9.32778 6.8 10.5556 6.8 12C6.8 13.4444 7.30556 14.6722 8.31667 15.6833C9.32778 16.6944 10.5556 17.2 12 17.2Z" fill="#212121"/>
</g>
<defs>
<clipPath id="clip0_6083_34804">
<rect width="24" height="24" fill="white"/>
</clipPath>
</defs>`,m.innerText="Preview backend running in this workspace."),m.setAttribute("id",p)}document.readyState==="loading"?window.addEventListener("DOMContentLoaded",u):u()}function Ma(){return typeof navigator<"u"&&typeof navigator.userAgent=="string"?navigator.userAgent:""}function Wi(){return typeof window<"u"&&!!(window.cordova||window.phonegap||window.PhoneGap)&&/ios|iphone|ipod|ipad|android|blackberry|iemobile/i.test(Ma())}function xa(){return typeof navigator=="object"&&navigator.product==="ReactNative"}function Ba(){return Pi.NODE_ADMIN===!0}function Fa(){try{return typeof indexedDB=="object"}catch{return!1}}function Wa(){return new Promise((n,e)=>{try{let t=!0;const s="validate-browser-context-for-indexeddb-analytics-module",i=self.indexedDB.open(s);i.onsuccess=()=>{i.result.close(),t||self.indexedDB.deleteDatabase(s),n(!0)},i.onupgradeneeded=()=>{t=!1},i.onerror=()=>{e(i.error?.message||"")}}catch(t){e(t)}})}const Ga="FirebaseError";class St extends Error{constructor(e,t,s){super(t),this.code=e,this.customData=s,this.name=Ga,Object.setPrototypeOf(this,St.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,Gi.prototype.create)}}class Gi{constructor(e,t,s){this.service=e,this.serviceName=t,this.errors=s}create(e,...t){const s=t[0]||{},i=`${this.service}/${e}`,r=this.errors[e],o=r?Ua(r,s):"Error",a=`${this.serviceName}: ${o} (${i}).`;return new St(i,a,s)}}function Ua(n,e){return n.replace(Ha,(t,s)=>{const i=e[s];return i!=null?String(i):`<${s}?>`})}const Ha=/\{\$([^}]+)}/g;function ht(n){return JSON.parse(n)}function x(n){return JSON.stringify(n)}const Ui=function(n){let e={},t={},s={},i="";try{const r=n.split(".");e=ht(wn(r[0])||""),t=ht(wn(r[1])||""),i=r[2],s=t.d||{},delete t.d}catch{}return{header:e,claims:t,data:s,signature:i}},$a=function(n){const e=Ui(n),t=e.claims;return!!t&&typeof t=="object"&&t.hasOwnProperty("iat")},Va=function(n){const e=Ui(n).claims;return typeof e=="object"&&e.admin===!0};function se(n,e){return Object.prototype.hasOwnProperty.call(n,e)}function Ge(n,e){if(Object.prototype.hasOwnProperty.call(n,e))return n[e]}function Tn(n){for(const e in n)if(Object.prototype.hasOwnProperty.call(n,e))return!1;return!0}function Lt(n,e,t){const s={};for(const i in n)Object.prototype.hasOwnProperty.call(n,i)&&(s[i]=e.call(t,n[i],i,n));return s}function Mt(n,e){if(n===e)return!0;const t=Object.keys(n),s=Object.keys(e);for(const i of t){if(!s.includes(i))return!1;const r=n[i],o=e[i];if(ks(r)&&ks(o)){if(!Mt(r,o))return!1}else if(r!==o)return!1}for(const i of s)if(!t.includes(i))return!1;return!0}function ks(n){return n!==null&&typeof n=="object"}function Ka(n){const e=[];for(const[t,s]of Object.entries(n))Array.isArray(s)?s.forEach(i=>{e.push(encodeURIComponent(t)+"="+encodeURIComponent(i))}):e.push(encodeURIComponent(t)+"="+encodeURIComponent(s));return e.length?"&"+e.join("&"):""}class za{constructor(){this.chain_=[],this.buf_=[],this.W_=[],this.pad_=[],this.inbuf_=0,this.total_=0,this.blockSize=512/8,this.pad_[0]=128;for(let e=1;e<this.blockSize;++e)this.pad_[e]=0;this.reset()}reset(){this.chain_[0]=1732584193,this.chain_[1]=4023233417,this.chain_[2]=2562383102,this.chain_[3]=271733878,this.chain_[4]=3285377520,this.inbuf_=0,this.total_=0}compress_(e,t){t||(t=0);const s=this.W_;if(typeof e=="string")for(let u=0;u<16;u++)s[u]=e.charCodeAt(t)<<24|e.charCodeAt(t+1)<<16|e.charCodeAt(t+2)<<8|e.charCodeAt(t+3),t+=4;else for(let u=0;u<16;u++)s[u]=e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3],t+=4;for(let u=16;u<80;u++){const h=s[u-3]^s[u-8]^s[u-14]^s[u-16];s[u]=(h<<1|h>>>31)&4294967295}let i=this.chain_[0],r=this.chain_[1],o=this.chain_[2],a=this.chain_[3],l=this.chain_[4],c,f;for(let u=0;u<80;u++){u<40?u<20?(c=a^r&(o^a),f=1518500249):(c=r^o^a,f=1859775393):u<60?(c=r&o|a&(r|o),f=2400959708):(c=r^o^a,f=3395469782);const h=(i<<5|i>>>27)+c+l+f+s[u]&4294967295;l=a,a=o,o=(r<<30|r>>>2)&4294967295,r=i,i=h}this.chain_[0]=this.chain_[0]+i&4294967295,this.chain_[1]=this.chain_[1]+r&4294967295,this.chain_[2]=this.chain_[2]+o&4294967295,this.chain_[3]=this.chain_[3]+a&4294967295,this.chain_[4]=this.chain_[4]+l&4294967295}update(e,t){if(e==null)return;t===void 0&&(t=e.length);const s=t-this.blockSize;let i=0;const r=this.buf_;let o=this.inbuf_;for(;i<t;){if(o===0)for(;i<=s;)this.compress_(e,i),i+=this.blockSize;if(typeof e=="string"){for(;i<t;)if(r[o]=e.charCodeAt(i),++o,++i,o===this.blockSize){this.compress_(r),o=0;break}}else for(;i<t;)if(r[o]=e[i],++o,++i,o===this.blockSize){this.compress_(r),o=0;break}}this.inbuf_=o,this.total_+=t}digest(){const e=[];let t=this.total_*8;this.inbuf_<56?this.update(this.pad_,56-this.inbuf_):this.update(this.pad_,this.blockSize-(this.inbuf_-56));for(let i=this.blockSize-1;i>=56;i--)this.buf_[i]=t&255,t/=256;this.compress_(this.buf_);let s=0;for(let i=0;i<5;i++)for(let r=24;r>=0;r-=8)e[s]=this.chain_[i]>>r&255,++s;return e}}function Ue(n,e){return`${n} failed: ${e} argument `}const ja=function(n){const e=[];let t=0;for(let s=0;s<n.length;s++){let i=n.charCodeAt(s);if(i>=55296&&i<=56319){const r=i-55296;s++,_(s<n.length,"Surrogate pair missing trail surrogate.");const o=n.charCodeAt(s)-56320;i=65536+(r<<10)+o}i<128?e[t++]=i:i<2048?(e[t++]=i>>6|192,e[t++]=i&63|128):i<65536?(e[t++]=i>>12|224,e[t++]=i>>6&63|128,e[t++]=i&63|128):(e[t++]=i>>18|240,e[t++]=i>>12&63|128,e[t++]=i>>6&63|128,e[t++]=i&63|128)}return e},Jt=function(n){let e=0;for(let t=0;t<n.length;t++){const s=n.charCodeAt(t);s<128?e++:s<2048?e+=2:s>=55296&&s<=56319?(e+=4,t++):e+=3}return e};function Ie(n){return n&&n._delegate?n._delegate:n}class ut{constructor(e,t,s){this.name=e,this.instanceFactory=t,this.type=s,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(e){return this.instantiationMode=e,this}setMultipleInstances(e){return this.multipleInstances=e,this}setServiceProps(e){return this.serviceProps=e,this}setInstanceCreatedCallback(e){return this.onInstanceCreated=e,this}}const be="[DEFAULT]";class Ya{constructor(e,t){this.name=e,this.container=t,this.component=null,this.instances=new Map,this.instancesDeferred=new Map,this.instancesOptions=new Map,this.onInitCallbacks=new Map}get(e){const t=this.normalizeInstanceIdentifier(e);if(!this.instancesDeferred.has(t)){const s=new te;if(this.instancesDeferred.set(t,s),this.isInitialized(t)||this.shouldAutoInitialize())try{const i=this.getOrInitializeService({instanceIdentifier:t});i&&s.resolve(i)}catch{}}return this.instancesDeferred.get(t).promise}getImmediate(e){const t=this.normalizeInstanceIdentifier(e?.identifier),s=e?.optional??!1;if(this.isInitialized(t)||this.shouldAutoInitialize())try{return this.getOrInitializeService({instanceIdentifier:t})}catch(i){if(s)return null;throw i}else{if(s)return null;throw Error(`Service ${this.name} is not available`)}}getComponent(){return this.component}setComponent(e){if(e.name!==this.name)throw Error(`Mismatching Component ${e.name} for Provider ${this.name}.`);if(this.component)throw Error(`Component for ${this.name} has already been provided`);if(this.component=e,!!this.shouldAutoInitialize()){if(Qa(e))try{this.getOrInitializeService({instanceIdentifier:be})}catch{}for(const[t,s]of this.instancesDeferred.entries()){const i=this.normalizeInstanceIdentifier(t);try{const r=this.getOrInitializeService({instanceIdentifier:i});s.resolve(r)}catch{}}}}clearInstance(e=be){this.instancesDeferred.delete(e),this.instancesOptions.delete(e),this.instances.delete(e)}async delete(){const e=Array.from(this.instances.values());await Promise.all([...e.filter(t=>"INTERNAL"in t).map(t=>t.INTERNAL.delete()),...e.filter(t=>"_delete"in t).map(t=>t._delete())])}isComponentSet(){return this.component!=null}isInitialized(e=be){return this.instances.has(e)}getOptions(e=be){return this.instancesOptions.get(e)||{}}initialize(e={}){const{options:t={}}=e,s=this.normalizeInstanceIdentifier(e.instanceIdentifier);if(this.isInitialized(s))throw Error(`${this.name}(${s}) has already been initialized`);if(!this.isComponentSet())throw Error(`Component ${this.name} has not been registered yet`);const i=this.getOrInitializeService({instanceIdentifier:s,options:t});for(const[r,o]of this.instancesDeferred.entries()){const a=this.normalizeInstanceIdentifier(r);s===a&&o.resolve(i)}return i}onInit(e,t){const s=this.normalizeInstanceIdentifier(t),i=this.onInitCallbacks.get(s)??new Set;i.add(e),this.onInitCallbacks.set(s,i);const r=this.instances.get(s);return r&&e(r,s),()=>{i.delete(e)}}invokeOnInitCallbacks(e,t){const s=this.onInitCallbacks.get(t);if(s)for(const i of s)try{i(e,t)}catch{}}getOrInitializeService({instanceIdentifier:e,options:t={}}){let s=this.instances.get(e);if(!s&&this.component&&(s=this.component.instanceFactory(this.container,{instanceIdentifier:qa(e),options:t}),this.instances.set(e,s),this.instancesOptions.set(e,t),this.invokeOnInitCallbacks(s,e),this.component.onInstanceCreated))try{this.component.onInstanceCreated(this.container,e,s)}catch{}return s||null}normalizeInstanceIdentifier(e=be){return this.component?this.component.multipleInstances?e:be:e}shouldAutoInitialize(){return!!this.component&&this.component.instantiationMode!=="EXPLICIT"}}function qa(n){return n===be?void 0:n}function Qa(n){return n.instantiationMode==="EAGER"}class Xa{constructor(e){this.name=e,this.providers=new Map}addComponent(e){const t=this.getProvider(e.name);if(t.isComponentSet())throw new Error(`Component ${e.name} has already been registered with ${this.name}`);t.setComponent(e)}addOrOverwriteComponent(e){this.getProvider(e.name).isComponentSet()&&this.providers.delete(e.name),this.addComponent(e)}getProvider(e){if(this.providers.has(e))return this.providers.get(e);const t=new Ya(e,this);return this.providers.set(e,t),t}getProviders(){return Array.from(this.providers.values())}}var O;(function(n){n[n.DEBUG=0]="DEBUG",n[n.VERBOSE=1]="VERBOSE",n[n.INFO=2]="INFO",n[n.WARN=3]="WARN",n[n.ERROR=4]="ERROR",n[n.SILENT=5]="SILENT"})(O||(O={}));const Ja={debug:O.DEBUG,verbose:O.VERBOSE,info:O.INFO,warn:O.WARN,error:O.ERROR,silent:O.SILENT},Za=O.INFO,el={[O.DEBUG]:"log",[O.VERBOSE]:"log",[O.INFO]:"info",[O.WARN]:"warn",[O.ERROR]:"error"},tl=(n,e,...t)=>{if(e<n.logLevel)return;const s=new Date().toISOString(),i=el[e];if(i)console[i](`[${s}]  ${n.name}:`,...t);else throw new Error(`Attempted to log a message with an invalid logType (value: ${e})`)};class Hi{constructor(e){this.name=e,this._logLevel=Za,this._logHandler=tl,this._userLogHandler=null}get logLevel(){return this._logLevel}set logLevel(e){if(!(e in O))throw new TypeError(`Invalid value "${e}" assigned to \`logLevel\``);this._logLevel=e}setLogLevel(e){this._logLevel=typeof e=="string"?Ja[e]:e}get logHandler(){return this._logHandler}set logHandler(e){if(typeof e!="function")throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=e}get userLogHandler(){return this._userLogHandler}set userLogHandler(e){this._userLogHandler=e}debug(...e){this._userLogHandler&&this._userLogHandler(this,O.DEBUG,...e),this._logHandler(this,O.DEBUG,...e)}log(...e){this._userLogHandler&&this._userLogHandler(this,O.VERBOSE,...e),this._logHandler(this,O.VERBOSE,...e)}info(...e){this._userLogHandler&&this._userLogHandler(this,O.INFO,...e),this._logHandler(this,O.INFO,...e)}warn(...e){this._userLogHandler&&this._userLogHandler(this,O.WARN,...e),this._logHandler(this,O.WARN,...e)}error(...e){this._userLogHandler&&this._userLogHandler(this,O.ERROR,...e),this._logHandler(this,O.ERROR,...e)}}const nl=(n,e)=>e.some(t=>n instanceof t);let Ps,Ls;function sl(){return Ps||(Ps=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function il(){return Ls||(Ls=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const $i=new WeakMap,Nn=new WeakMap,Vi=new WeakMap,fn=new WeakMap,qn=new WeakMap;function rl(n){const e=new Promise((t,s)=>{const i=()=>{n.removeEventListener("success",r),n.removeEventListener("error",o)},r=()=>{t(pe(n.result)),i()},o=()=>{s(n.error),i()};n.addEventListener("success",r),n.addEventListener("error",o)});return e.then(t=>{t instanceof IDBCursor&&$i.set(t,n)}).catch(()=>{}),qn.set(e,n),e}function ol(n){if(Nn.has(n))return;const e=new Promise((t,s)=>{const i=()=>{n.removeEventListener("complete",r),n.removeEventListener("error",o),n.removeEventListener("abort",o)},r=()=>{t(),i()},o=()=>{s(n.error||new DOMException("AbortError","AbortError")),i()};n.addEventListener("complete",r),n.addEventListener("error",o),n.addEventListener("abort",o)});Nn.set(n,e)}let Rn={get(n,e,t){if(n instanceof IDBTransaction){if(e==="done")return Nn.get(n);if(e==="objectStoreNames")return n.objectStoreNames||Vi.get(n);if(e==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return pe(n[e])},set(n,e,t){return n[e]=t,!0},has(n,e){return n instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in n}};function al(n){Rn=n(Rn)}function ll(n){return n===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(e,...t){const s=n.call(pn(this),e,...t);return Vi.set(s,e.sort?e.sort():[e]),pe(s)}:il().includes(n)?function(...e){return n.apply(pn(this),e),pe($i.get(this))}:function(...e){return pe(n.apply(pn(this),e))}}function cl(n){return typeof n=="function"?ll(n):(n instanceof IDBTransaction&&ol(n),nl(n,sl())?new Proxy(n,Rn):n)}function pe(n){if(n instanceof IDBRequest)return rl(n);if(fn.has(n))return fn.get(n);const e=cl(n);return e!==n&&(fn.set(n,e),qn.set(e,n)),e}const pn=n=>qn.get(n);function hl(n,e,{blocked:t,upgrade:s,blocking:i,terminated:r}={}){const o=indexedDB.open(n,e),a=pe(o);return s&&o.addEventListener("upgradeneeded",l=>{s(pe(o.result),l.oldVersion,l.newVersion,pe(o.transaction),l)}),t&&o.addEventListener("blocked",l=>t(l.oldVersion,l.newVersion,l)),a.then(l=>{r&&l.addEventListener("close",()=>r()),i&&l.addEventListener("versionchange",c=>i(c.oldVersion,c.newVersion,c))}).catch(()=>{}),a}const ul=["get","getKey","getAll","getAllKeys","count"],dl=["put","add","delete","clear"],_n=new Map;function Ms(n,e){if(!(n instanceof IDBDatabase&&!(e in n)&&typeof e=="string"))return;if(_n.get(e))return _n.get(e);const t=e.replace(/FromIndex$/,""),s=e!==t,i=dl.includes(t);if(!(t in(s?IDBIndex:IDBObjectStore).prototype)||!(i||ul.includes(t)))return;const r=async function(o,...a){const l=this.transaction(o,i?"readwrite":"readonly");let c=l.store;return s&&(c=c.index(a.shift())),(await Promise.all([c[t](...a),i&&l.done]))[0]};return _n.set(e,r),r}al(n=>({...n,get:(e,t,s)=>Ms(e,t)||n.get(e,t,s),has:(e,t)=>!!Ms(e,t)||n.has(e,t)}));class fl{constructor(e){this.container=e}getPlatformInfoString(){return this.container.getProviders().map(t=>{if(pl(t)){const s=t.getImmediate();return`${s.library}/${s.version}`}else return null}).filter(t=>t).join(" ")}}function pl(n){return n.getComponent()?.type==="VERSION"}const An="@firebase/app",xs="0.14.7";const le=new Hi("@firebase/app"),_l="@firebase/app-compat",ml="@firebase/analytics-compat",gl="@firebase/analytics",yl="@firebase/app-check-compat",El="@firebase/app-check",Cl="@firebase/auth",vl="@firebase/auth-compat",Sl="@firebase/database",Il="@firebase/data-connect",bl="@firebase/database-compat",wl="@firebase/functions",Tl="@firebase/functions-compat",Nl="@firebase/installations",Rl="@firebase/installations-compat",Al="@firebase/messaging",Ol="@firebase/messaging-compat",Dl="@firebase/performance",kl="@firebase/performance-compat",Pl="@firebase/remote-config",Ll="@firebase/remote-config-compat",Ml="@firebase/storage",xl="@firebase/storage-compat",Bl="@firebase/firestore",Fl="@firebase/ai",Wl="@firebase/firestore-compat",Gl="firebase",Ul="12.8.0";const On="[DEFAULT]",Hl={[An]:"fire-core",[_l]:"fire-core-compat",[gl]:"fire-analytics",[ml]:"fire-analytics-compat",[El]:"fire-app-check",[yl]:"fire-app-check-compat",[Cl]:"fire-auth",[vl]:"fire-auth-compat",[Sl]:"fire-rtdb",[Il]:"fire-data-connect",[bl]:"fire-rtdb-compat",[wl]:"fire-fn",[Tl]:"fire-fn-compat",[Nl]:"fire-iid",[Rl]:"fire-iid-compat",[Al]:"fire-fcm",[Ol]:"fire-fcm-compat",[Dl]:"fire-perf",[kl]:"fire-perf-compat",[Pl]:"fire-rc",[Ll]:"fire-rc-compat",[Ml]:"fire-gcs",[xl]:"fire-gcs-compat",[Bl]:"fire-fst",[Wl]:"fire-fst-compat",[Fl]:"fire-vertex","fire-js":"fire-js",[Gl]:"fire-js-all"};const xt=new Map,$l=new Map,Dn=new Map;function Bs(n,e){try{n.container.addComponent(e)}catch(t){le.debug(`Component ${e.name} failed to register with FirebaseApp ${n.name}`,t)}}function Bt(n){const e=n.name;if(Dn.has(e))return le.debug(`There were multiple attempts to register component ${e}.`),!1;Dn.set(e,n);for(const t of xt.values())Bs(t,n);for(const t of $l.values())Bs(t,n);return!0}function Vl(n,e){const t=n.container.getProvider("heartbeat").getImmediate({optional:!0});return t&&t.triggerHeartbeat(),n.container.getProvider(e)}function Kl(n){return n==null?!1:n.settings!==void 0}const zl={"no-app":"No Firebase App '{$appName}' has been created - call initializeApp() first","bad-app-name":"Illegal App name: '{$appName}'","duplicate-app":"Firebase App named '{$appName}' already exists with different options or config","app-deleted":"Firebase App named '{$appName}' already deleted","server-app-deleted":"Firebase Server App has been deleted","no-options":"Need to provide options, when not being deployed to hosting via source.","invalid-app-argument":"firebase.{$appName}() takes either no argument or a Firebase App instance.","invalid-log-argument":"First argument to `onLog` must be null or a function.","idb-open":"Error thrown when opening IndexedDB. Original error: {$originalErrorMessage}.","idb-get":"Error thrown when reading from IndexedDB. Original error: {$originalErrorMessage}.","idb-set":"Error thrown when writing to IndexedDB. Original error: {$originalErrorMessage}.","idb-delete":"Error thrown when deleting from IndexedDB. Original error: {$originalErrorMessage}.","finalization-registry-not-supported":"FirebaseServerApp deleteOnDeref field defined but the JS runtime does not support FinalizationRegistry.","invalid-server-app-environment":"FirebaseServerApp is not for use in browser environments."},_e=new Gi("app","Firebase",zl);class jl{constructor(e,t,s){this._isDeleted=!1,this._options={...e},this._config={...t},this._name=t.name,this._automaticDataCollectionEnabled=t.automaticDataCollectionEnabled,this._container=s,this.container.addComponent(new ut("app",()=>this,"PUBLIC"))}get automaticDataCollectionEnabled(){return this.checkDestroyed(),this._automaticDataCollectionEnabled}set automaticDataCollectionEnabled(e){this.checkDestroyed(),this._automaticDataCollectionEnabled=e}get name(){return this.checkDestroyed(),this._name}get options(){return this.checkDestroyed(),this._options}get config(){return this.checkDestroyed(),this._config}get container(){return this._container}get isDeleted(){return this._isDeleted}set isDeleted(e){this._isDeleted=e}checkDestroyed(){if(this.isDeleted)throw _e.create("app-deleted",{appName:this._name})}}const Yl=Ul;function Ki(n,e={}){let t=n;typeof e!="object"&&(e={name:e});const s={name:On,automaticDataCollectionEnabled:!0,...e},i=s.name;if(typeof i!="string"||!i)throw _e.create("bad-app-name",{appName:String(i)});if(t||(t=Fi()),!t)throw _e.create("no-options");const r=xt.get(i);if(r){if(Mt(t,r.options)&&Mt(s,r.config))return r;throw _e.create("duplicate-app",{appName:i})}const o=new Xa(i);for(const l of Dn.values())o.addComponent(l);const a=new jl(t,s,o);return xt.set(i,a),a}function ql(n=On){const e=xt.get(n);if(!e&&n===On&&Fi())return Ki();if(!e)throw _e.create("no-app",{appName:n});return e}function Be(n,e,t){let s=Hl[n]??n;t&&(s+=`-${t}`);const i=s.match(/\s|\//),r=e.match(/\s|\//);if(i||r){const o=[`Unable to register library "${s}" with version "${e}":`];i&&o.push(`library name "${s}" contains illegal characters (whitespace or "/")`),i&&r&&o.push("and"),r&&o.push(`version name "${e}" contains illegal characters (whitespace or "/")`),le.warn(o.join(" "));return}Bt(new ut(`${s}-version`,()=>({library:s,version:e}),"VERSION"))}const Ql="firebase-heartbeat-database",Xl=1,dt="firebase-heartbeat-store";let mn=null;function zi(){return mn||(mn=hl(Ql,Xl,{upgrade:(n,e)=>{switch(e){case 0:try{n.createObjectStore(dt)}catch(t){console.warn(t)}}}}).catch(n=>{throw _e.create("idb-open",{originalErrorMessage:n.message})})),mn}async function Jl(n){try{const t=(await zi()).transaction(dt),s=await t.objectStore(dt).get(ji(n));return await t.done,s}catch(e){if(e instanceof St)le.warn(e.message);else{const t=_e.create("idb-get",{originalErrorMessage:e?.message});le.warn(t.message)}}}async function Fs(n,e){try{const s=(await zi()).transaction(dt,"readwrite");await s.objectStore(dt).put(e,ji(n)),await s.done}catch(t){if(t instanceof St)le.warn(t.message);else{const s=_e.create("idb-set",{originalErrorMessage:t?.message});le.warn(s.message)}}}function ji(n){return`${n.name}!${n.options.appId}`}const Zl=1024,ec=30;class tc{constructor(e){this.container=e,this._heartbeatsCache=null;const t=this.container.getProvider("app").getImmediate();this._storage=new sc(t),this._heartbeatsCachePromise=this._storage.read().then(s=>(this._heartbeatsCache=s,s))}async triggerHeartbeat(){try{const t=this.container.getProvider("platform-logger").getImmediate().getPlatformInfoString(),s=Ws();if(this._heartbeatsCache?.heartbeats==null&&(this._heartbeatsCache=await this._heartbeatsCachePromise,this._heartbeatsCache?.heartbeats==null)||this._heartbeatsCache.lastSentHeartbeatDate===s||this._heartbeatsCache.heartbeats.some(i=>i.date===s))return;if(this._heartbeatsCache.heartbeats.push({date:s,agent:t}),this._heartbeatsCache.heartbeats.length>ec){const i=ic(this._heartbeatsCache.heartbeats);this._heartbeatsCache.heartbeats.splice(i,1)}return this._storage.overwrite(this._heartbeatsCache)}catch(e){le.warn(e)}}async getHeartbeatsHeader(){try{if(this._heartbeatsCache===null&&await this._heartbeatsCachePromise,this._heartbeatsCache?.heartbeats==null||this._heartbeatsCache.heartbeats.length===0)return"";const e=Ws(),{heartbeatsToSend:t,unsentEntries:s}=nc(this._heartbeatsCache.heartbeats),i=Pt(JSON.stringify({version:2,heartbeats:t}));return this._heartbeatsCache.lastSentHeartbeatDate=e,s.length>0?(this._heartbeatsCache.heartbeats=s,await this._storage.overwrite(this._heartbeatsCache)):(this._heartbeatsCache.heartbeats=[],this._storage.overwrite(this._heartbeatsCache)),i}catch(e){return le.warn(e),""}}}function Ws(){return new Date().toISOString().substring(0,10)}function nc(n,e=Zl){const t=[];let s=n.slice();for(const i of n){const r=t.find(o=>o.agent===i.agent);if(r){if(r.dates.push(i.date),Gs(t)>e){r.dates.pop();break}}else if(t.push({agent:i.agent,dates:[i.date]}),Gs(t)>e){t.pop();break}s=s.slice(1)}return{heartbeatsToSend:t,unsentEntries:s}}class sc{constructor(e){this.app=e,this._canUseIndexedDBPromise=this.runIndexedDBEnvironmentCheck()}async runIndexedDBEnvironmentCheck(){return Fa()?Wa().then(()=>!0).catch(()=>!1):!1}async read(){if(await this._canUseIndexedDBPromise){const t=await Jl(this.app);return t?.heartbeats?t:{heartbeats:[]}}else return{heartbeats:[]}}async overwrite(e){if(await this._canUseIndexedDBPromise){const s=await this.read();return Fs(this.app,{lastSentHeartbeatDate:e.lastSentHeartbeatDate??s.lastSentHeartbeatDate,heartbeats:e.heartbeats})}else return}async add(e){if(await this._canUseIndexedDBPromise){const s=await this.read();return Fs(this.app,{lastSentHeartbeatDate:e.lastSentHeartbeatDate??s.lastSentHeartbeatDate,heartbeats:[...s.heartbeats,...e.heartbeats]})}else return}}function Gs(n){return Pt(JSON.stringify({version:2,heartbeats:n})).length}function ic(n){if(n.length===0)return-1;let e=0,t=n[0].date;for(let s=1;s<n.length;s++)n[s].date<t&&(t=n[s].date,e=s);return e}function rc(n){Bt(new ut("platform-logger",e=>new fl(e),"PRIVATE")),Bt(new ut("heartbeat",e=>new tc(e),"PRIVATE")),Be(An,xs,n),Be(An,xs,"esm2020"),Be("fire-js","")}rc("");var oc="firebase",ac="12.8.0";Be(oc,ac,"app");var Us={};const Hs="@firebase/database",$s="1.1.0";let Yi="";function lc(n){Yi=n}class cc{constructor(e){this.domStorage_=e,this.prefix_="firebase:"}set(e,t){t==null?this.domStorage_.removeItem(this.prefixedName_(e)):this.domStorage_.setItem(this.prefixedName_(e),x(t))}get(e){const t=this.domStorage_.getItem(this.prefixedName_(e));return t==null?null:ht(t)}remove(e){this.domStorage_.removeItem(this.prefixedName_(e))}prefixedName_(e){return this.prefix_+e}toString(){return this.domStorage_.toString()}}class hc{constructor(){this.cache_={},this.isInMemoryStorage=!0}set(e,t){t==null?delete this.cache_[e]:this.cache_[e]=t}get(e){return se(this.cache_,e)?this.cache_[e]:null}remove(e){delete this.cache_[e]}}const qi=function(n){try{if(typeof window<"u"&&typeof window[n]<"u"){const e=window[n];return e.setItem("firebase:sentinel","cache"),e.removeItem("firebase:sentinel"),new cc(e)}}catch{}return new hc},Te=qi("localStorage"),uc=qi("sessionStorage");const Fe=new Hi("@firebase/database"),dc=(function(){let n=1;return function(){return n++}})(),Qi=function(n){const e=ja(n),t=new za;t.update(e);const s=t.digest();return jn.encodeByteArray(s)},It=function(...n){let e="";for(let t=0;t<n.length;t++){const s=n[t];Array.isArray(s)||s&&typeof s=="object"&&typeof s.length=="number"?e+=It.apply(null,s):typeof s=="object"?e+=x(s):e+=s,e+=" "}return e};let rt=null,Vs=!0;const fc=function(n,e){_(!0,"Can't turn on custom loggers persistently."),Fe.logLevel=O.VERBOSE,rt=Fe.log.bind(Fe)},W=function(...n){if(Vs===!0&&(Vs=!1,rt===null&&uc.get("logging_enabled")===!0&&fc()),rt){const e=It.apply(null,n);rt(e)}},bt=function(n){return function(...e){W(n,...e)}},kn=function(...n){const e="FIREBASE INTERNAL ERROR: "+It(...n);Fe.error(e)},ce=function(...n){const e=`FIREBASE FATAL ERROR: ${It(...n)}`;throw Fe.error(e),new Error(e)},H=function(...n){const e="FIREBASE WARNING: "+It(...n);Fe.warn(e)},pc=function(){typeof window<"u"&&window.location&&window.location.protocol&&window.location.protocol.indexOf("https:")!==-1&&H("Insecure Firebase access from a secure page. Please use https in calls to new Firebase().")},Zt=function(n){return typeof n=="number"&&(n!==n||n===Number.POSITIVE_INFINITY||n===Number.NEGATIVE_INFINITY)},_c=function(n){if(document.readyState==="complete")n();else{let e=!1;const t=function(){if(!document.body){setTimeout(t,Math.floor(10));return}e||(e=!0,n())};document.addEventListener?(document.addEventListener("DOMContentLoaded",t,!1),window.addEventListener("load",t,!1)):document.attachEvent&&(document.attachEvent("onreadystatechange",()=>{document.readyState==="complete"&&t()}),window.attachEvent("onload",t))}},He="[MIN_NAME]",Ne="[MAX_NAME]",De=function(n,e){if(n===e)return 0;if(n===He||e===Ne)return-1;if(e===He||n===Ne)return 1;{const t=Ks(n),s=Ks(e);return t!==null?s!==null?t-s===0?n.length-e.length:t-s:-1:s!==null?1:n<e?-1:1}},mc=function(n,e){return n===e?0:n<e?-1:1},Je=function(n,e){if(e&&n in e)return e[n];throw new Error("Missing required key ("+n+") in object: "+x(e))},Qn=function(n){if(typeof n!="object"||n===null)return x(n);const e=[];for(const s in n)e.push(s);e.sort();let t="{";for(let s=0;s<e.length;s++)s!==0&&(t+=","),t+=x(e[s]),t+=":",t+=Qn(n[e[s]]);return t+="}",t},Xi=function(n,e){const t=n.length;if(t<=e)return[n];const s=[];for(let i=0;i<t;i+=e)i+e>t?s.push(n.substring(i,t)):s.push(n.substring(i,i+e));return s};function G(n,e){for(const t in n)n.hasOwnProperty(t)&&e(t,n[t])}const Ji=function(n){_(!Zt(n),"Invalid JSON number");const e=11,t=52,s=(1<<e-1)-1;let i,r,o,a,l;n===0?(r=0,o=0,i=1/n===-1/0?1:0):(i=n<0,n=Math.abs(n),n>=Math.pow(2,1-s)?(a=Math.min(Math.floor(Math.log(n)/Math.LN2),s),r=a+s,o=Math.round(n*Math.pow(2,t-a)-Math.pow(2,t))):(r=0,o=Math.round(n/Math.pow(2,1-s-t))));const c=[];for(l=t;l;l-=1)c.push(o%2?1:0),o=Math.floor(o/2);for(l=e;l;l-=1)c.push(r%2?1:0),r=Math.floor(r/2);c.push(i?1:0),c.reverse();const f=c.join("");let u="";for(l=0;l<64;l+=8){let h=parseInt(f.substr(l,8),2).toString(16);h.length===1&&(h="0"+h),u=u+h}return u.toLowerCase()},gc=function(){return!!(typeof window=="object"&&window.chrome&&window.chrome.extension&&!/^chrome/.test(window.location.href))},yc=function(){return typeof Windows=="object"&&typeof Windows.UI=="object"};function Ec(n,e){let t="Unknown Error";n==="too_big"?t="The data requested exceeds the maximum size that can be accessed with a single request.":n==="permission_denied"?t="Client doesn't have permission to access the desired data.":n==="unavailable"&&(t="The service is unavailable");const s=new Error(n+" at "+e._path.toString()+": "+t);return s.code=n.toUpperCase(),s}const Cc=new RegExp("^-?(0*)\\d{1,10}$"),vc=-2147483648,Sc=2147483647,Ks=function(n){if(Cc.test(n)){const e=Number(n);if(e>=vc&&e<=Sc)return e}return null},Ye=function(n){try{n()}catch(e){setTimeout(()=>{const t=e.stack||"";throw H("Exception was thrown by user callback.",t),e},Math.floor(0))}},Ic=function(){return(typeof window=="object"&&window.navigator&&window.navigator.userAgent||"").search(/googlebot|google webmaster tools|bingbot|yahoo! slurp|baiduspider|yandexbot|duckduckbot/i)>=0},ot=function(n,e){const t=setTimeout(n,e);return typeof t=="number"&&typeof Deno<"u"&&Deno.unrefTimer?Deno.unrefTimer(t):typeof t=="object"&&t.unref&&t.unref(),t};class bc{constructor(e,t){this.appCheckProvider=t,this.appName=e.name,Kl(e)&&e.settings.appCheckToken&&(this.serverAppAppCheckToken=e.settings.appCheckToken),this.appCheck=t?.getImmediate({optional:!0}),this.appCheck||t?.get().then(s=>this.appCheck=s)}getToken(e){if(this.serverAppAppCheckToken){if(e)throw new Error("Attempted reuse of `FirebaseServerApp.appCheckToken` after previous usage failed.");return Promise.resolve({token:this.serverAppAppCheckToken})}return this.appCheck?this.appCheck.getToken(e):new Promise((t,s)=>{setTimeout(()=>{this.appCheck?this.getToken(e).then(t,s):t(null)},0)})}addTokenChangeListener(e){this.appCheckProvider?.get().then(t=>t.addTokenListener(e))}notifyForInvalidToken(){H(`Provided AppCheck credentials for the app named "${this.appName}" are invalid. This usually indicates your app was not initialized correctly.`)}}class wc{constructor(e,t,s){this.appName_=e,this.firebaseOptions_=t,this.authProvider_=s,this.auth_=null,this.auth_=s.getImmediate({optional:!0}),this.auth_||s.onInit(i=>this.auth_=i)}getToken(e){return this.auth_?this.auth_.getToken(e).catch(t=>t&&t.code==="auth/token-not-initialized"?(W("Got auth/token-not-initialized error.  Treating as null token."),null):Promise.reject(t)):new Promise((t,s)=>{setTimeout(()=>{this.auth_?this.getToken(e).then(t,s):t(null)},0)})}addTokenChangeListener(e){this.auth_?this.auth_.addAuthTokenListener(e):this.authProvider_.get().then(t=>t.addAuthTokenListener(e))}removeTokenChangeListener(e){this.authProvider_.get().then(t=>t.removeAuthTokenListener(e))}notifyForInvalidToken(){let e='Provided authentication credentials for the app named "'+this.appName_+'" are invalid. This usually indicates your app was not initialized correctly. ';"credential"in this.firebaseOptions_?e+='Make sure the "credential" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':"serviceAccount"in this.firebaseOptions_?e+='Make sure the "serviceAccount" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':e+='Make sure the "apiKey" and "databaseURL" properties provided to initializeApp() match the values provided for your app at https://console.firebase.google.com/.',H(e)}}class Dt{constructor(e){this.accessToken=e}getToken(e){return Promise.resolve({accessToken:this.accessToken})}addTokenChangeListener(e){e(this.accessToken)}removeTokenChangeListener(e){}notifyForInvalidToken(){}}Dt.OWNER="owner";const Xn="5",Zi="v",er="s",tr="r",nr="f",sr=/(console\.firebase|firebase-console-\w+\.corp|firebase\.corp)\.google\.com/,ir="ls",rr="p",Pn="ac",or="websocket",ar="long_polling";class lr{constructor(e,t,s,i,r=!1,o="",a=!1,l=!1,c=null){this.secure=t,this.namespace=s,this.webSocketOnly=i,this.nodeAdmin=r,this.persistenceKey=o,this.includeNamespaceInQueryParams=a,this.isUsingEmulator=l,this.emulatorOptions=c,this._host=e.toLowerCase(),this._domain=this._host.substr(this._host.indexOf(".")+1),this.internalHost=Te.get("host:"+e)||this._host}isCacheableHost(){return this.internalHost.substr(0,2)==="s-"}isCustomHost(){return this._domain!=="firebaseio.com"&&this._domain!=="firebaseio-demo.com"}get host(){return this._host}set host(e){e!==this.internalHost&&(this.internalHost=e,this.isCacheableHost()&&Te.set("host:"+this._host,this.internalHost))}toString(){let e=this.toURLString();return this.persistenceKey&&(e+="<"+this.persistenceKey+">"),e}toURLString(){const e=this.secure?"https://":"http://",t=this.includeNamespaceInQueryParams?`?ns=${this.namespace}`:"";return`${e}${this.host}/${t}`}}function Tc(n){return n.host!==n.internalHost||n.isCustomHost()||n.includeNamespaceInQueryParams}function cr(n,e,t){_(typeof e=="string","typeof type must == string"),_(typeof t=="object","typeof params must == object");let s;if(e===or)s=(n.secure?"wss://":"ws://")+n.internalHost+"/.ws?";else if(e===ar)s=(n.secure?"https://":"http://")+n.internalHost+"/.lp?";else throw new Error("Unknown connection type: "+e);Tc(n)&&(t.ns=n.namespace);const i=[];return G(t,(r,o)=>{i.push(r+"="+o)}),s+i.join("&")}class Nc{constructor(){this.counters_={}}incrementCounter(e,t=1){se(this.counters_,e)||(this.counters_[e]=0),this.counters_[e]+=t}get(){return Sa(this.counters_)}}const gn={},yn={};function Jn(n){const e=n.toString();return gn[e]||(gn[e]=new Nc),gn[e]}function Rc(n,e){const t=n.toString();return yn[t]||(yn[t]=e()),yn[t]}class Ac{constructor(e){this.onMessage_=e,this.pendingResponses=[],this.currentResponseNum=0,this.closeAfterResponse=-1,this.onClose=null}closeAfter(e,t){this.closeAfterResponse=e,this.onClose=t,this.closeAfterResponse<this.currentResponseNum&&(this.onClose(),this.onClose=null)}handleResponse(e,t){for(this.pendingResponses[e]=t;this.pendingResponses[this.currentResponseNum];){const s=this.pendingResponses[this.currentResponseNum];delete this.pendingResponses[this.currentResponseNum];for(let i=0;i<s.length;++i)s[i]&&Ye(()=>{this.onMessage_(s[i])});if(this.currentResponseNum===this.closeAfterResponse){this.onClose&&(this.onClose(),this.onClose=null);break}this.currentResponseNum++}}}const zs="start",Oc="close",Dc="pLPCommand",kc="pRTLPCB",hr="id",ur="pw",dr="ser",Pc="cb",Lc="seg",Mc="ts",xc="d",Bc="dframe",fr=1870,pr=30,Fc=fr-pr,Wc=25e3,Gc=3e4;class Me{constructor(e,t,s,i,r,o,a){this.connId=e,this.repoInfo=t,this.applicationId=s,this.appCheckToken=i,this.authToken=r,this.transportSessionId=o,this.lastSessionId=a,this.bytesSent=0,this.bytesReceived=0,this.everConnected_=!1,this.log_=bt(e),this.stats_=Jn(t),this.urlFn=l=>(this.appCheckToken&&(l[Pn]=this.appCheckToken),cr(t,ar,l))}open(e,t){this.curSegmentNum=0,this.onDisconnect_=t,this.myPacketOrderer=new Ac(e),this.isClosed_=!1,this.connectTimeoutTimer_=setTimeout(()=>{this.log_("Timed out trying to connect."),this.onClosed_(),this.connectTimeoutTimer_=null},Math.floor(Gc)),_c(()=>{if(this.isClosed_)return;this.scriptTagHolder=new Zn((...r)=>{const[o,a,l,c,f]=r;if(this.incrementIncomingBytes_(r),!!this.scriptTagHolder)if(this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null),this.everConnected_=!0,o===zs)this.id=a,this.password=l;else if(o===Oc)a?(this.scriptTagHolder.sendNewPolls=!1,this.myPacketOrderer.closeAfter(a,()=>{this.onClosed_()})):this.onClosed_();else throw new Error("Unrecognized command received: "+o)},(...r)=>{const[o,a]=r;this.incrementIncomingBytes_(r),this.myPacketOrderer.handleResponse(o,a)},()=>{this.onClosed_()},this.urlFn);const s={};s[zs]="t",s[dr]=Math.floor(Math.random()*1e8),this.scriptTagHolder.uniqueCallbackIdentifier&&(s[Pc]=this.scriptTagHolder.uniqueCallbackIdentifier),s[Zi]=Xn,this.transportSessionId&&(s[er]=this.transportSessionId),this.lastSessionId&&(s[ir]=this.lastSessionId),this.applicationId&&(s[rr]=this.applicationId),this.appCheckToken&&(s[Pn]=this.appCheckToken),typeof location<"u"&&location.hostname&&sr.test(location.hostname)&&(s[tr]=nr);const i=this.urlFn(s);this.log_("Connecting via long-poll to "+i),this.scriptTagHolder.addTag(i,()=>{})})}start(){this.scriptTagHolder.startLongPoll(this.id,this.password),this.addDisconnectPingFrame(this.id,this.password)}static forceAllow(){Me.forceAllow_=!0}static forceDisallow(){Me.forceDisallow_=!0}static isAvailable(){return Me.forceAllow_?!0:!Me.forceDisallow_&&typeof document<"u"&&document.createElement!=null&&!gc()&&!yc()}markConnectionHealthy(){}shutdown_(){this.isClosed_=!0,this.scriptTagHolder&&(this.scriptTagHolder.close(),this.scriptTagHolder=null),this.myDisconnFrame&&(document.body.removeChild(this.myDisconnFrame),this.myDisconnFrame=null),this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null)}onClosed_(){this.isClosed_||(this.log_("Longpoll is closing itself"),this.shutdown_(),this.onDisconnect_&&(this.onDisconnect_(this.everConnected_),this.onDisconnect_=null))}close(){this.isClosed_||(this.log_("Longpoll is being closed."),this.shutdown_())}send(e){const t=x(e);this.bytesSent+=t.length,this.stats_.incrementCounter("bytes_sent",t.length);const s=Mi(t),i=Xi(s,Fc);for(let r=0;r<i.length;r++)this.scriptTagHolder.enqueueSegment(this.curSegmentNum,i.length,i[r]),this.curSegmentNum++}addDisconnectPingFrame(e,t){this.myDisconnFrame=document.createElement("iframe");const s={};s[Bc]="t",s[hr]=e,s[ur]=t,this.myDisconnFrame.src=this.urlFn(s),this.myDisconnFrame.style.display="none",document.body.appendChild(this.myDisconnFrame)}incrementIncomingBytes_(e){const t=x(e).length;this.bytesReceived+=t,this.stats_.incrementCounter("bytes_received",t)}}class Zn{constructor(e,t,s,i){this.onDisconnect=s,this.urlFn=i,this.outstandingRequests=new Set,this.pendingSegs=[],this.currentSerial=Math.floor(Math.random()*1e8),this.sendNewPolls=!0;{this.uniqueCallbackIdentifier=dc(),window[Dc+this.uniqueCallbackIdentifier]=e,window[kc+this.uniqueCallbackIdentifier]=t,this.myIFrame=Zn.createIFrame_();let r="";this.myIFrame.src&&this.myIFrame.src.substr(0,11)==="javascript:"&&(r='<script>document.domain="'+document.domain+'";<\/script>');const o="<html><body>"+r+"</body></html>";try{this.myIFrame.doc.open(),this.myIFrame.doc.write(o),this.myIFrame.doc.close()}catch(a){W("frame writing exception"),a.stack&&W(a.stack),W(a)}}}static createIFrame_(){const e=document.createElement("iframe");if(e.style.display="none",document.body){document.body.appendChild(e);try{e.contentWindow.document||W("No IE domain setting required")}catch{const s=document.domain;e.src="javascript:void((function(){document.open();document.domain='"+s+"';document.close();})())"}}else throw"Document body has not initialized. Wait to initialize Firebase until after the document is ready.";return e.contentDocument?e.doc=e.contentDocument:e.contentWindow?e.doc=e.contentWindow.document:e.document&&(e.doc=e.document),e}close(){this.alive=!1,this.myIFrame&&(this.myIFrame.doc.body.textContent="",setTimeout(()=>{this.myIFrame!==null&&(document.body.removeChild(this.myIFrame),this.myIFrame=null)},Math.floor(0)));const e=this.onDisconnect;e&&(this.onDisconnect=null,e())}startLongPoll(e,t){for(this.myID=e,this.myPW=t,this.alive=!0;this.newRequest_(););}newRequest_(){if(this.alive&&this.sendNewPolls&&this.outstandingRequests.size<(this.pendingSegs.length>0?2:1)){this.currentSerial++;const e={};e[hr]=this.myID,e[ur]=this.myPW,e[dr]=this.currentSerial;let t=this.urlFn(e),s="",i=0;for(;this.pendingSegs.length>0&&this.pendingSegs[0].d.length+pr+s.length<=fr;){const o=this.pendingSegs.shift();s=s+"&"+Lc+i+"="+o.seg+"&"+Mc+i+"="+o.ts+"&"+xc+i+"="+o.d,i++}return t=t+s,this.addLongPollTag_(t,this.currentSerial),!0}else return!1}enqueueSegment(e,t,s){this.pendingSegs.push({seg:e,ts:t,d:s}),this.alive&&this.newRequest_()}addLongPollTag_(e,t){this.outstandingRequests.add(t);const s=()=>{this.outstandingRequests.delete(t),this.newRequest_()},i=setTimeout(s,Math.floor(Wc)),r=()=>{clearTimeout(i),s()};this.addTag(e,r)}addTag(e,t){setTimeout(()=>{try{if(!this.sendNewPolls)return;const s=this.myIFrame.doc.createElement("script");s.type="text/javascript",s.async=!0,s.src=e,s.onload=s.onreadystatechange=function(){const i=s.readyState;(!i||i==="loaded"||i==="complete")&&(s.onload=s.onreadystatechange=null,s.parentNode&&s.parentNode.removeChild(s),t())},s.onerror=()=>{W("Long-poll script failed to load: "+e),this.sendNewPolls=!1,this.close()},this.myIFrame.doc.body.appendChild(s)}catch{}},Math.floor(1))}}const Uc=16384,Hc=45e3;let Ft=null;typeof MozWebSocket<"u"?Ft=MozWebSocket:typeof WebSocket<"u"&&(Ft=WebSocket);class J{constructor(e,t,s,i,r,o,a){this.connId=e,this.applicationId=s,this.appCheckToken=i,this.authToken=r,this.keepaliveTimer=null,this.frames=null,this.totalFrames=0,this.bytesSent=0,this.bytesReceived=0,this.log_=bt(this.connId),this.stats_=Jn(t),this.connURL=J.connectionURL_(t,o,a,i,s),this.nodeAdmin=t.nodeAdmin}static connectionURL_(e,t,s,i,r){const o={};return o[Zi]=Xn,typeof location<"u"&&location.hostname&&sr.test(location.hostname)&&(o[tr]=nr),t&&(o[er]=t),s&&(o[ir]=s),i&&(o[Pn]=i),r&&(o[rr]=r),cr(e,or,o)}open(e,t){this.onDisconnect=t,this.onMessage=e,this.log_("Websocket connecting to "+this.connURL),this.everConnected_=!1,Te.set("previous_websocket_failure",!0);try{let s;Ba(),this.mySock=new Ft(this.connURL,[],s)}catch(s){this.log_("Error instantiating WebSocket.");const i=s.message||s.data;i&&this.log_(i),this.onClosed_();return}this.mySock.onopen=()=>{this.log_("Websocket connected."),this.everConnected_=!0},this.mySock.onclose=()=>{this.log_("Websocket connection was disconnected."),this.mySock=null,this.onClosed_()},this.mySock.onmessage=s=>{this.handleIncomingFrame(s)},this.mySock.onerror=s=>{this.log_("WebSocket error.  Closing connection.");const i=s.message||s.data;i&&this.log_(i),this.onClosed_()}}start(){}static forceDisallow(){J.forceDisallow_=!0}static isAvailable(){let e=!1;if(typeof navigator<"u"&&navigator.userAgent){const t=/Android ([0-9]{0,}\.[0-9]{0,})/,s=navigator.userAgent.match(t);s&&s.length>1&&parseFloat(s[1])<4.4&&(e=!0)}return!e&&Ft!==null&&!J.forceDisallow_}static previouslyFailed(){return Te.isInMemoryStorage||Te.get("previous_websocket_failure")===!0}markConnectionHealthy(){Te.remove("previous_websocket_failure")}appendFrame_(e){if(this.frames.push(e),this.frames.length===this.totalFrames){const t=this.frames.join("");this.frames=null;const s=ht(t);this.onMessage(s)}}handleNewFrameCount_(e){this.totalFrames=e,this.frames=[]}extractFrameCount_(e){if(_(this.frames===null,"We already have a frame buffer"),e.length<=6){const t=Number(e);if(!isNaN(t))return this.handleNewFrameCount_(t),null}return this.handleNewFrameCount_(1),e}handleIncomingFrame(e){if(this.mySock===null)return;const t=e.data;if(this.bytesReceived+=t.length,this.stats_.incrementCounter("bytes_received",t.length),this.resetKeepAlive(),this.frames!==null)this.appendFrame_(t);else{const s=this.extractFrameCount_(t);s!==null&&this.appendFrame_(s)}}send(e){this.resetKeepAlive();const t=x(e);this.bytesSent+=t.length,this.stats_.incrementCounter("bytes_sent",t.length);const s=Xi(t,Uc);s.length>1&&this.sendString_(String(s.length));for(let i=0;i<s.length;i++)this.sendString_(s[i])}shutdown_(){this.isClosed_=!0,this.keepaliveTimer&&(clearInterval(this.keepaliveTimer),this.keepaliveTimer=null),this.mySock&&(this.mySock.close(),this.mySock=null)}onClosed_(){this.isClosed_||(this.log_("WebSocket is closing itself"),this.shutdown_(),this.onDisconnect&&(this.onDisconnect(this.everConnected_),this.onDisconnect=null))}close(){this.isClosed_||(this.log_("WebSocket is being closed"),this.shutdown_())}resetKeepAlive(){clearInterval(this.keepaliveTimer),this.keepaliveTimer=setInterval(()=>{this.mySock&&this.sendString_("0"),this.resetKeepAlive()},Math.floor(Hc))}sendString_(e){try{this.mySock.send(e)}catch(t){this.log_("Exception thrown from WebSocket.send():",t.message||t.data,"Closing connection."),setTimeout(this.onClosed_.bind(this),0)}}}J.responsesRequiredToBeHealthy=2;J.healthyTimeout=3e4;class ft{static get ALL_TRANSPORTS(){return[Me,J]}static get IS_TRANSPORT_INITIALIZED(){return this.globalTransportInitialized_}constructor(e){this.initTransports_(e)}initTransports_(e){const t=J&&J.isAvailable();let s=t&&!J.previouslyFailed();if(e.webSocketOnly&&(t||H("wss:// URL used, but browser isn't known to support websockets.  Trying anyway."),s=!0),s)this.transports_=[J];else{const i=this.transports_=[];for(const r of ft.ALL_TRANSPORTS)r&&r.isAvailable()&&i.push(r);ft.globalTransportInitialized_=!0}}initialTransport(){if(this.transports_.length>0)return this.transports_[0];throw new Error("No transports available")}upgradeTransport(){return this.transports_.length>1?this.transports_[1]:null}}ft.globalTransportInitialized_=!1;const $c=6e4,Vc=5e3,Kc=10*1024,zc=100*1024,En="t",js="d",jc="s",Ys="r",Yc="e",qs="o",Qs="a",Xs="n",Js="p",qc="h";class Qc{constructor(e,t,s,i,r,o,a,l,c,f){this.id=e,this.repoInfo_=t,this.applicationId_=s,this.appCheckToken_=i,this.authToken_=r,this.onMessage_=o,this.onReady_=a,this.onDisconnect_=l,this.onKill_=c,this.lastSessionId=f,this.connectionCount=0,this.pendingDataMessages=[],this.state_=0,this.log_=bt("c:"+this.id+":"),this.transportManager_=new ft(t),this.log_("Connection created"),this.start_()}start_(){const e=this.transportManager_.initialTransport();this.conn_=new e(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,null,this.lastSessionId),this.primaryResponsesRequired_=e.responsesRequiredToBeHealthy||0;const t=this.connReceiver_(this.conn_),s=this.disconnReceiver_(this.conn_);this.tx_=this.conn_,this.rx_=this.conn_,this.secondaryConn_=null,this.isHealthy_=!1,setTimeout(()=>{this.conn_&&this.conn_.open(t,s)},Math.floor(0));const i=e.healthyTimeout||0;i>0&&(this.healthyTimeout_=ot(()=>{this.healthyTimeout_=null,this.isHealthy_||(this.conn_&&this.conn_.bytesReceived>zc?(this.log_("Connection exceeded healthy timeout but has received "+this.conn_.bytesReceived+" bytes.  Marking connection healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()):this.conn_&&this.conn_.bytesSent>Kc?this.log_("Connection exceeded healthy timeout but has sent "+this.conn_.bytesSent+" bytes.  Leaving connection alive."):(this.log_("Closing unhealthy connection after timeout."),this.close()))},Math.floor(i)))}nextTransportId_(){return"c:"+this.id+":"+this.connectionCount++}disconnReceiver_(e){return t=>{e===this.conn_?this.onConnectionLost_(t):e===this.secondaryConn_?(this.log_("Secondary connection lost."),this.onSecondaryConnectionLost_()):this.log_("closing an old connection")}}connReceiver_(e){return t=>{this.state_!==2&&(e===this.rx_?this.onPrimaryMessageReceived_(t):e===this.secondaryConn_?this.onSecondaryMessageReceived_(t):this.log_("message on old connection"))}}sendRequest(e){const t={t:"d",d:e};this.sendData_(t)}tryCleanupConnection(){this.tx_===this.secondaryConn_&&this.rx_===this.secondaryConn_&&(this.log_("cleaning up and promoting a connection: "+this.secondaryConn_.connId),this.conn_=this.secondaryConn_,this.secondaryConn_=null)}onSecondaryControl_(e){if(En in e){const t=e[En];t===Qs?this.upgradeIfSecondaryHealthy_():t===Ys?(this.log_("Got a reset on secondary, closing it"),this.secondaryConn_.close(),(this.tx_===this.secondaryConn_||this.rx_===this.secondaryConn_)&&this.close()):t===qs&&(this.log_("got pong on secondary."),this.secondaryResponsesRequired_--,this.upgradeIfSecondaryHealthy_())}}onSecondaryMessageReceived_(e){const t=Je("t",e),s=Je("d",e);if(t==="c")this.onSecondaryControl_(s);else if(t==="d")this.pendingDataMessages.push(s);else throw new Error("Unknown protocol layer: "+t)}upgradeIfSecondaryHealthy_(){this.secondaryResponsesRequired_<=0?(this.log_("Secondary connection is healthy."),this.isHealthy_=!0,this.secondaryConn_.markConnectionHealthy(),this.proceedWithUpgrade_()):(this.log_("sending ping on secondary."),this.secondaryConn_.send({t:"c",d:{t:Js,d:{}}}))}proceedWithUpgrade_(){this.secondaryConn_.start(),this.log_("sending client ack on secondary"),this.secondaryConn_.send({t:"c",d:{t:Qs,d:{}}}),this.log_("Ending transmission on primary"),this.conn_.send({t:"c",d:{t:Xs,d:{}}}),this.tx_=this.secondaryConn_,this.tryCleanupConnection()}onPrimaryMessageReceived_(e){const t=Je("t",e),s=Je("d",e);t==="c"?this.onControl_(s):t==="d"&&this.onDataMessage_(s)}onDataMessage_(e){this.onPrimaryResponse_(),this.onMessage_(e)}onPrimaryResponse_(){this.isHealthy_||(this.primaryResponsesRequired_--,this.primaryResponsesRequired_<=0&&(this.log_("Primary connection is healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()))}onControl_(e){const t=Je(En,e);if(js in e){const s=e[js];if(t===qc){const i={...s};this.repoInfo_.isUsingEmulator&&(i.h=this.repoInfo_.host),this.onHandshake_(i)}else if(t===Xs){this.log_("recvd end transmission on primary"),this.rx_=this.secondaryConn_;for(let i=0;i<this.pendingDataMessages.length;++i)this.onDataMessage_(this.pendingDataMessages[i]);this.pendingDataMessages=[],this.tryCleanupConnection()}else t===jc?this.onConnectionShutdown_(s):t===Ys?this.onReset_(s):t===Yc?kn("Server Error: "+s):t===qs?(this.log_("got pong on primary."),this.onPrimaryResponse_(),this.sendPingOnPrimaryIfNecessary_()):kn("Unknown control packet command: "+t)}}onHandshake_(e){const t=e.ts,s=e.v,i=e.h;this.sessionId=e.s,this.repoInfo_.host=i,this.state_===0&&(this.conn_.start(),this.onConnectionEstablished_(this.conn_,t),Xn!==s&&H("Protocol version mismatch detected"),this.tryStartUpgrade_())}tryStartUpgrade_(){const e=this.transportManager_.upgradeTransport();e&&this.startUpgrade_(e)}startUpgrade_(e){this.secondaryConn_=new e(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,this.sessionId),this.secondaryResponsesRequired_=e.responsesRequiredToBeHealthy||0;const t=this.connReceiver_(this.secondaryConn_),s=this.disconnReceiver_(this.secondaryConn_);this.secondaryConn_.open(t,s),ot(()=>{this.secondaryConn_&&(this.log_("Timed out trying to upgrade."),this.secondaryConn_.close())},Math.floor($c))}onReset_(e){this.log_("Reset packet received.  New host: "+e),this.repoInfo_.host=e,this.state_===1?this.close():(this.closeConnections_(),this.start_())}onConnectionEstablished_(e,t){this.log_("Realtime connection established."),this.conn_=e,this.state_=1,this.onReady_&&(this.onReady_(t,this.sessionId),this.onReady_=null),this.primaryResponsesRequired_===0?(this.log_("Primary connection is healthy."),this.isHealthy_=!0):ot(()=>{this.sendPingOnPrimaryIfNecessary_()},Math.floor(Vc))}sendPingOnPrimaryIfNecessary_(){!this.isHealthy_&&this.state_===1&&(this.log_("sending ping on primary."),this.sendData_({t:"c",d:{t:Js,d:{}}}))}onSecondaryConnectionLost_(){const e=this.secondaryConn_;this.secondaryConn_=null,(this.tx_===e||this.rx_===e)&&this.close()}onConnectionLost_(e){this.conn_=null,!e&&this.state_===0?(this.log_("Realtime connection failed."),this.repoInfo_.isCacheableHost()&&(Te.remove("host:"+this.repoInfo_.host),this.repoInfo_.internalHost=this.repoInfo_.host)):this.state_===1&&this.log_("Realtime connection lost."),this.close()}onConnectionShutdown_(e){this.log_("Connection shutdown command received. Shutting down..."),this.onKill_&&(this.onKill_(e),this.onKill_=null),this.onDisconnect_=null,this.close()}sendData_(e){if(this.state_!==1)throw"Connection is not connected";this.tx_.send(e)}close(){this.state_!==2&&(this.log_("Closing realtime connection."),this.state_=2,this.closeConnections_(),this.onDisconnect_&&(this.onDisconnect_(),this.onDisconnect_=null))}closeConnections_(){this.log_("Shutting down all connections"),this.conn_&&(this.conn_.close(),this.conn_=null),this.secondaryConn_&&(this.secondaryConn_.close(),this.secondaryConn_=null),this.healthyTimeout_&&(clearTimeout(this.healthyTimeout_),this.healthyTimeout_=null)}}class _r{put(e,t,s,i){}merge(e,t,s,i){}refreshAuthToken(e){}refreshAppCheckToken(e){}onDisconnectPut(e,t,s){}onDisconnectMerge(e,t,s){}onDisconnectCancel(e,t){}reportStats(e){}}class mr{constructor(e){this.allowedEvents_=e,this.listeners_={},_(Array.isArray(e)&&e.length>0,"Requires a non-empty array")}trigger(e,...t){if(Array.isArray(this.listeners_[e])){const s=[...this.listeners_[e]];for(let i=0;i<s.length;i++)s[i].callback.apply(s[i].context,t)}}on(e,t,s){this.validateEventType_(e),this.listeners_[e]=this.listeners_[e]||[],this.listeners_[e].push({callback:t,context:s});const i=this.getInitialEvent(e);i&&t.apply(s,i)}off(e,t,s){this.validateEventType_(e);const i=this.listeners_[e]||[];for(let r=0;r<i.length;r++)if(i[r].callback===t&&(!s||s===i[r].context)){i.splice(r,1);return}}validateEventType_(e){_(this.allowedEvents_.find(t=>t===e),"Unknown event: "+e)}}class Wt extends mr{static getInstance(){return new Wt}constructor(){super(["online"]),this.online_=!0,typeof window<"u"&&typeof window.addEventListener<"u"&&!Wi()&&(window.addEventListener("online",()=>{this.online_||(this.online_=!0,this.trigger("online",!0))},!1),window.addEventListener("offline",()=>{this.online_&&(this.online_=!1,this.trigger("online",!1))},!1))}getInitialEvent(e){return _(e==="online","Unknown event type: "+e),[this.online_]}currentlyOnline(){return this.online_}}const Zs=32,ei=768;class N{constructor(e,t){if(t===void 0){this.pieces_=e.split("/");let s=0;for(let i=0;i<this.pieces_.length;i++)this.pieces_[i].length>0&&(this.pieces_[s]=this.pieces_[i],s++);this.pieces_.length=s,this.pieceNum_=0}else this.pieces_=e,this.pieceNum_=t}toString(){let e="";for(let t=this.pieceNum_;t<this.pieces_.length;t++)this.pieces_[t]!==""&&(e+="/"+this.pieces_[t]);return e||"/"}}function T(){return new N("")}function C(n){return n.pieceNum_>=n.pieces_.length?null:n.pieces_[n.pieceNum_]}function ye(n){return n.pieces_.length-n.pieceNum_}function R(n){let e=n.pieceNum_;return e<n.pieces_.length&&e++,new N(n.pieces_,e)}function es(n){return n.pieceNum_<n.pieces_.length?n.pieces_[n.pieces_.length-1]:null}function Xc(n){let e="";for(let t=n.pieceNum_;t<n.pieces_.length;t++)n.pieces_[t]!==""&&(e+="/"+encodeURIComponent(String(n.pieces_[t])));return e||"/"}function pt(n,e=0){return n.pieces_.slice(n.pieceNum_+e)}function gr(n){if(n.pieceNum_>=n.pieces_.length)return null;const e=[];for(let t=n.pieceNum_;t<n.pieces_.length-1;t++)e.push(n.pieces_[t]);return new N(e,0)}function D(n,e){const t=[];for(let s=n.pieceNum_;s<n.pieces_.length;s++)t.push(n.pieces_[s]);if(e instanceof N)for(let s=e.pieceNum_;s<e.pieces_.length;s++)t.push(e.pieces_[s]);else{const s=e.split("/");for(let i=0;i<s.length;i++)s[i].length>0&&t.push(s[i])}return new N(t,0)}function v(n){return n.pieceNum_>=n.pieces_.length}function U(n,e){const t=C(n),s=C(e);if(t===null)return e;if(t===s)return U(R(n),R(e));throw new Error("INTERNAL ERROR: innerPath ("+e+") is not within outerPath ("+n+")")}function Jc(n,e){const t=pt(n,0),s=pt(e,0);for(let i=0;i<t.length&&i<s.length;i++){const r=De(t[i],s[i]);if(r!==0)return r}return t.length===s.length?0:t.length<s.length?-1:1}function ts(n,e){if(ye(n)!==ye(e))return!1;for(let t=n.pieceNum_,s=e.pieceNum_;t<=n.pieces_.length;t++,s++)if(n.pieces_[t]!==e.pieces_[s])return!1;return!0}function Q(n,e){let t=n.pieceNum_,s=e.pieceNum_;if(ye(n)>ye(e))return!1;for(;t<n.pieces_.length;){if(n.pieces_[t]!==e.pieces_[s])return!1;++t,++s}return!0}class Zc{constructor(e,t){this.errorPrefix_=t,this.parts_=pt(e,0),this.byteLength_=Math.max(1,this.parts_.length);for(let s=0;s<this.parts_.length;s++)this.byteLength_+=Jt(this.parts_[s]);yr(this)}}function eh(n,e){n.parts_.length>0&&(n.byteLength_+=1),n.parts_.push(e),n.byteLength_+=Jt(e),yr(n)}function th(n){const e=n.parts_.pop();n.byteLength_-=Jt(e),n.parts_.length>0&&(n.byteLength_-=1)}function yr(n){if(n.byteLength_>ei)throw new Error(n.errorPrefix_+"has a key path longer than "+ei+" bytes ("+n.byteLength_+").");if(n.parts_.length>Zs)throw new Error(n.errorPrefix_+"path specified exceeds the maximum depth that can be written ("+Zs+") or object contains a cycle "+we(n))}function we(n){return n.parts_.length===0?"":"in property '"+n.parts_.join(".")+"'"}class ns extends mr{static getInstance(){return new ns}constructor(){super(["visible"]);let e,t;typeof document<"u"&&typeof document.addEventListener<"u"&&(typeof document.hidden<"u"?(t="visibilitychange",e="hidden"):typeof document.mozHidden<"u"?(t="mozvisibilitychange",e="mozHidden"):typeof document.msHidden<"u"?(t="msvisibilitychange",e="msHidden"):typeof document.webkitHidden<"u"&&(t="webkitvisibilitychange",e="webkitHidden")),this.visible_=!0,t&&document.addEventListener(t,()=>{const s=!document[e];s!==this.visible_&&(this.visible_=s,this.trigger("visible",s))},!1)}getInitialEvent(e){return _(e==="visible","Unknown event type: "+e),[this.visible_]}}const Ze=1e3,nh=300*1e3,ti=30*1e3,sh=1.3,ih=3e4,rh="server_kill",ni=3;class oe extends _r{constructor(e,t,s,i,r,o,a,l){if(super(),this.repoInfo_=e,this.applicationId_=t,this.onDataUpdate_=s,this.onConnectStatus_=i,this.onServerInfoUpdate_=r,this.authTokenProvider_=o,this.appCheckTokenProvider_=a,this.authOverride_=l,this.id=oe.nextPersistentConnectionId_++,this.log_=bt("p:"+this.id+":"),this.interruptReasons_={},this.listens=new Map,this.outstandingPuts_=[],this.outstandingGets_=[],this.outstandingPutCount_=0,this.outstandingGetCount_=0,this.onDisconnectRequestQueue_=[],this.connected_=!1,this.reconnectDelay_=Ze,this.maxReconnectDelay_=nh,this.securityDebugCallback_=null,this.lastSessionId=null,this.establishConnectionTimer_=null,this.visible_=!1,this.requestCBHash_={},this.requestNumber_=0,this.realtime_=null,this.authToken_=null,this.appCheckToken_=null,this.forceTokenRefresh_=!1,this.invalidAuthTokenCount_=0,this.invalidAppCheckTokenCount_=0,this.firstConnection_=!0,this.lastConnectionAttemptTime_=null,this.lastConnectionEstablishedTime_=null,l)throw new Error("Auth override specified in options, but not supported on non Node.js platforms");ns.getInstance().on("visible",this.onVisible_,this),e.host.indexOf("fblocal")===-1&&Wt.getInstance().on("online",this.onOnline_,this)}sendRequest(e,t,s){const i=++this.requestNumber_,r={r:i,a:e,b:t};this.log_(x(r)),_(this.connected_,"sendRequest call when we're not connected not allowed."),this.realtime_.sendRequest(r),s&&(this.requestCBHash_[i]=s)}get(e){this.initConnection_();const t=new te,i={action:"g",request:{p:e._path.toString(),q:e._queryObject},onComplete:o=>{const a=o.d;o.s==="ok"?t.resolve(a):t.reject(a)}};this.outstandingGets_.push(i),this.outstandingGetCount_++;const r=this.outstandingGets_.length-1;return this.connected_&&this.sendGet_(r),t.promise}listen(e,t,s,i){this.initConnection_();const r=e._queryIdentifier,o=e._path.toString();this.log_("Listen called for "+o+" "+r),this.listens.has(o)||this.listens.set(o,new Map),_(e._queryParams.isDefault()||!e._queryParams.loadsAllData(),"listen() called for non-default but complete query"),_(!this.listens.get(o).has(r),"listen() called twice for same path/queryId.");const a={onComplete:i,hashFn:t,query:e,tag:s};this.listens.get(o).set(r,a),this.connected_&&this.sendListen_(a)}sendGet_(e){const t=this.outstandingGets_[e];this.sendRequest("g",t.request,s=>{delete this.outstandingGets_[e],this.outstandingGetCount_--,this.outstandingGetCount_===0&&(this.outstandingGets_=[]),t.onComplete&&t.onComplete(s)})}sendListen_(e){const t=e.query,s=t._path.toString(),i=t._queryIdentifier;this.log_("Listen on "+s+" for "+i);const r={p:s},o="q";e.tag&&(r.q=t._queryObject,r.t=e.tag),r.h=e.hashFn(),this.sendRequest(o,r,a=>{const l=a.d,c=a.s;oe.warnOnListenWarnings_(l,t),(this.listens.get(s)&&this.listens.get(s).get(i))===e&&(this.log_("listen response",a),c!=="ok"&&this.removeListen_(s,i),e.onComplete&&e.onComplete(c,l))})}static warnOnListenWarnings_(e,t){if(e&&typeof e=="object"&&se(e,"w")){const s=Ge(e,"w");if(Array.isArray(s)&&~s.indexOf("no_index")){const i='".indexOn": "'+t._queryParams.getIndex().toString()+'"',r=t._path.toString();H(`Using an unspecified index. Your data will be downloaded and filtered on the client. Consider adding ${i} at ${r} to your security rules for better performance.`)}}}refreshAuthToken(e){this.authToken_=e,this.log_("Auth token refreshed"),this.authToken_?this.tryAuth():this.connected_&&this.sendRequest("unauth",{},()=>{}),this.reduceReconnectDelayIfAdminCredential_(e)}reduceReconnectDelayIfAdminCredential_(e){(e&&e.length===40||Va(e))&&(this.log_("Admin auth credential detected.  Reducing max reconnect time."),this.maxReconnectDelay_=ti)}refreshAppCheckToken(e){this.appCheckToken_=e,this.log_("App check token refreshed"),this.appCheckToken_?this.tryAppCheck():this.connected_&&this.sendRequest("unappeck",{},()=>{})}tryAuth(){if(this.connected_&&this.authToken_){const e=this.authToken_,t=$a(e)?"auth":"gauth",s={cred:e};this.authOverride_===null?s.noauth=!0:typeof this.authOverride_=="object"&&(s.authvar=this.authOverride_),this.sendRequest(t,s,i=>{const r=i.s,o=i.d||"error";this.authToken_===e&&(r==="ok"?this.invalidAuthTokenCount_=0:this.onAuthRevoked_(r,o))})}}tryAppCheck(){this.connected_&&this.appCheckToken_&&this.sendRequest("appcheck",{token:this.appCheckToken_},e=>{const t=e.s,s=e.d||"error";t==="ok"?this.invalidAppCheckTokenCount_=0:this.onAppCheckRevoked_(t,s)})}unlisten(e,t){const s=e._path.toString(),i=e._queryIdentifier;this.log_("Unlisten called for "+s+" "+i),_(e._queryParams.isDefault()||!e._queryParams.loadsAllData(),"unlisten() called for non-default but complete query"),this.removeListen_(s,i)&&this.connected_&&this.sendUnlisten_(s,i,e._queryObject,t)}sendUnlisten_(e,t,s,i){this.log_("Unlisten on "+e+" for "+t);const r={p:e},o="n";i&&(r.q=s,r.t=i),this.sendRequest(o,r)}onDisconnectPut(e,t,s){this.initConnection_(),this.connected_?this.sendOnDisconnect_("o",e,t,s):this.onDisconnectRequestQueue_.push({pathString:e,action:"o",data:t,onComplete:s})}onDisconnectMerge(e,t,s){this.initConnection_(),this.connected_?this.sendOnDisconnect_("om",e,t,s):this.onDisconnectRequestQueue_.push({pathString:e,action:"om",data:t,onComplete:s})}onDisconnectCancel(e,t){this.initConnection_(),this.connected_?this.sendOnDisconnect_("oc",e,null,t):this.onDisconnectRequestQueue_.push({pathString:e,action:"oc",data:null,onComplete:t})}sendOnDisconnect_(e,t,s,i){const r={p:t,d:s};this.log_("onDisconnect "+e,r),this.sendRequest(e,r,o=>{i&&setTimeout(()=>{i(o.s,o.d)},Math.floor(0))})}put(e,t,s,i){this.putInternal("p",e,t,s,i)}merge(e,t,s,i){this.putInternal("m",e,t,s,i)}putInternal(e,t,s,i,r){this.initConnection_();const o={p:t,d:s};r!==void 0&&(o.h=r),this.outstandingPuts_.push({action:e,request:o,onComplete:i}),this.outstandingPutCount_++;const a=this.outstandingPuts_.length-1;this.connected_?this.sendPut_(a):this.log_("Buffering put: "+t)}sendPut_(e){const t=this.outstandingPuts_[e].action,s=this.outstandingPuts_[e].request,i=this.outstandingPuts_[e].onComplete;this.outstandingPuts_[e].queued=this.connected_,this.sendRequest(t,s,r=>{this.log_(t+" response",r),delete this.outstandingPuts_[e],this.outstandingPutCount_--,this.outstandingPutCount_===0&&(this.outstandingPuts_=[]),i&&i(r.s,r.d)})}reportStats(e){if(this.connected_){const t={c:e};this.log_("reportStats",t),this.sendRequest("s",t,s=>{if(s.s!=="ok"){const r=s.d;this.log_("reportStats","Error sending stats: "+r)}})}}onDataMessage_(e){if("r"in e){this.log_("from server: "+x(e));const t=e.r,s=this.requestCBHash_[t];s&&(delete this.requestCBHash_[t],s(e.b))}else{if("error"in e)throw"A server-side error has occurred: "+e.error;"a"in e&&this.onDataPush_(e.a,e.b)}}onDataPush_(e,t){this.log_("handleServerMessage",e,t),e==="d"?this.onDataUpdate_(t.p,t.d,!1,t.t):e==="m"?this.onDataUpdate_(t.p,t.d,!0,t.t):e==="c"?this.onListenRevoked_(t.p,t.q):e==="ac"?this.onAuthRevoked_(t.s,t.d):e==="apc"?this.onAppCheckRevoked_(t.s,t.d):e==="sd"?this.onSecurityDebugPacket_(t):kn("Unrecognized action received from server: "+x(e)+`
Are you using the latest client?`)}onReady_(e,t){this.log_("connection ready"),this.connected_=!0,this.lastConnectionEstablishedTime_=new Date().getTime(),this.handleTimestamp_(e),this.lastSessionId=t,this.firstConnection_&&this.sendConnectStats_(),this.restoreState_(),this.firstConnection_=!1,this.onConnectStatus_(!0)}scheduleConnect_(e){_(!this.realtime_,"Scheduling a connect when we're already connected/ing?"),this.establishConnectionTimer_&&clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=setTimeout(()=>{this.establishConnectionTimer_=null,this.establishConnection_()},Math.floor(e))}initConnection_(){!this.realtime_&&this.firstConnection_&&this.scheduleConnect_(0)}onVisible_(e){e&&!this.visible_&&this.reconnectDelay_===this.maxReconnectDelay_&&(this.log_("Window became visible.  Reducing delay."),this.reconnectDelay_=Ze,this.realtime_||this.scheduleConnect_(0)),this.visible_=e}onOnline_(e){e?(this.log_("Browser went online."),this.reconnectDelay_=Ze,this.realtime_||this.scheduleConnect_(0)):(this.log_("Browser went offline.  Killing connection."),this.realtime_&&this.realtime_.close())}onRealtimeDisconnect_(){if(this.log_("data client disconnected"),this.connected_=!1,this.realtime_=null,this.cancelSentTransactions_(),this.requestCBHash_={},this.shouldReconnect_()){this.visible_?this.lastConnectionEstablishedTime_&&(new Date().getTime()-this.lastConnectionEstablishedTime_>ih&&(this.reconnectDelay_=Ze),this.lastConnectionEstablishedTime_=null):(this.log_("Window isn't visible.  Delaying reconnect."),this.reconnectDelay_=this.maxReconnectDelay_,this.lastConnectionAttemptTime_=new Date().getTime());const e=Math.max(0,new Date().getTime()-this.lastConnectionAttemptTime_);let t=Math.max(0,this.reconnectDelay_-e);t=Math.random()*t,this.log_("Trying to reconnect in "+t+"ms"),this.scheduleConnect_(t),this.reconnectDelay_=Math.min(this.maxReconnectDelay_,this.reconnectDelay_*sh)}this.onConnectStatus_(!1)}async establishConnection_(){if(this.shouldReconnect_()){this.log_("Making a connection attempt"),this.lastConnectionAttemptTime_=new Date().getTime(),this.lastConnectionEstablishedTime_=null;const e=this.onDataMessage_.bind(this),t=this.onReady_.bind(this),s=this.onRealtimeDisconnect_.bind(this),i=this.id+":"+oe.nextConnectionId_++,r=this.lastSessionId;let o=!1,a=null;const l=function(){a?a.close():(o=!0,s())},c=function(u){_(a,"sendRequest call when we're not connected not allowed."),a.sendRequest(u)};this.realtime_={close:l,sendRequest:c};const f=this.forceTokenRefresh_;this.forceTokenRefresh_=!1;try{const[u,h]=await Promise.all([this.authTokenProvider_.getToken(f),this.appCheckTokenProvider_.getToken(f)]);o?W("getToken() completed but was canceled"):(W("getToken() completed. Creating connection."),this.authToken_=u&&u.accessToken,this.appCheckToken_=h&&h.token,a=new Qc(i,this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,e,t,s,p=>{H(p+" ("+this.repoInfo_.toString()+")"),this.interrupt(rh)},r))}catch(u){this.log_("Failed to get token: "+u),o||(this.repoInfo_.nodeAdmin&&H(u),l())}}}interrupt(e){W("Interrupting connection for reason: "+e),this.interruptReasons_[e]=!0,this.realtime_?this.realtime_.close():(this.establishConnectionTimer_&&(clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=null),this.connected_&&this.onRealtimeDisconnect_())}resume(e){W("Resuming connection for reason: "+e),delete this.interruptReasons_[e],Tn(this.interruptReasons_)&&(this.reconnectDelay_=Ze,this.realtime_||this.scheduleConnect_(0))}handleTimestamp_(e){const t=e-new Date().getTime();this.onServerInfoUpdate_({serverTimeOffset:t})}cancelSentTransactions_(){for(let e=0;e<this.outstandingPuts_.length;e++){const t=this.outstandingPuts_[e];t&&"h"in t.request&&t.queued&&(t.onComplete&&t.onComplete("disconnect"),delete this.outstandingPuts_[e],this.outstandingPutCount_--)}this.outstandingPutCount_===0&&(this.outstandingPuts_=[])}onListenRevoked_(e,t){let s;t?s=t.map(r=>Qn(r)).join("$"):s="default";const i=this.removeListen_(e,s);i&&i.onComplete&&i.onComplete("permission_denied")}removeListen_(e,t){const s=new N(e).toString();let i;if(this.listens.has(s)){const r=this.listens.get(s);i=r.get(t),r.delete(t),r.size===0&&this.listens.delete(s)}else i=void 0;return i}onAuthRevoked_(e,t){W("Auth token revoked: "+e+"/"+t),this.authToken_=null,this.forceTokenRefresh_=!0,this.realtime_.close(),(e==="invalid_token"||e==="permission_denied")&&(this.invalidAuthTokenCount_++,this.invalidAuthTokenCount_>=ni&&(this.reconnectDelay_=ti,this.authTokenProvider_.notifyForInvalidToken()))}onAppCheckRevoked_(e,t){W("App check token revoked: "+e+"/"+t),this.appCheckToken_=null,this.forceTokenRefresh_=!0,(e==="invalid_token"||e==="permission_denied")&&(this.invalidAppCheckTokenCount_++,this.invalidAppCheckTokenCount_>=ni&&this.appCheckTokenProvider_.notifyForInvalidToken())}onSecurityDebugPacket_(e){this.securityDebugCallback_?this.securityDebugCallback_(e):"msg"in e&&console.log("FIREBASE: "+e.msg.replace(`
`,`
FIREBASE: `))}restoreState_(){this.tryAuth(),this.tryAppCheck();for(const e of this.listens.values())for(const t of e.values())this.sendListen_(t);for(let e=0;e<this.outstandingPuts_.length;e++)this.outstandingPuts_[e]&&this.sendPut_(e);for(;this.onDisconnectRequestQueue_.length;){const e=this.onDisconnectRequestQueue_.shift();this.sendOnDisconnect_(e.action,e.pathString,e.data,e.onComplete)}for(let e=0;e<this.outstandingGets_.length;e++)this.outstandingGets_[e]&&this.sendGet_(e)}sendConnectStats_(){const e={};let t="js";e["sdk."+t+"."+Yi.replace(/\./g,"-")]=1,Wi()?e["framework.cordova"]=1:xa()&&(e["framework.reactnative"]=1),this.reportStats(e)}shouldReconnect_(){const e=Wt.getInstance().currentlyOnline();return Tn(this.interruptReasons_)&&e}}oe.nextPersistentConnectionId_=0;oe.nextConnectionId_=0;class S{constructor(e,t){this.name=e,this.node=t}static Wrap(e,t){return new S(e,t)}}class en{getCompare(){return this.compare.bind(this)}indexedValueChanged(e,t){const s=new S(He,e),i=new S(He,t);return this.compare(s,i)!==0}minPost(){return S.MIN}}let At;class Er extends en{static get __EMPTY_NODE(){return At}static set __EMPTY_NODE(e){At=e}compare(e,t){return De(e.name,t.name)}isDefinedOn(e){throw je("KeyIndex.isDefinedOn not expected to be called.")}indexedValueChanged(e,t){return!1}minPost(){return S.MIN}maxPost(){return new S(Ne,At)}makePost(e,t){return _(typeof e=="string","KeyIndex indexValue must always be a string."),new S(e,At)}toString(){return".key"}}const We=new Er;class Ot{constructor(e,t,s,i,r=null){this.isReverse_=i,this.resultGenerator_=r,this.nodeStack_=[];let o=1;for(;!e.isEmpty();)if(e=e,o=t?s(e.key,t):1,i&&(o*=-1),o<0)this.isReverse_?e=e.left:e=e.right;else if(o===0){this.nodeStack_.push(e);break}else this.nodeStack_.push(e),this.isReverse_?e=e.right:e=e.left}getNext(){if(this.nodeStack_.length===0)return null;let e=this.nodeStack_.pop(),t;if(this.resultGenerator_?t=this.resultGenerator_(e.key,e.value):t={key:e.key,value:e.value},this.isReverse_)for(e=e.left;!e.isEmpty();)this.nodeStack_.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack_.push(e),e=e.left;return t}hasNext(){return this.nodeStack_.length>0}peek(){if(this.nodeStack_.length===0)return null;const e=this.nodeStack_[this.nodeStack_.length-1];return this.resultGenerator_?this.resultGenerator_(e.key,e.value):{key:e.key,value:e.value}}}class F{constructor(e,t,s,i,r){this.key=e,this.value=t,this.color=s??F.RED,this.left=i??V.EMPTY_NODE,this.right=r??V.EMPTY_NODE}copy(e,t,s,i,r){return new F(e??this.key,t??this.value,s??this.color,i??this.left,r??this.right)}count(){return this.left.count()+1+this.right.count()}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||!!e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min_(){return this.left.isEmpty()?this:this.left.min_()}minKey(){return this.min_().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,s){let i=this;const r=s(e,i.key);return r<0?i=i.copy(null,null,null,i.left.insert(e,t,s),null):r===0?i=i.copy(null,t,null,null,null):i=i.copy(null,null,null,null,i.right.insert(e,t,s)),i.fixUp_()}removeMin_(){if(this.left.isEmpty())return V.EMPTY_NODE;let e=this;return!e.left.isRed_()&&!e.left.left.isRed_()&&(e=e.moveRedLeft_()),e=e.copy(null,null,null,e.left.removeMin_(),null),e.fixUp_()}remove(e,t){let s,i;if(s=this,t(e,s.key)<0)!s.left.isEmpty()&&!s.left.isRed_()&&!s.left.left.isRed_()&&(s=s.moveRedLeft_()),s=s.copy(null,null,null,s.left.remove(e,t),null);else{if(s.left.isRed_()&&(s=s.rotateRight_()),!s.right.isEmpty()&&!s.right.isRed_()&&!s.right.left.isRed_()&&(s=s.moveRedRight_()),t(e,s.key)===0){if(s.right.isEmpty())return V.EMPTY_NODE;i=s.right.min_(),s=s.copy(i.key,i.value,null,null,s.right.removeMin_())}s=s.copy(null,null,null,null,s.right.remove(e,t))}return s.fixUp_()}isRed_(){return this.color}fixUp_(){let e=this;return e.right.isRed_()&&!e.left.isRed_()&&(e=e.rotateLeft_()),e.left.isRed_()&&e.left.left.isRed_()&&(e=e.rotateRight_()),e.left.isRed_()&&e.right.isRed_()&&(e=e.colorFlip_()),e}moveRedLeft_(){let e=this.colorFlip_();return e.right.left.isRed_()&&(e=e.copy(null,null,null,null,e.right.rotateRight_()),e=e.rotateLeft_(),e=e.colorFlip_()),e}moveRedRight_(){let e=this.colorFlip_();return e.left.left.isRed_()&&(e=e.rotateRight_(),e=e.colorFlip_()),e}rotateLeft_(){const e=this.copy(null,null,F.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight_(){const e=this.copy(null,null,F.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip_(){const e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth_(){const e=this.check_();return Math.pow(2,e)<=this.count()+1}check_(){if(this.isRed_()&&this.left.isRed_())throw new Error("Red node has red child("+this.key+","+this.value+")");if(this.right.isRed_())throw new Error("Right child of ("+this.key+","+this.value+") is red");const e=this.left.check_();if(e!==this.right.check_())throw new Error("Black depths differ");return e+(this.isRed_()?0:1)}}F.RED=!0;F.BLACK=!1;class oh{copy(e,t,s,i,r){return this}insert(e,t,s){return new F(e,t,null)}remove(e,t){return this}count(){return 0}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}check_(){return 0}isRed_(){return!1}}class V{constructor(e,t=V.EMPTY_NODE){this.comparator_=e,this.root_=t}insert(e,t){return new V(this.comparator_,this.root_.insert(e,t,this.comparator_).copy(null,null,F.BLACK,null,null))}remove(e){return new V(this.comparator_,this.root_.remove(e,this.comparator_).copy(null,null,F.BLACK,null,null))}get(e){let t,s=this.root_;for(;!s.isEmpty();){if(t=this.comparator_(e,s.key),t===0)return s.value;t<0?s=s.left:t>0&&(s=s.right)}return null}getPredecessorKey(e){let t,s=this.root_,i=null;for(;!s.isEmpty();)if(t=this.comparator_(e,s.key),t===0){if(s.left.isEmpty())return i?i.key:null;for(s=s.left;!s.right.isEmpty();)s=s.right;return s.key}else t<0?s=s.left:t>0&&(i=s,s=s.right);throw new Error("Attempted to find predecessor key for a nonexistent key.  What gives?")}isEmpty(){return this.root_.isEmpty()}count(){return this.root_.count()}minKey(){return this.root_.minKey()}maxKey(){return this.root_.maxKey()}inorderTraversal(e){return this.root_.inorderTraversal(e)}reverseTraversal(e){return this.root_.reverseTraversal(e)}getIterator(e){return new Ot(this.root_,null,this.comparator_,!1,e)}getIteratorFrom(e,t){return new Ot(this.root_,e,this.comparator_,!1,t)}getReverseIteratorFrom(e,t){return new Ot(this.root_,e,this.comparator_,!0,t)}getReverseIterator(e){return new Ot(this.root_,null,this.comparator_,!0,e)}}V.EMPTY_NODE=new oh;function ah(n,e){return De(n.name,e.name)}function ss(n,e){return De(n,e)}let Ln;function lh(n){Ln=n}const Cr=function(n){return typeof n=="number"?"number:"+Ji(n):"string:"+n},vr=function(n){if(n.isLeafNode()){const e=n.val();_(typeof e=="string"||typeof e=="number"||typeof e=="object"&&se(e,".sv"),"Priority must be a string or number.")}else _(n===Ln||n.isEmpty(),"priority of unexpected type.");_(n===Ln||n.getPriority().isEmpty(),"Priority nodes can't have a priority of their own.")};let si;class B{static set __childrenNodeConstructor(e){si=e}static get __childrenNodeConstructor(){return si}constructor(e,t=B.__childrenNodeConstructor.EMPTY_NODE){this.value_=e,this.priorityNode_=t,this.lazyHash_=null,_(this.value_!==void 0&&this.value_!==null,"LeafNode shouldn't be created with null/undefined value."),vr(this.priorityNode_)}isLeafNode(){return!0}getPriority(){return this.priorityNode_}updatePriority(e){return new B(this.value_,e)}getImmediateChild(e){return e===".priority"?this.priorityNode_:B.__childrenNodeConstructor.EMPTY_NODE}getChild(e){return v(e)?this:C(e)===".priority"?this.priorityNode_:B.__childrenNodeConstructor.EMPTY_NODE}hasChild(){return!1}getPredecessorChildName(e,t){return null}updateImmediateChild(e,t){return e===".priority"?this.updatePriority(t):t.isEmpty()&&e!==".priority"?this:B.__childrenNodeConstructor.EMPTY_NODE.updateImmediateChild(e,t).updatePriority(this.priorityNode_)}updateChild(e,t){const s=C(e);return s===null?t:t.isEmpty()&&s!==".priority"?this:(_(s!==".priority"||ye(e)===1,".priority must be the last token in a path"),this.updateImmediateChild(s,B.__childrenNodeConstructor.EMPTY_NODE.updateChild(R(e),t)))}isEmpty(){return!1}numChildren(){return 0}forEachChild(e,t){return!1}val(e){return e&&!this.getPriority().isEmpty()?{".value":this.getValue(),".priority":this.getPriority().val()}:this.getValue()}hash(){if(this.lazyHash_===null){let e="";this.priorityNode_.isEmpty()||(e+="priority:"+Cr(this.priorityNode_.val())+":");const t=typeof this.value_;e+=t+":",t==="number"?e+=Ji(this.value_):e+=this.value_,this.lazyHash_=Qi(e)}return this.lazyHash_}getValue(){return this.value_}compareTo(e){return e===B.__childrenNodeConstructor.EMPTY_NODE?1:e instanceof B.__childrenNodeConstructor?-1:(_(e.isLeafNode(),"Unknown node type"),this.compareToLeafNode_(e))}compareToLeafNode_(e){const t=typeof e.value_,s=typeof this.value_,i=B.VALUE_TYPE_ORDER.indexOf(t),r=B.VALUE_TYPE_ORDER.indexOf(s);return _(i>=0,"Unknown leaf type: "+t),_(r>=0,"Unknown leaf type: "+s),i===r?s==="object"?0:this.value_<e.value_?-1:this.value_===e.value_?0:1:r-i}withIndex(){return this}isIndexed(){return!0}equals(e){if(e===this)return!0;if(e.isLeafNode()){const t=e;return this.value_===t.value_&&this.priorityNode_.equals(t.priorityNode_)}else return!1}}B.VALUE_TYPE_ORDER=["object","boolean","number","string"];let Sr,Ir;function ch(n){Sr=n}function hh(n){Ir=n}class uh extends en{compare(e,t){const s=e.node.getPriority(),i=t.node.getPriority(),r=s.compareTo(i);return r===0?De(e.name,t.name):r}isDefinedOn(e){return!e.getPriority().isEmpty()}indexedValueChanged(e,t){return!e.getPriority().equals(t.getPriority())}minPost(){return S.MIN}maxPost(){return new S(Ne,new B("[PRIORITY-POST]",Ir))}makePost(e,t){const s=Sr(e);return new S(t,new B("[PRIORITY-POST]",s))}toString(){return".priority"}}const k=new uh;const dh=Math.log(2);class fh{constructor(e){const t=r=>parseInt(Math.log(r)/dh,10),s=r=>parseInt(Array(r+1).join("1"),2);this.count=t(e+1),this.current_=this.count-1;const i=s(this.count);this.bits_=e+1&i}nextBitIsOne(){const e=!(this.bits_&1<<this.current_);return this.current_--,e}}const Gt=function(n,e,t,s){n.sort(e);const i=function(l,c){const f=c-l;let u,h;if(f===0)return null;if(f===1)return u=n[l],h=t?t(u):u,new F(h,u.node,F.BLACK,null,null);{const p=parseInt(f/2,10)+l,m=i(l,p),g=i(p+1,c);return u=n[p],h=t?t(u):u,new F(h,u.node,F.BLACK,m,g)}},r=function(l){let c=null,f=null,u=n.length;const h=function(m,g){const w=u-m,P=u;u-=m;const E=i(w+1,P),b=n[w],M=t?t(b):b;p(new F(M,b.node,g,null,E))},p=function(m){c?(c.left=m,c=m):(f=m,c=m)};for(let m=0;m<l.count;++m){const g=l.nextBitIsOne(),w=Math.pow(2,l.count-(m+1));g?h(w,F.BLACK):(h(w,F.BLACK),h(w,F.RED))}return f},o=new fh(n.length),a=r(o);return new V(s||e,a)};let Cn;const Le={};class re{static get Default(){return _(Le&&k,"ChildrenNode.ts has not been loaded"),Cn=Cn||new re({".priority":Le},{".priority":k}),Cn}constructor(e,t){this.indexes_=e,this.indexSet_=t}get(e){const t=Ge(this.indexes_,e);if(!t)throw new Error("No index defined for "+e);return t instanceof V?t:null}hasIndex(e){return se(this.indexSet_,e.toString())}addIndex(e,t){_(e!==We,"KeyIndex always exists and isn't meant to be added to the IndexMap.");const s=[];let i=!1;const r=t.getIterator(S.Wrap);let o=r.getNext();for(;o;)i=i||e.isDefinedOn(o.node),s.push(o),o=r.getNext();let a;i?a=Gt(s,e.getCompare()):a=Le;const l=e.toString(),c={...this.indexSet_};c[l]=e;const f={...this.indexes_};return f[l]=a,new re(f,c)}addToIndexes(e,t){const s=Lt(this.indexes_,(i,r)=>{const o=Ge(this.indexSet_,r);if(_(o,"Missing index implementation for "+r),i===Le)if(o.isDefinedOn(e.node)){const a=[],l=t.getIterator(S.Wrap);let c=l.getNext();for(;c;)c.name!==e.name&&a.push(c),c=l.getNext();return a.push(e),Gt(a,o.getCompare())}else return Le;else{const a=t.get(e.name);let l=i;return a&&(l=l.remove(new S(e.name,a))),l.insert(e,e.node)}});return new re(s,this.indexSet_)}removeFromIndexes(e,t){const s=Lt(this.indexes_,i=>{if(i===Le)return i;{const r=t.get(e.name);return r?i.remove(new S(e.name,r)):i}});return new re(s,this.indexSet_)}}let et;class y{static get EMPTY_NODE(){return et||(et=new y(new V(ss),null,re.Default))}constructor(e,t,s){this.children_=e,this.priorityNode_=t,this.indexMap_=s,this.lazyHash_=null,this.priorityNode_&&vr(this.priorityNode_),this.children_.isEmpty()&&_(!this.priorityNode_||this.priorityNode_.isEmpty(),"An empty node cannot have a priority")}isLeafNode(){return!1}getPriority(){return this.priorityNode_||et}updatePriority(e){return this.children_.isEmpty()?this:new y(this.children_,e,this.indexMap_)}getImmediateChild(e){if(e===".priority")return this.getPriority();{const t=this.children_.get(e);return t===null?et:t}}getChild(e){const t=C(e);return t===null?this:this.getImmediateChild(t).getChild(R(e))}hasChild(e){return this.children_.get(e)!==null}updateImmediateChild(e,t){if(_(t,"We should always be passing snapshot nodes"),e===".priority")return this.updatePriority(t);{const s=new S(e,t);let i,r;t.isEmpty()?(i=this.children_.remove(e),r=this.indexMap_.removeFromIndexes(s,this.children_)):(i=this.children_.insert(e,t),r=this.indexMap_.addToIndexes(s,this.children_));const o=i.isEmpty()?et:this.priorityNode_;return new y(i,o,r)}}updateChild(e,t){const s=C(e);if(s===null)return t;{_(C(e)!==".priority"||ye(e)===1,".priority must be the last token in a path");const i=this.getImmediateChild(s).updateChild(R(e),t);return this.updateImmediateChild(s,i)}}isEmpty(){return this.children_.isEmpty()}numChildren(){return this.children_.count()}val(e){if(this.isEmpty())return null;const t={};let s=0,i=0,r=!0;if(this.forEachChild(k,(o,a)=>{t[o]=a.val(e),s++,r&&y.INTEGER_REGEXP_.test(o)?i=Math.max(i,Number(o)):r=!1}),!e&&r&&i<2*s){const o=[];for(const a in t)o[a]=t[a];return o}else return e&&!this.getPriority().isEmpty()&&(t[".priority"]=this.getPriority().val()),t}hash(){if(this.lazyHash_===null){let e="";this.getPriority().isEmpty()||(e+="priority:"+Cr(this.getPriority().val())+":"),this.forEachChild(k,(t,s)=>{const i=s.hash();i!==""&&(e+=":"+t+":"+i)}),this.lazyHash_=e===""?"":Qi(e)}return this.lazyHash_}getPredecessorChildName(e,t,s){const i=this.resolveIndex_(s);if(i){const r=i.getPredecessorKey(new S(e,t));return r?r.name:null}else return this.children_.getPredecessorKey(e)}getFirstChildName(e){const t=this.resolveIndex_(e);if(t){const s=t.minKey();return s&&s.name}else return this.children_.minKey()}getFirstChild(e){const t=this.getFirstChildName(e);return t?new S(t,this.children_.get(t)):null}getLastChildName(e){const t=this.resolveIndex_(e);if(t){const s=t.maxKey();return s&&s.name}else return this.children_.maxKey()}getLastChild(e){const t=this.getLastChildName(e);return t?new S(t,this.children_.get(t)):null}forEachChild(e,t){const s=this.resolveIndex_(e);return s?s.inorderTraversal(i=>t(i.name,i.node)):this.children_.inorderTraversal(t)}getIterator(e){return this.getIteratorFrom(e.minPost(),e)}getIteratorFrom(e,t){const s=this.resolveIndex_(t);if(s)return s.getIteratorFrom(e,i=>i);{const i=this.children_.getIteratorFrom(e.name,S.Wrap);let r=i.peek();for(;r!=null&&t.compare(r,e)<0;)i.getNext(),r=i.peek();return i}}getReverseIterator(e){return this.getReverseIteratorFrom(e.maxPost(),e)}getReverseIteratorFrom(e,t){const s=this.resolveIndex_(t);if(s)return s.getReverseIteratorFrom(e,i=>i);{const i=this.children_.getReverseIteratorFrom(e.name,S.Wrap);let r=i.peek();for(;r!=null&&t.compare(r,e)>0;)i.getNext(),r=i.peek();return i}}compareTo(e){return this.isEmpty()?e.isEmpty()?0:-1:e.isLeafNode()||e.isEmpty()?1:e===wt?-1:0}withIndex(e){if(e===We||this.indexMap_.hasIndex(e))return this;{const t=this.indexMap_.addIndex(e,this.children_);return new y(this.children_,this.priorityNode_,t)}}isIndexed(e){return e===We||this.indexMap_.hasIndex(e)}equals(e){if(e===this)return!0;if(e.isLeafNode())return!1;{const t=e;if(this.getPriority().equals(t.getPriority()))if(this.children_.count()===t.children_.count()){const s=this.getIterator(k),i=t.getIterator(k);let r=s.getNext(),o=i.getNext();for(;r&&o;){if(r.name!==o.name||!r.node.equals(o.node))return!1;r=s.getNext(),o=i.getNext()}return r===null&&o===null}else return!1;else return!1}}resolveIndex_(e){return e===We?null:this.indexMap_.get(e.toString())}}y.INTEGER_REGEXP_=/^(0|[1-9]\d*)$/;class ph extends y{constructor(){super(new V(ss),y.EMPTY_NODE,re.Default)}compareTo(e){return e===this?0:1}equals(e){return e===this}getPriority(){return this}getImmediateChild(e){return y.EMPTY_NODE}isEmpty(){return!1}}const wt=new ph;Object.defineProperties(S,{MIN:{value:new S(He,y.EMPTY_NODE)},MAX:{value:new S(Ne,wt)}});Er.__EMPTY_NODE=y.EMPTY_NODE;B.__childrenNodeConstructor=y;lh(wt);hh(wt);const _h=!0;function L(n,e=null){if(n===null)return y.EMPTY_NODE;if(typeof n=="object"&&".priority"in n&&(e=n[".priority"]),_(e===null||typeof e=="string"||typeof e=="number"||typeof e=="object"&&".sv"in e,"Invalid priority type found: "+typeof e),typeof n=="object"&&".value"in n&&n[".value"]!==null&&(n=n[".value"]),typeof n!="object"||".sv"in n){const t=n;return new B(t,L(e))}if(!(n instanceof Array)&&_h){const t=[];let s=!1;if(G(n,(o,a)=>{if(o.substring(0,1)!=="."){const l=L(a);l.isEmpty()||(s=s||!l.getPriority().isEmpty(),t.push(new S(o,l)))}}),t.length===0)return y.EMPTY_NODE;const r=Gt(t,ah,o=>o.name,ss);if(s){const o=Gt(t,k.getCompare());return new y(r,L(e),new re({".priority":o},{".priority":k}))}else return new y(r,L(e),re.Default)}else{let t=y.EMPTY_NODE;return G(n,(s,i)=>{if(se(n,s)&&s.substring(0,1)!=="."){const r=L(i);(r.isLeafNode()||!r.isEmpty())&&(t=t.updateImmediateChild(s,r))}}),t.updatePriority(L(e))}}ch(L);class mh extends en{constructor(e){super(),this.indexPath_=e,_(!v(e)&&C(e)!==".priority","Can't create PathIndex with empty path or .priority key")}extractChild(e){return e.getChild(this.indexPath_)}isDefinedOn(e){return!e.getChild(this.indexPath_).isEmpty()}compare(e,t){const s=this.extractChild(e.node),i=this.extractChild(t.node),r=s.compareTo(i);return r===0?De(e.name,t.name):r}makePost(e,t){const s=L(e),i=y.EMPTY_NODE.updateChild(this.indexPath_,s);return new S(t,i)}maxPost(){const e=y.EMPTY_NODE.updateChild(this.indexPath_,wt);return new S(Ne,e)}toString(){return pt(this.indexPath_,0).join("/")}}class gh extends en{compare(e,t){const s=e.node.compareTo(t.node);return s===0?De(e.name,t.name):s}isDefinedOn(e){return!0}indexedValueChanged(e,t){return!e.equals(t)}minPost(){return S.MIN}maxPost(){return S.MAX}makePost(e,t){const s=L(e);return new S(t,s)}toString(){return".value"}}const yh=new gh;function br(n){return{type:"value",snapshotNode:n}}function $e(n,e){return{type:"child_added",snapshotNode:e,childName:n}}function _t(n,e){return{type:"child_removed",snapshotNode:e,childName:n}}function mt(n,e,t){return{type:"child_changed",snapshotNode:e,childName:n,oldSnap:t}}function Eh(n,e){return{type:"child_moved",snapshotNode:e,childName:n}}class is{constructor(e){this.index_=e}updateChild(e,t,s,i,r,o){_(e.isIndexed(this.index_),"A node must be indexed if only a child is updated");const a=e.getImmediateChild(t);return a.getChild(i).equals(s.getChild(i))&&a.isEmpty()===s.isEmpty()||(o!=null&&(s.isEmpty()?e.hasChild(t)?o.trackChildChange(_t(t,a)):_(e.isLeafNode(),"A child remove without an old child only makes sense on a leaf node"):a.isEmpty()?o.trackChildChange($e(t,s)):o.trackChildChange(mt(t,s,a))),e.isLeafNode()&&s.isEmpty())?e:e.updateImmediateChild(t,s).withIndex(this.index_)}updateFullNode(e,t,s){return s!=null&&(e.isLeafNode()||e.forEachChild(k,(i,r)=>{t.hasChild(i)||s.trackChildChange(_t(i,r))}),t.isLeafNode()||t.forEachChild(k,(i,r)=>{if(e.hasChild(i)){const o=e.getImmediateChild(i);o.equals(r)||s.trackChildChange(mt(i,r,o))}else s.trackChildChange($e(i,r))})),t.withIndex(this.index_)}updatePriority(e,t){return e.isEmpty()?y.EMPTY_NODE:e.updatePriority(t)}filtersNodes(){return!1}getIndexedFilter(){return this}getIndex(){return this.index_}}class gt{constructor(e){this.indexedFilter_=new is(e.getIndex()),this.index_=e.getIndex(),this.startPost_=gt.getStartPost_(e),this.endPost_=gt.getEndPost_(e),this.startIsInclusive_=!e.startAfterSet_,this.endIsInclusive_=!e.endBeforeSet_}getStartPost(){return this.startPost_}getEndPost(){return this.endPost_}matches(e){const t=this.startIsInclusive_?this.index_.compare(this.getStartPost(),e)<=0:this.index_.compare(this.getStartPost(),e)<0,s=this.endIsInclusive_?this.index_.compare(e,this.getEndPost())<=0:this.index_.compare(e,this.getEndPost())<0;return t&&s}updateChild(e,t,s,i,r,o){return this.matches(new S(t,s))||(s=y.EMPTY_NODE),this.indexedFilter_.updateChild(e,t,s,i,r,o)}updateFullNode(e,t,s){t.isLeafNode()&&(t=y.EMPTY_NODE);let i=t.withIndex(this.index_);i=i.updatePriority(y.EMPTY_NODE);const r=this;return t.forEachChild(k,(o,a)=>{r.matches(new S(o,a))||(i=i.updateImmediateChild(o,y.EMPTY_NODE))}),this.indexedFilter_.updateFullNode(e,i,s)}updatePriority(e,t){return e}filtersNodes(){return!0}getIndexedFilter(){return this.indexedFilter_}getIndex(){return this.index_}static getStartPost_(e){if(e.hasStart()){const t=e.getIndexStartName();return e.getIndex().makePost(e.getIndexStartValue(),t)}else return e.getIndex().minPost()}static getEndPost_(e){if(e.hasEnd()){const t=e.getIndexEndName();return e.getIndex().makePost(e.getIndexEndValue(),t)}else return e.getIndex().maxPost()}}class Ch{constructor(e){this.withinDirectionalStart=t=>this.reverse_?this.withinEndPost(t):this.withinStartPost(t),this.withinDirectionalEnd=t=>this.reverse_?this.withinStartPost(t):this.withinEndPost(t),this.withinStartPost=t=>{const s=this.index_.compare(this.rangedFilter_.getStartPost(),t);return this.startIsInclusive_?s<=0:s<0},this.withinEndPost=t=>{const s=this.index_.compare(t,this.rangedFilter_.getEndPost());return this.endIsInclusive_?s<=0:s<0},this.rangedFilter_=new gt(e),this.index_=e.getIndex(),this.limit_=e.getLimit(),this.reverse_=!e.isViewFromLeft(),this.startIsInclusive_=!e.startAfterSet_,this.endIsInclusive_=!e.endBeforeSet_}updateChild(e,t,s,i,r,o){return this.rangedFilter_.matches(new S(t,s))||(s=y.EMPTY_NODE),e.getImmediateChild(t).equals(s)?e:e.numChildren()<this.limit_?this.rangedFilter_.getIndexedFilter().updateChild(e,t,s,i,r,o):this.fullLimitUpdateChild_(e,t,s,r,o)}updateFullNode(e,t,s){let i;if(t.isLeafNode()||t.isEmpty())i=y.EMPTY_NODE.withIndex(this.index_);else if(this.limit_*2<t.numChildren()&&t.isIndexed(this.index_)){i=y.EMPTY_NODE.withIndex(this.index_);let r;this.reverse_?r=t.getReverseIteratorFrom(this.rangedFilter_.getEndPost(),this.index_):r=t.getIteratorFrom(this.rangedFilter_.getStartPost(),this.index_);let o=0;for(;r.hasNext()&&o<this.limit_;){const a=r.getNext();if(this.withinDirectionalStart(a))if(this.withinDirectionalEnd(a))i=i.updateImmediateChild(a.name,a.node),o++;else break;else continue}}else{i=t.withIndex(this.index_),i=i.updatePriority(y.EMPTY_NODE);let r;this.reverse_?r=i.getReverseIterator(this.index_):r=i.getIterator(this.index_);let o=0;for(;r.hasNext();){const a=r.getNext();o<this.limit_&&this.withinDirectionalStart(a)&&this.withinDirectionalEnd(a)?o++:i=i.updateImmediateChild(a.name,y.EMPTY_NODE)}}return this.rangedFilter_.getIndexedFilter().updateFullNode(e,i,s)}updatePriority(e,t){return e}filtersNodes(){return!0}getIndexedFilter(){return this.rangedFilter_.getIndexedFilter()}getIndex(){return this.index_}fullLimitUpdateChild_(e,t,s,i,r){let o;if(this.reverse_){const u=this.index_.getCompare();o=(h,p)=>u(p,h)}else o=this.index_.getCompare();const a=e;_(a.numChildren()===this.limit_,"");const l=new S(t,s),c=this.reverse_?a.getFirstChild(this.index_):a.getLastChild(this.index_),f=this.rangedFilter_.matches(l);if(a.hasChild(t)){const u=a.getImmediateChild(t);let h=i.getChildAfterChild(this.index_,c,this.reverse_);for(;h!=null&&(h.name===t||a.hasChild(h.name));)h=i.getChildAfterChild(this.index_,h,this.reverse_);const p=h==null?1:o(h,l);if(f&&!s.isEmpty()&&p>=0)return r?.trackChildChange(mt(t,s,u)),a.updateImmediateChild(t,s);{r?.trackChildChange(_t(t,u));const g=a.updateImmediateChild(t,y.EMPTY_NODE);return h!=null&&this.rangedFilter_.matches(h)?(r?.trackChildChange($e(h.name,h.node)),g.updateImmediateChild(h.name,h.node)):g}}else return s.isEmpty()?e:f&&o(c,l)>=0?(r!=null&&(r.trackChildChange(_t(c.name,c.node)),r.trackChildChange($e(t,s))),a.updateImmediateChild(t,s).updateImmediateChild(c.name,y.EMPTY_NODE)):e}}class rs{constructor(){this.limitSet_=!1,this.startSet_=!1,this.startNameSet_=!1,this.startAfterSet_=!1,this.endSet_=!1,this.endNameSet_=!1,this.endBeforeSet_=!1,this.limit_=0,this.viewFrom_="",this.indexStartValue_=null,this.indexStartName_="",this.indexEndValue_=null,this.indexEndName_="",this.index_=k}hasStart(){return this.startSet_}isViewFromLeft(){return this.viewFrom_===""?this.startSet_:this.viewFrom_==="l"}getIndexStartValue(){return _(this.startSet_,"Only valid if start has been set"),this.indexStartValue_}getIndexStartName(){return _(this.startSet_,"Only valid if start has been set"),this.startNameSet_?this.indexStartName_:He}hasEnd(){return this.endSet_}getIndexEndValue(){return _(this.endSet_,"Only valid if end has been set"),this.indexEndValue_}getIndexEndName(){return _(this.endSet_,"Only valid if end has been set"),this.endNameSet_?this.indexEndName_:Ne}hasLimit(){return this.limitSet_}hasAnchoredLimit(){return this.limitSet_&&this.viewFrom_!==""}getLimit(){return _(this.limitSet_,"Only valid if limit has been set"),this.limit_}getIndex(){return this.index_}loadsAllData(){return!(this.startSet_||this.endSet_||this.limitSet_)}isDefault(){return this.loadsAllData()&&this.index_===k}copy(){const e=new rs;return e.limitSet_=this.limitSet_,e.limit_=this.limit_,e.startSet_=this.startSet_,e.startAfterSet_=this.startAfterSet_,e.indexStartValue_=this.indexStartValue_,e.startNameSet_=this.startNameSet_,e.indexStartName_=this.indexStartName_,e.endSet_=this.endSet_,e.endBeforeSet_=this.endBeforeSet_,e.indexEndValue_=this.indexEndValue_,e.endNameSet_=this.endNameSet_,e.indexEndName_=this.indexEndName_,e.index_=this.index_,e.viewFrom_=this.viewFrom_,e}}function vh(n){return n.loadsAllData()?new is(n.getIndex()):n.hasLimit()?new Ch(n):new gt(n)}function ii(n){const e={};if(n.isDefault())return e;let t;if(n.index_===k?t="$priority":n.index_===yh?t="$value":n.index_===We?t="$key":(_(n.index_ instanceof mh,"Unrecognized index type!"),t=n.index_.toString()),e.orderBy=x(t),n.startSet_){const s=n.startAfterSet_?"startAfter":"startAt";e[s]=x(n.indexStartValue_),n.startNameSet_&&(e[s]+=","+x(n.indexStartName_))}if(n.endSet_){const s=n.endBeforeSet_?"endBefore":"endAt";e[s]=x(n.indexEndValue_),n.endNameSet_&&(e[s]+=","+x(n.indexEndName_))}return n.limitSet_&&(n.isViewFromLeft()?e.limitToFirst=n.limit_:e.limitToLast=n.limit_),e}function ri(n){const e={};if(n.startSet_&&(e.sp=n.indexStartValue_,n.startNameSet_&&(e.sn=n.indexStartName_),e.sin=!n.startAfterSet_),n.endSet_&&(e.ep=n.indexEndValue_,n.endNameSet_&&(e.en=n.indexEndName_),e.ein=!n.endBeforeSet_),n.limitSet_){e.l=n.limit_;let t=n.viewFrom_;t===""&&(n.isViewFromLeft()?t="l":t="r"),e.vf=t}return n.index_!==k&&(e.i=n.index_.toString()),e}class Ut extends _r{reportStats(e){throw new Error("Method not implemented.")}static getListenId_(e,t){return t!==void 0?"tag$"+t:(_(e._queryParams.isDefault(),"should have a tag if it's not a default query."),e._path.toString())}constructor(e,t,s,i){super(),this.repoInfo_=e,this.onDataUpdate_=t,this.authTokenProvider_=s,this.appCheckTokenProvider_=i,this.log_=bt("p:rest:"),this.listens_={}}listen(e,t,s,i){const r=e._path.toString();this.log_("Listen called for "+r+" "+e._queryIdentifier);const o=Ut.getListenId_(e,s),a={};this.listens_[o]=a;const l=ii(e._queryParams);this.restRequest_(r+".json",l,(c,f)=>{let u=f;if(c===404&&(u=null,c=null),c===null&&this.onDataUpdate_(r,u,!1,s),Ge(this.listens_,o)===a){let h;c?c===401?h="permission_denied":h="rest_error:"+c:h="ok",i(h,null)}})}unlisten(e,t){const s=Ut.getListenId_(e,t);delete this.listens_[s]}get(e){const t=ii(e._queryParams),s=e._path.toString(),i=new te;return this.restRequest_(s+".json",t,(r,o)=>{let a=o;r===404&&(a=null,r=null),r===null?(this.onDataUpdate_(s,a,!1,null),i.resolve(a)):i.reject(new Error(a))}),i.promise}refreshAuthToken(e){}restRequest_(e,t={},s){return t.format="export",Promise.all([this.authTokenProvider_.getToken(!1),this.appCheckTokenProvider_.getToken(!1)]).then(([i,r])=>{i&&i.accessToken&&(t.auth=i.accessToken),r&&r.token&&(t.ac=r.token);const o=(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host+e+"?ns="+this.repoInfo_.namespace+Ka(t);this.log_("Sending REST request for "+o);const a=new XMLHttpRequest;a.onreadystatechange=()=>{if(s&&a.readyState===4){this.log_("REST Response for "+o+" received. status:",a.status,"response:",a.responseText);let l=null;if(a.status>=200&&a.status<300){try{l=ht(a.responseText)}catch{H("Failed to parse JSON response for "+o+": "+a.responseText)}s(null,l)}else a.status!==401&&a.status!==404&&H("Got unsuccessful REST response for "+o+" Status: "+a.status),s(a.status);s=null}},a.open("GET",o,!0),a.send()})}}class Sh{constructor(){this.rootNode_=y.EMPTY_NODE}getNode(e){return this.rootNode_.getChild(e)}updateSnapshot(e,t){this.rootNode_=this.rootNode_.updateChild(e,t)}}function Ht(){return{value:null,children:new Map}}function qe(n,e,t){if(v(e))n.value=t,n.children.clear();else if(n.value!==null)n.value=n.value.updateChild(e,t);else{const s=C(e);n.children.has(s)||n.children.set(s,Ht());const i=n.children.get(s);e=R(e),qe(i,e,t)}}function Mn(n,e){if(v(e))return n.value=null,n.children.clear(),!0;if(n.value!==null){if(n.value.isLeafNode())return!1;{const t=n.value;return n.value=null,t.forEachChild(k,(s,i)=>{qe(n,new N(s),i)}),Mn(n,e)}}else if(n.children.size>0){const t=C(e);return e=R(e),n.children.has(t)&&Mn(n.children.get(t),e)&&n.children.delete(t),n.children.size===0}else return!0}function xn(n,e,t){n.value!==null?t(e,n.value):Ih(n,(s,i)=>{const r=new N(e.toString()+"/"+s);xn(i,r,t)})}function Ih(n,e){n.children.forEach((t,s)=>{e(s,t)})}class bh{constructor(e){this.collection_=e,this.last_=null}get(){const e=this.collection_.get(),t={...e};return this.last_&&G(this.last_,(s,i)=>{t[s]=t[s]-i}),this.last_=e,t}}const oi=10*1e3,wh=30*1e3,Th=300*1e3;class Nh{constructor(e,t){this.server_=t,this.statsToReport_={},this.statsListener_=new bh(e);const s=oi+(wh-oi)*Math.random();ot(this.reportStats_.bind(this),Math.floor(s))}reportStats_(){const e=this.statsListener_.get(),t={};let s=!1;G(e,(i,r)=>{r>0&&se(this.statsToReport_,i)&&(t[i]=r,s=!0)}),s&&this.server_.reportStats(t),ot(this.reportStats_.bind(this),Math.floor(Math.random()*2*Th))}}var Z;(function(n){n[n.OVERWRITE=0]="OVERWRITE",n[n.MERGE=1]="MERGE",n[n.ACK_USER_WRITE=2]="ACK_USER_WRITE",n[n.LISTEN_COMPLETE=3]="LISTEN_COMPLETE"})(Z||(Z={}));function os(){return{fromUser:!0,fromServer:!1,queryId:null,tagged:!1}}function as(){return{fromUser:!1,fromServer:!0,queryId:null,tagged:!1}}function ls(n){return{fromUser:!1,fromServer:!0,queryId:n,tagged:!0}}class $t{constructor(e,t,s){this.path=e,this.affectedTree=t,this.revert=s,this.type=Z.ACK_USER_WRITE,this.source=os()}operationForChild(e){if(v(this.path)){if(this.affectedTree.value!=null)return _(this.affectedTree.children.isEmpty(),"affectedTree should not have overlapping affected paths."),this;{const t=this.affectedTree.subtree(new N(e));return new $t(T(),t,this.revert)}}else return _(C(this.path)===e,"operationForChild called for unrelated child."),new $t(R(this.path),this.affectedTree,this.revert)}}class yt{constructor(e,t){this.source=e,this.path=t,this.type=Z.LISTEN_COMPLETE}operationForChild(e){return v(this.path)?new yt(this.source,T()):new yt(this.source,R(this.path))}}class Re{constructor(e,t,s){this.source=e,this.path=t,this.snap=s,this.type=Z.OVERWRITE}operationForChild(e){return v(this.path)?new Re(this.source,T(),this.snap.getImmediateChild(e)):new Re(this.source,R(this.path),this.snap)}}class Ve{constructor(e,t,s){this.source=e,this.path=t,this.children=s,this.type=Z.MERGE}operationForChild(e){if(v(this.path)){const t=this.children.subtree(new N(e));return t.isEmpty()?null:t.value?new Re(this.source,T(),t.value):new Ve(this.source,T(),t)}else return _(C(this.path)===e,"Can't get a merge for a child not on the path of the operation"),new Ve(this.source,R(this.path),this.children)}toString(){return"Operation("+this.path+": "+this.source.toString()+" merge: "+this.children.toString()+")"}}class Ee{constructor(e,t,s){this.node_=e,this.fullyInitialized_=t,this.filtered_=s}isFullyInitialized(){return this.fullyInitialized_}isFiltered(){return this.filtered_}isCompleteForPath(e){if(v(e))return this.isFullyInitialized()&&!this.filtered_;const t=C(e);return this.isCompleteForChild(t)}isCompleteForChild(e){return this.isFullyInitialized()&&!this.filtered_||this.node_.hasChild(e)}getNode(){return this.node_}}class Rh{constructor(e){this.query_=e,this.index_=this.query_._queryParams.getIndex()}}function Ah(n,e,t,s){const i=[],r=[];return e.forEach(o=>{o.type==="child_changed"&&n.index_.indexedValueChanged(o.oldSnap,o.snapshotNode)&&r.push(Eh(o.childName,o.snapshotNode))}),tt(n,i,"child_removed",e,s,t),tt(n,i,"child_added",e,s,t),tt(n,i,"child_moved",r,s,t),tt(n,i,"child_changed",e,s,t),tt(n,i,"value",e,s,t),i}function tt(n,e,t,s,i,r){const o=s.filter(a=>a.type===t);o.sort((a,l)=>Dh(n,a,l)),o.forEach(a=>{const l=Oh(n,a,r);i.forEach(c=>{c.respondsTo(a.type)&&e.push(c.createEvent(l,n.query_))})})}function Oh(n,e,t){return e.type==="value"||e.type==="child_removed"||(e.prevName=t.getPredecessorChildName(e.childName,e.snapshotNode,n.index_)),e}function Dh(n,e,t){if(e.childName==null||t.childName==null)throw je("Should only compare child_ events.");const s=new S(e.childName,e.snapshotNode),i=new S(t.childName,t.snapshotNode);return n.index_.compare(s,i)}function tn(n,e){return{eventCache:n,serverCache:e}}function at(n,e,t,s){return tn(new Ee(e,t,s),n.serverCache)}function wr(n,e,t,s){return tn(n.eventCache,new Ee(e,t,s))}function Vt(n){return n.eventCache.isFullyInitialized()?n.eventCache.getNode():null}function Ae(n){return n.serverCache.isFullyInitialized()?n.serverCache.getNode():null}let vn;const kh=()=>(vn||(vn=new V(mc)),vn);class A{static fromObject(e){let t=new A(null);return G(e,(s,i)=>{t=t.set(new N(s),i)}),t}constructor(e,t=kh()){this.value=e,this.children=t}isEmpty(){return this.value===null&&this.children.isEmpty()}findRootMostMatchingPathAndValue(e,t){if(this.value!=null&&t(this.value))return{path:T(),value:this.value};if(v(e))return null;{const s=C(e),i=this.children.get(s);if(i!==null){const r=i.findRootMostMatchingPathAndValue(R(e),t);return r!=null?{path:D(new N(s),r.path),value:r.value}:null}else return null}}findRootMostValueAndPath(e){return this.findRootMostMatchingPathAndValue(e,()=>!0)}subtree(e){if(v(e))return this;{const t=C(e),s=this.children.get(t);return s!==null?s.subtree(R(e)):new A(null)}}set(e,t){if(v(e))return new A(t,this.children);{const s=C(e),r=(this.children.get(s)||new A(null)).set(R(e),t),o=this.children.insert(s,r);return new A(this.value,o)}}remove(e){if(v(e))return this.children.isEmpty()?new A(null):new A(null,this.children);{const t=C(e),s=this.children.get(t);if(s){const i=s.remove(R(e));let r;return i.isEmpty()?r=this.children.remove(t):r=this.children.insert(t,i),this.value===null&&r.isEmpty()?new A(null):new A(this.value,r)}else return this}}get(e){if(v(e))return this.value;{const t=C(e),s=this.children.get(t);return s?s.get(R(e)):null}}setTree(e,t){if(v(e))return t;{const s=C(e),r=(this.children.get(s)||new A(null)).setTree(R(e),t);let o;return r.isEmpty()?o=this.children.remove(s):o=this.children.insert(s,r),new A(this.value,o)}}fold(e){return this.fold_(T(),e)}fold_(e,t){const s={};return this.children.inorderTraversal((i,r)=>{s[i]=r.fold_(D(e,i),t)}),t(e,this.value,s)}findOnPath(e,t){return this.findOnPath_(e,T(),t)}findOnPath_(e,t,s){const i=this.value?s(t,this.value):!1;if(i)return i;if(v(e))return null;{const r=C(e),o=this.children.get(r);return o?o.findOnPath_(R(e),D(t,r),s):null}}foreachOnPath(e,t){return this.foreachOnPath_(e,T(),t)}foreachOnPath_(e,t,s){if(v(e))return this;{this.value&&s(t,this.value);const i=C(e),r=this.children.get(i);return r?r.foreachOnPath_(R(e),D(t,i),s):new A(null)}}foreach(e){this.foreach_(T(),e)}foreach_(e,t){this.children.inorderTraversal((s,i)=>{i.foreach_(D(e,s),t)}),this.value&&t(e,this.value)}foreachChild(e){this.children.inorderTraversal((t,s)=>{s.value&&e(t,s.value)})}}class ee{constructor(e){this.writeTree_=e}static empty(){return new ee(new A(null))}}function lt(n,e,t){if(v(e))return new ee(new A(t));{const s=n.writeTree_.findRootMostValueAndPath(e);if(s!=null){const i=s.path;let r=s.value;const o=U(i,e);return r=r.updateChild(o,t),new ee(n.writeTree_.set(i,r))}else{const i=new A(t),r=n.writeTree_.setTree(e,i);return new ee(r)}}}function Bn(n,e,t){let s=n;return G(t,(i,r)=>{s=lt(s,D(e,i),r)}),s}function ai(n,e){if(v(e))return ee.empty();{const t=n.writeTree_.setTree(e,new A(null));return new ee(t)}}function Fn(n,e){return ke(n,e)!=null}function ke(n,e){const t=n.writeTree_.findRootMostValueAndPath(e);return t!=null?n.writeTree_.get(t.path).getChild(U(t.path,e)):null}function li(n){const e=[],t=n.writeTree_.value;return t!=null?t.isLeafNode()||t.forEachChild(k,(s,i)=>{e.push(new S(s,i))}):n.writeTree_.children.inorderTraversal((s,i)=>{i.value!=null&&e.push(new S(s,i.value))}),e}function me(n,e){if(v(e))return n;{const t=ke(n,e);return t!=null?new ee(new A(t)):new ee(n.writeTree_.subtree(e))}}function Wn(n){return n.writeTree_.isEmpty()}function Ke(n,e){return Tr(T(),n.writeTree_,e)}function Tr(n,e,t){if(e.value!=null)return t.updateChild(n,e.value);{let s=null;return e.children.inorderTraversal((i,r)=>{i===".priority"?(_(r.value!==null,"Priority writes must always be leaf nodes"),s=r.value):t=Tr(D(n,i),r,t)}),!t.getChild(n).isEmpty()&&s!==null&&(t=t.updateChild(D(n,".priority"),s)),t}}function nn(n,e){return Or(e,n)}function Ph(n,e,t,s,i){_(s>n.lastWriteId,"Stacking an older write on top of newer ones"),i===void 0&&(i=!0),n.allWrites.push({path:e,snap:t,writeId:s,visible:i}),i&&(n.visibleWrites=lt(n.visibleWrites,e,t)),n.lastWriteId=s}function Lh(n,e,t,s){_(s>n.lastWriteId,"Stacking an older merge on top of newer ones"),n.allWrites.push({path:e,children:t,writeId:s,visible:!0}),n.visibleWrites=Bn(n.visibleWrites,e,t),n.lastWriteId=s}function Mh(n,e){for(let t=0;t<n.allWrites.length;t++){const s=n.allWrites[t];if(s.writeId===e)return s}return null}function xh(n,e){const t=n.allWrites.findIndex(a=>a.writeId===e);_(t>=0,"removeWrite called with nonexistent writeId.");const s=n.allWrites[t];n.allWrites.splice(t,1);let i=s.visible,r=!1,o=n.allWrites.length-1;for(;i&&o>=0;){const a=n.allWrites[o];a.visible&&(o>=t&&Bh(a,s.path)?i=!1:Q(s.path,a.path)&&(r=!0)),o--}if(i){if(r)return Fh(n),!0;if(s.snap)n.visibleWrites=ai(n.visibleWrites,s.path);else{const a=s.children;G(a,l=>{n.visibleWrites=ai(n.visibleWrites,D(s.path,l))})}return!0}else return!1}function Bh(n,e){if(n.snap)return Q(n.path,e);for(const t in n.children)if(n.children.hasOwnProperty(t)&&Q(D(n.path,t),e))return!0;return!1}function Fh(n){n.visibleWrites=Nr(n.allWrites,Wh,T()),n.allWrites.length>0?n.lastWriteId=n.allWrites[n.allWrites.length-1].writeId:n.lastWriteId=-1}function Wh(n){return n.visible}function Nr(n,e,t){let s=ee.empty();for(let i=0;i<n.length;++i){const r=n[i];if(e(r)){const o=r.path;let a;if(r.snap)Q(t,o)?(a=U(t,o),s=lt(s,a,r.snap)):Q(o,t)&&(a=U(o,t),s=lt(s,T(),r.snap.getChild(a)));else if(r.children){if(Q(t,o))a=U(t,o),s=Bn(s,a,r.children);else if(Q(o,t))if(a=U(o,t),v(a))s=Bn(s,T(),r.children);else{const l=Ge(r.children,C(a));if(l){const c=l.getChild(R(a));s=lt(s,T(),c)}}}else throw je("WriteRecord should have .snap or .children")}}return s}function Rr(n,e,t,s,i){if(!s&&!i){const r=ke(n.visibleWrites,e);if(r!=null)return r;{const o=me(n.visibleWrites,e);if(Wn(o))return t;if(t==null&&!Fn(o,T()))return null;{const a=t||y.EMPTY_NODE;return Ke(o,a)}}}else{const r=me(n.visibleWrites,e);if(!i&&Wn(r))return t;if(!i&&t==null&&!Fn(r,T()))return null;{const o=function(c){return(c.visible||i)&&(!s||!~s.indexOf(c.writeId))&&(Q(c.path,e)||Q(e,c.path))},a=Nr(n.allWrites,o,e),l=t||y.EMPTY_NODE;return Ke(a,l)}}}function Gh(n,e,t){let s=y.EMPTY_NODE;const i=ke(n.visibleWrites,e);if(i)return i.isLeafNode()||i.forEachChild(k,(r,o)=>{s=s.updateImmediateChild(r,o)}),s;if(t){const r=me(n.visibleWrites,e);return t.forEachChild(k,(o,a)=>{const l=Ke(me(r,new N(o)),a);s=s.updateImmediateChild(o,l)}),li(r).forEach(o=>{s=s.updateImmediateChild(o.name,o.node)}),s}else{const r=me(n.visibleWrites,e);return li(r).forEach(o=>{s=s.updateImmediateChild(o.name,o.node)}),s}}function Uh(n,e,t,s,i){_(s||i,"Either existingEventSnap or existingServerSnap must exist");const r=D(e,t);if(Fn(n.visibleWrites,r))return null;{const o=me(n.visibleWrites,r);return Wn(o)?i.getChild(t):Ke(o,i.getChild(t))}}function Hh(n,e,t,s){const i=D(e,t),r=ke(n.visibleWrites,i);if(r!=null)return r;if(s.isCompleteForChild(t)){const o=me(n.visibleWrites,i);return Ke(o,s.getNode().getImmediateChild(t))}else return null}function $h(n,e){return ke(n.visibleWrites,e)}function Vh(n,e,t,s,i,r,o){let a;const l=me(n.visibleWrites,e),c=ke(l,T());if(c!=null)a=c;else if(t!=null)a=Ke(l,t);else return[];if(a=a.withIndex(o),!a.isEmpty()&&!a.isLeafNode()){const f=[],u=o.getCompare(),h=r?a.getReverseIteratorFrom(s,o):a.getIteratorFrom(s,o);let p=h.getNext();for(;p&&f.length<i;)u(p,s)!==0&&f.push(p),p=h.getNext();return f}else return[]}function Kh(){return{visibleWrites:ee.empty(),allWrites:[],lastWriteId:-1}}function Kt(n,e,t,s){return Rr(n.writeTree,n.treePath,e,t,s)}function cs(n,e){return Gh(n.writeTree,n.treePath,e)}function ci(n,e,t,s){return Uh(n.writeTree,n.treePath,e,t,s)}function zt(n,e){return $h(n.writeTree,D(n.treePath,e))}function zh(n,e,t,s,i,r){return Vh(n.writeTree,n.treePath,e,t,s,i,r)}function hs(n,e,t){return Hh(n.writeTree,n.treePath,e,t)}function Ar(n,e){return Or(D(n.treePath,e),n.writeTree)}function Or(n,e){return{treePath:n,writeTree:e}}class jh{constructor(){this.changeMap=new Map}trackChildChange(e){const t=e.type,s=e.childName;_(t==="child_added"||t==="child_changed"||t==="child_removed","Only child changes supported for tracking"),_(s!==".priority","Only non-priority child changes can be tracked.");const i=this.changeMap.get(s);if(i){const r=i.type;if(t==="child_added"&&r==="child_removed")this.changeMap.set(s,mt(s,e.snapshotNode,i.snapshotNode));else if(t==="child_removed"&&r==="child_added")this.changeMap.delete(s);else if(t==="child_removed"&&r==="child_changed")this.changeMap.set(s,_t(s,i.oldSnap));else if(t==="child_changed"&&r==="child_added")this.changeMap.set(s,$e(s,e.snapshotNode));else if(t==="child_changed"&&r==="child_changed")this.changeMap.set(s,mt(s,e.snapshotNode,i.oldSnap));else throw je("Illegal combination of changes: "+e+" occurred after "+i)}else this.changeMap.set(s,e)}getChanges(){return Array.from(this.changeMap.values())}}class Yh{getCompleteChild(e){return null}getChildAfterChild(e,t,s){return null}}const Dr=new Yh;class us{constructor(e,t,s=null){this.writes_=e,this.viewCache_=t,this.optCompleteServerCache_=s}getCompleteChild(e){const t=this.viewCache_.eventCache;if(t.isCompleteForChild(e))return t.getNode().getImmediateChild(e);{const s=this.optCompleteServerCache_!=null?new Ee(this.optCompleteServerCache_,!0,!1):this.viewCache_.serverCache;return hs(this.writes_,e,s)}}getChildAfterChild(e,t,s){const i=this.optCompleteServerCache_!=null?this.optCompleteServerCache_:Ae(this.viewCache_),r=zh(this.writes_,i,t,1,s,e);return r.length===0?null:r[0]}}function qh(n){return{filter:n}}function Qh(n,e){_(e.eventCache.getNode().isIndexed(n.filter.getIndex()),"Event snap not indexed"),_(e.serverCache.getNode().isIndexed(n.filter.getIndex()),"Server snap not indexed")}function Xh(n,e,t,s,i){const r=new jh;let o,a;if(t.type===Z.OVERWRITE){const c=t;c.source.fromUser?o=Gn(n,e,c.path,c.snap,s,i,r):(_(c.source.fromServer,"Unknown source."),a=c.source.tagged||e.serverCache.isFiltered()&&!v(c.path),o=jt(n,e,c.path,c.snap,s,i,a,r))}else if(t.type===Z.MERGE){const c=t;c.source.fromUser?o=Zh(n,e,c.path,c.children,s,i,r):(_(c.source.fromServer,"Unknown source."),a=c.source.tagged||e.serverCache.isFiltered(),o=Un(n,e,c.path,c.children,s,i,a,r))}else if(t.type===Z.ACK_USER_WRITE){const c=t;c.revert?o=nu(n,e,c.path,s,i,r):o=eu(n,e,c.path,c.affectedTree,s,i,r)}else if(t.type===Z.LISTEN_COMPLETE)o=tu(n,e,t.path,s,r);else throw je("Unknown operation type: "+t.type);const l=r.getChanges();return Jh(e,o,l),{viewCache:o,changes:l}}function Jh(n,e,t){const s=e.eventCache;if(s.isFullyInitialized()){const i=s.getNode().isLeafNode()||s.getNode().isEmpty(),r=Vt(n);(t.length>0||!n.eventCache.isFullyInitialized()||i&&!s.getNode().equals(r)||!s.getNode().getPriority().equals(r.getPriority()))&&t.push(br(Vt(e)))}}function kr(n,e,t,s,i,r){const o=e.eventCache;if(zt(s,t)!=null)return e;{let a,l;if(v(t))if(_(e.serverCache.isFullyInitialized(),"If change path is empty, we must have complete server data"),e.serverCache.isFiltered()){const c=Ae(e),f=c instanceof y?c:y.EMPTY_NODE,u=cs(s,f);a=n.filter.updateFullNode(e.eventCache.getNode(),u,r)}else{const c=Kt(s,Ae(e));a=n.filter.updateFullNode(e.eventCache.getNode(),c,r)}else{const c=C(t);if(c===".priority"){_(ye(t)===1,"Can't have a priority with additional path components");const f=o.getNode();l=e.serverCache.getNode();const u=ci(s,t,f,l);u!=null?a=n.filter.updatePriority(f,u):a=o.getNode()}else{const f=R(t);let u;if(o.isCompleteForChild(c)){l=e.serverCache.getNode();const h=ci(s,t,o.getNode(),l);h!=null?u=o.getNode().getImmediateChild(c).updateChild(f,h):u=o.getNode().getImmediateChild(c)}else u=hs(s,c,e.serverCache);u!=null?a=n.filter.updateChild(o.getNode(),c,u,f,i,r):a=o.getNode()}}return at(e,a,o.isFullyInitialized()||v(t),n.filter.filtersNodes())}}function jt(n,e,t,s,i,r,o,a){const l=e.serverCache;let c;const f=o?n.filter:n.filter.getIndexedFilter();if(v(t))c=f.updateFullNode(l.getNode(),s,null);else if(f.filtersNodes()&&!l.isFiltered()){const p=l.getNode().updateChild(t,s);c=f.updateFullNode(l.getNode(),p,null)}else{const p=C(t);if(!l.isCompleteForPath(t)&&ye(t)>1)return e;const m=R(t),w=l.getNode().getImmediateChild(p).updateChild(m,s);p===".priority"?c=f.updatePriority(l.getNode(),w):c=f.updateChild(l.getNode(),p,w,m,Dr,null)}const u=wr(e,c,l.isFullyInitialized()||v(t),f.filtersNodes()),h=new us(i,u,r);return kr(n,u,t,i,h,a)}function Gn(n,e,t,s,i,r,o){const a=e.eventCache;let l,c;const f=new us(i,e,r);if(v(t))c=n.filter.updateFullNode(e.eventCache.getNode(),s,o),l=at(e,c,!0,n.filter.filtersNodes());else{const u=C(t);if(u===".priority")c=n.filter.updatePriority(e.eventCache.getNode(),s),l=at(e,c,a.isFullyInitialized(),a.isFiltered());else{const h=R(t),p=a.getNode().getImmediateChild(u);let m;if(v(h))m=s;else{const g=f.getCompleteChild(u);g!=null?es(h)===".priority"&&g.getChild(gr(h)).isEmpty()?m=g:m=g.updateChild(h,s):m=y.EMPTY_NODE}if(p.equals(m))l=e;else{const g=n.filter.updateChild(a.getNode(),u,m,h,f,o);l=at(e,g,a.isFullyInitialized(),n.filter.filtersNodes())}}}return l}function hi(n,e){return n.eventCache.isCompleteForChild(e)}function Zh(n,e,t,s,i,r,o){let a=e;return s.foreach((l,c)=>{const f=D(t,l);hi(e,C(f))&&(a=Gn(n,a,f,c,i,r,o))}),s.foreach((l,c)=>{const f=D(t,l);hi(e,C(f))||(a=Gn(n,a,f,c,i,r,o))}),a}function ui(n,e,t){return t.foreach((s,i)=>{e=e.updateChild(s,i)}),e}function Un(n,e,t,s,i,r,o,a){if(e.serverCache.getNode().isEmpty()&&!e.serverCache.isFullyInitialized())return e;let l=e,c;v(t)?c=s:c=new A(null).setTree(t,s);const f=e.serverCache.getNode();return c.children.inorderTraversal((u,h)=>{if(f.hasChild(u)){const p=e.serverCache.getNode().getImmediateChild(u),m=ui(n,p,h);l=jt(n,l,new N(u),m,i,r,o,a)}}),c.children.inorderTraversal((u,h)=>{const p=!e.serverCache.isCompleteForChild(u)&&h.value===null;if(!f.hasChild(u)&&!p){const m=e.serverCache.getNode().getImmediateChild(u),g=ui(n,m,h);l=jt(n,l,new N(u),g,i,r,o,a)}}),l}function eu(n,e,t,s,i,r,o){if(zt(i,t)!=null)return e;const a=e.serverCache.isFiltered(),l=e.serverCache;if(s.value!=null){if(v(t)&&l.isFullyInitialized()||l.isCompleteForPath(t))return jt(n,e,t,l.getNode().getChild(t),i,r,a,o);if(v(t)){let c=new A(null);return l.getNode().forEachChild(We,(f,u)=>{c=c.set(new N(f),u)}),Un(n,e,t,c,i,r,a,o)}else return e}else{let c=new A(null);return s.foreach((f,u)=>{const h=D(t,f);l.isCompleteForPath(h)&&(c=c.set(f,l.getNode().getChild(h)))}),Un(n,e,t,c,i,r,a,o)}}function tu(n,e,t,s,i){const r=e.serverCache,o=wr(e,r.getNode(),r.isFullyInitialized()||v(t),r.isFiltered());return kr(n,o,t,s,Dr,i)}function nu(n,e,t,s,i,r){let o;if(zt(s,t)!=null)return e;{const a=new us(s,e,i),l=e.eventCache.getNode();let c;if(v(t)||C(t)===".priority"){let f;if(e.serverCache.isFullyInitialized())f=Kt(s,Ae(e));else{const u=e.serverCache.getNode();_(u instanceof y,"serverChildren would be complete if leaf node"),f=cs(s,u)}f=f,c=n.filter.updateFullNode(l,f,r)}else{const f=C(t);let u=hs(s,f,e.serverCache);u==null&&e.serverCache.isCompleteForChild(f)&&(u=l.getImmediateChild(f)),u!=null?c=n.filter.updateChild(l,f,u,R(t),a,r):e.eventCache.getNode().hasChild(f)?c=n.filter.updateChild(l,f,y.EMPTY_NODE,R(t),a,r):c=l,c.isEmpty()&&e.serverCache.isFullyInitialized()&&(o=Kt(s,Ae(e)),o.isLeafNode()&&(c=n.filter.updateFullNode(c,o,r)))}return o=e.serverCache.isFullyInitialized()||zt(s,T())!=null,at(e,c,o,n.filter.filtersNodes())}}class su{constructor(e,t){this.query_=e,this.eventRegistrations_=[];const s=this.query_._queryParams,i=new is(s.getIndex()),r=vh(s);this.processor_=qh(r);const o=t.serverCache,a=t.eventCache,l=i.updateFullNode(y.EMPTY_NODE,o.getNode(),null),c=r.updateFullNode(y.EMPTY_NODE,a.getNode(),null),f=new Ee(l,o.isFullyInitialized(),i.filtersNodes()),u=new Ee(c,a.isFullyInitialized(),r.filtersNodes());this.viewCache_=tn(u,f),this.eventGenerator_=new Rh(this.query_)}get query(){return this.query_}}function iu(n){return n.viewCache_.serverCache.getNode()}function ru(n){return Vt(n.viewCache_)}function ou(n,e){const t=Ae(n.viewCache_);return t&&(n.query._queryParams.loadsAllData()||!v(e)&&!t.getImmediateChild(C(e)).isEmpty())?t.getChild(e):null}function di(n){return n.eventRegistrations_.length===0}function au(n,e){n.eventRegistrations_.push(e)}function fi(n,e,t){const s=[];if(t){_(e==null,"A cancel should cancel all event registrations.");const i=n.query._path;n.eventRegistrations_.forEach(r=>{const o=r.createCancelEvent(t,i);o&&s.push(o)})}if(e){let i=[];for(let r=0;r<n.eventRegistrations_.length;++r){const o=n.eventRegistrations_[r];if(!o.matches(e))i.push(o);else if(e.hasAnyCallback()){i=i.concat(n.eventRegistrations_.slice(r+1));break}}n.eventRegistrations_=i}else n.eventRegistrations_=[];return s}function pi(n,e,t,s){e.type===Z.MERGE&&e.source.queryId!==null&&(_(Ae(n.viewCache_),"We should always have a full cache before handling merges"),_(Vt(n.viewCache_),"Missing event cache, even though we have a server cache"));const i=n.viewCache_,r=Xh(n.processor_,i,e,t,s);return Qh(n.processor_,r.viewCache),_(r.viewCache.serverCache.isFullyInitialized()||!i.serverCache.isFullyInitialized(),"Once a server snap is complete, it should never go back"),n.viewCache_=r.viewCache,Pr(n,r.changes,r.viewCache.eventCache.getNode(),null)}function lu(n,e){const t=n.viewCache_.eventCache,s=[];return t.getNode().isLeafNode()||t.getNode().forEachChild(k,(r,o)=>{s.push($e(r,o))}),t.isFullyInitialized()&&s.push(br(t.getNode())),Pr(n,s,t.getNode(),e)}function Pr(n,e,t,s){const i=s?[s]:n.eventRegistrations_;return Ah(n.eventGenerator_,e,t,i)}let Yt;class Lr{constructor(){this.views=new Map}}function cu(n){_(!Yt,"__referenceConstructor has already been defined"),Yt=n}function hu(){return _(Yt,"Reference.ts has not been loaded"),Yt}function uu(n){return n.views.size===0}function ds(n,e,t,s){const i=e.source.queryId;if(i!==null){const r=n.views.get(i);return _(r!=null,"SyncTree gave us an op for an invalid query."),pi(r,e,t,s)}else{let r=[];for(const o of n.views.values())r=r.concat(pi(o,e,t,s));return r}}function Mr(n,e,t,s,i){const r=e._queryIdentifier,o=n.views.get(r);if(!o){let a=Kt(t,i?s:null),l=!1;a?l=!0:s instanceof y?(a=cs(t,s),l=!1):(a=y.EMPTY_NODE,l=!1);const c=tn(new Ee(a,l,!1),new Ee(s,i,!1));return new su(e,c)}return o}function du(n,e,t,s,i,r){const o=Mr(n,e,s,i,r);return n.views.has(e._queryIdentifier)||n.views.set(e._queryIdentifier,o),au(o,t),lu(o,t)}function fu(n,e,t,s){const i=e._queryIdentifier,r=[];let o=[];const a=Ce(n);if(i==="default")for(const[l,c]of n.views.entries())o=o.concat(fi(c,t,s)),di(c)&&(n.views.delete(l),c.query._queryParams.loadsAllData()||r.push(c.query));else{const l=n.views.get(i);l&&(o=o.concat(fi(l,t,s)),di(l)&&(n.views.delete(i),l.query._queryParams.loadsAllData()||r.push(l.query)))}return a&&!Ce(n)&&r.push(new(hu())(e._repo,e._path)),{removed:r,events:o}}function xr(n){const e=[];for(const t of n.views.values())t.query._queryParams.loadsAllData()||e.push(t);return e}function ge(n,e){let t=null;for(const s of n.views.values())t=t||ou(s,e);return t}function Br(n,e){if(e._queryParams.loadsAllData())return sn(n);{const s=e._queryIdentifier;return n.views.get(s)}}function Fr(n,e){return Br(n,e)!=null}function Ce(n){return sn(n)!=null}function sn(n){for(const e of n.views.values())if(e.query._queryParams.loadsAllData())return e;return null}let qt;function pu(n){_(!qt,"__referenceConstructor has already been defined"),qt=n}function _u(){return _(qt,"Reference.ts has not been loaded"),qt}let mu=1;class _i{constructor(e){this.listenProvider_=e,this.syncPointTree_=new A(null),this.pendingWriteTree_=Kh(),this.tagToQueryMap=new Map,this.queryToTagMap=new Map}}function Wr(n,e,t,s,i){return Ph(n.pendingWriteTree_,e,t,s,i),i?Qe(n,new Re(os(),e,t)):[]}function gu(n,e,t,s){Lh(n.pendingWriteTree_,e,t,s);const i=A.fromObject(t);return Qe(n,new Ve(os(),e,i))}function fe(n,e,t=!1){const s=Mh(n.pendingWriteTree_,e);if(xh(n.pendingWriteTree_,e)){let r=new A(null);return s.snap!=null?r=r.set(T(),!0):G(s.children,o=>{r=r.set(new N(o),!0)}),Qe(n,new $t(s.path,r,t))}else return[]}function Tt(n,e,t){return Qe(n,new Re(as(),e,t))}function yu(n,e,t){const s=A.fromObject(t);return Qe(n,new Ve(as(),e,s))}function Eu(n,e){return Qe(n,new yt(as(),e))}function Cu(n,e,t){const s=ps(n,t);if(s){const i=_s(s),r=i.path,o=i.queryId,a=U(r,e),l=new yt(ls(o),a);return ms(n,r,l)}else return[]}function Qt(n,e,t,s,i=!1){const r=e._path,o=n.syncPointTree_.get(r);let a=[];if(o&&(e._queryIdentifier==="default"||Fr(o,e))){const l=fu(o,e,t,s);uu(o)&&(n.syncPointTree_=n.syncPointTree_.remove(r));const c=l.removed;if(a=l.events,!i){const f=c.findIndex(h=>h._queryParams.loadsAllData())!==-1,u=n.syncPointTree_.findOnPath(r,(h,p)=>Ce(p));if(f&&!u){const h=n.syncPointTree_.subtree(r);if(!h.isEmpty()){const p=Iu(h);for(let m=0;m<p.length;++m){const g=p[m],w=g.query,P=$r(n,g);n.listenProvider_.startListening(ct(w),Et(n,w),P.hashFn,P.onComplete)}}}!u&&c.length>0&&!s&&(f?n.listenProvider_.stopListening(ct(e),null):c.forEach(h=>{const p=n.queryToTagMap.get(rn(h));n.listenProvider_.stopListening(ct(h),p)}))}bu(n,c)}return a}function Gr(n,e,t,s){const i=ps(n,s);if(i!=null){const r=_s(i),o=r.path,a=r.queryId,l=U(o,e),c=new Re(ls(a),l,t);return ms(n,o,c)}else return[]}function vu(n,e,t,s){const i=ps(n,s);if(i){const r=_s(i),o=r.path,a=r.queryId,l=U(o,e),c=A.fromObject(t),f=new Ve(ls(a),l,c);return ms(n,o,f)}else return[]}function Hn(n,e,t,s=!1){const i=e._path;let r=null,o=!1;n.syncPointTree_.foreachOnPath(i,(h,p)=>{const m=U(h,i);r=r||ge(p,m),o=o||Ce(p)});let a=n.syncPointTree_.get(i);a?(o=o||Ce(a),r=r||ge(a,T())):(a=new Lr,n.syncPointTree_=n.syncPointTree_.set(i,a));let l;r!=null?l=!0:(l=!1,r=y.EMPTY_NODE,n.syncPointTree_.subtree(i).foreachChild((p,m)=>{const g=ge(m,T());g&&(r=r.updateImmediateChild(p,g))}));const c=Fr(a,e);if(!c&&!e._queryParams.loadsAllData()){const h=rn(e);_(!n.queryToTagMap.has(h),"View does not exist, but we have a tag");const p=wu();n.queryToTagMap.set(h,p),n.tagToQueryMap.set(p,h)}const f=nn(n.pendingWriteTree_,i);let u=du(a,e,t,f,r,l);if(!c&&!o&&!s){const h=Br(a,e);u=u.concat(Tu(n,e,h))}return u}function fs(n,e,t){const i=n.pendingWriteTree_,r=n.syncPointTree_.findOnPath(e,(o,a)=>{const l=U(o,e),c=ge(a,l);if(c)return c});return Rr(i,e,r,t,!0)}function Su(n,e){const t=e._path;let s=null;n.syncPointTree_.foreachOnPath(t,(c,f)=>{const u=U(c,t);s=s||ge(f,u)});let i=n.syncPointTree_.get(t);i?s=s||ge(i,T()):(i=new Lr,n.syncPointTree_=n.syncPointTree_.set(t,i));const r=s!=null,o=r?new Ee(s,!0,!1):null,a=nn(n.pendingWriteTree_,e._path),l=Mr(i,e,a,r?o.getNode():y.EMPTY_NODE,r);return ru(l)}function Qe(n,e){return Ur(e,n.syncPointTree_,null,nn(n.pendingWriteTree_,T()))}function Ur(n,e,t,s){if(v(n.path))return Hr(n,e,t,s);{const i=e.get(T());t==null&&i!=null&&(t=ge(i,T()));let r=[];const o=C(n.path),a=n.operationForChild(o),l=e.children.get(o);if(l&&a){const c=t?t.getImmediateChild(o):null,f=Ar(s,o);r=r.concat(Ur(a,l,c,f))}return i&&(r=r.concat(ds(i,n,s,t))),r}}function Hr(n,e,t,s){const i=e.get(T());t==null&&i!=null&&(t=ge(i,T()));let r=[];return e.children.inorderTraversal((o,a)=>{const l=t?t.getImmediateChild(o):null,c=Ar(s,o),f=n.operationForChild(o);f&&(r=r.concat(Hr(f,a,l,c)))}),i&&(r=r.concat(ds(i,n,s,t))),r}function $r(n,e){const t=e.query,s=Et(n,t);return{hashFn:()=>(iu(e)||y.EMPTY_NODE).hash(),onComplete:i=>{if(i==="ok")return s?Cu(n,t._path,s):Eu(n,t._path);{const r=Ec(i,t);return Qt(n,t,null,r)}}}}function Et(n,e){const t=rn(e);return n.queryToTagMap.get(t)}function rn(n){return n._path.toString()+"$"+n._queryIdentifier}function ps(n,e){return n.tagToQueryMap.get(e)}function _s(n){const e=n.indexOf("$");return _(e!==-1&&e<n.length-1,"Bad queryKey."),{queryId:n.substr(e+1),path:new N(n.substr(0,e))}}function ms(n,e,t){const s=n.syncPointTree_.get(e);_(s,"Missing sync point for query tag that we're tracking");const i=nn(n.pendingWriteTree_,e);return ds(s,t,i,null)}function Iu(n){return n.fold((e,t,s)=>{if(t&&Ce(t))return[sn(t)];{let i=[];return t&&(i=xr(t)),G(s,(r,o)=>{i=i.concat(o)}),i}})}function ct(n){return n._queryParams.loadsAllData()&&!n._queryParams.isDefault()?new(_u())(n._repo,n._path):n}function bu(n,e){for(let t=0;t<e.length;++t){const s=e[t];if(!s._queryParams.loadsAllData()){const i=rn(s),r=n.queryToTagMap.get(i);n.queryToTagMap.delete(i),n.tagToQueryMap.delete(r)}}}function wu(){return mu++}function Tu(n,e,t){const s=e._path,i=Et(n,e),r=$r(n,t),o=n.listenProvider_.startListening(ct(e),i,r.hashFn,r.onComplete),a=n.syncPointTree_.subtree(s);if(i)_(!Ce(a.value),"If we're adding a query, it shouldn't be shadowed");else{const l=a.fold((c,f,u)=>{if(!v(c)&&f&&Ce(f))return[sn(f).query];{let h=[];return f&&(h=h.concat(xr(f).map(p=>p.query))),G(u,(p,m)=>{h=h.concat(m)}),h}});for(let c=0;c<l.length;++c){const f=l[c];n.listenProvider_.stopListening(ct(f),Et(n,f))}}return o}class gs{constructor(e){this.node_=e}getImmediateChild(e){const t=this.node_.getImmediateChild(e);return new gs(t)}node(){return this.node_}}class ys{constructor(e,t){this.syncTree_=e,this.path_=t}getImmediateChild(e){const t=D(this.path_,e);return new ys(this.syncTree_,t)}node(){return fs(this.syncTree_,this.path_)}}const Nu=function(n){return n=n||{},n.timestamp=n.timestamp||new Date().getTime(),n},mi=function(n,e,t){if(!n||typeof n!="object")return n;if(_(".sv"in n,"Unexpected leaf node or priority contents"),typeof n[".sv"]=="string")return Ru(n[".sv"],e,t);if(typeof n[".sv"]=="object")return Au(n[".sv"],e);_(!1,"Unexpected server value: "+JSON.stringify(n,null,2))},Ru=function(n,e,t){if(n==="timestamp")return t.timestamp;_(!1,"Unexpected server value: "+n)},Au=function(n,e,t){n.hasOwnProperty("increment")||_(!1,"Unexpected server value: "+JSON.stringify(n,null,2));const s=n.increment;typeof s!="number"&&_(!1,"Unexpected increment value: "+s);const i=e.node();if(_(i!==null&&typeof i<"u","Expected ChildrenNode.EMPTY_NODE for nulls"),!i.isLeafNode())return s;const o=i.getValue();return typeof o!="number"?s:o+s},Vr=function(n,e,t,s){return Es(e,new ys(t,n),s)},Kr=function(n,e,t){return Es(n,new gs(e),t)};function Es(n,e,t){const s=n.getPriority().val(),i=mi(s,e.getImmediateChild(".priority"),t);let r;if(n.isLeafNode()){const o=n,a=mi(o.getValue(),e,t);return a!==o.getValue()||i!==o.getPriority().val()?new B(a,L(i)):n}else{const o=n;return r=o,i!==o.getPriority().val()&&(r=r.updatePriority(new B(i))),o.forEachChild(k,(a,l)=>{const c=Es(l,e.getImmediateChild(a),t);c!==l&&(r=r.updateImmediateChild(a,c))}),r}}class Cs{constructor(e="",t=null,s={children:{},childCount:0}){this.name=e,this.parent=t,this.node=s}}function vs(n,e){let t=e instanceof N?e:new N(e),s=n,i=C(t);for(;i!==null;){const r=Ge(s.node.children,i)||{children:{},childCount:0};s=new Cs(i,s,r),t=R(t),i=C(t)}return s}function Xe(n){return n.node.value}function zr(n,e){n.node.value=e,$n(n)}function jr(n){return n.node.childCount>0}function Ou(n){return Xe(n)===void 0&&!jr(n)}function on(n,e){G(n.node.children,(t,s)=>{e(new Cs(t,n,s))})}function Yr(n,e,t,s){t&&e(n),on(n,i=>{Yr(i,e,!0)})}function Du(n,e,t){let s=n.parent;for(;s!==null;){if(e(s))return!0;s=s.parent}return!1}function Nt(n){return new N(n.parent===null?n.name:Nt(n.parent)+"/"+n.name)}function $n(n){n.parent!==null&&ku(n.parent,n.name,n)}function ku(n,e,t){const s=Ou(t),i=se(n.node.children,e);s&&i?(delete n.node.children[e],n.node.childCount--,$n(n)):!s&&!i&&(n.node.children[e]=t.node,n.node.childCount++,$n(n))}const Pu=/[\[\].#$\/\u0000-\u001F\u007F]/,Lu=/[\[\].#$\u0000-\u001F\u007F]/,Sn=10*1024*1024,Ss=function(n){return typeof n=="string"&&n.length!==0&&!Pu.test(n)},qr=function(n){return typeof n=="string"&&n.length!==0&&!Lu.test(n)},Mu=function(n){return n&&(n=n.replace(/^\/*\.info(\/|$)/,"/")),qr(n)},Qr=function(n){return n===null||typeof n=="string"||typeof n=="number"&&!Zt(n)||n&&typeof n=="object"&&se(n,".sv")},Xt=function(n,e,t,s){s&&e===void 0||an(Ue(n,"value"),e,t)},an=function(n,e,t){const s=t instanceof N?new Zc(t,n):t;if(e===void 0)throw new Error(n+"contains undefined "+we(s));if(typeof e=="function")throw new Error(n+"contains a function "+we(s)+" with contents = "+e.toString());if(Zt(e))throw new Error(n+"contains "+e.toString()+" "+we(s));if(typeof e=="string"&&e.length>Sn/3&&Jt(e)>Sn)throw new Error(n+"contains a string greater than "+Sn+" utf8 bytes "+we(s)+" ('"+e.substring(0,50)+"...')");if(e&&typeof e=="object"){let i=!1,r=!1;if(G(e,(o,a)=>{if(o===".value")i=!0;else if(o!==".priority"&&o!==".sv"&&(r=!0,!Ss(o)))throw new Error(n+" contains an invalid key ("+o+") "+we(s)+`.  Keys must be non-empty strings and can't contain ".", "#", "$", "/", "[", or "]"`);eh(s,o),an(n,a,s),th(s)}),i&&r)throw new Error(n+' contains ".value" child '+we(s)+" in addition to actual children.")}},xu=function(n,e){let t,s;for(t=0;t<e.length;t++){s=e[t];const r=pt(s);for(let o=0;o<r.length;o++)if(!(r[o]===".priority"&&o===r.length-1)){if(!Ss(r[o]))throw new Error(n+"contains an invalid key ("+r[o]+") in path "+s.toString()+`. Keys must be non-empty strings and can't contain ".", "#", "$", "/", "[", or "]"`)}}e.sort(Jc);let i=null;for(t=0;t<e.length;t++){if(s=e[t],i!==null&&Q(i,s))throw new Error(n+"contains a path "+i.toString()+" that is ancestor of another path "+s.toString());i=s}},Xr=function(n,e,t,s){const i=Ue(n,"values");if(!(e&&typeof e=="object")||Array.isArray(e))throw new Error(i+" must be an object containing the children to replace.");const r=[];G(e,(o,a)=>{const l=new N(o);if(an(i,a,D(t,l)),es(l)===".priority"&&!Qr(a))throw new Error(i+"contains an invalid value for '"+l.toString()+"', which must be a valid Firebase priority (a string, finite number, server value, or null).");r.push(l)}),xu(i,r)},Bu=function(n,e,t){if(Zt(e))throw new Error(Ue(n,"priority")+"is "+e.toString()+", but must be a valid Firebase priority (a string, finite number, server value, or null).");if(!Qr(e))throw new Error(Ue(n,"priority")+"must be a valid Firebase priority (a string, finite number, server value, or null).")},Jr=function(n,e,t,s){if(!qr(t))throw new Error(Ue(n,e)+'was an invalid path = "'+t+`". Paths must be non-empty strings and can't contain ".", "#", "$", "[", or "]"`)},Fu=function(n,e,t,s){t&&(t=t.replace(/^\/*\.info(\/|$)/,"/")),Jr(n,e,t)},xe=function(n,e){if(C(e)===".info")throw new Error(n+" failed = Can't modify data under /.info/")},Wu=function(n,e){const t=e.path.toString();if(typeof e.repoInfo.host!="string"||e.repoInfo.host.length===0||!Ss(e.repoInfo.namespace)&&e.repoInfo.host.split(":")[0]!=="localhost"||t.length!==0&&!Mu(t))throw new Error(Ue(n,"url")+`must be a valid firebase URL and the path can't contain ".", "#", "$", "[", or "]".`)};class Gu{constructor(){this.eventLists_=[],this.recursionDepth_=0}}function ln(n,e){let t=null;for(let s=0;s<e.length;s++){const i=e[s],r=i.getPath();t!==null&&!ts(r,t.path)&&(n.eventLists_.push(t),t=null),t===null&&(t={events:[],path:r}),t.events.push(i)}t&&n.eventLists_.push(t)}function Zr(n,e,t){ln(n,t),eo(n,s=>ts(s,e))}function X(n,e,t){ln(n,t),eo(n,s=>Q(s,e)||Q(e,s))}function eo(n,e){n.recursionDepth_++;let t=!0;for(let s=0;s<n.eventLists_.length;s++){const i=n.eventLists_[s];if(i){const r=i.path;e(r)?(Uu(n.eventLists_[s]),n.eventLists_[s]=null):t=!1}}t&&(n.eventLists_=[]),n.recursionDepth_--}function Uu(n){for(let e=0;e<n.events.length;e++){const t=n.events[e];if(t!==null){n.events[e]=null;const s=t.getEventRunner();rt&&W("event: "+t.toString()),Ye(s)}}}const Hu="repo_interrupt",$u=25;class Vu{constructor(e,t,s,i){this.repoInfo_=e,this.forceRestClient_=t,this.authTokenProvider_=s,this.appCheckProvider_=i,this.dataUpdateCount=0,this.statsListener_=null,this.eventQueue_=new Gu,this.nextWriteId_=1,this.interceptServerDataCallback_=null,this.onDisconnect_=Ht(),this.transactionQueueTree_=new Cs,this.persistentConnection_=null,this.key=this.repoInfo_.toURLString()}toString(){return(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host}}function Ku(n,e,t){if(n.stats_=Jn(n.repoInfo_),n.forceRestClient_||Ic())n.server_=new Ut(n.repoInfo_,(s,i,r,o)=>{gi(n,s,i,r,o)},n.authTokenProvider_,n.appCheckProvider_),setTimeout(()=>yi(n,!0),0);else{if(typeof t<"u"&&t!==null){if(typeof t!="object")throw new Error("Only objects are supported for option databaseAuthVariableOverride");try{x(t)}catch(s){throw new Error("Invalid authOverride provided: "+s)}}n.persistentConnection_=new oe(n.repoInfo_,e,(s,i,r,o)=>{gi(n,s,i,r,o)},s=>{yi(n,s)},s=>{zu(n,s)},n.authTokenProvider_,n.appCheckProvider_,t),n.server_=n.persistentConnection_}n.authTokenProvider_.addTokenChangeListener(s=>{n.server_.refreshAuthToken(s)}),n.appCheckProvider_.addTokenChangeListener(s=>{n.server_.refreshAppCheckToken(s.token)}),n.statsReporter_=Rc(n.repoInfo_,()=>new Nh(n.stats_,n.server_)),n.infoData_=new Sh,n.infoSyncTree_=new _i({startListening:(s,i,r,o)=>{let a=[];const l=n.infoData_.getNode(s._path);return l.isEmpty()||(a=Tt(n.infoSyncTree_,s._path,l),setTimeout(()=>{o("ok")},0)),a},stopListening:()=>{}}),Is(n,"connected",!1),n.serverSyncTree_=new _i({startListening:(s,i,r,o)=>(n.server_.listen(s,r,i,(a,l)=>{const c=o(a,l);X(n.eventQueue_,s._path,c)}),[]),stopListening:(s,i)=>{n.server_.unlisten(s,i)}})}function to(n){const t=n.infoData_.getNode(new N(".info/serverTimeOffset")).val()||0;return new Date().getTime()+t}function cn(n){return Nu({timestamp:to(n)})}function gi(n,e,t,s,i){n.dataUpdateCount++;const r=new N(e);t=n.interceptServerDataCallback_?n.interceptServerDataCallback_(e,t):t;let o=[];if(i)if(s){const l=Lt(t,c=>L(c));o=vu(n.serverSyncTree_,r,l,i)}else{const l=L(t);o=Gr(n.serverSyncTree_,r,l,i)}else if(s){const l=Lt(t,c=>L(c));o=yu(n.serverSyncTree_,r,l)}else{const l=L(t);o=Tt(n.serverSyncTree_,r,l)}let a=r;o.length>0&&(a=ze(n,r)),X(n.eventQueue_,a,o)}function yi(n,e){Is(n,"connected",e),e===!1&&Qu(n)}function zu(n,e){G(e,(t,s)=>{Is(n,t,s)})}function Is(n,e,t){const s=new N("/.info/"+e),i=L(t);n.infoData_.updateSnapshot(s,i);const r=Tt(n.infoSyncTree_,s,i);X(n.eventQueue_,s,r)}function bs(n){return n.nextWriteId_++}function ju(n,e,t){const s=Su(n.serverSyncTree_,e);return s!=null?Promise.resolve(s):n.server_.get(e).then(i=>{const r=L(i).withIndex(e._queryParams.getIndex());Hn(n.serverSyncTree_,e,t,!0);let o;if(e._queryParams.loadsAllData())o=Tt(n.serverSyncTree_,e._path,r);else{const a=Et(n.serverSyncTree_,e);o=Gr(n.serverSyncTree_,e._path,r,a)}return X(n.eventQueue_,e._path,o),Qt(n.serverSyncTree_,e,t,null,!0),r},i=>(Rt(n,"get for query "+x(e)+" failed: "+i),Promise.reject(new Error(i))))}function Yu(n,e,t,s,i){Rt(n,"set",{path:e.toString(),value:t,priority:s});const r=cn(n),o=L(t,s),a=fs(n.serverSyncTree_,e),l=Kr(o,a,r),c=bs(n),f=Wr(n.serverSyncTree_,e,l,c,!0);ln(n.eventQueue_,f),n.server_.put(e.toString(),o.val(!0),(h,p)=>{const m=h==="ok";m||H("set at "+e+" failed: "+h);const g=fe(n.serverSyncTree_,c,!m);X(n.eventQueue_,e,g),ve(n,i,h,p)});const u=Ts(n,e);ze(n,u),X(n.eventQueue_,u,[])}function qu(n,e,t,s){Rt(n,"update",{path:e.toString(),value:t});let i=!0;const r=cn(n),o={};if(G(t,(a,l)=>{i=!1,o[a]=Vr(D(e,a),L(l),n.serverSyncTree_,r)}),i)W("update() called with empty data.  Don't do anything."),ve(n,s,"ok",void 0);else{const a=bs(n),l=gu(n.serverSyncTree_,e,o,a);ln(n.eventQueue_,l),n.server_.merge(e.toString(),t,(c,f)=>{const u=c==="ok";u||H("update at "+e+" failed: "+c);const h=fe(n.serverSyncTree_,a,!u),p=h.length>0?ze(n,e):e;X(n.eventQueue_,p,h),ve(n,s,c,f)}),G(t,c=>{const f=Ts(n,D(e,c));ze(n,f)}),X(n.eventQueue_,e,[])}}function Qu(n){Rt(n,"onDisconnectEvents");const e=cn(n),t=Ht();xn(n.onDisconnect_,T(),(i,r)=>{const o=Vr(i,r,n.serverSyncTree_,e);qe(t,i,o)});let s=[];xn(t,T(),(i,r)=>{s=s.concat(Tt(n.serverSyncTree_,i,r));const o=Ts(n,i);ze(n,o)}),n.onDisconnect_=Ht(),X(n.eventQueue_,T(),s)}function Xu(n,e,t){n.server_.onDisconnectCancel(e.toString(),(s,i)=>{s==="ok"&&Mn(n.onDisconnect_,e),ve(n,t,s,i)})}function Ei(n,e,t,s){const i=L(t);n.server_.onDisconnectPut(e.toString(),i.val(!0),(r,o)=>{r==="ok"&&qe(n.onDisconnect_,e,i),ve(n,s,r,o)})}function Ju(n,e,t,s,i){const r=L(t,s);n.server_.onDisconnectPut(e.toString(),r.val(!0),(o,a)=>{o==="ok"&&qe(n.onDisconnect_,e,r),ve(n,i,o,a)})}function Zu(n,e,t,s){if(Tn(t)){W("onDisconnect().update() called with empty data.  Don't do anything."),ve(n,s,"ok",void 0);return}n.server_.onDisconnectMerge(e.toString(),t,(i,r)=>{i==="ok"&&G(t,(o,a)=>{const l=L(a);qe(n.onDisconnect_,D(e,o),l)}),ve(n,s,i,r)})}function ed(n,e,t){let s;C(e._path)===".info"?s=Hn(n.infoSyncTree_,e,t):s=Hn(n.serverSyncTree_,e,t),Zr(n.eventQueue_,e._path,s)}function td(n,e,t){let s;C(e._path)===".info"?s=Qt(n.infoSyncTree_,e,t):s=Qt(n.serverSyncTree_,e,t),Zr(n.eventQueue_,e._path,s)}function nd(n){n.persistentConnection_&&n.persistentConnection_.interrupt(Hu)}function Rt(n,...e){let t="";n.persistentConnection_&&(t=n.persistentConnection_.id+":"),W(t,...e)}function ve(n,e,t,s){e&&Ye(()=>{if(t==="ok")e(null);else{const i=(t||"error").toUpperCase();let r=i;s&&(r+=": "+s);const o=new Error(r);o.code=i,e(o)}})}function no(n,e,t){return fs(n.serverSyncTree_,e,t)||y.EMPTY_NODE}function ws(n,e=n.transactionQueueTree_){if(e||hn(n,e),Xe(e)){const t=io(n,e);_(t.length>0,"Sending zero length transaction queue"),t.every(i=>i.status===0)&&sd(n,Nt(e),t)}else jr(e)&&on(e,t=>{ws(n,t)})}function sd(n,e,t){const s=t.map(c=>c.currentWriteId),i=no(n,e,s);let r=i;const o=i.hash();for(let c=0;c<t.length;c++){const f=t[c];_(f.status===0,"tryToSendTransactionQueue_: items in queue should all be run."),f.status=1,f.retryCount++;const u=U(e,f.path);r=r.updateChild(u,f.currentOutputSnapshotRaw)}const a=r.val(!0),l=e;n.server_.put(l.toString(),a,c=>{Rt(n,"transaction put response",{path:l.toString(),status:c});let f=[];if(c==="ok"){const u=[];for(let h=0;h<t.length;h++)t[h].status=2,f=f.concat(fe(n.serverSyncTree_,t[h].currentWriteId)),t[h].onComplete&&u.push(()=>t[h].onComplete(null,!0,t[h].currentOutputSnapshotResolved)),t[h].unwatcher();hn(n,vs(n.transactionQueueTree_,e)),ws(n,n.transactionQueueTree_),X(n.eventQueue_,e,f);for(let h=0;h<u.length;h++)Ye(u[h])}else{if(c==="datastale")for(let u=0;u<t.length;u++)t[u].status===3?t[u].status=4:t[u].status=0;else{H("transaction at "+l.toString()+" failed: "+c);for(let u=0;u<t.length;u++)t[u].status=4,t[u].abortReason=c}ze(n,e)}},o)}function ze(n,e){const t=so(n,e),s=Nt(t),i=io(n,t);return id(n,i,s),s}function id(n,e,t){if(e.length===0)return;const s=[];let i=[];const o=e.filter(a=>a.status===0).map(a=>a.currentWriteId);for(let a=0;a<e.length;a++){const l=e[a],c=U(t,l.path);let f=!1,u;if(_(c!==null,"rerunTransactionsUnderNode_: relativePath should not be null."),l.status===4)f=!0,u=l.abortReason,i=i.concat(fe(n.serverSyncTree_,l.currentWriteId,!0));else if(l.status===0)if(l.retryCount>=$u)f=!0,u="maxretry",i=i.concat(fe(n.serverSyncTree_,l.currentWriteId,!0));else{const h=no(n,l.path,o);l.currentInputSnapshot=h;const p=e[a].update(h.val());if(p!==void 0){an("transaction failed: Data returned ",p,l.path);let m=L(p);typeof p=="object"&&p!=null&&se(p,".priority")||(m=m.updatePriority(h.getPriority()));const w=l.currentWriteId,P=cn(n),E=Kr(m,h,P);l.currentOutputSnapshotRaw=m,l.currentOutputSnapshotResolved=E,l.currentWriteId=bs(n),o.splice(o.indexOf(w),1),i=i.concat(Wr(n.serverSyncTree_,l.path,E,l.currentWriteId,l.applyLocally)),i=i.concat(fe(n.serverSyncTree_,w,!0))}else f=!0,u="nodata",i=i.concat(fe(n.serverSyncTree_,l.currentWriteId,!0))}X(n.eventQueue_,t,i),i=[],f&&(e[a].status=2,(function(h){setTimeout(h,Math.floor(0))})(e[a].unwatcher),e[a].onComplete&&(u==="nodata"?s.push(()=>e[a].onComplete(null,!1,e[a].currentInputSnapshot)):s.push(()=>e[a].onComplete(new Error(u),!1,null))))}hn(n,n.transactionQueueTree_);for(let a=0;a<s.length;a++)Ye(s[a]);ws(n,n.transactionQueueTree_)}function so(n,e){let t,s=n.transactionQueueTree_;for(t=C(e);t!==null&&Xe(s)===void 0;)s=vs(s,t),e=R(e),t=C(e);return s}function io(n,e){const t=[];return ro(n,e,t),t.sort((s,i)=>s.order-i.order),t}function ro(n,e,t){const s=Xe(e);if(s)for(let i=0;i<s.length;i++)t.push(s[i]);on(e,i=>{ro(n,i,t)})}function hn(n,e){const t=Xe(e);if(t){let s=0;for(let i=0;i<t.length;i++)t[i].status!==2&&(t[s]=t[i],s++);t.length=s,zr(e,t.length>0?t:void 0)}on(e,s=>{hn(n,s)})}function Ts(n,e){const t=Nt(so(n,e)),s=vs(n.transactionQueueTree_,e);return Du(s,i=>{In(n,i)}),In(n,s),Yr(s,i=>{In(n,i)}),t}function In(n,e){const t=Xe(e);if(t){const s=[];let i=[],r=-1;for(let o=0;o<t.length;o++)t[o].status===3||(t[o].status===1?(_(r===o-1,"All SENT items should be at beginning of queue."),r=o,t[o].status=3,t[o].abortReason="set"):(_(t[o].status===0,"Unexpected transaction status in abort"),t[o].unwatcher(),i=i.concat(fe(n.serverSyncTree_,t[o].currentWriteId,!0)),t[o].onComplete&&s.push(t[o].onComplete.bind(null,new Error("set"),!1,null))));r===-1?zr(e,void 0):t.length=r+1,X(n.eventQueue_,Nt(e),i);for(let o=0;o<s.length;o++)Ye(s[o])}}function rd(n){let e="";const t=n.split("/");for(let s=0;s<t.length;s++)if(t[s].length>0){let i=t[s];try{i=decodeURIComponent(i.replace(/\+/g," "))}catch{}e+="/"+i}return e}function od(n){const e={};n.charAt(0)==="?"&&(n=n.substring(1));for(const t of n.split("&")){if(t.length===0)continue;const s=t.split("=");s.length===2?e[decodeURIComponent(s[0])]=decodeURIComponent(s[1]):H(`Invalid query segment '${t}' in query '${n}'`)}return e}const Ci=function(n,e){const t=ad(n),s=t.namespace;t.domain==="firebase.com"&&ce(t.host+" is no longer supported. Please use <YOUR FIREBASE>.firebaseio.com instead"),(!s||s==="undefined")&&t.domain!=="localhost"&&ce("Cannot parse Firebase url. Please use https://<YOUR FIREBASE>.firebaseio.com"),t.secure||pc();const i=t.scheme==="ws"||t.scheme==="wss";return{repoInfo:new lr(t.host,t.secure,s,i,e,"",s!==t.subdomain),path:new N(t.pathString)}},ad=function(n){let e="",t="",s="",i="",r="",o=!0,a="https",l=443;if(typeof n=="string"){let c=n.indexOf("//");c>=0&&(a=n.substring(0,c-1),n=n.substring(c+2));let f=n.indexOf("/");f===-1&&(f=n.length);let u=n.indexOf("?");u===-1&&(u=n.length),e=n.substring(0,Math.min(f,u)),f<u&&(i=rd(n.substring(f,u)));const h=od(n.substring(Math.min(n.length,u)));c=e.indexOf(":"),c>=0?(o=a==="https"||a==="wss",l=parseInt(e.substring(c+1),10)):c=e.length;const p=e.slice(0,c);if(p.toLowerCase()==="localhost")t="localhost";else if(p.split(".").length<=2)t=p;else{const m=e.indexOf(".");s=e.substring(0,m).toLowerCase(),t=e.substring(m+1),r=s}"ns"in h&&(r=h.ns)}return{host:e,port:l,domain:t,subdomain:s,secure:o,scheme:a,pathString:i,namespace:r}};const vi="-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz",ld=(function(){let n=0;const e=[];return function(t){const s=t===n;n=t;let i;const r=new Array(8);for(i=7;i>=0;i--)r[i]=vi.charAt(t%64),t=Math.floor(t/64);_(t===0,"Cannot push at time == 0");let o=r.join("");if(s){for(i=11;i>=0&&e[i]===63;i--)e[i]=0;e[i]++}else for(i=0;i<12;i++)e[i]=Math.floor(Math.random()*64);for(i=0;i<12;i++)o+=vi.charAt(e[i]);return _(o.length===20,"nextPushId: Length should be 20."),o}})();class cd{constructor(e,t,s,i){this.eventType=e,this.eventRegistration=t,this.snapshot=s,this.prevName=i}getPath(){const e=this.snapshot.ref;return this.eventType==="value"?e._path:e.parent._path}getEventType(){return this.eventType}getEventRunner(){return this.eventRegistration.getEventRunner(this)}toString(){return this.getPath().toString()+":"+this.eventType+":"+x(this.snapshot.exportVal())}}class hd{constructor(e,t,s){this.eventRegistration=e,this.error=t,this.path=s}getPath(){return this.path}getEventType(){return"cancel"}getEventRunner(){return this.eventRegistration.getEventRunner(this)}toString(){return this.path.toString()+":cancel"}}class oo{constructor(e,t){this.snapshotCallback=e,this.cancelCallback=t}onValue(e,t){this.snapshotCallback.call(null,e,t)}onCancel(e){return _(this.hasCancelCallback,"Raising a cancel event on a listener with no cancel callback"),this.cancelCallback.call(null,e)}get hasCancelCallback(){return!!this.cancelCallback}matches(e){return this.snapshotCallback===e.snapshotCallback||this.snapshotCallback.userCallback!==void 0&&this.snapshotCallback.userCallback===e.snapshotCallback.userCallback&&this.snapshotCallback.context===e.snapshotCallback.context}}class ud{constructor(e,t){this._repo=e,this._path=t}cancel(){const e=new te;return Xu(this._repo,this._path,e.wrapCallback(()=>{})),e.promise}remove(){xe("OnDisconnect.remove",this._path);const e=new te;return Ei(this._repo,this._path,null,e.wrapCallback(()=>{})),e.promise}set(e){xe("OnDisconnect.set",this._path),Xt("OnDisconnect.set",e,this._path,!1);const t=new te;return Ei(this._repo,this._path,e,t.wrapCallback(()=>{})),t.promise}setWithPriority(e,t){xe("OnDisconnect.setWithPriority",this._path),Xt("OnDisconnect.setWithPriority",e,this._path,!1),Bu("OnDisconnect.setWithPriority",t);const s=new te;return Ju(this._repo,this._path,e,t,s.wrapCallback(()=>{})),s.promise}update(e){xe("OnDisconnect.update",this._path),Xr("OnDisconnect.update",e,this._path);const t=new te;return Zu(this._repo,this._path,e,t.wrapCallback(()=>{})),t.promise}}class Ns{constructor(e,t,s,i){this._repo=e,this._path=t,this._queryParams=s,this._orderByCalled=i}get key(){return v(this._path)?null:es(this._path)}get ref(){return new he(this._repo,this._path)}get _queryIdentifier(){const e=ri(this._queryParams),t=Qn(e);return t==="{}"?"default":t}get _queryObject(){return ri(this._queryParams)}isEqual(e){if(e=Ie(e),!(e instanceof Ns))return!1;const t=this._repo===e._repo,s=ts(this._path,e._path),i=this._queryIdentifier===e._queryIdentifier;return t&&s&&i}toJSON(){return this.toString()}toString(){return this._repo.toString()+Xc(this._path)}}class he extends Ns{constructor(e,t){super(e,t,new rs,!1)}get parent(){const e=gr(this._path);return e===null?null:new he(this._repo,e)}get root(){let e=this;for(;e.parent!==null;)e=e.parent;return e}}class Ct{constructor(e,t,s){this._node=e,this.ref=t,this._index=s}get priority(){return this._node.getPriority().val()}get key(){return this.ref.key}get size(){return this._node.numChildren()}child(e){const t=new N(e),s=vt(this.ref,e);return new Ct(this._node.getChild(t),s,k)}exists(){return!this._node.isEmpty()}exportVal(){return this._node.val(!0)}forEach(e){return this._node.isLeafNode()?!1:!!this._node.forEachChild(this._index,(s,i)=>e(new Ct(i,vt(this.ref,s),k)))}hasChild(e){const t=new N(e);return!this._node.getChild(t).isEmpty()}hasChildren(){return this._node.isLeafNode()?!1:!this._node.isEmpty()}toJSON(){return this.exportVal()}val(){return this._node.val()}}function z(n,e){return n=Ie(n),n._checkNotDeleted("ref"),e!==void 0?vt(n._root,e):n._root}function vt(n,e){return n=Ie(n),C(n._path)===null?Fu("child","path",e):Jr("child","path",e),new he(n._repo,D(n._path,e))}function Si(n){return n=Ie(n),new ud(n._repo,n._path)}function dd(n,e){n=Ie(n),xe("push",n._path),Xt("push",e,n._path,!0);const t=to(n._repo),s=ld(t),i=vt(n,s),r=vt(n,s);let o;return o=Promise.resolve(r),i.then=o.then.bind(o),i.catch=o.then.bind(o,void 0),i}function bn(n,e){n=Ie(n),xe("set",n._path),Xt("set",e,n._path,!1);const t=new te;return Yu(n._repo,n._path,e,null,t.wrapCallback(()=>{})),t.promise}function de(n,e){Xr("update",e,n._path);const t=new te;return qu(n._repo,n._path,e,t.wrapCallback(()=>{})),t.promise}function Ii(n){n=Ie(n);const e=new oo(()=>{}),t=new un(e);return ju(n._repo,n,t).then(s=>new Ct(s,new he(n._repo,n._path),n._queryParams.getIndex()))}class un{constructor(e){this.callbackContext=e}respondsTo(e){return e==="value"}createEvent(e,t){const s=t._queryParams.getIndex();return new cd("value",this,new Ct(e.snapshotNode,new he(t._repo,t._path),s))}getEventRunner(e){return e.getEventType()==="cancel"?()=>this.callbackContext.onCancel(e.error):()=>this.callbackContext.onValue(e.snapshot,null)}createCancelEvent(e,t){return this.callbackContext.hasCancelCallback?new hd(this,e,t):null}matches(e){return e instanceof un?!e.callbackContext||!this.callbackContext?!0:e.callbackContext.matches(this.callbackContext):!1}hasAnyCallback(){return this.callbackContext!==null}}function fd(n,e,t,s,i){const r=new oo(t,void 0),o=new un(r);return ed(n._repo,n,o),()=>td(n._repo,n,o)}function pd(n,e,t,s){return fd(n,"value",e)}cu(he);pu(he);const _d="FIREBASE_DATABASE_EMULATOR_HOST",Vn={};let md=!1;function gd(n,e,t,s){const i=e.lastIndexOf(":"),r=e.substring(0,i),o=Yn(r);n.repoInfo_=new lr(e,o,n.repoInfo_.namespace,n.repoInfo_.webSocketOnly,n.repoInfo_.nodeAdmin,n.repoInfo_.persistenceKey,n.repoInfo_.includeNamespaceInQueryParams,!0,t),s&&(n.authTokenProvider_=s)}function yd(n,e,t,s,i){let r=s||n.options.databaseURL;r===void 0&&(n.options.projectId||ce("Can't determine Firebase Database URL. Be sure to include  a Project ID when calling firebase.initializeApp()."),W("Using default host for project ",n.options.projectId),r=`${n.options.projectId}-default-rtdb.firebaseio.com`);let o=Ci(r,i),a=o.repoInfo,l;typeof process<"u"&&Us&&(l=Us[_d]),l?(r=`http://${l}?ns=${a.namespace}`,o=Ci(r,i),a=o.repoInfo):o.repoInfo.secure;const c=new wc(n.name,n.options,e);Wu("Invalid Firebase Database URL",o),v(o.path)||ce("Database URL must point to the root of a Firebase Database (not including a child path).");const f=Cd(a,n,c,new bc(n,t));return new vd(f,n)}function Ed(n,e){const t=Vn[e];(!t||t[n.key]!==n)&&ce(`Database ${e}(${n.repoInfo_}) has already been deleted.`),nd(n),delete t[n.key]}function Cd(n,e,t,s){let i=Vn[e.name];i||(i={},Vn[e.name]=i);let r=i[n.toURLString()];return r&&ce("Database initialized multiple times. Please make sure the format of the database URL matches with each database() call."),r=new Vu(n,md,t,s),i[n.toURLString()]=r,r}class vd{constructor(e,t){this._repoInternal=e,this.app=t,this.type="database",this._instanceStarted=!1}get _repo(){return this._instanceStarted||(Ku(this._repoInternal,this.app.options.appId,this.app.options.databaseAuthVariableOverride),this._instanceStarted=!0),this._repoInternal}get _root(){return this._rootInternal||(this._rootInternal=new he(this._repo,T())),this._rootInternal}_delete(){return this._rootInternal!==null&&(Ed(this._repo,this.app.name),this._repoInternal=null,this._rootInternal=null),Promise.resolve()}_checkNotDeleted(e){this._rootInternal===null&&ce("Cannot call "+e+" on a deleted database.")}}function Sd(n=ql(),e){const t=Vl(n,"database").getImmediate({identifier:e});if(!t._instanceStarted){const s=Aa("database");s&&Id(t,...s)}return t}function Id(n,e,t,s={}){n=Ie(n),n._checkNotDeleted("useEmulator");const i=`${e}:${t}`,r=n._repoInternal;if(n._instanceStarted){if(i===n._repoInternal.repoInfo_.host&&Mt(s,r.repoInfo_.emulatorOptions))return;ce("connectDatabaseEmulator() cannot initialize or alter the emulator configuration after the database instance has started.")}let o;if(r.repoInfo_.nodeAdmin)s.mockUserToken&&ce('mockUserToken is not supported by the Admin SDK. For client access with mock users, please use the "firebase" package instead of "firebase-admin".'),o=new Dt(Dt.OWNER);else if(s.mockUserToken){const a=typeof s.mockUserToken=="string"?s.mockUserToken:Da(s.mockUserToken,n.app.options.projectId);o=new Dt(a)}Yn(e)&&(Oa(e),La("Database",!0)),gd(r,i,s,o)}function bd(n){lc(Yl),Bt(new ut("database",(e,{instanceIdentifier:t})=>{const s=e.getProvider("app").getImmediate(),i=e.getProvider("auth-internal"),r=e.getProvider("app-check-internal");return yd(s,i,r,t)},"PUBLIC").setMultipleInstances(!0)),Be(Hs,$s,n),Be(Hs,$s,"esm2020")}oe.prototype.simpleListen=function(n,e){this.sendRequest("q",{p:n},e)};oe.prototype.echo=function(n,e){this.sendRequest("echo",{d:n},e)};bd();const wd={apiKey:"AIzaSyDhDhpFMVbXOq04J2jZkGrfjeovdTT6U2o",authDomain:"tiny-towns-multiplayer.firebaseapp.com",databaseURL:"https://tiny-towns-multiplayer-default-rtdb.europe-west1.firebasedatabase.app",projectId:"tiny-towns-multiplayer",storageBucket:"tiny-towns-multiplayer.firebasestorage.app",messagingSenderId:"374830147876",appId:"1:374830147876:web:93ffbe5825d8d3af982bb1"},Td=Ki(wd),j=Sd(Td);class Nd{gameId=null;playerId;isHost=!1;localGame;masterBuilderId=null;myName="Unknown";currentRound=1;onStateChange=null;onGameStart=null;constructor(e){this.localGame=e,this.playerId="player_"+Math.random().toString(36).substr(2,9)}async createGame(e,t){const s=z(j,"games"),i=dd(s);this.gameId=i.key,this.isHost=!0,this.myName=e;const r={status:"LOBBY",hostId:this.playerId,deck:t,currentResource:null,masterBuilderIndex:0,roundNumber:1,playerOrder:[this.playerId],players:{[this.playerId]:{name:e,score:0,isReady:!0,placedRound:0,isGameOver:!1,board:this.serializeBoard()}}};return await bn(i,r),this.subscribeToGame(),Si(i).remove(),this.gameId}async joinGame(e,t){const s=z(j,`games/${e}`);if(!(await Ii(s)).exists())throw new Error("Game not found");this.gameId=e,this.isHost=!1,this.myName=t;const r=z(j,`games/${e}/players/${this.playerId}`);await bn(r,{name:t,score:0,isReady:!0,placedRound:0,isGameOver:!1,board:this.serializeBoard()});const o=z(j,`games/${e}/playerOrder`),l=(await Ii(o)).val()||[];l.includes(this.playerId)||(l.push(this.playerId),await bn(o,l)),Si(r).remove(),this.subscribeToGame()}async startGame(){!this.isHost||!this.gameId||await de(z(j,`games/${this.gameId}`),{status:"PLAYING"})}async updateDeck(e){!this.isHost||!this.gameId||await de(z(j,`games/${this.gameId}`),{deck:e})}subscribeToGame(){if(!this.gameId)return;const e=z(j,`games/${this.gameId}`);pd(e,t=>{const s=t.val();if(!s)return;s.status==="PLAYING"&&this.localGame.gameRegistry.length===0&&(this.syncDeck(s.deck),this.onGameStart&&this.onGameStart());const i=s.playerOrder||[],r=Array.isArray(i)?i:Object.values(i);if(r.length>0){const o=(s.masterBuilderIndex||0)%r.length;this.masterBuilderId=r[o]}s.currentResource===void 0||s.currentResource===""?this.localGame.currentResource=null:this.localGame.currentResource=s.currentResource,this.currentRound=s.roundNumber||1,this.onStateChange&&this.onStateChange(s),this.isHost&&s.status==="PLAYING"&&setTimeout(()=>this.checkTurnComplete(s),10)})}async setGlobalResource(e){if(!this.gameId||this.playerId!==this.masterBuilderId)return;const t={};t[`games/${this.gameId}/currentResource`]=e,await de(z(j),t)}async commitTurn(){if(!this.gameId)return;const e={},t=`games/${this.gameId}/players/${this.playerId}`;e[`${t}/board`]=this.serializeBoard(),e[`${t}/score`]=this.localGame.getScore().total,e[`${t}/placedRound`]=this.currentRound,await de(z(j),e)}async saveBoardOnly(){if(!this.gameId)return;console.log("Saving board state (Turn not finished)...");const e={},t=`games/${this.gameId}/players/${this.playerId}`;e[`${t}/board`]=this.serializeBoard(),e[`${t}/score`]=this.localGame.getScore().total,await de(z(j),e)}async declareGameOver(){if(!this.gameId)return;const e={},t=`games/${this.gameId}/players/${this.playerId}`;e[`${t}/isGameOver`]=!0,e[`${t}/placedRound`]=this.currentRound,await de(z(j),e),this.isHost&&setTimeout(()=>{},10)}async checkTurnComplete(e){if(!e||!e.players)return;const t=Object.values(e.players),s=e.roundNumber||1,i=e.playerOrder||[];if(t.every(h=>h.isGameOver===!0)){e.status!=="FINISHED"&&(console.log("GAME OVER FOR EVERYONE"),await de(z(j,`games/${this.gameId}`),{status:"FINISHED"}));return}const o=e.currentResource!==void 0&&e.currentResource!==null,a=t.every(h=>h.placedRound===s||h.isGameOver===!0),l=(e.masterBuilderIndex||0)%i.length,c=i[l],f=e.players[c]&&e.players[c].isGameOver;let u=!1;if(o&&a?(console.log(`Round ${s} Complete. Rotating.`),u=!0):!o&&f&&(console.log("Current Master Builder is finished. Skipping their turn."),u=!0),u){let h=e.masterBuilderIndex||0,p=!1;for(let g=1;g<=i.length;g++){const w=(h+g)%i.length,P=i[w],E=e.players[P];if(E&&!E.isGameOver){h=h+g,p=!0;break}}p||h++;const m={};m[`games/${this.gameId}/currentResource`]=null,m[`games/${this.gameId}/masterBuilderIndex`]=h,m[`games/${this.gameId}/roundNumber`]=s+1,await de(z(j),m)}}syncDeck(e){e&&(this.localGame.gameRegistry=kt.filter(t=>e.includes(t.name)),this.localGame.scanForMatches())}serializeBoard(){return this.localGame.board.getGrid()}}const $=new ga,Pe=new ya,K=new Nd($);let ae=null,dn=[],nt="",Kn=!1,bi=!1;const I={startModal:document.getElementById("start-screen-modal"),landingUI:document.getElementById("landing-ui"),lobbyUI:document.getElementById("lobby-ui"),playerNameInput:document.getElementById("player-name-input"),createGameBtn:document.getElementById("create-game-ui-btn"),joinGameBtn:document.getElementById("join-game-btn"),gameIdInput:document.getElementById("game-id-input"),shareCodeDisplay:document.getElementById("share-code-display"),lobbyPlayerList:document.getElementById("lobby-player-list"),hostSettings:document.getElementById("host-settings"),guestWaitingMsg:document.getElementById("guest-waiting-msg"),startGameBtn:document.getElementById("start-game-btn"),multiplayerResultsModal:document.getElementById("multiplayer-results-modal"),leaderboardList:document.getElementById("leaderboard-list"),mpRestartBtn:document.getElementById("mp-restart-btn"),opponentsSidebar:document.getElementById("opponents-sidebar"),opponentsList:document.getElementById("opponents-list"),monumentGrid:document.getElementById("monument-pattern-grid"),monumentDesc:document.getElementById("monument-desc"),gameOverModal:document.getElementById("game-over-modal"),finalScore:document.getElementById("final-score"),scoreList:document.getElementById("score-breakdown-list"),restartBtn:document.getElementById("restart-btn"),undoBtn:document.getElementById("undo-btn")},Rs=[{id:"RED",label:"Farm (Red)",options:Ni},{id:"GRAY",label:"Well (Gray)",options:Ri},{id:"YELLOW",label:"Theater (Yellow)",options:Oi},{id:"GREEN",label:"Tavern (Green)",options:Ai},{id:"ORANGE",label:"Chapel (Orange)",options:ki},{id:"BLACK",label:"Factory (Black)",options:Di},{id:"PURPLE",label:"Monument",options:kt.filter(n=>n.isMonument)}];K.onStateChange=n=>{try{if(n.status==="LOBBY"&&Ad(n.players),n.status==="PLAYING"){I.startModal.classList.contains("hidden")||(I.startModal.classList.add("hidden"),Oe(),Pe.renderDeck($.gameRegistry)),n.players&&Md(n.players,n.roundNumber||1);let e="Unknown";const t=n.playerOrder||[],s=Array.isArray(t)?t:Object.values(t);if(s.length>0&&n.players){const l=(n.masterBuilderIndex||0)%s.length,c=s[l];n.players[c]&&(e=n.players[c].name)}const i=K.masterBuilderId===K.playerId,r=n.currentResource!==void 0&&n.currentResource!==null,o=n.roundNumber||1,a=n.players?n.players[K.playerId]:null;a&&(Kn=Number(a.placedRound)===Number(o)),r?Kn?(nt="Waiting for other players to finish placing...",st(!1)):(nt="",st(!1)):i?(nt="YOU are the Master Builder! Choose a resource.",st(!0)):(nt=`Waiting for ${e} to choose a resource...`,st(!1))}n.status==="FINISHED"&&(I.gameOverModal.classList.add("hidden"),Ld(n.players),I.multiplayerResultsModal.classList.remove("hidden")),$.currentResource=n.currentResource||null,Oe()}catch(e){console.error("Error in onStateChange:",e)}};K.onGameStart=()=>{I.startModal.classList.add("hidden"),Oe(),Pe.renderDeck($.gameRegistry)};Pe.onResourceSelect=n=>{console.log("Clicked resource:",n),console.log("Current game state resource:",$.currentResource),!ae&&($.currentResource?console.log("Blocked: Resource already active:",$.currentResource):(console.log("Sending request to set resource..."),K.setGlobalResource(n)))};Pe.onCellClick=(n,e)=>{try{ae?Dd(n,e):Rd(n,e)}catch(t){ne(t.message,"error")}};async function Rd(n,e){if(Kn){ne("You have already placed a resource this turn! Wait for others.","error");return}if(!$.currentResource){ne("Waiting for Master Builder...","info");return}try{$.placeResource(n,e)}catch(t){ne(t.message,"error");return}await K.commitTurn(),Oe(),uo()}Pe.onBuildClick=n=>{ae=n,dn=kd(n),Oe()};Pe.onCancelClick=()=>{co(),Oe()};I.undoBtn.onclick=()=>{ne("Undo not yet supported in Multiplayer!","info")};I.mpRestartBtn.onclick=()=>{location.reload()};I.createGameBtn.onclick=async()=>{const n=I.playerNameInput.value||"Host";try{const e=lo(),t=await K.createGame(n,e.map(s=>s.name));ao(t,!0)}catch(e){console.error("Firebase Error:",e),ne("Error creating game. Check console for details.","error")}};I.joinGameBtn.onclick=async()=>{const n=I.playerNameInput.value||"Guest",e=I.gameIdInput.value.trim();if(!e){ne("Please enter a code!","error");return}try{await K.joinGame(e,n),ao(e,!1)}catch(t){ne("Could not join game: "+t,"error")}};I.startGameBtn.onclick=async()=>{const n=Od();await K.updateDeck(n.map(e=>e.name)),await K.startGame()};I.shareCodeDisplay.onclick=()=>{const n=I.shareCodeDisplay.innerText.replace("Code: ","");navigator.clipboard.writeText(n),ne("Code copied!","success")};I.restartBtn.onclick=()=>{location.reload()};function ao(n,e){I.landingUI.classList.add("hidden"),I.lobbyUI.classList.remove("hidden"),I.shareCodeDisplay.innerText=`Code: ${n}`,e?(I.hostSettings.classList.remove("hidden"),I.guestWaitingMsg.classList.add("hidden"),Pd()):(I.hostSettings.classList.add("hidden"),I.guestWaitingMsg.classList.remove("hidden"))}function Ad(n){I.lobbyPlayerList.innerHTML="<strong>Players:</strong><br>",Object.values(n).forEach(e=>{const t=document.createElement("div");t.textContent=` ${e.name}`,I.lobbyPlayerList.appendChild(t)})}function Od(){const n=[zn],e=document.querySelectorAll(".setup-select");return e.length===0?lo():(e.forEach(t=>{const s=t.dataset.category;if(!s)return;const i=Rs.find(o=>o.id===s);if(!i)return;let r;t.value==="RANDOM"?r=ho(i.options):r=i.options.find(o=>o.name===t.value),r&&n.push(r)}),n)}function lo(){const n=[zn];return Rs.forEach(e=>{n.push(ho(e.options))}),n}function Dd(n,e){const s=$.board.getGrid()[n][e],i=dn.some(c=>c.row===n&&c.col===e),r=ae?ae.buildingName.toUpperCase():"",l=($.hasObeliskAbility()||r==="SHED")&&s==="NONE";if(i||l){if(s&&s.toUpperCase().replace("_"," ")==="TRADING POST"){ne("Cannot build on Trading Post.","error");return}$.constructBuilding(ae,n,e),K.saveBoardOnly(),co(),Oe(),uo()}}function co(){ae=null,dn=[]}function kd(n){const e=[];return n.pattern.forEach((t,s)=>{t.forEach((i,r)=>{i!=="NONE"&&e.push({row:n.row+s,col:n.col+r})})}),e}function ho(n){return n[Math.floor(Math.random()*n.length)]}function Oe(){Pe.render($,ae,dn,nt)}function uo(){if(!bi&&$.checkGameOver()&&!ae){const n=$.getScore();I.finalScore.textContent=n.total.toString(),I.scoreList.innerHTML="",Object.entries(n.breakdown).forEach(([e,t])=>{t!==0&&wi(e,t)}),n.penaltyCount>0&&wi("Empty Spaces",-n.penaltyCount,!0),I.gameOverModal.classList.remove("hidden"),K.declareGameOver(),bi=!0,st(!1)}}function wi(n,e,t=!1){const s=document.createElement("li");s.className="score-item",t&&(s.classList.add("penalty-text"),s.style.color="#ef5350"),s.style.display="flex",s.style.justifyContent="space-between",s.innerHTML=`<span>${n.toLowerCase()}</span><strong>${e}</strong>`,I.scoreList.appendChild(s)}function Pd(){const n=document.getElementById("setup-container");n.innerHTML="";const e=document.createElement("div");e.className="setup-grid",Rs.forEach(t=>{const s=document.createElement("div");s.className="setup-group";const i=document.createElement("label");i.className="setup-label",i.textContent=t.label,s.appendChild(i);const r=document.createElement("select");r.className=`setup-select ${t.id}`,r.dataset.category=t.id;const o=document.createElement("option");o.value="RANDOM",o.textContent="Random",r.appendChild(o),t.options.forEach(a=>{const l=document.createElement("option");l.value=a.name,l.textContent=a.name,r.appendChild(l)}),s.appendChild(r),e.appendChild(s)}),n.appendChild(e)}function st(n){const e=document.getElementById("resource-palette");e&&(n?(e.style.opacity="1",e.style.pointerEvents="auto"):(e.style.opacity="0.5",e.style.pointerEvents="none"))}function Ld(n){I.leaderboardList.innerHTML="",Object.values(n).sort((t,s)=>s.score-t.score).forEach((t,s)=>{const i=document.createElement("li");i.className="leaderboard-row",s===0&&i.classList.add("winner");const r=s+1;i.innerHTML=`
            <div style="display:flex; align-items:center;">
                <div class="rank-badge">${r}</div>
                <div class="player-info">
                    <span class="player-name">${t.name}</span>
                    <span class="player-details">
                        ${t.isGameOver?"Finished":"Playing"} 
                    </span>
                </div>
            </div>
            <div class="final-total">${t.score}</div>
        `,I.leaderboardList.appendChild(i)})}function ne(n,e="info"){const t=document.getElementById("toast-container");if(!t)return;const s=document.createElement("div");s.className=`toast ${e}`,s.textContent=n,t.appendChild(s),setTimeout(()=>{s.remove()},4e3)}function Md(n,e){I.opponentsSidebar.classList.remove("hidden"),I.opponentsList.innerHTML="",Object.keys(n).forEach(t=>{if(t===K.playerId)return;const s=n[t],i=s.placedRound===e||s.isGameOver,r=i?"done":"thinking",o=document.createElement("div");o.className="opponent-card";const a=document.createElement("div");a.className="opponent-name",a.innerHTML=`
            ${s.name}
            <span class="status-dot ${r}" title="${i?"Waiting":"Thinking"}"></span>
        `,o.appendChild(a);const l=document.createElement("div");l.className="mini-board",s.board&&Array.isArray(s.board)&&s.board.forEach(c=>{c.forEach(f=>{const u=document.createElement("div");u.className="mini-cell",f!=="NONE"&&(["WOOD","WHEAT","BRICK","GLASS","STONE"].includes(f)?u.classList.add(f):(u.classList.add(f),u.title=f,["COTTAGE","FARM","GRANARY","GREENHOUSE","ORCHARD","WELL","FOUNTAIN","MILLSTONE","SHED","CHAPEL","ABBEY","CLOISTER","TEMPLE","TAVERN","ALMSHOUSE","INN","FEAST-HALL","THEATER","BAKERY","TAILOR","MARKET","FACTORY","BANK","WAREHOUSE","TRADING-POST"].includes(f)||u.classList.add("MONUMENT"))),l.appendChild(u)})}),o.appendChild(l),I.opponentsList.appendChild(o)})}
