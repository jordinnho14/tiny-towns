(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const c of o.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&n(c)}).observe(document,{childList:!0,subtree:!0});function t(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerPolicy&&(o.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?o.credentials="include":r.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(r){if(r.ep)return;r.ep=!0;const o=t(r);fetch(r.href,o)}})();const s={WOOD:"WOOD",WHEAT:"WHEAT",BRICK:"BRICK",GLASS:"GLASS",STONE:"STONE",NONE:"NONE"},b={COTTAGE:"COTTAGE",TAVERN:"TAVERN",CHAPEL:"CHAPEL",BARRETT_CASTLE:"BARRETT_CASTLE"};class v{points;requiresFood;constructor(e,t=!1){this.points=e,this.requiresFood=t}score(e){return this.requiresFood&&!e.fedState?0:this.points}}class ${targetTypes;pointsPerNeighbor;constructor(e,t){this.targetTypes=e,this.pointsPerNeighbor=t}score(e){let t=0;const n=[[-1,0],[1,0],[0,-1],[0,1]];for(const[r,o]of n){const c=e.row+r,d=e.col+o;if(c>=0&&c<4&&d>=0&&d<4){const i=e.grid[c][d];this.targetTypes.includes(i)&&(t+=this.pointsPerNeighbor)}}return t}}class K{score(e){const t=new Set;for(let n=0;n<4;n++)n!==e.col&&this.addIfBuilding(t,e.grid[e.row][n]);for(let n=0;n<4;n++)n!==e.row&&this.addIfBuilding(t,e.grid[n][e.col]);return t.size}addIfBuilding(e,t){["NONE","WOOD","WHEAT","BRICK","GLASS","STONE"].includes(t)||e.add(t)}}class P{score(e){let t=0;return Object.values(e.counts).forEach(n=>{n===1&&(t+=1)}),t}}class U{multiplier;constructor(e){this.multiplier=e}score(e){const t=new Set,n=[[-1,0],[1,0],[0,-1],[0,1]],r=["NONE","WOOD","WHEAT","BRICK","GLASS","STONE"];for(const[o,c]of n){const d=e.row+o,i=e.col+c;if(d>=0&&d<4&&i>=0&&i<4){const l=e.grid[d][i];r.includes(l)||t.add(l)}}return t.size*this.multiplier}}class F{score(e){const t=`${e.row},${e.col}`,n=e.metadata.get(t);return n&&n.savedScore||0}}class q{score(e){let t=0;for(const n of e.validBuildingNames){const r=n.toUpperCase();e.counts[r]||t++}return t*2}}class x{score(e){let t=0;const n=new Set,r=["NONE","WOOD","WHEAT","BRICK","GLASS","STONE"],o=[[-1,0],[1,0],[0,-1],[0,1]];for(let c=0;c<4;c++)for(let d=0;d<4;d++){const i=`${c},${d}`,l=e.grid[c][d];if(n.has(i)||r.includes(l))continue;let f=0;const m=[{r:c,c:d}];for(n.add(i);m.length>0;){const g=m.pop();f++;for(const[S,T]of o){const O=g.r+S,C=g.c+T,u=`${O},${C}`;O>=0&&O<4&&C>=0&&C<4&&!n.has(u)&&e.grid[O][C]===l&&(n.add(u),m.push({r:O,c:C}))}}f>t&&(t=f)}return 1+t}}class z{score(e){let t=0;for(let n=0;n<4;n++)for(let r=0;r<4;r++){const o=e.grid[n][r],c=`${n},${r}`;o==="COTTAGE"&&(e.allFedPositions.has(c)||t++)}return t*3}}const V={name:"Cottage",pattern:[[s.NONE,s.WHEAT],[s.BRICK,s.GLASS]],scorer:new v(3,!0),feedCost:1},_={name:"Well",pattern:[[s.WOOD,s.STONE]],scorer:new $([b.COTTAGE,b.BARRETT_CASTLE],1)},j={name:"Farm",pattern:[[s.WHEAT,s.WHEAT],[s.WOOD,s.WOOD]],feeds:4},J={name:"Tavern",pattern:[[s.BRICK,s.BRICK,s.GLASS]]},Y={name:"Theater",pattern:[[s.NONE,s.STONE,s.NONE],[s.WOOD,s.GLASS,s.WOOD]],scorer:new K},Q={name:"Factory",pattern:[[s.WOOD,s.NONE,s.NONE,s.NONE],[s.BRICK,s.STONE,s.STONE,s.BRICK]]},X={name:"Chapel",pattern:[[s.NONE,s.NONE,s.GLASS],[s.STONE,s.GLASS,s.STONE]]},Z={name:"Archive",pattern:[[s.WHEAT,s.WHEAT],[s.BRICK,s.GLASS]],scorer:new P,isMonument:!0},ee={name:"Barrett Castle",pattern:[[s.WHEAT,s.NONE,s.NONE,s.STONE],[s.WOOD,s.GLASS,s.GLASS,s.BRICK]],scorer:new v(5,!0),feedCost:1,countsAs:[b.COTTAGE],isMonument:!0},te={name:"Obelisk of the Crescent",pattern:[[s.WHEAT,s.NONE,s.NONE],[s.BRICK,s.GLASS,s.BRICK]],isMonument:!0},ne={name:"Mandras",pattern:[[s.WHEAT,s.GLASS],[s.BRICK,s.WOOD]],scorer:new U(2),isMonument:!0},se={name:"Shrine of the Elder Tree",pattern:[[s.BRICK,s.WHEAT,s.STONE],[s.WOOD,s.GLASS,s.WOOD]],isMonument:!0,scorer:new F},re={name:"Baths",pattern:[[s.NONE,s.WHEAT,s.NONE],[s.STONE,s.GLASS,s.WOOD],[s.BRICK,s.NONE,s.BRICK]],isMonument:!0,scorer:new q},oe={name:"Forum",pattern:[[s.NONE,s.NONE,s.WHEAT,s.NONE],[s.BRICK,s.BRICK,s.STONE,s.WOOD]],isMonument:!0,scorer:new x},ie={name:"Mausoleum",pattern:[[s.WOOD,s.WOOD],[s.BRICK,s.STONE]],isMonument:!0,scorer:new z},ae={name:"Cathedral",pattern:[[s.NONE,s.WHEAT],[s.STONE,s.GLASS]],isMonument:!0,scorer:new v(2,!1)},L=[V,_,j,J,Y,Q,X,Z,ee,te,ne,se,re,oe,ie,ae];class I{grid;size=4;metadata=new Map;constructor(){this.grid=Array(this.size).fill(null).map(()=>Array(this.size).fill(s.NONE))}place(e,t,n){if(!this.isValid(e,t))throw new Error(`Invalid coordinate: ${e}, ${t}`);if(this.grid[e][t]!==s.NONE)throw new Error("Spot already occupied");this.grid[e][t]=n}constructBuilding(e,t,n,r){if(!e.some(c=>c.row===t&&c.col===n)&&this.grid[t][n]!=="NONE")throw new Error("Building must be placed on one of the pattern squares.");this.clear(e),this.grid[t][n]=r}clear(e){e.forEach(({row:t,col:n})=>{this.isValid(t,n)&&(this.grid[t][n]=s.NONE,this.metadata.delete(`${t},${n}`))})}getGrid(){return this.grid.map(e=>[...e])}isValid(e,t){return e>=0&&e<this.size&&t>=0&&t<this.size}remove(e,t){this.isValid(e,t)&&(this.grid[e][t]="NONE",this.metadata.delete(`${e},${t}`))}setMetadata(e,t,n){this.metadata.set(`${e},${t}`,n)}getMetadata(e,t){return this.metadata.get(`${e},${t}`)}}class ce{static rotate(e){return e[0].map((t,n)=>e.map(r=>r[n]).reverse())}static flip(e){return e.map(t=>[...t].reverse())}static getSymmetries(e){const t=new Set;let n=e;for(let r=0;r<4;r++)t.add(JSON.stringify(n)),t.add(JSON.stringify(this.flip(n))),n=this.rotate(n);return Array.from(t).map(r=>JSON.parse(r))}static findMatches(e,t){const n=this.getSymmetries(t.pattern),r=[];for(const o of n){const c=o.length,d=o[0].length;for(let i=0;i<=4-c;i++)for(let l=0;l<=4-d;l++)this.isMatch(e,o,i,l)&&r.push({row:i,col:l,pattern:o})}return r}static isMatch(e,t,n,r){return t.every((o,c)=>o.every((d,i)=>d==="NONE"?!0:e[n+c][r+i]===d))}}class le{static calculateScore(e,t,n){const c={},d=n.map(u=>u.name),i={};let l=0,f=[],m=0;for(let u=0;u<4;u++)for(let p=0;p<4;p++){const N=e[u][p];if(!this.isBuilding(N)){m++;continue}i[N]=(i[N]||0)+1;const y=L.find(A=>A.name.toUpperCase()===N);if(y&&(y.feeds&&(l+=y.feeds),y.feedCost)){const A=y.name==="Barrett"?10:1;f.push({r:u,c:p,cost:y.feedCost,id:`${u},${p}`,priority:A})}}const g=(i.CATHEDRAL||0)>0;f.sort((u,p)=>p.priority-u.priority);const S=new Set;let T=0;for(const u of f)if(l>=u.cost){l-=u.cost,S.add(u.id);const p=e[u.r][u.c];p===b.COTTAGE?T+=1:p===b.BARRETT_CASTLE&&(T+=2)}for(let u=0;u<4;u++)for(let p=0;p<4;p++){const N=e[u][p];if(!this.isBuilding(N))continue;const y=L.find(A=>A.name.toUpperCase()===N);if(y)if(y.scorer){const A={grid:e,row:u,col:p,counts:i,fedState:S.has(`${u},${p}`),metadata:t,validBuildingNames:d,allFedPositions:S},k=y.scorer.score(A);c[N]=(c[N]||0)+k}else N===b.CHAPEL&&(c[N]=(c[N]||0)+T)}if(i[b.TAVERN]){const u=[0,2,5,9,14,20],p=Math.min(i[b.TAVERN],5);c[b.TAVERN]=u[p]}let O=0;Object.values(c).forEach(u=>O+=u);const C=g?0:m;return{total:O-C,breakdown:c,penaltyCount:C}}static isBuilding(e){return!["NONE","WOOD","WHEAT","BRICK","GLASS","STONE"].includes(e)}}class de{board;currentResource=null;availableMatches=[];activeMonument=null;gameRegistry=[];lastMove=null;constructor(){this.board=new I}start(){this.board=new I,this.currentResource=null,this.lastMove=null,this.availableMatches=[]}placeResource(e,t){if(!this.currentResource)throw new Error("No resource selected");this.board.place(e,t,this.currentResource),this.lastMove={r:e,c:t},this.currentResource=null,this.scanForMatches()}constructBuilding(e,t,n){const r=[];let o=0,c=!1;if(e.pattern.forEach((d,i)=>{d.forEach((l,f)=>{l!=="NONE"&&r.push({row:e.row+i,col:e.col+f})})}),console.log("building name: "+e.buildingName),e.buildingName==="SHRINE OF THE ELDER TREE"){c=!0,console.log("made it to shrine scoring");const i=this.countBuildingsOnBoard()+1;i<6?o=i:o=8}this.board.constructBuilding(r,t,n,e.buildingName),c&&this.board.setMetadata(t,n,{savedScore:o}),this.lastMove=null,this.scanForMatches()}undo(){this.lastMove&&(this.board.remove(this.lastMove.r,this.lastMove.c),this.lastMove=null,this.scanForMatches())}canUndo(){return this.lastMove!==null}scanForMatches(){this.availableMatches=[];const e=this.board.getGrid(),t=e.some(n=>n.some(r=>this.gameRegistry.find(c=>c.name.toUpperCase()===r)?.isMonument));for(const n of this.gameRegistry){if(t&&n.isMonument)continue;ce.findMatches(e,n).forEach(o=>{this.availableMatches.push({...o,buildingName:n.name.toUpperCase()})})}}checkGameOver(){const t=this.board.getGrid().some(r=>r.some(o=>o==="NONE")),n=this.availableMatches.length>0;return!t&&!n}getScore(){return le.calculateScore(this.board.getGrid(),this.board.metadata,this.gameRegistry)}countBuildingsOnBoard(){const e=this.board.getGrid();let t=0;const n=["WOOD","WHEAT","BRICK","GLASS","STONE","NONE"];return e.forEach(r=>{r.forEach(o=>{n.includes(o)||t++})}),t}hasObeliskAbility(){return this.board.getGrid().some(t=>t.some(n=>n.toUpperCase().includes("OBELISK")))}}class ue{boardEl=document.getElementById("board");buildMenuEl=document.getElementById("build-menu");msgLabel=document.getElementById("message");paletteEl=document.getElementById("resource-palette");scoreEl=document.getElementById("score-display");undoBtn=document.getElementById("undo-btn");deckDisplayEl=document.getElementById("deck-display");onCellClick=()=>{};onResourceSelect=()=>{};onBuildClick=()=>{};onCancelClick=()=>{};constructor(){}render(e,t,n){this.renderHeader(e),this.renderBoard(e,t,n),this.renderSidebar(e,t),this.renderControls(e,t)}renderHeader(e){const t=e.getScore(),n=t.total+t.penaltyCount;this.scoreEl.innerHTML=`Score: ${n} <span style="font-size:12px; color:#999">(-${t.penaltyCount} empty)</span>`}renderBoard(e,t,n){const r=e.hasObeliskAbility(),o=e.board.getGrid(),c=["WOOD","WHEAT","BRICK","GLASS","STONE"];this.boardEl.children.length===0&&o.forEach((i,l)=>{i.forEach((f,m)=>{const g=document.createElement("div");g.dataset.r=l.toString(),g.dataset.c=m.toString(),g.onclick=()=>this.onCellClick(l,m),this.boardEl.appendChild(g)})}),Array.from(this.boardEl.children).forEach(i=>{const l=parseInt(i.dataset.r),f=parseInt(i.dataset.c),m=o[l][f],g=m.replace(/ /g,"-").replace(/'/g,"").toUpperCase();let S=`cell ${m==="NONE"?"empty":g}`;t&&(n.some(C=>C.row===l&&C.col===f)||r&&m==="NONE")&&(S+=" match-highlight"),i.className!==S&&(i.className=S,m==="NONE"?(i.textContent="",i.style.color=""):c.includes(m)?(i.textContent=m,i.style.color=""):(i.textContent="",i.style.color="")),m==="NONE"&&e.currentResource&&!t?(i.onmouseenter=()=>{i.classList.add("ghost",e.currentResource),i.textContent=""},i.onmouseleave=()=>{i.classList.remove("ghost","WOOD","WHEAT","BRICK","GLASS","STONE"),i.textContent=""}):(i.onmouseenter=null,i.onmouseleave=null)}),t?(this.msgLabel.textContent=`Select a highlighted square to build your ${t.buildingName}!`,this.msgLabel.style.color="#d32f2f"):e.availableMatches.length>0?(this.msgLabel.textContent="Matches available!",this.msgLabel.style.color="#333"):e.currentResource?(this.msgLabel.textContent=`Place ${e.currentResource}...`,this.msgLabel.style.color="#333"):(this.msgLabel.textContent="Select a Resource...",this.msgLabel.style.color="#1976d2")}renderSidebar(e,t){if(this.buildMenuEl.innerHTML="",e.availableMatches.length===0){const n=document.createElement("p");n.textContent="No patterns found.",n.style.color="#777",n.style.fontStyle="italic",this.buildMenuEl.appendChild(n)}else e.availableMatches.forEach(n=>{const r=document.createElement("button");r.textContent=`Build ${n.buildingName}`;const o=n.buildingName.replace(/ /g,"-").replace(/'/g,"").toUpperCase();r.className=`build-btn ${o}`,r.onclick=()=>this.onBuildClick(n);const c=[];n.pattern&&Array.isArray(n.pattern)?n.pattern.forEach((d,i)=>{d.forEach((l,f)=>{l&&l!=="NONE"&&c.push({row:n.row+i,col:n.col+f})})}):c.push({row:n.row,col:n.col}),r.onmouseenter=()=>this.togglePreview(c,!0),r.onmouseleave=()=>this.togglePreview(c,!1),this.buildMenuEl.appendChild(r)});if(t){const n=document.createElement("button");n.textContent="Cancel Construction",n.className="secondary-btn",n.style.marginTop="10px",n.style.width="100%",n.onclick=()=>this.onCancelClick(),this.buildMenuEl.appendChild(n)}}togglePreview(e,t){e.forEach(n=>{const r=`div[data-r="${n.row}"][data-c="${n.col}"]`,o=this.boardEl.querySelector(r);o&&(t?o.classList.add("preview-target"):o.classList.remove("preview-target"))})}renderControls(e,t){this.paletteEl.innerHTML="",[s.WOOD,s.WHEAT,s.BRICK,s.GLASS,s.STONE].forEach(r=>{const o=document.createElement("div");let c=`res-btn ${r}`;e.currentResource===r&&!t&&(c+=" selected"),o.className=c,o.textContent=r.charAt(0),o.onclick=()=>this.onResourceSelect(r),this.paletteEl.appendChild(o)}),e.canUndo()&&!t?this.undoBtn.removeAttribute("disabled"):this.undoBtn.setAttribute("disabled","true")}renderDeck(e){this.deckDisplayEl&&(this.deckDisplayEl.innerHTML="",e.forEach(t=>{const n=document.createElement("div");n.className="building-card";const r=document.createElement("header");r.className="card-header";const o=document.createElement("span");o.textContent=t.name;const c=document.createElement("div"),d=t.name.replace(/ /g,"-").replace(/'/g,"").toUpperCase();c.className=`card-icon ${d}`,r.appendChild(o),r.appendChild(c),n.appendChild(r);const i=document.createElement("div");i.className="card-body";const l=document.createElement("div");l.className="mini-pattern";const f=t.pattern[0].length;l.style.gridTemplateColumns=`repeat(${f}, 15px)`,t.pattern.forEach(g=>{g.forEach(S=>{const T=document.createElement("div"),O=S==="NONE"?"pattern-empty":S;T.className=`pattern-cell ${O}`,l.appendChild(T)})});const m=document.createElement("div");m.className="card-text",m.textContent=this.getDescription(t.name),i.appendChild(l),i.appendChild(m),n.appendChild(i),this.deckDisplayEl.appendChild(n)}))}getDescription(e){return{Cottage:"3 pts if fed.",Farm:"Feeds 4 Cottages.",Well:"1 pt per adjacent Cottage.",Theater:"1 pt per unique building in row/col.",Chapel:"1 pt per fed Cottage.",Tavern:"Score: 2, 5, 9, 14, 20 pts.","Archive of the Second Age":"1pt per unique building type.","Barrett Castle":"Feeds 2. Worth 5 pts.",Mandras:"2pts per unique neighbor.","Shrine of the Elder Tree":"Score rises as town fills (1-8pts).",Cathedral:"2pts. No empty penalty.",Baths:"2pts per missing building type.",Forum:"Score based on largest group.","Grand Mausoleum":"Unfed Cottages score 3pts.","Obelisk of the Crescent":"Place buildings anywhere."}[e]||"Unique scoring rules."}}const E=new de,R=new ue;let B=null,w=[];const h={startModal:document.getElementById("start-screen-modal"),startBtn:document.getElementById("start-game-btn"),restartBtn:document.getElementById("restart-btn"),undoBtn:document.getElementById("undo-btn"),monumentGrid:document.getElementById("monument-pattern-grid"),monumentSelect:document.getElementById("monument-selector"),monumentDesc:document.getElementById("monument-desc"),gameOverModal:document.getElementById("game-over-modal"),finalScore:document.getElementById("final-score"),scoreList:document.getElementById("score-breakdown-list")};R.onResourceSelect=a=>{B||(E.currentResource=a,M())};R.onBuildClick=a=>{B=a,w=pe(a),M()};R.onCellClick=(a,e)=>{try{B?me(a,e):he(a,e)}catch(t){alert(t.message)}};R.onCancelClick=()=>{W(),M()};h.undoBtn.onclick=()=>{E.undo(),M()};h.startBtn.onclick=()=>{const a=L.filter(e=>!e.isMonument);E.gameRegistry=[...a,E.activeMonument],E.start(),h.startModal.classList.add("hidden"),M(),R.renderDeck(E.gameRegistry)};h.restartBtn.onclick=()=>{h.gameOverModal.classList.add("hidden"),H()};function me(a,e){const t=w.some(r=>r.row===a&&r.col===e),n=E.hasObeliskAbility()&&E.board.getGrid()[a][e]==="NONE";(t||n)&&(E.constructBuilding(B,a,e),W(),M(),D())}function he(a,e){if(!E.currentResource){alert("Select a resource first!");return}E.placeResource(a,e),M(),D()}function W(){B=null,w=[]}function pe(a){const e=[];return a.pattern.forEach((t,n)=>{t.forEach((r,o)=>{r!=="NONE"&&e.push({row:a.row+n,col:a.col+o})})}),e}function M(){R.render(E,B,w)}function H(){const a=L.filter(t=>t.isMonument);h.monumentSelect.innerHTML="",a.forEach((t,n)=>{const r=document.createElement("option");r.value=n.toString(),r.textContent=t.name,h.monumentSelect.appendChild(r)}),h.monumentSelect.onchange=()=>{const t=a[parseInt(h.monumentSelect.value)];E.activeMonument=t,fe(t)};const e=Math.floor(Math.random()*a.length);h.monumentSelect.value=e.toString(),h.monumentSelect.onchange(null),h.startModal.classList.remove("hidden")}function fe(a){h.monumentSelect.className=`monument-select ${a.name.toUpperCase()}`;const e={Archive:"1pt for every unique building type.","Barrett Castle":"Feeds 2 cottages. Worth 5pts.",Mandras:"2pts per unique adjacent neighbor.",Caterina:"Empty spaces are worth +1 instead of -1.","Obelisk of the Crescent":"ABILITY: Can place buildings anywhere.","Shrine of the Elder Tree":"Score depends on when you build it (1-8pts).",Baths:"2pts for every building type NOT in your town.",Forum:"1pt + size of largest group of identical buildings.","Grand Mausoleum":"Unfed cottages score 3pts.",Cathedral:"2pts. Empty spaces are worth 0."};h.monumentDesc.textContent=e[a.name]||"A unique monument.",Ee(a)}function Ee(a){h.monumentGrid.innerHTML="";const e=a.pattern;h.monumentGrid.style.gridTemplateColumns=`repeat(${e[0].length}, 30px)`,e.forEach(t=>{t.forEach(n=>{const r=document.createElement("div");r.className=`mini-cell ${n}`,h.monumentGrid.appendChild(r)})})}function D(){if(E.checkGameOver()&&!B){const a=E.getScore();h.finalScore.textContent=a.total.toString(),h.scoreList.innerHTML="";for(const[e,t]of Object.entries(a.breakdown))t!==0&&G(e,t);a.penaltyCount>0&&G("Empty Spaces",-a.penaltyCount,!0),h.gameOverModal.classList.remove("hidden")}}function G(a,e,t=!1){const n=document.createElement("li");n.className="score-item",t&&n.classList.add("penalty-text"),n.style.display="flex",n.style.justifyContent="space-between",n.style.marginBottom="5px",t&&(n.style.color="#ef5350",n.style.marginTop="10px",n.style.borderTop="1px solid #eee",n.style.paddingTop="5px"),n.innerHTML=`
        <span style="text-transform: capitalize;">${a.toLowerCase()}</span>
        <strong>${e}</strong>
    `,h.scoreList.appendChild(n)}H();
