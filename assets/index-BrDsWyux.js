(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=t(i);fetch(i.href,r)}})();const f={WOOD:"WOOD",WHEAT:"WHEAT",BRICK:"BRICK",GLASS:"GLASS",STONE:"STONE",NONE:"NONE"},Z={COTTAGE:"COTTAGE",TAVERN:"TAVERN",BARRETT_CASTLE:"BARRETT_CASTLE"};class ae{points;requiresFood;constructor(e,t=!1){this.points=e,this.requiresFood=t}score(e){return this.requiresFood&&!e.fedState?0:this.points}}class Eo{targetTypes;pointsPerNeighbor;constructor(e,t){this.targetTypes=e,this.pointsPerNeighbor=t}score(e){let t=0;const s=[[-1,0],[1,0],[0,-1],[0,1]];for(const[i,r]of s){const o=e.row+i,a=e.col+r;if(o>=0&&o<4&&a>=0&&a<4){const l=e.grid[o][a];this.targetTypes.includes(l)&&(t+=this.pointsPerNeighbor)}}return t}}class Co{score(e){const t=new Set;for(let s=0;s<4;s++)s!==e.col&&this.addIfBuilding(t,e.grid[e.row][s]);for(let s=0;s<4;s++)s!==e.row&&this.addIfBuilding(t,e.grid[s][e.col]);return t.size}addIfBuilding(e,t){["NONE","WOOD","WHEAT","BRICK","GLASS","STONE"].includes(t)||e.add(t)}}class vo{score(e){let t=0;return Object.values(e.counts).forEach(s=>{s===1&&(t+=1)}),t}}class So{multiplier;constructor(e){this.multiplier=e}score(e){const t=new Set,s=[[-1,0],[1,0],[0,-1],[0,1]],i=["NONE","WOOD","WHEAT","BRICK","GLASS","STONE"];for(const[r,o]of s){const a=e.row+r,l=e.col+o;if(a>=0&&a<4&&l>=0&&l<4){const c=e.grid[a][l];i.includes(c)||t.add(c)}}return t.size*this.multiplier}}class bo{score(e){const t=`${e.row},${e.col}`,s=e.metadata.get(t);return s&&s.savedScore||0}}class wo{score(e){let t=0;for(const s of e.validBuildingNames){const i=s.toUpperCase();e.counts[i]||t++}return t*2}}class Io{score(e){let t=0;const s=new Set,i=["NONE","WOOD","WHEAT","BRICK","GLASS","STONE"],r=[[-1,0],[1,0],[0,-1],[0,1]];for(let o=0;o<4;o++)for(let a=0;a<4;a++){const l=`${o},${a}`,c=e.grid[o][a];if(s.has(l)||i.includes(c))continue;let h=0;const u=[{r:o,c:a}];for(s.add(l);u.length>0;){const d=u.pop();h++;for(const[p,m]of r){const _=d.r+p,C=d.c+m,N=`${_},${C}`;_>=0&&_<4&&C>=0&&C<4&&!s.has(N)&&e.grid[_][C]===c&&(s.add(N),u.push({r:_,c:C}))}}h>t&&(t=h)}return 1+t}}class To{score(e){let t=0;for(let s=0;s<4;s++)for(let i=0;i<4;i++){const r=e.grid[s][i],o=`${s},${i}`;r==="COTTAGE"&&(e.allFedPositions.has(o)||t++)}return t*3}}class No{targetTypes;scoreAmount;constructor(e,t){this.targetTypes=e,this.scoreAmount=t}score(e){const t=[[-1,0],[1,0],[0,-1],[0,1]];for(const[s,i]of t){const r=e.row+s,o=e.col+i;if(r>=0&&r<4&&o>=0&&o<4){const a=e.grid[r][o];if(this.targetTypes.includes(a))return this.scoreAmount}}return 0}}class Di{targetCategories;scoreAmount;constructor(e,t){this.targetCategories=e,this.scoreAmount=t}score(e){const t=[[-1,0],[1,0],[0,-1],[0,1]];for(const[s,i]of t){const r=e.row+s,o=e.col+i;if(r>=0&&r<4&&o>=0&&o<4){const a=e.grid[r][o],l=e.registry.find(c=>c.name.toUpperCase()===a.toUpperCase());if(l&&this.targetCategories.includes(l.type))return this.scoreAmount}}return 0}}class Ro{score(e){let t=0;const s=e.grid[e.row][e.col];for(let i=0;i<4;i++)i!==e.col&&e.grid[e.row][i]===s&&t++;for(let i=0;i<4;i++)i!==e.row&&e.grid[i][e.col]===s&&t++;return t}}class Oo{score(e){let t=1;const s=["1,1","1,2","2,1","2,2"],i=`${e.row},${e.col}`,r=e.grid[e.row][e.col];return s.forEach(o=>{if(o===i)return;const[a,l]=o.split(",").map(Number);e.grid[a][l]===r&&t++}),t}}class Ao{score(e){const t=e.grid[e.row][e.col],s=e.counts[t]||e.counts[t.toUpperCase()]||0;return s===0?0:s%2!==0?-1:({2:5,4:15,6:26,8:40}[s]??s*5)/s}}class ko{score(e){const t=e.grid[e.row][e.col];for(let s=0;s<4;s++)if(s!==e.col&&e.grid[e.row][s]===t)return 0;for(let s=0;s<4;s++)if(s!==e.row&&e.grid[s][e.col]===t)return 0;return 3}}class Do{score(e){return e.fedCottageCount}}class Mo{requiredNeighbors;scoreAmount;constructor(e,t){this.requiredNeighbors=e,this.scoreAmount=t}score(e){let t=0;const s=[[-1,0],[1,0],[0,-1],[0,1]];for(const[i,r]of s){const o=e.row+i,a=e.col+r;o>=0&&o<4&&a>=0&&a<4&&e.allFedPositions.has(`${o},${a}`)&&t++}return t>=this.requiredNeighbors?this.scoreAmount:0}}class Lo{targetName;constructor(e){this.targetName=e}score(e){const t=[{r:0,c:0},{r:0,c:3},{r:3,c:0},{r:3,c:3}];let s=0;return t.forEach(i=>{e.grid[i.r][i.c]===this.targetName&&s++}),s}}class Po{restrictedCategories;scoreAmount;constructor(e,t){this.restrictedCategories=e,this.scoreAmount=t}score(e){const t=[[-1,0],[1,0],[0,-1],[0,1]];for(const[s,i]of t){const r=e.row+s,o=e.col+i;if(r>=0&&r<4&&o>=0&&o<4){const a=e.grid[r][o],l=e.registry.find(c=>c.name.toUpperCase()===a.toUpperCase());if(l&&this.restrictedCategories.includes(l.type))return 0}}return this.scoreAmount}}const Jn={name:"Cottage",type:"BLUE",pattern:[[f.NONE,f.WHEAT],[f.BRICK,f.GLASS]],scorer:new ae(3,!0),feedCost:1,description:"3 points if fed."},xo=[Jn];class Bo{amount;constructor(e){this.amount=e}getFedPositions(e,t,s){return Array(this.amount).fill({r:-1,c:-1})}}class Fo{getFedPositions(e,t,s){const i=[];return[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]].forEach(([o,a])=>{const l=e+o,c=t+a;l>=0&&l<4&&c>=0&&c<4&&i.push({r:l,c})}),i}}class Wo{getFedPositions(e,t,s){const o=new Set,a=[],l=(c,h)=>{const u=s[c][h];return u===Z.COTTAGE||u===Z.BARRETT_CASTLE};for(let c=0;c<4;c++)for(let h=0;h<4;h++){const u=`${c},${h}`;if(o.has(u)||!l(c,h))continue;const d=[],p=[{r:c,c:h}];for(o.add(u);p.length>0;){const m=p.pop();d.push(m);const _=[[-1,0],[1,0],[0,-1],[0,1]];for(const[C,N]of _){const E=m.r+C,I=m.c+N,O=`${E},${I}`;E>=0&&E<4&&I>=0&&I<4&&!o.has(O)&&l(E,I)&&(o.add(O),p.push({r:E,c:I}))}}a.push(d)}return a.length===0?[]:(a.sort((c,h)=>h.length-c.length),a[0])}}class Go{getFedPositions(e,t,s){const i=[];for(let r=0;r<4;r++)r!==t&&i.push({r:e,c:r});for(let r=0;r<4;r++)r!==e&&i.push({r,c:t});return i}}const Uo={name:"Farm",type:"RED",pattern:[[f.WHEAT,f.WHEAT],[f.WOOD,f.WOOD]],feeder:new Bo(4),description:"Feeds 4 cottages anywhere on the board."},Ho={name:"Granary",type:"RED",pattern:[[f.WHEAT,f.WHEAT],[f.WOOD,f.BRICK]],feeder:new Fo,description:"Feeds all buildings in the 8 squares surrounding it."},$o={name:"Greenhouse",type:"RED",pattern:[[f.WHEAT,f.GLASS],[f.WOOD,f.WOOD]],feeder:new Wo,description:"Feeds one contiguous group of Cottages."},Vo={name:"Orchard",type:"RED",description:"Feeds Cottages in the same row and column.",pattern:[[f.STONE,f.WHEAT],[f.WHEAT,f.WOOD]],feeder:new Go},Mi=[Uo,Ho,$o,Vo],Ko={name:"Well",type:"GRAY",pattern:[[f.WOOD,f.STONE]],description:"1 point for each adjacent cottage.",scorer:new Eo([Z.COTTAGE,Z.BARRETT_CASTLE],1)},Yo={name:"Fountain",type:"GRAY",description:"2 points if adjacent to a Cottage.",pattern:[[f.WOOD,f.STONE]],scorer:new No([Z.COTTAGE,Z.BARRETT_CASTLE],2)},jo={name:"Millstone",type:"GRAY",description:"2 points if adjacent to a Red or Yellow building.",pattern:[[f.WOOD,f.STONE]],scorer:new Di(["RED","YELLOW"],2)},qo={name:"Shed",type:"GRAY",description:"Worth 1 point. Can be placed anywhere.",pattern:[[f.WOOD,f.STONE]],scorer:new ae(1)},Li=[Ko,Yo,jo,qo],zo={name:"Almshouse",type:"GREEN",pattern:[[f.STONE,f.STONE,f.GLASS]],description:"Score increasing points for each Almshouse you have built.",scorer:new Ao},Qo={name:"Inn",type:"GREEN",pattern:[[f.WHEAT,f.STONE,f.GLASS]],description:"Get 3 points if not in a row or column with another Inn.",scorer:new ko},Xo={name:"Feast Hall",type:"GREEN",pattern:[[f.WOOD,f.WOOD,f.GLASS]],description:"Get 2 points, and an extra 1 if you have more Feast Halls than the player on your right.",scorer:new ae(2)},Jo={name:"Tavern",type:"GREEN",pattern:[[f.BRICK,f.BRICK,f.GLASS]],description:"Score increasing points for each Tavern you have built."},Pi=[Jo,Qo,zo,Xo],Zo={name:"Theater",type:"YELLOW",pattern:[[f.NONE,f.STONE,f.NONE],[f.WOOD,f.GLASS,f.WOOD]],scorer:new Co,description:"1 point for each unique building type in the same row and column."},ea={name:"Bakery",type:"YELLOW",description:"3 points if adjacent to a Food (Red) building.",pattern:[[f.NONE,f.WHEAT,f.NONE],[f.BRICK,f.GLASS,f.BRICK]],scorer:new Di(["RED"],3)},ta={name:"Market",type:"YELLOW",description:"1 point for each other Market in the same row or column.",pattern:[[f.NONE,f.WOOD,f.NONE],[f.STONE,f.GLASS,f.STONE]],scorer:new Ro},na={name:"Tailor",type:"YELLOW",description:"1 point. +1 point for each other Tailor in the 4 center squares.",pattern:[[f.NONE,f.WHEAT,f.NONE],[f.STONE,f.GLASS,f.STONE]],scorer:new Oo},xi=[Zo,ea,ta,na];class sa{type="FACTORY";description="Stores a resource. Allows swapping that resource when chosen by others.";canSwap(e,t){return e===t}}class ia{type="BANK";description="Stores a resource. You cannot choose this resource as Master Builder."}class ra{type="WAREHOUSE";description="Stores up to 3 resources. You can Swap the current resource with one in storage. -1 point for each resource left at the end.";capacity=3}class oa{type="STATUE_BONDMAKER";description="When another player names a resource, you may place it on a square with a Cottage."}class aa{type="GROVE_UNIVERSITY";description="Immediately place a building on an empty square in your town."}class la{type="FORT_IRONWEED";description="Unless you are the last player in the game, you can no longer take turns as the Master Builder."}const ca={name:"Factory",type:"BLACK",pattern:[[f.WOOD,f.NONE,f.NONE,f.NONE],[f.BRICK,f.STONE,f.STONE,f.BRICK]],description:"Place 1 resource on the factory, whenever another player chooses that resource, play a different one instead.",effect:new sa},ua={name:"Trading Post",type:"BLACK",description:"1 point. Counts as a WILD (any) resource for future buildings.",pattern:[[f.STONE,f.WOOD,f.NONE],[f.STONE,f.WOOD,f.BRICK]],scorer:new ae(1)},da={name:"Bank",type:"BLACK",description:"4 points. Place a resource on this building - you can no longer select this resource as master builder.",pattern:[[f.WHEAT,f.WHEAT,f.NONE],[f.WOOD,f.GLASS,f.BRICK]],scorer:new ae(4),effect:new ia},ha={name:"Warehouse",type:"BLACK",description:"-1 for each resource on this building. When another player chooses a resource, you may place that resource on the warehouse, or swap it with a resource already stored here. It can store 3 resources.",pattern:[[f.WHEAT,f.WOOD,f.WHEAT],[f.BRICK,f.NONE,f.BRICK]],effect:new ra},Bi=[ca,ua,da,ha],fa={name:"Chapel",type:"ORANGE",pattern:[[f.NONE,f.NONE,f.GLASS],[f.STONE,f.GLASS,f.STONE]],description:"Scores 1 point for each fed cottage.",scorer:new Do},pa={name:"Abbey",type:"ORANGE",pattern:[[f.NONE,f.NONE,f.GLASS],[f.BRICK,f.STONE,f.STONE]],description:"3 points if not adjacent to a black, green or yellow building.",scorer:new Po(["BLACK","GREEN","YELLOW"],3)},ma={name:"Cloister",type:"ORANGE",pattern:[[f.NONE,f.NONE,f.GLASS],[f.WOOD,f.BRICK,f.STONE]],description:"Scores 1 point for each cloister in a corner of your town.",scorer:new Lo("CLOISTER")},ga={name:"Temple",type:"ORANGE",pattern:[[f.NONE,f.NONE,f.GLASS],[f.BRICK,f.BRICK,f.STONE]],description:"4 points if adjacent to 2 or more fed cottages.",scorer:new Mo(2,4)},Fi=[fa,pa,ma,ga],_a={name:"Archive of the Second Age",type:"PURPLE",pattern:[[f.WHEAT,f.WHEAT],[f.BRICK,f.GLASS]],scorer:new vo,isMonument:!0,description:"Scores 1 point for each unique building type on the board."},ya={name:"Barrett Castle",type:"PURPLE",pattern:[[f.WHEAT,f.NONE,f.NONE,f.STONE],[f.WOOD,f.GLASS,f.GLASS,f.BRICK]],scorer:new ae(5,!0),feedCost:1,countsAs:[Z.COTTAGE],isMonument:!0,description:"Scores 5 points if fed. Counts as 2 cottages."},Ea={name:"Obelisk of the Crescent",type:"PURPLE",pattern:[[f.WHEAT,f.NONE,f.NONE],[f.BRICK,f.GLASS,f.BRICK]],isMonument:!0,description:"You may place all future buildings on any empty square in your town."},Ca={name:"Mandras Palace",type:"PURPLE",pattern:[[f.WHEAT,f.GLASS],[f.BRICK,f.WOOD]],scorer:new So(2),isMonument:!0,description:"Scores 2 points for each unique adjacent building type."},va={name:"Shrine of the Elder Tree",type:"PURPLE",pattern:[[f.BRICK,f.WHEAT,f.STONE],[f.WOOD,f.GLASS,f.WOOD]],isMonument:!0,scorer:new bo,description:"Gain points based on the number of buildings in your town when constructed."},Sa={name:"The Sky Baths",type:"PURPLE",pattern:[[f.NONE,f.WHEAT,f.NONE],[f.STONE,f.GLASS,f.WOOD],[f.BRICK,f.NONE,f.BRICK]],isMonument:!0,scorer:new wo,description:"Scores 2 points for each building type your town is missing."},ba={name:"Silva Forum",type:"PURPLE",pattern:[[f.NONE,f.NONE,f.WHEAT,f.NONE],[f.BRICK,f.BRICK,f.STONE,f.WOOD]],isMonument:!0,scorer:new Io,description:"Gain 1 point, plus 1 for each building in the largest contiguous group of buildings of the same type in your town."},wa={name:"Grand Mausoleum of the Rodina",type:"PURPLE",pattern:[[f.WOOD,f.WOOD],[f.BRICK,f.STONE]],isMonument:!0,scorer:new To,description:"Your unfed cottages are worth 3 points each."},Ia={name:"Cathedral of Caterina",type:"PURPLE",pattern:[[f.NONE,f.WHEAT],[f.STONE,f.GLASS]],isMonument:!0,scorer:new ae(2,!1),description:"2 points. Empty squares in your town are worth 0 points (instead of -1)."},Ta={name:"Statue of the Bondmaker",type:"PURPLE",pattern:[[f.WOOD,f.STONE,f.STONE,f.GLASS],[f.WHEAT,f.NONE,f.NONE,f.NONE]],isMonument:!0,description:"When another player names a resource, you may choose to place it on a square with a cottage. Each of your cottages can hold 1 resource.",effect:new oa},Na={name:"Architect's Guild",type:"PURPLE",pattern:[[f.NONE,f.NONE,f.GLASS],[f.NONE,f.WHEAT,f.STONE],[f.WOOD,f.BRICK,f.NONE]],isMonument:!0,scorer:new ae(1,!1),description:"1 point. When constructed, replace up to 2 buildings in your town with any other building types."},Ra={name:"Grove University",type:"PURPLE",pattern:[[f.NONE,f.BRICK,f.NONE],[f.STONE,f.GLASS,f.STONE]],isMonument:!0,scorer:new ae(3,!1),description:"3 points. Immediately place a building on an empty square in your town.",effect:new aa},Oa={name:"Opaleye's Watch",type:"PURPLE",pattern:[[f.WOOD,f.NONE,f.NONE,f.NONE],[f.BRICK,f.GLASS,f.WHEAT,f.WHEAT],[f.STONE,f.NONE,f.NONE,f.NONE]],isMonument:!0,description:"Immediately place 3 unique buildings on this card. Whenever a player on the left or right of you constructs 1 of those buildings, take the building from here and place it on an empty square in your town."},Aa={name:"Fort Ironweed",type:"PURPLE",pattern:[[f.WHEAT,f.NONE,f.BRICK],[f.STONE,f.WOOD,f.STONE]],isMonument:!0,scorer:new ae(7,!1),description:"7 points. Unless you are the last player in the game you can no longer take turns as the master builder.",effect:new la},ka={name:"The Starloom",type:"PURPLE",pattern:[[f.GLASS,f.GLASS],[f.WOOD,f.WHEAT]],isMonument:!0,description:"Gain points based on how early you complete your town."},He=[_a,Aa,ya,Ea,Ta,Na,Ra,Oa,Ca,va,Sa,ba,wa,Ia,ka],at=[...xo,...Mi,...Li,...Pi,...xi,...Bi,...Fi,...He];class Ps{grid;size=4;metadata=new Map;constructor(){this.grid=Array(this.size).fill(null).map(()=>Array(this.size).fill(f.NONE))}place(e,t,s){if(!this.isValid(e,t))throw new Error(`Invalid coordinate: ${e}, ${t}`);if(this.grid[e][t]!==f.NONE)throw new Error("Spot already occupied");this.grid[e][t]=s}placeBuilding(e,t,s){this.isValid(e,t)&&(this.grid[e][t]=s)}constructBuilding(e,t,s,i){if(!e.some(o=>o.row===t&&o.col===s)&&this.grid[t][s]!=="NONE")throw new Error("Building must be placed on one of the pattern squares.");this.clear(e),this.grid[t][s]=i}clear(e){e.forEach(({row:t,col:s})=>{this.isValid(t,s)&&(this.grid[t][s]=f.NONE,this.metadata.delete(`${t},${s}`))})}getGrid(){return this.grid.map(e=>[...e])}isValid(e,t){return e>=0&&e<this.size&&t>=0&&t<this.size}remove(e,t){this.isValid(e,t)&&(this.grid[e][t]="NONE",this.metadata.delete(`${e},${t}`))}setMetadata(e,t,s){this.metadata.set(`${e},${t}`,s)}getMetadata(e,t){return this.metadata.get(`${e},${t}`)}}class Da{static rotate(e){return e[0].map((t,s)=>e.map(i=>i[s]).reverse())}static flip(e){return e.map(t=>[...t].reverse())}static getSymmetries(e){const t=new Set;let s=e;for(let i=0;i<4;i++)t.add(JSON.stringify(s)),t.add(JSON.stringify(this.flip(s))),s=this.rotate(s);return Array.from(t).map(i=>JSON.parse(i))}static findMatches(e,t,s){const i=this.getSymmetries(t.pattern),r=[];for(const o of i){const a=o.length,l=o[0].length;for(let c=0;c<=4-a;c++)for(let h=0;h<=4-l;h++)this.isMatch(e,o,c,h,s)&&r.push({row:c,col:h,pattern:o})}return r}static isMatch(e,t,s,i,r){return t.every((o,a)=>o.every((l,c)=>{const h=s+a,u=i+c,d=e[h][u];if(l==="NONE"||d===l||d&&d.toUpperCase().replace("_"," ")==="TRADING POST")return!0;if(r){const p=`${h},${u}`,m=r instanceof Map?r.get(p):r[p];if(m&&m.storedResource===l)return!0}return!1}))}}class Ma{static calculateScore(e,t,s){const o={},a=E=>s.find(I=>I.name.toUpperCase()===E.toUpperCase()),l={};let c=0,h=0;const u=new Set;for(let E=0;E<4;E++)for(let I=0;I<4;I++){const O=e[E][I];if(!this.isBuilding(O)){c++;continue}l[O]=(l[O]||0)+1;const z=a(O);if(z&&z.feeder){const J=z.feeder.getFedPositions(E,I,e);J.length>0&&J[0].r===-1?h+=J.length:J.forEach(Q=>u.add(`${Q.r},${Q.c}`))}}const d=new Set;let p=0;for(let E=0;E<4;E++)for(let I=0;I<4;I++){const O=e[E][I];if(!this.isBuilding(O))continue;const z=a(O);if(z&&z.feedCost){const J=`${E},${I}`;let Q=!1;u.has(J)?Q=!0:h>=z.feedCost&&(h-=z.feedCost,Q=!0),Q&&(d.add(J),O===Z.COTTAGE&&p++,O===Z.BARRETT_CASTLE&&(p+=2))}}const m=s.map(E=>E.name);for(let E=0;E<4;E++)for(let I=0;I<4;I++){const O=e[E][I];if(!this.isBuilding(O))continue;const z=a(O);if(z){if(z.scorer){const J={grid:e,row:E,col:I,counts:l,fedState:d.has(`${E},${I}`),metadata:t,validBuildingNames:m,allFedPositions:d,registry:s,fedCottageCount:p},Q=z.scorer.score(J);o[O]=(o[O]||0)+Q}if(O.toUpperCase()==="WAREHOUSE"){const J=`${E},${I}`,Q=t instanceof Map?t.get(J):t[J];if(Q&&Q.storedResources&&Array.isArray(Q.storedResources)){const yo=Q.storedResources.length;o[O]=(o[O]||0)-yo}}}}if(l[Z.TAVERN]){const E=[0,2,5,9,14,20],I=Math.min(l[Z.TAVERN],5);o[Z.TAVERN]=E[I]}let _=0;Object.values(o).forEach(E=>_+=E);const N=(l.CATHEDRAL||0)>0?0:c;return{total:_-N,breakdown:o,penaltyCount:N}}static isBuilding(e){return!["NONE","WOOD","WHEAT","BRICK","GLASS","STONE"].includes(e)}}class La{board;currentResource=null;availableMatches=[];activeMonument=null;gameRegistry=[];lastMove=null;constructor(){this.board=new Ps}setMonument(e,t){this.activeMonument=e,this.gameRegistry=[...t,this.activeMonument],this.scanForMatches()}start(){if(this.board=new Ps,this.currentResource=null,this.lastMove=null,this.availableMatches=[],this.gameRegistry.length===0){const e=at.filter(s=>s.isMonument),t=at.filter(s=>!s.isMonument);this.activeMonument=e[Math.floor(Math.random()*e.length)],this.gameRegistry=[...t,this.activeMonument]}}placeResource(e,t){if(!this.currentResource)throw new Error("No resource selected");const i=this.board.getGrid()[e][t];if(i==="NONE")this.board.place(e,t,this.currentResource);else if(i==="COTTAGE"&&this.hasStatueOfBondmaker()){const r=this.board.getMetadata(e,t);if(r&&r.storedResource)throw new Error("This Cottage is already holding a resource!");this.board.setMetadata(e,t,{...r,storedResource:this.currentResource})}else throw new Error("Cannot place resource here.");this.lastMove={r:e,c:t},this.currentResource=null,this.scanForMatches()}constructBuilding(e,t,s){const i=[];let r=0,o=!1;if(e.pattern.forEach((l,c)=>{l.forEach((h,u)=>{h&&h!=="NONE"&&i.push({row:e.row+c,col:e.col+u})})}),e.buildingName.toUpperCase()==="SHRINE OF THE ELDER TREE"){o=!0;const c=this.countBuildingsOnBoard()+1;c<6?r=c:r=8}i.forEach(l=>{const c=this.board.getGrid()[l.row][l.col],h=c&&c.toUpperCase().replace("_"," ")==="TRADING POST",u=this.board.getMetadata(l.row,l.col);u&&u.storedResource?this.board.setMetadata(l.row,l.col,{...u,storedResource:null}):h||this.board.remove(l.row,l.col)}),this.board.placeBuilding(t,s,e.buildingName),o&&this.board.setMetadata(t,s,{savedScore:r}),this.lastMove=null,this.scanForMatches();const a=at.find(l=>l.name.toUpperCase()===e.buildingName.toUpperCase());return a&&a.effect?{type:"TRIGGER_EFFECT",effectType:a.effect.type}:{type:"SUCCESS"}}undo(){this.lastMove&&(this.board.remove(this.lastMove.r,this.lastMove.c),this.lastMove=null,this.scanForMatches())}canUndo(){return this.lastMove!==null}scanForMatches(){this.availableMatches=[];const e=this.board.getGrid(),t=e.some(s=>s.some(i=>this.gameRegistry.find(o=>o.name.toUpperCase()===i.toUpperCase())?.isMonument));for(const s of this.gameRegistry){if(t&&s.isMonument)continue;Da.findMatches(e,s,this.board.metadata).forEach(r=>{this.availableMatches.push({...r,buildingName:s.name.toUpperCase()})})}}checkGameOver(){const t=this.board.getGrid().some(i=>i.some(r=>r==="NONE")),s=this.availableMatches.length>0;return!t&&!s}getScore(){return Ma.calculateScore(this.board.getGrid(),this.board.metadata,this.gameRegistry)}countBuildingsOnBoard(){const e=this.board.getGrid();let t=0;const s=["WOOD","WHEAT","BRICK","GLASS","STONE","NONE"];return e.forEach(i=>{i.forEach(r=>{s.includes(r)||t++})}),t}hasObeliskAbility(){return this.board.getGrid().some(t=>t.some(s=>s.toUpperCase().includes("OBELISK")))}findEffectBuildings(e,t=!0){const s=this.board.getGrid(),i=[];return s.forEach((r,o)=>{r.forEach((a,l)=>{if(["WOOD","WHEAT","BRICK","GLASS","STONE","NONE"].includes(a))return;const c=this.gameRegistry.find(h=>h.name.toUpperCase()===a.toUpperCase());if(c&&c.effect&&c.effect.type===e){const h=this.board.getMetadata(o,l),u=h?h.storedResource:null;t?u&&i.push({r:o,c:l,storedRes:u}):i.push({r:o,c:l,storedRes:u})}})}),i}setBuildingStorage(e,t,s){this.board.setMetadata(e,t,{storedResource:s})}canFactorySwap(e){const s=this.findEffectBuildings("FACTORY").find(i=>i.storedRes===e);return s?{r:s.r,c:s.c}:null}getForbiddenResources(){return this.findEffectBuildings("BANK").map(t=>t.storedRes).filter(t=>t!==null)}storeInWarehouse(e,t,s){const i=this.board.getMetadata(e,t)||{},r=i.storedResources||[];return r.length>=3?!1:(r.push(s),this.board.setMetadata(e,t,{...i,storedResources:r}),!0)}swapInWarehouse(e,t,s,i){const r=this.board.getMetadata(e,t);if(!r||!r.storedResources)return null;const o=[...r.storedResources];if(s<0||s>=o.length)return null;const a=o[s];return o[s]=i,this.board.setMetadata(e,t,{...r,storedResources:o}),a}getWarehouseContents(e,t){return this.board.getMetadata(e,t)?.storedResources||[]}hasStatueOfBondmaker(){const e=this.findEffectBuildings("STATUE_BONDMAKER",!1);return console.log(`Checking for Bondmaker. Found: ${e.length}`,e),e.length>0}placeFreeBuilding(e,t,s){if(this.board.getGrid()[e][t]!=="NONE")throw new Error("Target square must be empty!");this.board.placeBuilding(e,t,s),this.scanForMatches()}}class Pa{boardEl=document.getElementById("board");buildMenuEl=document.getElementById("build-menu");msgLabel=document.getElementById("message");paletteEl=document.getElementById("resource-palette");scoreEl=document.getElementById("score-display");undoBtn=document.getElementById("undo-btn");deckDisplayEl=document.getElementById("deck-display");factoryBar=document.getElementById("factory-action-bar");swapBtn=document.getElementById("factory-swap-btn");swapResLabel=document.getElementById("swap-res-name");onCellClick=()=>{};onResourceSelect=()=>{};onBuildClick=()=>{};onCancelClick=()=>{};onSwapClick=()=>{};constructor(){this.swapBtn.onclick=()=>this.onSwapClick()}render(e,t,s,i,r=[]){this.renderHeader(e),this.renderBoard(e,t,s,i),this.renderSidebar(e,t),this.renderControls(e,t,r)}renderHeader(e){const t=e.getScore(),s=t.total+t.penaltyCount;this.scoreEl.innerHTML=`Score: ${s} <span style="font-size:12px; color:#999">(-${t.penaltyCount} empty)</span>`}renderBoard(e,t,s,i){const r=e.board.getGrid(),o=["WOOD","WHEAT","BRICK","GLASS","STONE"];this.boardEl.children.length===0&&r.forEach((l,c)=>{l.forEach((h,u)=>{const d=document.createElement("div");d.dataset.r=c.toString(),d.dataset.c=u.toString(),d.onclick=()=>this.onCellClick(c,u),this.boardEl.appendChild(d)})}),Array.from(this.boardEl.children).forEach(l=>{const c=parseInt(l.dataset.r),h=parseInt(l.dataset.c),u=r[c][h];if(l.className="cell",l.style.backgroundColor="",l.innerHTML="",u==="NONE")l.classList.add("empty");else if(o.includes(u))l.classList.add(u),l.textContent=u;else{const p=e.gameRegistry.find(m=>m.name.toUpperCase()===u.toUpperCase());if(p){if(l.classList.add("constructed"),p.isMonument)l.classList.add("MONUMENT");else{const m=u.replace(/ /g,"-").replace(/'/g,"").toUpperCase();l.classList.add(m)}p.color&&(l.style.backgroundColor=p.color)}}const d=e.board.getMetadata(c,h);if(d&&d.storedResource){const p=document.createElement("div");p.className=`stored-resource-icon ${d.storedResource}`,p.title=`Stored: ${d.storedResource}`,l.appendChild(p)}if(d&&d.storedResources&&Array.isArray(d.storedResources)){const p=document.createElement("div");p.className="warehouse-storage",d.storedResources.forEach(m=>{const _=document.createElement("div");_.className=`mini-resource ${m}`,p.appendChild(_)}),l.appendChild(p)}if(e.currentResource&&!t&&u.toUpperCase()==="WAREHOUSE"&&(l.classList.add("interactive-building"),l.title="Click to Store or Swap"),t){const p=s.some(E=>E.row===c&&E.col===h),m=e.hasObeliskAbility(),_=t.buildingName.toUpperCase()==="SHED",C=(m||_)&&u==="NONE",N=u&&u.toUpperCase().replace("_"," ")==="TRADING POST";(p&&!N||C)&&l.classList.add("match-highlight")}u==="NONE"&&e.currentResource&&!t?(l.onmouseenter=()=>{l.classList.add("ghost",e.currentResource)},l.onmouseleave=()=>{l.classList.remove("ghost","WOOD","WHEAT","BRICK","GLASS","STONE")}):(l.onmouseenter=null,l.onmouseleave=null)}),t?(this.msgLabel.textContent=`Select a highlighted square to build your ${t.buildingName}!`,this.msgLabel.style.color="#d32f2f"):i?(this.msgLabel.textContent=i,i.includes("Waiting")?this.msgLabel.style.color="#d32f2f":i.includes("YOU")?this.msgLabel.style.color="#2e7d32":this.msgLabel.style.color="#333"):e.availableMatches.length>0?(this.msgLabel.textContent="Matches available!",this.msgLabel.style.color="#333"):e.currentResource?(this.msgLabel.textContent=`Place ${e.currentResource}...`,this.msgLabel.style.color="#333"):(this.msgLabel.textContent="Select a Resource...",this.msgLabel.style.color="#1976d2")}renderSidebar(e,t){if(this.buildMenuEl.innerHTML="",e.availableMatches.length===0){const s=document.createElement("p");s.textContent="No patterns found.",s.style.color="#777",s.style.fontStyle="italic",this.buildMenuEl.appendChild(s)}else e.availableMatches.forEach(s=>{const i=document.createElement("button");i.textContent=`Build ${s.buildingName}`;const r=s.buildingName.replace(/ /g,"-").replace(/'/g,"").toUpperCase();i.className=`build-btn ${r}`,i.onclick=()=>this.onBuildClick(s);const o=[];s.pattern&&Array.isArray(s.pattern)?s.pattern.forEach((a,l)=>{a.forEach((c,h)=>{c&&c!=="NONE"&&o.push({row:s.row+l,col:s.col+h})})}):o.push({row:s.row,col:s.col}),i.onmouseenter=()=>this.togglePreview(o,!0),i.onmouseleave=()=>this.togglePreview(o,!1),this.buildMenuEl.appendChild(i)});if(t){const s=document.createElement("button");s.textContent="Cancel Construction",s.className="secondary-btn",s.style.marginTop="10px",s.style.width="100%",s.onclick=()=>this.onCancelClick(),this.buildMenuEl.appendChild(s)}}togglePreview(e,t){e.forEach(s=>{const i=`div[data-r="${s.row}"][data-c="${s.col}"]`,r=this.boardEl.querySelector(i);r&&(t?r.classList.add("preview-target"):r.classList.remove("preview-target"))})}renderControls(e,t,s){this.paletteEl.innerHTML="",[f.WOOD,f.WHEAT,f.BRICK,f.GLASS,f.STONE].forEach(r=>{const o=document.createElement("div");let a=`res-btn ${r}`;e.currentResource===r&&!t&&(a+=" selected"),s.includes(r)&&(a+=" disabled",o.title="Blocked by bank"),o.className=a,o.textContent=r.charAt(0),s.includes(r)||(o.onclick=()=>this.onResourceSelect(r)),this.paletteEl.appendChild(o)}),e.canUndo()&&!t?this.undoBtn.removeAttribute("disabled"):this.undoBtn.setAttribute("disabled","true")}renderDeck(e){this.deckDisplayEl&&(this.deckDisplayEl.innerHTML="",e.forEach(t=>{const s=document.createElement("div");t.isMonument?s.className="building-card MONUMENT":s.className=`building-card ${t.name.toUpperCase()}`;const i=document.createElement("header");i.className="card-header";const r=document.createElement("span");r.textContent=t.name;const o=document.createElement("div"),a=t.name.replace(/ /g,"-").replace(/'/g,"").toUpperCase();o.className=`card-icon ${a}`,i.appendChild(r),i.appendChild(o),s.appendChild(i);const l=document.createElement("div");l.className="card-body";const c=document.createElement("div");c.className="mini-pattern";const h=t.pattern[0].length;c.style.gridTemplateColumns=`repeat(${h}, 15px)`,t.pattern.forEach(d=>{d.forEach(p=>{const m=document.createElement("div"),_=p==="NONE"?"pattern-empty":p;m.className=`pattern-cell ${_}`,c.appendChild(m)})});const u=document.createElement("div");u.className="card-text",u.textContent=t.description||"Unique scoring rules.",l.appendChild(c),l.appendChild(u),s.appendChild(l),this.deckDisplayEl.appendChild(s)}))}toggleFactoryAction(e,t=""){e?(this.factoryBar.classList.remove("hidden"),this.swapResLabel.textContent=t):this.factoryBar.classList.add("hidden")}}const xa=()=>{};var xs={};const Wi={NODE_ADMIN:!1,SDK_VERSION:"${JSCORE_VERSION}"};const g=function(n,e){if(!n)throw Xe(e)},Xe=function(n){return new Error("Firebase Database ("+Wi.SDK_VERSION+") INTERNAL ASSERT FAILED: "+n)};const Gi=function(n){const e=[];let t=0;for(let s=0;s<n.length;s++){let i=n.charCodeAt(s);i<128?e[t++]=i:i<2048?(e[t++]=i>>6|192,e[t++]=i&63|128):(i&64512)===55296&&s+1<n.length&&(n.charCodeAt(s+1)&64512)===56320?(i=65536+((i&1023)<<10)+(n.charCodeAt(++s)&1023),e[t++]=i>>18|240,e[t++]=i>>12&63|128,e[t++]=i>>6&63|128,e[t++]=i&63|128):(e[t++]=i>>12|224,e[t++]=i>>6&63|128,e[t++]=i&63|128)}return e},Ba=function(n){const e=[];let t=0,s=0;for(;t<n.length;){const i=n[t++];if(i<128)e[s++]=String.fromCharCode(i);else if(i>191&&i<224){const r=n[t++];e[s++]=String.fromCharCode((i&31)<<6|r&63)}else if(i>239&&i<365){const r=n[t++],o=n[t++],a=n[t++],l=((i&7)<<18|(r&63)<<12|(o&63)<<6|a&63)-65536;e[s++]=String.fromCharCode(55296+(l>>10)),e[s++]=String.fromCharCode(56320+(l&1023))}else{const r=n[t++],o=n[t++];e[s++]=String.fromCharCode((i&15)<<12|(r&63)<<6|o&63)}}return e.join("")},Zn={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:typeof atob=="function",encodeByteArray(n,e){if(!Array.isArray(n))throw Error("encodeByteArray takes an array as a parameter");this.init_();const t=e?this.byteToCharMapWebSafe_:this.byteToCharMap_,s=[];for(let i=0;i<n.length;i+=3){const r=n[i],o=i+1<n.length,a=o?n[i+1]:0,l=i+2<n.length,c=l?n[i+2]:0,h=r>>2,u=(r&3)<<4|a>>4;let d=(a&15)<<2|c>>6,p=c&63;l||(p=64,o||(d=64)),s.push(t[h],t[u],t[d],t[p])}return s.join("")},encodeString(n,e){return this.HAS_NATIVE_SUPPORT&&!e?btoa(n):this.encodeByteArray(Gi(n),e)},decodeString(n,e){return this.HAS_NATIVE_SUPPORT&&!e?atob(n):Ba(this.decodeStringToByteArray(n,e))},decodeStringToByteArray(n,e){this.init_();const t=e?this.charToByteMapWebSafe_:this.charToByteMap_,s=[];for(let i=0;i<n.length;){const r=t[n.charAt(i++)],a=i<n.length?t[n.charAt(i)]:0;++i;const c=i<n.length?t[n.charAt(i)]:64;++i;const u=i<n.length?t[n.charAt(i)]:64;if(++i,r==null||a==null||c==null||u==null)throw new Fa;const d=r<<2|a>>4;if(s.push(d),c!==64){const p=a<<4&240|c>>2;if(s.push(p),u!==64){const m=c<<6&192|u;s.push(m)}}}return s},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let n=0;n<this.ENCODED_VALS.length;n++)this.byteToCharMap_[n]=this.ENCODED_VALS.charAt(n),this.charToByteMap_[this.byteToCharMap_[n]]=n,this.byteToCharMapWebSafe_[n]=this.ENCODED_VALS_WEBSAFE.charAt(n),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[n]]=n,n>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(n)]=n,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(n)]=n)}}};class Fa extends Error{constructor(){super(...arguments),this.name="DecodeBase64StringError"}}const Ui=function(n){const e=Gi(n);return Zn.encodeByteArray(e,!0)},xt=function(n){return Ui(n).replace(/\./g,"")},An=function(n){try{return Zn.decodeString(n,!0)}catch(e){console.error("base64Decode failed: ",e)}return null};function Wa(n){return Hi(void 0,n)}function Hi(n,e){if(!(e instanceof Object))return e;switch(e.constructor){case Date:const t=e;return new Date(t.getTime());case Object:n===void 0&&(n={});break;case Array:n=[];break;default:return e}for(const t in e)!e.hasOwnProperty(t)||!Ga(t)||(n[t]=Hi(n[t],e[t]));return n}function Ga(n){return n!=="__proto__"}function Ua(){if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global;throw new Error("Unable to locate global object.")}const Ha=()=>Ua().__FIREBASE_DEFAULTS__,$a=()=>{if(typeof process>"u"||typeof xs>"u")return;const n=xs.__FIREBASE_DEFAULTS__;if(n)return JSON.parse(n)},Va=()=>{if(typeof document>"u")return;let n;try{n=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch{return}const e=n&&An(n[1]);return e&&JSON.parse(e)},$i=()=>{try{return xa()||Ha()||$a()||Va()}catch(n){console.info(`Unable to get __FIREBASE_DEFAULTS__ due to: ${n}`);return}},Ka=n=>$i()?.emulatorHosts?.[n],Ya=n=>{const e=Ka(n);if(!e)return;const t=e.lastIndexOf(":");if(t<=0||t+1===e.length)throw new Error(`Invalid host ${e} with no separate hostname and port!`);const s=parseInt(e.substring(t+1),10);return e[0]==="["?[e.substring(1,t-1),s]:[e.substring(0,t),s]},Vi=()=>$i()?.config;class re{constructor(){this.reject=()=>{},this.resolve=()=>{},this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}wrapCallback(e){return(t,s)=>{t?this.reject(t):this.resolve(s),typeof e=="function"&&(this.promise.catch(()=>{}),e.length===1?e(t):e(t,s))}}}function es(n){try{return(n.startsWith("http://")||n.startsWith("https://")?new URL(n).hostname:n).endsWith(".cloudworkstations.dev")}catch{return!1}}async function ja(n){return(await fetch(n,{credentials:"include"})).ok}function qa(n,e){if(n.uid)throw new Error('The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.');const t={alg:"none",type:"JWT"},s=e||"demo-project",i=n.iat||0,r=n.sub||n.user_id;if(!r)throw new Error("mockUserToken must contain 'sub' or 'user_id' field!");const o={iss:`https://securetoken.google.com/${s}`,aud:s,iat:i,exp:i+3600,auth_time:i,sub:r,user_id:r,firebase:{sign_in_provider:"custom",identities:{}},...n};return[xt(JSON.stringify(t)),xt(JSON.stringify(o)),""].join(".")}const lt={};function za(){const n={prod:[],emulator:[]};for(const e of Object.keys(lt))lt[e]?n.emulator.push(e):n.prod.push(e);return n}function Qa(n){let e=document.getElementById(n),t=!1;return e||(e=document.createElement("div"),e.setAttribute("id",n),t=!0),{created:t,element:e}}let Bs=!1;function Xa(n,e){if(typeof window>"u"||typeof document>"u"||!es(window.location.host)||lt[n]===e||lt[n]||Bs)return;lt[n]=e;function t(d){return`__firebase__banner__${d}`}const s="__firebase__banner",r=za().prod.length>0;function o(){const d=document.getElementById(s);d&&d.remove()}function a(d){d.style.display="flex",d.style.background="#7faaf0",d.style.position="fixed",d.style.bottom="5px",d.style.left="5px",d.style.padding=".5em",d.style.borderRadius="5px",d.style.alignItems="center"}function l(d,p){d.setAttribute("width","24"),d.setAttribute("id",p),d.setAttribute("height","24"),d.setAttribute("viewBox","0 0 24 24"),d.setAttribute("fill","none"),d.style.marginLeft="-6px"}function c(){const d=document.createElement("span");return d.style.cursor="pointer",d.style.marginLeft="16px",d.style.fontSize="24px",d.innerHTML=" &times;",d.onclick=()=>{Bs=!0,o()},d}function h(d,p){d.setAttribute("id",p),d.innerText="Learn more",d.href="https://firebase.google.com/docs/studio/preview-apps#preview-backend",d.setAttribute("target","__blank"),d.style.paddingLeft="5px",d.style.textDecoration="underline"}function u(){const d=Qa(s),p=t("text"),m=document.getElementById(p)||document.createElement("span"),_=t("learnmore"),C=document.getElementById(_)||document.createElement("a"),N=t("preprendIcon"),E=document.getElementById(N)||document.createElementNS("http://www.w3.org/2000/svg","svg");if(d.created){const I=d.element;a(I),h(C,_);const O=c();l(E,N),I.append(E,m,C,O),document.body.appendChild(I)}r?(m.innerText="Preview backend disconnected.",E.innerHTML=`<g clip-path="url(#clip0_6013_33858)">
<path d="M4.8 17.6L12 5.6L19.2 17.6H4.8ZM6.91667 16.4H17.0833L12 7.93333L6.91667 16.4ZM12 15.6C12.1667 15.6 12.3056 15.5444 12.4167 15.4333C12.5389 15.3111 12.6 15.1667 12.6 15C12.6 14.8333 12.5389 14.6944 12.4167 14.5833C12.3056 14.4611 12.1667 14.4 12 14.4C11.8333 14.4 11.6889 14.4611 11.5667 14.5833C11.4556 14.6944 11.4 14.8333 11.4 15C11.4 15.1667 11.4556 15.3111 11.5667 15.4333C11.6889 15.5444 11.8333 15.6 12 15.6ZM11.4 13.6H12.6V10.4H11.4V13.6Z" fill="#212121"/>
</g>
<defs>
<clipPath id="clip0_6013_33858">
<rect width="24" height="24" fill="white"/>
</clipPath>
</defs>`):(E.innerHTML=`<g clip-path="url(#clip0_6083_34804)">
<path d="M11.4 15.2H12.6V11.2H11.4V15.2ZM12 10C12.1667 10 12.3056 9.94444 12.4167 9.83333C12.5389 9.71111 12.6 9.56667 12.6 9.4C12.6 9.23333 12.5389 9.09444 12.4167 8.98333C12.3056 8.86111 12.1667 8.8 12 8.8C11.8333 8.8 11.6889 8.86111 11.5667 8.98333C11.4556 9.09444 11.4 9.23333 11.4 9.4C11.4 9.56667 11.4556 9.71111 11.5667 9.83333C11.6889 9.94444 11.8333 10 12 10ZM12 18.4C11.1222 18.4 10.2944 18.2333 9.51667 17.9C8.73889 17.5667 8.05556 17.1111 7.46667 16.5333C6.88889 15.9444 6.43333 15.2611 6.1 14.4833C5.76667 13.7056 5.6 12.8778 5.6 12C5.6 11.1111 5.76667 10.2833 6.1 9.51667C6.43333 8.73889 6.88889 8.06111 7.46667 7.48333C8.05556 6.89444 8.73889 6.43333 9.51667 6.1C10.2944 5.76667 11.1222 5.6 12 5.6C12.8889 5.6 13.7167 5.76667 14.4833 6.1C15.2611 6.43333 15.9389 6.89444 16.5167 7.48333C17.1056 8.06111 17.5667 8.73889 17.9 9.51667C18.2333 10.2833 18.4 11.1111 18.4 12C18.4 12.8778 18.2333 13.7056 17.9 14.4833C17.5667 15.2611 17.1056 15.9444 16.5167 16.5333C15.9389 17.1111 15.2611 17.5667 14.4833 17.9C13.7167 18.2333 12.8889 18.4 12 18.4ZM12 17.2C13.4444 17.2 14.6722 16.6944 15.6833 15.6833C16.6944 14.6722 17.2 13.4444 17.2 12C17.2 10.5556 16.6944 9.32778 15.6833 8.31667C14.6722 7.30555 13.4444 6.8 12 6.8C10.5556 6.8 9.32778 7.30555 8.31667 8.31667C7.30556 9.32778 6.8 10.5556 6.8 12C6.8 13.4444 7.30556 14.6722 8.31667 15.6833C9.32778 16.6944 10.5556 17.2 12 17.2Z" fill="#212121"/>
</g>
<defs>
<clipPath id="clip0_6083_34804">
<rect width="24" height="24" fill="white"/>
</clipPath>
</defs>`,m.innerText="Preview backend running in this workspace."),m.setAttribute("id",p)}document.readyState==="loading"?window.addEventListener("DOMContentLoaded",u):u()}function Ja(){return typeof navigator<"u"&&typeof navigator.userAgent=="string"?navigator.userAgent:""}function Ki(){return typeof window<"u"&&!!(window.cordova||window.phonegap||window.PhoneGap)&&/ios|iphone|ipod|ipad|android|blackberry|iemobile/i.test(Ja())}function Za(){return typeof navigator=="object"&&navigator.product==="ReactNative"}function el(){return Wi.NODE_ADMIN===!0}function tl(){try{return typeof indexedDB=="object"}catch{return!1}}function nl(){return new Promise((n,e)=>{try{let t=!0;const s="validate-browser-context-for-indexeddb-analytics-module",i=self.indexedDB.open(s);i.onsuccess=()=>{i.result.close(),t||self.indexedDB.deleteDatabase(s),n(!0)},i.onupgradeneeded=()=>{t=!1},i.onerror=()=>{e(i.error?.message||"")}}catch(t){e(t)}})}const sl="FirebaseError";class Tt extends Error{constructor(e,t,s){super(t),this.code=e,this.customData=s,this.name=sl,Object.setPrototypeOf(this,Tt.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,Yi.prototype.create)}}class Yi{constructor(e,t,s){this.service=e,this.serviceName=t,this.errors=s}create(e,...t){const s=t[0]||{},i=`${this.service}/${e}`,r=this.errors[e],o=r?il(r,s):"Error",a=`${this.serviceName}: ${o} (${i}).`;return new Tt(i,a,s)}}function il(n,e){return n.replace(rl,(t,s)=>{const i=e[s];return i!=null?String(i):`<${s}?>`})}const rl=/\{\$([^}]+)}/g;function pt(n){return JSON.parse(n)}function W(n){return JSON.stringify(n)}const ji=function(n){let e={},t={},s={},i="";try{const r=n.split(".");e=pt(An(r[0])||""),t=pt(An(r[1])||""),i=r[2],s=t.d||{},delete t.d}catch{}return{header:e,claims:t,data:s,signature:i}},ol=function(n){const e=ji(n),t=e.claims;return!!t&&typeof t=="object"&&t.hasOwnProperty("iat")},al=function(n){const e=ji(n).claims;return typeof e=="object"&&e.admin===!0};function le(n,e){return Object.prototype.hasOwnProperty.call(n,e)}function $e(n,e){if(Object.prototype.hasOwnProperty.call(n,e))return n[e]}function kn(n){for(const e in n)if(Object.prototype.hasOwnProperty.call(n,e))return!1;return!0}function Bt(n,e,t){const s={};for(const i in n)Object.prototype.hasOwnProperty.call(n,i)&&(s[i]=e.call(t,n[i],i,n));return s}function Ft(n,e){if(n===e)return!0;const t=Object.keys(n),s=Object.keys(e);for(const i of t){if(!s.includes(i))return!1;const r=n[i],o=e[i];if(Fs(r)&&Fs(o)){if(!Ft(r,o))return!1}else if(r!==o)return!1}for(const i of s)if(!t.includes(i))return!1;return!0}function Fs(n){return n!==null&&typeof n=="object"}function ll(n){const e=[];for(const[t,s]of Object.entries(n))Array.isArray(s)?s.forEach(i=>{e.push(encodeURIComponent(t)+"="+encodeURIComponent(i))}):e.push(encodeURIComponent(t)+"="+encodeURIComponent(s));return e.length?"&"+e.join("&"):""}class cl{constructor(){this.chain_=[],this.buf_=[],this.W_=[],this.pad_=[],this.inbuf_=0,this.total_=0,this.blockSize=512/8,this.pad_[0]=128;for(let e=1;e<this.blockSize;++e)this.pad_[e]=0;this.reset()}reset(){this.chain_[0]=1732584193,this.chain_[1]=4023233417,this.chain_[2]=2562383102,this.chain_[3]=271733878,this.chain_[4]=3285377520,this.inbuf_=0,this.total_=0}compress_(e,t){t||(t=0);const s=this.W_;if(typeof e=="string")for(let u=0;u<16;u++)s[u]=e.charCodeAt(t)<<24|e.charCodeAt(t+1)<<16|e.charCodeAt(t+2)<<8|e.charCodeAt(t+3),t+=4;else for(let u=0;u<16;u++)s[u]=e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3],t+=4;for(let u=16;u<80;u++){const d=s[u-3]^s[u-8]^s[u-14]^s[u-16];s[u]=(d<<1|d>>>31)&4294967295}let i=this.chain_[0],r=this.chain_[1],o=this.chain_[2],a=this.chain_[3],l=this.chain_[4],c,h;for(let u=0;u<80;u++){u<40?u<20?(c=a^r&(o^a),h=1518500249):(c=r^o^a,h=1859775393):u<60?(c=r&o|a&(r|o),h=2400959708):(c=r^o^a,h=3395469782);const d=(i<<5|i>>>27)+c+l+h+s[u]&4294967295;l=a,a=o,o=(r<<30|r>>>2)&4294967295,r=i,i=d}this.chain_[0]=this.chain_[0]+i&4294967295,this.chain_[1]=this.chain_[1]+r&4294967295,this.chain_[2]=this.chain_[2]+o&4294967295,this.chain_[3]=this.chain_[3]+a&4294967295,this.chain_[4]=this.chain_[4]+l&4294967295}update(e,t){if(e==null)return;t===void 0&&(t=e.length);const s=t-this.blockSize;let i=0;const r=this.buf_;let o=this.inbuf_;for(;i<t;){if(o===0)for(;i<=s;)this.compress_(e,i),i+=this.blockSize;if(typeof e=="string"){for(;i<t;)if(r[o]=e.charCodeAt(i),++o,++i,o===this.blockSize){this.compress_(r),o=0;break}}else for(;i<t;)if(r[o]=e[i],++o,++i,o===this.blockSize){this.compress_(r),o=0;break}}this.inbuf_=o,this.total_+=t}digest(){const e=[];let t=this.total_*8;this.inbuf_<56?this.update(this.pad_,56-this.inbuf_):this.update(this.pad_,this.blockSize-(this.inbuf_-56));for(let i=this.blockSize-1;i>=56;i--)this.buf_[i]=t&255,t/=256;this.compress_(this.buf_);let s=0;for(let i=0;i<5;i++)for(let r=24;r>=0;r-=8)e[s]=this.chain_[i]>>r&255,++s;return e}}function Ve(n,e){return`${n} failed: ${e} argument `}const ul=function(n){const e=[];let t=0;for(let s=0;s<n.length;s++){let i=n.charCodeAt(s);if(i>=55296&&i<=56319){const r=i-55296;s++,g(s<n.length,"Surrogate pair missing trail surrogate.");const o=n.charCodeAt(s)-56320;i=65536+(r<<10)+o}i<128?e[t++]=i:i<2048?(e[t++]=i>>6|192,e[t++]=i&63|128):i<65536?(e[t++]=i>>12|224,e[t++]=i>>6&63|128,e[t++]=i&63|128):(e[t++]=i>>18|240,e[t++]=i>>12&63|128,e[t++]=i>>6&63|128,e[t++]=i&63|128)}return e},tn=function(n){let e=0;for(let t=0;t<n.length;t++){const s=n.charCodeAt(t);s<128?e++:s<2048?e+=2:s>=55296&&s<=56319?(e+=4,t++):e+=3}return e};function Ie(n){return n&&n._delegate?n._delegate:n}class mt{constructor(e,t,s){this.name=e,this.instanceFactory=t,this.type=s,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(e){return this.instantiationMode=e,this}setMultipleInstances(e){return this.multipleInstances=e,this}setServiceProps(e){return this.serviceProps=e,this}setInstanceCreatedCallback(e){return this.onInstanceCreated=e,this}}const Te="[DEFAULT]";class dl{constructor(e,t){this.name=e,this.container=t,this.component=null,this.instances=new Map,this.instancesDeferred=new Map,this.instancesOptions=new Map,this.onInitCallbacks=new Map}get(e){const t=this.normalizeInstanceIdentifier(e);if(!this.instancesDeferred.has(t)){const s=new re;if(this.instancesDeferred.set(t,s),this.isInitialized(t)||this.shouldAutoInitialize())try{const i=this.getOrInitializeService({instanceIdentifier:t});i&&s.resolve(i)}catch{}}return this.instancesDeferred.get(t).promise}getImmediate(e){const t=this.normalizeInstanceIdentifier(e?.identifier),s=e?.optional??!1;if(this.isInitialized(t)||this.shouldAutoInitialize())try{return this.getOrInitializeService({instanceIdentifier:t})}catch(i){if(s)return null;throw i}else{if(s)return null;throw Error(`Service ${this.name} is not available`)}}getComponent(){return this.component}setComponent(e){if(e.name!==this.name)throw Error(`Mismatching Component ${e.name} for Provider ${this.name}.`);if(this.component)throw Error(`Component for ${this.name} has already been provided`);if(this.component=e,!!this.shouldAutoInitialize()){if(fl(e))try{this.getOrInitializeService({instanceIdentifier:Te})}catch{}for(const[t,s]of this.instancesDeferred.entries()){const i=this.normalizeInstanceIdentifier(t);try{const r=this.getOrInitializeService({instanceIdentifier:i});s.resolve(r)}catch{}}}}clearInstance(e=Te){this.instancesDeferred.delete(e),this.instancesOptions.delete(e),this.instances.delete(e)}async delete(){const e=Array.from(this.instances.values());await Promise.all([...e.filter(t=>"INTERNAL"in t).map(t=>t.INTERNAL.delete()),...e.filter(t=>"_delete"in t).map(t=>t._delete())])}isComponentSet(){return this.component!=null}isInitialized(e=Te){return this.instances.has(e)}getOptions(e=Te){return this.instancesOptions.get(e)||{}}initialize(e={}){const{options:t={}}=e,s=this.normalizeInstanceIdentifier(e.instanceIdentifier);if(this.isInitialized(s))throw Error(`${this.name}(${s}) has already been initialized`);if(!this.isComponentSet())throw Error(`Component ${this.name} has not been registered yet`);const i=this.getOrInitializeService({instanceIdentifier:s,options:t});for(const[r,o]of this.instancesDeferred.entries()){const a=this.normalizeInstanceIdentifier(r);s===a&&o.resolve(i)}return i}onInit(e,t){const s=this.normalizeInstanceIdentifier(t),i=this.onInitCallbacks.get(s)??new Set;i.add(e),this.onInitCallbacks.set(s,i);const r=this.instances.get(s);return r&&e(r,s),()=>{i.delete(e)}}invokeOnInitCallbacks(e,t){const s=this.onInitCallbacks.get(t);if(s)for(const i of s)try{i(e,t)}catch{}}getOrInitializeService({instanceIdentifier:e,options:t={}}){let s=this.instances.get(e);if(!s&&this.component&&(s=this.component.instanceFactory(this.container,{instanceIdentifier:hl(e),options:t}),this.instances.set(e,s),this.instancesOptions.set(e,t),this.invokeOnInitCallbacks(s,e),this.component.onInstanceCreated))try{this.component.onInstanceCreated(this.container,e,s)}catch{}return s||null}normalizeInstanceIdentifier(e=Te){return this.component?this.component.multipleInstances?e:Te:e}shouldAutoInitialize(){return!!this.component&&this.component.instantiationMode!=="EXPLICIT"}}function hl(n){return n===Te?void 0:n}function fl(n){return n.instantiationMode==="EAGER"}class pl{constructor(e){this.name=e,this.providers=new Map}addComponent(e){const t=this.getProvider(e.name);if(t.isComponentSet())throw new Error(`Component ${e.name} has already been registered with ${this.name}`);t.setComponent(e)}addOrOverwriteComponent(e){this.getProvider(e.name).isComponentSet()&&this.providers.delete(e.name),this.addComponent(e)}getProvider(e){if(this.providers.has(e))return this.providers.get(e);const t=new dl(e,this);return this.providers.set(e,t),t}getProviders(){return Array.from(this.providers.values())}}var L;(function(n){n[n.DEBUG=0]="DEBUG",n[n.VERBOSE=1]="VERBOSE",n[n.INFO=2]="INFO",n[n.WARN=3]="WARN",n[n.ERROR=4]="ERROR",n[n.SILENT=5]="SILENT"})(L||(L={}));const ml={debug:L.DEBUG,verbose:L.VERBOSE,info:L.INFO,warn:L.WARN,error:L.ERROR,silent:L.SILENT},gl=L.INFO,_l={[L.DEBUG]:"log",[L.VERBOSE]:"log",[L.INFO]:"info",[L.WARN]:"warn",[L.ERROR]:"error"},yl=(n,e,...t)=>{if(e<n.logLevel)return;const s=new Date().toISOString(),i=_l[e];if(i)console[i](`[${s}]  ${n.name}:`,...t);else throw new Error(`Attempted to log a message with an invalid logType (value: ${e})`)};class qi{constructor(e){this.name=e,this._logLevel=gl,this._logHandler=yl,this._userLogHandler=null}get logLevel(){return this._logLevel}set logLevel(e){if(!(e in L))throw new TypeError(`Invalid value "${e}" assigned to \`logLevel\``);this._logLevel=e}setLogLevel(e){this._logLevel=typeof e=="string"?ml[e]:e}get logHandler(){return this._logHandler}set logHandler(e){if(typeof e!="function")throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=e}get userLogHandler(){return this._userLogHandler}set userLogHandler(e){this._userLogHandler=e}debug(...e){this._userLogHandler&&this._userLogHandler(this,L.DEBUG,...e),this._logHandler(this,L.DEBUG,...e)}log(...e){this._userLogHandler&&this._userLogHandler(this,L.VERBOSE,...e),this._logHandler(this,L.VERBOSE,...e)}info(...e){this._userLogHandler&&this._userLogHandler(this,L.INFO,...e),this._logHandler(this,L.INFO,...e)}warn(...e){this._userLogHandler&&this._userLogHandler(this,L.WARN,...e),this._logHandler(this,L.WARN,...e)}error(...e){this._userLogHandler&&this._userLogHandler(this,L.ERROR,...e),this._logHandler(this,L.ERROR,...e)}}const El=(n,e)=>e.some(t=>n instanceof t);let Ws,Gs;function Cl(){return Ws||(Ws=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function vl(){return Gs||(Gs=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const zi=new WeakMap,Dn=new WeakMap,Qi=new WeakMap,_n=new WeakMap,ts=new WeakMap;function Sl(n){const e=new Promise((t,s)=>{const i=()=>{n.removeEventListener("success",r),n.removeEventListener("error",o)},r=()=>{t(_e(n.result)),i()},o=()=>{s(n.error),i()};n.addEventListener("success",r),n.addEventListener("error",o)});return e.then(t=>{t instanceof IDBCursor&&zi.set(t,n)}).catch(()=>{}),ts.set(e,n),e}function bl(n){if(Dn.has(n))return;const e=new Promise((t,s)=>{const i=()=>{n.removeEventListener("complete",r),n.removeEventListener("error",o),n.removeEventListener("abort",o)},r=()=>{t(),i()},o=()=>{s(n.error||new DOMException("AbortError","AbortError")),i()};n.addEventListener("complete",r),n.addEventListener("error",o),n.addEventListener("abort",o)});Dn.set(n,e)}let Mn={get(n,e,t){if(n instanceof IDBTransaction){if(e==="done")return Dn.get(n);if(e==="objectStoreNames")return n.objectStoreNames||Qi.get(n);if(e==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return _e(n[e])},set(n,e,t){return n[e]=t,!0},has(n,e){return n instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in n}};function wl(n){Mn=n(Mn)}function Il(n){return n===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(e,...t){const s=n.call(yn(this),e,...t);return Qi.set(s,e.sort?e.sort():[e]),_e(s)}:vl().includes(n)?function(...e){return n.apply(yn(this),e),_e(zi.get(this))}:function(...e){return _e(n.apply(yn(this),e))}}function Tl(n){return typeof n=="function"?Il(n):(n instanceof IDBTransaction&&bl(n),El(n,Cl())?new Proxy(n,Mn):n)}function _e(n){if(n instanceof IDBRequest)return Sl(n);if(_n.has(n))return _n.get(n);const e=Tl(n);return e!==n&&(_n.set(n,e),ts.set(e,n)),e}const yn=n=>ts.get(n);function Nl(n,e,{blocked:t,upgrade:s,blocking:i,terminated:r}={}){const o=indexedDB.open(n,e),a=_e(o);return s&&o.addEventListener("upgradeneeded",l=>{s(_e(o.result),l.oldVersion,l.newVersion,_e(o.transaction),l)}),t&&o.addEventListener("blocked",l=>t(l.oldVersion,l.newVersion,l)),a.then(l=>{r&&l.addEventListener("close",()=>r()),i&&l.addEventListener("versionchange",c=>i(c.oldVersion,c.newVersion,c))}).catch(()=>{}),a}const Rl=["get","getKey","getAll","getAllKeys","count"],Ol=["put","add","delete","clear"],En=new Map;function Us(n,e){if(!(n instanceof IDBDatabase&&!(e in n)&&typeof e=="string"))return;if(En.get(e))return En.get(e);const t=e.replace(/FromIndex$/,""),s=e!==t,i=Ol.includes(t);if(!(t in(s?IDBIndex:IDBObjectStore).prototype)||!(i||Rl.includes(t)))return;const r=async function(o,...a){const l=this.transaction(o,i?"readwrite":"readonly");let c=l.store;return s&&(c=c.index(a.shift())),(await Promise.all([c[t](...a),i&&l.done]))[0]};return En.set(e,r),r}wl(n=>({...n,get:(e,t,s)=>Us(e,t)||n.get(e,t,s),has:(e,t)=>!!Us(e,t)||n.has(e,t)}));class Al{constructor(e){this.container=e}getPlatformInfoString(){return this.container.getProviders().map(t=>{if(kl(t)){const s=t.getImmediate();return`${s.library}/${s.version}`}else return null}).filter(t=>t).join(" ")}}function kl(n){return n.getComponent()?.type==="VERSION"}const Ln="@firebase/app",Hs="0.14.7";const fe=new qi("@firebase/app"),Dl="@firebase/app-compat",Ml="@firebase/analytics-compat",Ll="@firebase/analytics",Pl="@firebase/app-check-compat",xl="@firebase/app-check",Bl="@firebase/auth",Fl="@firebase/auth-compat",Wl="@firebase/database",Gl="@firebase/data-connect",Ul="@firebase/database-compat",Hl="@firebase/functions",$l="@firebase/functions-compat",Vl="@firebase/installations",Kl="@firebase/installations-compat",Yl="@firebase/messaging",jl="@firebase/messaging-compat",ql="@firebase/performance",zl="@firebase/performance-compat",Ql="@firebase/remote-config",Xl="@firebase/remote-config-compat",Jl="@firebase/storage",Zl="@firebase/storage-compat",ec="@firebase/firestore",tc="@firebase/ai",nc="@firebase/firestore-compat",sc="firebase",ic="12.8.0";const Pn="[DEFAULT]",rc={[Ln]:"fire-core",[Dl]:"fire-core-compat",[Ll]:"fire-analytics",[Ml]:"fire-analytics-compat",[xl]:"fire-app-check",[Pl]:"fire-app-check-compat",[Bl]:"fire-auth",[Fl]:"fire-auth-compat",[Wl]:"fire-rtdb",[Gl]:"fire-data-connect",[Ul]:"fire-rtdb-compat",[Hl]:"fire-fn",[$l]:"fire-fn-compat",[Vl]:"fire-iid",[Kl]:"fire-iid-compat",[Yl]:"fire-fcm",[jl]:"fire-fcm-compat",[ql]:"fire-perf",[zl]:"fire-perf-compat",[Ql]:"fire-rc",[Xl]:"fire-rc-compat",[Jl]:"fire-gcs",[Zl]:"fire-gcs-compat",[ec]:"fire-fst",[nc]:"fire-fst-compat",[tc]:"fire-vertex","fire-js":"fire-js",[sc]:"fire-js-all"};const Wt=new Map,oc=new Map,xn=new Map;function $s(n,e){try{n.container.addComponent(e)}catch(t){fe.debug(`Component ${e.name} failed to register with FirebaseApp ${n.name}`,t)}}function Gt(n){const e=n.name;if(xn.has(e))return fe.debug(`There were multiple attempts to register component ${e}.`),!1;xn.set(e,n);for(const t of Wt.values())$s(t,n);for(const t of oc.values())$s(t,n);return!0}function ac(n,e){const t=n.container.getProvider("heartbeat").getImmediate({optional:!0});return t&&t.triggerHeartbeat(),n.container.getProvider(e)}function lc(n){return n==null?!1:n.settings!==void 0}const cc={"no-app":"No Firebase App '{$appName}' has been created - call initializeApp() first","bad-app-name":"Illegal App name: '{$appName}'","duplicate-app":"Firebase App named '{$appName}' already exists with different options or config","app-deleted":"Firebase App named '{$appName}' already deleted","server-app-deleted":"Firebase Server App has been deleted","no-options":"Need to provide options, when not being deployed to hosting via source.","invalid-app-argument":"firebase.{$appName}() takes either no argument or a Firebase App instance.","invalid-log-argument":"First argument to `onLog` must be null or a function.","idb-open":"Error thrown when opening IndexedDB. Original error: {$originalErrorMessage}.","idb-get":"Error thrown when reading from IndexedDB. Original error: {$originalErrorMessage}.","idb-set":"Error thrown when writing to IndexedDB. Original error: {$originalErrorMessage}.","idb-delete":"Error thrown when deleting from IndexedDB. Original error: {$originalErrorMessage}.","finalization-registry-not-supported":"FirebaseServerApp deleteOnDeref field defined but the JS runtime does not support FinalizationRegistry.","invalid-server-app-environment":"FirebaseServerApp is not for use in browser environments."},ye=new Yi("app","Firebase",cc);class uc{constructor(e,t,s){this._isDeleted=!1,this._options={...e},this._config={...t},this._name=t.name,this._automaticDataCollectionEnabled=t.automaticDataCollectionEnabled,this._container=s,this.container.addComponent(new mt("app",()=>this,"PUBLIC"))}get automaticDataCollectionEnabled(){return this.checkDestroyed(),this._automaticDataCollectionEnabled}set automaticDataCollectionEnabled(e){this.checkDestroyed(),this._automaticDataCollectionEnabled=e}get name(){return this.checkDestroyed(),this._name}get options(){return this.checkDestroyed(),this._options}get config(){return this.checkDestroyed(),this._config}get container(){return this._container}get isDeleted(){return this._isDeleted}set isDeleted(e){this._isDeleted=e}checkDestroyed(){if(this.isDeleted)throw ye.create("app-deleted",{appName:this._name})}}const dc=ic;function Xi(n,e={}){let t=n;typeof e!="object"&&(e={name:e});const s={name:Pn,automaticDataCollectionEnabled:!0,...e},i=s.name;if(typeof i!="string"||!i)throw ye.create("bad-app-name",{appName:String(i)});if(t||(t=Vi()),!t)throw ye.create("no-options");const r=Wt.get(i);if(r){if(Ft(t,r.options)&&Ft(s,r.config))return r;throw ye.create("duplicate-app",{appName:i})}const o=new pl(i);for(const l of xn.values())o.addComponent(l);const a=new uc(t,s,o);return Wt.set(i,a),a}function hc(n=Pn){const e=Wt.get(n);if(!e&&n===Pn&&Vi())return Xi();if(!e)throw ye.create("no-app",{appName:n});return e}function Fe(n,e,t){let s=rc[n]??n;t&&(s+=`-${t}`);const i=s.match(/\s|\//),r=e.match(/\s|\//);if(i||r){const o=[`Unable to register library "${s}" with version "${e}":`];i&&o.push(`library name "${s}" contains illegal characters (whitespace or "/")`),i&&r&&o.push("and"),r&&o.push(`version name "${e}" contains illegal characters (whitespace or "/")`),fe.warn(o.join(" "));return}Gt(new mt(`${s}-version`,()=>({library:s,version:e}),"VERSION"))}const fc="firebase-heartbeat-database",pc=1,gt="firebase-heartbeat-store";let Cn=null;function Ji(){return Cn||(Cn=Nl(fc,pc,{upgrade:(n,e)=>{switch(e){case 0:try{n.createObjectStore(gt)}catch(t){console.warn(t)}}}}).catch(n=>{throw ye.create("idb-open",{originalErrorMessage:n.message})})),Cn}async function mc(n){try{const t=(await Ji()).transaction(gt),s=await t.objectStore(gt).get(Zi(n));return await t.done,s}catch(e){if(e instanceof Tt)fe.warn(e.message);else{const t=ye.create("idb-get",{originalErrorMessage:e?.message});fe.warn(t.message)}}}async function Vs(n,e){try{const s=(await Ji()).transaction(gt,"readwrite");await s.objectStore(gt).put(e,Zi(n)),await s.done}catch(t){if(t instanceof Tt)fe.warn(t.message);else{const s=ye.create("idb-set",{originalErrorMessage:t?.message});fe.warn(s.message)}}}function Zi(n){return`${n.name}!${n.options.appId}`}const gc=1024,_c=30;class yc{constructor(e){this.container=e,this._heartbeatsCache=null;const t=this.container.getProvider("app").getImmediate();this._storage=new Cc(t),this._heartbeatsCachePromise=this._storage.read().then(s=>(this._heartbeatsCache=s,s))}async triggerHeartbeat(){try{const t=this.container.getProvider("platform-logger").getImmediate().getPlatformInfoString(),s=Ks();if(this._heartbeatsCache?.heartbeats==null&&(this._heartbeatsCache=await this._heartbeatsCachePromise,this._heartbeatsCache?.heartbeats==null)||this._heartbeatsCache.lastSentHeartbeatDate===s||this._heartbeatsCache.heartbeats.some(i=>i.date===s))return;if(this._heartbeatsCache.heartbeats.push({date:s,agent:t}),this._heartbeatsCache.heartbeats.length>_c){const i=vc(this._heartbeatsCache.heartbeats);this._heartbeatsCache.heartbeats.splice(i,1)}return this._storage.overwrite(this._heartbeatsCache)}catch(e){fe.warn(e)}}async getHeartbeatsHeader(){try{if(this._heartbeatsCache===null&&await this._heartbeatsCachePromise,this._heartbeatsCache?.heartbeats==null||this._heartbeatsCache.heartbeats.length===0)return"";const e=Ks(),{heartbeatsToSend:t,unsentEntries:s}=Ec(this._heartbeatsCache.heartbeats),i=xt(JSON.stringify({version:2,heartbeats:t}));return this._heartbeatsCache.lastSentHeartbeatDate=e,s.length>0?(this._heartbeatsCache.heartbeats=s,await this._storage.overwrite(this._heartbeatsCache)):(this._heartbeatsCache.heartbeats=[],this._storage.overwrite(this._heartbeatsCache)),i}catch(e){return fe.warn(e),""}}}function Ks(){return new Date().toISOString().substring(0,10)}function Ec(n,e=gc){const t=[];let s=n.slice();for(const i of n){const r=t.find(o=>o.agent===i.agent);if(r){if(r.dates.push(i.date),Ys(t)>e){r.dates.pop();break}}else if(t.push({agent:i.agent,dates:[i.date]}),Ys(t)>e){t.pop();break}s=s.slice(1)}return{heartbeatsToSend:t,unsentEntries:s}}class Cc{constructor(e){this.app=e,this._canUseIndexedDBPromise=this.runIndexedDBEnvironmentCheck()}async runIndexedDBEnvironmentCheck(){return tl()?nl().then(()=>!0).catch(()=>!1):!1}async read(){if(await this._canUseIndexedDBPromise){const t=await mc(this.app);return t?.heartbeats?t:{heartbeats:[]}}else return{heartbeats:[]}}async overwrite(e){if(await this._canUseIndexedDBPromise){const s=await this.read();return Vs(this.app,{lastSentHeartbeatDate:e.lastSentHeartbeatDate??s.lastSentHeartbeatDate,heartbeats:e.heartbeats})}else return}async add(e){if(await this._canUseIndexedDBPromise){const s=await this.read();return Vs(this.app,{lastSentHeartbeatDate:e.lastSentHeartbeatDate??s.lastSentHeartbeatDate,heartbeats:[...s.heartbeats,...e.heartbeats]})}else return}}function Ys(n){return xt(JSON.stringify({version:2,heartbeats:n})).length}function vc(n){if(n.length===0)return-1;let e=0,t=n[0].date;for(let s=1;s<n.length;s++)n[s].date<t&&(t=n[s].date,e=s);return e}function Sc(n){Gt(new mt("platform-logger",e=>new Al(e),"PRIVATE")),Gt(new mt("heartbeat",e=>new yc(e),"PRIVATE")),Fe(Ln,Hs,n),Fe(Ln,Hs,"esm2020"),Fe("fire-js","")}Sc("");var bc="firebase",wc="12.8.0";Fe(bc,wc,"app");var js={};const qs="@firebase/database",zs="1.1.0";let er="";function Ic(n){er=n}class Tc{constructor(e){this.domStorage_=e,this.prefix_="firebase:"}set(e,t){t==null?this.domStorage_.removeItem(this.prefixedName_(e)):this.domStorage_.setItem(this.prefixedName_(e),W(t))}get(e){const t=this.domStorage_.getItem(this.prefixedName_(e));return t==null?null:pt(t)}remove(e){this.domStorage_.removeItem(this.prefixedName_(e))}prefixedName_(e){return this.prefix_+e}toString(){return this.domStorage_.toString()}}class Nc{constructor(){this.cache_={},this.isInMemoryStorage=!0}set(e,t){t==null?delete this.cache_[e]:this.cache_[e]=t}get(e){return le(this.cache_,e)?this.cache_[e]:null}remove(e){delete this.cache_[e]}}const tr=function(n){try{if(typeof window<"u"&&typeof window[n]<"u"){const e=window[n];return e.setItem("firebase:sentinel","cache"),e.removeItem("firebase:sentinel"),new Tc(e)}}catch{}return new Nc},Re=tr("localStorage"),Rc=tr("sessionStorage");const We=new qi("@firebase/database"),Oc=(function(){let n=1;return function(){return n++}})(),nr=function(n){const e=ul(n),t=new cl;t.update(e);const s=t.digest();return Zn.encodeByteArray(s)},Nt=function(...n){let e="";for(let t=0;t<n.length;t++){const s=n[t];Array.isArray(s)||s&&typeof s=="object"&&typeof s.length=="number"?e+=Nt.apply(null,s):typeof s=="object"?e+=W(s):e+=s,e+=" "}return e};let ct=null,Qs=!0;const Ac=function(n,e){g(!0,"Can't turn on custom loggers persistently."),We.logLevel=L.VERBOSE,ct=We.log.bind(We)},H=function(...n){if(Qs===!0&&(Qs=!1,ct===null&&Rc.get("logging_enabled")===!0&&Ac()),ct){const e=Nt.apply(null,n);ct(e)}},Rt=function(n){return function(...e){H(n,...e)}},Bn=function(...n){const e="FIREBASE INTERNAL ERROR: "+Nt(...n);We.error(e)},pe=function(...n){const e=`FIREBASE FATAL ERROR: ${Nt(...n)}`;throw We.error(e),new Error(e)},K=function(...n){const e="FIREBASE WARNING: "+Nt(...n);We.warn(e)},kc=function(){typeof window<"u"&&window.location&&window.location.protocol&&window.location.protocol.indexOf("https:")!==-1&&K("Insecure Firebase access from a secure page. Please use https in calls to new Firebase().")},nn=function(n){return typeof n=="number"&&(n!==n||n===Number.POSITIVE_INFINITY||n===Number.NEGATIVE_INFINITY)},Dc=function(n){if(document.readyState==="complete")n();else{let e=!1;const t=function(){if(!document.body){setTimeout(t,Math.floor(10));return}e||(e=!0,n())};document.addEventListener?(document.addEventListener("DOMContentLoaded",t,!1),window.addEventListener("load",t,!1)):document.attachEvent&&(document.attachEvent("onreadystatechange",()=>{document.readyState==="complete"&&t()}),window.attachEvent("onload",t))}},Ke="[MIN_NAME]",Oe="[MAX_NAME]",De=function(n,e){if(n===e)return 0;if(n===Ke||e===Oe)return-1;if(e===Ke||n===Oe)return 1;{const t=Xs(n),s=Xs(e);return t!==null?s!==null?t-s===0?n.length-e.length:t-s:-1:s!==null?1:n<e?-1:1}},Mc=function(n,e){return n===e?0:n<e?-1:1},nt=function(n,e){if(e&&n in e)return e[n];throw new Error("Missing required key ("+n+") in object: "+W(e))},ns=function(n){if(typeof n!="object"||n===null)return W(n);const e=[];for(const s in n)e.push(s);e.sort();let t="{";for(let s=0;s<e.length;s++)s!==0&&(t+=","),t+=W(e[s]),t+=":",t+=ns(n[e[s]]);return t+="}",t},sr=function(n,e){const t=n.length;if(t<=e)return[n];const s=[];for(let i=0;i<t;i+=e)i+e>t?s.push(n.substring(i,t)):s.push(n.substring(i,i+e));return s};function $(n,e){for(const t in n)n.hasOwnProperty(t)&&e(t,n[t])}const ir=function(n){g(!nn(n),"Invalid JSON number");const e=11,t=52,s=(1<<e-1)-1;let i,r,o,a,l;n===0?(r=0,o=0,i=1/n===-1/0?1:0):(i=n<0,n=Math.abs(n),n>=Math.pow(2,1-s)?(a=Math.min(Math.floor(Math.log(n)/Math.LN2),s),r=a+s,o=Math.round(n*Math.pow(2,t-a)-Math.pow(2,t))):(r=0,o=Math.round(n/Math.pow(2,1-s-t))));const c=[];for(l=t;l;l-=1)c.push(o%2?1:0),o=Math.floor(o/2);for(l=e;l;l-=1)c.push(r%2?1:0),r=Math.floor(r/2);c.push(i?1:0),c.reverse();const h=c.join("");let u="";for(l=0;l<64;l+=8){let d=parseInt(h.substr(l,8),2).toString(16);d.length===1&&(d="0"+d),u=u+d}return u.toLowerCase()},Lc=function(){return!!(typeof window=="object"&&window.chrome&&window.chrome.extension&&!/^chrome/.test(window.location.href))},Pc=function(){return typeof Windows=="object"&&typeof Windows.UI=="object"};function xc(n,e){let t="Unknown Error";n==="too_big"?t="The data requested exceeds the maximum size that can be accessed with a single request.":n==="permission_denied"?t="Client doesn't have permission to access the desired data.":n==="unavailable"&&(t="The service is unavailable");const s=new Error(n+" at "+e._path.toString()+": "+t);return s.code=n.toUpperCase(),s}const Bc=new RegExp("^-?(0*)\\d{1,10}$"),Fc=-2147483648,Wc=2147483647,Xs=function(n){if(Bc.test(n)){const e=Number(n);if(e>=Fc&&e<=Wc)return e}return null},Je=function(n){try{n()}catch(e){setTimeout(()=>{const t=e.stack||"";throw K("Exception was thrown by user callback.",t),e},Math.floor(0))}},Gc=function(){return(typeof window=="object"&&window.navigator&&window.navigator.userAgent||"").search(/googlebot|google webmaster tools|bingbot|yahoo! slurp|baiduspider|yandexbot|duckduckbot/i)>=0},ut=function(n,e){const t=setTimeout(n,e);return typeof t=="number"&&typeof Deno<"u"&&Deno.unrefTimer?Deno.unrefTimer(t):typeof t=="object"&&t.unref&&t.unref(),t};class Uc{constructor(e,t){this.appCheckProvider=t,this.appName=e.name,lc(e)&&e.settings.appCheckToken&&(this.serverAppAppCheckToken=e.settings.appCheckToken),this.appCheck=t?.getImmediate({optional:!0}),this.appCheck||t?.get().then(s=>this.appCheck=s)}getToken(e){if(this.serverAppAppCheckToken){if(e)throw new Error("Attempted reuse of `FirebaseServerApp.appCheckToken` after previous usage failed.");return Promise.resolve({token:this.serverAppAppCheckToken})}return this.appCheck?this.appCheck.getToken(e):new Promise((t,s)=>{setTimeout(()=>{this.appCheck?this.getToken(e).then(t,s):t(null)},0)})}addTokenChangeListener(e){this.appCheckProvider?.get().then(t=>t.addTokenListener(e))}notifyForInvalidToken(){K(`Provided AppCheck credentials for the app named "${this.appName}" are invalid. This usually indicates your app was not initialized correctly.`)}}class Hc{constructor(e,t,s){this.appName_=e,this.firebaseOptions_=t,this.authProvider_=s,this.auth_=null,this.auth_=s.getImmediate({optional:!0}),this.auth_||s.onInit(i=>this.auth_=i)}getToken(e){return this.auth_?this.auth_.getToken(e).catch(t=>t&&t.code==="auth/token-not-initialized"?(H("Got auth/token-not-initialized error.  Treating as null token."),null):Promise.reject(t)):new Promise((t,s)=>{setTimeout(()=>{this.auth_?this.getToken(e).then(t,s):t(null)},0)})}addTokenChangeListener(e){this.auth_?this.auth_.addAuthTokenListener(e):this.authProvider_.get().then(t=>t.addAuthTokenListener(e))}removeTokenChangeListener(e){this.authProvider_.get().then(t=>t.removeAuthTokenListener(e))}notifyForInvalidToken(){let e='Provided authentication credentials for the app named "'+this.appName_+'" are invalid. This usually indicates your app was not initialized correctly. ';"credential"in this.firebaseOptions_?e+='Make sure the "credential" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':"serviceAccount"in this.firebaseOptions_?e+='Make sure the "serviceAccount" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':e+='Make sure the "apiKey" and "databaseURL" properties provided to initializeApp() match the values provided for your app at https://console.firebase.google.com/.',K(e)}}class Pt{constructor(e){this.accessToken=e}getToken(e){return Promise.resolve({accessToken:this.accessToken})}addTokenChangeListener(e){e(this.accessToken)}removeTokenChangeListener(e){}notifyForInvalidToken(){}}Pt.OWNER="owner";const ss="5",rr="v",or="s",ar="r",lr="f",cr=/(console\.firebase|firebase-console-\w+\.corp|firebase\.corp)\.google\.com/,ur="ls",dr="p",Fn="ac",hr="websocket",fr="long_polling";class pr{constructor(e,t,s,i,r=!1,o="",a=!1,l=!1,c=null){this.secure=t,this.namespace=s,this.webSocketOnly=i,this.nodeAdmin=r,this.persistenceKey=o,this.includeNamespaceInQueryParams=a,this.isUsingEmulator=l,this.emulatorOptions=c,this._host=e.toLowerCase(),this._domain=this._host.substr(this._host.indexOf(".")+1),this.internalHost=Re.get("host:"+e)||this._host}isCacheableHost(){return this.internalHost.substr(0,2)==="s-"}isCustomHost(){return this._domain!=="firebaseio.com"&&this._domain!=="firebaseio-demo.com"}get host(){return this._host}set host(e){e!==this.internalHost&&(this.internalHost=e,this.isCacheableHost()&&Re.set("host:"+this._host,this.internalHost))}toString(){let e=this.toURLString();return this.persistenceKey&&(e+="<"+this.persistenceKey+">"),e}toURLString(){const e=this.secure?"https://":"http://",t=this.includeNamespaceInQueryParams?`?ns=${this.namespace}`:"";return`${e}${this.host}/${t}`}}function $c(n){return n.host!==n.internalHost||n.isCustomHost()||n.includeNamespaceInQueryParams}function mr(n,e,t){g(typeof e=="string","typeof type must == string"),g(typeof t=="object","typeof params must == object");let s;if(e===hr)s=(n.secure?"wss://":"ws://")+n.internalHost+"/.ws?";else if(e===fr)s=(n.secure?"https://":"http://")+n.internalHost+"/.lp?";else throw new Error("Unknown connection type: "+e);$c(n)&&(t.ns=n.namespace);const i=[];return $(t,(r,o)=>{i.push(r+"="+o)}),s+i.join("&")}class Vc{constructor(){this.counters_={}}incrementCounter(e,t=1){le(this.counters_,e)||(this.counters_[e]=0),this.counters_[e]+=t}get(){return Wa(this.counters_)}}const vn={},Sn={};function is(n){const e=n.toString();return vn[e]||(vn[e]=new Vc),vn[e]}function Kc(n,e){const t=n.toString();return Sn[t]||(Sn[t]=e()),Sn[t]}class Yc{constructor(e){this.onMessage_=e,this.pendingResponses=[],this.currentResponseNum=0,this.closeAfterResponse=-1,this.onClose=null}closeAfter(e,t){this.closeAfterResponse=e,this.onClose=t,this.closeAfterResponse<this.currentResponseNum&&(this.onClose(),this.onClose=null)}handleResponse(e,t){for(this.pendingResponses[e]=t;this.pendingResponses[this.currentResponseNum];){const s=this.pendingResponses[this.currentResponseNum];delete this.pendingResponses[this.currentResponseNum];for(let i=0;i<s.length;++i)s[i]&&Je(()=>{this.onMessage_(s[i])});if(this.currentResponseNum===this.closeAfterResponse){this.onClose&&(this.onClose(),this.onClose=null);break}this.currentResponseNum++}}}const Js="start",jc="close",qc="pLPCommand",zc="pRTLPCB",gr="id",_r="pw",yr="ser",Qc="cb",Xc="seg",Jc="ts",Zc="d",eu="dframe",Er=1870,Cr=30,tu=Er-Cr,nu=25e3,su=3e4;class Pe{constructor(e,t,s,i,r,o,a){this.connId=e,this.repoInfo=t,this.applicationId=s,this.appCheckToken=i,this.authToken=r,this.transportSessionId=o,this.lastSessionId=a,this.bytesSent=0,this.bytesReceived=0,this.everConnected_=!1,this.log_=Rt(e),this.stats_=is(t),this.urlFn=l=>(this.appCheckToken&&(l[Fn]=this.appCheckToken),mr(t,fr,l))}open(e,t){this.curSegmentNum=0,this.onDisconnect_=t,this.myPacketOrderer=new Yc(e),this.isClosed_=!1,this.connectTimeoutTimer_=setTimeout(()=>{this.log_("Timed out trying to connect."),this.onClosed_(),this.connectTimeoutTimer_=null},Math.floor(su)),Dc(()=>{if(this.isClosed_)return;this.scriptTagHolder=new rs((...r)=>{const[o,a,l,c,h]=r;if(this.incrementIncomingBytes_(r),!!this.scriptTagHolder)if(this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null),this.everConnected_=!0,o===Js)this.id=a,this.password=l;else if(o===jc)a?(this.scriptTagHolder.sendNewPolls=!1,this.myPacketOrderer.closeAfter(a,()=>{this.onClosed_()})):this.onClosed_();else throw new Error("Unrecognized command received: "+o)},(...r)=>{const[o,a]=r;this.incrementIncomingBytes_(r),this.myPacketOrderer.handleResponse(o,a)},()=>{this.onClosed_()},this.urlFn);const s={};s[Js]="t",s[yr]=Math.floor(Math.random()*1e8),this.scriptTagHolder.uniqueCallbackIdentifier&&(s[Qc]=this.scriptTagHolder.uniqueCallbackIdentifier),s[rr]=ss,this.transportSessionId&&(s[or]=this.transportSessionId),this.lastSessionId&&(s[ur]=this.lastSessionId),this.applicationId&&(s[dr]=this.applicationId),this.appCheckToken&&(s[Fn]=this.appCheckToken),typeof location<"u"&&location.hostname&&cr.test(location.hostname)&&(s[ar]=lr);const i=this.urlFn(s);this.log_("Connecting via long-poll to "+i),this.scriptTagHolder.addTag(i,()=>{})})}start(){this.scriptTagHolder.startLongPoll(this.id,this.password),this.addDisconnectPingFrame(this.id,this.password)}static forceAllow(){Pe.forceAllow_=!0}static forceDisallow(){Pe.forceDisallow_=!0}static isAvailable(){return Pe.forceAllow_?!0:!Pe.forceDisallow_&&typeof document<"u"&&document.createElement!=null&&!Lc()&&!Pc()}markConnectionHealthy(){}shutdown_(){this.isClosed_=!0,this.scriptTagHolder&&(this.scriptTagHolder.close(),this.scriptTagHolder=null),this.myDisconnFrame&&(document.body.removeChild(this.myDisconnFrame),this.myDisconnFrame=null),this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null)}onClosed_(){this.isClosed_||(this.log_("Longpoll is closing itself"),this.shutdown_(),this.onDisconnect_&&(this.onDisconnect_(this.everConnected_),this.onDisconnect_=null))}close(){this.isClosed_||(this.log_("Longpoll is being closed."),this.shutdown_())}send(e){const t=W(e);this.bytesSent+=t.length,this.stats_.incrementCounter("bytes_sent",t.length);const s=Ui(t),i=sr(s,tu);for(let r=0;r<i.length;r++)this.scriptTagHolder.enqueueSegment(this.curSegmentNum,i.length,i[r]),this.curSegmentNum++}addDisconnectPingFrame(e,t){this.myDisconnFrame=document.createElement("iframe");const s={};s[eu]="t",s[gr]=e,s[_r]=t,this.myDisconnFrame.src=this.urlFn(s),this.myDisconnFrame.style.display="none",document.body.appendChild(this.myDisconnFrame)}incrementIncomingBytes_(e){const t=W(e).length;this.bytesReceived+=t,this.stats_.incrementCounter("bytes_received",t)}}class rs{constructor(e,t,s,i){this.onDisconnect=s,this.urlFn=i,this.outstandingRequests=new Set,this.pendingSegs=[],this.currentSerial=Math.floor(Math.random()*1e8),this.sendNewPolls=!0;{this.uniqueCallbackIdentifier=Oc(),window[qc+this.uniqueCallbackIdentifier]=e,window[zc+this.uniqueCallbackIdentifier]=t,this.myIFrame=rs.createIFrame_();let r="";this.myIFrame.src&&this.myIFrame.src.substr(0,11)==="javascript:"&&(r='<script>document.domain="'+document.domain+'";<\/script>');const o="<html><body>"+r+"</body></html>";try{this.myIFrame.doc.open(),this.myIFrame.doc.write(o),this.myIFrame.doc.close()}catch(a){H("frame writing exception"),a.stack&&H(a.stack),H(a)}}}static createIFrame_(){const e=document.createElement("iframe");if(e.style.display="none",document.body){document.body.appendChild(e);try{e.contentWindow.document||H("No IE domain setting required")}catch{const s=document.domain;e.src="javascript:void((function(){document.open();document.domain='"+s+"';document.close();})())"}}else throw"Document body has not initialized. Wait to initialize Firebase until after the document is ready.";return e.contentDocument?e.doc=e.contentDocument:e.contentWindow?e.doc=e.contentWindow.document:e.document&&(e.doc=e.document),e}close(){this.alive=!1,this.myIFrame&&(this.myIFrame.doc.body.textContent="",setTimeout(()=>{this.myIFrame!==null&&(document.body.removeChild(this.myIFrame),this.myIFrame=null)},Math.floor(0)));const e=this.onDisconnect;e&&(this.onDisconnect=null,e())}startLongPoll(e,t){for(this.myID=e,this.myPW=t,this.alive=!0;this.newRequest_(););}newRequest_(){if(this.alive&&this.sendNewPolls&&this.outstandingRequests.size<(this.pendingSegs.length>0?2:1)){this.currentSerial++;const e={};e[gr]=this.myID,e[_r]=this.myPW,e[yr]=this.currentSerial;let t=this.urlFn(e),s="",i=0;for(;this.pendingSegs.length>0&&this.pendingSegs[0].d.length+Cr+s.length<=Er;){const o=this.pendingSegs.shift();s=s+"&"+Xc+i+"="+o.seg+"&"+Jc+i+"="+o.ts+"&"+Zc+i+"="+o.d,i++}return t=t+s,this.addLongPollTag_(t,this.currentSerial),!0}else return!1}enqueueSegment(e,t,s){this.pendingSegs.push({seg:e,ts:t,d:s}),this.alive&&this.newRequest_()}addLongPollTag_(e,t){this.outstandingRequests.add(t);const s=()=>{this.outstandingRequests.delete(t),this.newRequest_()},i=setTimeout(s,Math.floor(nu)),r=()=>{clearTimeout(i),s()};this.addTag(e,r)}addTag(e,t){setTimeout(()=>{try{if(!this.sendNewPolls)return;const s=this.myIFrame.doc.createElement("script");s.type="text/javascript",s.async=!0,s.src=e,s.onload=s.onreadystatechange=function(){const i=s.readyState;(!i||i==="loaded"||i==="complete")&&(s.onload=s.onreadystatechange=null,s.parentNode&&s.parentNode.removeChild(s),t())},s.onerror=()=>{H("Long-poll script failed to load: "+e),this.sendNewPolls=!1,this.close()},this.myIFrame.doc.body.appendChild(s)}catch{}},Math.floor(1))}}const iu=16384,ru=45e3;let Ut=null;typeof MozWebSocket<"u"?Ut=MozWebSocket:typeof WebSocket<"u"&&(Ut=WebSocket);class ne{constructor(e,t,s,i,r,o,a){this.connId=e,this.applicationId=s,this.appCheckToken=i,this.authToken=r,this.keepaliveTimer=null,this.frames=null,this.totalFrames=0,this.bytesSent=0,this.bytesReceived=0,this.log_=Rt(this.connId),this.stats_=is(t),this.connURL=ne.connectionURL_(t,o,a,i,s),this.nodeAdmin=t.nodeAdmin}static connectionURL_(e,t,s,i,r){const o={};return o[rr]=ss,typeof location<"u"&&location.hostname&&cr.test(location.hostname)&&(o[ar]=lr),t&&(o[or]=t),s&&(o[ur]=s),i&&(o[Fn]=i),r&&(o[dr]=r),mr(e,hr,o)}open(e,t){this.onDisconnect=t,this.onMessage=e,this.log_("Websocket connecting to "+this.connURL),this.everConnected_=!1,Re.set("previous_websocket_failure",!0);try{let s;el(),this.mySock=new Ut(this.connURL,[],s)}catch(s){this.log_("Error instantiating WebSocket.");const i=s.message||s.data;i&&this.log_(i),this.onClosed_();return}this.mySock.onopen=()=>{this.log_("Websocket connected."),this.everConnected_=!0},this.mySock.onclose=()=>{this.log_("Websocket connection was disconnected."),this.mySock=null,this.onClosed_()},this.mySock.onmessage=s=>{this.handleIncomingFrame(s)},this.mySock.onerror=s=>{this.log_("WebSocket error.  Closing connection.");const i=s.message||s.data;i&&this.log_(i),this.onClosed_()}}start(){}static forceDisallow(){ne.forceDisallow_=!0}static isAvailable(){let e=!1;if(typeof navigator<"u"&&navigator.userAgent){const t=/Android ([0-9]{0,}\.[0-9]{0,})/,s=navigator.userAgent.match(t);s&&s.length>1&&parseFloat(s[1])<4.4&&(e=!0)}return!e&&Ut!==null&&!ne.forceDisallow_}static previouslyFailed(){return Re.isInMemoryStorage||Re.get("previous_websocket_failure")===!0}markConnectionHealthy(){Re.remove("previous_websocket_failure")}appendFrame_(e){if(this.frames.push(e),this.frames.length===this.totalFrames){const t=this.frames.join("");this.frames=null;const s=pt(t);this.onMessage(s)}}handleNewFrameCount_(e){this.totalFrames=e,this.frames=[]}extractFrameCount_(e){if(g(this.frames===null,"We already have a frame buffer"),e.length<=6){const t=Number(e);if(!isNaN(t))return this.handleNewFrameCount_(t),null}return this.handleNewFrameCount_(1),e}handleIncomingFrame(e){if(this.mySock===null)return;const t=e.data;if(this.bytesReceived+=t.length,this.stats_.incrementCounter("bytes_received",t.length),this.resetKeepAlive(),this.frames!==null)this.appendFrame_(t);else{const s=this.extractFrameCount_(t);s!==null&&this.appendFrame_(s)}}send(e){this.resetKeepAlive();const t=W(e);this.bytesSent+=t.length,this.stats_.incrementCounter("bytes_sent",t.length);const s=sr(t,iu);s.length>1&&this.sendString_(String(s.length));for(let i=0;i<s.length;i++)this.sendString_(s[i])}shutdown_(){this.isClosed_=!0,this.keepaliveTimer&&(clearInterval(this.keepaliveTimer),this.keepaliveTimer=null),this.mySock&&(this.mySock.close(),this.mySock=null)}onClosed_(){this.isClosed_||(this.log_("WebSocket is closing itself"),this.shutdown_(),this.onDisconnect&&(this.onDisconnect(this.everConnected_),this.onDisconnect=null))}close(){this.isClosed_||(this.log_("WebSocket is being closed"),this.shutdown_())}resetKeepAlive(){clearInterval(this.keepaliveTimer),this.keepaliveTimer=setInterval(()=>{this.mySock&&this.sendString_("0"),this.resetKeepAlive()},Math.floor(ru))}sendString_(e){try{this.mySock.send(e)}catch(t){this.log_("Exception thrown from WebSocket.send():",t.message||t.data,"Closing connection."),setTimeout(this.onClosed_.bind(this),0)}}}ne.responsesRequiredToBeHealthy=2;ne.healthyTimeout=3e4;class _t{static get ALL_TRANSPORTS(){return[Pe,ne]}static get IS_TRANSPORT_INITIALIZED(){return this.globalTransportInitialized_}constructor(e){this.initTransports_(e)}initTransports_(e){const t=ne&&ne.isAvailable();let s=t&&!ne.previouslyFailed();if(e.webSocketOnly&&(t||K("wss:// URL used, but browser isn't known to support websockets.  Trying anyway."),s=!0),s)this.transports_=[ne];else{const i=this.transports_=[];for(const r of _t.ALL_TRANSPORTS)r&&r.isAvailable()&&i.push(r);_t.globalTransportInitialized_=!0}}initialTransport(){if(this.transports_.length>0)return this.transports_[0];throw new Error("No transports available")}upgradeTransport(){return this.transports_.length>1?this.transports_[1]:null}}_t.globalTransportInitialized_=!1;const ou=6e4,au=5e3,lu=10*1024,cu=100*1024,bn="t",Zs="d",uu="s",ei="r",du="e",ti="o",ni="a",si="n",ii="p",hu="h";class fu{constructor(e,t,s,i,r,o,a,l,c,h){this.id=e,this.repoInfo_=t,this.applicationId_=s,this.appCheckToken_=i,this.authToken_=r,this.onMessage_=o,this.onReady_=a,this.onDisconnect_=l,this.onKill_=c,this.lastSessionId=h,this.connectionCount=0,this.pendingDataMessages=[],this.state_=0,this.log_=Rt("c:"+this.id+":"),this.transportManager_=new _t(t),this.log_("Connection created"),this.start_()}start_(){const e=this.transportManager_.initialTransport();this.conn_=new e(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,null,this.lastSessionId),this.primaryResponsesRequired_=e.responsesRequiredToBeHealthy||0;const t=this.connReceiver_(this.conn_),s=this.disconnReceiver_(this.conn_);this.tx_=this.conn_,this.rx_=this.conn_,this.secondaryConn_=null,this.isHealthy_=!1,setTimeout(()=>{this.conn_&&this.conn_.open(t,s)},Math.floor(0));const i=e.healthyTimeout||0;i>0&&(this.healthyTimeout_=ut(()=>{this.healthyTimeout_=null,this.isHealthy_||(this.conn_&&this.conn_.bytesReceived>cu?(this.log_("Connection exceeded healthy timeout but has received "+this.conn_.bytesReceived+" bytes.  Marking connection healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()):this.conn_&&this.conn_.bytesSent>lu?this.log_("Connection exceeded healthy timeout but has sent "+this.conn_.bytesSent+" bytes.  Leaving connection alive."):(this.log_("Closing unhealthy connection after timeout."),this.close()))},Math.floor(i)))}nextTransportId_(){return"c:"+this.id+":"+this.connectionCount++}disconnReceiver_(e){return t=>{e===this.conn_?this.onConnectionLost_(t):e===this.secondaryConn_?(this.log_("Secondary connection lost."),this.onSecondaryConnectionLost_()):this.log_("closing an old connection")}}connReceiver_(e){return t=>{this.state_!==2&&(e===this.rx_?this.onPrimaryMessageReceived_(t):e===this.secondaryConn_?this.onSecondaryMessageReceived_(t):this.log_("message on old connection"))}}sendRequest(e){const t={t:"d",d:e};this.sendData_(t)}tryCleanupConnection(){this.tx_===this.secondaryConn_&&this.rx_===this.secondaryConn_&&(this.log_("cleaning up and promoting a connection: "+this.secondaryConn_.connId),this.conn_=this.secondaryConn_,this.secondaryConn_=null)}onSecondaryControl_(e){if(bn in e){const t=e[bn];t===ni?this.upgradeIfSecondaryHealthy_():t===ei?(this.log_("Got a reset on secondary, closing it"),this.secondaryConn_.close(),(this.tx_===this.secondaryConn_||this.rx_===this.secondaryConn_)&&this.close()):t===ti&&(this.log_("got pong on secondary."),this.secondaryResponsesRequired_--,this.upgradeIfSecondaryHealthy_())}}onSecondaryMessageReceived_(e){const t=nt("t",e),s=nt("d",e);if(t==="c")this.onSecondaryControl_(s);else if(t==="d")this.pendingDataMessages.push(s);else throw new Error("Unknown protocol layer: "+t)}upgradeIfSecondaryHealthy_(){this.secondaryResponsesRequired_<=0?(this.log_("Secondary connection is healthy."),this.isHealthy_=!0,this.secondaryConn_.markConnectionHealthy(),this.proceedWithUpgrade_()):(this.log_("sending ping on secondary."),this.secondaryConn_.send({t:"c",d:{t:ii,d:{}}}))}proceedWithUpgrade_(){this.secondaryConn_.start(),this.log_("sending client ack on secondary"),this.secondaryConn_.send({t:"c",d:{t:ni,d:{}}}),this.log_("Ending transmission on primary"),this.conn_.send({t:"c",d:{t:si,d:{}}}),this.tx_=this.secondaryConn_,this.tryCleanupConnection()}onPrimaryMessageReceived_(e){const t=nt("t",e),s=nt("d",e);t==="c"?this.onControl_(s):t==="d"&&this.onDataMessage_(s)}onDataMessage_(e){this.onPrimaryResponse_(),this.onMessage_(e)}onPrimaryResponse_(){this.isHealthy_||(this.primaryResponsesRequired_--,this.primaryResponsesRequired_<=0&&(this.log_("Primary connection is healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()))}onControl_(e){const t=nt(bn,e);if(Zs in e){const s=e[Zs];if(t===hu){const i={...s};this.repoInfo_.isUsingEmulator&&(i.h=this.repoInfo_.host),this.onHandshake_(i)}else if(t===si){this.log_("recvd end transmission on primary"),this.rx_=this.secondaryConn_;for(let i=0;i<this.pendingDataMessages.length;++i)this.onDataMessage_(this.pendingDataMessages[i]);this.pendingDataMessages=[],this.tryCleanupConnection()}else t===uu?this.onConnectionShutdown_(s):t===ei?this.onReset_(s):t===du?Bn("Server Error: "+s):t===ti?(this.log_("got pong on primary."),this.onPrimaryResponse_(),this.sendPingOnPrimaryIfNecessary_()):Bn("Unknown control packet command: "+t)}}onHandshake_(e){const t=e.ts,s=e.v,i=e.h;this.sessionId=e.s,this.repoInfo_.host=i,this.state_===0&&(this.conn_.start(),this.onConnectionEstablished_(this.conn_,t),ss!==s&&K("Protocol version mismatch detected"),this.tryStartUpgrade_())}tryStartUpgrade_(){const e=this.transportManager_.upgradeTransport();e&&this.startUpgrade_(e)}startUpgrade_(e){this.secondaryConn_=new e(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,this.sessionId),this.secondaryResponsesRequired_=e.responsesRequiredToBeHealthy||0;const t=this.connReceiver_(this.secondaryConn_),s=this.disconnReceiver_(this.secondaryConn_);this.secondaryConn_.open(t,s),ut(()=>{this.secondaryConn_&&(this.log_("Timed out trying to upgrade."),this.secondaryConn_.close())},Math.floor(ou))}onReset_(e){this.log_("Reset packet received.  New host: "+e),this.repoInfo_.host=e,this.state_===1?this.close():(this.closeConnections_(),this.start_())}onConnectionEstablished_(e,t){this.log_("Realtime connection established."),this.conn_=e,this.state_=1,this.onReady_&&(this.onReady_(t,this.sessionId),this.onReady_=null),this.primaryResponsesRequired_===0?(this.log_("Primary connection is healthy."),this.isHealthy_=!0):ut(()=>{this.sendPingOnPrimaryIfNecessary_()},Math.floor(au))}sendPingOnPrimaryIfNecessary_(){!this.isHealthy_&&this.state_===1&&(this.log_("sending ping on primary."),this.sendData_({t:"c",d:{t:ii,d:{}}}))}onSecondaryConnectionLost_(){const e=this.secondaryConn_;this.secondaryConn_=null,(this.tx_===e||this.rx_===e)&&this.close()}onConnectionLost_(e){this.conn_=null,!e&&this.state_===0?(this.log_("Realtime connection failed."),this.repoInfo_.isCacheableHost()&&(Re.remove("host:"+this.repoInfo_.host),this.repoInfo_.internalHost=this.repoInfo_.host)):this.state_===1&&this.log_("Realtime connection lost."),this.close()}onConnectionShutdown_(e){this.log_("Connection shutdown command received. Shutting down..."),this.onKill_&&(this.onKill_(e),this.onKill_=null),this.onDisconnect_=null,this.close()}sendData_(e){if(this.state_!==1)throw"Connection is not connected";this.tx_.send(e)}close(){this.state_!==2&&(this.log_("Closing realtime connection."),this.state_=2,this.closeConnections_(),this.onDisconnect_&&(this.onDisconnect_(),this.onDisconnect_=null))}closeConnections_(){this.log_("Shutting down all connections"),this.conn_&&(this.conn_.close(),this.conn_=null),this.secondaryConn_&&(this.secondaryConn_.close(),this.secondaryConn_=null),this.healthyTimeout_&&(clearTimeout(this.healthyTimeout_),this.healthyTimeout_=null)}}class vr{put(e,t,s,i){}merge(e,t,s,i){}refreshAuthToken(e){}refreshAppCheckToken(e){}onDisconnectPut(e,t,s){}onDisconnectMerge(e,t,s){}onDisconnectCancel(e,t){}reportStats(e){}}class Sr{constructor(e){this.allowedEvents_=e,this.listeners_={},g(Array.isArray(e)&&e.length>0,"Requires a non-empty array")}trigger(e,...t){if(Array.isArray(this.listeners_[e])){const s=[...this.listeners_[e]];for(let i=0;i<s.length;i++)s[i].callback.apply(s[i].context,t)}}on(e,t,s){this.validateEventType_(e),this.listeners_[e]=this.listeners_[e]||[],this.listeners_[e].push({callback:t,context:s});const i=this.getInitialEvent(e);i&&t.apply(s,i)}off(e,t,s){this.validateEventType_(e);const i=this.listeners_[e]||[];for(let r=0;r<i.length;r++)if(i[r].callback===t&&(!s||s===i[r].context)){i.splice(r,1);return}}validateEventType_(e){g(this.allowedEvents_.find(t=>t===e),"Unknown event: "+e)}}class Ht extends Sr{static getInstance(){return new Ht}constructor(){super(["online"]),this.online_=!0,typeof window<"u"&&typeof window.addEventListener<"u"&&!Ki()&&(window.addEventListener("online",()=>{this.online_||(this.online_=!0,this.trigger("online",!0))},!1),window.addEventListener("offline",()=>{this.online_&&(this.online_=!1,this.trigger("online",!1))},!1))}getInitialEvent(e){return g(e==="online","Unknown event type: "+e),[this.online_]}currentlyOnline(){return this.online_}}const ri=32,oi=768;class k{constructor(e,t){if(t===void 0){this.pieces_=e.split("/");let s=0;for(let i=0;i<this.pieces_.length;i++)this.pieces_[i].length>0&&(this.pieces_[s]=this.pieces_[i],s++);this.pieces_.length=s,this.pieceNum_=0}else this.pieces_=e,this.pieceNum_=t}toString(){let e="";for(let t=this.pieceNum_;t<this.pieces_.length;t++)this.pieces_[t]!==""&&(e+="/"+this.pieces_[t]);return e||"/"}}function R(){return new k("")}function S(n){return n.pieceNum_>=n.pieces_.length?null:n.pieces_[n.pieceNum_]}function ve(n){return n.pieces_.length-n.pieceNum_}function D(n){let e=n.pieceNum_;return e<n.pieces_.length&&e++,new k(n.pieces_,e)}function os(n){return n.pieceNum_<n.pieces_.length?n.pieces_[n.pieces_.length-1]:null}function pu(n){let e="";for(let t=n.pieceNum_;t<n.pieces_.length;t++)n.pieces_[t]!==""&&(e+="/"+encodeURIComponent(String(n.pieces_[t])));return e||"/"}function yt(n,e=0){return n.pieces_.slice(n.pieceNum_+e)}function br(n){if(n.pieceNum_>=n.pieces_.length)return null;const e=[];for(let t=n.pieceNum_;t<n.pieces_.length-1;t++)e.push(n.pieces_[t]);return new k(e,0)}function P(n,e){const t=[];for(let s=n.pieceNum_;s<n.pieces_.length;s++)t.push(n.pieces_[s]);if(e instanceof k)for(let s=e.pieceNum_;s<e.pieces_.length;s++)t.push(e.pieces_[s]);else{const s=e.split("/");for(let i=0;i<s.length;i++)s[i].length>0&&t.push(s[i])}return new k(t,0)}function b(n){return n.pieceNum_>=n.pieces_.length}function V(n,e){const t=S(n),s=S(e);if(t===null)return e;if(t===s)return V(D(n),D(e));throw new Error("INTERNAL ERROR: innerPath ("+e+") is not within outerPath ("+n+")")}function mu(n,e){const t=yt(n,0),s=yt(e,0);for(let i=0;i<t.length&&i<s.length;i++){const r=De(t[i],s[i]);if(r!==0)return r}return t.length===s.length?0:t.length<s.length?-1:1}function as(n,e){if(ve(n)!==ve(e))return!1;for(let t=n.pieceNum_,s=e.pieceNum_;t<=n.pieces_.length;t++,s++)if(n.pieces_[t]!==e.pieces_[s])return!1;return!0}function ee(n,e){let t=n.pieceNum_,s=e.pieceNum_;if(ve(n)>ve(e))return!1;for(;t<n.pieces_.length;){if(n.pieces_[t]!==e.pieces_[s])return!1;++t,++s}return!0}class gu{constructor(e,t){this.errorPrefix_=t,this.parts_=yt(e,0),this.byteLength_=Math.max(1,this.parts_.length);for(let s=0;s<this.parts_.length;s++)this.byteLength_+=tn(this.parts_[s]);wr(this)}}function _u(n,e){n.parts_.length>0&&(n.byteLength_+=1),n.parts_.push(e),n.byteLength_+=tn(e),wr(n)}function yu(n){const e=n.parts_.pop();n.byteLength_-=tn(e),n.parts_.length>0&&(n.byteLength_-=1)}function wr(n){if(n.byteLength_>oi)throw new Error(n.errorPrefix_+"has a key path longer than "+oi+" bytes ("+n.byteLength_+").");if(n.parts_.length>ri)throw new Error(n.errorPrefix_+"path specified exceeds the maximum depth that can be written ("+ri+") or object contains a cycle "+Ne(n))}function Ne(n){return n.parts_.length===0?"":"in property '"+n.parts_.join(".")+"'"}class ls extends Sr{static getInstance(){return new ls}constructor(){super(["visible"]);let e,t;typeof document<"u"&&typeof document.addEventListener<"u"&&(typeof document.hidden<"u"?(t="visibilitychange",e="hidden"):typeof document.mozHidden<"u"?(t="mozvisibilitychange",e="mozHidden"):typeof document.msHidden<"u"?(t="msvisibilitychange",e="msHidden"):typeof document.webkitHidden<"u"&&(t="webkitvisibilitychange",e="webkitHidden")),this.visible_=!0,t&&document.addEventListener(t,()=>{const s=!document[e];s!==this.visible_&&(this.visible_=s,this.trigger("visible",s))},!1)}getInitialEvent(e){return g(e==="visible","Unknown event type: "+e),[this.visible_]}}const st=1e3,Eu=300*1e3,ai=30*1e3,Cu=1.3,vu=3e4,Su="server_kill",li=3;class de extends vr{constructor(e,t,s,i,r,o,a,l){if(super(),this.repoInfo_=e,this.applicationId_=t,this.onDataUpdate_=s,this.onConnectStatus_=i,this.onServerInfoUpdate_=r,this.authTokenProvider_=o,this.appCheckTokenProvider_=a,this.authOverride_=l,this.id=de.nextPersistentConnectionId_++,this.log_=Rt("p:"+this.id+":"),this.interruptReasons_={},this.listens=new Map,this.outstandingPuts_=[],this.outstandingGets_=[],this.outstandingPutCount_=0,this.outstandingGetCount_=0,this.onDisconnectRequestQueue_=[],this.connected_=!1,this.reconnectDelay_=st,this.maxReconnectDelay_=Eu,this.securityDebugCallback_=null,this.lastSessionId=null,this.establishConnectionTimer_=null,this.visible_=!1,this.requestCBHash_={},this.requestNumber_=0,this.realtime_=null,this.authToken_=null,this.appCheckToken_=null,this.forceTokenRefresh_=!1,this.invalidAuthTokenCount_=0,this.invalidAppCheckTokenCount_=0,this.firstConnection_=!0,this.lastConnectionAttemptTime_=null,this.lastConnectionEstablishedTime_=null,l)throw new Error("Auth override specified in options, but not supported on non Node.js platforms");ls.getInstance().on("visible",this.onVisible_,this),e.host.indexOf("fblocal")===-1&&Ht.getInstance().on("online",this.onOnline_,this)}sendRequest(e,t,s){const i=++this.requestNumber_,r={r:i,a:e,b:t};this.log_(W(r)),g(this.connected_,"sendRequest call when we're not connected not allowed."),this.realtime_.sendRequest(r),s&&(this.requestCBHash_[i]=s)}get(e){this.initConnection_();const t=new re,i={action:"g",request:{p:e._path.toString(),q:e._queryObject},onComplete:o=>{const a=o.d;o.s==="ok"?t.resolve(a):t.reject(a)}};this.outstandingGets_.push(i),this.outstandingGetCount_++;const r=this.outstandingGets_.length-1;return this.connected_&&this.sendGet_(r),t.promise}listen(e,t,s,i){this.initConnection_();const r=e._queryIdentifier,o=e._path.toString();this.log_("Listen called for "+o+" "+r),this.listens.has(o)||this.listens.set(o,new Map),g(e._queryParams.isDefault()||!e._queryParams.loadsAllData(),"listen() called for non-default but complete query"),g(!this.listens.get(o).has(r),"listen() called twice for same path/queryId.");const a={onComplete:i,hashFn:t,query:e,tag:s};this.listens.get(o).set(r,a),this.connected_&&this.sendListen_(a)}sendGet_(e){const t=this.outstandingGets_[e];this.sendRequest("g",t.request,s=>{delete this.outstandingGets_[e],this.outstandingGetCount_--,this.outstandingGetCount_===0&&(this.outstandingGets_=[]),t.onComplete&&t.onComplete(s)})}sendListen_(e){const t=e.query,s=t._path.toString(),i=t._queryIdentifier;this.log_("Listen on "+s+" for "+i);const r={p:s},o="q";e.tag&&(r.q=t._queryObject,r.t=e.tag),r.h=e.hashFn(),this.sendRequest(o,r,a=>{const l=a.d,c=a.s;de.warnOnListenWarnings_(l,t),(this.listens.get(s)&&this.listens.get(s).get(i))===e&&(this.log_("listen response",a),c!=="ok"&&this.removeListen_(s,i),e.onComplete&&e.onComplete(c,l))})}static warnOnListenWarnings_(e,t){if(e&&typeof e=="object"&&le(e,"w")){const s=$e(e,"w");if(Array.isArray(s)&&~s.indexOf("no_index")){const i='".indexOn": "'+t._queryParams.getIndex().toString()+'"',r=t._path.toString();K(`Using an unspecified index. Your data will be downloaded and filtered on the client. Consider adding ${i} at ${r} to your security rules for better performance.`)}}}refreshAuthToken(e){this.authToken_=e,this.log_("Auth token refreshed"),this.authToken_?this.tryAuth():this.connected_&&this.sendRequest("unauth",{},()=>{}),this.reduceReconnectDelayIfAdminCredential_(e)}reduceReconnectDelayIfAdminCredential_(e){(e&&e.length===40||al(e))&&(this.log_("Admin auth credential detected.  Reducing max reconnect time."),this.maxReconnectDelay_=ai)}refreshAppCheckToken(e){this.appCheckToken_=e,this.log_("App check token refreshed"),this.appCheckToken_?this.tryAppCheck():this.connected_&&this.sendRequest("unappeck",{},()=>{})}tryAuth(){if(this.connected_&&this.authToken_){const e=this.authToken_,t=ol(e)?"auth":"gauth",s={cred:e};this.authOverride_===null?s.noauth=!0:typeof this.authOverride_=="object"&&(s.authvar=this.authOverride_),this.sendRequest(t,s,i=>{const r=i.s,o=i.d||"error";this.authToken_===e&&(r==="ok"?this.invalidAuthTokenCount_=0:this.onAuthRevoked_(r,o))})}}tryAppCheck(){this.connected_&&this.appCheckToken_&&this.sendRequest("appcheck",{token:this.appCheckToken_},e=>{const t=e.s,s=e.d||"error";t==="ok"?this.invalidAppCheckTokenCount_=0:this.onAppCheckRevoked_(t,s)})}unlisten(e,t){const s=e._path.toString(),i=e._queryIdentifier;this.log_("Unlisten called for "+s+" "+i),g(e._queryParams.isDefault()||!e._queryParams.loadsAllData(),"unlisten() called for non-default but complete query"),this.removeListen_(s,i)&&this.connected_&&this.sendUnlisten_(s,i,e._queryObject,t)}sendUnlisten_(e,t,s,i){this.log_("Unlisten on "+e+" for "+t);const r={p:e},o="n";i&&(r.q=s,r.t=i),this.sendRequest(o,r)}onDisconnectPut(e,t,s){this.initConnection_(),this.connected_?this.sendOnDisconnect_("o",e,t,s):this.onDisconnectRequestQueue_.push({pathString:e,action:"o",data:t,onComplete:s})}onDisconnectMerge(e,t,s){this.initConnection_(),this.connected_?this.sendOnDisconnect_("om",e,t,s):this.onDisconnectRequestQueue_.push({pathString:e,action:"om",data:t,onComplete:s})}onDisconnectCancel(e,t){this.initConnection_(),this.connected_?this.sendOnDisconnect_("oc",e,null,t):this.onDisconnectRequestQueue_.push({pathString:e,action:"oc",data:null,onComplete:t})}sendOnDisconnect_(e,t,s,i){const r={p:t,d:s};this.log_("onDisconnect "+e,r),this.sendRequest(e,r,o=>{i&&setTimeout(()=>{i(o.s,o.d)},Math.floor(0))})}put(e,t,s,i){this.putInternal("p",e,t,s,i)}merge(e,t,s,i){this.putInternal("m",e,t,s,i)}putInternal(e,t,s,i,r){this.initConnection_();const o={p:t,d:s};r!==void 0&&(o.h=r),this.outstandingPuts_.push({action:e,request:o,onComplete:i}),this.outstandingPutCount_++;const a=this.outstandingPuts_.length-1;this.connected_?this.sendPut_(a):this.log_("Buffering put: "+t)}sendPut_(e){const t=this.outstandingPuts_[e].action,s=this.outstandingPuts_[e].request,i=this.outstandingPuts_[e].onComplete;this.outstandingPuts_[e].queued=this.connected_,this.sendRequest(t,s,r=>{this.log_(t+" response",r),delete this.outstandingPuts_[e],this.outstandingPutCount_--,this.outstandingPutCount_===0&&(this.outstandingPuts_=[]),i&&i(r.s,r.d)})}reportStats(e){if(this.connected_){const t={c:e};this.log_("reportStats",t),this.sendRequest("s",t,s=>{if(s.s!=="ok"){const r=s.d;this.log_("reportStats","Error sending stats: "+r)}})}}onDataMessage_(e){if("r"in e){this.log_("from server: "+W(e));const t=e.r,s=this.requestCBHash_[t];s&&(delete this.requestCBHash_[t],s(e.b))}else{if("error"in e)throw"A server-side error has occurred: "+e.error;"a"in e&&this.onDataPush_(e.a,e.b)}}onDataPush_(e,t){this.log_("handleServerMessage",e,t),e==="d"?this.onDataUpdate_(t.p,t.d,!1,t.t):e==="m"?this.onDataUpdate_(t.p,t.d,!0,t.t):e==="c"?this.onListenRevoked_(t.p,t.q):e==="ac"?this.onAuthRevoked_(t.s,t.d):e==="apc"?this.onAppCheckRevoked_(t.s,t.d):e==="sd"?this.onSecurityDebugPacket_(t):Bn("Unrecognized action received from server: "+W(e)+`
Are you using the latest client?`)}onReady_(e,t){this.log_("connection ready"),this.connected_=!0,this.lastConnectionEstablishedTime_=new Date().getTime(),this.handleTimestamp_(e),this.lastSessionId=t,this.firstConnection_&&this.sendConnectStats_(),this.restoreState_(),this.firstConnection_=!1,this.onConnectStatus_(!0)}scheduleConnect_(e){g(!this.realtime_,"Scheduling a connect when we're already connected/ing?"),this.establishConnectionTimer_&&clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=setTimeout(()=>{this.establishConnectionTimer_=null,this.establishConnection_()},Math.floor(e))}initConnection_(){!this.realtime_&&this.firstConnection_&&this.scheduleConnect_(0)}onVisible_(e){e&&!this.visible_&&this.reconnectDelay_===this.maxReconnectDelay_&&(this.log_("Window became visible.  Reducing delay."),this.reconnectDelay_=st,this.realtime_||this.scheduleConnect_(0)),this.visible_=e}onOnline_(e){e?(this.log_("Browser went online."),this.reconnectDelay_=st,this.realtime_||this.scheduleConnect_(0)):(this.log_("Browser went offline.  Killing connection."),this.realtime_&&this.realtime_.close())}onRealtimeDisconnect_(){if(this.log_("data client disconnected"),this.connected_=!1,this.realtime_=null,this.cancelSentTransactions_(),this.requestCBHash_={},this.shouldReconnect_()){this.visible_?this.lastConnectionEstablishedTime_&&(new Date().getTime()-this.lastConnectionEstablishedTime_>vu&&(this.reconnectDelay_=st),this.lastConnectionEstablishedTime_=null):(this.log_("Window isn't visible.  Delaying reconnect."),this.reconnectDelay_=this.maxReconnectDelay_,this.lastConnectionAttemptTime_=new Date().getTime());const e=Math.max(0,new Date().getTime()-this.lastConnectionAttemptTime_);let t=Math.max(0,this.reconnectDelay_-e);t=Math.random()*t,this.log_("Trying to reconnect in "+t+"ms"),this.scheduleConnect_(t),this.reconnectDelay_=Math.min(this.maxReconnectDelay_,this.reconnectDelay_*Cu)}this.onConnectStatus_(!1)}async establishConnection_(){if(this.shouldReconnect_()){this.log_("Making a connection attempt"),this.lastConnectionAttemptTime_=new Date().getTime(),this.lastConnectionEstablishedTime_=null;const e=this.onDataMessage_.bind(this),t=this.onReady_.bind(this),s=this.onRealtimeDisconnect_.bind(this),i=this.id+":"+de.nextConnectionId_++,r=this.lastSessionId;let o=!1,a=null;const l=function(){a?a.close():(o=!0,s())},c=function(u){g(a,"sendRequest call when we're not connected not allowed."),a.sendRequest(u)};this.realtime_={close:l,sendRequest:c};const h=this.forceTokenRefresh_;this.forceTokenRefresh_=!1;try{const[u,d]=await Promise.all([this.authTokenProvider_.getToken(h),this.appCheckTokenProvider_.getToken(h)]);o?H("getToken() completed but was canceled"):(H("getToken() completed. Creating connection."),this.authToken_=u&&u.accessToken,this.appCheckToken_=d&&d.token,a=new fu(i,this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,e,t,s,p=>{K(p+" ("+this.repoInfo_.toString()+")"),this.interrupt(Su)},r))}catch(u){this.log_("Failed to get token: "+u),o||(this.repoInfo_.nodeAdmin&&K(u),l())}}}interrupt(e){H("Interrupting connection for reason: "+e),this.interruptReasons_[e]=!0,this.realtime_?this.realtime_.close():(this.establishConnectionTimer_&&(clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=null),this.connected_&&this.onRealtimeDisconnect_())}resume(e){H("Resuming connection for reason: "+e),delete this.interruptReasons_[e],kn(this.interruptReasons_)&&(this.reconnectDelay_=st,this.realtime_||this.scheduleConnect_(0))}handleTimestamp_(e){const t=e-new Date().getTime();this.onServerInfoUpdate_({serverTimeOffset:t})}cancelSentTransactions_(){for(let e=0;e<this.outstandingPuts_.length;e++){const t=this.outstandingPuts_[e];t&&"h"in t.request&&t.queued&&(t.onComplete&&t.onComplete("disconnect"),delete this.outstandingPuts_[e],this.outstandingPutCount_--)}this.outstandingPutCount_===0&&(this.outstandingPuts_=[])}onListenRevoked_(e,t){let s;t?s=t.map(r=>ns(r)).join("$"):s="default";const i=this.removeListen_(e,s);i&&i.onComplete&&i.onComplete("permission_denied")}removeListen_(e,t){const s=new k(e).toString();let i;if(this.listens.has(s)){const r=this.listens.get(s);i=r.get(t),r.delete(t),r.size===0&&this.listens.delete(s)}else i=void 0;return i}onAuthRevoked_(e,t){H("Auth token revoked: "+e+"/"+t),this.authToken_=null,this.forceTokenRefresh_=!0,this.realtime_.close(),(e==="invalid_token"||e==="permission_denied")&&(this.invalidAuthTokenCount_++,this.invalidAuthTokenCount_>=li&&(this.reconnectDelay_=ai,this.authTokenProvider_.notifyForInvalidToken()))}onAppCheckRevoked_(e,t){H("App check token revoked: "+e+"/"+t),this.appCheckToken_=null,this.forceTokenRefresh_=!0,(e==="invalid_token"||e==="permission_denied")&&(this.invalidAppCheckTokenCount_++,this.invalidAppCheckTokenCount_>=li&&this.appCheckTokenProvider_.notifyForInvalidToken())}onSecurityDebugPacket_(e){this.securityDebugCallback_?this.securityDebugCallback_(e):"msg"in e&&console.log("FIREBASE: "+e.msg.replace(`
`,`
FIREBASE: `))}restoreState_(){this.tryAuth(),this.tryAppCheck();for(const e of this.listens.values())for(const t of e.values())this.sendListen_(t);for(let e=0;e<this.outstandingPuts_.length;e++)this.outstandingPuts_[e]&&this.sendPut_(e);for(;this.onDisconnectRequestQueue_.length;){const e=this.onDisconnectRequestQueue_.shift();this.sendOnDisconnect_(e.action,e.pathString,e.data,e.onComplete)}for(let e=0;e<this.outstandingGets_.length;e++)this.outstandingGets_[e]&&this.sendGet_(e)}sendConnectStats_(){const e={};let t="js";e["sdk."+t+"."+er.replace(/\./g,"-")]=1,Ki()?e["framework.cordova"]=1:Za()&&(e["framework.reactnative"]=1),this.reportStats(e)}shouldReconnect_(){const e=Ht.getInstance().currentlyOnline();return kn(this.interruptReasons_)&&e}}de.nextPersistentConnectionId_=0;de.nextConnectionId_=0;class w{constructor(e,t){this.name=e,this.node=t}static Wrap(e,t){return new w(e,t)}}class sn{getCompare(){return this.compare.bind(this)}indexedValueChanged(e,t){const s=new w(Ke,e),i=new w(Ke,t);return this.compare(s,i)!==0}minPost(){return w.MIN}}let Mt;class Ir extends sn{static get __EMPTY_NODE(){return Mt}static set __EMPTY_NODE(e){Mt=e}compare(e,t){return De(e.name,t.name)}isDefinedOn(e){throw Xe("KeyIndex.isDefinedOn not expected to be called.")}indexedValueChanged(e,t){return!1}minPost(){return w.MIN}maxPost(){return new w(Oe,Mt)}makePost(e,t){return g(typeof e=="string","KeyIndex indexValue must always be a string."),new w(e,Mt)}toString(){return".key"}}const Ge=new Ir;class Lt{constructor(e,t,s,i,r=null){this.isReverse_=i,this.resultGenerator_=r,this.nodeStack_=[];let o=1;for(;!e.isEmpty();)if(e=e,o=t?s(e.key,t):1,i&&(o*=-1),o<0)this.isReverse_?e=e.left:e=e.right;else if(o===0){this.nodeStack_.push(e);break}else this.nodeStack_.push(e),this.isReverse_?e=e.right:e=e.left}getNext(){if(this.nodeStack_.length===0)return null;let e=this.nodeStack_.pop(),t;if(this.resultGenerator_?t=this.resultGenerator_(e.key,e.value):t={key:e.key,value:e.value},this.isReverse_)for(e=e.left;!e.isEmpty();)this.nodeStack_.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack_.push(e),e=e.left;return t}hasNext(){return this.nodeStack_.length>0}peek(){if(this.nodeStack_.length===0)return null;const e=this.nodeStack_[this.nodeStack_.length-1];return this.resultGenerator_?this.resultGenerator_(e.key,e.value):{key:e.key,value:e.value}}}class U{constructor(e,t,s,i,r){this.key=e,this.value=t,this.color=s??U.RED,this.left=i??q.EMPTY_NODE,this.right=r??q.EMPTY_NODE}copy(e,t,s,i,r){return new U(e??this.key,t??this.value,s??this.color,i??this.left,r??this.right)}count(){return this.left.count()+1+this.right.count()}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||!!e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min_(){return this.left.isEmpty()?this:this.left.min_()}minKey(){return this.min_().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,s){let i=this;const r=s(e,i.key);return r<0?i=i.copy(null,null,null,i.left.insert(e,t,s),null):r===0?i=i.copy(null,t,null,null,null):i=i.copy(null,null,null,null,i.right.insert(e,t,s)),i.fixUp_()}removeMin_(){if(this.left.isEmpty())return q.EMPTY_NODE;let e=this;return!e.left.isRed_()&&!e.left.left.isRed_()&&(e=e.moveRedLeft_()),e=e.copy(null,null,null,e.left.removeMin_(),null),e.fixUp_()}remove(e,t){let s,i;if(s=this,t(e,s.key)<0)!s.left.isEmpty()&&!s.left.isRed_()&&!s.left.left.isRed_()&&(s=s.moveRedLeft_()),s=s.copy(null,null,null,s.left.remove(e,t),null);else{if(s.left.isRed_()&&(s=s.rotateRight_()),!s.right.isEmpty()&&!s.right.isRed_()&&!s.right.left.isRed_()&&(s=s.moveRedRight_()),t(e,s.key)===0){if(s.right.isEmpty())return q.EMPTY_NODE;i=s.right.min_(),s=s.copy(i.key,i.value,null,null,s.right.removeMin_())}s=s.copy(null,null,null,null,s.right.remove(e,t))}return s.fixUp_()}isRed_(){return this.color}fixUp_(){let e=this;return e.right.isRed_()&&!e.left.isRed_()&&(e=e.rotateLeft_()),e.left.isRed_()&&e.left.left.isRed_()&&(e=e.rotateRight_()),e.left.isRed_()&&e.right.isRed_()&&(e=e.colorFlip_()),e}moveRedLeft_(){let e=this.colorFlip_();return e.right.left.isRed_()&&(e=e.copy(null,null,null,null,e.right.rotateRight_()),e=e.rotateLeft_(),e=e.colorFlip_()),e}moveRedRight_(){let e=this.colorFlip_();return e.left.left.isRed_()&&(e=e.rotateRight_(),e=e.colorFlip_()),e}rotateLeft_(){const e=this.copy(null,null,U.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight_(){const e=this.copy(null,null,U.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip_(){const e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth_(){const e=this.check_();return Math.pow(2,e)<=this.count()+1}check_(){if(this.isRed_()&&this.left.isRed_())throw new Error("Red node has red child("+this.key+","+this.value+")");if(this.right.isRed_())throw new Error("Right child of ("+this.key+","+this.value+") is red");const e=this.left.check_();if(e!==this.right.check_())throw new Error("Black depths differ");return e+(this.isRed_()?0:1)}}U.RED=!0;U.BLACK=!1;class bu{copy(e,t,s,i,r){return this}insert(e,t,s){return new U(e,t,null)}remove(e,t){return this}count(){return 0}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}check_(){return 0}isRed_(){return!1}}class q{constructor(e,t=q.EMPTY_NODE){this.comparator_=e,this.root_=t}insert(e,t){return new q(this.comparator_,this.root_.insert(e,t,this.comparator_).copy(null,null,U.BLACK,null,null))}remove(e){return new q(this.comparator_,this.root_.remove(e,this.comparator_).copy(null,null,U.BLACK,null,null))}get(e){let t,s=this.root_;for(;!s.isEmpty();){if(t=this.comparator_(e,s.key),t===0)return s.value;t<0?s=s.left:t>0&&(s=s.right)}return null}getPredecessorKey(e){let t,s=this.root_,i=null;for(;!s.isEmpty();)if(t=this.comparator_(e,s.key),t===0){if(s.left.isEmpty())return i?i.key:null;for(s=s.left;!s.right.isEmpty();)s=s.right;return s.key}else t<0?s=s.left:t>0&&(i=s,s=s.right);throw new Error("Attempted to find predecessor key for a nonexistent key.  What gives?")}isEmpty(){return this.root_.isEmpty()}count(){return this.root_.count()}minKey(){return this.root_.minKey()}maxKey(){return this.root_.maxKey()}inorderTraversal(e){return this.root_.inorderTraversal(e)}reverseTraversal(e){return this.root_.reverseTraversal(e)}getIterator(e){return new Lt(this.root_,null,this.comparator_,!1,e)}getIteratorFrom(e,t){return new Lt(this.root_,e,this.comparator_,!1,t)}getReverseIteratorFrom(e,t){return new Lt(this.root_,e,this.comparator_,!0,t)}getReverseIterator(e){return new Lt(this.root_,null,this.comparator_,!0,e)}}q.EMPTY_NODE=new bu;function wu(n,e){return De(n.name,e.name)}function cs(n,e){return De(n,e)}let Wn;function Iu(n){Wn=n}const Tr=function(n){return typeof n=="number"?"number:"+ir(n):"string:"+n},Nr=function(n){if(n.isLeafNode()){const e=n.val();g(typeof e=="string"||typeof e=="number"||typeof e=="object"&&le(e,".sv"),"Priority must be a string or number.")}else g(n===Wn||n.isEmpty(),"priority of unexpected type.");g(n===Wn||n.getPriority().isEmpty(),"Priority nodes can't have a priority of their own.")};let ci;class G{static set __childrenNodeConstructor(e){ci=e}static get __childrenNodeConstructor(){return ci}constructor(e,t=G.__childrenNodeConstructor.EMPTY_NODE){this.value_=e,this.priorityNode_=t,this.lazyHash_=null,g(this.value_!==void 0&&this.value_!==null,"LeafNode shouldn't be created with null/undefined value."),Nr(this.priorityNode_)}isLeafNode(){return!0}getPriority(){return this.priorityNode_}updatePriority(e){return new G(this.value_,e)}getImmediateChild(e){return e===".priority"?this.priorityNode_:G.__childrenNodeConstructor.EMPTY_NODE}getChild(e){return b(e)?this:S(e)===".priority"?this.priorityNode_:G.__childrenNodeConstructor.EMPTY_NODE}hasChild(){return!1}getPredecessorChildName(e,t){return null}updateImmediateChild(e,t){return e===".priority"?this.updatePriority(t):t.isEmpty()&&e!==".priority"?this:G.__childrenNodeConstructor.EMPTY_NODE.updateImmediateChild(e,t).updatePriority(this.priorityNode_)}updateChild(e,t){const s=S(e);return s===null?t:t.isEmpty()&&s!==".priority"?this:(g(s!==".priority"||ve(e)===1,".priority must be the last token in a path"),this.updateImmediateChild(s,G.__childrenNodeConstructor.EMPTY_NODE.updateChild(D(e),t)))}isEmpty(){return!1}numChildren(){return 0}forEachChild(e,t){return!1}val(e){return e&&!this.getPriority().isEmpty()?{".value":this.getValue(),".priority":this.getPriority().val()}:this.getValue()}hash(){if(this.lazyHash_===null){let e="";this.priorityNode_.isEmpty()||(e+="priority:"+Tr(this.priorityNode_.val())+":");const t=typeof this.value_;e+=t+":",t==="number"?e+=ir(this.value_):e+=this.value_,this.lazyHash_=nr(e)}return this.lazyHash_}getValue(){return this.value_}compareTo(e){return e===G.__childrenNodeConstructor.EMPTY_NODE?1:e instanceof G.__childrenNodeConstructor?-1:(g(e.isLeafNode(),"Unknown node type"),this.compareToLeafNode_(e))}compareToLeafNode_(e){const t=typeof e.value_,s=typeof this.value_,i=G.VALUE_TYPE_ORDER.indexOf(t),r=G.VALUE_TYPE_ORDER.indexOf(s);return g(i>=0,"Unknown leaf type: "+t),g(r>=0,"Unknown leaf type: "+s),i===r?s==="object"?0:this.value_<e.value_?-1:this.value_===e.value_?0:1:r-i}withIndex(){return this}isIndexed(){return!0}equals(e){if(e===this)return!0;if(e.isLeafNode()){const t=e;return this.value_===t.value_&&this.priorityNode_.equals(t.priorityNode_)}else return!1}}G.VALUE_TYPE_ORDER=["object","boolean","number","string"];let Rr,Or;function Tu(n){Rr=n}function Nu(n){Or=n}class Ru extends sn{compare(e,t){const s=e.node.getPriority(),i=t.node.getPriority(),r=s.compareTo(i);return r===0?De(e.name,t.name):r}isDefinedOn(e){return!e.getPriority().isEmpty()}indexedValueChanged(e,t){return!e.getPriority().equals(t.getPriority())}minPost(){return w.MIN}maxPost(){return new w(Oe,new G("[PRIORITY-POST]",Or))}makePost(e,t){const s=Rr(e);return new w(t,new G("[PRIORITY-POST]",s))}toString(){return".priority"}}const x=new Ru;const Ou=Math.log(2);class Au{constructor(e){const t=r=>parseInt(Math.log(r)/Ou,10),s=r=>parseInt(Array(r+1).join("1"),2);this.count=t(e+1),this.current_=this.count-1;const i=s(this.count);this.bits_=e+1&i}nextBitIsOne(){const e=!(this.bits_&1<<this.current_);return this.current_--,e}}const $t=function(n,e,t,s){n.sort(e);const i=function(l,c){const h=c-l;let u,d;if(h===0)return null;if(h===1)return u=n[l],d=t?t(u):u,new U(d,u.node,U.BLACK,null,null);{const p=parseInt(h/2,10)+l,m=i(l,p),_=i(p+1,c);return u=n[p],d=t?t(u):u,new U(d,u.node,U.BLACK,m,_)}},r=function(l){let c=null,h=null,u=n.length;const d=function(m,_){const C=u-m,N=u;u-=m;const E=i(C+1,N),I=n[C],O=t?t(I):I;p(new U(O,I.node,_,null,E))},p=function(m){c?(c.left=m,c=m):(h=m,c=m)};for(let m=0;m<l.count;++m){const _=l.nextBitIsOne(),C=Math.pow(2,l.count-(m+1));_?d(C,U.BLACK):(d(C,U.BLACK),d(C,U.RED))}return h},o=new Au(n.length),a=r(o);return new q(s||e,a)};let wn;const Le={};class ue{static get Default(){return g(Le&&x,"ChildrenNode.ts has not been loaded"),wn=wn||new ue({".priority":Le},{".priority":x}),wn}constructor(e,t){this.indexes_=e,this.indexSet_=t}get(e){const t=$e(this.indexes_,e);if(!t)throw new Error("No index defined for "+e);return t instanceof q?t:null}hasIndex(e){return le(this.indexSet_,e.toString())}addIndex(e,t){g(e!==Ge,"KeyIndex always exists and isn't meant to be added to the IndexMap.");const s=[];let i=!1;const r=t.getIterator(w.Wrap);let o=r.getNext();for(;o;)i=i||e.isDefinedOn(o.node),s.push(o),o=r.getNext();let a;i?a=$t(s,e.getCompare()):a=Le;const l=e.toString(),c={...this.indexSet_};c[l]=e;const h={...this.indexes_};return h[l]=a,new ue(h,c)}addToIndexes(e,t){const s=Bt(this.indexes_,(i,r)=>{const o=$e(this.indexSet_,r);if(g(o,"Missing index implementation for "+r),i===Le)if(o.isDefinedOn(e.node)){const a=[],l=t.getIterator(w.Wrap);let c=l.getNext();for(;c;)c.name!==e.name&&a.push(c),c=l.getNext();return a.push(e),$t(a,o.getCompare())}else return Le;else{const a=t.get(e.name);let l=i;return a&&(l=l.remove(new w(e.name,a))),l.insert(e,e.node)}});return new ue(s,this.indexSet_)}removeFromIndexes(e,t){const s=Bt(this.indexes_,i=>{if(i===Le)return i;{const r=t.get(e.name);return r?i.remove(new w(e.name,r)):i}});return new ue(s,this.indexSet_)}}let it;class y{static get EMPTY_NODE(){return it||(it=new y(new q(cs),null,ue.Default))}constructor(e,t,s){this.children_=e,this.priorityNode_=t,this.indexMap_=s,this.lazyHash_=null,this.priorityNode_&&Nr(this.priorityNode_),this.children_.isEmpty()&&g(!this.priorityNode_||this.priorityNode_.isEmpty(),"An empty node cannot have a priority")}isLeafNode(){return!1}getPriority(){return this.priorityNode_||it}updatePriority(e){return this.children_.isEmpty()?this:new y(this.children_,e,this.indexMap_)}getImmediateChild(e){if(e===".priority")return this.getPriority();{const t=this.children_.get(e);return t===null?it:t}}getChild(e){const t=S(e);return t===null?this:this.getImmediateChild(t).getChild(D(e))}hasChild(e){return this.children_.get(e)!==null}updateImmediateChild(e,t){if(g(t,"We should always be passing snapshot nodes"),e===".priority")return this.updatePriority(t);{const s=new w(e,t);let i,r;t.isEmpty()?(i=this.children_.remove(e),r=this.indexMap_.removeFromIndexes(s,this.children_)):(i=this.children_.insert(e,t),r=this.indexMap_.addToIndexes(s,this.children_));const o=i.isEmpty()?it:this.priorityNode_;return new y(i,o,r)}}updateChild(e,t){const s=S(e);if(s===null)return t;{g(S(e)!==".priority"||ve(e)===1,".priority must be the last token in a path");const i=this.getImmediateChild(s).updateChild(D(e),t);return this.updateImmediateChild(s,i)}}isEmpty(){return this.children_.isEmpty()}numChildren(){return this.children_.count()}val(e){if(this.isEmpty())return null;const t={};let s=0,i=0,r=!0;if(this.forEachChild(x,(o,a)=>{t[o]=a.val(e),s++,r&&y.INTEGER_REGEXP_.test(o)?i=Math.max(i,Number(o)):r=!1}),!e&&r&&i<2*s){const o=[];for(const a in t)o[a]=t[a];return o}else return e&&!this.getPriority().isEmpty()&&(t[".priority"]=this.getPriority().val()),t}hash(){if(this.lazyHash_===null){let e="";this.getPriority().isEmpty()||(e+="priority:"+Tr(this.getPriority().val())+":"),this.forEachChild(x,(t,s)=>{const i=s.hash();i!==""&&(e+=":"+t+":"+i)}),this.lazyHash_=e===""?"":nr(e)}return this.lazyHash_}getPredecessorChildName(e,t,s){const i=this.resolveIndex_(s);if(i){const r=i.getPredecessorKey(new w(e,t));return r?r.name:null}else return this.children_.getPredecessorKey(e)}getFirstChildName(e){const t=this.resolveIndex_(e);if(t){const s=t.minKey();return s&&s.name}else return this.children_.minKey()}getFirstChild(e){const t=this.getFirstChildName(e);return t?new w(t,this.children_.get(t)):null}getLastChildName(e){const t=this.resolveIndex_(e);if(t){const s=t.maxKey();return s&&s.name}else return this.children_.maxKey()}getLastChild(e){const t=this.getLastChildName(e);return t?new w(t,this.children_.get(t)):null}forEachChild(e,t){const s=this.resolveIndex_(e);return s?s.inorderTraversal(i=>t(i.name,i.node)):this.children_.inorderTraversal(t)}getIterator(e){return this.getIteratorFrom(e.minPost(),e)}getIteratorFrom(e,t){const s=this.resolveIndex_(t);if(s)return s.getIteratorFrom(e,i=>i);{const i=this.children_.getIteratorFrom(e.name,w.Wrap);let r=i.peek();for(;r!=null&&t.compare(r,e)<0;)i.getNext(),r=i.peek();return i}}getReverseIterator(e){return this.getReverseIteratorFrom(e.maxPost(),e)}getReverseIteratorFrom(e,t){const s=this.resolveIndex_(t);if(s)return s.getReverseIteratorFrom(e,i=>i);{const i=this.children_.getReverseIteratorFrom(e.name,w.Wrap);let r=i.peek();for(;r!=null&&t.compare(r,e)>0;)i.getNext(),r=i.peek();return i}}compareTo(e){return this.isEmpty()?e.isEmpty()?0:-1:e.isLeafNode()||e.isEmpty()?1:e===Ot?-1:0}withIndex(e){if(e===Ge||this.indexMap_.hasIndex(e))return this;{const t=this.indexMap_.addIndex(e,this.children_);return new y(this.children_,this.priorityNode_,t)}}isIndexed(e){return e===Ge||this.indexMap_.hasIndex(e)}equals(e){if(e===this)return!0;if(e.isLeafNode())return!1;{const t=e;if(this.getPriority().equals(t.getPriority()))if(this.children_.count()===t.children_.count()){const s=this.getIterator(x),i=t.getIterator(x);let r=s.getNext(),o=i.getNext();for(;r&&o;){if(r.name!==o.name||!r.node.equals(o.node))return!1;r=s.getNext(),o=i.getNext()}return r===null&&o===null}else return!1;else return!1}}resolveIndex_(e){return e===Ge?null:this.indexMap_.get(e.toString())}}y.INTEGER_REGEXP_=/^(0|[1-9]\d*)$/;class ku extends y{constructor(){super(new q(cs),y.EMPTY_NODE,ue.Default)}compareTo(e){return e===this?0:1}equals(e){return e===this}getPriority(){return this}getImmediateChild(e){return y.EMPTY_NODE}isEmpty(){return!1}}const Ot=new ku;Object.defineProperties(w,{MIN:{value:new w(Ke,y.EMPTY_NODE)},MAX:{value:new w(Oe,Ot)}});Ir.__EMPTY_NODE=y.EMPTY_NODE;G.__childrenNodeConstructor=y;Iu(Ot);Nu(Ot);const Du=!0;function B(n,e=null){if(n===null)return y.EMPTY_NODE;if(typeof n=="object"&&".priority"in n&&(e=n[".priority"]),g(e===null||typeof e=="string"||typeof e=="number"||typeof e=="object"&&".sv"in e,"Invalid priority type found: "+typeof e),typeof n=="object"&&".value"in n&&n[".value"]!==null&&(n=n[".value"]),typeof n!="object"||".sv"in n){const t=n;return new G(t,B(e))}if(!(n instanceof Array)&&Du){const t=[];let s=!1;if($(n,(o,a)=>{if(o.substring(0,1)!=="."){const l=B(a);l.isEmpty()||(s=s||!l.getPriority().isEmpty(),t.push(new w(o,l)))}}),t.length===0)return y.EMPTY_NODE;const r=$t(t,wu,o=>o.name,cs);if(s){const o=$t(t,x.getCompare());return new y(r,B(e),new ue({".priority":o},{".priority":x}))}else return new y(r,B(e),ue.Default)}else{let t=y.EMPTY_NODE;return $(n,(s,i)=>{if(le(n,s)&&s.substring(0,1)!=="."){const r=B(i);(r.isLeafNode()||!r.isEmpty())&&(t=t.updateImmediateChild(s,r))}}),t.updatePriority(B(e))}}Tu(B);class Mu extends sn{constructor(e){super(),this.indexPath_=e,g(!b(e)&&S(e)!==".priority","Can't create PathIndex with empty path or .priority key")}extractChild(e){return e.getChild(this.indexPath_)}isDefinedOn(e){return!e.getChild(this.indexPath_).isEmpty()}compare(e,t){const s=this.extractChild(e.node),i=this.extractChild(t.node),r=s.compareTo(i);return r===0?De(e.name,t.name):r}makePost(e,t){const s=B(e),i=y.EMPTY_NODE.updateChild(this.indexPath_,s);return new w(t,i)}maxPost(){const e=y.EMPTY_NODE.updateChild(this.indexPath_,Ot);return new w(Oe,e)}toString(){return yt(this.indexPath_,0).join("/")}}class Lu extends sn{compare(e,t){const s=e.node.compareTo(t.node);return s===0?De(e.name,t.name):s}isDefinedOn(e){return!0}indexedValueChanged(e,t){return!e.equals(t)}minPost(){return w.MIN}maxPost(){return w.MAX}makePost(e,t){const s=B(e);return new w(t,s)}toString(){return".value"}}const Pu=new Lu;function Ar(n){return{type:"value",snapshotNode:n}}function Ye(n,e){return{type:"child_added",snapshotNode:e,childName:n}}function Et(n,e){return{type:"child_removed",snapshotNode:e,childName:n}}function Ct(n,e,t){return{type:"child_changed",snapshotNode:e,childName:n,oldSnap:t}}function xu(n,e){return{type:"child_moved",snapshotNode:e,childName:n}}class us{constructor(e){this.index_=e}updateChild(e,t,s,i,r,o){g(e.isIndexed(this.index_),"A node must be indexed if only a child is updated");const a=e.getImmediateChild(t);return a.getChild(i).equals(s.getChild(i))&&a.isEmpty()===s.isEmpty()||(o!=null&&(s.isEmpty()?e.hasChild(t)?o.trackChildChange(Et(t,a)):g(e.isLeafNode(),"A child remove without an old child only makes sense on a leaf node"):a.isEmpty()?o.trackChildChange(Ye(t,s)):o.trackChildChange(Ct(t,s,a))),e.isLeafNode()&&s.isEmpty())?e:e.updateImmediateChild(t,s).withIndex(this.index_)}updateFullNode(e,t,s){return s!=null&&(e.isLeafNode()||e.forEachChild(x,(i,r)=>{t.hasChild(i)||s.trackChildChange(Et(i,r))}),t.isLeafNode()||t.forEachChild(x,(i,r)=>{if(e.hasChild(i)){const o=e.getImmediateChild(i);o.equals(r)||s.trackChildChange(Ct(i,r,o))}else s.trackChildChange(Ye(i,r))})),t.withIndex(this.index_)}updatePriority(e,t){return e.isEmpty()?y.EMPTY_NODE:e.updatePriority(t)}filtersNodes(){return!1}getIndexedFilter(){return this}getIndex(){return this.index_}}class vt{constructor(e){this.indexedFilter_=new us(e.getIndex()),this.index_=e.getIndex(),this.startPost_=vt.getStartPost_(e),this.endPost_=vt.getEndPost_(e),this.startIsInclusive_=!e.startAfterSet_,this.endIsInclusive_=!e.endBeforeSet_}getStartPost(){return this.startPost_}getEndPost(){return this.endPost_}matches(e){const t=this.startIsInclusive_?this.index_.compare(this.getStartPost(),e)<=0:this.index_.compare(this.getStartPost(),e)<0,s=this.endIsInclusive_?this.index_.compare(e,this.getEndPost())<=0:this.index_.compare(e,this.getEndPost())<0;return t&&s}updateChild(e,t,s,i,r,o){return this.matches(new w(t,s))||(s=y.EMPTY_NODE),this.indexedFilter_.updateChild(e,t,s,i,r,o)}updateFullNode(e,t,s){t.isLeafNode()&&(t=y.EMPTY_NODE);let i=t.withIndex(this.index_);i=i.updatePriority(y.EMPTY_NODE);const r=this;return t.forEachChild(x,(o,a)=>{r.matches(new w(o,a))||(i=i.updateImmediateChild(o,y.EMPTY_NODE))}),this.indexedFilter_.updateFullNode(e,i,s)}updatePriority(e,t){return e}filtersNodes(){return!0}getIndexedFilter(){return this.indexedFilter_}getIndex(){return this.index_}static getStartPost_(e){if(e.hasStart()){const t=e.getIndexStartName();return e.getIndex().makePost(e.getIndexStartValue(),t)}else return e.getIndex().minPost()}static getEndPost_(e){if(e.hasEnd()){const t=e.getIndexEndName();return e.getIndex().makePost(e.getIndexEndValue(),t)}else return e.getIndex().maxPost()}}class Bu{constructor(e){this.withinDirectionalStart=t=>this.reverse_?this.withinEndPost(t):this.withinStartPost(t),this.withinDirectionalEnd=t=>this.reverse_?this.withinStartPost(t):this.withinEndPost(t),this.withinStartPost=t=>{const s=this.index_.compare(this.rangedFilter_.getStartPost(),t);return this.startIsInclusive_?s<=0:s<0},this.withinEndPost=t=>{const s=this.index_.compare(t,this.rangedFilter_.getEndPost());return this.endIsInclusive_?s<=0:s<0},this.rangedFilter_=new vt(e),this.index_=e.getIndex(),this.limit_=e.getLimit(),this.reverse_=!e.isViewFromLeft(),this.startIsInclusive_=!e.startAfterSet_,this.endIsInclusive_=!e.endBeforeSet_}updateChild(e,t,s,i,r,o){return this.rangedFilter_.matches(new w(t,s))||(s=y.EMPTY_NODE),e.getImmediateChild(t).equals(s)?e:e.numChildren()<this.limit_?this.rangedFilter_.getIndexedFilter().updateChild(e,t,s,i,r,o):this.fullLimitUpdateChild_(e,t,s,r,o)}updateFullNode(e,t,s){let i;if(t.isLeafNode()||t.isEmpty())i=y.EMPTY_NODE.withIndex(this.index_);else if(this.limit_*2<t.numChildren()&&t.isIndexed(this.index_)){i=y.EMPTY_NODE.withIndex(this.index_);let r;this.reverse_?r=t.getReverseIteratorFrom(this.rangedFilter_.getEndPost(),this.index_):r=t.getIteratorFrom(this.rangedFilter_.getStartPost(),this.index_);let o=0;for(;r.hasNext()&&o<this.limit_;){const a=r.getNext();if(this.withinDirectionalStart(a))if(this.withinDirectionalEnd(a))i=i.updateImmediateChild(a.name,a.node),o++;else break;else continue}}else{i=t.withIndex(this.index_),i=i.updatePriority(y.EMPTY_NODE);let r;this.reverse_?r=i.getReverseIterator(this.index_):r=i.getIterator(this.index_);let o=0;for(;r.hasNext();){const a=r.getNext();o<this.limit_&&this.withinDirectionalStart(a)&&this.withinDirectionalEnd(a)?o++:i=i.updateImmediateChild(a.name,y.EMPTY_NODE)}}return this.rangedFilter_.getIndexedFilter().updateFullNode(e,i,s)}updatePriority(e,t){return e}filtersNodes(){return!0}getIndexedFilter(){return this.rangedFilter_.getIndexedFilter()}getIndex(){return this.index_}fullLimitUpdateChild_(e,t,s,i,r){let o;if(this.reverse_){const u=this.index_.getCompare();o=(d,p)=>u(p,d)}else o=this.index_.getCompare();const a=e;g(a.numChildren()===this.limit_,"");const l=new w(t,s),c=this.reverse_?a.getFirstChild(this.index_):a.getLastChild(this.index_),h=this.rangedFilter_.matches(l);if(a.hasChild(t)){const u=a.getImmediateChild(t);let d=i.getChildAfterChild(this.index_,c,this.reverse_);for(;d!=null&&(d.name===t||a.hasChild(d.name));)d=i.getChildAfterChild(this.index_,d,this.reverse_);const p=d==null?1:o(d,l);if(h&&!s.isEmpty()&&p>=0)return r?.trackChildChange(Ct(t,s,u)),a.updateImmediateChild(t,s);{r?.trackChildChange(Et(t,u));const _=a.updateImmediateChild(t,y.EMPTY_NODE);return d!=null&&this.rangedFilter_.matches(d)?(r?.trackChildChange(Ye(d.name,d.node)),_.updateImmediateChild(d.name,d.node)):_}}else return s.isEmpty()?e:h&&o(c,l)>=0?(r!=null&&(r.trackChildChange(Et(c.name,c.node)),r.trackChildChange(Ye(t,s))),a.updateImmediateChild(t,s).updateImmediateChild(c.name,y.EMPTY_NODE)):e}}class ds{constructor(){this.limitSet_=!1,this.startSet_=!1,this.startNameSet_=!1,this.startAfterSet_=!1,this.endSet_=!1,this.endNameSet_=!1,this.endBeforeSet_=!1,this.limit_=0,this.viewFrom_="",this.indexStartValue_=null,this.indexStartName_="",this.indexEndValue_=null,this.indexEndName_="",this.index_=x}hasStart(){return this.startSet_}isViewFromLeft(){return this.viewFrom_===""?this.startSet_:this.viewFrom_==="l"}getIndexStartValue(){return g(this.startSet_,"Only valid if start has been set"),this.indexStartValue_}getIndexStartName(){return g(this.startSet_,"Only valid if start has been set"),this.startNameSet_?this.indexStartName_:Ke}hasEnd(){return this.endSet_}getIndexEndValue(){return g(this.endSet_,"Only valid if end has been set"),this.indexEndValue_}getIndexEndName(){return g(this.endSet_,"Only valid if end has been set"),this.endNameSet_?this.indexEndName_:Oe}hasLimit(){return this.limitSet_}hasAnchoredLimit(){return this.limitSet_&&this.viewFrom_!==""}getLimit(){return g(this.limitSet_,"Only valid if limit has been set"),this.limit_}getIndex(){return this.index_}loadsAllData(){return!(this.startSet_||this.endSet_||this.limitSet_)}isDefault(){return this.loadsAllData()&&this.index_===x}copy(){const e=new ds;return e.limitSet_=this.limitSet_,e.limit_=this.limit_,e.startSet_=this.startSet_,e.startAfterSet_=this.startAfterSet_,e.indexStartValue_=this.indexStartValue_,e.startNameSet_=this.startNameSet_,e.indexStartName_=this.indexStartName_,e.endSet_=this.endSet_,e.endBeforeSet_=this.endBeforeSet_,e.indexEndValue_=this.indexEndValue_,e.endNameSet_=this.endNameSet_,e.indexEndName_=this.indexEndName_,e.index_=this.index_,e.viewFrom_=this.viewFrom_,e}}function Fu(n){return n.loadsAllData()?new us(n.getIndex()):n.hasLimit()?new Bu(n):new vt(n)}function ui(n){const e={};if(n.isDefault())return e;let t;if(n.index_===x?t="$priority":n.index_===Pu?t="$value":n.index_===Ge?t="$key":(g(n.index_ instanceof Mu,"Unrecognized index type!"),t=n.index_.toString()),e.orderBy=W(t),n.startSet_){const s=n.startAfterSet_?"startAfter":"startAt";e[s]=W(n.indexStartValue_),n.startNameSet_&&(e[s]+=","+W(n.indexStartName_))}if(n.endSet_){const s=n.endBeforeSet_?"endBefore":"endAt";e[s]=W(n.indexEndValue_),n.endNameSet_&&(e[s]+=","+W(n.indexEndName_))}return n.limitSet_&&(n.isViewFromLeft()?e.limitToFirst=n.limit_:e.limitToLast=n.limit_),e}function di(n){const e={};if(n.startSet_&&(e.sp=n.indexStartValue_,n.startNameSet_&&(e.sn=n.indexStartName_),e.sin=!n.startAfterSet_),n.endSet_&&(e.ep=n.indexEndValue_,n.endNameSet_&&(e.en=n.indexEndName_),e.ein=!n.endBeforeSet_),n.limitSet_){e.l=n.limit_;let t=n.viewFrom_;t===""&&(n.isViewFromLeft()?t="l":t="r"),e.vf=t}return n.index_!==x&&(e.i=n.index_.toString()),e}class Vt extends vr{reportStats(e){throw new Error("Method not implemented.")}static getListenId_(e,t){return t!==void 0?"tag$"+t:(g(e._queryParams.isDefault(),"should have a tag if it's not a default query."),e._path.toString())}constructor(e,t,s,i){super(),this.repoInfo_=e,this.onDataUpdate_=t,this.authTokenProvider_=s,this.appCheckTokenProvider_=i,this.log_=Rt("p:rest:"),this.listens_={}}listen(e,t,s,i){const r=e._path.toString();this.log_("Listen called for "+r+" "+e._queryIdentifier);const o=Vt.getListenId_(e,s),a={};this.listens_[o]=a;const l=ui(e._queryParams);this.restRequest_(r+".json",l,(c,h)=>{let u=h;if(c===404&&(u=null,c=null),c===null&&this.onDataUpdate_(r,u,!1,s),$e(this.listens_,o)===a){let d;c?c===401?d="permission_denied":d="rest_error:"+c:d="ok",i(d,null)}})}unlisten(e,t){const s=Vt.getListenId_(e,t);delete this.listens_[s]}get(e){const t=ui(e._queryParams),s=e._path.toString(),i=new re;return this.restRequest_(s+".json",t,(r,o)=>{let a=o;r===404&&(a=null,r=null),r===null?(this.onDataUpdate_(s,a,!1,null),i.resolve(a)):i.reject(new Error(a))}),i.promise}refreshAuthToken(e){}restRequest_(e,t={},s){return t.format="export",Promise.all([this.authTokenProvider_.getToken(!1),this.appCheckTokenProvider_.getToken(!1)]).then(([i,r])=>{i&&i.accessToken&&(t.auth=i.accessToken),r&&r.token&&(t.ac=r.token);const o=(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host+e+"?ns="+this.repoInfo_.namespace+ll(t);this.log_("Sending REST request for "+o);const a=new XMLHttpRequest;a.onreadystatechange=()=>{if(s&&a.readyState===4){this.log_("REST Response for "+o+" received. status:",a.status,"response:",a.responseText);let l=null;if(a.status>=200&&a.status<300){try{l=pt(a.responseText)}catch{K("Failed to parse JSON response for "+o+": "+a.responseText)}s(null,l)}else a.status!==401&&a.status!==404&&K("Got unsuccessful REST response for "+o+" Status: "+a.status),s(a.status);s=null}},a.open("GET",o,!0),a.send()})}}class Wu{constructor(){this.rootNode_=y.EMPTY_NODE}getNode(e){return this.rootNode_.getChild(e)}updateSnapshot(e,t){this.rootNode_=this.rootNode_.updateChild(e,t)}}function Kt(){return{value:null,children:new Map}}function Ze(n,e,t){if(b(e))n.value=t,n.children.clear();else if(n.value!==null)n.value=n.value.updateChild(e,t);else{const s=S(e);n.children.has(s)||n.children.set(s,Kt());const i=n.children.get(s);e=D(e),Ze(i,e,t)}}function Gn(n,e){if(b(e))return n.value=null,n.children.clear(),!0;if(n.value!==null){if(n.value.isLeafNode())return!1;{const t=n.value;return n.value=null,t.forEachChild(x,(s,i)=>{Ze(n,new k(s),i)}),Gn(n,e)}}else if(n.children.size>0){const t=S(e);return e=D(e),n.children.has(t)&&Gn(n.children.get(t),e)&&n.children.delete(t),n.children.size===0}else return!0}function Un(n,e,t){n.value!==null?t(e,n.value):Gu(n,(s,i)=>{const r=new k(e.toString()+"/"+s);Un(i,r,t)})}function Gu(n,e){n.children.forEach((t,s)=>{e(s,t)})}class Uu{constructor(e){this.collection_=e,this.last_=null}get(){const e=this.collection_.get(),t={...e};return this.last_&&$(this.last_,(s,i)=>{t[s]=t[s]-i}),this.last_=e,t}}const hi=10*1e3,Hu=30*1e3,$u=300*1e3;class Vu{constructor(e,t){this.server_=t,this.statsToReport_={},this.statsListener_=new Uu(e);const s=hi+(Hu-hi)*Math.random();ut(this.reportStats_.bind(this),Math.floor(s))}reportStats_(){const e=this.statsListener_.get(),t={};let s=!1;$(e,(i,r)=>{r>0&&le(this.statsToReport_,i)&&(t[i]=r,s=!0)}),s&&this.server_.reportStats(t),ut(this.reportStats_.bind(this),Math.floor(Math.random()*2*$u))}}var se;(function(n){n[n.OVERWRITE=0]="OVERWRITE",n[n.MERGE=1]="MERGE",n[n.ACK_USER_WRITE=2]="ACK_USER_WRITE",n[n.LISTEN_COMPLETE=3]="LISTEN_COMPLETE"})(se||(se={}));function hs(){return{fromUser:!0,fromServer:!1,queryId:null,tagged:!1}}function fs(){return{fromUser:!1,fromServer:!0,queryId:null,tagged:!1}}function ps(n){return{fromUser:!1,fromServer:!0,queryId:n,tagged:!0}}class Yt{constructor(e,t,s){this.path=e,this.affectedTree=t,this.revert=s,this.type=se.ACK_USER_WRITE,this.source=hs()}operationForChild(e){if(b(this.path)){if(this.affectedTree.value!=null)return g(this.affectedTree.children.isEmpty(),"affectedTree should not have overlapping affected paths."),this;{const t=this.affectedTree.subtree(new k(e));return new Yt(R(),t,this.revert)}}else return g(S(this.path)===e,"operationForChild called for unrelated child."),new Yt(D(this.path),this.affectedTree,this.revert)}}class St{constructor(e,t){this.source=e,this.path=t,this.type=se.LISTEN_COMPLETE}operationForChild(e){return b(this.path)?new St(this.source,R()):new St(this.source,D(this.path))}}class Ae{constructor(e,t,s){this.source=e,this.path=t,this.snap=s,this.type=se.OVERWRITE}operationForChild(e){return b(this.path)?new Ae(this.source,R(),this.snap.getImmediateChild(e)):new Ae(this.source,D(this.path),this.snap)}}class je{constructor(e,t,s){this.source=e,this.path=t,this.children=s,this.type=se.MERGE}operationForChild(e){if(b(this.path)){const t=this.children.subtree(new k(e));return t.isEmpty()?null:t.value?new Ae(this.source,R(),t.value):new je(this.source,R(),t)}else return g(S(this.path)===e,"Can't get a merge for a child not on the path of the operation"),new je(this.source,D(this.path),this.children)}toString(){return"Operation("+this.path+": "+this.source.toString()+" merge: "+this.children.toString()+")"}}class Se{constructor(e,t,s){this.node_=e,this.fullyInitialized_=t,this.filtered_=s}isFullyInitialized(){return this.fullyInitialized_}isFiltered(){return this.filtered_}isCompleteForPath(e){if(b(e))return this.isFullyInitialized()&&!this.filtered_;const t=S(e);return this.isCompleteForChild(t)}isCompleteForChild(e){return this.isFullyInitialized()&&!this.filtered_||this.node_.hasChild(e)}getNode(){return this.node_}}class Ku{constructor(e){this.query_=e,this.index_=this.query_._queryParams.getIndex()}}function Yu(n,e,t,s){const i=[],r=[];return e.forEach(o=>{o.type==="child_changed"&&n.index_.indexedValueChanged(o.oldSnap,o.snapshotNode)&&r.push(xu(o.childName,o.snapshotNode))}),rt(n,i,"child_removed",e,s,t),rt(n,i,"child_added",e,s,t),rt(n,i,"child_moved",r,s,t),rt(n,i,"child_changed",e,s,t),rt(n,i,"value",e,s,t),i}function rt(n,e,t,s,i,r){const o=s.filter(a=>a.type===t);o.sort((a,l)=>qu(n,a,l)),o.forEach(a=>{const l=ju(n,a,r);i.forEach(c=>{c.respondsTo(a.type)&&e.push(c.createEvent(l,n.query_))})})}function ju(n,e,t){return e.type==="value"||e.type==="child_removed"||(e.prevName=t.getPredecessorChildName(e.childName,e.snapshotNode,n.index_)),e}function qu(n,e,t){if(e.childName==null||t.childName==null)throw Xe("Should only compare child_ events.");const s=new w(e.childName,e.snapshotNode),i=new w(t.childName,t.snapshotNode);return n.index_.compare(s,i)}function rn(n,e){return{eventCache:n,serverCache:e}}function dt(n,e,t,s){return rn(new Se(e,t,s),n.serverCache)}function kr(n,e,t,s){return rn(n.eventCache,new Se(e,t,s))}function jt(n){return n.eventCache.isFullyInitialized()?n.eventCache.getNode():null}function ke(n){return n.serverCache.isFullyInitialized()?n.serverCache.getNode():null}let In;const zu=()=>(In||(In=new q(Mc)),In);class M{static fromObject(e){let t=new M(null);return $(e,(s,i)=>{t=t.set(new k(s),i)}),t}constructor(e,t=zu()){this.value=e,this.children=t}isEmpty(){return this.value===null&&this.children.isEmpty()}findRootMostMatchingPathAndValue(e,t){if(this.value!=null&&t(this.value))return{path:R(),value:this.value};if(b(e))return null;{const s=S(e),i=this.children.get(s);if(i!==null){const r=i.findRootMostMatchingPathAndValue(D(e),t);return r!=null?{path:P(new k(s),r.path),value:r.value}:null}else return null}}findRootMostValueAndPath(e){return this.findRootMostMatchingPathAndValue(e,()=>!0)}subtree(e){if(b(e))return this;{const t=S(e),s=this.children.get(t);return s!==null?s.subtree(D(e)):new M(null)}}set(e,t){if(b(e))return new M(t,this.children);{const s=S(e),r=(this.children.get(s)||new M(null)).set(D(e),t),o=this.children.insert(s,r);return new M(this.value,o)}}remove(e){if(b(e))return this.children.isEmpty()?new M(null):new M(null,this.children);{const t=S(e),s=this.children.get(t);if(s){const i=s.remove(D(e));let r;return i.isEmpty()?r=this.children.remove(t):r=this.children.insert(t,i),this.value===null&&r.isEmpty()?new M(null):new M(this.value,r)}else return this}}get(e){if(b(e))return this.value;{const t=S(e),s=this.children.get(t);return s?s.get(D(e)):null}}setTree(e,t){if(b(e))return t;{const s=S(e),r=(this.children.get(s)||new M(null)).setTree(D(e),t);let o;return r.isEmpty()?o=this.children.remove(s):o=this.children.insert(s,r),new M(this.value,o)}}fold(e){return this.fold_(R(),e)}fold_(e,t){const s={};return this.children.inorderTraversal((i,r)=>{s[i]=r.fold_(P(e,i),t)}),t(e,this.value,s)}findOnPath(e,t){return this.findOnPath_(e,R(),t)}findOnPath_(e,t,s){const i=this.value?s(t,this.value):!1;if(i)return i;if(b(e))return null;{const r=S(e),o=this.children.get(r);return o?o.findOnPath_(D(e),P(t,r),s):null}}foreachOnPath(e,t){return this.foreachOnPath_(e,R(),t)}foreachOnPath_(e,t,s){if(b(e))return this;{this.value&&s(t,this.value);const i=S(e),r=this.children.get(i);return r?r.foreachOnPath_(D(e),P(t,i),s):new M(null)}}foreach(e){this.foreach_(R(),e)}foreach_(e,t){this.children.inorderTraversal((s,i)=>{i.foreach_(P(e,s),t)}),this.value&&t(e,this.value)}foreachChild(e){this.children.inorderTraversal((t,s)=>{s.value&&e(t,s.value)})}}class ie{constructor(e){this.writeTree_=e}static empty(){return new ie(new M(null))}}function ht(n,e,t){if(b(e))return new ie(new M(t));{const s=n.writeTree_.findRootMostValueAndPath(e);if(s!=null){const i=s.path;let r=s.value;const o=V(i,e);return r=r.updateChild(o,t),new ie(n.writeTree_.set(i,r))}else{const i=new M(t),r=n.writeTree_.setTree(e,i);return new ie(r)}}}function Hn(n,e,t){let s=n;return $(t,(i,r)=>{s=ht(s,P(e,i),r)}),s}function fi(n,e){if(b(e))return ie.empty();{const t=n.writeTree_.setTree(e,new M(null));return new ie(t)}}function $n(n,e){return Me(n,e)!=null}function Me(n,e){const t=n.writeTree_.findRootMostValueAndPath(e);return t!=null?n.writeTree_.get(t.path).getChild(V(t.path,e)):null}function pi(n){const e=[],t=n.writeTree_.value;return t!=null?t.isLeafNode()||t.forEachChild(x,(s,i)=>{e.push(new w(s,i))}):n.writeTree_.children.inorderTraversal((s,i)=>{i.value!=null&&e.push(new w(s,i.value))}),e}function Ee(n,e){if(b(e))return n;{const t=Me(n,e);return t!=null?new ie(new M(t)):new ie(n.writeTree_.subtree(e))}}function Vn(n){return n.writeTree_.isEmpty()}function qe(n,e){return Dr(R(),n.writeTree_,e)}function Dr(n,e,t){if(e.value!=null)return t.updateChild(n,e.value);{let s=null;return e.children.inorderTraversal((i,r)=>{i===".priority"?(g(r.value!==null,"Priority writes must always be leaf nodes"),s=r.value):t=Dr(P(n,i),r,t)}),!t.getChild(n).isEmpty()&&s!==null&&(t=t.updateChild(P(n,".priority"),s)),t}}function on(n,e){return xr(e,n)}function Qu(n,e,t,s,i){g(s>n.lastWriteId,"Stacking an older write on top of newer ones"),i===void 0&&(i=!0),n.allWrites.push({path:e,snap:t,writeId:s,visible:i}),i&&(n.visibleWrites=ht(n.visibleWrites,e,t)),n.lastWriteId=s}function Xu(n,e,t,s){g(s>n.lastWriteId,"Stacking an older merge on top of newer ones"),n.allWrites.push({path:e,children:t,writeId:s,visible:!0}),n.visibleWrites=Hn(n.visibleWrites,e,t),n.lastWriteId=s}function Ju(n,e){for(let t=0;t<n.allWrites.length;t++){const s=n.allWrites[t];if(s.writeId===e)return s}return null}function Zu(n,e){const t=n.allWrites.findIndex(a=>a.writeId===e);g(t>=0,"removeWrite called with nonexistent writeId.");const s=n.allWrites[t];n.allWrites.splice(t,1);let i=s.visible,r=!1,o=n.allWrites.length-1;for(;i&&o>=0;){const a=n.allWrites[o];a.visible&&(o>=t&&ed(a,s.path)?i=!1:ee(s.path,a.path)&&(r=!0)),o--}if(i){if(r)return td(n),!0;if(s.snap)n.visibleWrites=fi(n.visibleWrites,s.path);else{const a=s.children;$(a,l=>{n.visibleWrites=fi(n.visibleWrites,P(s.path,l))})}return!0}else return!1}function ed(n,e){if(n.snap)return ee(n.path,e);for(const t in n.children)if(n.children.hasOwnProperty(t)&&ee(P(n.path,t),e))return!0;return!1}function td(n){n.visibleWrites=Mr(n.allWrites,nd,R()),n.allWrites.length>0?n.lastWriteId=n.allWrites[n.allWrites.length-1].writeId:n.lastWriteId=-1}function nd(n){return n.visible}function Mr(n,e,t){let s=ie.empty();for(let i=0;i<n.length;++i){const r=n[i];if(e(r)){const o=r.path;let a;if(r.snap)ee(t,o)?(a=V(t,o),s=ht(s,a,r.snap)):ee(o,t)&&(a=V(o,t),s=ht(s,R(),r.snap.getChild(a)));else if(r.children){if(ee(t,o))a=V(t,o),s=Hn(s,a,r.children);else if(ee(o,t))if(a=V(o,t),b(a))s=Hn(s,R(),r.children);else{const l=$e(r.children,S(a));if(l){const c=l.getChild(D(a));s=ht(s,R(),c)}}}else throw Xe("WriteRecord should have .snap or .children")}}return s}function Lr(n,e,t,s,i){if(!s&&!i){const r=Me(n.visibleWrites,e);if(r!=null)return r;{const o=Ee(n.visibleWrites,e);if(Vn(o))return t;if(t==null&&!$n(o,R()))return null;{const a=t||y.EMPTY_NODE;return qe(o,a)}}}else{const r=Ee(n.visibleWrites,e);if(!i&&Vn(r))return t;if(!i&&t==null&&!$n(r,R()))return null;{const o=function(c){return(c.visible||i)&&(!s||!~s.indexOf(c.writeId))&&(ee(c.path,e)||ee(e,c.path))},a=Mr(n.allWrites,o,e),l=t||y.EMPTY_NODE;return qe(a,l)}}}function sd(n,e,t){let s=y.EMPTY_NODE;const i=Me(n.visibleWrites,e);if(i)return i.isLeafNode()||i.forEachChild(x,(r,o)=>{s=s.updateImmediateChild(r,o)}),s;if(t){const r=Ee(n.visibleWrites,e);return t.forEachChild(x,(o,a)=>{const l=qe(Ee(r,new k(o)),a);s=s.updateImmediateChild(o,l)}),pi(r).forEach(o=>{s=s.updateImmediateChild(o.name,o.node)}),s}else{const r=Ee(n.visibleWrites,e);return pi(r).forEach(o=>{s=s.updateImmediateChild(o.name,o.node)}),s}}function id(n,e,t,s,i){g(s||i,"Either existingEventSnap or existingServerSnap must exist");const r=P(e,t);if($n(n.visibleWrites,r))return null;{const o=Ee(n.visibleWrites,r);return Vn(o)?i.getChild(t):qe(o,i.getChild(t))}}function rd(n,e,t,s){const i=P(e,t),r=Me(n.visibleWrites,i);if(r!=null)return r;if(s.isCompleteForChild(t)){const o=Ee(n.visibleWrites,i);return qe(o,s.getNode().getImmediateChild(t))}else return null}function od(n,e){return Me(n.visibleWrites,e)}function ad(n,e,t,s,i,r,o){let a;const l=Ee(n.visibleWrites,e),c=Me(l,R());if(c!=null)a=c;else if(t!=null)a=qe(l,t);else return[];if(a=a.withIndex(o),!a.isEmpty()&&!a.isLeafNode()){const h=[],u=o.getCompare(),d=r?a.getReverseIteratorFrom(s,o):a.getIteratorFrom(s,o);let p=d.getNext();for(;p&&h.length<i;)u(p,s)!==0&&h.push(p),p=d.getNext();return h}else return[]}function ld(){return{visibleWrites:ie.empty(),allWrites:[],lastWriteId:-1}}function qt(n,e,t,s){return Lr(n.writeTree,n.treePath,e,t,s)}function ms(n,e){return sd(n.writeTree,n.treePath,e)}function mi(n,e,t,s){return id(n.writeTree,n.treePath,e,t,s)}function zt(n,e){return od(n.writeTree,P(n.treePath,e))}function cd(n,e,t,s,i,r){return ad(n.writeTree,n.treePath,e,t,s,i,r)}function gs(n,e,t){return rd(n.writeTree,n.treePath,e,t)}function Pr(n,e){return xr(P(n.treePath,e),n.writeTree)}function xr(n,e){return{treePath:n,writeTree:e}}class ud{constructor(){this.changeMap=new Map}trackChildChange(e){const t=e.type,s=e.childName;g(t==="child_added"||t==="child_changed"||t==="child_removed","Only child changes supported for tracking"),g(s!==".priority","Only non-priority child changes can be tracked.");const i=this.changeMap.get(s);if(i){const r=i.type;if(t==="child_added"&&r==="child_removed")this.changeMap.set(s,Ct(s,e.snapshotNode,i.snapshotNode));else if(t==="child_removed"&&r==="child_added")this.changeMap.delete(s);else if(t==="child_removed"&&r==="child_changed")this.changeMap.set(s,Et(s,i.oldSnap));else if(t==="child_changed"&&r==="child_added")this.changeMap.set(s,Ye(s,e.snapshotNode));else if(t==="child_changed"&&r==="child_changed")this.changeMap.set(s,Ct(s,e.snapshotNode,i.oldSnap));else throw Xe("Illegal combination of changes: "+e+" occurred after "+i)}else this.changeMap.set(s,e)}getChanges(){return Array.from(this.changeMap.values())}}class dd{getCompleteChild(e){return null}getChildAfterChild(e,t,s){return null}}const Br=new dd;class _s{constructor(e,t,s=null){this.writes_=e,this.viewCache_=t,this.optCompleteServerCache_=s}getCompleteChild(e){const t=this.viewCache_.eventCache;if(t.isCompleteForChild(e))return t.getNode().getImmediateChild(e);{const s=this.optCompleteServerCache_!=null?new Se(this.optCompleteServerCache_,!0,!1):this.viewCache_.serverCache;return gs(this.writes_,e,s)}}getChildAfterChild(e,t,s){const i=this.optCompleteServerCache_!=null?this.optCompleteServerCache_:ke(this.viewCache_),r=cd(this.writes_,i,t,1,s,e);return r.length===0?null:r[0]}}function hd(n){return{filter:n}}function fd(n,e){g(e.eventCache.getNode().isIndexed(n.filter.getIndex()),"Event snap not indexed"),g(e.serverCache.getNode().isIndexed(n.filter.getIndex()),"Server snap not indexed")}function pd(n,e,t,s,i){const r=new ud;let o,a;if(t.type===se.OVERWRITE){const c=t;c.source.fromUser?o=Kn(n,e,c.path,c.snap,s,i,r):(g(c.source.fromServer,"Unknown source."),a=c.source.tagged||e.serverCache.isFiltered()&&!b(c.path),o=Qt(n,e,c.path,c.snap,s,i,a,r))}else if(t.type===se.MERGE){const c=t;c.source.fromUser?o=gd(n,e,c.path,c.children,s,i,r):(g(c.source.fromServer,"Unknown source."),a=c.source.tagged||e.serverCache.isFiltered(),o=Yn(n,e,c.path,c.children,s,i,a,r))}else if(t.type===se.ACK_USER_WRITE){const c=t;c.revert?o=Ed(n,e,c.path,s,i,r):o=_d(n,e,c.path,c.affectedTree,s,i,r)}else if(t.type===se.LISTEN_COMPLETE)o=yd(n,e,t.path,s,r);else throw Xe("Unknown operation type: "+t.type);const l=r.getChanges();return md(e,o,l),{viewCache:o,changes:l}}function md(n,e,t){const s=e.eventCache;if(s.isFullyInitialized()){const i=s.getNode().isLeafNode()||s.getNode().isEmpty(),r=jt(n);(t.length>0||!n.eventCache.isFullyInitialized()||i&&!s.getNode().equals(r)||!s.getNode().getPriority().equals(r.getPriority()))&&t.push(Ar(jt(e)))}}function Fr(n,e,t,s,i,r){const o=e.eventCache;if(zt(s,t)!=null)return e;{let a,l;if(b(t))if(g(e.serverCache.isFullyInitialized(),"If change path is empty, we must have complete server data"),e.serverCache.isFiltered()){const c=ke(e),h=c instanceof y?c:y.EMPTY_NODE,u=ms(s,h);a=n.filter.updateFullNode(e.eventCache.getNode(),u,r)}else{const c=qt(s,ke(e));a=n.filter.updateFullNode(e.eventCache.getNode(),c,r)}else{const c=S(t);if(c===".priority"){g(ve(t)===1,"Can't have a priority with additional path components");const h=o.getNode();l=e.serverCache.getNode();const u=mi(s,t,h,l);u!=null?a=n.filter.updatePriority(h,u):a=o.getNode()}else{const h=D(t);let u;if(o.isCompleteForChild(c)){l=e.serverCache.getNode();const d=mi(s,t,o.getNode(),l);d!=null?u=o.getNode().getImmediateChild(c).updateChild(h,d):u=o.getNode().getImmediateChild(c)}else u=gs(s,c,e.serverCache);u!=null?a=n.filter.updateChild(o.getNode(),c,u,h,i,r):a=o.getNode()}}return dt(e,a,o.isFullyInitialized()||b(t),n.filter.filtersNodes())}}function Qt(n,e,t,s,i,r,o,a){const l=e.serverCache;let c;const h=o?n.filter:n.filter.getIndexedFilter();if(b(t))c=h.updateFullNode(l.getNode(),s,null);else if(h.filtersNodes()&&!l.isFiltered()){const p=l.getNode().updateChild(t,s);c=h.updateFullNode(l.getNode(),p,null)}else{const p=S(t);if(!l.isCompleteForPath(t)&&ve(t)>1)return e;const m=D(t),C=l.getNode().getImmediateChild(p).updateChild(m,s);p===".priority"?c=h.updatePriority(l.getNode(),C):c=h.updateChild(l.getNode(),p,C,m,Br,null)}const u=kr(e,c,l.isFullyInitialized()||b(t),h.filtersNodes()),d=new _s(i,u,r);return Fr(n,u,t,i,d,a)}function Kn(n,e,t,s,i,r,o){const a=e.eventCache;let l,c;const h=new _s(i,e,r);if(b(t))c=n.filter.updateFullNode(e.eventCache.getNode(),s,o),l=dt(e,c,!0,n.filter.filtersNodes());else{const u=S(t);if(u===".priority")c=n.filter.updatePriority(e.eventCache.getNode(),s),l=dt(e,c,a.isFullyInitialized(),a.isFiltered());else{const d=D(t),p=a.getNode().getImmediateChild(u);let m;if(b(d))m=s;else{const _=h.getCompleteChild(u);_!=null?os(d)===".priority"&&_.getChild(br(d)).isEmpty()?m=_:m=_.updateChild(d,s):m=y.EMPTY_NODE}if(p.equals(m))l=e;else{const _=n.filter.updateChild(a.getNode(),u,m,d,h,o);l=dt(e,_,a.isFullyInitialized(),n.filter.filtersNodes())}}}return l}function gi(n,e){return n.eventCache.isCompleteForChild(e)}function gd(n,e,t,s,i,r,o){let a=e;return s.foreach((l,c)=>{const h=P(t,l);gi(e,S(h))&&(a=Kn(n,a,h,c,i,r,o))}),s.foreach((l,c)=>{const h=P(t,l);gi(e,S(h))||(a=Kn(n,a,h,c,i,r,o))}),a}function _i(n,e,t){return t.foreach((s,i)=>{e=e.updateChild(s,i)}),e}function Yn(n,e,t,s,i,r,o,a){if(e.serverCache.getNode().isEmpty()&&!e.serverCache.isFullyInitialized())return e;let l=e,c;b(t)?c=s:c=new M(null).setTree(t,s);const h=e.serverCache.getNode();return c.children.inorderTraversal((u,d)=>{if(h.hasChild(u)){const p=e.serverCache.getNode().getImmediateChild(u),m=_i(n,p,d);l=Qt(n,l,new k(u),m,i,r,o,a)}}),c.children.inorderTraversal((u,d)=>{const p=!e.serverCache.isCompleteForChild(u)&&d.value===null;if(!h.hasChild(u)&&!p){const m=e.serverCache.getNode().getImmediateChild(u),_=_i(n,m,d);l=Qt(n,l,new k(u),_,i,r,o,a)}}),l}function _d(n,e,t,s,i,r,o){if(zt(i,t)!=null)return e;const a=e.serverCache.isFiltered(),l=e.serverCache;if(s.value!=null){if(b(t)&&l.isFullyInitialized()||l.isCompleteForPath(t))return Qt(n,e,t,l.getNode().getChild(t),i,r,a,o);if(b(t)){let c=new M(null);return l.getNode().forEachChild(Ge,(h,u)=>{c=c.set(new k(h),u)}),Yn(n,e,t,c,i,r,a,o)}else return e}else{let c=new M(null);return s.foreach((h,u)=>{const d=P(t,h);l.isCompleteForPath(d)&&(c=c.set(h,l.getNode().getChild(d)))}),Yn(n,e,t,c,i,r,a,o)}}function yd(n,e,t,s,i){const r=e.serverCache,o=kr(e,r.getNode(),r.isFullyInitialized()||b(t),r.isFiltered());return Fr(n,o,t,s,Br,i)}function Ed(n,e,t,s,i,r){let o;if(zt(s,t)!=null)return e;{const a=new _s(s,e,i),l=e.eventCache.getNode();let c;if(b(t)||S(t)===".priority"){let h;if(e.serverCache.isFullyInitialized())h=qt(s,ke(e));else{const u=e.serverCache.getNode();g(u instanceof y,"serverChildren would be complete if leaf node"),h=ms(s,u)}h=h,c=n.filter.updateFullNode(l,h,r)}else{const h=S(t);let u=gs(s,h,e.serverCache);u==null&&e.serverCache.isCompleteForChild(h)&&(u=l.getImmediateChild(h)),u!=null?c=n.filter.updateChild(l,h,u,D(t),a,r):e.eventCache.getNode().hasChild(h)?c=n.filter.updateChild(l,h,y.EMPTY_NODE,D(t),a,r):c=l,c.isEmpty()&&e.serverCache.isFullyInitialized()&&(o=qt(s,ke(e)),o.isLeafNode()&&(c=n.filter.updateFullNode(c,o,r)))}return o=e.serverCache.isFullyInitialized()||zt(s,R())!=null,dt(e,c,o,n.filter.filtersNodes())}}class Cd{constructor(e,t){this.query_=e,this.eventRegistrations_=[];const s=this.query_._queryParams,i=new us(s.getIndex()),r=Fu(s);this.processor_=hd(r);const o=t.serverCache,a=t.eventCache,l=i.updateFullNode(y.EMPTY_NODE,o.getNode(),null),c=r.updateFullNode(y.EMPTY_NODE,a.getNode(),null),h=new Se(l,o.isFullyInitialized(),i.filtersNodes()),u=new Se(c,a.isFullyInitialized(),r.filtersNodes());this.viewCache_=rn(u,h),this.eventGenerator_=new Ku(this.query_)}get query(){return this.query_}}function vd(n){return n.viewCache_.serverCache.getNode()}function Sd(n){return jt(n.viewCache_)}function bd(n,e){const t=ke(n.viewCache_);return t&&(n.query._queryParams.loadsAllData()||!b(e)&&!t.getImmediateChild(S(e)).isEmpty())?t.getChild(e):null}function yi(n){return n.eventRegistrations_.length===0}function wd(n,e){n.eventRegistrations_.push(e)}function Ei(n,e,t){const s=[];if(t){g(e==null,"A cancel should cancel all event registrations.");const i=n.query._path;n.eventRegistrations_.forEach(r=>{const o=r.createCancelEvent(t,i);o&&s.push(o)})}if(e){let i=[];for(let r=0;r<n.eventRegistrations_.length;++r){const o=n.eventRegistrations_[r];if(!o.matches(e))i.push(o);else if(e.hasAnyCallback()){i=i.concat(n.eventRegistrations_.slice(r+1));break}}n.eventRegistrations_=i}else n.eventRegistrations_=[];return s}function Ci(n,e,t,s){e.type===se.MERGE&&e.source.queryId!==null&&(g(ke(n.viewCache_),"We should always have a full cache before handling merges"),g(jt(n.viewCache_),"Missing event cache, even though we have a server cache"));const i=n.viewCache_,r=pd(n.processor_,i,e,t,s);return fd(n.processor_,r.viewCache),g(r.viewCache.serverCache.isFullyInitialized()||!i.serverCache.isFullyInitialized(),"Once a server snap is complete, it should never go back"),n.viewCache_=r.viewCache,Wr(n,r.changes,r.viewCache.eventCache.getNode(),null)}function Id(n,e){const t=n.viewCache_.eventCache,s=[];return t.getNode().isLeafNode()||t.getNode().forEachChild(x,(r,o)=>{s.push(Ye(r,o))}),t.isFullyInitialized()&&s.push(Ar(t.getNode())),Wr(n,s,t.getNode(),e)}function Wr(n,e,t,s){const i=s?[s]:n.eventRegistrations_;return Yu(n.eventGenerator_,e,t,i)}let Xt;class Gr{constructor(){this.views=new Map}}function Td(n){g(!Xt,"__referenceConstructor has already been defined"),Xt=n}function Nd(){return g(Xt,"Reference.ts has not been loaded"),Xt}function Rd(n){return n.views.size===0}function ys(n,e,t,s){const i=e.source.queryId;if(i!==null){const r=n.views.get(i);return g(r!=null,"SyncTree gave us an op for an invalid query."),Ci(r,e,t,s)}else{let r=[];for(const o of n.views.values())r=r.concat(Ci(o,e,t,s));return r}}function Ur(n,e,t,s,i){const r=e._queryIdentifier,o=n.views.get(r);if(!o){let a=qt(t,i?s:null),l=!1;a?l=!0:s instanceof y?(a=ms(t,s),l=!1):(a=y.EMPTY_NODE,l=!1);const c=rn(new Se(a,l,!1),new Se(s,i,!1));return new Cd(e,c)}return o}function Od(n,e,t,s,i,r){const o=Ur(n,e,s,i,r);return n.views.has(e._queryIdentifier)||n.views.set(e._queryIdentifier,o),wd(o,t),Id(o,t)}function Ad(n,e,t,s){const i=e._queryIdentifier,r=[];let o=[];const a=be(n);if(i==="default")for(const[l,c]of n.views.entries())o=o.concat(Ei(c,t,s)),yi(c)&&(n.views.delete(l),c.query._queryParams.loadsAllData()||r.push(c.query));else{const l=n.views.get(i);l&&(o=o.concat(Ei(l,t,s)),yi(l)&&(n.views.delete(i),l.query._queryParams.loadsAllData()||r.push(l.query)))}return a&&!be(n)&&r.push(new(Nd())(e._repo,e._path)),{removed:r,events:o}}function Hr(n){const e=[];for(const t of n.views.values())t.query._queryParams.loadsAllData()||e.push(t);return e}function Ce(n,e){let t=null;for(const s of n.views.values())t=t||bd(s,e);return t}function $r(n,e){if(e._queryParams.loadsAllData())return an(n);{const s=e._queryIdentifier;return n.views.get(s)}}function Vr(n,e){return $r(n,e)!=null}function be(n){return an(n)!=null}function an(n){for(const e of n.views.values())if(e.query._queryParams.loadsAllData())return e;return null}let Jt;function kd(n){g(!Jt,"__referenceConstructor has already been defined"),Jt=n}function Dd(){return g(Jt,"Reference.ts has not been loaded"),Jt}let Md=1;class vi{constructor(e){this.listenProvider_=e,this.syncPointTree_=new M(null),this.pendingWriteTree_=ld(),this.tagToQueryMap=new Map,this.queryToTagMap=new Map}}function Kr(n,e,t,s,i){return Qu(n.pendingWriteTree_,e,t,s,i),i?et(n,new Ae(hs(),e,t)):[]}function Ld(n,e,t,s){Xu(n.pendingWriteTree_,e,t,s);const i=M.fromObject(t);return et(n,new je(hs(),e,i))}function ge(n,e,t=!1){const s=Ju(n.pendingWriteTree_,e);if(Zu(n.pendingWriteTree_,e)){let r=new M(null);return s.snap!=null?r=r.set(R(),!0):$(s.children,o=>{r=r.set(new k(o),!0)}),et(n,new Yt(s.path,r,t))}else return[]}function At(n,e,t){return et(n,new Ae(fs(),e,t))}function Pd(n,e,t){const s=M.fromObject(t);return et(n,new je(fs(),e,s))}function xd(n,e){return et(n,new St(fs(),e))}function Bd(n,e,t){const s=Cs(n,t);if(s){const i=vs(s),r=i.path,o=i.queryId,a=V(r,e),l=new St(ps(o),a);return Ss(n,r,l)}else return[]}function Zt(n,e,t,s,i=!1){const r=e._path,o=n.syncPointTree_.get(r);let a=[];if(o&&(e._queryIdentifier==="default"||Vr(o,e))){const l=Ad(o,e,t,s);Rd(o)&&(n.syncPointTree_=n.syncPointTree_.remove(r));const c=l.removed;if(a=l.events,!i){const h=c.findIndex(d=>d._queryParams.loadsAllData())!==-1,u=n.syncPointTree_.findOnPath(r,(d,p)=>be(p));if(h&&!u){const d=n.syncPointTree_.subtree(r);if(!d.isEmpty()){const p=Gd(d);for(let m=0;m<p.length;++m){const _=p[m],C=_.query,N=zr(n,_);n.listenProvider_.startListening(ft(C),bt(n,C),N.hashFn,N.onComplete)}}}!u&&c.length>0&&!s&&(h?n.listenProvider_.stopListening(ft(e),null):c.forEach(d=>{const p=n.queryToTagMap.get(ln(d));n.listenProvider_.stopListening(ft(d),p)}))}Ud(n,c)}return a}function Yr(n,e,t,s){const i=Cs(n,s);if(i!=null){const r=vs(i),o=r.path,a=r.queryId,l=V(o,e),c=new Ae(ps(a),l,t);return Ss(n,o,c)}else return[]}function Fd(n,e,t,s){const i=Cs(n,s);if(i){const r=vs(i),o=r.path,a=r.queryId,l=V(o,e),c=M.fromObject(t),h=new je(ps(a),l,c);return Ss(n,o,h)}else return[]}function jn(n,e,t,s=!1){const i=e._path;let r=null,o=!1;n.syncPointTree_.foreachOnPath(i,(d,p)=>{const m=V(d,i);r=r||Ce(p,m),o=o||be(p)});let a=n.syncPointTree_.get(i);a?(o=o||be(a),r=r||Ce(a,R())):(a=new Gr,n.syncPointTree_=n.syncPointTree_.set(i,a));let l;r!=null?l=!0:(l=!1,r=y.EMPTY_NODE,n.syncPointTree_.subtree(i).foreachChild((p,m)=>{const _=Ce(m,R());_&&(r=r.updateImmediateChild(p,_))}));const c=Vr(a,e);if(!c&&!e._queryParams.loadsAllData()){const d=ln(e);g(!n.queryToTagMap.has(d),"View does not exist, but we have a tag");const p=Hd();n.queryToTagMap.set(d,p),n.tagToQueryMap.set(p,d)}const h=on(n.pendingWriteTree_,i);let u=Od(a,e,t,h,r,l);if(!c&&!o&&!s){const d=$r(a,e);u=u.concat($d(n,e,d))}return u}function Es(n,e,t){const i=n.pendingWriteTree_,r=n.syncPointTree_.findOnPath(e,(o,a)=>{const l=V(o,e),c=Ce(a,l);if(c)return c});return Lr(i,e,r,t,!0)}function Wd(n,e){const t=e._path;let s=null;n.syncPointTree_.foreachOnPath(t,(c,h)=>{const u=V(c,t);s=s||Ce(h,u)});let i=n.syncPointTree_.get(t);i?s=s||Ce(i,R()):(i=new Gr,n.syncPointTree_=n.syncPointTree_.set(t,i));const r=s!=null,o=r?new Se(s,!0,!1):null,a=on(n.pendingWriteTree_,e._path),l=Ur(i,e,a,r?o.getNode():y.EMPTY_NODE,r);return Sd(l)}function et(n,e){return jr(e,n.syncPointTree_,null,on(n.pendingWriteTree_,R()))}function jr(n,e,t,s){if(b(n.path))return qr(n,e,t,s);{const i=e.get(R());t==null&&i!=null&&(t=Ce(i,R()));let r=[];const o=S(n.path),a=n.operationForChild(o),l=e.children.get(o);if(l&&a){const c=t?t.getImmediateChild(o):null,h=Pr(s,o);r=r.concat(jr(a,l,c,h))}return i&&(r=r.concat(ys(i,n,s,t))),r}}function qr(n,e,t,s){const i=e.get(R());t==null&&i!=null&&(t=Ce(i,R()));let r=[];return e.children.inorderTraversal((o,a)=>{const l=t?t.getImmediateChild(o):null,c=Pr(s,o),h=n.operationForChild(o);h&&(r=r.concat(qr(h,a,l,c)))}),i&&(r=r.concat(ys(i,n,s,t))),r}function zr(n,e){const t=e.query,s=bt(n,t);return{hashFn:()=>(vd(e)||y.EMPTY_NODE).hash(),onComplete:i=>{if(i==="ok")return s?Bd(n,t._path,s):xd(n,t._path);{const r=xc(i,t);return Zt(n,t,null,r)}}}}function bt(n,e){const t=ln(e);return n.queryToTagMap.get(t)}function ln(n){return n._path.toString()+"$"+n._queryIdentifier}function Cs(n,e){return n.tagToQueryMap.get(e)}function vs(n){const e=n.indexOf("$");return g(e!==-1&&e<n.length-1,"Bad queryKey."),{queryId:n.substr(e+1),path:new k(n.substr(0,e))}}function Ss(n,e,t){const s=n.syncPointTree_.get(e);g(s,"Missing sync point for query tag that we're tracking");const i=on(n.pendingWriteTree_,e);return ys(s,t,i,null)}function Gd(n){return n.fold((e,t,s)=>{if(t&&be(t))return[an(t)];{let i=[];return t&&(i=Hr(t)),$(s,(r,o)=>{i=i.concat(o)}),i}})}function ft(n){return n._queryParams.loadsAllData()&&!n._queryParams.isDefault()?new(Dd())(n._repo,n._path):n}function Ud(n,e){for(let t=0;t<e.length;++t){const s=e[t];if(!s._queryParams.loadsAllData()){const i=ln(s),r=n.queryToTagMap.get(i);n.queryToTagMap.delete(i),n.tagToQueryMap.delete(r)}}}function Hd(){return Md++}function $d(n,e,t){const s=e._path,i=bt(n,e),r=zr(n,t),o=n.listenProvider_.startListening(ft(e),i,r.hashFn,r.onComplete),a=n.syncPointTree_.subtree(s);if(i)g(!be(a.value),"If we're adding a query, it shouldn't be shadowed");else{const l=a.fold((c,h,u)=>{if(!b(c)&&h&&be(h))return[an(h).query];{let d=[];return h&&(d=d.concat(Hr(h).map(p=>p.query))),$(u,(p,m)=>{d=d.concat(m)}),d}});for(let c=0;c<l.length;++c){const h=l[c];n.listenProvider_.stopListening(ft(h),bt(n,h))}}return o}class bs{constructor(e){this.node_=e}getImmediateChild(e){const t=this.node_.getImmediateChild(e);return new bs(t)}node(){return this.node_}}class ws{constructor(e,t){this.syncTree_=e,this.path_=t}getImmediateChild(e){const t=P(this.path_,e);return new ws(this.syncTree_,t)}node(){return Es(this.syncTree_,this.path_)}}const Vd=function(n){return n=n||{},n.timestamp=n.timestamp||new Date().getTime(),n},Si=function(n,e,t){if(!n||typeof n!="object")return n;if(g(".sv"in n,"Unexpected leaf node or priority contents"),typeof n[".sv"]=="string")return Kd(n[".sv"],e,t);if(typeof n[".sv"]=="object")return Yd(n[".sv"],e);g(!1,"Unexpected server value: "+JSON.stringify(n,null,2))},Kd=function(n,e,t){if(n==="timestamp")return t.timestamp;g(!1,"Unexpected server value: "+n)},Yd=function(n,e,t){n.hasOwnProperty("increment")||g(!1,"Unexpected server value: "+JSON.stringify(n,null,2));const s=n.increment;typeof s!="number"&&g(!1,"Unexpected increment value: "+s);const i=e.node();if(g(i!==null&&typeof i<"u","Expected ChildrenNode.EMPTY_NODE for nulls"),!i.isLeafNode())return s;const o=i.getValue();return typeof o!="number"?s:o+s},Qr=function(n,e,t,s){return Is(e,new ws(t,n),s)},Xr=function(n,e,t){return Is(n,new bs(e),t)};function Is(n,e,t){const s=n.getPriority().val(),i=Si(s,e.getImmediateChild(".priority"),t);let r;if(n.isLeafNode()){const o=n,a=Si(o.getValue(),e,t);return a!==o.getValue()||i!==o.getPriority().val()?new G(a,B(i)):n}else{const o=n;return r=o,i!==o.getPriority().val()&&(r=r.updatePriority(new G(i))),o.forEachChild(x,(a,l)=>{const c=Is(l,e.getImmediateChild(a),t);c!==l&&(r=r.updateImmediateChild(a,c))}),r}}class Ts{constructor(e="",t=null,s={children:{},childCount:0}){this.name=e,this.parent=t,this.node=s}}function Ns(n,e){let t=e instanceof k?e:new k(e),s=n,i=S(t);for(;i!==null;){const r=$e(s.node.children,i)||{children:{},childCount:0};s=new Ts(i,s,r),t=D(t),i=S(t)}return s}function tt(n){return n.node.value}function Jr(n,e){n.node.value=e,qn(n)}function Zr(n){return n.node.childCount>0}function jd(n){return tt(n)===void 0&&!Zr(n)}function cn(n,e){$(n.node.children,(t,s)=>{e(new Ts(t,n,s))})}function eo(n,e,t,s){t&&e(n),cn(n,i=>{eo(i,e,!0)})}function qd(n,e,t){let s=n.parent;for(;s!==null;){if(e(s))return!0;s=s.parent}return!1}function kt(n){return new k(n.parent===null?n.name:kt(n.parent)+"/"+n.name)}function qn(n){n.parent!==null&&zd(n.parent,n.name,n)}function zd(n,e,t){const s=jd(t),i=le(n.node.children,e);s&&i?(delete n.node.children[e],n.node.childCount--,qn(n)):!s&&!i&&(n.node.children[e]=t.node,n.node.childCount++,qn(n))}const Qd=/[\[\].#$\/\u0000-\u001F\u007F]/,Xd=/[\[\].#$\u0000-\u001F\u007F]/,Tn=10*1024*1024,Rs=function(n){return typeof n=="string"&&n.length!==0&&!Qd.test(n)},to=function(n){return typeof n=="string"&&n.length!==0&&!Xd.test(n)},Jd=function(n){return n&&(n=n.replace(/^\/*\.info(\/|$)/,"/")),to(n)},no=function(n){return n===null||typeof n=="string"||typeof n=="number"&&!nn(n)||n&&typeof n=="object"&&le(n,".sv")},en=function(n,e,t,s){s&&e===void 0||un(Ve(n,"value"),e,t)},un=function(n,e,t){const s=t instanceof k?new gu(t,n):t;if(e===void 0)throw new Error(n+"contains undefined "+Ne(s));if(typeof e=="function")throw new Error(n+"contains a function "+Ne(s)+" with contents = "+e.toString());if(nn(e))throw new Error(n+"contains "+e.toString()+" "+Ne(s));if(typeof e=="string"&&e.length>Tn/3&&tn(e)>Tn)throw new Error(n+"contains a string greater than "+Tn+" utf8 bytes "+Ne(s)+" ('"+e.substring(0,50)+"...')");if(e&&typeof e=="object"){let i=!1,r=!1;if($(e,(o,a)=>{if(o===".value")i=!0;else if(o!==".priority"&&o!==".sv"&&(r=!0,!Rs(o)))throw new Error(n+" contains an invalid key ("+o+") "+Ne(s)+`.  Keys must be non-empty strings and can't contain ".", "#", "$", "/", "[", or "]"`);_u(s,o),un(n,a,s),yu(s)}),i&&r)throw new Error(n+' contains ".value" child '+Ne(s)+" in addition to actual children.")}},Zd=function(n,e){let t,s;for(t=0;t<e.length;t++){s=e[t];const r=yt(s);for(let o=0;o<r.length;o++)if(!(r[o]===".priority"&&o===r.length-1)){if(!Rs(r[o]))throw new Error(n+"contains an invalid key ("+r[o]+") in path "+s.toString()+`. Keys must be non-empty strings and can't contain ".", "#", "$", "/", "[", or "]"`)}}e.sort(mu);let i=null;for(t=0;t<e.length;t++){if(s=e[t],i!==null&&ee(i,s))throw new Error(n+"contains a path "+i.toString()+" that is ancestor of another path "+s.toString());i=s}},so=function(n,e,t,s){const i=Ve(n,"values");if(!(e&&typeof e=="object")||Array.isArray(e))throw new Error(i+" must be an object containing the children to replace.");const r=[];$(e,(o,a)=>{const l=new k(o);if(un(i,a,P(t,l)),os(l)===".priority"&&!no(a))throw new Error(i+"contains an invalid value for '"+l.toString()+"', which must be a valid Firebase priority (a string, finite number, server value, or null).");r.push(l)}),Zd(i,r)},eh=function(n,e,t){if(nn(e))throw new Error(Ve(n,"priority")+"is "+e.toString()+", but must be a valid Firebase priority (a string, finite number, server value, or null).");if(!no(e))throw new Error(Ve(n,"priority")+"must be a valid Firebase priority (a string, finite number, server value, or null).")},io=function(n,e,t,s){if(!to(t))throw new Error(Ve(n,e)+'was an invalid path = "'+t+`". Paths must be non-empty strings and can't contain ".", "#", "$", "[", or "]"`)},th=function(n,e,t,s){t&&(t=t.replace(/^\/*\.info(\/|$)/,"/")),io(n,e,t)},xe=function(n,e){if(S(e)===".info")throw new Error(n+" failed = Can't modify data under /.info/")},nh=function(n,e){const t=e.path.toString();if(typeof e.repoInfo.host!="string"||e.repoInfo.host.length===0||!Rs(e.repoInfo.namespace)&&e.repoInfo.host.split(":")[0]!=="localhost"||t.length!==0&&!Jd(t))throw new Error(Ve(n,"url")+`must be a valid firebase URL and the path can't contain ".", "#", "$", "[", or "]".`)};class sh{constructor(){this.eventLists_=[],this.recursionDepth_=0}}function dn(n,e){let t=null;for(let s=0;s<e.length;s++){const i=e[s],r=i.getPath();t!==null&&!as(r,t.path)&&(n.eventLists_.push(t),t=null),t===null&&(t={events:[],path:r}),t.events.push(i)}t&&n.eventLists_.push(t)}function ro(n,e,t){dn(n,t),oo(n,s=>as(s,e))}function te(n,e,t){dn(n,t),oo(n,s=>ee(s,e)||ee(e,s))}function oo(n,e){n.recursionDepth_++;let t=!0;for(let s=0;s<n.eventLists_.length;s++){const i=n.eventLists_[s];if(i){const r=i.path;e(r)?(ih(n.eventLists_[s]),n.eventLists_[s]=null):t=!1}}t&&(n.eventLists_=[]),n.recursionDepth_--}function ih(n){for(let e=0;e<n.events.length;e++){const t=n.events[e];if(t!==null){n.events[e]=null;const s=t.getEventRunner();ct&&H("event: "+t.toString()),Je(s)}}}const rh="repo_interrupt",oh=25;class ah{constructor(e,t,s,i){this.repoInfo_=e,this.forceRestClient_=t,this.authTokenProvider_=s,this.appCheckProvider_=i,this.dataUpdateCount=0,this.statsListener_=null,this.eventQueue_=new sh,this.nextWriteId_=1,this.interceptServerDataCallback_=null,this.onDisconnect_=Kt(),this.transactionQueueTree_=new Ts,this.persistentConnection_=null,this.key=this.repoInfo_.toURLString()}toString(){return(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host}}function lh(n,e,t){if(n.stats_=is(n.repoInfo_),n.forceRestClient_||Gc())n.server_=new Vt(n.repoInfo_,(s,i,r,o)=>{bi(n,s,i,r,o)},n.authTokenProvider_,n.appCheckProvider_),setTimeout(()=>wi(n,!0),0);else{if(typeof t<"u"&&t!==null){if(typeof t!="object")throw new Error("Only objects are supported for option databaseAuthVariableOverride");try{W(t)}catch(s){throw new Error("Invalid authOverride provided: "+s)}}n.persistentConnection_=new de(n.repoInfo_,e,(s,i,r,o)=>{bi(n,s,i,r,o)},s=>{wi(n,s)},s=>{ch(n,s)},n.authTokenProvider_,n.appCheckProvider_,t),n.server_=n.persistentConnection_}n.authTokenProvider_.addTokenChangeListener(s=>{n.server_.refreshAuthToken(s)}),n.appCheckProvider_.addTokenChangeListener(s=>{n.server_.refreshAppCheckToken(s.token)}),n.statsReporter_=Kc(n.repoInfo_,()=>new Vu(n.stats_,n.server_)),n.infoData_=new Wu,n.infoSyncTree_=new vi({startListening:(s,i,r,o)=>{let a=[];const l=n.infoData_.getNode(s._path);return l.isEmpty()||(a=At(n.infoSyncTree_,s._path,l),setTimeout(()=>{o("ok")},0)),a},stopListening:()=>{}}),Os(n,"connected",!1),n.serverSyncTree_=new vi({startListening:(s,i,r,o)=>(n.server_.listen(s,r,i,(a,l)=>{const c=o(a,l);te(n.eventQueue_,s._path,c)}),[]),stopListening:(s,i)=>{n.server_.unlisten(s,i)}})}function ao(n){const t=n.infoData_.getNode(new k(".info/serverTimeOffset")).val()||0;return new Date().getTime()+t}function hn(n){return Vd({timestamp:ao(n)})}function bi(n,e,t,s,i){n.dataUpdateCount++;const r=new k(e);t=n.interceptServerDataCallback_?n.interceptServerDataCallback_(e,t):t;let o=[];if(i)if(s){const l=Bt(t,c=>B(c));o=Fd(n.serverSyncTree_,r,l,i)}else{const l=B(t);o=Yr(n.serverSyncTree_,r,l,i)}else if(s){const l=Bt(t,c=>B(c));o=Pd(n.serverSyncTree_,r,l)}else{const l=B(t);o=At(n.serverSyncTree_,r,l)}let a=r;o.length>0&&(a=ze(n,r)),te(n.eventQueue_,a,o)}function wi(n,e){Os(n,"connected",e),e===!1&&fh(n)}function ch(n,e){$(e,(t,s)=>{Os(n,t,s)})}function Os(n,e,t){const s=new k("/.info/"+e),i=B(t);n.infoData_.updateSnapshot(s,i);const r=At(n.infoSyncTree_,s,i);te(n.eventQueue_,s,r)}function As(n){return n.nextWriteId_++}function uh(n,e,t){const s=Wd(n.serverSyncTree_,e);return s!=null?Promise.resolve(s):n.server_.get(e).then(i=>{const r=B(i).withIndex(e._queryParams.getIndex());jn(n.serverSyncTree_,e,t,!0);let o;if(e._queryParams.loadsAllData())o=At(n.serverSyncTree_,e._path,r);else{const a=bt(n.serverSyncTree_,e);o=Yr(n.serverSyncTree_,e._path,r,a)}return te(n.eventQueue_,e._path,o),Zt(n.serverSyncTree_,e,t,null,!0),r},i=>(Dt(n,"get for query "+W(e)+" failed: "+i),Promise.reject(new Error(i))))}function dh(n,e,t,s,i){Dt(n,"set",{path:e.toString(),value:t,priority:s});const r=hn(n),o=B(t,s),a=Es(n.serverSyncTree_,e),l=Xr(o,a,r),c=As(n),h=Kr(n.serverSyncTree_,e,l,c,!0);dn(n.eventQueue_,h),n.server_.put(e.toString(),o.val(!0),(d,p)=>{const m=d==="ok";m||K("set at "+e+" failed: "+d);const _=ge(n.serverSyncTree_,c,!m);te(n.eventQueue_,e,_),we(n,i,d,p)});const u=Ds(n,e);ze(n,u),te(n.eventQueue_,u,[])}function hh(n,e,t,s){Dt(n,"update",{path:e.toString(),value:t});let i=!0;const r=hn(n),o={};if($(t,(a,l)=>{i=!1,o[a]=Qr(P(e,a),B(l),n.serverSyncTree_,r)}),i)H("update() called with empty data.  Don't do anything."),we(n,s,"ok",void 0);else{const a=As(n),l=Ld(n.serverSyncTree_,e,o,a);dn(n.eventQueue_,l),n.server_.merge(e.toString(),t,(c,h)=>{const u=c==="ok";u||K("update at "+e+" failed: "+c);const d=ge(n.serverSyncTree_,a,!u),p=d.length>0?ze(n,e):e;te(n.eventQueue_,p,d),we(n,s,c,h)}),$(t,c=>{const h=Ds(n,P(e,c));ze(n,h)}),te(n.eventQueue_,e,[])}}function fh(n){Dt(n,"onDisconnectEvents");const e=hn(n),t=Kt();Un(n.onDisconnect_,R(),(i,r)=>{const o=Qr(i,r,n.serverSyncTree_,e);Ze(t,i,o)});let s=[];Un(t,R(),(i,r)=>{s=s.concat(At(n.serverSyncTree_,i,r));const o=Ds(n,i);ze(n,o)}),n.onDisconnect_=Kt(),te(n.eventQueue_,R(),s)}function ph(n,e,t){n.server_.onDisconnectCancel(e.toString(),(s,i)=>{s==="ok"&&Gn(n.onDisconnect_,e),we(n,t,s,i)})}function Ii(n,e,t,s){const i=B(t);n.server_.onDisconnectPut(e.toString(),i.val(!0),(r,o)=>{r==="ok"&&Ze(n.onDisconnect_,e,i),we(n,s,r,o)})}function mh(n,e,t,s,i){const r=B(t,s);n.server_.onDisconnectPut(e.toString(),r.val(!0),(o,a)=>{o==="ok"&&Ze(n.onDisconnect_,e,r),we(n,i,o,a)})}function gh(n,e,t,s){if(kn(t)){H("onDisconnect().update() called with empty data.  Don't do anything."),we(n,s,"ok",void 0);return}n.server_.onDisconnectMerge(e.toString(),t,(i,r)=>{i==="ok"&&$(t,(o,a)=>{const l=B(a);Ze(n.onDisconnect_,P(e,o),l)}),we(n,s,i,r)})}function _h(n,e,t){let s;S(e._path)===".info"?s=jn(n.infoSyncTree_,e,t):s=jn(n.serverSyncTree_,e,t),ro(n.eventQueue_,e._path,s)}function yh(n,e,t){let s;S(e._path)===".info"?s=Zt(n.infoSyncTree_,e,t):s=Zt(n.serverSyncTree_,e,t),ro(n.eventQueue_,e._path,s)}function Eh(n){n.persistentConnection_&&n.persistentConnection_.interrupt(rh)}function Dt(n,...e){let t="";n.persistentConnection_&&(t=n.persistentConnection_.id+":"),H(t,...e)}function we(n,e,t,s){e&&Je(()=>{if(t==="ok")e(null);else{const i=(t||"error").toUpperCase();let r=i;s&&(r+=": "+s);const o=new Error(r);o.code=i,e(o)}})}function lo(n,e,t){return Es(n.serverSyncTree_,e,t)||y.EMPTY_NODE}function ks(n,e=n.transactionQueueTree_){if(e||fn(n,e),tt(e)){const t=uo(n,e);g(t.length>0,"Sending zero length transaction queue"),t.every(i=>i.status===0)&&Ch(n,kt(e),t)}else Zr(e)&&cn(e,t=>{ks(n,t)})}function Ch(n,e,t){const s=t.map(c=>c.currentWriteId),i=lo(n,e,s);let r=i;const o=i.hash();for(let c=0;c<t.length;c++){const h=t[c];g(h.status===0,"tryToSendTransactionQueue_: items in queue should all be run."),h.status=1,h.retryCount++;const u=V(e,h.path);r=r.updateChild(u,h.currentOutputSnapshotRaw)}const a=r.val(!0),l=e;n.server_.put(l.toString(),a,c=>{Dt(n,"transaction put response",{path:l.toString(),status:c});let h=[];if(c==="ok"){const u=[];for(let d=0;d<t.length;d++)t[d].status=2,h=h.concat(ge(n.serverSyncTree_,t[d].currentWriteId)),t[d].onComplete&&u.push(()=>t[d].onComplete(null,!0,t[d].currentOutputSnapshotResolved)),t[d].unwatcher();fn(n,Ns(n.transactionQueueTree_,e)),ks(n,n.transactionQueueTree_),te(n.eventQueue_,e,h);for(let d=0;d<u.length;d++)Je(u[d])}else{if(c==="datastale")for(let u=0;u<t.length;u++)t[u].status===3?t[u].status=4:t[u].status=0;else{K("transaction at "+l.toString()+" failed: "+c);for(let u=0;u<t.length;u++)t[u].status=4,t[u].abortReason=c}ze(n,e)}},o)}function ze(n,e){const t=co(n,e),s=kt(t),i=uo(n,t);return vh(n,i,s),s}function vh(n,e,t){if(e.length===0)return;const s=[];let i=[];const o=e.filter(a=>a.status===0).map(a=>a.currentWriteId);for(let a=0;a<e.length;a++){const l=e[a],c=V(t,l.path);let h=!1,u;if(g(c!==null,"rerunTransactionsUnderNode_: relativePath should not be null."),l.status===4)h=!0,u=l.abortReason,i=i.concat(ge(n.serverSyncTree_,l.currentWriteId,!0));else if(l.status===0)if(l.retryCount>=oh)h=!0,u="maxretry",i=i.concat(ge(n.serverSyncTree_,l.currentWriteId,!0));else{const d=lo(n,l.path,o);l.currentInputSnapshot=d;const p=e[a].update(d.val());if(p!==void 0){un("transaction failed: Data returned ",p,l.path);let m=B(p);typeof p=="object"&&p!=null&&le(p,".priority")||(m=m.updatePriority(d.getPriority()));const C=l.currentWriteId,N=hn(n),E=Xr(m,d,N);l.currentOutputSnapshotRaw=m,l.currentOutputSnapshotResolved=E,l.currentWriteId=As(n),o.splice(o.indexOf(C),1),i=i.concat(Kr(n.serverSyncTree_,l.path,E,l.currentWriteId,l.applyLocally)),i=i.concat(ge(n.serverSyncTree_,C,!0))}else h=!0,u="nodata",i=i.concat(ge(n.serverSyncTree_,l.currentWriteId,!0))}te(n.eventQueue_,t,i),i=[],h&&(e[a].status=2,(function(d){setTimeout(d,Math.floor(0))})(e[a].unwatcher),e[a].onComplete&&(u==="nodata"?s.push(()=>e[a].onComplete(null,!1,e[a].currentInputSnapshot)):s.push(()=>e[a].onComplete(new Error(u),!1,null))))}fn(n,n.transactionQueueTree_);for(let a=0;a<s.length;a++)Je(s[a]);ks(n,n.transactionQueueTree_)}function co(n,e){let t,s=n.transactionQueueTree_;for(t=S(e);t!==null&&tt(s)===void 0;)s=Ns(s,t),e=D(e),t=S(e);return s}function uo(n,e){const t=[];return ho(n,e,t),t.sort((s,i)=>s.order-i.order),t}function ho(n,e,t){const s=tt(e);if(s)for(let i=0;i<s.length;i++)t.push(s[i]);cn(e,i=>{ho(n,i,t)})}function fn(n,e){const t=tt(e);if(t){let s=0;for(let i=0;i<t.length;i++)t[i].status!==2&&(t[s]=t[i],s++);t.length=s,Jr(e,t.length>0?t:void 0)}cn(e,s=>{fn(n,s)})}function Ds(n,e){const t=kt(co(n,e)),s=Ns(n.transactionQueueTree_,e);return qd(s,i=>{Nn(n,i)}),Nn(n,s),eo(s,i=>{Nn(n,i)}),t}function Nn(n,e){const t=tt(e);if(t){const s=[];let i=[],r=-1;for(let o=0;o<t.length;o++)t[o].status===3||(t[o].status===1?(g(r===o-1,"All SENT items should be at beginning of queue."),r=o,t[o].status=3,t[o].abortReason="set"):(g(t[o].status===0,"Unexpected transaction status in abort"),t[o].unwatcher(),i=i.concat(ge(n.serverSyncTree_,t[o].currentWriteId,!0)),t[o].onComplete&&s.push(t[o].onComplete.bind(null,new Error("set"),!1,null))));r===-1?Jr(e,void 0):t.length=r+1,te(n.eventQueue_,kt(e),i);for(let o=0;o<s.length;o++)Je(s[o])}}function Sh(n){let e="";const t=n.split("/");for(let s=0;s<t.length;s++)if(t[s].length>0){let i=t[s];try{i=decodeURIComponent(i.replace(/\+/g," "))}catch{}e+="/"+i}return e}function bh(n){const e={};n.charAt(0)==="?"&&(n=n.substring(1));for(const t of n.split("&")){if(t.length===0)continue;const s=t.split("=");s.length===2?e[decodeURIComponent(s[0])]=decodeURIComponent(s[1]):K(`Invalid query segment '${t}' in query '${n}'`)}return e}const Ti=function(n,e){const t=wh(n),s=t.namespace;t.domain==="firebase.com"&&pe(t.host+" is no longer supported. Please use <YOUR FIREBASE>.firebaseio.com instead"),(!s||s==="undefined")&&t.domain!=="localhost"&&pe("Cannot parse Firebase url. Please use https://<YOUR FIREBASE>.firebaseio.com"),t.secure||kc();const i=t.scheme==="ws"||t.scheme==="wss";return{repoInfo:new pr(t.host,t.secure,s,i,e,"",s!==t.subdomain),path:new k(t.pathString)}},wh=function(n){let e="",t="",s="",i="",r="",o=!0,a="https",l=443;if(typeof n=="string"){let c=n.indexOf("//");c>=0&&(a=n.substring(0,c-1),n=n.substring(c+2));let h=n.indexOf("/");h===-1&&(h=n.length);let u=n.indexOf("?");u===-1&&(u=n.length),e=n.substring(0,Math.min(h,u)),h<u&&(i=Sh(n.substring(h,u)));const d=bh(n.substring(Math.min(n.length,u)));c=e.indexOf(":"),c>=0?(o=a==="https"||a==="wss",l=parseInt(e.substring(c+1),10)):c=e.length;const p=e.slice(0,c);if(p.toLowerCase()==="localhost")t="localhost";else if(p.split(".").length<=2)t=p;else{const m=e.indexOf(".");s=e.substring(0,m).toLowerCase(),t=e.substring(m+1),r=s}"ns"in d&&(r=d.ns)}return{host:e,port:l,domain:t,subdomain:s,secure:o,scheme:a,pathString:i,namespace:r}};const Ni="-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz",Ih=(function(){let n=0;const e=[];return function(t){const s=t===n;n=t;let i;const r=new Array(8);for(i=7;i>=0;i--)r[i]=Ni.charAt(t%64),t=Math.floor(t/64);g(t===0,"Cannot push at time == 0");let o=r.join("");if(s){for(i=11;i>=0&&e[i]===63;i--)e[i]=0;e[i]++}else for(i=0;i<12;i++)e[i]=Math.floor(Math.random()*64);for(i=0;i<12;i++)o+=Ni.charAt(e[i]);return g(o.length===20,"nextPushId: Length should be 20."),o}})();class Th{constructor(e,t,s,i){this.eventType=e,this.eventRegistration=t,this.snapshot=s,this.prevName=i}getPath(){const e=this.snapshot.ref;return this.eventType==="value"?e._path:e.parent._path}getEventType(){return this.eventType}getEventRunner(){return this.eventRegistration.getEventRunner(this)}toString(){return this.getPath().toString()+":"+this.eventType+":"+W(this.snapshot.exportVal())}}class Nh{constructor(e,t,s){this.eventRegistration=e,this.error=t,this.path=s}getPath(){return this.path}getEventType(){return"cancel"}getEventRunner(){return this.eventRegistration.getEventRunner(this)}toString(){return this.path.toString()+":cancel"}}class fo{constructor(e,t){this.snapshotCallback=e,this.cancelCallback=t}onValue(e,t){this.snapshotCallback.call(null,e,t)}onCancel(e){return g(this.hasCancelCallback,"Raising a cancel event on a listener with no cancel callback"),this.cancelCallback.call(null,e)}get hasCancelCallback(){return!!this.cancelCallback}matches(e){return this.snapshotCallback===e.snapshotCallback||this.snapshotCallback.userCallback!==void 0&&this.snapshotCallback.userCallback===e.snapshotCallback.userCallback&&this.snapshotCallback.context===e.snapshotCallback.context}}class Rh{constructor(e,t){this._repo=e,this._path=t}cancel(){const e=new re;return ph(this._repo,this._path,e.wrapCallback(()=>{})),e.promise}remove(){xe("OnDisconnect.remove",this._path);const e=new re;return Ii(this._repo,this._path,null,e.wrapCallback(()=>{})),e.promise}set(e){xe("OnDisconnect.set",this._path),en("OnDisconnect.set",e,this._path,!1);const t=new re;return Ii(this._repo,this._path,e,t.wrapCallback(()=>{})),t.promise}setWithPriority(e,t){xe("OnDisconnect.setWithPriority",this._path),en("OnDisconnect.setWithPriority",e,this._path,!1),eh("OnDisconnect.setWithPriority",t);const s=new re;return mh(this._repo,this._path,e,t,s.wrapCallback(()=>{})),s.promise}update(e){xe("OnDisconnect.update",this._path),so("OnDisconnect.update",e,this._path);const t=new re;return gh(this._repo,this._path,e,t.wrapCallback(()=>{})),t.promise}}class Ms{constructor(e,t,s,i){this._repo=e,this._path=t,this._queryParams=s,this._orderByCalled=i}get key(){return b(this._path)?null:os(this._path)}get ref(){return new me(this._repo,this._path)}get _queryIdentifier(){const e=di(this._queryParams),t=ns(e);return t==="{}"?"default":t}get _queryObject(){return di(this._queryParams)}isEqual(e){if(e=Ie(e),!(e instanceof Ms))return!1;const t=this._repo===e._repo,s=as(this._path,e._path),i=this._queryIdentifier===e._queryIdentifier;return t&&s&&i}toJSON(){return this.toString()}toString(){return this._repo.toString()+pu(this._path)}}class me extends Ms{constructor(e,t){super(e,t,new ds,!1)}get parent(){const e=br(this._path);return e===null?null:new me(this._repo,e)}get root(){let e=this;for(;e.parent!==null;)e=e.parent;return e}}class wt{constructor(e,t,s){this._node=e,this.ref=t,this._index=s}get priority(){return this._node.getPriority().val()}get key(){return this.ref.key}get size(){return this._node.numChildren()}child(e){const t=new k(e),s=Qe(this.ref,e);return new wt(this._node.getChild(t),s,x)}exists(){return!this._node.isEmpty()}exportVal(){return this._node.val(!0)}forEach(e){return this._node.isLeafNode()?!1:!!this._node.forEachChild(this._index,(s,i)=>e(new wt(i,Qe(this.ref,s),x)))}hasChild(e){const t=new k(e);return!this._node.getChild(t).isEmpty()}hasChildren(){return this._node.isLeafNode()?!1:!this._node.isEmpty()}toJSON(){return this.exportVal()}val(){return this._node.val()}}function Y(n,e){return n=Ie(n),n._checkNotDeleted("ref"),e!==void 0?Qe(n._root,e):n._root}function Qe(n,e){return n=Ie(n),S(n._path)===null?th("child","path",e):io("child","path",e),new me(n._repo,P(n._path,e))}function Ri(n){return n=Ie(n),new Rh(n._repo,n._path)}function Oh(n,e){n=Ie(n),xe("push",n._path),en("push",e,n._path,!0);const t=ao(n._repo),s=Ih(t),i=Qe(n,s),r=Qe(n,s);let o;return o=Promise.resolve(r),i.then=o.then.bind(o),i.catch=o.then.bind(o,void 0),i}function Rn(n,e){n=Ie(n),xe("set",n._path),en("set",e,n._path,!1);const t=new re;return dh(n._repo,n._path,e,null,t.wrapCallback(()=>{})),t.promise}function ce(n,e){so("update",e,n._path);const t=new re;return hh(n._repo,n._path,e,t.wrapCallback(()=>{})),t.promise}function On(n){n=Ie(n);const e=new fo(()=>{}),t=new pn(e);return uh(n._repo,n,t).then(s=>new wt(s,new me(n._repo,n._path),n._queryParams.getIndex()))}class pn{constructor(e){this.callbackContext=e}respondsTo(e){return e==="value"}createEvent(e,t){const s=t._queryParams.getIndex();return new Th("value",this,new wt(e.snapshotNode,new me(t._repo,t._path),s))}getEventRunner(e){return e.getEventType()==="cancel"?()=>this.callbackContext.onCancel(e.error):()=>this.callbackContext.onValue(e.snapshot,null)}createCancelEvent(e,t){return this.callbackContext.hasCancelCallback?new Nh(this,e,t):null}matches(e){return e instanceof pn?!e.callbackContext||!this.callbackContext?!0:e.callbackContext.matches(this.callbackContext):!1}hasAnyCallback(){return this.callbackContext!==null}}function Ah(n,e,t,s,i){const r=new fo(t,void 0),o=new pn(r);return _h(n._repo,n,o),()=>yh(n._repo,n,o)}function kh(n,e,t,s){return Ah(n,"value",e)}Td(me);kd(me);const Dh="FIREBASE_DATABASE_EMULATOR_HOST",zn={};let Mh=!1;function Lh(n,e,t,s){const i=e.lastIndexOf(":"),r=e.substring(0,i),o=es(r);n.repoInfo_=new pr(e,o,n.repoInfo_.namespace,n.repoInfo_.webSocketOnly,n.repoInfo_.nodeAdmin,n.repoInfo_.persistenceKey,n.repoInfo_.includeNamespaceInQueryParams,!0,t),s&&(n.authTokenProvider_=s)}function Ph(n,e,t,s,i){let r=s||n.options.databaseURL;r===void 0&&(n.options.projectId||pe("Can't determine Firebase Database URL. Be sure to include  a Project ID when calling firebase.initializeApp()."),H("Using default host for project ",n.options.projectId),r=`${n.options.projectId}-default-rtdb.firebaseio.com`);let o=Ti(r,i),a=o.repoInfo,l;typeof process<"u"&&js&&(l=js[Dh]),l?(r=`http://${l}?ns=${a.namespace}`,o=Ti(r,i),a=o.repoInfo):o.repoInfo.secure;const c=new Hc(n.name,n.options,e);nh("Invalid Firebase Database URL",o),b(o.path)||pe("Database URL must point to the root of a Firebase Database (not including a child path).");const h=Bh(a,n,c,new Uc(n,t));return new Fh(h,n)}function xh(n,e){const t=zn[e];(!t||t[n.key]!==n)&&pe(`Database ${e}(${n.repoInfo_}) has already been deleted.`),Eh(n),delete t[n.key]}function Bh(n,e,t,s){let i=zn[e.name];i||(i={},zn[e.name]=i);let r=i[n.toURLString()];return r&&pe("Database initialized multiple times. Please make sure the format of the database URL matches with each database() call."),r=new ah(n,Mh,t,s),i[n.toURLString()]=r,r}class Fh{constructor(e,t){this._repoInternal=e,this.app=t,this.type="database",this._instanceStarted=!1}get _repo(){return this._instanceStarted||(lh(this._repoInternal,this.app.options.appId,this.app.options.databaseAuthVariableOverride),this._instanceStarted=!0),this._repoInternal}get _root(){return this._rootInternal||(this._rootInternal=new me(this._repo,R())),this._rootInternal}_delete(){return this._rootInternal!==null&&(xh(this._repo,this.app.name),this._repoInternal=null,this._rootInternal=null),Promise.resolve()}_checkNotDeleted(e){this._rootInternal===null&&pe("Cannot call "+e+" on a deleted database.")}}function Wh(n=hc(),e){const t=ac(n,"database").getImmediate({identifier:e});if(!t._instanceStarted){const s=Ya("database");s&&Gh(t,...s)}return t}function Gh(n,e,t,s={}){n=Ie(n),n._checkNotDeleted("useEmulator");const i=`${e}:${t}`,r=n._repoInternal;if(n._instanceStarted){if(i===n._repoInternal.repoInfo_.host&&Ft(s,r.repoInfo_.emulatorOptions))return;pe("connectDatabaseEmulator() cannot initialize or alter the emulator configuration after the database instance has started.")}let o;if(r.repoInfo_.nodeAdmin)s.mockUserToken&&pe('mockUserToken is not supported by the Admin SDK. For client access with mock users, please use the "firebase" package instead of "firebase-admin".'),o=new Pt(Pt.OWNER);else if(s.mockUserToken){const a=typeof s.mockUserToken=="string"?s.mockUserToken:qa(s.mockUserToken,n.app.options.projectId);o=new Pt(a)}es(e)&&(ja(e),Xa("Database",!0)),Lh(r,i,s,o)}function Uh(n){Ic(dc),Gt(new mt("database",(e,{instanceIdentifier:t})=>{const s=e.getProvider("app").getImmediate(),i=e.getProvider("auth-internal"),r=e.getProvider("app-check-internal");return Ph(s,i,r,t)},"PUBLIC").setMultipleInstances(!0)),Fe(qs,zs,n),Fe(qs,zs,"esm2020")}de.prototype.simpleListen=function(n,e){this.sendRequest("q",{p:n},e)};de.prototype.echo=function(n,e){this.sendRequest("echo",{d:n},e)};Uh();const Hh={apiKey:"AIzaSyDhDhpFMVbXOq04J2jZkGrfjeovdTT6U2o",authDomain:"tiny-towns-multiplayer.firebaseapp.com",databaseURL:"https://tiny-towns-multiplayer-default-rtdb.europe-west1.firebasedatabase.app",projectId:"tiny-towns-multiplayer",storageBucket:"tiny-towns-multiplayer.firebasestorage.app",messagingSenderId:"374830147876",appId:"1:374830147876:web:93ffbe5825d8d3af982bb1"},$h=Xi(Hh),j=Wh($h);class Vh{gameId=null;playerId;isHost=!1;localGame;masterBuilderId=null;myName="Unknown";currentRound=1;onStateChange=null;onGameStart=null;constructor(e){this.localGame=e,this.playerId="player_"+Math.random().toString(36).substr(2,9)}async createGame(e,t){const s=Y(j,"games"),i=Oh(s);this.gameId=i.key,this.isHost=!0,this.myName=e;const r={status:"LOBBY",hostId:this.playerId,deck:t,currentResource:null,masterBuilderIndex:0,roundNumber:1,playerOrder:[this.playerId],players:{[this.playerId]:{name:e,score:0,isReady:!0,placedRound:0,isGameOver:!1,board:this.serializeBoard()}}};return await Rn(i,r),this.subscribeToGame(),Ri(i).remove(),this.gameId}async joinGame(e,t){const s=Y(j,`games/${e}`);if(!(await On(s)).exists())throw new Error("Game not found");this.gameId=e,this.isHost=!1,this.myName=t;const r=Y(j,`games/${e}/players/${this.playerId}`);await Rn(r,{name:t,score:0,isReady:!0,placedRound:0,isGameOver:!1,board:this.serializeBoard()});const o=Y(j,`games/${e}/playerOrder`),l=(await On(o)).val()||[];l.includes(this.playerId)||(l.push(this.playerId),await Rn(o,l)),Ri(r).remove(),this.subscribeToGame()}async startGame(){if(!this.gameId)return;const e=Y(j,`games/${this.gameId}`),s=(await On(Qe(e,"players"))).val()||{},i=Object.keys(s),r=[...He].sort(()=>Math.random()-.5),o={status:"PLAYING",currentResource:null,roundNumber:1,masterBuilderIndex:0,playerOrder:i};i.forEach(a=>{const l=r.pop(),c=r.pop();l&&c&&(o[`players/${a}/monumentOptions`]=[l.name,c.name],o[`players/${a}/monumentChosen`]=!1)}),await ce(e,o)}async selectMonument(e){if(!this.gameId||!this.playerId)return;const t=Y(j,`games/${this.gameId}/players/${this.playerId}`);await ce(t,{activeMonument:e,monumentChosen:!0})}async updateDeck(e){!this.isHost||!this.gameId||await ce(Y(j,`games/${this.gameId}`),{deck:e})}subscribeToGame(){if(!this.gameId)return;const e=Y(j,`games/${this.gameId}`);kh(e,t=>{const s=t.val();if(!s)return;s.status==="PLAYING"&&this.localGame.gameRegistry.length===0&&(this.syncDeck(s.deck),this.onGameStart&&this.onGameStart());const i=s.playerOrder||[],r=Array.isArray(i)?i:Object.values(i);if(r.length>0){const o=(s.masterBuilderIndex||0)%r.length;this.masterBuilderId=r[o]}s.currentResource===void 0||s.currentResource===""?this.localGame.currentResource=null:this.localGame.currentResource=s.currentResource,this.currentRound=s.roundNumber||1,this.onStateChange&&this.onStateChange(s),this.isHost&&s.status==="PLAYING"&&setTimeout(()=>this.checkTurnComplete(s),10)})}async setGlobalResource(e){if(!this.gameId||this.playerId!==this.masterBuilderId)return;const t={};t[`games/${this.gameId}/currentResource`]=e,await ce(Y(j),t)}async commitTurn(){if(!this.gameId)return;const e={},t=`games/${this.gameId}/players/${this.playerId}`;e[`${t}/board`]=this.serializeBoard(),e[`${t}/score`]=this.localGame.getScore().total,e[`${t}/placedRound`]=this.currentRound,await ce(Y(j),e)}async saveBoardOnly(){if(!this.gameId)return;console.log("Saving board state (Turn not finished)...");const e={},t=`games/${this.gameId}/players/${this.playerId}`;e[`${t}/board`]=this.serializeBoard(),e[`${t}/score`]=this.localGame.getScore().total,await ce(Y(j),e)}async declareGameOver(){if(!this.gameId)return;const e={},t=`games/${this.gameId}/players/${this.playerId}`;e[`${t}/isGameOver`]=!0,e[`${t}/placedRound`]=this.currentRound,await ce(Y(j),e),this.isHost&&setTimeout(()=>{},10)}async checkTurnComplete(e){if(!e||!e.players)return;const t=Object.values(e.players),s=e.roundNumber||1,i=e.playerOrder||[];if(t.every(d=>d.isGameOver===!0)){e.status!=="FINISHED"&&(console.log("GAME OVER FOR EVERYONE"),await ce(Y(j,`games/${this.gameId}`),{status:"FINISHED"}));return}const o=e.currentResource!==void 0&&e.currentResource!==null,a=t.every(d=>d.placedRound===s||d.isGameOver===!0),l=(e.masterBuilderIndex||0)%i.length,c=i[l],h=e.players[c]&&e.players[c].isGameOver;let u=!1;if(o&&a?(console.log(`Round ${s} Complete. Rotating.`),u=!0):!o&&h&&(console.log("Current Master Builder is finished. Skipping their turn."),u=!0),u){let d=e.masterBuilderIndex||0,p=d,m=!1;const _=t.filter(N=>!N.isGameOver).length;for(let N=1;N<=i.length;N++){const E=(d+N)%i.length,I=i[E],O=e.players[I];if(O&&!O.isGameOver){if(this.playerHasBuilding(O.board,"FORT IRONWEED")&&_>1){console.log(`Skipping ${O.name} due to Fort Ironweed.`);continue}p=E,m=!0;break}}m||(p=(d+1)%i.length);const C={};C[`games/${this.gameId}/currentResource`]=null,C[`games/${this.gameId}/masterBuilderIndex`]=p,C[`games/${this.gameId}/roundNumber`]=s+1,await ce(Y(j),C)}}playerHasBuilding(e,t){return!e||!Array.isArray(e)?!1:e.some(s=>s.some(i=>typeof i=="string"&&i.toUpperCase().includes(t.toUpperCase())))}syncDeck(e){e&&(this.localGame.gameRegistry=at.filter(t=>e.includes(t.name)),this.localGame.scanForMatches())}serializeBoard(){return this.localGame.board.getGrid()}}function F(n,e="info"){const t=document.getElementById("toast-container");if(!t)return;const s=document.createElement("div");s.className=`toast ${e}`,s.textContent=n,t.appendChild(s),setTimeout(()=>{s.remove()},4e3)}function Be(n){const e=document.getElementById("resource-palette");e&&(n?(e.style.opacity="1",e.style.pointerEvents="auto"):(e.style.opacity="0.5",e.style.pointerEvents="none"))}function Qn(n,e,t,s=[]){const i=document.getElementById("resource-picker-modal"),r=document.getElementById("picker-title"),o=document.getElementById("picker-message"),a=document.getElementById("picker-options");r.textContent=n,o.textContent=e,a.innerHTML="",["WOOD","WHEAT","BRICK","GLASS","STONE"].forEach(c=>{if(s.includes(c))return;const h=document.createElement("div");h.className=`res-btn ${c}`,h.onclick=()=>{i.classList.add("hidden"),t(c)},a.appendChild(h)}),i.classList.remove("hidden")}function Kh(n,e){e.innerHTML="<strong>Players:</strong><br>",Object.values(n).forEach(t=>{const s=document.createElement("div");s.textContent=` ${t.name}`,e.appendChild(s)})}function Yh(n,e){e.innerHTML="",Object.values(n).sort((s,i)=>i.score-s.score).forEach((s,i)=>{const r=document.createElement("li");r.className="leaderboard-row",i===0&&r.classList.add("winner");const o=i+1;r.innerHTML=`
            <div style="display:flex; align-items:center;">
                <div class="rank-badge">${o}</div>
                <div class="player-info">
                    <span class="player-name">${s.name}</span>
                    <span class="player-details">
                        ${s.isGameOver?"Finished":"Playing"} 
                    </span>
                </div>
            </div>
            <div class="final-total">${s.score}</div>
        `,e.appendChild(r)})}function jh(n,e,t,s,i,r){s.classList.remove("hidden"),i.innerHTML="",Object.keys(n).forEach(o=>{if(o===t)return;const a=n[o],l=a.placedRound===e||a.isGameOver,c=l?"done":"thinking",h=o===r,u=document.createElement("div");u.className="opponent-card",h&&(u.style.border="2px solid #ff9800",u.style.background="#fff3e0");const d=document.createElement("div");d.className="opponent-name";const p=h?'<span style="font-size:1.2em; margin-right:5px;"></span>':"";d.innerHTML=`
            ${p} ${a.name}
            <span class="status-dot ${c}" title="${l?"Waiting":"Thinking"}"></span>
        `,u.appendChild(d);const m=document.createElement("div");m.className="mini-board",a.board&&Array.isArray(a.board)&&a.board.forEach(_=>{_.forEach(C=>{const N=document.createElement("div");if(N.className="mini-cell",C!=="NONE")if(["WOOD","WHEAT","BRICK","GLASS","STONE"].includes(C))N.classList.add(C);else{const E=C.replace(/ /g,"-").replace(/'/g,"").toUpperCase();N.classList.add(E),N.title=C,["COTTAGE","FARM","GRANARY","GREENHOUSE","ORCHARD","WELL","FOUNTAIN","MILLSTONE","SHED","CHAPEL","ABBEY","CLOISTER","TEMPLE","TAVERN","ALMSHOUSE","INN","FEAST-HALL","THEATER","BAKERY","TAILOR","MARKET","FACTORY","BANK","WAREHOUSE","TRADING-POST"].includes(C)||N.classList.add("MONUMENT")}m.appendChild(N)})}),u.appendChild(m),i.appendChild(u)})}function qh(n,e){n.innerHTML="";const t=document.createElement("div");t.className="setup-grid",e.forEach(s=>{const i=document.createElement("div");i.className="setup-group";const r=document.createElement("label");r.className="setup-label",r.textContent=s.label,i.appendChild(r);const o=document.createElement("select");o.className=`setup-select ${s.id}`,o.dataset.category=s.id;const a=document.createElement("option");a.value="RANDOM",a.textContent="Random",o.appendChild(a),s.options.forEach(l=>{const c=document.createElement("option");c.value=l.name,c.textContent=l.name,o.appendChild(c)}),i.appendChild(o),t.appendChild(i)}),n.appendChild(t)}function zh(n,e){const t=document.getElementById("resource-picker-modal"),s=document.getElementById("picker-title"),i=document.getElementById("picker-message"),r=document.getElementById("picker-options");s.textContent="Choose Your Monument",i.textContent="You have been granted two options. Choose one to construct in your town.",r.innerHTML="",r.style.display="flex",r.style.gap="20px",r.style.justifyContent="center",r.style.flexWrap="wrap",n.forEach(o=>{const a=document.createElement("div");a.className="monument-card-choice",a.style.border="2px solid #9c27b0",a.style.borderRadius="8px",a.style.padding="15px",a.style.cursor="pointer",a.style.background="white",a.style.width="180px",a.style.textAlign="center",a.style.transition="transform 0.2s",a.onmouseenter=()=>a.style.transform="scale(1.05)",a.onmouseleave=()=>a.style.transform="scale(1)",a.innerHTML=`
            <h4 style="color:#6a1b9a; margin:0 0 10px 0;">${o.name}</h4>
            <div class="mini-grid" style="margin: 0 auto 10px auto;">
                ${Qh(o.pattern)}
            </div>
            <p style="font-size:0.8em; color:#555;">${o.description||"Unique Scoring"}</p>
        `,a.onclick=()=>{r.style.display="",r.style.gap="",r.style.justifyContent="",t.classList.add("hidden"),e(o)},r.appendChild(a)}),t.classList.remove("hidden")}function Qh(n){let e='<div style="display:flex; flex-direction:column; gap:2px; align-items:center;">';return n.forEach(t=>{e+='<div style="display:flex; gap:2px;">',t.forEach(s=>{let i="transparent",r="1px solid transparent";s!=="NONE"&&(r="1px solid rgba(0,0,0,0.1)",s==="WOOD"&&(i="#5d4037"),s==="WHEAT"&&(i="#fdd835"),s==="BRICK"&&(i="#ef5350"),s==="GLASS"&&(i="#29b6f6"),s==="STONE"&&(i="#757575")),e+=`<div style="width:15px; height:15px; background:${i}; border:${r}; border-radius:2px;"></div>`}),e+="</div>"}),e+="</div>",e}function Xh(n,e){const t=document.getElementById("resource-picker-modal"),s=document.getElementById("picker-title"),i=document.getElementById("picker-message"),r=document.getElementById("picker-options");s.textContent="Grove University Scholarship",i.textContent="Choose a building to construct immediately for free:",r.innerHTML="",r.parentElement&&(r.parentElement.style.maxWidth="600px",r.parentElement.style.width="95%"),r.style.display="flex",r.style.gap="15px",r.style.justifyContent="center",r.style.flexWrap="wrap",r.style.padding="10px",r.style.maxHeight="70vh",r.style.overflowY="auto",n.forEach(o=>{if(o.isMonument)return;const a=document.createElement("div");a.style.border="1px solid #e0e0e0",a.style.borderRadius="12px",a.style.padding="15px 10px",a.style.cursor="pointer",a.style.background="white",a.style.width="110px",a.style.height="130px",a.style.display="flex",a.style.flexDirection="column",a.style.alignItems="center",a.style.justifyContent="space-between",a.style.transition="all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1)",a.style.boxShadow="0 2px 5px rgba(0,0,0,0.05)";let l="#ccc";o.type==="RED"?l="#ef5350":o.type==="BLUE"?l="#42a5f5":o.type==="YELLOW"?l="#fdd835":o.type==="GREEN"?l="#66bb6a":o.type==="GRAY"?l="#bdbdbd":o.type==="ORANGE"?l="#ffca28":o.type==="BLACK"&&(l="#424242"),a.style.borderBottom=`5px solid ${l}`;const c=document.createElement("div");c.style.flex="1",c.style.display="flex",c.style.alignItems="center",c.style.justifyContent="center",c.style.width="100%";const h=document.createElement("div"),u=o.name.replace(/ /g,"-").replace(/'/g,"").toUpperCase();h.className=`mini-cell ${u}`,h.style.width="50px",h.style.height="50px",h.style.transform="none",h.style.margin="0",h.style.backgroundSize="contain",h.style.backgroundRepeat="no-repeat",h.style.backgroundPosition="center",h.style.border="none",c.appendChild(h);const d=document.createElement("span");d.textContent=o.name,d.style.fontSize="0.85em",d.style.fontWeight="600",d.style.color="#333",d.style.textAlign="center",d.style.marginTop="5px",a.appendChild(c),a.appendChild(d),a.onmouseenter=()=>{a.style.transform="translateY(-4px)",a.style.boxShadow="0 8px 15px rgba(0,0,0,0.1)"},a.onmouseleave=()=>{a.style.transform="translateY(0)",a.style.boxShadow="0 2px 5px rgba(0,0,0,0.05)"},a.onclick=()=>{r.style.display="",r.style.gap="",r.style.justifyContent="",r.style.maxHeight="",r.style.overflowY="",r.style.padding="",r.parentElement&&(r.parentElement.style.maxWidth="",r.parentElement.style.width=""),t.classList.add("hidden"),e(o)},r.appendChild(a)}),t.classList.remove("hidden")}const v=new La,oe=new Pa,A=new Vh(v);let he=null,mn=[],ot="",It=!1,Oi=!1,Xn="",Ue=null;const T={startModal:document.getElementById("start-screen-modal"),landingUI:document.getElementById("landing-ui"),lobbyUI:document.getElementById("lobby-ui"),playerNameInput:document.getElementById("player-name-input"),createGameBtn:document.getElementById("create-game-ui-btn"),joinGameBtn:document.getElementById("join-game-btn"),gameIdInput:document.getElementById("game-id-input"),shareCodeDisplay:document.getElementById("share-code-display"),lobbyPlayerList:document.getElementById("lobby-player-list"),hostSettings:document.getElementById("host-settings"),guestWaitingMsg:document.getElementById("guest-waiting-msg"),startGameBtn:document.getElementById("start-game-btn"),multiplayerResultsModal:document.getElementById("multiplayer-results-modal"),leaderboardList:document.getElementById("leaderboard-list"),mpRestartBtn:document.getElementById("mp-restart-btn"),opponentsSidebar:document.getElementById("opponents-sidebar"),opponentsList:document.getElementById("opponents-list"),copyLinkBtn:document.getElementById("copy-link-btn"),gameOverModal:document.getElementById("game-over-modal"),finalScore:document.getElementById("final-score"),scoreList:document.getElementById("score-breakdown-list"),restartBtn:document.getElementById("restart-btn"),undoBtn:document.getElementById("undo-btn")},Ls=[{id:"RED",label:"Farm (Red)",options:Mi},{id:"GRAY",label:"Well (Gray)",options:Li},{id:"YELLOW",label:"Theater (Yellow)",options:xi},{id:"GREEN",label:"Tavern (Green)",options:Pi},{id:"ORANGE",label:"Chapel (Orange)",options:Fi},{id:"BLACK",label:"Factory (Black)",options:Bi}];A.onStateChange=n=>{try{if(n.status==="LOBBY"&&Kh(n.players,T.lobbyPlayerList),n.status==="PLAYING"){T.startModal.classList.contains("hidden")||T.startModal.classList.add("hidden");const e=n.players?n.players[A.playerId]:null;if(e&&e.monumentOptions&&!e.monumentChosen){const c=document.getElementById("resource-picker-modal");if(c&&c.classList.contains("hidden")){const h=e.monumentOptions.map(u=>He.find(d=>d.name===u)).filter(u=>!!u);h.length>0&&zh(h,u=>{A.selectMonument(u.name)})}return}if(e&&e.activeMonument&&!v.activeMonument){const c=He.find(d=>d.name===e.activeMonument),u=(n.deck||[]).map(d=>at.find(p=>p.name===d)).filter(d=>!!d);c&&(v.setMonument(c,u),oe.renderDeck(v.gameRegistry))}n.players&&jh(n.players,n.roundNumber||1,A.playerId,T.opponentsSidebar,T.opponentsList,rf(n));let t="Unknown";const s=n.playerOrder||[],i=Array.isArray(s)?s:Object.values(s);if(i.length>0&&n.players){const c=(n.masterBuilderIndex||0)%i.length,h=i[c];n.players[h]&&(t=n.players[h].name)}const r=A.masterBuilderId===A.playerId,o=n.currentResource!==void 0&&n.currentResource!==null,a=n.roundNumber||1,l=n.players?n.players[A.playerId]:null;l&&(It=Number(l.placedRound)===Number(a)),o?It?(ot="Waiting for other players to finish placing...",Be(!1)):(ot="",Be(!1)):r?(ot="YOU are the Master Builder! Choose a resource.",Be(!0)):(ot=`Waiting for ${t} to choose a resource...`,Be(!1))}n.status==="FINISHED"&&(T.gameOverModal.classList.add("hidden"),Yh(n.players,T.leaderboardList),T.multiplayerResultsModal.classList.remove("hidden")),v.currentResource=n.currentResource||null,X()}catch(e){console.error("Error in onStateChange:",e)}};A.onGameStart=()=>{T.startModal.classList.add("hidden"),X(),oe.renderDeck(v.gameRegistry)};oe.onResourceSelect=n=>{he||(v.currentResource?console.log("Blocked: Resource already active:",v.currentResource):A.setGlobalResource(n))};oe.onCellClick=(n,e)=>{const s=v.board.getGrid()[n][e];if(Ue){if(s!=="NONE"){F("You must choose an EMPTY square!","error");return}try{v.placeFreeBuilding(n,e,Ue),Ue=null,A.saveBoardOnly(),X(),gn(),F("Scholarship claimed!","success")}catch{F("Error placing building.","error")}return}if(s&&s.toUpperCase()==="WAREHOUSE"){nf(n,e);return}try{he?ef(n,e):Jh(n,e)}catch(i){F(i.message,"error")}};oe.onSwapClick=tf;async function Jh(n,e){if(It){F("You have already placed a resource this turn!","error");return}if(!v.currentResource){F("Waiting for Master Builder...","info");return}const t=A.masterBuilderId===A.playerId;if(v.board.getGrid()[n][e].toUpperCase()==="COTTAGE"&&v.hasStatueOfBondmaker()){const r=v.board.getMetadata(n,e);if(r&&r.storedResource){F("This Cottage is already holding a resource!","error");return}if(t){F("The Bondmaker only works when OTHER players name a resource!","error");return}}try{v.placeResource(n,e),await A.commitTurn(),X(),gn()}catch(r){F(r.message,"error")}}oe.onBuildClick=n=>{he=n,mn=sf(n),X()};oe.onCancelClick=()=>{go(),X()};T.undoBtn.onclick=()=>{F("Undo not yet supported in Multiplayer!","info")};T.mpRestartBtn.onclick=()=>{location.reload()};T.createGameBtn.onclick=async()=>{const n=T.playerNameInput.value||"Host";try{const e=mo(),t=await A.createGame(n,e.map(s=>s.name));po(t,!0)}catch(e){console.error("Firebase Error:",e),F("Error creating game.","error")}};T.joinGameBtn.onclick=async()=>{const n=T.playerNameInput.value||"Guest",e=T.gameIdInput.value.trim();if(!e){F("Please enter a code!","error");return}try{await A.joinGame(e,n),po(e,!1)}catch(t){F("Could not join game: "+t,"error")}};T.startGameBtn.onclick=async()=>{const n=Zh();await A.updateDeck(n.map(e=>e.name)),await A.startGame()};T.shareCodeDisplay.onclick=()=>{const n=T.shareCodeDisplay.innerText.replace("Code: ","");navigator.clipboard.writeText(n),F("Code copied!","success")};T.restartBtn.onclick=()=>{location.reload()};T.copyLinkBtn.onclick=()=>{if(!Xn)return;const n=`${window.location.origin}${window.location.pathname}?gameId=${Xn}`;navigator.clipboard.writeText(n).then(()=>{F("Invite Link copied!","success")})};function po(n,e){Xn=n,T.landingUI.classList.add("hidden"),T.lobbyUI.classList.remove("hidden"),T.shareCodeDisplay.innerText=`Code: ${n}`,e?(T.hostSettings.classList.remove("hidden"),T.guestWaitingMsg.classList.add("hidden"),qh(document.getElementById("setup-container"),Ls)):(T.hostSettings.classList.add("hidden"),T.guestWaitingMsg.classList.remove("hidden"))}function Zh(){const n=[Jn],e=document.querySelectorAll(".setup-select");return e.length===0?mo():(e.forEach(t=>{const s=t.dataset.category;if(!s)return;const i=Ls.find(o=>o.id===s);if(!i)return;let r;t.value==="RANDOM"?r=_o(i.options):r=i.options.find(o=>o.name===t.value),r&&n.push(r)}),n)}function mo(){const n=[Jn];return Ls.forEach(e=>{n.push(_o(e.options))}),n}function ef(n,e){const s=v.board.getGrid()[n][e],i=mn.some(c=>c.row===n&&c.col===e),r=he?he.buildingName.toUpperCase():"",l=(v.hasObeliskAbility()||r==="SHED")&&s==="NONE";if(i||l){if(s&&s.toUpperCase().replace("_"," ")==="TRADING POST"){F("Cannot build on Trading Post.","error");return}const c=v.constructBuilding(he,n,e);if(A.saveBoardOnly(),go(),c.type==="TRIGGER_EFFECT"){if(c.effectType==="FACTORY")Qn("Setup Factory","Choose a resource to store on your Factory:",h=>{v.setBuildingStorage(n,e,h),A.saveBoardOnly(),X()});else if(c.effectType==="BANK"){const h=v.getForbiddenResources();Qn("Setup Bank",`Choose a resource to store on your Bank.
You will NOT be able to pick this resource as Master Builder!`,u=>{v.setBuildingStorage(n,e,u),A.saveBoardOnly(),X()},h)}else if(c.effectType==="GROVE_UNIVERSITY"){Xh(v.gameRegistry,h=>{Ue=h.name,F(`Select an empty square to build the ${h.name}.`,"success"),X()});return}}X(),gn()}}function tf(){Qn("Factory Swap","Select the resource you want to use this turn:",async n=>{const e=v.currentResource;v.currentResource=n,F(`Factory activated! Swapped ${e} for ${n}.`,"success"),X()})}function nf(n,e){if(It||!v.currentResource)return;const t=v.getWarehouseContents(n,e),s=t.length<3,i=v.currentResource,r=document.getElementById("resource-picker-modal"),o=document.getElementById("picker-options"),a=document.getElementById("picker-title"),l=document.getElementById("picker-message");if(a.textContent="Warehouse Manager",l.textContent=`Current Resource: ${i}`,o.innerHTML="",s){const c=document.createElement("button");c.className="primary-btn",c.style.width="100%",c.style.marginBottom="20px",c.innerHTML=` <strong>Store ${i}</strong> <br><span style="font-size:0.8em; font-weight:normal">(Ends Turn)</span>`,c.onclick=()=>{v.storeInWarehouse(n,e,i),Ai(!0),r.classList.add("hidden")},o.appendChild(c)}else{const c=document.createElement("p");c.textContent="Warehouse Full (Max 3)",c.style.color="#d32f2f",c.style.fontWeight="bold",c.style.textAlign="center",o.appendChild(c)}if(t.length>0){const c=document.createElement("div");c.style.borderTop="1px solid #ddd",c.style.margin="15px 0",o.appendChild(c);const h=document.createElement("p");h.innerHTML=`Swap <strong>${i}</strong> for:`,h.style.textAlign="center",o.appendChild(h);const u=document.createElement("div");u.style.display="flex",u.style.gap="15px",u.style.justifyContent="center",t.forEach((d,p)=>{const m=document.createElement("div");m.style.display="flex",m.style.flexDirection="column",m.style.alignItems="center";const _=document.createElement("div");_.className=`res-btn ${d}`,_.textContent=d[0],_.style.cursor="pointer",_.onclick=()=>{const C=v.swapInWarehouse(n,e,p,i);C&&(v.currentResource=C,F(`Swapped! Place ${C} on the board.`,"success"),Ai(!1),r.classList.add("hidden"))},m.appendChild(_),u.appendChild(m)}),o.appendChild(u)}r.classList.remove("hidden")}async function Ai(n){try{n?await A.commitTurn():await A.saveBoardOnly(),X(),gn()}catch(e){F("Error saving warehouse: "+e,"error")}}function go(){he=null,mn=[]}function sf(n){const e=[];return n.pattern.forEach((t,s)=>{t.forEach((i,r)=>{i!=="NONE"&&e.push({row:n.row+s,col:n.col+r})})}),e}function _o(n){return n[Math.floor(Math.random()*n.length)]}function X(){let n=!1;if(v.currentResource&&!It){const i=A.masterBuilderId===A.playerId,r=v.canFactorySwap(v.currentResource);!i&&r&&(n=!0)}oe.toggleFactoryAction(n,v.currentResource||"");let e=[];A.masterBuilderId===A.playerId&&!v.currentResource&&(e=v.getForbiddenResources());let s=ot;Ue&&(s=` BONUS: Click an empty square for your ${Ue}!`,Be(!1)),oe.render(v,he,mn,s,e)}function gn(){if(!Oi&&v.checkGameOver()&&!he){const n=v.getScore();T.finalScore.textContent=n.total.toString(),T.scoreList.innerHTML="",Object.entries(n.breakdown).forEach(([e,t])=>{t!==0&&ki(e,t)}),n.penaltyCount>0&&ki("Empty Spaces",-n.penaltyCount,!0),T.gameOverModal.classList.remove("hidden"),A.declareGameOver(),Oi=!0,Be(!1)}}function ki(n,e,t=!1){const s=document.createElement("li");s.className="score-item",t&&(s.classList.add("penalty-text"),s.style.color="#ef5350"),s.style.display="flex",s.style.justifyContent="space-between",s.innerHTML=`<span>${n.toLowerCase()}</span><strong>${e}</strong>`,T.scoreList.appendChild(s)}function rf(n){const e=n.playerOrder||[],t=Array.isArray(e)?e:Object.values(e);if(t.length>0){const s=(n.masterBuilderIndex||0)%t.length;return t[s]}return null}(function(){const t=new URLSearchParams(window.location.search).get("gameId");t&&(T.gameIdInput.value=t,T.playerNameInput.focus(),F(`Invite code ${t} detected! Enter your name to join.`,"success"),T.createGameBtn.parentElement?.classList.add("hidden"))})();window.setMonument=n=>{const e=He.find(s=>s.name.toUpperCase().includes(n.toUpperCase()));if(!e){console.error(`Could not find monument matching "${n}". Available:`,He.map(s=>s.name));return}console.log(`Force-switching monument to: ${e.name}`);const t=v.gameRegistry.filter(s=>!s.isMonument);v.setMonument(e,t),oe.renderDeck(v.gameRegistry),X(),A.gameId&&A.selectMonument(e.name),F(`Debug: Switched to ${e.name}`,"success")};console.log(" DEBUG MODE: Type setMonument('Statue') in console to switch monuments.");
