(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))t(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&t(a)}).observe(document,{childList:!0,subtree:!0});function n(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function t(s){if(s.ep)return;s.ep=!0;const r=n(s);fetch(s.href,r)}})();const o={WOOD:"WOOD",WHEAT:"WHEAT",BRICK:"BRICK",GLASS:"GLASS",STONE:"STONE",NONE:"NONE"},T={COTTAGE:"COTTAGE",TAVERN:"TAVERN",BARRETT_CASTLE:"BARRETT_CASTLE"};class V{amount;constructor(e){this.amount=e}getFedPositions(e,n,t){return Array(this.amount).fill({r:-1,c:-1})}}class J{getFedPositions(e,n,t){const s=[];return[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]].forEach(([a,i])=>{const l=e+a,d=n+i;l>=0&&l<4&&d>=0&&d<4&&s.push({r:l,c:d})}),s}}class Q{getFedPositions(e,n,t){const a=new Set,i=[],l=(d,u)=>{const h=t[d][u];return h===T.COTTAGE||h===T.BARRETT_CASTLE};for(let d=0;d<4;d++)for(let u=0;u<4;u++){const h=`${d},${u}`;if(a.has(h)||!l(d,u))continue;const f=[],N=[{r:d,c:u}];for(a.add(h);N.length>0;){const y=N.pop();f.push(y);const O=[[-1,0],[1,0],[0,-1],[0,1]];for(const[A,w]of O){const p=y.r+A,m=y.c+w,g=`${p},${m}`;p>=0&&p<4&&m>=0&&m<4&&!a.has(g)&&l(p,m)&&(a.add(g),N.push({r:p,c:m}))}}i.push(f)}return i.length===0?[]:(i.sort((d,u)=>u.length-d.length),i[0])}}class X{getFedPositions(e,n,t){const s=[];for(let r=0;r<4;r++)r!==n&&s.push({r:e,c:r});for(let r=0;r<4;r++)r!==e&&s.push({r,c:n});return s}}class B{points;requiresFood;constructor(e,n=!1){this.points=e,this.requiresFood=n}score(e){return this.requiresFood&&!e.fedState?0:this.points}}class Z{targetTypes;pointsPerNeighbor;constructor(e,n){this.targetTypes=e,this.pointsPerNeighbor=n}score(e){let n=0;const t=[[-1,0],[1,0],[0,-1],[0,1]];for(const[s,r]of t){const a=e.row+s,i=e.col+r;if(a>=0&&a<4&&i>=0&&i<4){const l=e.grid[a][i];this.targetTypes.includes(l)&&(n+=this.pointsPerNeighbor)}}return n}}class x{score(e){const n=new Set;for(let t=0;t<4;t++)t!==e.col&&this.addIfBuilding(n,e.grid[e.row][t]);for(let t=0;t<4;t++)t!==e.row&&this.addIfBuilding(n,e.grid[t][e.col]);return n.size}addIfBuilding(e,n){["NONE","WOOD","WHEAT","BRICK","GLASS","STONE"].includes(n)||e.add(n)}}class ee{score(e){let n=0;return Object.values(e.counts).forEach(t=>{t===1&&(n+=1)}),n}}class te{multiplier;constructor(e){this.multiplier=e}score(e){const n=new Set,t=[[-1,0],[1,0],[0,-1],[0,1]],s=["NONE","WOOD","WHEAT","BRICK","GLASS","STONE"];for(const[r,a]of t){const i=e.row+r,l=e.col+a;if(i>=0&&i<4&&l>=0&&l<4){const d=e.grid[i][l];s.includes(d)||n.add(d)}}return n.size*this.multiplier}}class ne{score(e){const n=`${e.row},${e.col}`,t=e.metadata.get(n);return t&&t.savedScore||0}}class oe{score(e){let n=0;for(const t of e.validBuildingNames){const s=t.toUpperCase();e.counts[s]||n++}return n*2}}class se{score(e){let n=0;const t=new Set,s=["NONE","WOOD","WHEAT","BRICK","GLASS","STONE"],r=[[-1,0],[1,0],[0,-1],[0,1]];for(let a=0;a<4;a++)for(let i=0;i<4;i++){const l=`${a},${i}`,d=e.grid[a][i];if(t.has(l)||s.includes(d))continue;let u=0;const h=[{r:a,c:i}];for(t.add(l);h.length>0;){const f=h.pop();u++;for(const[N,y]of r){const O=f.r+N,A=f.c+y,w=`${O},${A}`;O>=0&&O<4&&A>=0&&A<4&&!t.has(w)&&e.grid[O][A]===d&&(t.add(w),h.push({r:O,c:A}))}}u>n&&(n=u)}return 1+n}}class re{score(e){let n=0;for(let t=0;t<4;t++)for(let s=0;s<4;s++){const r=e.grid[t][s],a=`${t},${s}`;r==="COTTAGE"&&(e.allFedPositions.has(a)||n++)}return n*3}}class ie{targetTypes;scoreAmount;constructor(e,n){this.targetTypes=e,this.scoreAmount=n}score(e){const n=[[-1,0],[1,0],[0,-1],[0,1]];for(const[t,s]of n){const r=e.row+t,a=e.col+s;if(r>=0&&r<4&&a>=0&&a<4){const i=e.grid[r][a];if(this.targetTypes.includes(i))return this.scoreAmount}}return 0}}class P{targetCategories;scoreAmount;constructor(e,n){this.targetCategories=e,this.scoreAmount=n}score(e){const n=[[-1,0],[1,0],[0,-1],[0,1]];for(const[t,s]of n){const r=e.row+t,a=e.col+s;if(r>=0&&r<4&&a>=0&&a<4){const i=e.grid[r][a],l=e.registry.find(d=>d.name.toUpperCase()===i.toUpperCase());if(l&&this.targetCategories.includes(l.type))return this.scoreAmount}}return 0}}class ae{score(e){let n=0;const t=e.grid[e.row][e.col];for(let s=0;s<4;s++)s!==e.col&&e.grid[e.row][s]===t&&n++;for(let s=0;s<4;s++)s!==e.row&&e.grid[s][e.col]===t&&n++;return n}}class ce{score(e){let n=1;const t=["1,1","1,2","2,1","2,2"],s=`${e.row},${e.col}`,r=e.grid[e.row][e.col];return t.forEach(a=>{if(a===s)return;const[i,l]=a.split(",").map(Number);e.grid[i][l]===r&&n++}),n}}class le{score(e){const n=e.grid[e.row][e.col],t=e.counts[n]||e.counts[n.toUpperCase()]||0;return t===0?0:t%2!==0?-1:({2:5,4:15,6:26,8:40}[t]??t*5)/t}}class de{score(e){const n=e.grid[e.row][e.col];for(let t=0;t<4;t++)if(t!==e.col&&e.grid[e.row][t]===n)return 0;for(let t=0;t<4;t++)if(t!==e.row&&e.grid[t][e.col]===n)return 0;return 3}}class ue{score(e){return e.fedCottageCount}}class pe{requiredNeighbors;scoreAmount;constructor(e,n){this.requiredNeighbors=e,this.scoreAmount=n}score(e){let n=0;const t=[[-1,0],[1,0],[0,-1],[0,1]];for(const[s,r]of t){const a=e.row+s,i=e.col+r;a>=0&&a<4&&i>=0&&i<4&&e.allFedPositions.has(`${a},${i}`)&&n++}return n>=this.requiredNeighbors?this.scoreAmount:0}}class he{targetName;constructor(e){this.targetName=e}score(e){const n=[{r:0,c:0},{r:0,c:3},{r:3,c:0},{r:3,c:3}];let t=0;return n.forEach(s=>{e.grid[s.r][s.c]===this.targetName&&t++}),t}}class me{restrictedCategories;scoreAmount;constructor(e,n){this.restrictedCategories=e,this.scoreAmount=n}score(e){const n=[[-1,0],[1,0],[0,-1],[0,1]];for(const[t,s]of n){const r=e.row+t,a=e.col+s;if(r>=0&&r<4&&a>=0&&a<4){const i=e.grid[r][a],l=e.registry.find(d=>d.name.toUpperCase()===i.toUpperCase());if(l&&this.restrictedCategories.includes(l.type))return 0}}return this.scoreAmount}}const U={name:"Cottage",type:"BLUE",pattern:[[o.NONE,o.WHEAT],[o.BRICK,o.GLASS]],scorer:new B(3,!0),feedCost:1,description:"3 points if fed."},Ee=[U],fe={name:"Farm",type:"RED",pattern:[[o.WHEAT,o.WHEAT],[o.WOOD,o.WOOD]],feeder:new V(4),description:"Feeds 4 cottages anywhere on the board."},ge={name:"Granary",type:"RED",pattern:[[o.WHEAT,o.WHEAT],[o.WOOD,o.BRICK]],feeder:new J,description:"Feeds all buildings in the 8 squares surrounding it."},Ne={name:"Greenhouse",type:"RED",pattern:[[o.WHEAT,o.GLASS],[o.WOOD,o.WOOD]],feeder:new Q,description:"Feeds one contiguous group of Cottages."},Oe={name:"Orchard",type:"RED",description:"Feeds Cottages in the same row and column.",pattern:[[o.STONE,o.WHEAT],[o.WHEAT,o.WOOD]],feeder:new X},H=[fe,ge,Ne,Oe],Se={name:"Well",type:"GRAY",pattern:[[o.WOOD,o.STONE]],description:"1 point for each adjacent cottage.",scorer:new Z([T.COTTAGE,T.BARRETT_CASTLE],1)},ye={name:"Fountain",type:"GRAY",description:"2 points if adjacent to a Cottage.",pattern:[[o.WOOD,o.STONE]],scorer:new ie([T.COTTAGE,T.BARRETT_CASTLE],2)},Ce={name:"Millstone",type:"GRAY",description:"2 points if adjacent to a Red or Yellow building.",pattern:[[o.WOOD,o.STONE]],scorer:new P(["RED","YELLOW"],2)},Te={name:"Shed",type:"GRAY",description:"Worth 1 point. (Standard placement rules apply).",pattern:[[o.WOOD,o.STONE]],scorer:new B(1)},K=[Se,ye,Ce,Te],Ae={name:"Almshouse",type:"GREEN",pattern:[[o.STONE,o.STONE,o.GLASS]],description:"Score increasing points for each Almshouse you have built.",scorer:new le},Re={name:"Inn",type:"GREEN",pattern:[[o.WHEAT,o.STONE,o.GLASS]],description:"Get 3 points if not in a row or column with another Inn.",scorer:new de},be={name:"Feast Hall",type:"GREEN",pattern:[[o.WOOD,o.WOOD,o.GLASS]],description:"Get 2 points, and an extra 1 if you have more Feast Halls than the player on your right.",scorer:new B(2)},Le={name:"Tavern",type:"GREEN",pattern:[[o.BRICK,o.BRICK,o.GLASS]],description:"Score increasing points for each Tavern you have built."},$=[Le,Re,Ae,be],Be={name:"Theater",type:"YELLOW",pattern:[[o.NONE,o.STONE,o.NONE],[o.WOOD,o.GLASS,o.WOOD]],scorer:new x,description:"1 point for each unique building type in the same row and column."},we={name:"Bakery",type:"YELLOW",description:"3 points if adjacent to a Food (Red) building.",pattern:[[o.NONE,o.WHEAT,o.NONE],[o.BRICK,o.GLASS,o.BRICK]],scorer:new P(["RED"],3)},Ge={name:"Market",type:"YELLOW",description:"1 point for each other Market in the same row or column.",pattern:[[o.NONE,o.WOOD,o.NONE],[o.STONE,o.GLASS,o.STONE]],scorer:new ae},Me={name:"Tailor",type:"YELLOW",description:"1 point. +1 point for each other Tailor in the 4 center squares.",pattern:[[o.NONE,o.WHEAT,o.NONE],[o.STONE,o.GLASS,o.STONE]],scorer:new ce},k=[Be,we,Ge,Me],Ie={name:"Factory",type:"BLACK",pattern:[[o.WOOD,o.NONE,o.NONE,o.NONE],[o.BRICK,o.STONE,o.STONE,o.BRICK]],description:"Place 1 resource on the factory, whenever another player chooses that resource, play a different one instead."},De={name:"Trading Post",type:"BLACK",description:"1 point. Counts as a WILD (any) resource for future buildings.",pattern:[[o.STONE,o.STONE,o.NONE],[o.WOOD,o.WOOD,o.BRICK]],scorer:new B(1)},We={name:"Bank",type:"BLACK",description:"4 points. Place a resource on this building - you can no longer select this resource as master builder.",pattern:[[o.STONE,o.STONE,o.NONE],[o.WOOD,o.WOOD,o.BRICK]],scorer:new B(4)},ve={name:"Warehouse",type:"BLACK",description:"-1 for each resource on this building. YADA YADA YADA",pattern:[[o.STONE,o.STONE,o.NONE],[o.WOOD,o.WOOD,o.BRICK]],scorer:new B(1)},F=[Ie,De,We,ve],Pe={name:"Chapel",type:"ORANGE",pattern:[[o.NONE,o.NONE,o.GLASS],[o.STONE,o.GLASS,o.STONE]],description:"Scores 1 point for each fed cottage.",scorer:new ue},Ue={name:"Abbey",type:"ORANGE",pattern:[[o.NONE,o.NONE,o.GLASS],[o.BRICK,o.STONE,o.STONE]],description:"3 points if not adjacent to a black, green or yellow building.",scorer:new me(["BLACK","GREEN","YELLOW"],3)},He={name:"Cloister",type:"ORANGE",pattern:[[o.NONE,o.NONE,o.GLASS],[o.WOOD,o.BRICK,o.STONE]],description:"Scores 1 point for each cloister in a corner of your town.",scorer:new he("CLOISTER")},Ke={name:"Temple",type:"ORANGE",pattern:[[o.NONE,o.NONE,o.GLASS],[o.BRICK,o.BRICK,o.STONE]],description:"4 points if adjacent to 2 or more fed cottages.",scorer:new pe(2,4)},_=[Pe,Ue,He,Ke],$e={name:"Archive",type:"PURPLE",pattern:[[o.WHEAT,o.WHEAT],[o.BRICK,o.GLASS]],scorer:new ee,isMonument:!0},ke={name:"Barrett Castle",type:"PURPLE",pattern:[[o.WHEAT,o.NONE,o.NONE,o.STONE],[o.WOOD,o.GLASS,o.GLASS,o.BRICK]],scorer:new B(5,!0),feedCost:1,countsAs:[T.COTTAGE],isMonument:!0},Fe={name:"Obelisk of the Crescent",type:"PURPLE",pattern:[[o.WHEAT,o.NONE,o.NONE],[o.BRICK,o.GLASS,o.BRICK]],isMonument:!0},_e={name:"Mandras",type:"PURPLE",pattern:[[o.WHEAT,o.GLASS],[o.BRICK,o.WOOD]],scorer:new te(2),isMonument:!0},qe={name:"Shrine of the Elder Tree",type:"PURPLE",pattern:[[o.BRICK,o.WHEAT,o.STONE],[o.WOOD,o.GLASS,o.WOOD]],isMonument:!0,scorer:new ne},Ye={name:"Baths",type:"PURPLE",pattern:[[o.NONE,o.WHEAT,o.NONE],[o.STONE,o.GLASS,o.WOOD],[o.BRICK,o.NONE,o.BRICK]],isMonument:!0,scorer:new oe},je={name:"Forum",type:"PURPLE",pattern:[[o.NONE,o.NONE,o.WHEAT,o.NONE],[o.BRICK,o.BRICK,o.STONE,o.WOOD]],isMonument:!0,scorer:new se},ze={name:"Mausoleum",type:"PURPLE",pattern:[[o.WOOD,o.WOOD],[o.BRICK,o.STONE]],isMonument:!0,scorer:new re},Ve={name:"Cathedral",type:"PURPLE",pattern:[[o.NONE,o.WHEAT],[o.STONE,o.GLASS]],isMonument:!0,scorer:new B(2,!1)},Je=[$e,ke,Fe,_e,qe,Ye,je,ze,Ve],D=[...Ee,...H,...K,...$,...k,...F,..._,...Je];class W{grid;size=4;metadata=new Map;constructor(){this.grid=Array(this.size).fill(null).map(()=>Array(this.size).fill(o.NONE))}place(e,n,t){if(!this.isValid(e,n))throw new Error(`Invalid coordinate: ${e}, ${n}`);if(this.grid[e][n]!==o.NONE)throw new Error("Spot already occupied");this.grid[e][n]=t}placeBuilding(e,n,t){this.isValid(e,n)&&(this.grid[e][n]=t)}constructBuilding(e,n,t,s){if(!e.some(a=>a.row===n&&a.col===t)&&this.grid[n][t]!=="NONE")throw new Error("Building must be placed on one of the pattern squares.");this.clear(e),this.grid[n][t]=s}clear(e){e.forEach(({row:n,col:t})=>{this.isValid(n,t)&&(this.grid[n][t]=o.NONE,this.metadata.delete(`${n},${t}`))})}getGrid(){return this.grid.map(e=>[...e])}isValid(e,n){return e>=0&&e<this.size&&n>=0&&n<this.size}remove(e,n){this.isValid(e,n)&&(this.grid[e][n]="NONE",this.metadata.delete(`${e},${n}`))}setMetadata(e,n,t){this.metadata.set(`${e},${n}`,t)}getMetadata(e,n){return this.metadata.get(`${e},${n}`)}}class Qe{static rotate(e){return e[0].map((n,t)=>e.map(s=>s[t]).reverse())}static flip(e){return e.map(n=>[...n].reverse())}static getSymmetries(e){const n=new Set;let t=e;for(let s=0;s<4;s++)n.add(JSON.stringify(t)),n.add(JSON.stringify(this.flip(t))),t=this.rotate(t);return Array.from(n).map(s=>JSON.parse(s))}static findMatches(e,n){const t=this.getSymmetries(n.pattern),s=[];for(const r of t){const a=r.length,i=r[0].length;for(let l=0;l<=4-a;l++)for(let d=0;d<=4-i;d++)this.isMatch(e,r,l,d)&&s.push({row:l,col:d,pattern:r})}return s}static isMatch(e,n,t,s){return n.every((r,a)=>r.every((i,l)=>{const d=e[t+a][s+l];return!!(i==="NONE"||d===i||d&&d.toUpperCase().replace("_"," ")==="TRADING POST")}))}}class Xe{static calculateScore(e,n,t){const a={},i=p=>t.find(m=>m.name.toUpperCase()===p.toUpperCase()),l={};let d=0,u=0;const h=new Set;for(let p=0;p<4;p++)for(let m=0;m<4;m++){const g=e[p][m];if(!this.isBuilding(g)){d++;continue}l[g]=(l[g]||0)+1;const C=i(g);if(C&&C.feeder){const R=C.feeder.getFedPositions(p,m,e);R.length>0&&R[0].r===-1?u+=R.length:R.forEach(L=>h.add(`${L.r},${L.c}`))}}const f=new Set;let N=0;for(let p=0;p<4;p++)for(let m=0;m<4;m++){const g=e[p][m];if(!this.isBuilding(g))continue;const C=i(g);if(C&&C.feedCost){const R=`${p},${m}`;let L=!1;h.has(R)?L=!0:u>=C.feedCost&&(u-=C.feedCost,L=!0),L&&(f.add(R),g===T.COTTAGE&&N++,g===T.BARRETT_CASTLE&&(N+=2))}}const y=t.map(p=>p.name);for(let p=0;p<4;p++)for(let m=0;m<4;m++){const g=e[p][m];if(!this.isBuilding(g))continue;const C=i(g);if(C&&C.scorer){const R={grid:e,row:p,col:m,counts:l,fedState:f.has(`${p},${m}`),metadata:n,validBuildingNames:y,allFedPositions:f,registry:t,fedCottageCount:N},L=C.scorer.score(R);a[g]=(a[g]||0)+L}}if(l[T.TAVERN]){const p=[0,2,5,9,14,20],m=Math.min(l[T.TAVERN],5);a[T.TAVERN]=p[m]}let O=0;Object.values(a).forEach(p=>O+=p);const w=(l.CATHEDRAL||0)>0?0:d;return{total:O-w,breakdown:a,penaltyCount:w}}static isBuilding(e){return!["NONE","WOOD","WHEAT","BRICK","GLASS","STONE"].includes(e)}}class Ze{board;currentResource=null;availableMatches=[];activeMonument=null;gameRegistry=[];lastMove=null;constructor(){this.board=new W}start(){if(this.board=new W,this.currentResource=null,this.lastMove=null,this.availableMatches=[],this.gameRegistry.length===0){const e=D.filter(t=>t.isMonument),n=D.filter(t=>!t.isMonument);this.activeMonument=e[Math.floor(Math.random()*e.length)],this.gameRegistry=[...n,this.activeMonument]}}placeResource(e,n){if(!this.currentResource)throw new Error("No resource selected");this.board.place(e,n,this.currentResource),this.lastMove={r:e,c:n},this.currentResource=null,this.scanForMatches()}constructBuilding(e,n,t){const s=[];let r=0,a=!1;if(e.pattern.forEach((i,l)=>{i.forEach((d,u)=>{d&&d!=="NONE"&&s.push({row:e.row+l,col:e.col+u})})}),e.buildingName.toUpperCase()==="SHRINE OF THE ELDER TREE"){a=!0;const l=this.countBuildingsOnBoard()+1;l<6?r=l:r=8}s.forEach(i=>{const l=this.board.getGrid()[i.row][i.col];l&&l.toUpperCase().replace("_"," ")==="TRADING POST"||this.board.remove(i.row,i.col)}),this.board.placeBuilding(n,t,e.buildingName),a&&this.board.setMetadata(n,t,{savedScore:r}),this.lastMove=null,this.scanForMatches()}undo(){this.lastMove&&(this.board.remove(this.lastMove.r,this.lastMove.c),this.lastMove=null,this.scanForMatches())}canUndo(){return this.lastMove!==null}scanForMatches(){this.availableMatches=[];const e=this.board.getGrid(),n=e.some(t=>t.some(s=>this.gameRegistry.find(a=>a.name.toUpperCase()===s.toUpperCase())?.isMonument));for(const t of this.gameRegistry){if(n&&t.isMonument)continue;Qe.findMatches(e,t).forEach(r=>{this.availableMatches.push({...r,buildingName:t.name.toUpperCase()})})}}checkGameOver(){const n=this.board.getGrid().some(s=>s.some(r=>r==="NONE")),t=this.availableMatches.length>0;return!n&&!t}getScore(){return Xe.calculateScore(this.board.getGrid(),this.board.metadata,this.gameRegistry)}countBuildingsOnBoard(){const e=this.board.getGrid();let n=0;const t=["WOOD","WHEAT","BRICK","GLASS","STONE","NONE"];return e.forEach(s=>{s.forEach(r=>{t.includes(r)||n++})}),n}hasObeliskAbility(){return this.board.getGrid().some(n=>n.some(t=>t.toUpperCase().includes("OBELISK")))}}class xe{boardEl=document.getElementById("board");buildMenuEl=document.getElementById("build-menu");msgLabel=document.getElementById("message");paletteEl=document.getElementById("resource-palette");scoreEl=document.getElementById("score-display");undoBtn=document.getElementById("undo-btn");deckDisplayEl=document.getElementById("deck-display");onCellClick=()=>{};onResourceSelect=()=>{};onBuildClick=()=>{};onCancelClick=()=>{};constructor(){}render(e,n,t){this.renderHeader(e),this.renderBoard(e,n,t),this.renderSidebar(e,n),this.renderControls(e,n)}renderHeader(e){const n=e.getScore(),t=n.total+n.penaltyCount;this.scoreEl.innerHTML=`Score: ${t} <span style="font-size:12px; color:#999">(-${n.penaltyCount} empty)</span>`}renderBoard(e,n,t){const s=e.board.getGrid(),r=["WOOD","WHEAT","BRICK","GLASS","STONE"];this.boardEl.children.length===0&&s.forEach((i,l)=>{i.forEach((d,u)=>{const h=document.createElement("div");h.dataset.r=l.toString(),h.dataset.c=u.toString(),h.onclick=()=>this.onCellClick(l,u),this.boardEl.appendChild(h)})}),Array.from(this.boardEl.children).forEach(i=>{const l=parseInt(i.dataset.r),d=parseInt(i.dataset.c),u=s[l][d];if(i.className="cell",i.style.backgroundColor="",u==="NONE")i.classList.add("empty"),i.textContent="";else if(r.includes(u))i.classList.add(u),i.textContent=u;else{i.textContent="";const h=e.gameRegistry.find(f=>f.name.toUpperCase()===u.toUpperCase());if(h){if(i.classList.add("constructed"),h.isMonument)i.classList.add("MONUMENT");else{const f=u.replace(/ /g,"-").replace(/'/g,"").toUpperCase();i.classList.add(f)}i.style.backgroundColor=h.color}}if(n){const h=t.some(A=>A.row===l&&A.col===d),f=e.hasObeliskAbility(),N=n.buildingName.toUpperCase()==="SHED",y=(f||N)&&u==="NONE",O=u&&u.toUpperCase().replace("_"," ")==="TRADING POST";(h&&!O||y)&&i.classList.add("match-highlight")}u==="NONE"&&e.currentResource&&!n?(i.onmouseenter=()=>{i.classList.add("ghost",e.currentResource)},i.onmouseleave=()=>{i.classList.remove("ghost","WOOD","WHEAT","BRICK","GLASS","STONE")}):(i.onmouseenter=null,i.onmouseleave=null)}),n?(this.msgLabel.textContent=`Select a highlighted square to build your ${n.buildingName}!`,this.msgLabel.style.color="#d32f2f"):e.availableMatches.length>0?(this.msgLabel.textContent="Matches available!",this.msgLabel.style.color="#333"):e.currentResource?(this.msgLabel.textContent=`Place ${e.currentResource}...`,this.msgLabel.style.color="#333"):(this.msgLabel.textContent="Select a Resource...",this.msgLabel.style.color="#1976d2")}renderSidebar(e,n){if(this.buildMenuEl.innerHTML="",e.availableMatches.length===0){const t=document.createElement("p");t.textContent="No patterns found.",t.style.color="#777",t.style.fontStyle="italic",this.buildMenuEl.appendChild(t)}else e.availableMatches.forEach(t=>{const s=document.createElement("button");s.textContent=`Build ${t.buildingName}`;const r=t.buildingName.replace(/ /g,"-").replace(/'/g,"").toUpperCase();s.className=`build-btn ${r}`,s.onclick=()=>this.onBuildClick(t);const a=[];t.pattern&&Array.isArray(t.pattern)?t.pattern.forEach((i,l)=>{i.forEach((d,u)=>{d&&d!=="NONE"&&a.push({row:t.row+l,col:t.col+u})})}):a.push({row:t.row,col:t.col}),s.onmouseenter=()=>this.togglePreview(a,!0),s.onmouseleave=()=>this.togglePreview(a,!1),this.buildMenuEl.appendChild(s)});if(n){const t=document.createElement("button");t.textContent="Cancel Construction",t.className="secondary-btn",t.style.marginTop="10px",t.style.width="100%",t.onclick=()=>this.onCancelClick(),this.buildMenuEl.appendChild(t)}}togglePreview(e,n){e.forEach(t=>{const s=`div[data-r="${t.row}"][data-c="${t.col}"]`,r=this.boardEl.querySelector(s);r&&(n?r.classList.add("preview-target"):r.classList.remove("preview-target"))})}renderControls(e,n){this.paletteEl.innerHTML="",[o.WOOD,o.WHEAT,o.BRICK,o.GLASS,o.STONE].forEach(s=>{const r=document.createElement("div");let a=`res-btn ${s}`;e.currentResource===s&&!n&&(a+=" selected"),r.className=a,r.textContent=s.charAt(0),r.onclick=()=>this.onResourceSelect(s),this.paletteEl.appendChild(r)}),e.canUndo()&&!n?this.undoBtn.removeAttribute("disabled"):this.undoBtn.setAttribute("disabled","true")}renderDeck(e){this.deckDisplayEl&&(this.deckDisplayEl.innerHTML="",e.forEach(n=>{const t=document.createElement("div");n.isMonument?t.className="building-card MONUMENT":t.className=`building-card ${n.name.toUpperCase()}`;const s=document.createElement("header");s.className="card-header";const r=document.createElement("span");r.textContent=n.name;const a=document.createElement("div"),i=n.name.replace(/ /g,"-").replace(/'/g,"").toUpperCase();a.className=`card-icon ${i}`,s.appendChild(r),s.appendChild(a),t.appendChild(s);const l=document.createElement("div");l.className="card-body";const d=document.createElement("div");d.className="mini-pattern";const u=n.pattern[0].length;d.style.gridTemplateColumns=`repeat(${u}, 15px)`,n.pattern.forEach(f=>{f.forEach(N=>{const y=document.createElement("div"),O=N==="NONE"?"pattern-empty":N;y.className=`pattern-cell ${O}`,d.appendChild(y)})});const h=document.createElement("div");h.className="card-text",h.textContent=n.description||"Unique scoring rules.",l.appendChild(d),l.appendChild(h),t.appendChild(l),this.deckDisplayEl.appendChild(t)}))}}const S=new Ze,M=new xe;let b=null,I=[];const E={startModal:document.getElementById("start-screen-modal"),startBtn:document.getElementById("start-game-btn"),restartBtn:document.getElementById("restart-btn"),undoBtn:document.getElementById("undo-btn"),monumentGrid:document.getElementById("monument-pattern-grid"),monumentDesc:document.getElementById("monument-desc"),gameOverModal:document.getElementById("game-over-modal"),finalScore:document.getElementById("final-score"),scoreList:document.getElementById("score-breakdown-list")},q=[{id:"RED",label:"Farm (Red)",options:H},{id:"GRAY",label:"Well (Gray)",options:K},{id:"YELLOW",label:"Theater (Yellow)",options:k},{id:"GREEN",label:"Tavern (Green)",options:$},{id:"ORANGE",label:"Chapel (Orange)",options:_},{id:"BLACK",label:"Factory (Black)",options:F},{id:"PURPLE",label:"Monument",options:D.filter(c=>c.isMonument)}];M.onResourceSelect=c=>{b||(S.currentResource=c,G())};M.onBuildClick=c=>{b=c,I=nt(c),G()};M.onCellClick=(c,e)=>{try{b?et(c,e):tt(c,e)}catch(n){alert(n.message)}};M.onCancelClick=()=>{j(),G()};E.undoBtn.onclick=()=>{S.undo(),G()};E.startBtn.onclick=()=>{const c=[];c.push(U),document.querySelectorAll(".setup-select").forEach(n=>{const t=n.dataset.category,s=q.find(a=>a.id===t);if(!s)return;let r;n.value==="RANDOM"?r=ot(s.options):r=s.options.find(a=>a.name===n.value),r&&(c.push(r),s.id==="PURPLE"&&(S.activeMonument=r))}),S.gameRegistry=c,S.start(),E.startModal.classList.add("hidden"),G(),M.renderDeck(S.gameRegistry)};E.restartBtn.onclick=()=>{E.gameOverModal.classList.add("hidden"),Y()};function Y(){const c=document.getElementById("setup-container");if(!c)return;c.innerHTML="";const e=document.createElement("div");e.className="setup-grid",q.forEach(n=>{const t=document.createElement("div");t.className="setup-group";const s=document.createElement("label");s.className="setup-label",s.textContent=n.label,t.appendChild(s);const r=document.createElement("select");r.className=`setup-select ${n.id}`,r.dataset.category=n.id;const a=document.createElement("option");a.value="RANDOM",a.textContent=`Random ${n.label.split(" ")[0]}`,r.appendChild(a),n.options.forEach(i=>{const l=document.createElement("option");l.value=i.name,l.textContent=i.name,r.appendChild(l)}),n.id==="PURPLE"&&(r.onchange=()=>{const i=r.value;if(i==="RANDOM")E.monumentDesc.textContent="A random monument will be chosen.",E.monumentGrid.innerHTML="";else{const l=n.options.find(d=>d.name===i);l&&st(l)}}),t.appendChild(r),e.appendChild(t)}),c.appendChild(e),E.monumentDesc.textContent="Customize your town or leave as Random.",E.monumentGrid.innerHTML="",E.startModal.classList.remove("hidden")}function et(c,e){const t=S.board.getGrid()[c][e],s=I.some(d=>d.row===c&&d.col===e),r=b?b.buildingName.toUpperCase():"",l=(S.hasObeliskAbility()||r==="SHED")&&t==="NONE";if(s||l){if(t&&t.toUpperCase().replace("_"," ")==="TRADING POST"){alert("You cannot build directly on top of a Trading Post. Please select one of the consumable resource squares or an empty square.");return}S.constructBuilding(b,c,e),j(),G(),z()}}function tt(c,e){if(!S.currentResource){alert("Select a resource first!");return}S.placeResource(c,e),G(),z()}function j(){b=null,I=[]}function nt(c){const e=[];return c.pattern.forEach((n,t)=>{n.forEach((s,r)=>{s!=="NONE"&&e.push({row:c.row+t,col:c.col+r})})}),e}function ot(c){if(!c||c.length===0)throw new Error("Empty building list!");return c[Math.floor(Math.random()*c.length)]}function G(){M.render(S,b,I)}function st(c){const e={Archive:"1pt for every unique building type.","Barrett Castle":"Feeds 2 cottages. Worth 5pts.",Mandras:"2pts per unique adjacent neighbor.","Obelisk of the Crescent":"ABILITY: Can place buildings anywhere.","Shrine of the Elder Tree":"Score depends on when you build it (1-8pts).",Baths:"2pts for every building type NOT in your town.",Forum:"1pt + size of largest group of identical buildings.",Mausoleum:"Unfed cottages score 3pts.",Cathedral:"2pts. Empty spaces are worth 0."};E.monumentDesc.textContent=c.description||e[c.name]||"A unique monument.",rt(c)}function rt(c){E.monumentGrid.innerHTML="";const e=c.pattern;E.monumentGrid.style.gridTemplateColumns=`repeat(${e[0].length}, 30px)`,e.forEach(n=>{n.forEach(t=>{const s=document.createElement("div");s.className=`mini-cell ${t}`,E.monumentGrid.appendChild(s)})})}function z(){if(S.checkGameOver()&&!b){const c=S.getScore();E.finalScore.textContent=c.total.toString(),E.scoreList.innerHTML="";for(const[e,n]of Object.entries(c.breakdown))n!==0&&v(e,n);c.penaltyCount>0&&v("Empty Spaces",-c.penaltyCount,!0),E.gameOverModal.classList.remove("hidden")}}function v(c,e,n=!1){const t=document.createElement("li");t.className="score-item",n&&t.classList.add("penalty-text"),t.style.display="flex",t.style.justifyContent="space-between",t.style.marginBottom="5px",n&&(t.style.color="#ef5350",t.style.marginTop="10px",t.style.borderTop="1px solid #eee",t.style.paddingTop="5px"),t.innerHTML=`
        <span style="text-transform: capitalize;">${c.toLowerCase()}</span>
        <strong>${e}</strong>
    `,E.scoreList.appendChild(t)}Y();
