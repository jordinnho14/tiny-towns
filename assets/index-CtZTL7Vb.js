(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))t(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const c of o.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&t(c)}).observe(document,{childList:!0,subtree:!0});function n(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerPolicy&&(o.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?o.credentials="include":r.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function t(r){if(r.ep)return;r.ep=!0;const o=n(r);fetch(r.href,o)}})();const s={WOOD:"WOOD",WHEAT:"WHEAT",BRICK:"BRICK",GLASS:"GLASS",STONE:"STONE",NONE:"NONE"},b={COTTAGE:"COTTAGE",TAVERN:"TAVERN",CHAPEL:"CHAPEL",BARRETT_CASTLE:"BARRETT_CASTLE"};class w{points;requiresFood;constructor(e,n=!1){this.points=e,this.requiresFood=n}score(e){return this.requiresFood&&!e.fedState?0:this.points}}class k{targetTypes;pointsPerNeighbor;constructor(e,n){this.targetTypes=e,this.pointsPerNeighbor=n}score(e){let n=0;const t=[[-1,0],[1,0],[0,-1],[0,1]];for(const[r,o]of t){const c=e.row+r,d=e.col+o;if(c>=0&&c<4&&d>=0&&d<4){const i=e.grid[c][d];this.targetTypes.includes(i)&&(n+=this.pointsPerNeighbor)}}return n}}class ${score(e){const n=new Set;for(let t=0;t<4;t++)t!==e.col&&this.addIfBuilding(n,e.grid[e.row][t]);for(let t=0;t<4;t++)t!==e.row&&this.addIfBuilding(n,e.grid[t][e.col]);return n.size}addIfBuilding(e,n){["NONE","WOOD","WHEAT","BRICK","GLASS","STONE"].includes(n)||e.add(n)}}class K{score(e){let n=0;return Object.values(e.counts).forEach(t=>{t===1&&(n+=1)}),n}}class P{multiplier;constructor(e){this.multiplier=e}score(e){const n=new Set,t=[[-1,0],[1,0],[0,-1],[0,1]],r=["NONE","WOOD","WHEAT","BRICK","GLASS","STONE"];for(const[o,c]of t){const d=e.row+o,i=e.col+c;if(d>=0&&d<4&&i>=0&&i<4){const l=e.grid[d][i];r.includes(l)||n.add(l)}}return n.size*this.multiplier}}class U{score(e){const n=`${e.row},${e.col}`,t=e.metadata.get(n);return t&&t.savedScore||0}}class F{score(e){let n=0;for(const t of e.validBuildingNames){const r=t.toUpperCase();e.counts[r]||n++}return n*2}}class q{score(e){let n=0;const t=new Set,r=["NONE","WOOD","WHEAT","BRICK","GLASS","STONE"],o=[[-1,0],[1,0],[0,-1],[0,1]];for(let c=0;c<4;c++)for(let d=0;d<4;d++){const i=`${c},${d}`,l=e.grid[c][d];if(t.has(i)||r.includes(l))continue;let E=0;const h=[{r:c,c:d}];for(t.add(i);h.length>0;){const g=h.pop();E++;for(const[S,T]of o){const O=g.r+S,C=g.c+T,u=`${O},${C}`;O>=0&&O<4&&C>=0&&C<4&&!t.has(u)&&e.grid[O][C]===l&&(t.add(u),h.push({r:O,c:C}))}}E>n&&(n=E)}return 1+n}}class x{score(e){let n=0;for(let t=0;t<4;t++)for(let r=0;r<4;r++){const o=e.grid[t][r],c=`${t},${r}`;o==="COTTAGE"&&(e.allFedPositions.has(c)||n++)}return n*3}}const z={name:"Cottage",pattern:[[s.NONE,s.WHEAT],[s.BRICK,s.GLASS]],scorer:new w(3,!0),feedCost:1},V={name:"Well",pattern:[[s.WOOD,s.STONE]],scorer:new k([b.COTTAGE,b.BARRETT_CASTLE],1)},_={name:"Farm",pattern:[[s.WHEAT,s.WHEAT],[s.WOOD,s.WOOD]],feeds:4},j={name:"Tavern",pattern:[[s.BRICK,s.BRICK,s.GLASS]]},J={name:"Theater",pattern:[[s.NONE,s.STONE,s.NONE],[s.WOOD,s.GLASS,s.WOOD]],scorer:new $},Y={name:"Factory",pattern:[[s.WOOD,s.NONE,s.NONE,s.NONE],[s.BRICK,s.STONE,s.STONE,s.BRICK]]},Q={name:"Chapel",pattern:[[s.NONE,s.NONE,s.GLASS],[s.STONE,s.GLASS,s.STONE]]},X={name:"Archive",pattern:[[s.WHEAT,s.WHEAT],[s.BRICK,s.GLASS]],scorer:new K,isMonument:!0},Z={name:"Barrett Castle",pattern:[[s.WHEAT,s.NONE,s.NONE,s.STONE],[s.WOOD,s.GLASS,s.GLASS,s.BRICK]],scorer:new w(5,!0),feedCost:1,countsAs:[b.COTTAGE],isMonument:!0},ee={name:"Obelisk of the Crescent",pattern:[[s.WHEAT,s.NONE,s.NONE],[s.BRICK,s.GLASS,s.BRICK]],isMonument:!0},te={name:"Mandras",pattern:[[s.WHEAT,s.GLASS],[s.BRICK,s.WOOD]],scorer:new P(2),isMonument:!0},ne={name:"Shrine of the Elder Tree",pattern:[[s.BRICK,s.WHEAT,s.STONE],[s.WOOD,s.GLASS,s.WOOD]],isMonument:!0,scorer:new U},se={name:"Baths",pattern:[[s.NONE,s.WHEAT,s.NONE],[s.STONE,s.GLASS,s.WOOD],[s.BRICK,s.NONE,s.BRICK]],isMonument:!0,scorer:new F},re={name:"Forum",pattern:[[s.NONE,s.NONE,s.WHEAT,s.NONE],[s.BRICK,s.BRICK,s.STONE,s.WOOD]],isMonument:!0,scorer:new q},oe={name:"Mausoleum",pattern:[[s.WOOD,s.WOOD],[s.BRICK,s.STONE]],isMonument:!0,scorer:new x},ie={name:"Cathedral",pattern:[[s.NONE,s.WHEAT],[s.STONE,s.GLASS]],isMonument:!0,scorer:new w(2,!1)},A=[z,V,_,j,J,Y,Q,X,Z,ee,te,ne,se,re,oe,ie];class I{grid;size=4;metadata=new Map;constructor(){this.grid=Array(this.size).fill(null).map(()=>Array(this.size).fill(s.NONE))}place(e,n,t){if(!this.isValid(e,n))throw new Error(`Invalid coordinate: ${e}, ${n}`);if(this.grid[e][n]!==s.NONE)throw new Error("Spot already occupied");this.grid[e][n]=t}constructBuilding(e,n,t,r){if(!e.some(c=>c.row===n&&c.col===t)&&this.grid[n][t]!=="NONE")throw new Error("Building must be placed on one of the pattern squares.");this.clear(e),this.grid[n][t]=r}clear(e){e.forEach(({row:n,col:t})=>{this.isValid(n,t)&&(this.grid[n][t]=s.NONE,this.metadata.delete(`${n},${t}`))})}getGrid(){return this.grid.map(e=>[...e])}isValid(e,n){return e>=0&&e<this.size&&n>=0&&n<this.size}remove(e,n){this.isValid(e,n)&&(this.grid[e][n]="NONE",this.metadata.delete(`${e},${n}`))}setMetadata(e,n,t){this.metadata.set(`${e},${n}`,t)}getMetadata(e,n){return this.metadata.get(`${e},${n}`)}}class ae{static rotate(e){return e[0].map((n,t)=>e.map(r=>r[t]).reverse())}static flip(e){return e.map(n=>[...n].reverse())}static getSymmetries(e){const n=new Set;let t=e;for(let r=0;r<4;r++)n.add(JSON.stringify(t)),n.add(JSON.stringify(this.flip(t))),t=this.rotate(t);return Array.from(n).map(r=>JSON.parse(r))}static findMatches(e,n){const t=this.getSymmetries(n.pattern),r=[];for(const o of t){const c=o.length,d=o[0].length;for(let i=0;i<=4-c;i++)for(let l=0;l<=4-d;l++)this.isMatch(e,o,i,l)&&r.push({row:i,col:l,pattern:o})}return r}static isMatch(e,n,t,r){return n.every((o,c)=>o.every((d,i)=>d==="NONE"?!0:e[t+c][r+i]===d))}}class ce{static calculateScore(e,n,t){const c={},d=t.map(u=>u.name),i={};let l=0,E=[],h=0;for(let u=0;u<4;u++)for(let p=0;p<4;p++){const N=e[u][p];if(!this.isBuilding(N)){h++;continue}i[N]=(i[N]||0)+1;const y=A.find(B=>B.name.toUpperCase()===N);if(y&&(y.feeds&&(l+=y.feeds),y.feedCost)){const B=y.name==="Barrett"?10:1;E.push({r:u,c:p,cost:y.feedCost,id:`${u},${p}`,priority:B})}}const g=(i.CATHEDRAL||0)>0;E.sort((u,p)=>p.priority-u.priority);const S=new Set;let T=0;for(const u of E)if(l>=u.cost){l-=u.cost,S.add(u.id);const p=e[u.r][u.c];p===b.COTTAGE?T+=1:p===b.BARRETT_CASTLE&&(T+=2)}for(let u=0;u<4;u++)for(let p=0;p<4;p++){const N=e[u][p];if(!this.isBuilding(N))continue;const y=A.find(B=>B.name.toUpperCase()===N);if(y)if(y.scorer){const B={grid:e,row:u,col:p,counts:i,fedState:S.has(`${u},${p}`),metadata:n,validBuildingNames:d,allFedPositions:S},D=y.scorer.score(B);c[N]=(c[N]||0)+D}else N===b.CHAPEL&&(c[N]=(c[N]||0)+T)}if(i[b.TAVERN]){const u=[0,2,5,9,14,20],p=Math.min(i[b.TAVERN],5);c[b.TAVERN]=u[p]}let O=0;Object.values(c).forEach(u=>O+=u);const C=g?0:h;return{total:O-C,breakdown:c,penaltyCount:C}}static isBuilding(e){return!["NONE","WOOD","WHEAT","BRICK","GLASS","STONE"].includes(e)}}class le{board;currentResource=null;availableMatches=[];activeMonument=null;gameRegistry=[];lastMove=null;constructor(){this.board=new I}start(){if(this.board=new I,this.currentResource=null,this.lastMove=null,this.availableMatches=[],this.gameRegistry.length===0){const e=A.filter(t=>t.isMonument),n=A.filter(t=>!t.isMonument);this.activeMonument=e[Math.floor(Math.random()*e.length)],this.gameRegistry=[...n,this.activeMonument]}}placeResource(e,n){if(!this.currentResource)throw new Error("No resource selected");this.board.place(e,n,this.currentResource),this.lastMove={r:e,c:n},this.currentResource=null,this.scanForMatches()}constructBuilding(e,n,t){const r=[];let o=0,c=!1;if(e.pattern.forEach((d,i)=>{d.forEach((l,E)=>{l&&l!=="NONE"&&r.push({row:e.row+i,col:e.col+E})})}),e.buildingName.toUpperCase()==="SHRINE OF THE ELDER TREE"){c=!0;const i=this.countBuildingsOnBoard()+1;i<6?o=i:o=8}this.board.constructBuilding(r,n,t,e.buildingName),c&&this.board.setMetadata(n,t,{savedScore:o}),this.lastMove=null,this.scanForMatches()}undo(){this.lastMove&&(this.board.remove(this.lastMove.r,this.lastMove.c),this.lastMove=null,this.scanForMatches())}canUndo(){return this.lastMove!==null}scanForMatches(){this.availableMatches=[];const e=this.board.getGrid(),n=e.some(t=>t.some(r=>this.gameRegistry.find(c=>c.name.toUpperCase()===r.toUpperCase())?.isMonument));for(const t of this.gameRegistry){if(n&&t.isMonument)continue;ae.findMatches(e,t).forEach(o=>{this.availableMatches.push({...o,buildingName:t.name.toUpperCase()})})}}checkGameOver(){const n=this.board.getGrid().some(r=>r.some(o=>o==="NONE")),t=this.availableMatches.length>0;return!n&&!t}getScore(){return ce.calculateScore(this.board.getGrid(),this.board.metadata,this.gameRegistry)}countBuildingsOnBoard(){const e=this.board.getGrid();let n=0;const t=["WOOD","WHEAT","BRICK","GLASS","STONE","NONE"];return e.forEach(r=>{r.forEach(o=>{t.includes(o)||n++})}),n}hasObeliskAbility(){return this.board.getGrid().some(n=>n.some(t=>t.toUpperCase().includes("OBELISK")))}}class de{boardEl=document.getElementById("board");buildMenuEl=document.getElementById("build-menu");msgLabel=document.getElementById("message");paletteEl=document.getElementById("resource-palette");scoreEl=document.getElementById("score-display");undoBtn=document.getElementById("undo-btn");deckDisplayEl=document.getElementById("deck-display");onCellClick=()=>{};onResourceSelect=()=>{};onBuildClick=()=>{};onCancelClick=()=>{};constructor(){}render(e,n,t){this.renderHeader(e),this.renderBoard(e,n,t),this.renderSidebar(e,n),this.renderControls(e,n)}renderHeader(e){const n=e.getScore(),t=n.total+n.penaltyCount;this.scoreEl.innerHTML=`Score: ${t} <span style="font-size:12px; color:#999">(-${n.penaltyCount} empty)</span>`}renderBoard(e,n,t){const r=e.hasObeliskAbility(),o=e.board.getGrid(),c=["WOOD","WHEAT","BRICK","GLASS","STONE"];this.boardEl.children.length===0&&o.forEach((i,l)=>{i.forEach((E,h)=>{const g=document.createElement("div");g.dataset.r=l.toString(),g.dataset.c=h.toString(),g.onclick=()=>this.onCellClick(l,h),this.boardEl.appendChild(g)})}),Array.from(this.boardEl.children).forEach(i=>{const l=parseInt(i.dataset.r),E=parseInt(i.dataset.c),h=o[l][E],g=h.replace(/ /g,"-").replace(/'/g,"").toUpperCase();let S=`cell ${h==="NONE"?"empty":g}`;n&&(t.some(C=>C.row===l&&C.col===E)||r&&h==="NONE")&&(S+=" match-highlight"),i.className!==S&&(i.className=S,h==="NONE"?(i.textContent="",i.style.color=""):c.includes(h)?(i.textContent=h,i.style.color=""):(i.textContent="",i.style.color="")),h==="NONE"&&e.currentResource&&!n?(i.onmouseenter=()=>{i.classList.add("ghost",e.currentResource),i.textContent=""},i.onmouseleave=()=>{i.classList.remove("ghost","WOOD","WHEAT","BRICK","GLASS","STONE"),i.textContent=""}):(i.onmouseenter=null,i.onmouseleave=null)}),n?(this.msgLabel.textContent=`Select a highlighted square to build your ${n.buildingName}!`,this.msgLabel.style.color="#d32f2f"):e.availableMatches.length>0?(this.msgLabel.textContent="Matches available!",this.msgLabel.style.color="#333"):e.currentResource?(this.msgLabel.textContent=`Place ${e.currentResource}...`,this.msgLabel.style.color="#333"):(this.msgLabel.textContent="Select a Resource...",this.msgLabel.style.color="#1976d2")}renderSidebar(e,n){if(this.buildMenuEl.innerHTML="",e.availableMatches.length===0){const t=document.createElement("p");t.textContent="No patterns found.",t.style.color="#777",t.style.fontStyle="italic",this.buildMenuEl.appendChild(t)}else e.availableMatches.forEach(t=>{const r=document.createElement("button");r.textContent=`Build ${t.buildingName}`;const o=t.buildingName.replace(/ /g,"-").replace(/'/g,"").toUpperCase();r.className=`build-btn ${o}`,r.onclick=()=>this.onBuildClick(t);const c=[];t.pattern&&Array.isArray(t.pattern)?t.pattern.forEach((d,i)=>{d.forEach((l,E)=>{l&&l!=="NONE"&&c.push({row:t.row+i,col:t.col+E})})}):c.push({row:t.row,col:t.col}),r.onmouseenter=()=>this.togglePreview(c,!0),r.onmouseleave=()=>this.togglePreview(c,!1),this.buildMenuEl.appendChild(r)});if(n){const t=document.createElement("button");t.textContent="Cancel Construction",t.className="secondary-btn",t.style.marginTop="10px",t.style.width="100%",t.onclick=()=>this.onCancelClick(),this.buildMenuEl.appendChild(t)}}togglePreview(e,n){e.forEach(t=>{const r=`div[data-r="${t.row}"][data-c="${t.col}"]`,o=this.boardEl.querySelector(r);o&&(n?o.classList.add("preview-target"):o.classList.remove("preview-target"))})}renderControls(e,n){this.paletteEl.innerHTML="",[s.WOOD,s.WHEAT,s.BRICK,s.GLASS,s.STONE].forEach(r=>{const o=document.createElement("div");let c=`res-btn ${r}`;e.currentResource===r&&!n&&(c+=" selected"),o.className=c,o.textContent=r.charAt(0),o.onclick=()=>this.onResourceSelect(r),this.paletteEl.appendChild(o)}),e.canUndo()&&!n?this.undoBtn.removeAttribute("disabled"):this.undoBtn.setAttribute("disabled","true")}renderDeck(e){this.deckDisplayEl&&(this.deckDisplayEl.innerHTML="",e.forEach(n=>{const t=document.createElement("div");t.className="building-card";const r=document.createElement("header");r.className="card-header";const o=document.createElement("span");o.textContent=n.name;const c=document.createElement("div"),d=n.name.replace(/ /g,"-").replace(/'/g,"").toUpperCase();c.className=`card-icon ${d}`,r.appendChild(o),r.appendChild(c),t.appendChild(r);const i=document.createElement("div");i.className="card-body";const l=document.createElement("div");l.className="mini-pattern";const E=n.pattern[0].length;l.style.gridTemplateColumns=`repeat(${E}, 15px)`,n.pattern.forEach(g=>{g.forEach(S=>{const T=document.createElement("div"),O=S==="NONE"?"pattern-empty":S;T.className=`pattern-cell ${O}`,l.appendChild(T)})});const h=document.createElement("div");h.className="card-text",h.textContent=this.getDescription(n.name),i.appendChild(l),i.appendChild(h),t.appendChild(i),this.deckDisplayEl.appendChild(t)}))}getDescription(e){return{Cottage:"3 pts if fed.",Farm:"Feeds 4 Cottages.",Well:"1 pt per adjacent Cottage.",Theater:"1 pt per unique building in row/col.",Chapel:"1 pt per fed Cottage.",Tavern:"Score: 2, 5, 9, 14, 20 pts.","Archive of the Second Age":"1pt per unique building type.","Barrett Castle":"Feeds 2. Worth 5 pts.",Mandras:"2pts per unique neighbor.","Shrine of the Elder Tree":"Score rises as town fills (1-8pts).",Cathedral:"2pts. No empty penalty.",Baths:"2pts per missing building type.",Forum:"Score based on largest group.","Grand Mausoleum":"Unfed Cottages score 3pts.","Obelisk of the Crescent":"Place buildings anywhere."}[e]||"Unique scoring rules."}}const f=new le,L=new de;let R=null,v=[];const m={startModal:document.getElementById("start-screen-modal"),startBtn:document.getElementById("start-game-btn"),restartBtn:document.getElementById("restart-btn"),undoBtn:document.getElementById("undo-btn"),monumentGrid:document.getElementById("monument-pattern-grid"),monumentSelect:document.getElementById("monument-selector"),monumentDesc:document.getElementById("monument-desc"),gameOverModal:document.getElementById("game-over-modal"),finalScore:document.getElementById("final-score"),scoreList:document.getElementById("score-breakdown-list")};L.onResourceSelect=a=>{R||(f.currentResource=a,M())};L.onBuildClick=a=>{R=a,v=he(a),M()};L.onCellClick=(a,e)=>{try{R?ue(a,e):me(a,e)}catch(n){alert(n.message)}};L.onCancelClick=()=>{W(),M()};m.undoBtn.onclick=()=>{f.undo(),M()};m.startBtn.onclick=()=>{const a=A.filter(e=>!e.isMonument);f.gameRegistry=[...a,f.activeMonument],f.start(),m.startModal.classList.add("hidden"),M(),L.renderDeck(f.gameRegistry)};m.restartBtn.onclick=()=>{m.gameOverModal.classList.add("hidden"),pe()};function ue(a,e){const n=v.some(r=>r.row===a&&r.col===e),t=f.hasObeliskAbility()&&f.board.getGrid()[a][e]==="NONE";(n||t)&&(f.constructBuilding(R,a,e),W(),M(),H())}function me(a,e){if(!f.currentResource){alert("Select a resource first!");return}f.placeResource(a,e),M(),H()}function W(){R=null,v=[]}function he(a){const e=[];return a.pattern.forEach((n,t)=>{n.forEach((r,o)=>{r!=="NONE"&&e.push({row:a.row+t,col:a.col+o})})}),e}function M(){L.render(f,R,v)}function pe(){const a=A.filter(n=>n.isMonument);m.monumentSelect.innerHTML="",a.forEach((n,t)=>{const r=document.createElement("option");r.value=t.toString(),r.textContent=n.name,m.monumentSelect.appendChild(r)}),m.monumentSelect.onchange=()=>{const n=a[parseInt(m.monumentSelect.value)];f.activeMonument=n,fe(n)};const e=Math.floor(Math.random()*a.length);m.monumentSelect.value=e.toString(),m.monumentSelect.onchange(null),m.startModal.classList.remove("hidden")}function fe(a){m.monumentSelect.className=`monument-select ${a.name.toUpperCase()}`;const e={Archive:"1pt for every unique building type.","Barrett Castle":"Feeds 2 cottages. Worth 5pts.",Mandras:"2pts per unique adjacent neighbor.",Caterina:"Empty spaces are worth +1 instead of -1.","Obelisk of the Crescent":"ABILITY: Can place buildings anywhere.","Shrine of the Elder Tree":"Score depends on when you build it (1-8pts).",Baths:"2pts for every building type NOT in your town.",Forum:"1pt + size of largest group of identical buildings.","Grand Mausoleum":"Unfed cottages score 3pts.",Cathedral:"2pts. Empty spaces are worth 0."};m.monumentDesc.textContent=e[a.name]||"A unique monument.",Ee(a)}function Ee(a){m.monumentGrid.innerHTML="";const e=a.pattern;m.monumentGrid.style.gridTemplateColumns=`repeat(${e[0].length}, 30px)`,e.forEach(n=>{n.forEach(t=>{const r=document.createElement("div");r.className=`mini-cell ${t}`,m.monumentGrid.appendChild(r)})})}function H(){if(f.checkGameOver()&&!R){const a=f.getScore();m.finalScore.textContent=a.total.toString(),m.scoreList.innerHTML="";for(const[e,n]of Object.entries(a.breakdown))n!==0&&G(e,n);a.penaltyCount>0&&G("Empty Spaces",-a.penaltyCount,!0),m.gameOverModal.classList.remove("hidden")}}function G(a,e,n=!1){const t=document.createElement("li");t.className="score-item",n&&t.classList.add("penalty-text"),t.style.display="flex",t.style.justifyContent="space-between",t.style.marginBottom="5px",n&&(t.style.color="#ef5350",t.style.marginTop="10px",t.style.borderTop="1px solid #eee",t.style.paddingTop="5px"),t.innerHTML=`
        <span style="text-transform: capitalize;">${a.toLowerCase()}</span>
        <strong>${e}</strong>
    `,m.scoreList.appendChild(t)}{console.log("Prod Mode: Random Start...");const a=A.filter(t=>t.isMonument),e=A.filter(t=>!t.isMonument),n=a[Math.floor(Math.random()*a.length)];f.activeMonument=n,f.gameRegistry=[...e,n],f.start(),M(),m.startModal.classList.add("hidden")}
