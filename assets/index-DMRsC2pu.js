(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=t(i);fetch(i.href,r)}})();const f={WOOD:"WOOD",WHEAT:"WHEAT",BRICK:"BRICK",GLASS:"GLASS",STONE:"STONE",NONE:"NONE"},se={COTTAGE:"COTTAGE",TAVERN:"TAVERN",BARRETT_CASTLE:"BARRETT_CASTLE"};class Ce{points;requiresFood;constructor(e,t=!1){this.points=e,this.requiresFood=t}score(e){return this.requiresFood&&!e.fedState?0:this.points}}class Ao{targetTypes;pointsPerNeighbor;constructor(e,t){this.targetTypes=e,this.pointsPerNeighbor=t}score(e){let t=0;const s=[[-1,0],[1,0],[0,-1],[0,1]];for(const[i,r]of s){const o=e.row+i,a=e.col+r;if(o>=0&&o<4&&a>=0&&a<4){const l=e.grid[o][a];this.targetTypes.includes(l)&&(t+=this.pointsPerNeighbor)}}return t}}class ko{score(e){const t=new Set;for(let s=0;s<4;s++)s!==e.col&&this.addIfBuilding(t,e.grid[e.row][s]);for(let s=0;s<4;s++)s!==e.row&&this.addIfBuilding(t,e.grid[s][e.col]);return t.size}addIfBuilding(e,t){["NONE","WOOD","WHEAT","BRICK","GLASS","STONE"].includes(t)||e.add(t)}}class Do{score(e){let t=0;return Object.values(e.counts).forEach(s=>{s===1&&(t+=1)}),t}}class Lo{multiplier;constructor(e){this.multiplier=e}score(e){const t=new Set,s=[[-1,0],[1,0],[0,-1],[0,1]],i=["NONE","WOOD","WHEAT","BRICK","GLASS","STONE"];for(const[r,o]of s){const a=e.row+r,l=e.col+o;if(a>=0&&a<4&&l>=0&&l<4){const c=e.grid[a][l];i.includes(c)||t.add(c)}}return t.size*this.multiplier}}class Mo{score(e){const t=`${e.row},${e.col}`,s=e.metadata.get(t);return s&&s.savedScore||0}}class xo{score(e){let t=0;for(const s of e.validBuildingNames){const i=s.toUpperCase();e.counts[i]||t++}return t*2}}class Po{score(e){let t=0;const s=new Set,i=["NONE","WOOD","WHEAT","BRICK","GLASS","STONE"],r=[[-1,0],[1,0],[0,-1],[0,1]];for(let o=0;o<4;o++)for(let a=0;a<4;a++){const l=`${o},${a}`,c=e.grid[o][a];if(s.has(l)||i.includes(c))continue;let u=0;const h=[{r:o,c:a}];for(s.add(l);h.length>0;){const d=h.pop();u++;for(const[p,m]of r){const _=d.r+p,E=d.c+m,k=`${_},${E}`;_>=0&&_<4&&E>=0&&E<4&&!s.has(k)&&e.grid[_][E]===c&&(s.add(k),h.push({r:_,c:E}))}}u>t&&(t=u)}return 1+t}}class Bo{score(e){let t=0;for(let s=0;s<4;s++)for(let i=0;i<4;i++){const r=e.grid[s][i],o=`${s},${i}`;r==="COTTAGE"&&(e.allFedPositions.has(o)||t++)}return t*3}}class Fo{targetTypes;scoreAmount;constructor(e,t){this.targetTypes=e,this.scoreAmount=t}score(e){const t=[[-1,0],[1,0],[0,-1],[0,1]];for(const[s,i]of t){const r=e.row+s,o=e.col+i;if(r>=0&&r<4&&o>=0&&o<4){const a=e.grid[r][o];if(this.targetTypes.includes(a))return this.scoreAmount}}return 0}}class Vi{targetCategories;scoreAmount;constructor(e,t){this.targetCategories=e,this.scoreAmount=t}score(e){const t=[[-1,0],[1,0],[0,-1],[0,1]];for(const[s,i]of t){const r=e.row+s,o=e.col+i;if(r>=0&&r<4&&o>=0&&o<4){const a=e.grid[r][o],l=e.registry.find(c=>c.name.toUpperCase()===a.toUpperCase());if(l&&this.targetCategories.includes(l.type))return this.scoreAmount}}return 0}}class Wo{score(e){let t=0;const s=e.grid[e.row][e.col];for(let i=0;i<4;i++)i!==e.col&&e.grid[e.row][i]===s&&t++;for(let i=0;i<4;i++)i!==e.row&&e.grid[i][e.col]===s&&t++;return t}}class Go{score(e){let t=1;const s=["1,1","1,2","2,1","2,2"],i=`${e.row},${e.col}`,r=e.grid[e.row][e.col];return s.forEach(o=>{if(o===i)return;const[a,l]=o.split(",").map(Number);e.grid[a][l]===r&&t++}),t}}class Uo{score(e){const t=e.grid[e.row][e.col],s=e.counts[t]||e.counts[t.toUpperCase()]||0;return s===0?0:s%2!==0?-1:({2:5,4:15,6:26,8:40}[s]??s*5)/s}}class Ho{score(e){const t=e.grid[e.row][e.col];for(let s=0;s<4;s++)if(s!==e.col&&e.grid[e.row][s]===t)return 0;for(let s=0;s<4;s++)if(s!==e.row&&e.grid[s][e.col]===t)return 0;return 3}}class $o{score(e){return e.fedCottageCount}}class Vo{requiredNeighbors;scoreAmount;constructor(e,t){this.requiredNeighbors=e,this.scoreAmount=t}score(e){let t=0;const s=[[-1,0],[1,0],[0,-1],[0,1]];for(const[i,r]of s){const o=e.row+i,a=e.col+r;o>=0&&o<4&&a>=0&&a<4&&e.allFedPositions.has(`${o},${a}`)&&t++}return t>=this.requiredNeighbors?this.scoreAmount:0}}class Ko{targetName;constructor(e){this.targetName=e}score(e){const t=[{r:0,c:0},{r:0,c:3},{r:3,c:0},{r:3,c:3}];let s=0;return t.forEach(i=>{e.grid[i.r][i.c]===this.targetName&&s++}),s}}class Yo{restrictedCategories;scoreAmount;constructor(e,t){this.restrictedCategories=e,this.scoreAmount=t}score(e){const t=[[-1,0],[1,0],[0,-1],[0,1]];for(const[s,i]of t){const r=e.row+s,o=e.col+i;if(r>=0&&r<4&&o>=0&&o<4){const a=e.grid[r][o],l=e.registry.find(c=>c.name.toUpperCase()===a.toUpperCase());if(l&&this.restrictedCategories.includes(l.type))return 0}}return this.scoreAmount}}class zo{score(e){if(!e.finishRank)return 0;const t=e.finishRank;return t===1?6:t===2?3:t===3?2:0}}class jo{score(e){const t=e.counts["FEAST HALL"]||0,s=e.rightNeighborFeastHallCount||0;return t>s?3:2}}const ds={name:"Cottage",type:"BLUE",pattern:[[f.NONE,f.WHEAT],[f.BRICK,f.GLASS]],scorer:new Ce(3,!0),feedCost:1,description:"3 points if fed."},qo=[ds];class Qo{amount;constructor(e){this.amount=e}getFedPositions(e,t,s){return Array(this.amount).fill({r:-1,c:-1})}}class Xo{getFedPositions(e,t,s){const i=[];return[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]].forEach(([o,a])=>{const l=e+o,c=t+a;l>=0&&l<4&&c>=0&&c<4&&i.push({r:l,c})}),i}}class Jo{getFedPositions(e,t,s){const o=new Set,a=[],l=(c,u)=>{const h=s[c][u];return h===se.COTTAGE||h===se.BARRETT_CASTLE};for(let c=0;c<4;c++)for(let u=0;u<4;u++){const h=`${c},${u}`;if(o.has(h)||!l(c,u))continue;const d=[],p=[{r:c,c:u}];for(o.add(h);p.length>0;){const m=p.pop();d.push(m);const _=[[-1,0],[1,0],[0,-1],[0,1]];for(const[E,k]of _){const A=m.r+E,x=m.c+k,S=`${A},${x}`;A>=0&&A<4&&x>=0&&x<4&&!o.has(S)&&l(A,x)&&(o.add(S),p.push({r:A,c:x}))}}a.push(d)}return a.length===0?[]:(a.sort((c,u)=>u.length-c.length),a[0])}}class Zo{getFedPositions(e,t,s){const i=[];for(let r=0;r<4;r++)r!==t&&i.push({r:e,c:r});for(let r=0;r<4;r++)r!==e&&i.push({r,c:t});return i}}const ea={name:"Farm",type:"RED",pattern:[[f.WHEAT,f.WHEAT],[f.WOOD,f.WOOD]],feeder:new Qo(4),description:"Feeds 4 cottages anywhere on the board."},ta={name:"Granary",type:"RED",pattern:[[f.WHEAT,f.WHEAT],[f.WOOD,f.BRICK]],feeder:new Xo,description:"Feeds all buildings in the 8 squares surrounding it."},na={name:"Greenhouse",type:"RED",pattern:[[f.WHEAT,f.GLASS],[f.WOOD,f.WOOD]],feeder:new Jo,description:"Feeds one contiguous group of Cottages."},sa={name:"Orchard",type:"RED",description:"Feeds Cottages in the same row and column.",pattern:[[f.STONE,f.WHEAT],[f.WHEAT,f.WOOD]],feeder:new Zo},Ki=[ea,ta,na,sa],ia={name:"Well",type:"GRAY",pattern:[[f.WOOD,f.STONE]],description:"1 point for each adjacent cottage.",scorer:new Ao([se.COTTAGE,se.BARRETT_CASTLE],1)},ra={name:"Fountain",type:"GRAY",description:"2 points if adjacent to a Cottage.",pattern:[[f.WOOD,f.STONE]],scorer:new Fo([se.COTTAGE,se.BARRETT_CASTLE],2)},oa={name:"Millstone",type:"GRAY",description:"2 points if adjacent to a Red or Yellow building.",pattern:[[f.WOOD,f.STONE]],scorer:new Vi(["RED","YELLOW"],2)},aa={name:"Shed",type:"GRAY",description:"Worth 1 point. Can be placed anywhere.",pattern:[[f.WOOD,f.STONE]],scorer:new Ce(1)},Yi=[ia,ra,oa,aa],la={name:"Almshouse",type:"GREEN",pattern:[[f.STONE,f.STONE,f.GLASS]],description:"Score increasing points for each Almshouse you have built.",scorer:new Uo},ca={name:"Inn",type:"GREEN",pattern:[[f.WHEAT,f.STONE,f.GLASS]],description:"Get 3 points if not in a row or column with another Inn.",scorer:new Ho},da={name:"Feast Hall",type:"GREEN",pattern:[[f.WOOD,f.WOOD,f.GLASS]],description:"Get 2 points, and an extra 1 if you have more Feast Halls than the player on your right.",scorer:new jo},ua={name:"Tavern",type:"GREEN",pattern:[[f.BRICK,f.BRICK,f.GLASS]],description:"Score increasing points for each Tavern you have built."},zi=[ua,ca,la,da],ha={name:"Theater",type:"YELLOW",pattern:[[f.NONE,f.STONE,f.NONE],[f.WOOD,f.GLASS,f.WOOD]],scorer:new ko,description:"1 point for each unique building type in the same row and column."},fa={name:"Bakery",type:"YELLOW",description:"3 points if adjacent to a Food (Red) building.",pattern:[[f.NONE,f.WHEAT,f.NONE],[f.BRICK,f.GLASS,f.BRICK]],scorer:new Vi(["RED"],3)},pa={name:"Market",type:"YELLOW",description:"1 point for each other Market in the same row or column.",pattern:[[f.NONE,f.WOOD,f.NONE],[f.STONE,f.GLASS,f.STONE]],scorer:new Wo},ma={name:"Tailor",type:"YELLOW",description:"1 point. +1 point for each other Tailor in the 4 center squares.",pattern:[[f.NONE,f.WHEAT,f.NONE],[f.STONE,f.GLASS,f.STONE]],scorer:new Go},ji=[ha,fa,pa,ma];class ga{type="FACTORY";description="Stores a resource. Allows swapping that resource when chosen by others.";canSwap(e,t){return e===t}}class _a{type="BANK";description="Stores a resource. You cannot choose this resource as Master Builder."}class ya{type="WAREHOUSE";description="Stores up to 3 resources. You can Swap the current resource with one in storage. -1 point for each resource left at the end.";capacity=3}class Ea{type="STATUE_BONDMAKER";description="When another player names a resource, you may place it on a square with a Cottage."}class Ca{type="GROVE_UNIVERSITY";description="Immediately place a building on an empty square in your town."}class va{type="FORT_IRONWEED";description="Unless you are the last player in the game, you can no longer take turns as the Master Builder."}class Sa{type="ARCHITECTS_GUILD";description="Replace up to 2 buildings in your town with any other building types."}class ba{type="OPALEYE_WATCH";description="Place 3 unique buildings on this card. When neighbors build them, you get them."}const wa={name:"Factory",type:"BLACK",pattern:[[f.WOOD,f.NONE,f.NONE,f.NONE],[f.BRICK,f.STONE,f.STONE,f.BRICK]],description:"Place 1 resource on the factory, whenever another player chooses that resource, play a different one instead.",effect:new ga},Ia={name:"Trading Post",type:"BLACK",description:"1 point. Counts as a WILD (any) resource for future buildings.",pattern:[[f.STONE,f.WOOD,f.NONE],[f.STONE,f.WOOD,f.BRICK]],scorer:new Ce(1)},Ta={name:"Bank",type:"BLACK",description:"4 points. Place a resource on this building - you can no longer select this resource as master builder.",pattern:[[f.WHEAT,f.WHEAT,f.NONE],[f.WOOD,f.GLASS,f.BRICK]],scorer:new Ce(4),effect:new _a},Na={name:"Warehouse",type:"BLACK",description:"-1 for each resource on this building. When another player chooses a resource, you may place that resource on the warehouse, or swap it with a resource already stored here. It can store 3 resources.",pattern:[[f.WHEAT,f.WOOD,f.WHEAT],[f.BRICK,f.NONE,f.BRICK]],effect:new ya},qi=[wa,Ia,Ta,Na],Ra={name:"Chapel",type:"ORANGE",pattern:[[f.NONE,f.NONE,f.GLASS],[f.STONE,f.GLASS,f.STONE]],description:"Scores 1 point for each fed cottage.",scorer:new $o},Oa={name:"Abbey",type:"ORANGE",pattern:[[f.NONE,f.NONE,f.GLASS],[f.BRICK,f.STONE,f.STONE]],description:"3 points if not adjacent to a black, green or yellow building.",scorer:new Yo(["BLACK","GREEN","YELLOW"],3)},Aa={name:"Cloister",type:"ORANGE",pattern:[[f.NONE,f.NONE,f.GLASS],[f.WOOD,f.BRICK,f.STONE]],description:"Scores 1 point for each cloister in a corner of your town.",scorer:new Ko("CLOISTER")},ka={name:"Temple",type:"ORANGE",pattern:[[f.NONE,f.NONE,f.GLASS],[f.BRICK,f.BRICK,f.STONE]],description:"4 points if adjacent to 2 or more fed cottages.",scorer:new Vo(2,4)},Qi=[Ra,Oa,Aa,ka],Da={name:"Archive of the Second Age",type:"PURPLE",pattern:[[f.WHEAT,f.WHEAT],[f.BRICK,f.GLASS]],scorer:new Do,isMonument:!0,description:"Scores 1 point for each unique building type on the board."},La={name:"Barrett Castle",type:"PURPLE",pattern:[[f.WHEAT,f.NONE,f.NONE,f.STONE],[f.WOOD,f.GLASS,f.GLASS,f.BRICK]],scorer:new Ce(5,!0),feedCost:1,countsAs:[se.COTTAGE],isMonument:!0,description:"Scores 5 points if fed. Counts as 2 cottages."},Ma={name:"Obelisk of the Crescent",type:"PURPLE",pattern:[[f.WHEAT,f.NONE,f.NONE],[f.BRICK,f.GLASS,f.BRICK]],isMonument:!0,description:"You may place all future buildings on any empty square in your town."},xa={name:"Mandras Palace",type:"PURPLE",pattern:[[f.WHEAT,f.GLASS],[f.BRICK,f.WOOD]],scorer:new Lo(2),isMonument:!0,description:"Scores 2 points for each unique adjacent building type."},Pa={name:"Shrine of the Elder Tree",type:"PURPLE",pattern:[[f.BRICK,f.WHEAT,f.STONE],[f.WOOD,f.GLASS,f.WOOD]],isMonument:!0,scorer:new Mo,description:"Gain points based on the number of buildings in your town when constructed."},Ba={name:"The Sky Baths",type:"PURPLE",pattern:[[f.NONE,f.WHEAT,f.NONE],[f.STONE,f.GLASS,f.WOOD],[f.BRICK,f.NONE,f.BRICK]],isMonument:!0,scorer:new xo,description:"Scores 2 points for each building type your town is missing."},Fa={name:"Silva Forum",type:"PURPLE",pattern:[[f.NONE,f.NONE,f.WHEAT,f.NONE],[f.BRICK,f.BRICK,f.STONE,f.WOOD]],isMonument:!0,scorer:new Po,description:"Gain 1 point, plus 1 for each building in the largest contiguous group of buildings of the same type in your town."},Wa={name:"Grand Mausoleum of the Rodina",type:"PURPLE",pattern:[[f.WOOD,f.WOOD],[f.BRICK,f.STONE]],isMonument:!0,scorer:new Bo,description:"Your unfed cottages are worth 3 points each."},Ga={name:"Cathedral of Caterina",type:"PURPLE",pattern:[[f.NONE,f.WHEAT],[f.STONE,f.GLASS]],isMonument:!0,scorer:new Ce(2,!1),description:"2 points. Empty squares in your town are worth 0 points (instead of -1)."},Ua={name:"Statue of the Bondmaker",type:"PURPLE",pattern:[[f.WOOD,f.STONE,f.STONE,f.GLASS],[f.WHEAT,f.NONE,f.NONE,f.NONE]],isMonument:!0,description:"When another player names a resource, you may choose to place it on a square with a cottage. Each of your cottages can hold 1 resource.",effect:new Ea},Ha={name:"Architect's Guild",type:"PURPLE",pattern:[[f.NONE,f.NONE,f.GLASS],[f.NONE,f.WHEAT,f.STONE],[f.WOOD,f.BRICK,f.NONE]],isMonument:!0,scorer:new Ce(1,!1),description:"1 point. When constructed, replace up to 2 buildings in your town with any other building types.",effect:new Sa},$a={name:"Grove University",type:"PURPLE",pattern:[[f.NONE,f.BRICK,f.NONE],[f.STONE,f.GLASS,f.STONE]],isMonument:!0,scorer:new Ce(3,!1),description:"3 points. Immediately place a building on an empty square in your town.",effect:new Ca},Va={name:"Opaleye's Watch",type:"PURPLE",pattern:[[f.WOOD,f.NONE,f.NONE,f.NONE],[f.BRICK,f.GLASS,f.WHEAT,f.WHEAT],[f.STONE,f.NONE,f.NONE,f.NONE]],isMonument:!0,description:"Immediately place 3 unique buildings on this card. Whenever a player on the left or right of you constructs 1 of those buildings, take the building from here and place it on an empty square in your town.",effect:new ba},Ka={name:"Fort Ironweed",type:"PURPLE",pattern:[[f.WHEAT,f.NONE,f.BRICK],[f.STONE,f.WOOD,f.STONE]],isMonument:!0,scorer:new Ce(7,!1),description:"7 points. Unless you are the last player in the game you can no longer take turns as the master builder.",effect:new va},Ya={name:"The Starloom",type:"PURPLE",pattern:[[f.GLASS,f.GLASS],[f.WOOD,f.WHEAT]],isMonument:!0,description:"Gain points based on how early you complete your town.",scorer:new zo},Xe=[Da,Ka,La,Ma,Ua,Ha,$a,Va,xa,Pa,Ba,Fa,Wa,Ga,Ya],mt=[...qo,...Ki,...Yi,...zi,...ji,...qi,...Qi,...Xe];class js{grid;size=4;metadata=new Map;constructor(){this.grid=Array(this.size).fill(null).map(()=>Array(this.size).fill(f.NONE))}place(e,t,s){if(!this.isValid(e,t))throw new Error(`Invalid coordinate: ${e}, ${t}`);if(this.grid[e][t]!==f.NONE)throw new Error("Spot already occupied");this.grid[e][t]=s}placeBuilding(e,t,s){this.isValid(e,t)&&(this.grid[e][t]=s)}constructBuilding(e,t,s,i){if(!e.some(o=>o.row===t&&o.col===s)&&this.grid[t][s]!=="NONE")throw new Error("Building must be placed on one of the pattern squares.");this.clear(e),this.grid[t][s]=i}clear(e){e.forEach(({row:t,col:s})=>{this.isValid(t,s)&&(this.grid[t][s]=f.NONE,this.metadata.delete(`${t},${s}`))})}getGrid(){return this.grid.map(e=>[...e])}isValid(e,t){return e>=0&&e<this.size&&t>=0&&t<this.size}remove(e,t){this.isValid(e,t)&&(this.grid[e][t]="NONE",this.metadata.delete(`${e},${t}`))}setMetadata(e,t,s){this.metadata.set(`${e},${t}`,s)}getMetadata(e,t){return this.metadata.get(`${e},${t}`)}}class za{static rotate(e){return e[0].map((t,s)=>e.map(i=>i[s]).reverse())}static flip(e){return e.map(t=>[...t].reverse())}static getSymmetries(e){const t=new Set;let s=e;for(let i=0;i<4;i++)t.add(JSON.stringify(s)),t.add(JSON.stringify(this.flip(s))),s=this.rotate(s);return Array.from(t).map(i=>JSON.parse(i))}static findMatches(e,t,s){const i=this.getSymmetries(t.pattern),r=[];for(const o of i){const a=o.length,l=o[0].length;for(let c=0;c<=4-a;c++)for(let u=0;u<=4-l;u++)this.isMatch(e,o,c,u,s)&&r.push({row:c,col:u,pattern:o})}return r}static isMatch(e,t,s,i,r){return t.every((o,a)=>o.every((l,c)=>{const u=s+a,h=i+c,d=e[u][h];if(l==="NONE"||d===l||d&&d.toUpperCase().replace("_"," ")==="TRADING POST")return!0;if(r){const p=`${u},${h}`,m=r instanceof Map?r.get(p):r[p];if(m&&m.storedResource===l)return!0}return!1}))}}class ja{static calculateScore(e,t,s,i,r=0){const l={},c=S=>s.find(W=>W.name.toUpperCase()===S.toUpperCase()),u={};let h=0,d=0;const p=new Set;for(let S=0;S<4;S++)for(let W=0;W<4;W++){const z=e[S][W];if(!this.isBuilding(z)){h++;continue}u[z]=(u[z]||0)+1;const te=c(z);if(te&&te.feeder){const ne=te.feeder.getFedPositions(S,W,e);ne.length>0&&ne[0].r===-1?d+=ne.length:ne.forEach(Z=>p.add(`${Z.r},${Z.c}`))}}const m=new Set;let _=0;for(let S=0;S<4;S++)for(let W=0;W<4;W++){const z=e[S][W];if(!this.isBuilding(z))continue;const te=c(z);if(te&&te.feedCost){const ne=`${S},${W}`;let Z=!1;p.has(ne)?Z=!0:d>=te.feedCost&&(d-=te.feedCost,Z=!0),Z&&(m.add(ne),z===se.COTTAGE&&_++,z===se.BARRETT_CASTLE&&(_+=2))}}const E=s.map(S=>S.name);for(let S=0;S<4;S++)for(let W=0;W<4;W++){const z=e[S][W];if(!this.isBuilding(z))continue;const te=c(z);if(te){if(te.scorer){const ne={grid:e,row:S,col:W,counts:u,fedState:m.has(`${S},${W}`),metadata:t,validBuildingNames:E,allFedPositions:m,registry:s,fedCottageCount:_,finishRank:i,rightNeighborFeastHallCount:r},Z=te.scorer.score(ne);l[z]=(l[z]||0)+Z}if(z.toUpperCase()==="WAREHOUSE"){const ne=`${S},${W}`,Z=t instanceof Map?t.get(ne):t[ne];if(Z&&Z.storedResources&&Array.isArray(Z.storedResources)){const Oo=Z.storedResources.length;l[z]=(l[z]||0)-Oo}}}}if(u[se.TAVERN]){const S=[0,2,5,9,14,20],W=Math.min(u[se.TAVERN],5);l[se.TAVERN]=S[W]}let k=0;Object.values(l).forEach(S=>k+=S);const x=(u.CATHEDRAL||0)>0?0:h;return{total:k-x,breakdown:l,penaltyCount:x}}static isBuilding(e){return!["NONE","WOOD","WHEAT","BRICK","GLASS","STONE"].includes(e)}}class qa{board;currentResource=null;availableMatches=[];activeMonument=null;gameRegistry=[];rightNeighborFeastHallCount=0;lastMove=null;constructor(){this.board=new js}setRightNeighborFeastHallCount(e){this.rightNeighborFeastHallCount=e}setMonument(e,t){this.activeMonument=e,this.gameRegistry=[...t,this.activeMonument],this.scanForMatches()}start(){if(this.board=new js,this.currentResource=null,this.lastMove=null,this.availableMatches=[],this.gameRegistry.length===0){const e=mt.filter(s=>s.isMonument),t=mt.filter(s=>!s.isMonument);this.activeMonument=e[Math.floor(Math.random()*e.length)],this.gameRegistry=[...t,this.activeMonument]}}placeResource(e,t){if(!this.currentResource)throw new Error("No resource selected");const i=this.board.getGrid()[e][t];if(i==="NONE")this.board.place(e,t,this.currentResource);else if(i==="COTTAGE"&&this.hasStatueOfBondmaker()){const r=this.board.getMetadata(e,t);if(r&&r.storedResource)throw new Error("This Cottage is already holding a resource!");this.board.setMetadata(e,t,{...r,storedResource:this.currentResource})}else throw new Error("Cannot place resource here.");this.lastMove={r:e,c:t},this.currentResource=null,this.scanForMatches()}constructBuilding(e,t,s){const i=[];let r=0,o=!1;if(e.pattern.forEach((l,c)=>{l.forEach((u,h)=>{u&&u!=="NONE"&&i.push({row:e.row+c,col:e.col+h})})}),e.buildingName.toUpperCase()==="SHRINE OF THE ELDER TREE"){o=!0;const c=this.countBuildingsOnBoard()+1;c<6?r=c:r=8}i.forEach(l=>{const c=this.board.getGrid()[l.row][l.col],u=c&&c.toUpperCase().replace("_"," ")==="TRADING POST",h=this.board.getMetadata(l.row,l.col);h&&h.storedResource?this.board.setMetadata(l.row,l.col,{...h,storedResource:null}):u||this.board.remove(l.row,l.col)}),this.board.placeBuilding(t,s,e.buildingName),o&&this.board.setMetadata(t,s,{savedScore:r}),this.lastMove=null,this.scanForMatches();const a=mt.find(l=>l.name.toUpperCase()===e.buildingName.toUpperCase());return a&&a.effect?{type:"TRIGGER_EFFECT",effectType:a.effect.type}:{type:"SUCCESS"}}undo(){this.lastMove&&(this.board.remove(this.lastMove.r,this.lastMove.c),this.lastMove=null,this.scanForMatches())}canUndo(){return this.lastMove!==null}scanForMatches(){this.availableMatches=[];const e=this.board.getGrid(),t=e.some(s=>s.some(i=>this.gameRegistry.find(o=>o.name.toUpperCase()===i.toUpperCase())?.isMonument));for(const s of this.gameRegistry){if(t&&s.isMonument)continue;za.findMatches(e,s,this.board.metadata).forEach(r=>{this.availableMatches.push({...r,buildingName:s.name.toUpperCase()})})}}checkGameOver(){const t=this.board.getGrid().some(i=>i.some(r=>r==="NONE")),s=this.availableMatches.length>0;return!t&&!s}getScore(e){return ja.calculateScore(this.board.getGrid(),this.board.metadata,this.gameRegistry,e,this.rightNeighborFeastHallCount)}countBuildingsOnBoard(){const e=this.board.getGrid();let t=0;const s=["WOOD","WHEAT","BRICK","GLASS","STONE","NONE"];return e.forEach(i=>{i.forEach(r=>{s.includes(r)||t++})}),t}hasObeliskAbility(){return this.board.getGrid().some(t=>t.some(s=>s.toUpperCase().includes("OBELISK")))}findEffectBuildings(e,t=!0){const s=this.board.getGrid(),i=[];return s.forEach((r,o)=>{r.forEach((a,l)=>{if(["WOOD","WHEAT","BRICK","GLASS","STONE","NONE"].includes(a))return;const c=this.gameRegistry.find(u=>u.name.toUpperCase()===a.toUpperCase());if(c&&c.effect&&c.effect.type===e){const u=this.board.getMetadata(o,l),h=u?u.storedResource:null;t?h&&i.push({r:o,c:l,storedRes:h}):i.push({r:o,c:l,storedRes:h})}})}),i}setBuildingStorage(e,t,s){this.board.setMetadata(e,t,{storedResource:s})}canFactorySwap(e){const s=this.findEffectBuildings("FACTORY").find(i=>i.storedRes===e);return s?{r:s.r,c:s.c}:null}getForbiddenResources(){return this.findEffectBuildings("BANK").map(t=>t.storedRes).filter(t=>t!==null)}storeInWarehouse(e,t,s){const i=this.board.getMetadata(e,t)||{},r=i.storedResources||[];return r.length>=3?!1:(r.push(s),this.board.setMetadata(e,t,{...i,storedResources:r}),!0)}swapInWarehouse(e,t,s,i){const r=this.board.getMetadata(e,t);if(!r||!r.storedResources)return null;const o=[...r.storedResources];if(s<0||s>=o.length)return null;const a=o[s];return o[s]=i,this.board.setMetadata(e,t,{...r,storedResources:o}),a}getWarehouseContents(e,t){return this.board.getMetadata(e,t)?.storedResources||[]}hasStatueOfBondmaker(){const e=this.findEffectBuildings("STATUE_BONDMAKER",!1);return console.log(`Checking for Bondmaker. Found: ${e.length}`,e),e.length>0}placeFreeBuilding(e,t,s){if(this.board.getGrid()[e][t]!=="NONE")throw new Error("Target square must be empty!");this.board.placeBuilding(e,t,s),this.scanForMatches()}replaceBuilding(e,t,s){const r=this.board.getGrid()[e][t];if(r==="NONE"||["WOOD","WHEAT","BRICK","GLASS","STONE"].includes(r))throw new Error("Must select an existing building!");this.board.placeBuilding(e,t,s),this.board.setMetadata(e,t,{}),this.scanForMatches()}initializeOpaleye(e,t,s){this.board.setMetadata(e,t,{opaleyeBuildings:s})}checkOpaleyeMatch(e){const t=this.board.getGrid(),s=e.toUpperCase();for(let i=0;i<4;i++)for(let r=0;r<4;r++)if(t[i][r].toUpperCase().includes("OPALEYE")){const o=this.board.getMetadata(i,r);if(o&&o.opaleyeBuildings&&o.opaleyeBuildings.some(l=>l.toUpperCase()===s))return{r:i,c:r}}return null}removeOpaleyeItem(e,t,s){const i=this.board.getMetadata(e,t);if(!i||!i.opaleyeBuildings){console.error("[Opaleye] No metadata found at",e,t);return}console.log("[Opaleye] Attempting remove:",s),console.log("[Opaleye] Current List:",i.opaleyeBuildings);const r=s.trim().toUpperCase(),o=i.opaleyeBuildings.filter(a=>a.trim().toUpperCase()!==r);console.log("[Opaleye] Updated List:",o),o.length===i.opaleyeBuildings.length&&console.warn("[Opaleye] WARNING: Nothing was removed! Name mismatch?"),this.board.setMetadata(e,t,{...i,opaleyeBuildings:o})}}class Qa{boardEl=document.getElementById("board");buildMenuEl=document.getElementById("build-menu");msgLabel=document.getElementById("message");paletteEl=document.getElementById("resource-palette");scoreEl=document.getElementById("score-display");undoBtn=document.getElementById("undo-btn");deckDisplayEl=document.getElementById("deck-display");factoryBar=document.getElementById("factory-action-bar");swapBtn=document.getElementById("factory-swap-btn");swapResLabel=document.getElementById("swap-res-name");onCellClick=()=>{};onResourceSelect=()=>{};onBuildClick=()=>{};onCancelClick=()=>{};onSwapClick=()=>{};constructor(){this.swapBtn.onclick=()=>this.onSwapClick()}render(e,t,s,i,r=[]){this.renderHeader(e),this.renderBoard(e,t,s,i),this.renderSidebar(e,t),this.renderControls(e,t,r)}renderHeader(e){const t=e.getScore(),s=t.total+t.penaltyCount;this.scoreEl.innerHTML=`Score: ${s} <span style="font-size:12px; color:#999">(-${t.penaltyCount} empty)</span>`}renderBoard(e,t,s,i){const r=e.board.getGrid(),o=["WOOD","WHEAT","BRICK","GLASS","STONE"];this.boardEl.children.length===0&&r.forEach((l,c)=>{l.forEach((u,h)=>{const d=document.createElement("div");d.dataset.r=c.toString(),d.dataset.c=h.toString(),d.onclick=()=>this.onCellClick(c,h),this.boardEl.appendChild(d)})}),Array.from(this.boardEl.children).forEach(l=>{const c=parseInt(l.dataset.r),u=parseInt(l.dataset.c),h=r[c][u];if(l.className="cell",l.style.backgroundColor="",l.innerHTML="",h==="NONE")l.classList.add("empty");else if(o.includes(h))l.classList.add(h),l.textContent=h;else{const p=e.gameRegistry.find(m=>m.name.toUpperCase()===h.toUpperCase());if(p){if(l.classList.add("constructed"),p.isMonument)l.classList.add("MONUMENT");else{const m=h.replace(/ /g,"-").replace(/'/g,"").toUpperCase();l.classList.add(m)}p.color&&(l.style.backgroundColor=p.color)}}const d=e.board.getMetadata(c,u);if(d&&d.storedResource){const p=document.createElement("div");p.className=`stored-resource-icon ${d.storedResource}`,p.title=`Stored: ${d.storedResource}`,l.appendChild(p)}if(d&&d.storedResources&&Array.isArray(d.storedResources)){const p=document.createElement("div");p.className="warehouse-storage",d.storedResources.forEach(m=>{const _=document.createElement("div");_.className=`mini-resource ${m}`,p.appendChild(_)}),l.appendChild(p)}if(d&&d.opaleyeBuildings&&Array.isArray(d.opaleyeBuildings)){const p=document.createElement("div");p.className="warehouse-storage",d.opaleyeBuildings.forEach(m=>{const _=document.createElement("div"),E=m.replace(/ /g,"-").replace(/'/g,"").toUpperCase();_.className=`mini-cell ${E} on-board-mini`,_.title=m,p.appendChild(_)}),l.appendChild(p)}if(e.currentResource&&!t&&h.toUpperCase()==="WAREHOUSE"&&(l.classList.add("interactive-building"),l.title="Click to Store or Swap"),t){const p=s.some(A=>A.row===c&&A.col===u),m=e.hasObeliskAbility(),_=t.buildingName.toUpperCase()==="SHED",E=(m||_)&&h==="NONE",k=h&&h.toUpperCase().replace("_"," ")==="TRADING POST";(p&&!k||E)&&l.classList.add("match-highlight")}h==="NONE"&&e.currentResource&&!t?(l.onmouseenter=()=>{l.classList.add("ghost",e.currentResource)},l.onmouseleave=()=>{l.classList.remove("ghost","WOOD","WHEAT","BRICK","GLASS","STONE")}):(l.onmouseenter=null,l.onmouseleave=null)}),t?(this.msgLabel.textContent=`Select a highlighted square to build your ${t.buildingName}!`,this.msgLabel.style.color="#d32f2f"):i?(this.msgLabel.textContent=i,i.includes("Waiting")?this.msgLabel.style.color="#d32f2f":i.includes("YOU")?this.msgLabel.style.color="#2e7d32":this.msgLabel.style.color="#333"):e.availableMatches.length>0?(this.msgLabel.textContent="Matches available!",this.msgLabel.style.color="#333"):e.currentResource?(this.msgLabel.textContent=`Place ${e.currentResource}...`,this.msgLabel.style.color="#333"):(this.msgLabel.textContent="Select a Resource...",this.msgLabel.style.color="#1976d2")}renderSidebar(e,t){if(this.buildMenuEl.innerHTML="",e.availableMatches.length===0){const s=document.createElement("p");s.textContent="No patterns found.",s.style.color="#777",s.style.fontStyle="italic",this.buildMenuEl.appendChild(s)}else e.availableMatches.forEach(s=>{const i=document.createElement("button");i.textContent=`Build ${s.buildingName}`;const r=s.buildingName.replace(/ /g,"-").replace(/'/g,"").toUpperCase();i.className=`build-btn ${r}`,i.onclick=()=>this.onBuildClick(s);const o=[];s.pattern&&Array.isArray(s.pattern)?s.pattern.forEach((a,l)=>{a.forEach((c,u)=>{c&&c!=="NONE"&&o.push({row:s.row+l,col:s.col+u})})}):o.push({row:s.row,col:s.col}),i.onmouseenter=()=>this.togglePreview(o,!0),i.onmouseleave=()=>this.togglePreview(o,!1),this.buildMenuEl.appendChild(i)});if(t){const s=document.createElement("button");s.textContent="Cancel Construction",s.className="secondary-btn",s.style.marginTop="10px",s.style.width="100%",s.onclick=()=>this.onCancelClick(),this.buildMenuEl.appendChild(s)}}togglePreview(e,t){e.forEach(s=>{const i=`div[data-r="${s.row}"][data-c="${s.col}"]`,r=this.boardEl.querySelector(i);r&&(t?r.classList.add("preview-target"):r.classList.remove("preview-target"))})}renderControls(e,t,s){this.paletteEl.innerHTML="",[f.WOOD,f.WHEAT,f.BRICK,f.GLASS,f.STONE].forEach(r=>{const o=document.createElement("div");let a=`res-btn ${r}`;e.currentResource===r&&!t&&(a+=" selected"),s.includes(r)&&(a+=" disabled",o.title="Blocked by bank"),o.className=a,o.textContent=r.charAt(0),s.includes(r)||(o.onclick=()=>this.onResourceSelect(r)),this.paletteEl.appendChild(o)}),e.canUndo()&&!t?this.undoBtn.removeAttribute("disabled"):this.undoBtn.setAttribute("disabled","true")}renderDeck(e){this.deckDisplayEl&&(this.deckDisplayEl.innerHTML="",e.forEach(t=>{const s=document.createElement("div");t.isMonument?s.className="building-card MONUMENT":s.className=`building-card ${t.name.toUpperCase()}`;const i=document.createElement("header");i.className="card-header";const r=document.createElement("span");r.textContent=t.name;const o=document.createElement("div"),a=t.name.replace(/ /g,"-").replace(/'/g,"").toUpperCase();o.className=`card-icon ${a}`,i.appendChild(r),i.appendChild(o),s.appendChild(i);const l=document.createElement("div");l.className="card-body";const c=document.createElement("div");c.className="mini-pattern";const u=t.pattern[0].length;c.style.gridTemplateColumns=`repeat(${u}, 15px)`,t.pattern.forEach(d=>{d.forEach(p=>{const m=document.createElement("div"),_=p==="NONE"?"pattern-empty":p;m.className=`pattern-cell ${_}`,c.appendChild(m)})});const h=document.createElement("div");h.className="card-text",h.textContent=t.description||"Unique scoring rules.",l.appendChild(c),l.appendChild(h),s.appendChild(l),this.deckDisplayEl.appendChild(s)}))}toggleFactoryAction(e,t=""){e?(this.factoryBar.classList.remove("hidden"),this.swapResLabel.textContent=t):this.factoryBar.classList.add("hidden")}}const Xa=()=>{};var qs={};const Xi={NODE_ADMIN:!1,SDK_VERSION:"${JSCORE_VERSION}"};const g=function(n,e){if(!n)throw ot(e)},ot=function(n){return new Error("Firebase Database ("+Xi.SDK_VERSION+") INTERNAL ASSERT FAILED: "+n)};const Ji=function(n){const e=[];let t=0;for(let s=0;s<n.length;s++){let i=n.charCodeAt(s);i<128?e[t++]=i:i<2048?(e[t++]=i>>6|192,e[t++]=i&63|128):(i&64512)===55296&&s+1<n.length&&(n.charCodeAt(s+1)&64512)===56320?(i=65536+((i&1023)<<10)+(n.charCodeAt(++s)&1023),e[t++]=i>>18|240,e[t++]=i>>12&63|128,e[t++]=i>>6&63|128,e[t++]=i&63|128):(e[t++]=i>>12|224,e[t++]=i>>6&63|128,e[t++]=i&63|128)}return e},Ja=function(n){const e=[];let t=0,s=0;for(;t<n.length;){const i=n[t++];if(i<128)e[s++]=String.fromCharCode(i);else if(i>191&&i<224){const r=n[t++];e[s++]=String.fromCharCode((i&31)<<6|r&63)}else if(i>239&&i<365){const r=n[t++],o=n[t++],a=n[t++],l=((i&7)<<18|(r&63)<<12|(o&63)<<6|a&63)-65536;e[s++]=String.fromCharCode(55296+(l>>10)),e[s++]=String.fromCharCode(56320+(l&1023))}else{const r=n[t++],o=n[t++];e[s++]=String.fromCharCode((i&15)<<12|(r&63)<<6|o&63)}}return e.join("")},us={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:typeof atob=="function",encodeByteArray(n,e){if(!Array.isArray(n))throw Error("encodeByteArray takes an array as a parameter");this.init_();const t=e?this.byteToCharMapWebSafe_:this.byteToCharMap_,s=[];for(let i=0;i<n.length;i+=3){const r=n[i],o=i+1<n.length,a=o?n[i+1]:0,l=i+2<n.length,c=l?n[i+2]:0,u=r>>2,h=(r&3)<<4|a>>4;let d=(a&15)<<2|c>>6,p=c&63;l||(p=64,o||(d=64)),s.push(t[u],t[h],t[d],t[p])}return s.join("")},encodeString(n,e){return this.HAS_NATIVE_SUPPORT&&!e?btoa(n):this.encodeByteArray(Ji(n),e)},decodeString(n,e){return this.HAS_NATIVE_SUPPORT&&!e?atob(n):Ja(this.decodeStringToByteArray(n,e))},decodeStringToByteArray(n,e){this.init_();const t=e?this.charToByteMapWebSafe_:this.charToByteMap_,s=[];for(let i=0;i<n.length;){const r=t[n.charAt(i++)],a=i<n.length?t[n.charAt(i)]:0;++i;const c=i<n.length?t[n.charAt(i)]:64;++i;const h=i<n.length?t[n.charAt(i)]:64;if(++i,r==null||a==null||c==null||h==null)throw new Za;const d=r<<2|a>>4;if(s.push(d),c!==64){const p=a<<4&240|c>>2;if(s.push(p),h!==64){const m=c<<6&192|h;s.push(m)}}}return s},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let n=0;n<this.ENCODED_VALS.length;n++)this.byteToCharMap_[n]=this.ENCODED_VALS.charAt(n),this.charToByteMap_[this.byteToCharMap_[n]]=n,this.byteToCharMapWebSafe_[n]=this.ENCODED_VALS_WEBSAFE.charAt(n),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[n]]=n,n>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(n)]=n,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(n)]=n)}}};class Za extends Error{constructor(){super(...arguments),this.name="DecodeBase64StringError"}}const Zi=function(n){const e=Ji(n);return us.encodeByteArray(e,!0)},Kt=function(n){return Zi(n).replace(/\./g,"")},Hn=function(n){try{return us.decodeString(n,!0)}catch(e){console.error("base64Decode failed: ",e)}return null};function el(n){return er(void 0,n)}function er(n,e){if(!(e instanceof Object))return e;switch(e.constructor){case Date:const t=e;return new Date(t.getTime());case Object:n===void 0&&(n={});break;case Array:n=[];break;default:return e}for(const t in e)!e.hasOwnProperty(t)||!tl(t)||(n[t]=er(n[t],e[t]));return n}function tl(n){return n!=="__proto__"}function nl(){if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global;throw new Error("Unable to locate global object.")}const sl=()=>nl().__FIREBASE_DEFAULTS__,il=()=>{if(typeof process>"u"||typeof qs>"u")return;const n=qs.__FIREBASE_DEFAULTS__;if(n)return JSON.parse(n)},rl=()=>{if(typeof document>"u")return;let n;try{n=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch{return}const e=n&&Hn(n[1]);return e&&JSON.parse(e)},tr=()=>{try{return Xa()||sl()||il()||rl()}catch(n){console.info(`Unable to get __FIREBASE_DEFAULTS__ due to: ${n}`);return}},ol=n=>tr()?.emulatorHosts?.[n],al=n=>{const e=ol(n);if(!e)return;const t=e.lastIndexOf(":");if(t<=0||t+1===e.length)throw new Error(`Invalid host ${e} with no separate hostname and port!`);const s=parseInt(e.substring(t+1),10);return e[0]==="["?[e.substring(1,t-1),s]:[e.substring(0,t),s]},nr=()=>tr()?.config;class re{constructor(){this.reject=()=>{},this.resolve=()=>{},this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}wrapCallback(e){return(t,s)=>{t?this.reject(t):this.resolve(s),typeof e=="function"&&(this.promise.catch(()=>{}),e.length===1?e(t):e(t,s))}}}function hs(n){try{return(n.startsWith("http://")||n.startsWith("https://")?new URL(n).hostname:n).endsWith(".cloudworkstations.dev")}catch{return!1}}async function ll(n){return(await fetch(n,{credentials:"include"})).ok}function cl(n,e){if(n.uid)throw new Error('The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.');const t={alg:"none",type:"JWT"},s=e||"demo-project",i=n.iat||0,r=n.sub||n.user_id;if(!r)throw new Error("mockUserToken must contain 'sub' or 'user_id' field!");const o={iss:`https://securetoken.google.com/${s}`,aud:s,iat:i,exp:i+3600,auth_time:i,sub:r,user_id:r,firebase:{sign_in_provider:"custom",identities:{}},...n};return[Kt(JSON.stringify(t)),Kt(JSON.stringify(o)),""].join(".")}const gt={};function dl(){const n={prod:[],emulator:[]};for(const e of Object.keys(gt))gt[e]?n.emulator.push(e):n.prod.push(e);return n}function ul(n){let e=document.getElementById(n),t=!1;return e||(e=document.createElement("div"),e.setAttribute("id",n),t=!0),{created:t,element:e}}let Qs=!1;function hl(n,e){if(typeof window>"u"||typeof document>"u"||!hs(window.location.host)||gt[n]===e||gt[n]||Qs)return;gt[n]=e;function t(d){return`__firebase__banner__${d}`}const s="__firebase__banner",r=dl().prod.length>0;function o(){const d=document.getElementById(s);d&&d.remove()}function a(d){d.style.display="flex",d.style.background="#7faaf0",d.style.position="fixed",d.style.bottom="5px",d.style.left="5px",d.style.padding=".5em",d.style.borderRadius="5px",d.style.alignItems="center"}function l(d,p){d.setAttribute("width","24"),d.setAttribute("id",p),d.setAttribute("height","24"),d.setAttribute("viewBox","0 0 24 24"),d.setAttribute("fill","none"),d.style.marginLeft="-6px"}function c(){const d=document.createElement("span");return d.style.cursor="pointer",d.style.marginLeft="16px",d.style.fontSize="24px",d.innerHTML=" &times;",d.onclick=()=>{Qs=!0,o()},d}function u(d,p){d.setAttribute("id",p),d.innerText="Learn more",d.href="https://firebase.google.com/docs/studio/preview-apps#preview-backend",d.setAttribute("target","__blank"),d.style.paddingLeft="5px",d.style.textDecoration="underline"}function h(){const d=ul(s),p=t("text"),m=document.getElementById(p)||document.createElement("span"),_=t("learnmore"),E=document.getElementById(_)||document.createElement("a"),k=t("preprendIcon"),A=document.getElementById(k)||document.createElementNS("http://www.w3.org/2000/svg","svg");if(d.created){const x=d.element;a(x),u(E,_);const S=c();l(A,k),x.append(A,m,E,S),document.body.appendChild(x)}r?(m.innerText="Preview backend disconnected.",A.innerHTML=`<g clip-path="url(#clip0_6013_33858)">
<path d="M4.8 17.6L12 5.6L19.2 17.6H4.8ZM6.91667 16.4H17.0833L12 7.93333L6.91667 16.4ZM12 15.6C12.1667 15.6 12.3056 15.5444 12.4167 15.4333C12.5389 15.3111 12.6 15.1667 12.6 15C12.6 14.8333 12.5389 14.6944 12.4167 14.5833C12.3056 14.4611 12.1667 14.4 12 14.4C11.8333 14.4 11.6889 14.4611 11.5667 14.5833C11.4556 14.6944 11.4 14.8333 11.4 15C11.4 15.1667 11.4556 15.3111 11.5667 15.4333C11.6889 15.5444 11.8333 15.6 12 15.6ZM11.4 13.6H12.6V10.4H11.4V13.6Z" fill="#212121"/>
</g>
<defs>
<clipPath id="clip0_6013_33858">
<rect width="24" height="24" fill="white"/>
</clipPath>
</defs>`):(A.innerHTML=`<g clip-path="url(#clip0_6083_34804)">
<path d="M11.4 15.2H12.6V11.2H11.4V15.2ZM12 10C12.1667 10 12.3056 9.94444 12.4167 9.83333C12.5389 9.71111 12.6 9.56667 12.6 9.4C12.6 9.23333 12.5389 9.09444 12.4167 8.98333C12.3056 8.86111 12.1667 8.8 12 8.8C11.8333 8.8 11.6889 8.86111 11.5667 8.98333C11.4556 9.09444 11.4 9.23333 11.4 9.4C11.4 9.56667 11.4556 9.71111 11.5667 9.83333C11.6889 9.94444 11.8333 10 12 10ZM12 18.4C11.1222 18.4 10.2944 18.2333 9.51667 17.9C8.73889 17.5667 8.05556 17.1111 7.46667 16.5333C6.88889 15.9444 6.43333 15.2611 6.1 14.4833C5.76667 13.7056 5.6 12.8778 5.6 12C5.6 11.1111 5.76667 10.2833 6.1 9.51667C6.43333 8.73889 6.88889 8.06111 7.46667 7.48333C8.05556 6.89444 8.73889 6.43333 9.51667 6.1C10.2944 5.76667 11.1222 5.6 12 5.6C12.8889 5.6 13.7167 5.76667 14.4833 6.1C15.2611 6.43333 15.9389 6.89444 16.5167 7.48333C17.1056 8.06111 17.5667 8.73889 17.9 9.51667C18.2333 10.2833 18.4 11.1111 18.4 12C18.4 12.8778 18.2333 13.7056 17.9 14.4833C17.5667 15.2611 17.1056 15.9444 16.5167 16.5333C15.9389 17.1111 15.2611 17.5667 14.4833 17.9C13.7167 18.2333 12.8889 18.4 12 18.4ZM12 17.2C13.4444 17.2 14.6722 16.6944 15.6833 15.6833C16.6944 14.6722 17.2 13.4444 17.2 12C17.2 10.5556 16.6944 9.32778 15.6833 8.31667C14.6722 7.30555 13.4444 6.8 12 6.8C10.5556 6.8 9.32778 7.30555 8.31667 8.31667C7.30556 9.32778 6.8 10.5556 6.8 12C6.8 13.4444 7.30556 14.6722 8.31667 15.6833C9.32778 16.6944 10.5556 17.2 12 17.2Z" fill="#212121"/>
</g>
<defs>
<clipPath id="clip0_6083_34804">
<rect width="24" height="24" fill="white"/>
</clipPath>
</defs>`,m.innerText="Preview backend running in this workspace."),m.setAttribute("id",p)}document.readyState==="loading"?window.addEventListener("DOMContentLoaded",h):h()}function fl(){return typeof navigator<"u"&&typeof navigator.userAgent=="string"?navigator.userAgent:""}function sr(){return typeof window<"u"&&!!(window.cordova||window.phonegap||window.PhoneGap)&&/ios|iphone|ipod|ipad|android|blackberry|iemobile/i.test(fl())}function pl(){return typeof navigator=="object"&&navigator.product==="ReactNative"}function ml(){return Xi.NODE_ADMIN===!0}function gl(){try{return typeof indexedDB=="object"}catch{return!1}}function _l(){return new Promise((n,e)=>{try{let t=!0;const s="validate-browser-context-for-indexeddb-analytics-module",i=self.indexedDB.open(s);i.onsuccess=()=>{i.result.close(),t||self.indexedDB.deleteDatabase(s),n(!0)},i.onupgradeneeded=()=>{t=!1},i.onerror=()=>{e(i.error?.message||"")}}catch(t){e(t)}})}const yl="FirebaseError";class Lt extends Error{constructor(e,t,s){super(t),this.code=e,this.customData=s,this.name=yl,Object.setPrototypeOf(this,Lt.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,ir.prototype.create)}}class ir{constructor(e,t,s){this.service=e,this.serviceName=t,this.errors=s}create(e,...t){const s=t[0]||{},i=`${this.service}/${e}`,r=this.errors[e],o=r?El(r,s):"Error",a=`${this.serviceName}: ${o} (${i}).`;return new Lt(i,a,s)}}function El(n,e){return n.replace(Cl,(t,s)=>{const i=e[s];return i!=null?String(i):`<${s}?>`})}const Cl=/\{\$([^}]+)}/g;function St(n){return JSON.parse(n)}function H(n){return JSON.stringify(n)}const rr=function(n){let e={},t={},s={},i="";try{const r=n.split(".");e=St(Hn(r[0])||""),t=St(Hn(r[1])||""),i=r[2],s=t.d||{},delete t.d}catch{}return{header:e,claims:t,data:s,signature:i}},vl=function(n){const e=rr(n),t=e.claims;return!!t&&typeof t=="object"&&t.hasOwnProperty("iat")},Sl=function(n){const e=rr(n).claims;return typeof e=="object"&&e.admin===!0};function de(n,e){return Object.prototype.hasOwnProperty.call(n,e)}function We(n,e){if(Object.prototype.hasOwnProperty.call(n,e))return n[e]}function $n(n){for(const e in n)if(Object.prototype.hasOwnProperty.call(n,e))return!1;return!0}function Yt(n,e,t){const s={};for(const i in n)Object.prototype.hasOwnProperty.call(n,i)&&(s[i]=e.call(t,n[i],i,n));return s}function zt(n,e){if(n===e)return!0;const t=Object.keys(n),s=Object.keys(e);for(const i of t){if(!s.includes(i))return!1;const r=n[i],o=e[i];if(Xs(r)&&Xs(o)){if(!zt(r,o))return!1}else if(r!==o)return!1}for(const i of s)if(!t.includes(i))return!1;return!0}function Xs(n){return n!==null&&typeof n=="object"}function bl(n){const e=[];for(const[t,s]of Object.entries(n))Array.isArray(s)?s.forEach(i=>{e.push(encodeURIComponent(t)+"="+encodeURIComponent(i))}):e.push(encodeURIComponent(t)+"="+encodeURIComponent(s));return e.length?"&"+e.join("&"):""}class wl{constructor(){this.chain_=[],this.buf_=[],this.W_=[],this.pad_=[],this.inbuf_=0,this.total_=0,this.blockSize=512/8,this.pad_[0]=128;for(let e=1;e<this.blockSize;++e)this.pad_[e]=0;this.reset()}reset(){this.chain_[0]=1732584193,this.chain_[1]=4023233417,this.chain_[2]=2562383102,this.chain_[3]=271733878,this.chain_[4]=3285377520,this.inbuf_=0,this.total_=0}compress_(e,t){t||(t=0);const s=this.W_;if(typeof e=="string")for(let h=0;h<16;h++)s[h]=e.charCodeAt(t)<<24|e.charCodeAt(t+1)<<16|e.charCodeAt(t+2)<<8|e.charCodeAt(t+3),t+=4;else for(let h=0;h<16;h++)s[h]=e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3],t+=4;for(let h=16;h<80;h++){const d=s[h-3]^s[h-8]^s[h-14]^s[h-16];s[h]=(d<<1|d>>>31)&4294967295}let i=this.chain_[0],r=this.chain_[1],o=this.chain_[2],a=this.chain_[3],l=this.chain_[4],c,u;for(let h=0;h<80;h++){h<40?h<20?(c=a^r&(o^a),u=1518500249):(c=r^o^a,u=1859775393):h<60?(c=r&o|a&(r|o),u=2400959708):(c=r^o^a,u=3395469782);const d=(i<<5|i>>>27)+c+l+u+s[h]&4294967295;l=a,a=o,o=(r<<30|r>>>2)&4294967295,r=i,i=d}this.chain_[0]=this.chain_[0]+i&4294967295,this.chain_[1]=this.chain_[1]+r&4294967295,this.chain_[2]=this.chain_[2]+o&4294967295,this.chain_[3]=this.chain_[3]+a&4294967295,this.chain_[4]=this.chain_[4]+l&4294967295}update(e,t){if(e==null)return;t===void 0&&(t=e.length);const s=t-this.blockSize;let i=0;const r=this.buf_;let o=this.inbuf_;for(;i<t;){if(o===0)for(;i<=s;)this.compress_(e,i),i+=this.blockSize;if(typeof e=="string"){for(;i<t;)if(r[o]=e.charCodeAt(i),++o,++i,o===this.blockSize){this.compress_(r),o=0;break}}else for(;i<t;)if(r[o]=e[i],++o,++i,o===this.blockSize){this.compress_(r),o=0;break}}this.inbuf_=o,this.total_+=t}digest(){const e=[];let t=this.total_*8;this.inbuf_<56?this.update(this.pad_,56-this.inbuf_):this.update(this.pad_,this.blockSize-(this.inbuf_-56));for(let i=this.blockSize-1;i>=56;i--)this.buf_[i]=t&255,t/=256;this.compress_(this.buf_);let s=0;for(let i=0;i<5;i++)for(let r=24;r>=0;r-=8)e[s]=this.chain_[i]>>r&255,++s;return e}}function Je(n,e){return`${n} failed: ${e} argument `}const Il=function(n){const e=[];let t=0;for(let s=0;s<n.length;s++){let i=n.charCodeAt(s);if(i>=55296&&i<=56319){const r=i-55296;s++,g(s<n.length,"Surrogate pair missing trail surrogate.");const o=n.charCodeAt(s)-56320;i=65536+(r<<10)+o}i<128?e[t++]=i:i<2048?(e[t++]=i>>6|192,e[t++]=i&63|128):i<65536?(e[t++]=i>>12|224,e[t++]=i>>6&63|128,e[t++]=i&63|128):(e[t++]=i>>18|240,e[t++]=i>>12&63|128,e[t++]=i>>6&63|128,e[t++]=i&63|128)}return e},fn=function(n){let e=0;for(let t=0;t<n.length;t++){const s=n.charCodeAt(t);s<128?e++:s<2048?e+=2:s>=55296&&s<=56319?(e+=4,t++):e+=3}return e};function ve(n){return n&&n._delegate?n._delegate:n}class bt{constructor(e,t,s){this.name=e,this.instanceFactory=t,this.type=s,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(e){return this.instantiationMode=e,this}setMultipleInstances(e){return this.multipleInstances=e,this}setServiceProps(e){return this.serviceProps=e,this}setInstanceCreatedCallback(e){return this.onInstanceCreated=e,this}}const De="[DEFAULT]";class Tl{constructor(e,t){this.name=e,this.container=t,this.component=null,this.instances=new Map,this.instancesDeferred=new Map,this.instancesOptions=new Map,this.onInitCallbacks=new Map}get(e){const t=this.normalizeInstanceIdentifier(e);if(!this.instancesDeferred.has(t)){const s=new re;if(this.instancesDeferred.set(t,s),this.isInitialized(t)||this.shouldAutoInitialize())try{const i=this.getOrInitializeService({instanceIdentifier:t});i&&s.resolve(i)}catch{}}return this.instancesDeferred.get(t).promise}getImmediate(e){const t=this.normalizeInstanceIdentifier(e?.identifier),s=e?.optional??!1;if(this.isInitialized(t)||this.shouldAutoInitialize())try{return this.getOrInitializeService({instanceIdentifier:t})}catch(i){if(s)return null;throw i}else{if(s)return null;throw Error(`Service ${this.name} is not available`)}}getComponent(){return this.component}setComponent(e){if(e.name!==this.name)throw Error(`Mismatching Component ${e.name} for Provider ${this.name}.`);if(this.component)throw Error(`Component for ${this.name} has already been provided`);if(this.component=e,!!this.shouldAutoInitialize()){if(Rl(e))try{this.getOrInitializeService({instanceIdentifier:De})}catch{}for(const[t,s]of this.instancesDeferred.entries()){const i=this.normalizeInstanceIdentifier(t);try{const r=this.getOrInitializeService({instanceIdentifier:i});s.resolve(r)}catch{}}}}clearInstance(e=De){this.instancesDeferred.delete(e),this.instancesOptions.delete(e),this.instances.delete(e)}async delete(){const e=Array.from(this.instances.values());await Promise.all([...e.filter(t=>"INTERNAL"in t).map(t=>t.INTERNAL.delete()),...e.filter(t=>"_delete"in t).map(t=>t._delete())])}isComponentSet(){return this.component!=null}isInitialized(e=De){return this.instances.has(e)}getOptions(e=De){return this.instancesOptions.get(e)||{}}initialize(e={}){const{options:t={}}=e,s=this.normalizeInstanceIdentifier(e.instanceIdentifier);if(this.isInitialized(s))throw Error(`${this.name}(${s}) has already been initialized`);if(!this.isComponentSet())throw Error(`Component ${this.name} has not been registered yet`);const i=this.getOrInitializeService({instanceIdentifier:s,options:t});for(const[r,o]of this.instancesDeferred.entries()){const a=this.normalizeInstanceIdentifier(r);s===a&&o.resolve(i)}return i}onInit(e,t){const s=this.normalizeInstanceIdentifier(t),i=this.onInitCallbacks.get(s)??new Set;i.add(e),this.onInitCallbacks.set(s,i);const r=this.instances.get(s);return r&&e(r,s),()=>{i.delete(e)}}invokeOnInitCallbacks(e,t){const s=this.onInitCallbacks.get(t);if(s)for(const i of s)try{i(e,t)}catch{}}getOrInitializeService({instanceIdentifier:e,options:t={}}){let s=this.instances.get(e);if(!s&&this.component&&(s=this.component.instanceFactory(this.container,{instanceIdentifier:Nl(e),options:t}),this.instances.set(e,s),this.instancesOptions.set(e,t),this.invokeOnInitCallbacks(s,e),this.component.onInstanceCreated))try{this.component.onInstanceCreated(this.container,e,s)}catch{}return s||null}normalizeInstanceIdentifier(e=De){return this.component?this.component.multipleInstances?e:De:e}shouldAutoInitialize(){return!!this.component&&this.component.instantiationMode!=="EXPLICIT"}}function Nl(n){return n===De?void 0:n}function Rl(n){return n.instantiationMode==="EAGER"}class Ol{constructor(e){this.name=e,this.providers=new Map}addComponent(e){const t=this.getProvider(e.name);if(t.isComponentSet())throw new Error(`Component ${e.name} has already been registered with ${this.name}`);t.setComponent(e)}addOrOverwriteComponent(e){this.getProvider(e.name).isComponentSet()&&this.providers.delete(e.name),this.addComponent(e)}getProvider(e){if(this.providers.has(e))return this.providers.get(e);const t=new Tl(e,this);return this.providers.set(e,t),t}getProviders(){return Array.from(this.providers.values())}}var M;(function(n){n[n.DEBUG=0]="DEBUG",n[n.VERBOSE=1]="VERBOSE",n[n.INFO=2]="INFO",n[n.WARN=3]="WARN",n[n.ERROR=4]="ERROR",n[n.SILENT=5]="SILENT"})(M||(M={}));const Al={debug:M.DEBUG,verbose:M.VERBOSE,info:M.INFO,warn:M.WARN,error:M.ERROR,silent:M.SILENT},kl=M.INFO,Dl={[M.DEBUG]:"log",[M.VERBOSE]:"log",[M.INFO]:"info",[M.WARN]:"warn",[M.ERROR]:"error"},Ll=(n,e,...t)=>{if(e<n.logLevel)return;const s=new Date().toISOString(),i=Dl[e];if(i)console[i](`[${s}]  ${n.name}:`,...t);else throw new Error(`Attempted to log a message with an invalid logType (value: ${e})`)};class or{constructor(e){this.name=e,this._logLevel=kl,this._logHandler=Ll,this._userLogHandler=null}get logLevel(){return this._logLevel}set logLevel(e){if(!(e in M))throw new TypeError(`Invalid value "${e}" assigned to \`logLevel\``);this._logLevel=e}setLogLevel(e){this._logLevel=typeof e=="string"?Al[e]:e}get logHandler(){return this._logHandler}set logHandler(e){if(typeof e!="function")throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=e}get userLogHandler(){return this._userLogHandler}set userLogHandler(e){this._userLogHandler=e}debug(...e){this._userLogHandler&&this._userLogHandler(this,M.DEBUG,...e),this._logHandler(this,M.DEBUG,...e)}log(...e){this._userLogHandler&&this._userLogHandler(this,M.VERBOSE,...e),this._logHandler(this,M.VERBOSE,...e)}info(...e){this._userLogHandler&&this._userLogHandler(this,M.INFO,...e),this._logHandler(this,M.INFO,...e)}warn(...e){this._userLogHandler&&this._userLogHandler(this,M.WARN,...e),this._logHandler(this,M.WARN,...e)}error(...e){this._userLogHandler&&this._userLogHandler(this,M.ERROR,...e),this._logHandler(this,M.ERROR,...e)}}const Ml=(n,e)=>e.some(t=>n instanceof t);let Js,Zs;function xl(){return Js||(Js=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function Pl(){return Zs||(Zs=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const ar=new WeakMap,Vn=new WeakMap,lr=new WeakMap,On=new WeakMap,fs=new WeakMap;function Bl(n){const e=new Promise((t,s)=>{const i=()=>{n.removeEventListener("success",r),n.removeEventListener("error",o)},r=()=>{t(we(n.result)),i()},o=()=>{s(n.error),i()};n.addEventListener("success",r),n.addEventListener("error",o)});return e.then(t=>{t instanceof IDBCursor&&ar.set(t,n)}).catch(()=>{}),fs.set(e,n),e}function Fl(n){if(Vn.has(n))return;const e=new Promise((t,s)=>{const i=()=>{n.removeEventListener("complete",r),n.removeEventListener("error",o),n.removeEventListener("abort",o)},r=()=>{t(),i()},o=()=>{s(n.error||new DOMException("AbortError","AbortError")),i()};n.addEventListener("complete",r),n.addEventListener("error",o),n.addEventListener("abort",o)});Vn.set(n,e)}let Kn={get(n,e,t){if(n instanceof IDBTransaction){if(e==="done")return Vn.get(n);if(e==="objectStoreNames")return n.objectStoreNames||lr.get(n);if(e==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return we(n[e])},set(n,e,t){return n[e]=t,!0},has(n,e){return n instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in n}};function Wl(n){Kn=n(Kn)}function Gl(n){return n===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(e,...t){const s=n.call(An(this),e,...t);return lr.set(s,e.sort?e.sort():[e]),we(s)}:Pl().includes(n)?function(...e){return n.apply(An(this),e),we(ar.get(this))}:function(...e){return we(n.apply(An(this),e))}}function Ul(n){return typeof n=="function"?Gl(n):(n instanceof IDBTransaction&&Fl(n),Ml(n,xl())?new Proxy(n,Kn):n)}function we(n){if(n instanceof IDBRequest)return Bl(n);if(On.has(n))return On.get(n);const e=Ul(n);return e!==n&&(On.set(n,e),fs.set(e,n)),e}const An=n=>fs.get(n);function Hl(n,e,{blocked:t,upgrade:s,blocking:i,terminated:r}={}){const o=indexedDB.open(n,e),a=we(o);return s&&o.addEventListener("upgradeneeded",l=>{s(we(o.result),l.oldVersion,l.newVersion,we(o.transaction),l)}),t&&o.addEventListener("blocked",l=>t(l.oldVersion,l.newVersion,l)),a.then(l=>{r&&l.addEventListener("close",()=>r()),i&&l.addEventListener("versionchange",c=>i(c.oldVersion,c.newVersion,c))}).catch(()=>{}),a}const $l=["get","getKey","getAll","getAllKeys","count"],Vl=["put","add","delete","clear"],kn=new Map;function ei(n,e){if(!(n instanceof IDBDatabase&&!(e in n)&&typeof e=="string"))return;if(kn.get(e))return kn.get(e);const t=e.replace(/FromIndex$/,""),s=e!==t,i=Vl.includes(t);if(!(t in(s?IDBIndex:IDBObjectStore).prototype)||!(i||$l.includes(t)))return;const r=async function(o,...a){const l=this.transaction(o,i?"readwrite":"readonly");let c=l.store;return s&&(c=c.index(a.shift())),(await Promise.all([c[t](...a),i&&l.done]))[0]};return kn.set(e,r),r}Wl(n=>({...n,get:(e,t,s)=>ei(e,t)||n.get(e,t,s),has:(e,t)=>!!ei(e,t)||n.has(e,t)}));class Kl{constructor(e){this.container=e}getPlatformInfoString(){return this.container.getProviders().map(t=>{if(Yl(t)){const s=t.getImmediate();return`${s.library}/${s.version}`}else return null}).filter(t=>t).join(" ")}}function Yl(n){return n.getComponent()?.type==="VERSION"}const Yn="@firebase/app",ti="0.14.7";const ye=new or("@firebase/app"),zl="@firebase/app-compat",jl="@firebase/analytics-compat",ql="@firebase/analytics",Ql="@firebase/app-check-compat",Xl="@firebase/app-check",Jl="@firebase/auth",Zl="@firebase/auth-compat",ec="@firebase/database",tc="@firebase/data-connect",nc="@firebase/database-compat",sc="@firebase/functions",ic="@firebase/functions-compat",rc="@firebase/installations",oc="@firebase/installations-compat",ac="@firebase/messaging",lc="@firebase/messaging-compat",cc="@firebase/performance",dc="@firebase/performance-compat",uc="@firebase/remote-config",hc="@firebase/remote-config-compat",fc="@firebase/storage",pc="@firebase/storage-compat",mc="@firebase/firestore",gc="@firebase/ai",_c="@firebase/firestore-compat",yc="firebase",Ec="12.8.0";const zn="[DEFAULT]",Cc={[Yn]:"fire-core",[zl]:"fire-core-compat",[ql]:"fire-analytics",[jl]:"fire-analytics-compat",[Xl]:"fire-app-check",[Ql]:"fire-app-check-compat",[Jl]:"fire-auth",[Zl]:"fire-auth-compat",[ec]:"fire-rtdb",[tc]:"fire-data-connect",[nc]:"fire-rtdb-compat",[sc]:"fire-fn",[ic]:"fire-fn-compat",[rc]:"fire-iid",[oc]:"fire-iid-compat",[ac]:"fire-fcm",[lc]:"fire-fcm-compat",[cc]:"fire-perf",[dc]:"fire-perf-compat",[uc]:"fire-rc",[hc]:"fire-rc-compat",[fc]:"fire-gcs",[pc]:"fire-gcs-compat",[mc]:"fire-fst",[_c]:"fire-fst-compat",[gc]:"fire-vertex","fire-js":"fire-js",[yc]:"fire-js-all"};const jt=new Map,vc=new Map,jn=new Map;function ni(n,e){try{n.container.addComponent(e)}catch(t){ye.debug(`Component ${e.name} failed to register with FirebaseApp ${n.name}`,t)}}function qt(n){const e=n.name;if(jn.has(e))return ye.debug(`There were multiple attempts to register component ${e}.`),!1;jn.set(e,n);for(const t of jt.values())ni(t,n);for(const t of vc.values())ni(t,n);return!0}function Sc(n,e){const t=n.container.getProvider("heartbeat").getImmediate({optional:!0});return t&&t.triggerHeartbeat(),n.container.getProvider(e)}function bc(n){return n==null?!1:n.settings!==void 0}const wc={"no-app":"No Firebase App '{$appName}' has been created - call initializeApp() first","bad-app-name":"Illegal App name: '{$appName}'","duplicate-app":"Firebase App named '{$appName}' already exists with different options or config","app-deleted":"Firebase App named '{$appName}' already deleted","server-app-deleted":"Firebase Server App has been deleted","no-options":"Need to provide options, when not being deployed to hosting via source.","invalid-app-argument":"firebase.{$appName}() takes either no argument or a Firebase App instance.","invalid-log-argument":"First argument to `onLog` must be null or a function.","idb-open":"Error thrown when opening IndexedDB. Original error: {$originalErrorMessage}.","idb-get":"Error thrown when reading from IndexedDB. Original error: {$originalErrorMessage}.","idb-set":"Error thrown when writing to IndexedDB. Original error: {$originalErrorMessage}.","idb-delete":"Error thrown when deleting from IndexedDB. Original error: {$originalErrorMessage}.","finalization-registry-not-supported":"FirebaseServerApp deleteOnDeref field defined but the JS runtime does not support FinalizationRegistry.","invalid-server-app-environment":"FirebaseServerApp is not for use in browser environments."},Ie=new ir("app","Firebase",wc);class Ic{constructor(e,t,s){this._isDeleted=!1,this._options={...e},this._config={...t},this._name=t.name,this._automaticDataCollectionEnabled=t.automaticDataCollectionEnabled,this._container=s,this.container.addComponent(new bt("app",()=>this,"PUBLIC"))}get automaticDataCollectionEnabled(){return this.checkDestroyed(),this._automaticDataCollectionEnabled}set automaticDataCollectionEnabled(e){this.checkDestroyed(),this._automaticDataCollectionEnabled=e}get name(){return this.checkDestroyed(),this._name}get options(){return this.checkDestroyed(),this._options}get config(){return this.checkDestroyed(),this._config}get container(){return this._container}get isDeleted(){return this._isDeleted}set isDeleted(e){this._isDeleted=e}checkDestroyed(){if(this.isDeleted)throw Ie.create("app-deleted",{appName:this._name})}}const Tc=Ec;function cr(n,e={}){let t=n;typeof e!="object"&&(e={name:e});const s={name:zn,automaticDataCollectionEnabled:!0,...e},i=s.name;if(typeof i!="string"||!i)throw Ie.create("bad-app-name",{appName:String(i)});if(t||(t=nr()),!t)throw Ie.create("no-options");const r=jt.get(i);if(r){if(zt(t,r.options)&&zt(s,r.config))return r;throw Ie.create("duplicate-app",{appName:i})}const o=new Ol(i);for(const l of jn.values())o.addComponent(l);const a=new Ic(t,s,o);return jt.set(i,a),a}function Nc(n=zn){const e=jt.get(n);if(!e&&n===zn&&nr())return cr();if(!e)throw Ie.create("no-app",{appName:n});return e}function je(n,e,t){let s=Cc[n]??n;t&&(s+=`-${t}`);const i=s.match(/\s|\//),r=e.match(/\s|\//);if(i||r){const o=[`Unable to register library "${s}" with version "${e}":`];i&&o.push(`library name "${s}" contains illegal characters (whitespace or "/")`),i&&r&&o.push("and"),r&&o.push(`version name "${e}" contains illegal characters (whitespace or "/")`),ye.warn(o.join(" "));return}qt(new bt(`${s}-version`,()=>({library:s,version:e}),"VERSION"))}const Rc="firebase-heartbeat-database",Oc=1,wt="firebase-heartbeat-store";let Dn=null;function dr(){return Dn||(Dn=Hl(Rc,Oc,{upgrade:(n,e)=>{switch(e){case 0:try{n.createObjectStore(wt)}catch(t){console.warn(t)}}}}).catch(n=>{throw Ie.create("idb-open",{originalErrorMessage:n.message})})),Dn}async function Ac(n){try{const t=(await dr()).transaction(wt),s=await t.objectStore(wt).get(ur(n));return await t.done,s}catch(e){if(e instanceof Lt)ye.warn(e.message);else{const t=Ie.create("idb-get",{originalErrorMessage:e?.message});ye.warn(t.message)}}}async function si(n,e){try{const s=(await dr()).transaction(wt,"readwrite");await s.objectStore(wt).put(e,ur(n)),await s.done}catch(t){if(t instanceof Lt)ye.warn(t.message);else{const s=Ie.create("idb-set",{originalErrorMessage:t?.message});ye.warn(s.message)}}}function ur(n){return`${n.name}!${n.options.appId}`}const kc=1024,Dc=30;class Lc{constructor(e){this.container=e,this._heartbeatsCache=null;const t=this.container.getProvider("app").getImmediate();this._storage=new xc(t),this._heartbeatsCachePromise=this._storage.read().then(s=>(this._heartbeatsCache=s,s))}async triggerHeartbeat(){try{const t=this.container.getProvider("platform-logger").getImmediate().getPlatformInfoString(),s=ii();if(this._heartbeatsCache?.heartbeats==null&&(this._heartbeatsCache=await this._heartbeatsCachePromise,this._heartbeatsCache?.heartbeats==null)||this._heartbeatsCache.lastSentHeartbeatDate===s||this._heartbeatsCache.heartbeats.some(i=>i.date===s))return;if(this._heartbeatsCache.heartbeats.push({date:s,agent:t}),this._heartbeatsCache.heartbeats.length>Dc){const i=Pc(this._heartbeatsCache.heartbeats);this._heartbeatsCache.heartbeats.splice(i,1)}return this._storage.overwrite(this._heartbeatsCache)}catch(e){ye.warn(e)}}async getHeartbeatsHeader(){try{if(this._heartbeatsCache===null&&await this._heartbeatsCachePromise,this._heartbeatsCache?.heartbeats==null||this._heartbeatsCache.heartbeats.length===0)return"";const e=ii(),{heartbeatsToSend:t,unsentEntries:s}=Mc(this._heartbeatsCache.heartbeats),i=Kt(JSON.stringify({version:2,heartbeats:t}));return this._heartbeatsCache.lastSentHeartbeatDate=e,s.length>0?(this._heartbeatsCache.heartbeats=s,await this._storage.overwrite(this._heartbeatsCache)):(this._heartbeatsCache.heartbeats=[],this._storage.overwrite(this._heartbeatsCache)),i}catch(e){return ye.warn(e),""}}}function ii(){return new Date().toISOString().substring(0,10)}function Mc(n,e=kc){const t=[];let s=n.slice();for(const i of n){const r=t.find(o=>o.agent===i.agent);if(r){if(r.dates.push(i.date),ri(t)>e){r.dates.pop();break}}else if(t.push({agent:i.agent,dates:[i.date]}),ri(t)>e){t.pop();break}s=s.slice(1)}return{heartbeatsToSend:t,unsentEntries:s}}class xc{constructor(e){this.app=e,this._canUseIndexedDBPromise=this.runIndexedDBEnvironmentCheck()}async runIndexedDBEnvironmentCheck(){return gl()?_l().then(()=>!0).catch(()=>!1):!1}async read(){if(await this._canUseIndexedDBPromise){const t=await Ac(this.app);return t?.heartbeats?t:{heartbeats:[]}}else return{heartbeats:[]}}async overwrite(e){if(await this._canUseIndexedDBPromise){const s=await this.read();return si(this.app,{lastSentHeartbeatDate:e.lastSentHeartbeatDate??s.lastSentHeartbeatDate,heartbeats:e.heartbeats})}else return}async add(e){if(await this._canUseIndexedDBPromise){const s=await this.read();return si(this.app,{lastSentHeartbeatDate:e.lastSentHeartbeatDate??s.lastSentHeartbeatDate,heartbeats:[...s.heartbeats,...e.heartbeats]})}else return}}function ri(n){return Kt(JSON.stringify({version:2,heartbeats:n})).length}function Pc(n){if(n.length===0)return-1;let e=0,t=n[0].date;for(let s=1;s<n.length;s++)n[s].date<t&&(t=n[s].date,e=s);return e}function Bc(n){qt(new bt("platform-logger",e=>new Kl(e),"PRIVATE")),qt(new bt("heartbeat",e=>new Lc(e),"PRIVATE")),je(Yn,ti,n),je(Yn,ti,"esm2020"),je("fire-js","")}Bc("");var Fc="firebase",Wc="12.8.0";je(Fc,Wc,"app");var oi={};const ai="@firebase/database",li="1.1.0";let hr="";function Gc(n){hr=n}class Uc{constructor(e){this.domStorage_=e,this.prefix_="firebase:"}set(e,t){t==null?this.domStorage_.removeItem(this.prefixedName_(e)):this.domStorage_.setItem(this.prefixedName_(e),H(t))}get(e){const t=this.domStorage_.getItem(this.prefixedName_(e));return t==null?null:St(t)}remove(e){this.domStorage_.removeItem(this.prefixedName_(e))}prefixedName_(e){return this.prefix_+e}toString(){return this.domStorage_.toString()}}class Hc{constructor(){this.cache_={},this.isInMemoryStorage=!0}set(e,t){t==null?delete this.cache_[e]:this.cache_[e]=t}get(e){return de(this.cache_,e)?this.cache_[e]:null}remove(e){delete this.cache_[e]}}const fr=function(n){try{if(typeof window<"u"&&typeof window[n]<"u"){const e=window[n];return e.setItem("firebase:sentinel","cache"),e.removeItem("firebase:sentinel"),new Uc(e)}}catch{}return new Hc},xe=fr("localStorage"),$c=fr("sessionStorage");const qe=new or("@firebase/database"),pr=(function(){let n=1;return function(){return n++}})(),mr=function(n){const e=Il(n),t=new wl;t.update(e);const s=t.digest();return us.encodeByteArray(s)},Mt=function(...n){let e="";for(let t=0;t<n.length;t++){const s=n[t];Array.isArray(s)||s&&typeof s=="object"&&typeof s.length=="number"?e+=Mt.apply(null,s):typeof s=="object"?e+=H(s):e+=s,e+=" "}return e};let _t=null,ci=!0;const Vc=function(n,e){g(!0,"Can't turn on custom loggers persistently."),qe.logLevel=M.VERBOSE,_t=qe.log.bind(qe)},K=function(...n){if(ci===!0&&(ci=!1,_t===null&&$c.get("logging_enabled")===!0&&Vc()),_t){const e=Mt.apply(null,n);_t(e)}},xt=function(n){return function(...e){K(n,...e)}},qn=function(...n){const e="FIREBASE INTERNAL ERROR: "+Mt(...n);qe.error(e)},Ee=function(...n){const e=`FIREBASE FATAL ERROR: ${Mt(...n)}`;throw qe.error(e),new Error(e)},X=function(...n){const e="FIREBASE WARNING: "+Mt(...n);qe.warn(e)},Kc=function(){typeof window<"u"&&window.location&&window.location.protocol&&window.location.protocol.indexOf("https:")!==-1&&X("Insecure Firebase access from a secure page. Please use https in calls to new Firebase().")},pn=function(n){return typeof n=="number"&&(n!==n||n===Number.POSITIVE_INFINITY||n===Number.NEGATIVE_INFINITY)},Yc=function(n){if(document.readyState==="complete")n();else{let e=!1;const t=function(){if(!document.body){setTimeout(t,Math.floor(10));return}e||(e=!0,n())};document.addEventListener?(document.addEventListener("DOMContentLoaded",t,!1),window.addEventListener("load",t,!1)):document.attachEvent&&(document.attachEvent("onreadystatechange",()=>{document.readyState==="complete"&&t()}),window.attachEvent("onload",t))}},Ze="[MIN_NAME]",Ge="[MAX_NAME]",$e=function(n,e){if(n===e)return 0;if(n===Ze||e===Ge)return-1;if(e===Ze||n===Ge)return 1;{const t=di(n),s=di(e);return t!==null?s!==null?t-s===0?n.length-e.length:t-s:-1:s!==null?1:n<e?-1:1}},zc=function(n,e){return n===e?0:n<e?-1:1},ut=function(n,e){if(e&&n in e)return e[n];throw new Error("Missing required key ("+n+") in object: "+H(e))},ps=function(n){if(typeof n!="object"||n===null)return H(n);const e=[];for(const s in n)e.push(s);e.sort();let t="{";for(let s=0;s<e.length;s++)s!==0&&(t+=","),t+=H(e[s]),t+=":",t+=ps(n[e[s]]);return t+="}",t},gr=function(n,e){const t=n.length;if(t<=e)return[n];const s=[];for(let i=0;i<t;i+=e)i+e>t?s.push(n.substring(i,t)):s.push(n.substring(i,i+e));return s};function Y(n,e){for(const t in n)n.hasOwnProperty(t)&&e(t,n[t])}const _r=function(n){g(!pn(n),"Invalid JSON number");const e=11,t=52,s=(1<<e-1)-1;let i,r,o,a,l;n===0?(r=0,o=0,i=1/n===-1/0?1:0):(i=n<0,n=Math.abs(n),n>=Math.pow(2,1-s)?(a=Math.min(Math.floor(Math.log(n)/Math.LN2),s),r=a+s,o=Math.round(n*Math.pow(2,t-a)-Math.pow(2,t))):(r=0,o=Math.round(n/Math.pow(2,1-s-t))));const c=[];for(l=t;l;l-=1)c.push(o%2?1:0),o=Math.floor(o/2);for(l=e;l;l-=1)c.push(r%2?1:0),r=Math.floor(r/2);c.push(i?1:0),c.reverse();const u=c.join("");let h="";for(l=0;l<64;l+=8){let d=parseInt(u.substr(l,8),2).toString(16);d.length===1&&(d="0"+d),h=h+d}return h.toLowerCase()},jc=function(){return!!(typeof window=="object"&&window.chrome&&window.chrome.extension&&!/^chrome/.test(window.location.href))},qc=function(){return typeof Windows=="object"&&typeof Windows.UI=="object"};function Qc(n,e){let t="Unknown Error";n==="too_big"?t="The data requested exceeds the maximum size that can be accessed with a single request.":n==="permission_denied"?t="Client doesn't have permission to access the desired data.":n==="unavailable"&&(t="The service is unavailable");const s=new Error(n+" at "+e._path.toString()+": "+t);return s.code=n.toUpperCase(),s}const Xc=new RegExp("^-?(0*)\\d{1,10}$"),Jc=-2147483648,Zc=2147483647,di=function(n){if(Xc.test(n)){const e=Number(n);if(e>=Jc&&e<=Zc)return e}return null},at=function(n){try{n()}catch(e){setTimeout(()=>{const t=e.stack||"";throw X("Exception was thrown by user callback.",t),e},Math.floor(0))}},ed=function(){return(typeof window=="object"&&window.navigator&&window.navigator.userAgent||"").search(/googlebot|google webmaster tools|bingbot|yahoo! slurp|baiduspider|yandexbot|duckduckbot/i)>=0},yt=function(n,e){const t=setTimeout(n,e);return typeof t=="number"&&typeof Deno<"u"&&Deno.unrefTimer?Deno.unrefTimer(t):typeof t=="object"&&t.unref&&t.unref(),t};class td{constructor(e,t){this.appCheckProvider=t,this.appName=e.name,bc(e)&&e.settings.appCheckToken&&(this.serverAppAppCheckToken=e.settings.appCheckToken),this.appCheck=t?.getImmediate({optional:!0}),this.appCheck||t?.get().then(s=>this.appCheck=s)}getToken(e){if(this.serverAppAppCheckToken){if(e)throw new Error("Attempted reuse of `FirebaseServerApp.appCheckToken` after previous usage failed.");return Promise.resolve({token:this.serverAppAppCheckToken})}return this.appCheck?this.appCheck.getToken(e):new Promise((t,s)=>{setTimeout(()=>{this.appCheck?this.getToken(e).then(t,s):t(null)},0)})}addTokenChangeListener(e){this.appCheckProvider?.get().then(t=>t.addTokenListener(e))}notifyForInvalidToken(){X(`Provided AppCheck credentials for the app named "${this.appName}" are invalid. This usually indicates your app was not initialized correctly.`)}}class nd{constructor(e,t,s){this.appName_=e,this.firebaseOptions_=t,this.authProvider_=s,this.auth_=null,this.auth_=s.getImmediate({optional:!0}),this.auth_||s.onInit(i=>this.auth_=i)}getToken(e){return this.auth_?this.auth_.getToken(e).catch(t=>t&&t.code==="auth/token-not-initialized"?(K("Got auth/token-not-initialized error.  Treating as null token."),null):Promise.reject(t)):new Promise((t,s)=>{setTimeout(()=>{this.auth_?this.getToken(e).then(t,s):t(null)},0)})}addTokenChangeListener(e){this.auth_?this.auth_.addAuthTokenListener(e):this.authProvider_.get().then(t=>t.addAuthTokenListener(e))}removeTokenChangeListener(e){this.authProvider_.get().then(t=>t.removeAuthTokenListener(e))}notifyForInvalidToken(){let e='Provided authentication credentials for the app named "'+this.appName_+'" are invalid. This usually indicates your app was not initialized correctly. ';"credential"in this.firebaseOptions_?e+='Make sure the "credential" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':"serviceAccount"in this.firebaseOptions_?e+='Make sure the "serviceAccount" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':e+='Make sure the "apiKey" and "databaseURL" properties provided to initializeApp() match the values provided for your app at https://console.firebase.google.com/.',X(e)}}class Vt{constructor(e){this.accessToken=e}getToken(e){return Promise.resolve({accessToken:this.accessToken})}addTokenChangeListener(e){e(this.accessToken)}removeTokenChangeListener(e){}notifyForInvalidToken(){}}Vt.OWNER="owner";const ms="5",yr="v",Er="s",Cr="r",vr="f",Sr=/(console\.firebase|firebase-console-\w+\.corp|firebase\.corp)\.google\.com/,br="ls",wr="p",Qn="ac",Ir="websocket",Tr="long_polling";class Nr{constructor(e,t,s,i,r=!1,o="",a=!1,l=!1,c=null){this.secure=t,this.namespace=s,this.webSocketOnly=i,this.nodeAdmin=r,this.persistenceKey=o,this.includeNamespaceInQueryParams=a,this.isUsingEmulator=l,this.emulatorOptions=c,this._host=e.toLowerCase(),this._domain=this._host.substr(this._host.indexOf(".")+1),this.internalHost=xe.get("host:"+e)||this._host}isCacheableHost(){return this.internalHost.substr(0,2)==="s-"}isCustomHost(){return this._domain!=="firebaseio.com"&&this._domain!=="firebaseio-demo.com"}get host(){return this._host}set host(e){e!==this.internalHost&&(this.internalHost=e,this.isCacheableHost()&&xe.set("host:"+this._host,this.internalHost))}toString(){let e=this.toURLString();return this.persistenceKey&&(e+="<"+this.persistenceKey+">"),e}toURLString(){const e=this.secure?"https://":"http://",t=this.includeNamespaceInQueryParams?`?ns=${this.namespace}`:"";return`${e}${this.host}/${t}`}}function sd(n){return n.host!==n.internalHost||n.isCustomHost()||n.includeNamespaceInQueryParams}function Rr(n,e,t){g(typeof e=="string","typeof type must == string"),g(typeof t=="object","typeof params must == object");let s;if(e===Ir)s=(n.secure?"wss://":"ws://")+n.internalHost+"/.ws?";else if(e===Tr)s=(n.secure?"https://":"http://")+n.internalHost+"/.lp?";else throw new Error("Unknown connection type: "+e);sd(n)&&(t.ns=n.namespace);const i=[];return Y(t,(r,o)=>{i.push(r+"="+o)}),s+i.join("&")}class id{constructor(){this.counters_={}}incrementCounter(e,t=1){de(this.counters_,e)||(this.counters_[e]=0),this.counters_[e]+=t}get(){return el(this.counters_)}}const Ln={},Mn={};function gs(n){const e=n.toString();return Ln[e]||(Ln[e]=new id),Ln[e]}function rd(n,e){const t=n.toString();return Mn[t]||(Mn[t]=e()),Mn[t]}class od{constructor(e){this.onMessage_=e,this.pendingResponses=[],this.currentResponseNum=0,this.closeAfterResponse=-1,this.onClose=null}closeAfter(e,t){this.closeAfterResponse=e,this.onClose=t,this.closeAfterResponse<this.currentResponseNum&&(this.onClose(),this.onClose=null)}handleResponse(e,t){for(this.pendingResponses[e]=t;this.pendingResponses[this.currentResponseNum];){const s=this.pendingResponses[this.currentResponseNum];delete this.pendingResponses[this.currentResponseNum];for(let i=0;i<s.length;++i)s[i]&&at(()=>{this.onMessage_(s[i])});if(this.currentResponseNum===this.closeAfterResponse){this.onClose&&(this.onClose(),this.onClose=null);break}this.currentResponseNum++}}}const ui="start",ad="close",ld="pLPCommand",cd="pRTLPCB",Or="id",Ar="pw",kr="ser",dd="cb",ud="seg",hd="ts",fd="d",pd="dframe",Dr=1870,Lr=30,md=Dr-Lr,gd=25e3,_d=3e4;class ze{constructor(e,t,s,i,r,o,a){this.connId=e,this.repoInfo=t,this.applicationId=s,this.appCheckToken=i,this.authToken=r,this.transportSessionId=o,this.lastSessionId=a,this.bytesSent=0,this.bytesReceived=0,this.everConnected_=!1,this.log_=xt(e),this.stats_=gs(t),this.urlFn=l=>(this.appCheckToken&&(l[Qn]=this.appCheckToken),Rr(t,Tr,l))}open(e,t){this.curSegmentNum=0,this.onDisconnect_=t,this.myPacketOrderer=new od(e),this.isClosed_=!1,this.connectTimeoutTimer_=setTimeout(()=>{this.log_("Timed out trying to connect."),this.onClosed_(),this.connectTimeoutTimer_=null},Math.floor(_d)),Yc(()=>{if(this.isClosed_)return;this.scriptTagHolder=new _s((...r)=>{const[o,a,l,c,u]=r;if(this.incrementIncomingBytes_(r),!!this.scriptTagHolder)if(this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null),this.everConnected_=!0,o===ui)this.id=a,this.password=l;else if(o===ad)a?(this.scriptTagHolder.sendNewPolls=!1,this.myPacketOrderer.closeAfter(a,()=>{this.onClosed_()})):this.onClosed_();else throw new Error("Unrecognized command received: "+o)},(...r)=>{const[o,a]=r;this.incrementIncomingBytes_(r),this.myPacketOrderer.handleResponse(o,a)},()=>{this.onClosed_()},this.urlFn);const s={};s[ui]="t",s[kr]=Math.floor(Math.random()*1e8),this.scriptTagHolder.uniqueCallbackIdentifier&&(s[dd]=this.scriptTagHolder.uniqueCallbackIdentifier),s[yr]=ms,this.transportSessionId&&(s[Er]=this.transportSessionId),this.lastSessionId&&(s[br]=this.lastSessionId),this.applicationId&&(s[wr]=this.applicationId),this.appCheckToken&&(s[Qn]=this.appCheckToken),typeof location<"u"&&location.hostname&&Sr.test(location.hostname)&&(s[Cr]=vr);const i=this.urlFn(s);this.log_("Connecting via long-poll to "+i),this.scriptTagHolder.addTag(i,()=>{})})}start(){this.scriptTagHolder.startLongPoll(this.id,this.password),this.addDisconnectPingFrame(this.id,this.password)}static forceAllow(){ze.forceAllow_=!0}static forceDisallow(){ze.forceDisallow_=!0}static isAvailable(){return ze.forceAllow_?!0:!ze.forceDisallow_&&typeof document<"u"&&document.createElement!=null&&!jc()&&!qc()}markConnectionHealthy(){}shutdown_(){this.isClosed_=!0,this.scriptTagHolder&&(this.scriptTagHolder.close(),this.scriptTagHolder=null),this.myDisconnFrame&&(document.body.removeChild(this.myDisconnFrame),this.myDisconnFrame=null),this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null)}onClosed_(){this.isClosed_||(this.log_("Longpoll is closing itself"),this.shutdown_(),this.onDisconnect_&&(this.onDisconnect_(this.everConnected_),this.onDisconnect_=null))}close(){this.isClosed_||(this.log_("Longpoll is being closed."),this.shutdown_())}send(e){const t=H(e);this.bytesSent+=t.length,this.stats_.incrementCounter("bytes_sent",t.length);const s=Zi(t),i=gr(s,md);for(let r=0;r<i.length;r++)this.scriptTagHolder.enqueueSegment(this.curSegmentNum,i.length,i[r]),this.curSegmentNum++}addDisconnectPingFrame(e,t){this.myDisconnFrame=document.createElement("iframe");const s={};s[pd]="t",s[Or]=e,s[Ar]=t,this.myDisconnFrame.src=this.urlFn(s),this.myDisconnFrame.style.display="none",document.body.appendChild(this.myDisconnFrame)}incrementIncomingBytes_(e){const t=H(e).length;this.bytesReceived+=t,this.stats_.incrementCounter("bytes_received",t)}}class _s{constructor(e,t,s,i){this.onDisconnect=s,this.urlFn=i,this.outstandingRequests=new Set,this.pendingSegs=[],this.currentSerial=Math.floor(Math.random()*1e8),this.sendNewPolls=!0;{this.uniqueCallbackIdentifier=pr(),window[ld+this.uniqueCallbackIdentifier]=e,window[cd+this.uniqueCallbackIdentifier]=t,this.myIFrame=_s.createIFrame_();let r="";this.myIFrame.src&&this.myIFrame.src.substr(0,11)==="javascript:"&&(r='<script>document.domain="'+document.domain+'";<\/script>');const o="<html><body>"+r+"</body></html>";try{this.myIFrame.doc.open(),this.myIFrame.doc.write(o),this.myIFrame.doc.close()}catch(a){K("frame writing exception"),a.stack&&K(a.stack),K(a)}}}static createIFrame_(){const e=document.createElement("iframe");if(e.style.display="none",document.body){document.body.appendChild(e);try{e.contentWindow.document||K("No IE domain setting required")}catch{const s=document.domain;e.src="javascript:void((function(){document.open();document.domain='"+s+"';document.close();})())"}}else throw"Document body has not initialized. Wait to initialize Firebase until after the document is ready.";return e.contentDocument?e.doc=e.contentDocument:e.contentWindow?e.doc=e.contentWindow.document:e.document&&(e.doc=e.document),e}close(){this.alive=!1,this.myIFrame&&(this.myIFrame.doc.body.textContent="",setTimeout(()=>{this.myIFrame!==null&&(document.body.removeChild(this.myIFrame),this.myIFrame=null)},Math.floor(0)));const e=this.onDisconnect;e&&(this.onDisconnect=null,e())}startLongPoll(e,t){for(this.myID=e,this.myPW=t,this.alive=!0;this.newRequest_(););}newRequest_(){if(this.alive&&this.sendNewPolls&&this.outstandingRequests.size<(this.pendingSegs.length>0?2:1)){this.currentSerial++;const e={};e[Or]=this.myID,e[Ar]=this.myPW,e[kr]=this.currentSerial;let t=this.urlFn(e),s="",i=0;for(;this.pendingSegs.length>0&&this.pendingSegs[0].d.length+Lr+s.length<=Dr;){const o=this.pendingSegs.shift();s=s+"&"+ud+i+"="+o.seg+"&"+hd+i+"="+o.ts+"&"+fd+i+"="+o.d,i++}return t=t+s,this.addLongPollTag_(t,this.currentSerial),!0}else return!1}enqueueSegment(e,t,s){this.pendingSegs.push({seg:e,ts:t,d:s}),this.alive&&this.newRequest_()}addLongPollTag_(e,t){this.outstandingRequests.add(t);const s=()=>{this.outstandingRequests.delete(t),this.newRequest_()},i=setTimeout(s,Math.floor(gd)),r=()=>{clearTimeout(i),s()};this.addTag(e,r)}addTag(e,t){setTimeout(()=>{try{if(!this.sendNewPolls)return;const s=this.myIFrame.doc.createElement("script");s.type="text/javascript",s.async=!0,s.src=e,s.onload=s.onreadystatechange=function(){const i=s.readyState;(!i||i==="loaded"||i==="complete")&&(s.onload=s.onreadystatechange=null,s.parentNode&&s.parentNode.removeChild(s),t())},s.onerror=()=>{K("Long-poll script failed to load: "+e),this.sendNewPolls=!1,this.close()},this.myIFrame.doc.body.appendChild(s)}catch{}},Math.floor(1))}}const yd=16384,Ed=45e3;let Qt=null;typeof MozWebSocket<"u"?Qt=MozWebSocket:typeof WebSocket<"u"&&(Qt=WebSocket);class oe{constructor(e,t,s,i,r,o,a){this.connId=e,this.applicationId=s,this.appCheckToken=i,this.authToken=r,this.keepaliveTimer=null,this.frames=null,this.totalFrames=0,this.bytesSent=0,this.bytesReceived=0,this.log_=xt(this.connId),this.stats_=gs(t),this.connURL=oe.connectionURL_(t,o,a,i,s),this.nodeAdmin=t.nodeAdmin}static connectionURL_(e,t,s,i,r){const o={};return o[yr]=ms,typeof location<"u"&&location.hostname&&Sr.test(location.hostname)&&(o[Cr]=vr),t&&(o[Er]=t),s&&(o[br]=s),i&&(o[Qn]=i),r&&(o[wr]=r),Rr(e,Ir,o)}open(e,t){this.onDisconnect=t,this.onMessage=e,this.log_("Websocket connecting to "+this.connURL),this.everConnected_=!1,xe.set("previous_websocket_failure",!0);try{let s;ml(),this.mySock=new Qt(this.connURL,[],s)}catch(s){this.log_("Error instantiating WebSocket.");const i=s.message||s.data;i&&this.log_(i),this.onClosed_();return}this.mySock.onopen=()=>{this.log_("Websocket connected."),this.everConnected_=!0},this.mySock.onclose=()=>{this.log_("Websocket connection was disconnected."),this.mySock=null,this.onClosed_()},this.mySock.onmessage=s=>{this.handleIncomingFrame(s)},this.mySock.onerror=s=>{this.log_("WebSocket error.  Closing connection.");const i=s.message||s.data;i&&this.log_(i),this.onClosed_()}}start(){}static forceDisallow(){oe.forceDisallow_=!0}static isAvailable(){let e=!1;if(typeof navigator<"u"&&navigator.userAgent){const t=/Android ([0-9]{0,}\.[0-9]{0,})/,s=navigator.userAgent.match(t);s&&s.length>1&&parseFloat(s[1])<4.4&&(e=!0)}return!e&&Qt!==null&&!oe.forceDisallow_}static previouslyFailed(){return xe.isInMemoryStorage||xe.get("previous_websocket_failure")===!0}markConnectionHealthy(){xe.remove("previous_websocket_failure")}appendFrame_(e){if(this.frames.push(e),this.frames.length===this.totalFrames){const t=this.frames.join("");this.frames=null;const s=St(t);this.onMessage(s)}}handleNewFrameCount_(e){this.totalFrames=e,this.frames=[]}extractFrameCount_(e){if(g(this.frames===null,"We already have a frame buffer"),e.length<=6){const t=Number(e);if(!isNaN(t))return this.handleNewFrameCount_(t),null}return this.handleNewFrameCount_(1),e}handleIncomingFrame(e){if(this.mySock===null)return;const t=e.data;if(this.bytesReceived+=t.length,this.stats_.incrementCounter("bytes_received",t.length),this.resetKeepAlive(),this.frames!==null)this.appendFrame_(t);else{const s=this.extractFrameCount_(t);s!==null&&this.appendFrame_(s)}}send(e){this.resetKeepAlive();const t=H(e);this.bytesSent+=t.length,this.stats_.incrementCounter("bytes_sent",t.length);const s=gr(t,yd);s.length>1&&this.sendString_(String(s.length));for(let i=0;i<s.length;i++)this.sendString_(s[i])}shutdown_(){this.isClosed_=!0,this.keepaliveTimer&&(clearInterval(this.keepaliveTimer),this.keepaliveTimer=null),this.mySock&&(this.mySock.close(),this.mySock=null)}onClosed_(){this.isClosed_||(this.log_("WebSocket is closing itself"),this.shutdown_(),this.onDisconnect&&(this.onDisconnect(this.everConnected_),this.onDisconnect=null))}close(){this.isClosed_||(this.log_("WebSocket is being closed"),this.shutdown_())}resetKeepAlive(){clearInterval(this.keepaliveTimer),this.keepaliveTimer=setInterval(()=>{this.mySock&&this.sendString_("0"),this.resetKeepAlive()},Math.floor(Ed))}sendString_(e){try{this.mySock.send(e)}catch(t){this.log_("Exception thrown from WebSocket.send():",t.message||t.data,"Closing connection."),setTimeout(this.onClosed_.bind(this),0)}}}oe.responsesRequiredToBeHealthy=2;oe.healthyTimeout=3e4;class It{static get ALL_TRANSPORTS(){return[ze,oe]}static get IS_TRANSPORT_INITIALIZED(){return this.globalTransportInitialized_}constructor(e){this.initTransports_(e)}initTransports_(e){const t=oe&&oe.isAvailable();let s=t&&!oe.previouslyFailed();if(e.webSocketOnly&&(t||X("wss:// URL used, but browser isn't known to support websockets.  Trying anyway."),s=!0),s)this.transports_=[oe];else{const i=this.transports_=[];for(const r of It.ALL_TRANSPORTS)r&&r.isAvailable()&&i.push(r);It.globalTransportInitialized_=!0}}initialTransport(){if(this.transports_.length>0)return this.transports_[0];throw new Error("No transports available")}upgradeTransport(){return this.transports_.length>1?this.transports_[1]:null}}It.globalTransportInitialized_=!1;const Cd=6e4,vd=5e3,Sd=10*1024,bd=100*1024,xn="t",hi="d",wd="s",fi="r",Id="e",pi="o",mi="a",gi="n",_i="p",Td="h";class Nd{constructor(e,t,s,i,r,o,a,l,c,u){this.id=e,this.repoInfo_=t,this.applicationId_=s,this.appCheckToken_=i,this.authToken_=r,this.onMessage_=o,this.onReady_=a,this.onDisconnect_=l,this.onKill_=c,this.lastSessionId=u,this.connectionCount=0,this.pendingDataMessages=[],this.state_=0,this.log_=xt("c:"+this.id+":"),this.transportManager_=new It(t),this.log_("Connection created"),this.start_()}start_(){const e=this.transportManager_.initialTransport();this.conn_=new e(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,null,this.lastSessionId),this.primaryResponsesRequired_=e.responsesRequiredToBeHealthy||0;const t=this.connReceiver_(this.conn_),s=this.disconnReceiver_(this.conn_);this.tx_=this.conn_,this.rx_=this.conn_,this.secondaryConn_=null,this.isHealthy_=!1,setTimeout(()=>{this.conn_&&this.conn_.open(t,s)},Math.floor(0));const i=e.healthyTimeout||0;i>0&&(this.healthyTimeout_=yt(()=>{this.healthyTimeout_=null,this.isHealthy_||(this.conn_&&this.conn_.bytesReceived>bd?(this.log_("Connection exceeded healthy timeout but has received "+this.conn_.bytesReceived+" bytes.  Marking connection healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()):this.conn_&&this.conn_.bytesSent>Sd?this.log_("Connection exceeded healthy timeout but has sent "+this.conn_.bytesSent+" bytes.  Leaving connection alive."):(this.log_("Closing unhealthy connection after timeout."),this.close()))},Math.floor(i)))}nextTransportId_(){return"c:"+this.id+":"+this.connectionCount++}disconnReceiver_(e){return t=>{e===this.conn_?this.onConnectionLost_(t):e===this.secondaryConn_?(this.log_("Secondary connection lost."),this.onSecondaryConnectionLost_()):this.log_("closing an old connection")}}connReceiver_(e){return t=>{this.state_!==2&&(e===this.rx_?this.onPrimaryMessageReceived_(t):e===this.secondaryConn_?this.onSecondaryMessageReceived_(t):this.log_("message on old connection"))}}sendRequest(e){const t={t:"d",d:e};this.sendData_(t)}tryCleanupConnection(){this.tx_===this.secondaryConn_&&this.rx_===this.secondaryConn_&&(this.log_("cleaning up and promoting a connection: "+this.secondaryConn_.connId),this.conn_=this.secondaryConn_,this.secondaryConn_=null)}onSecondaryControl_(e){if(xn in e){const t=e[xn];t===mi?this.upgradeIfSecondaryHealthy_():t===fi?(this.log_("Got a reset on secondary, closing it"),this.secondaryConn_.close(),(this.tx_===this.secondaryConn_||this.rx_===this.secondaryConn_)&&this.close()):t===pi&&(this.log_("got pong on secondary."),this.secondaryResponsesRequired_--,this.upgradeIfSecondaryHealthy_())}}onSecondaryMessageReceived_(e){const t=ut("t",e),s=ut("d",e);if(t==="c")this.onSecondaryControl_(s);else if(t==="d")this.pendingDataMessages.push(s);else throw new Error("Unknown protocol layer: "+t)}upgradeIfSecondaryHealthy_(){this.secondaryResponsesRequired_<=0?(this.log_("Secondary connection is healthy."),this.isHealthy_=!0,this.secondaryConn_.markConnectionHealthy(),this.proceedWithUpgrade_()):(this.log_("sending ping on secondary."),this.secondaryConn_.send({t:"c",d:{t:_i,d:{}}}))}proceedWithUpgrade_(){this.secondaryConn_.start(),this.log_("sending client ack on secondary"),this.secondaryConn_.send({t:"c",d:{t:mi,d:{}}}),this.log_("Ending transmission on primary"),this.conn_.send({t:"c",d:{t:gi,d:{}}}),this.tx_=this.secondaryConn_,this.tryCleanupConnection()}onPrimaryMessageReceived_(e){const t=ut("t",e),s=ut("d",e);t==="c"?this.onControl_(s):t==="d"&&this.onDataMessage_(s)}onDataMessage_(e){this.onPrimaryResponse_(),this.onMessage_(e)}onPrimaryResponse_(){this.isHealthy_||(this.primaryResponsesRequired_--,this.primaryResponsesRequired_<=0&&(this.log_("Primary connection is healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()))}onControl_(e){const t=ut(xn,e);if(hi in e){const s=e[hi];if(t===Td){const i={...s};this.repoInfo_.isUsingEmulator&&(i.h=this.repoInfo_.host),this.onHandshake_(i)}else if(t===gi){this.log_("recvd end transmission on primary"),this.rx_=this.secondaryConn_;for(let i=0;i<this.pendingDataMessages.length;++i)this.onDataMessage_(this.pendingDataMessages[i]);this.pendingDataMessages=[],this.tryCleanupConnection()}else t===wd?this.onConnectionShutdown_(s):t===fi?this.onReset_(s):t===Id?qn("Server Error: "+s):t===pi?(this.log_("got pong on primary."),this.onPrimaryResponse_(),this.sendPingOnPrimaryIfNecessary_()):qn("Unknown control packet command: "+t)}}onHandshake_(e){const t=e.ts,s=e.v,i=e.h;this.sessionId=e.s,this.repoInfo_.host=i,this.state_===0&&(this.conn_.start(),this.onConnectionEstablished_(this.conn_,t),ms!==s&&X("Protocol version mismatch detected"),this.tryStartUpgrade_())}tryStartUpgrade_(){const e=this.transportManager_.upgradeTransport();e&&this.startUpgrade_(e)}startUpgrade_(e){this.secondaryConn_=new e(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,this.sessionId),this.secondaryResponsesRequired_=e.responsesRequiredToBeHealthy||0;const t=this.connReceiver_(this.secondaryConn_),s=this.disconnReceiver_(this.secondaryConn_);this.secondaryConn_.open(t,s),yt(()=>{this.secondaryConn_&&(this.log_("Timed out trying to upgrade."),this.secondaryConn_.close())},Math.floor(Cd))}onReset_(e){this.log_("Reset packet received.  New host: "+e),this.repoInfo_.host=e,this.state_===1?this.close():(this.closeConnections_(),this.start_())}onConnectionEstablished_(e,t){this.log_("Realtime connection established."),this.conn_=e,this.state_=1,this.onReady_&&(this.onReady_(t,this.sessionId),this.onReady_=null),this.primaryResponsesRequired_===0?(this.log_("Primary connection is healthy."),this.isHealthy_=!0):yt(()=>{this.sendPingOnPrimaryIfNecessary_()},Math.floor(vd))}sendPingOnPrimaryIfNecessary_(){!this.isHealthy_&&this.state_===1&&(this.log_("sending ping on primary."),this.sendData_({t:"c",d:{t:_i,d:{}}}))}onSecondaryConnectionLost_(){const e=this.secondaryConn_;this.secondaryConn_=null,(this.tx_===e||this.rx_===e)&&this.close()}onConnectionLost_(e){this.conn_=null,!e&&this.state_===0?(this.log_("Realtime connection failed."),this.repoInfo_.isCacheableHost()&&(xe.remove("host:"+this.repoInfo_.host),this.repoInfo_.internalHost=this.repoInfo_.host)):this.state_===1&&this.log_("Realtime connection lost."),this.close()}onConnectionShutdown_(e){this.log_("Connection shutdown command received. Shutting down..."),this.onKill_&&(this.onKill_(e),this.onKill_=null),this.onDisconnect_=null,this.close()}sendData_(e){if(this.state_!==1)throw"Connection is not connected";this.tx_.send(e)}close(){this.state_!==2&&(this.log_("Closing realtime connection."),this.state_=2,this.closeConnections_(),this.onDisconnect_&&(this.onDisconnect_(),this.onDisconnect_=null))}closeConnections_(){this.log_("Shutting down all connections"),this.conn_&&(this.conn_.close(),this.conn_=null),this.secondaryConn_&&(this.secondaryConn_.close(),this.secondaryConn_=null),this.healthyTimeout_&&(clearTimeout(this.healthyTimeout_),this.healthyTimeout_=null)}}class Mr{put(e,t,s,i){}merge(e,t,s,i){}refreshAuthToken(e){}refreshAppCheckToken(e){}onDisconnectPut(e,t,s){}onDisconnectMerge(e,t,s){}onDisconnectCancel(e,t){}reportStats(e){}}class xr{constructor(e){this.allowedEvents_=e,this.listeners_={},g(Array.isArray(e)&&e.length>0,"Requires a non-empty array")}trigger(e,...t){if(Array.isArray(this.listeners_[e])){const s=[...this.listeners_[e]];for(let i=0;i<s.length;i++)s[i].callback.apply(s[i].context,t)}}on(e,t,s){this.validateEventType_(e),this.listeners_[e]=this.listeners_[e]||[],this.listeners_[e].push({callback:t,context:s});const i=this.getInitialEvent(e);i&&t.apply(s,i)}off(e,t,s){this.validateEventType_(e);const i=this.listeners_[e]||[];for(let r=0;r<i.length;r++)if(i[r].callback===t&&(!s||s===i[r].context)){i.splice(r,1);return}}validateEventType_(e){g(this.allowedEvents_.find(t=>t===e),"Unknown event: "+e)}}class Xt extends xr{static getInstance(){return new Xt}constructor(){super(["online"]),this.online_=!0,typeof window<"u"&&typeof window.addEventListener<"u"&&!sr()&&(window.addEventListener("online",()=>{this.online_||(this.online_=!0,this.trigger("online",!0))},!1),window.addEventListener("offline",()=>{this.online_&&(this.online_=!1,this.trigger("online",!1))},!1))}getInitialEvent(e){return g(e==="online","Unknown event type: "+e),[this.online_]}currentlyOnline(){return this.online_}}const yi=32,Ei=768;class O{constructor(e,t){if(t===void 0){this.pieces_=e.split("/");let s=0;for(let i=0;i<this.pieces_.length;i++)this.pieces_[i].length>0&&(this.pieces_[s]=this.pieces_[i],s++);this.pieces_.length=s,this.pieceNum_=0}else this.pieces_=e,this.pieceNum_=t}toString(){let e="";for(let t=this.pieceNum_;t<this.pieces_.length;t++)this.pieces_[t]!==""&&(e+="/"+this.pieces_[t]);return e||"/"}}function R(){return new O("")}function b(n){return n.pieceNum_>=n.pieces_.length?null:n.pieces_[n.pieceNum_]}function Re(n){return n.pieces_.length-n.pieceNum_}function D(n){let e=n.pieceNum_;return e<n.pieces_.length&&e++,new O(n.pieces_,e)}function ys(n){return n.pieceNum_<n.pieces_.length?n.pieces_[n.pieces_.length-1]:null}function Rd(n){let e="";for(let t=n.pieceNum_;t<n.pieces_.length;t++)n.pieces_[t]!==""&&(e+="/"+encodeURIComponent(String(n.pieces_[t])));return e||"/"}function Tt(n,e=0){return n.pieces_.slice(n.pieceNum_+e)}function Pr(n){if(n.pieceNum_>=n.pieces_.length)return null;const e=[];for(let t=n.pieceNum_;t<n.pieces_.length-1;t++)e.push(n.pieces_[t]);return new O(e,0)}function F(n,e){const t=[];for(let s=n.pieceNum_;s<n.pieces_.length;s++)t.push(n.pieces_[s]);if(e instanceof O)for(let s=e.pieceNum_;s<e.pieces_.length;s++)t.push(e.pieces_[s]);else{const s=e.split("/");for(let i=0;i<s.length;i++)s[i].length>0&&t.push(s[i])}return new O(t,0)}function w(n){return n.pieceNum_>=n.pieces_.length}function Q(n,e){const t=b(n),s=b(e);if(t===null)return e;if(t===s)return Q(D(n),D(e));throw new Error("INTERNAL ERROR: innerPath ("+e+") is not within outerPath ("+n+")")}function Od(n,e){const t=Tt(n,0),s=Tt(e,0);for(let i=0;i<t.length&&i<s.length;i++){const r=$e(t[i],s[i]);if(r!==0)return r}return t.length===s.length?0:t.length<s.length?-1:1}function Es(n,e){if(Re(n)!==Re(e))return!1;for(let t=n.pieceNum_,s=e.pieceNum_;t<=n.pieces_.length;t++,s++)if(n.pieces_[t]!==e.pieces_[s])return!1;return!0}function ie(n,e){let t=n.pieceNum_,s=e.pieceNum_;if(Re(n)>Re(e))return!1;for(;t<n.pieces_.length;){if(n.pieces_[t]!==e.pieces_[s])return!1;++t,++s}return!0}class Ad{constructor(e,t){this.errorPrefix_=t,this.parts_=Tt(e,0),this.byteLength_=Math.max(1,this.parts_.length);for(let s=0;s<this.parts_.length;s++)this.byteLength_+=fn(this.parts_[s]);Br(this)}}function kd(n,e){n.parts_.length>0&&(n.byteLength_+=1),n.parts_.push(e),n.byteLength_+=fn(e),Br(n)}function Dd(n){const e=n.parts_.pop();n.byteLength_-=fn(e),n.parts_.length>0&&(n.byteLength_-=1)}function Br(n){if(n.byteLength_>Ei)throw new Error(n.errorPrefix_+"has a key path longer than "+Ei+" bytes ("+n.byteLength_+").");if(n.parts_.length>yi)throw new Error(n.errorPrefix_+"path specified exceeds the maximum depth that can be written ("+yi+") or object contains a cycle "+Le(n))}function Le(n){return n.parts_.length===0?"":"in property '"+n.parts_.join(".")+"'"}class Cs extends xr{static getInstance(){return new Cs}constructor(){super(["visible"]);let e,t;typeof document<"u"&&typeof document.addEventListener<"u"&&(typeof document.hidden<"u"?(t="visibilitychange",e="hidden"):typeof document.mozHidden<"u"?(t="mozvisibilitychange",e="mozHidden"):typeof document.msHidden<"u"?(t="msvisibilitychange",e="msHidden"):typeof document.webkitHidden<"u"&&(t="webkitvisibilitychange",e="webkitHidden")),this.visible_=!0,t&&document.addEventListener(t,()=>{const s=!document[e];s!==this.visible_&&(this.visible_=s,this.trigger("visible",s))},!1)}getInitialEvent(e){return g(e==="visible","Unknown event type: "+e),[this.visible_]}}const ht=1e3,Ld=300*1e3,Ci=30*1e3,Md=1.3,xd=3e4,Pd="server_kill",vi=3;class ge extends Mr{constructor(e,t,s,i,r,o,a,l){if(super(),this.repoInfo_=e,this.applicationId_=t,this.onDataUpdate_=s,this.onConnectStatus_=i,this.onServerInfoUpdate_=r,this.authTokenProvider_=o,this.appCheckTokenProvider_=a,this.authOverride_=l,this.id=ge.nextPersistentConnectionId_++,this.log_=xt("p:"+this.id+":"),this.interruptReasons_={},this.listens=new Map,this.outstandingPuts_=[],this.outstandingGets_=[],this.outstandingPutCount_=0,this.outstandingGetCount_=0,this.onDisconnectRequestQueue_=[],this.connected_=!1,this.reconnectDelay_=ht,this.maxReconnectDelay_=Ld,this.securityDebugCallback_=null,this.lastSessionId=null,this.establishConnectionTimer_=null,this.visible_=!1,this.requestCBHash_={},this.requestNumber_=0,this.realtime_=null,this.authToken_=null,this.appCheckToken_=null,this.forceTokenRefresh_=!1,this.invalidAuthTokenCount_=0,this.invalidAppCheckTokenCount_=0,this.firstConnection_=!0,this.lastConnectionAttemptTime_=null,this.lastConnectionEstablishedTime_=null,l)throw new Error("Auth override specified in options, but not supported on non Node.js platforms");Cs.getInstance().on("visible",this.onVisible_,this),e.host.indexOf("fblocal")===-1&&Xt.getInstance().on("online",this.onOnline_,this)}sendRequest(e,t,s){const i=++this.requestNumber_,r={r:i,a:e,b:t};this.log_(H(r)),g(this.connected_,"sendRequest call when we're not connected not allowed."),this.realtime_.sendRequest(r),s&&(this.requestCBHash_[i]=s)}get(e){this.initConnection_();const t=new re,i={action:"g",request:{p:e._path.toString(),q:e._queryObject},onComplete:o=>{const a=o.d;o.s==="ok"?t.resolve(a):t.reject(a)}};this.outstandingGets_.push(i),this.outstandingGetCount_++;const r=this.outstandingGets_.length-1;return this.connected_&&this.sendGet_(r),t.promise}listen(e,t,s,i){this.initConnection_();const r=e._queryIdentifier,o=e._path.toString();this.log_("Listen called for "+o+" "+r),this.listens.has(o)||this.listens.set(o,new Map),g(e._queryParams.isDefault()||!e._queryParams.loadsAllData(),"listen() called for non-default but complete query"),g(!this.listens.get(o).has(r),"listen() called twice for same path/queryId.");const a={onComplete:i,hashFn:t,query:e,tag:s};this.listens.get(o).set(r,a),this.connected_&&this.sendListen_(a)}sendGet_(e){const t=this.outstandingGets_[e];this.sendRequest("g",t.request,s=>{delete this.outstandingGets_[e],this.outstandingGetCount_--,this.outstandingGetCount_===0&&(this.outstandingGets_=[]),t.onComplete&&t.onComplete(s)})}sendListen_(e){const t=e.query,s=t._path.toString(),i=t._queryIdentifier;this.log_("Listen on "+s+" for "+i);const r={p:s},o="q";e.tag&&(r.q=t._queryObject,r.t=e.tag),r.h=e.hashFn(),this.sendRequest(o,r,a=>{const l=a.d,c=a.s;ge.warnOnListenWarnings_(l,t),(this.listens.get(s)&&this.listens.get(s).get(i))===e&&(this.log_("listen response",a),c!=="ok"&&this.removeListen_(s,i),e.onComplete&&e.onComplete(c,l))})}static warnOnListenWarnings_(e,t){if(e&&typeof e=="object"&&de(e,"w")){const s=We(e,"w");if(Array.isArray(s)&&~s.indexOf("no_index")){const i='".indexOn": "'+t._queryParams.getIndex().toString()+'"',r=t._path.toString();X(`Using an unspecified index. Your data will be downloaded and filtered on the client. Consider adding ${i} at ${r} to your security rules for better performance.`)}}}refreshAuthToken(e){this.authToken_=e,this.log_("Auth token refreshed"),this.authToken_?this.tryAuth():this.connected_&&this.sendRequest("unauth",{},()=>{}),this.reduceReconnectDelayIfAdminCredential_(e)}reduceReconnectDelayIfAdminCredential_(e){(e&&e.length===40||Sl(e))&&(this.log_("Admin auth credential detected.  Reducing max reconnect time."),this.maxReconnectDelay_=Ci)}refreshAppCheckToken(e){this.appCheckToken_=e,this.log_("App check token refreshed"),this.appCheckToken_?this.tryAppCheck():this.connected_&&this.sendRequest("unappeck",{},()=>{})}tryAuth(){if(this.connected_&&this.authToken_){const e=this.authToken_,t=vl(e)?"auth":"gauth",s={cred:e};this.authOverride_===null?s.noauth=!0:typeof this.authOverride_=="object"&&(s.authvar=this.authOverride_),this.sendRequest(t,s,i=>{const r=i.s,o=i.d||"error";this.authToken_===e&&(r==="ok"?this.invalidAuthTokenCount_=0:this.onAuthRevoked_(r,o))})}}tryAppCheck(){this.connected_&&this.appCheckToken_&&this.sendRequest("appcheck",{token:this.appCheckToken_},e=>{const t=e.s,s=e.d||"error";t==="ok"?this.invalidAppCheckTokenCount_=0:this.onAppCheckRevoked_(t,s)})}unlisten(e,t){const s=e._path.toString(),i=e._queryIdentifier;this.log_("Unlisten called for "+s+" "+i),g(e._queryParams.isDefault()||!e._queryParams.loadsAllData(),"unlisten() called for non-default but complete query"),this.removeListen_(s,i)&&this.connected_&&this.sendUnlisten_(s,i,e._queryObject,t)}sendUnlisten_(e,t,s,i){this.log_("Unlisten on "+e+" for "+t);const r={p:e},o="n";i&&(r.q=s,r.t=i),this.sendRequest(o,r)}onDisconnectPut(e,t,s){this.initConnection_(),this.connected_?this.sendOnDisconnect_("o",e,t,s):this.onDisconnectRequestQueue_.push({pathString:e,action:"o",data:t,onComplete:s})}onDisconnectMerge(e,t,s){this.initConnection_(),this.connected_?this.sendOnDisconnect_("om",e,t,s):this.onDisconnectRequestQueue_.push({pathString:e,action:"om",data:t,onComplete:s})}onDisconnectCancel(e,t){this.initConnection_(),this.connected_?this.sendOnDisconnect_("oc",e,null,t):this.onDisconnectRequestQueue_.push({pathString:e,action:"oc",data:null,onComplete:t})}sendOnDisconnect_(e,t,s,i){const r={p:t,d:s};this.log_("onDisconnect "+e,r),this.sendRequest(e,r,o=>{i&&setTimeout(()=>{i(o.s,o.d)},Math.floor(0))})}put(e,t,s,i){this.putInternal("p",e,t,s,i)}merge(e,t,s,i){this.putInternal("m",e,t,s,i)}putInternal(e,t,s,i,r){this.initConnection_();const o={p:t,d:s};r!==void 0&&(o.h=r),this.outstandingPuts_.push({action:e,request:o,onComplete:i}),this.outstandingPutCount_++;const a=this.outstandingPuts_.length-1;this.connected_?this.sendPut_(a):this.log_("Buffering put: "+t)}sendPut_(e){const t=this.outstandingPuts_[e].action,s=this.outstandingPuts_[e].request,i=this.outstandingPuts_[e].onComplete;this.outstandingPuts_[e].queued=this.connected_,this.sendRequest(t,s,r=>{this.log_(t+" response",r),delete this.outstandingPuts_[e],this.outstandingPutCount_--,this.outstandingPutCount_===0&&(this.outstandingPuts_=[]),i&&i(r.s,r.d)})}reportStats(e){if(this.connected_){const t={c:e};this.log_("reportStats",t),this.sendRequest("s",t,s=>{if(s.s!=="ok"){const r=s.d;this.log_("reportStats","Error sending stats: "+r)}})}}onDataMessage_(e){if("r"in e){this.log_("from server: "+H(e));const t=e.r,s=this.requestCBHash_[t];s&&(delete this.requestCBHash_[t],s(e.b))}else{if("error"in e)throw"A server-side error has occurred: "+e.error;"a"in e&&this.onDataPush_(e.a,e.b)}}onDataPush_(e,t){this.log_("handleServerMessage",e,t),e==="d"?this.onDataUpdate_(t.p,t.d,!1,t.t):e==="m"?this.onDataUpdate_(t.p,t.d,!0,t.t):e==="c"?this.onListenRevoked_(t.p,t.q):e==="ac"?this.onAuthRevoked_(t.s,t.d):e==="apc"?this.onAppCheckRevoked_(t.s,t.d):e==="sd"?this.onSecurityDebugPacket_(t):qn("Unrecognized action received from server: "+H(e)+`
Are you using the latest client?`)}onReady_(e,t){this.log_("connection ready"),this.connected_=!0,this.lastConnectionEstablishedTime_=new Date().getTime(),this.handleTimestamp_(e),this.lastSessionId=t,this.firstConnection_&&this.sendConnectStats_(),this.restoreState_(),this.firstConnection_=!1,this.onConnectStatus_(!0)}scheduleConnect_(e){g(!this.realtime_,"Scheduling a connect when we're already connected/ing?"),this.establishConnectionTimer_&&clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=setTimeout(()=>{this.establishConnectionTimer_=null,this.establishConnection_()},Math.floor(e))}initConnection_(){!this.realtime_&&this.firstConnection_&&this.scheduleConnect_(0)}onVisible_(e){e&&!this.visible_&&this.reconnectDelay_===this.maxReconnectDelay_&&(this.log_("Window became visible.  Reducing delay."),this.reconnectDelay_=ht,this.realtime_||this.scheduleConnect_(0)),this.visible_=e}onOnline_(e){e?(this.log_("Browser went online."),this.reconnectDelay_=ht,this.realtime_||this.scheduleConnect_(0)):(this.log_("Browser went offline.  Killing connection."),this.realtime_&&this.realtime_.close())}onRealtimeDisconnect_(){if(this.log_("data client disconnected"),this.connected_=!1,this.realtime_=null,this.cancelSentTransactions_(),this.requestCBHash_={},this.shouldReconnect_()){this.visible_?this.lastConnectionEstablishedTime_&&(new Date().getTime()-this.lastConnectionEstablishedTime_>xd&&(this.reconnectDelay_=ht),this.lastConnectionEstablishedTime_=null):(this.log_("Window isn't visible.  Delaying reconnect."),this.reconnectDelay_=this.maxReconnectDelay_,this.lastConnectionAttemptTime_=new Date().getTime());const e=Math.max(0,new Date().getTime()-this.lastConnectionAttemptTime_);let t=Math.max(0,this.reconnectDelay_-e);t=Math.random()*t,this.log_("Trying to reconnect in "+t+"ms"),this.scheduleConnect_(t),this.reconnectDelay_=Math.min(this.maxReconnectDelay_,this.reconnectDelay_*Md)}this.onConnectStatus_(!1)}async establishConnection_(){if(this.shouldReconnect_()){this.log_("Making a connection attempt"),this.lastConnectionAttemptTime_=new Date().getTime(),this.lastConnectionEstablishedTime_=null;const e=this.onDataMessage_.bind(this),t=this.onReady_.bind(this),s=this.onRealtimeDisconnect_.bind(this),i=this.id+":"+ge.nextConnectionId_++,r=this.lastSessionId;let o=!1,a=null;const l=function(){a?a.close():(o=!0,s())},c=function(h){g(a,"sendRequest call when we're not connected not allowed."),a.sendRequest(h)};this.realtime_={close:l,sendRequest:c};const u=this.forceTokenRefresh_;this.forceTokenRefresh_=!1;try{const[h,d]=await Promise.all([this.authTokenProvider_.getToken(u),this.appCheckTokenProvider_.getToken(u)]);o?K("getToken() completed but was canceled"):(K("getToken() completed. Creating connection."),this.authToken_=h&&h.accessToken,this.appCheckToken_=d&&d.token,a=new Nd(i,this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,e,t,s,p=>{X(p+" ("+this.repoInfo_.toString()+")"),this.interrupt(Pd)},r))}catch(h){this.log_("Failed to get token: "+h),o||(this.repoInfo_.nodeAdmin&&X(h),l())}}}interrupt(e){K("Interrupting connection for reason: "+e),this.interruptReasons_[e]=!0,this.realtime_?this.realtime_.close():(this.establishConnectionTimer_&&(clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=null),this.connected_&&this.onRealtimeDisconnect_())}resume(e){K("Resuming connection for reason: "+e),delete this.interruptReasons_[e],$n(this.interruptReasons_)&&(this.reconnectDelay_=ht,this.realtime_||this.scheduleConnect_(0))}handleTimestamp_(e){const t=e-new Date().getTime();this.onServerInfoUpdate_({serverTimeOffset:t})}cancelSentTransactions_(){for(let e=0;e<this.outstandingPuts_.length;e++){const t=this.outstandingPuts_[e];t&&"h"in t.request&&t.queued&&(t.onComplete&&t.onComplete("disconnect"),delete this.outstandingPuts_[e],this.outstandingPutCount_--)}this.outstandingPutCount_===0&&(this.outstandingPuts_=[])}onListenRevoked_(e,t){let s;t?s=t.map(r=>ps(r)).join("$"):s="default";const i=this.removeListen_(e,s);i&&i.onComplete&&i.onComplete("permission_denied")}removeListen_(e,t){const s=new O(e).toString();let i;if(this.listens.has(s)){const r=this.listens.get(s);i=r.get(t),r.delete(t),r.size===0&&this.listens.delete(s)}else i=void 0;return i}onAuthRevoked_(e,t){K("Auth token revoked: "+e+"/"+t),this.authToken_=null,this.forceTokenRefresh_=!0,this.realtime_.close(),(e==="invalid_token"||e==="permission_denied")&&(this.invalidAuthTokenCount_++,this.invalidAuthTokenCount_>=vi&&(this.reconnectDelay_=Ci,this.authTokenProvider_.notifyForInvalidToken()))}onAppCheckRevoked_(e,t){K("App check token revoked: "+e+"/"+t),this.appCheckToken_=null,this.forceTokenRefresh_=!0,(e==="invalid_token"||e==="permission_denied")&&(this.invalidAppCheckTokenCount_++,this.invalidAppCheckTokenCount_>=vi&&this.appCheckTokenProvider_.notifyForInvalidToken())}onSecurityDebugPacket_(e){this.securityDebugCallback_?this.securityDebugCallback_(e):"msg"in e&&console.log("FIREBASE: "+e.msg.replace(`
`,`
FIREBASE: `))}restoreState_(){this.tryAuth(),this.tryAppCheck();for(const e of this.listens.values())for(const t of e.values())this.sendListen_(t);for(let e=0;e<this.outstandingPuts_.length;e++)this.outstandingPuts_[e]&&this.sendPut_(e);for(;this.onDisconnectRequestQueue_.length;){const e=this.onDisconnectRequestQueue_.shift();this.sendOnDisconnect_(e.action,e.pathString,e.data,e.onComplete)}for(let e=0;e<this.outstandingGets_.length;e++)this.outstandingGets_[e]&&this.sendGet_(e)}sendConnectStats_(){const e={};let t="js";e["sdk."+t+"."+hr.replace(/\./g,"-")]=1,sr()?e["framework.cordova"]=1:pl()&&(e["framework.reactnative"]=1),this.reportStats(e)}shouldReconnect_(){const e=Xt.getInstance().currentlyOnline();return $n(this.interruptReasons_)&&e}}ge.nextPersistentConnectionId_=0;ge.nextConnectionId_=0;class I{constructor(e,t){this.name=e,this.node=t}static Wrap(e,t){return new I(e,t)}}class mn{getCompare(){return this.compare.bind(this)}indexedValueChanged(e,t){const s=new I(Ze,e),i=new I(Ze,t);return this.compare(s,i)!==0}minPost(){return I.MIN}}let Ht;class Fr extends mn{static get __EMPTY_NODE(){return Ht}static set __EMPTY_NODE(e){Ht=e}compare(e,t){return $e(e.name,t.name)}isDefinedOn(e){throw ot("KeyIndex.isDefinedOn not expected to be called.")}indexedValueChanged(e,t){return!1}minPost(){return I.MIN}maxPost(){return new I(Ge,Ht)}makePost(e,t){return g(typeof e=="string","KeyIndex indexValue must always be a string."),new I(e,Ht)}toString(){return".key"}}const Qe=new Fr;class $t{constructor(e,t,s,i,r=null){this.isReverse_=i,this.resultGenerator_=r,this.nodeStack_=[];let o=1;for(;!e.isEmpty();)if(e=e,o=t?s(e.key,t):1,i&&(o*=-1),o<0)this.isReverse_?e=e.left:e=e.right;else if(o===0){this.nodeStack_.push(e);break}else this.nodeStack_.push(e),this.isReverse_?e=e.right:e=e.left}getNext(){if(this.nodeStack_.length===0)return null;let e=this.nodeStack_.pop(),t;if(this.resultGenerator_?t=this.resultGenerator_(e.key,e.value):t={key:e.key,value:e.value},this.isReverse_)for(e=e.left;!e.isEmpty();)this.nodeStack_.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack_.push(e),e=e.left;return t}hasNext(){return this.nodeStack_.length>0}peek(){if(this.nodeStack_.length===0)return null;const e=this.nodeStack_[this.nodeStack_.length-1];return this.resultGenerator_?this.resultGenerator_(e.key,e.value):{key:e.key,value:e.value}}}class V{constructor(e,t,s,i,r){this.key=e,this.value=t,this.color=s??V.RED,this.left=i??J.EMPTY_NODE,this.right=r??J.EMPTY_NODE}copy(e,t,s,i,r){return new V(e??this.key,t??this.value,s??this.color,i??this.left,r??this.right)}count(){return this.left.count()+1+this.right.count()}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||!!e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min_(){return this.left.isEmpty()?this:this.left.min_()}minKey(){return this.min_().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,s){let i=this;const r=s(e,i.key);return r<0?i=i.copy(null,null,null,i.left.insert(e,t,s),null):r===0?i=i.copy(null,t,null,null,null):i=i.copy(null,null,null,null,i.right.insert(e,t,s)),i.fixUp_()}removeMin_(){if(this.left.isEmpty())return J.EMPTY_NODE;let e=this;return!e.left.isRed_()&&!e.left.left.isRed_()&&(e=e.moveRedLeft_()),e=e.copy(null,null,null,e.left.removeMin_(),null),e.fixUp_()}remove(e,t){let s,i;if(s=this,t(e,s.key)<0)!s.left.isEmpty()&&!s.left.isRed_()&&!s.left.left.isRed_()&&(s=s.moveRedLeft_()),s=s.copy(null,null,null,s.left.remove(e,t),null);else{if(s.left.isRed_()&&(s=s.rotateRight_()),!s.right.isEmpty()&&!s.right.isRed_()&&!s.right.left.isRed_()&&(s=s.moveRedRight_()),t(e,s.key)===0){if(s.right.isEmpty())return J.EMPTY_NODE;i=s.right.min_(),s=s.copy(i.key,i.value,null,null,s.right.removeMin_())}s=s.copy(null,null,null,null,s.right.remove(e,t))}return s.fixUp_()}isRed_(){return this.color}fixUp_(){let e=this;return e.right.isRed_()&&!e.left.isRed_()&&(e=e.rotateLeft_()),e.left.isRed_()&&e.left.left.isRed_()&&(e=e.rotateRight_()),e.left.isRed_()&&e.right.isRed_()&&(e=e.colorFlip_()),e}moveRedLeft_(){let e=this.colorFlip_();return e.right.left.isRed_()&&(e=e.copy(null,null,null,null,e.right.rotateRight_()),e=e.rotateLeft_(),e=e.colorFlip_()),e}moveRedRight_(){let e=this.colorFlip_();return e.left.left.isRed_()&&(e=e.rotateRight_(),e=e.colorFlip_()),e}rotateLeft_(){const e=this.copy(null,null,V.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight_(){const e=this.copy(null,null,V.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip_(){const e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth_(){const e=this.check_();return Math.pow(2,e)<=this.count()+1}check_(){if(this.isRed_()&&this.left.isRed_())throw new Error("Red node has red child("+this.key+","+this.value+")");if(this.right.isRed_())throw new Error("Right child of ("+this.key+","+this.value+") is red");const e=this.left.check_();if(e!==this.right.check_())throw new Error("Black depths differ");return e+(this.isRed_()?0:1)}}V.RED=!0;V.BLACK=!1;class Bd{copy(e,t,s,i,r){return this}insert(e,t,s){return new V(e,t,null)}remove(e,t){return this}count(){return 0}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}check_(){return 0}isRed_(){return!1}}class J{constructor(e,t=J.EMPTY_NODE){this.comparator_=e,this.root_=t}insert(e,t){return new J(this.comparator_,this.root_.insert(e,t,this.comparator_).copy(null,null,V.BLACK,null,null))}remove(e){return new J(this.comparator_,this.root_.remove(e,this.comparator_).copy(null,null,V.BLACK,null,null))}get(e){let t,s=this.root_;for(;!s.isEmpty();){if(t=this.comparator_(e,s.key),t===0)return s.value;t<0?s=s.left:t>0&&(s=s.right)}return null}getPredecessorKey(e){let t,s=this.root_,i=null;for(;!s.isEmpty();)if(t=this.comparator_(e,s.key),t===0){if(s.left.isEmpty())return i?i.key:null;for(s=s.left;!s.right.isEmpty();)s=s.right;return s.key}else t<0?s=s.left:t>0&&(i=s,s=s.right);throw new Error("Attempted to find predecessor key for a nonexistent key.  What gives?")}isEmpty(){return this.root_.isEmpty()}count(){return this.root_.count()}minKey(){return this.root_.minKey()}maxKey(){return this.root_.maxKey()}inorderTraversal(e){return this.root_.inorderTraversal(e)}reverseTraversal(e){return this.root_.reverseTraversal(e)}getIterator(e){return new $t(this.root_,null,this.comparator_,!1,e)}getIteratorFrom(e,t){return new $t(this.root_,e,this.comparator_,!1,t)}getReverseIteratorFrom(e,t){return new $t(this.root_,e,this.comparator_,!0,t)}getReverseIterator(e){return new $t(this.root_,null,this.comparator_,!0,e)}}J.EMPTY_NODE=new Bd;function Fd(n,e){return $e(n.name,e.name)}function vs(n,e){return $e(n,e)}let Xn;function Wd(n){Xn=n}const Wr=function(n){return typeof n=="number"?"number:"+_r(n):"string:"+n},Gr=function(n){if(n.isLeafNode()){const e=n.val();g(typeof e=="string"||typeof e=="number"||typeof e=="object"&&de(e,".sv"),"Priority must be a string or number.")}else g(n===Xn||n.isEmpty(),"priority of unexpected type.");g(n===Xn||n.getPriority().isEmpty(),"Priority nodes can't have a priority of their own.")};let Si;class ${static set __childrenNodeConstructor(e){Si=e}static get __childrenNodeConstructor(){return Si}constructor(e,t=$.__childrenNodeConstructor.EMPTY_NODE){this.value_=e,this.priorityNode_=t,this.lazyHash_=null,g(this.value_!==void 0&&this.value_!==null,"LeafNode shouldn't be created with null/undefined value."),Gr(this.priorityNode_)}isLeafNode(){return!0}getPriority(){return this.priorityNode_}updatePriority(e){return new $(this.value_,e)}getImmediateChild(e){return e===".priority"?this.priorityNode_:$.__childrenNodeConstructor.EMPTY_NODE}getChild(e){return w(e)?this:b(e)===".priority"?this.priorityNode_:$.__childrenNodeConstructor.EMPTY_NODE}hasChild(){return!1}getPredecessorChildName(e,t){return null}updateImmediateChild(e,t){return e===".priority"?this.updatePriority(t):t.isEmpty()&&e!==".priority"?this:$.__childrenNodeConstructor.EMPTY_NODE.updateImmediateChild(e,t).updatePriority(this.priorityNode_)}updateChild(e,t){const s=b(e);return s===null?t:t.isEmpty()&&s!==".priority"?this:(g(s!==".priority"||Re(e)===1,".priority must be the last token in a path"),this.updateImmediateChild(s,$.__childrenNodeConstructor.EMPTY_NODE.updateChild(D(e),t)))}isEmpty(){return!1}numChildren(){return 0}forEachChild(e,t){return!1}val(e){return e&&!this.getPriority().isEmpty()?{".value":this.getValue(),".priority":this.getPriority().val()}:this.getValue()}hash(){if(this.lazyHash_===null){let e="";this.priorityNode_.isEmpty()||(e+="priority:"+Wr(this.priorityNode_.val())+":");const t=typeof this.value_;e+=t+":",t==="number"?e+=_r(this.value_):e+=this.value_,this.lazyHash_=mr(e)}return this.lazyHash_}getValue(){return this.value_}compareTo(e){return e===$.__childrenNodeConstructor.EMPTY_NODE?1:e instanceof $.__childrenNodeConstructor?-1:(g(e.isLeafNode(),"Unknown node type"),this.compareToLeafNode_(e))}compareToLeafNode_(e){const t=typeof e.value_,s=typeof this.value_,i=$.VALUE_TYPE_ORDER.indexOf(t),r=$.VALUE_TYPE_ORDER.indexOf(s);return g(i>=0,"Unknown leaf type: "+t),g(r>=0,"Unknown leaf type: "+s),i===r?s==="object"?0:this.value_<e.value_?-1:this.value_===e.value_?0:1:r-i}withIndex(){return this}isIndexed(){return!0}equals(e){if(e===this)return!0;if(e.isLeafNode()){const t=e;return this.value_===t.value_&&this.priorityNode_.equals(t.priorityNode_)}else return!1}}$.VALUE_TYPE_ORDER=["object","boolean","number","string"];let Ur,Hr;function Gd(n){Ur=n}function Ud(n){Hr=n}class Hd extends mn{compare(e,t){const s=e.node.getPriority(),i=t.node.getPriority(),r=s.compareTo(i);return r===0?$e(e.name,t.name):r}isDefinedOn(e){return!e.getPriority().isEmpty()}indexedValueChanged(e,t){return!e.getPriority().equals(t.getPriority())}minPost(){return I.MIN}maxPost(){return new I(Ge,new $("[PRIORITY-POST]",Hr))}makePost(e,t){const s=Ur(e);return new I(t,new $("[PRIORITY-POST]",s))}toString(){return".priority"}}const P=new Hd;const $d=Math.log(2);class Vd{constructor(e){const t=r=>parseInt(Math.log(r)/$d,10),s=r=>parseInt(Array(r+1).join("1"),2);this.count=t(e+1),this.current_=this.count-1;const i=s(this.count);this.bits_=e+1&i}nextBitIsOne(){const e=!(this.bits_&1<<this.current_);return this.current_--,e}}const Jt=function(n,e,t,s){n.sort(e);const i=function(l,c){const u=c-l;let h,d;if(u===0)return null;if(u===1)return h=n[l],d=t?t(h):h,new V(d,h.node,V.BLACK,null,null);{const p=parseInt(u/2,10)+l,m=i(l,p),_=i(p+1,c);return h=n[p],d=t?t(h):h,new V(d,h.node,V.BLACK,m,_)}},r=function(l){let c=null,u=null,h=n.length;const d=function(m,_){const E=h-m,k=h;h-=m;const A=i(E+1,k),x=n[E],S=t?t(x):x;p(new V(S,x.node,_,null,A))},p=function(m){c?(c.left=m,c=m):(u=m,c=m)};for(let m=0;m<l.count;++m){const _=l.nextBitIsOne(),E=Math.pow(2,l.count-(m+1));_?d(E,V.BLACK):(d(E,V.BLACK),d(E,V.RED))}return u},o=new Vd(n.length),a=r(o);return new J(s||e,a)};let Pn;const Ye={};class me{static get Default(){return g(Ye&&P,"ChildrenNode.ts has not been loaded"),Pn=Pn||new me({".priority":Ye},{".priority":P}),Pn}constructor(e,t){this.indexes_=e,this.indexSet_=t}get(e){const t=We(this.indexes_,e);if(!t)throw new Error("No index defined for "+e);return t instanceof J?t:null}hasIndex(e){return de(this.indexSet_,e.toString())}addIndex(e,t){g(e!==Qe,"KeyIndex always exists and isn't meant to be added to the IndexMap.");const s=[];let i=!1;const r=t.getIterator(I.Wrap);let o=r.getNext();for(;o;)i=i||e.isDefinedOn(o.node),s.push(o),o=r.getNext();let a;i?a=Jt(s,e.getCompare()):a=Ye;const l=e.toString(),c={...this.indexSet_};c[l]=e;const u={...this.indexes_};return u[l]=a,new me(u,c)}addToIndexes(e,t){const s=Yt(this.indexes_,(i,r)=>{const o=We(this.indexSet_,r);if(g(o,"Missing index implementation for "+r),i===Ye)if(o.isDefinedOn(e.node)){const a=[],l=t.getIterator(I.Wrap);let c=l.getNext();for(;c;)c.name!==e.name&&a.push(c),c=l.getNext();return a.push(e),Jt(a,o.getCompare())}else return Ye;else{const a=t.get(e.name);let l=i;return a&&(l=l.remove(new I(e.name,a))),l.insert(e,e.node)}});return new me(s,this.indexSet_)}removeFromIndexes(e,t){const s=Yt(this.indexes_,i=>{if(i===Ye)return i;{const r=t.get(e.name);return r?i.remove(new I(e.name,r)):i}});return new me(s,this.indexSet_)}}let ft;class v{static get EMPTY_NODE(){return ft||(ft=new v(new J(vs),null,me.Default))}constructor(e,t,s){this.children_=e,this.priorityNode_=t,this.indexMap_=s,this.lazyHash_=null,this.priorityNode_&&Gr(this.priorityNode_),this.children_.isEmpty()&&g(!this.priorityNode_||this.priorityNode_.isEmpty(),"An empty node cannot have a priority")}isLeafNode(){return!1}getPriority(){return this.priorityNode_||ft}updatePriority(e){return this.children_.isEmpty()?this:new v(this.children_,e,this.indexMap_)}getImmediateChild(e){if(e===".priority")return this.getPriority();{const t=this.children_.get(e);return t===null?ft:t}}getChild(e){const t=b(e);return t===null?this:this.getImmediateChild(t).getChild(D(e))}hasChild(e){return this.children_.get(e)!==null}updateImmediateChild(e,t){if(g(t,"We should always be passing snapshot nodes"),e===".priority")return this.updatePriority(t);{const s=new I(e,t);let i,r;t.isEmpty()?(i=this.children_.remove(e),r=this.indexMap_.removeFromIndexes(s,this.children_)):(i=this.children_.insert(e,t),r=this.indexMap_.addToIndexes(s,this.children_));const o=i.isEmpty()?ft:this.priorityNode_;return new v(i,o,r)}}updateChild(e,t){const s=b(e);if(s===null)return t;{g(b(e)!==".priority"||Re(e)===1,".priority must be the last token in a path");const i=this.getImmediateChild(s).updateChild(D(e),t);return this.updateImmediateChild(s,i)}}isEmpty(){return this.children_.isEmpty()}numChildren(){return this.children_.count()}val(e){if(this.isEmpty())return null;const t={};let s=0,i=0,r=!0;if(this.forEachChild(P,(o,a)=>{t[o]=a.val(e),s++,r&&v.INTEGER_REGEXP_.test(o)?i=Math.max(i,Number(o)):r=!1}),!e&&r&&i<2*s){const o=[];for(const a in t)o[a]=t[a];return o}else return e&&!this.getPriority().isEmpty()&&(t[".priority"]=this.getPriority().val()),t}hash(){if(this.lazyHash_===null){let e="";this.getPriority().isEmpty()||(e+="priority:"+Wr(this.getPriority().val())+":"),this.forEachChild(P,(t,s)=>{const i=s.hash();i!==""&&(e+=":"+t+":"+i)}),this.lazyHash_=e===""?"":mr(e)}return this.lazyHash_}getPredecessorChildName(e,t,s){const i=this.resolveIndex_(s);if(i){const r=i.getPredecessorKey(new I(e,t));return r?r.name:null}else return this.children_.getPredecessorKey(e)}getFirstChildName(e){const t=this.resolveIndex_(e);if(t){const s=t.minKey();return s&&s.name}else return this.children_.minKey()}getFirstChild(e){const t=this.getFirstChildName(e);return t?new I(t,this.children_.get(t)):null}getLastChildName(e){const t=this.resolveIndex_(e);if(t){const s=t.maxKey();return s&&s.name}else return this.children_.maxKey()}getLastChild(e){const t=this.getLastChildName(e);return t?new I(t,this.children_.get(t)):null}forEachChild(e,t){const s=this.resolveIndex_(e);return s?s.inorderTraversal(i=>t(i.name,i.node)):this.children_.inorderTraversal(t)}getIterator(e){return this.getIteratorFrom(e.minPost(),e)}getIteratorFrom(e,t){const s=this.resolveIndex_(t);if(s)return s.getIteratorFrom(e,i=>i);{const i=this.children_.getIteratorFrom(e.name,I.Wrap);let r=i.peek();for(;r!=null&&t.compare(r,e)<0;)i.getNext(),r=i.peek();return i}}getReverseIterator(e){return this.getReverseIteratorFrom(e.maxPost(),e)}getReverseIteratorFrom(e,t){const s=this.resolveIndex_(t);if(s)return s.getReverseIteratorFrom(e,i=>i);{const i=this.children_.getReverseIteratorFrom(e.name,I.Wrap);let r=i.peek();for(;r!=null&&t.compare(r,e)>0;)i.getNext(),r=i.peek();return i}}compareTo(e){return this.isEmpty()?e.isEmpty()?0:-1:e.isLeafNode()||e.isEmpty()?1:e===Pt?-1:0}withIndex(e){if(e===Qe||this.indexMap_.hasIndex(e))return this;{const t=this.indexMap_.addIndex(e,this.children_);return new v(this.children_,this.priorityNode_,t)}}isIndexed(e){return e===Qe||this.indexMap_.hasIndex(e)}equals(e){if(e===this)return!0;if(e.isLeafNode())return!1;{const t=e;if(this.getPriority().equals(t.getPriority()))if(this.children_.count()===t.children_.count()){const s=this.getIterator(P),i=t.getIterator(P);let r=s.getNext(),o=i.getNext();for(;r&&o;){if(r.name!==o.name||!r.node.equals(o.node))return!1;r=s.getNext(),o=i.getNext()}return r===null&&o===null}else return!1;else return!1}}resolveIndex_(e){return e===Qe?null:this.indexMap_.get(e.toString())}}v.INTEGER_REGEXP_=/^(0|[1-9]\d*)$/;class Kd extends v{constructor(){super(new J(vs),v.EMPTY_NODE,me.Default)}compareTo(e){return e===this?0:1}equals(e){return e===this}getPriority(){return this}getImmediateChild(e){return v.EMPTY_NODE}isEmpty(){return!1}}const Pt=new Kd;Object.defineProperties(I,{MIN:{value:new I(Ze,v.EMPTY_NODE)},MAX:{value:new I(Ge,Pt)}});Fr.__EMPTY_NODE=v.EMPTY_NODE;$.__childrenNodeConstructor=v;Wd(Pt);Ud(Pt);const Yd=!0;function B(n,e=null){if(n===null)return v.EMPTY_NODE;if(typeof n=="object"&&".priority"in n&&(e=n[".priority"]),g(e===null||typeof e=="string"||typeof e=="number"||typeof e=="object"&&".sv"in e,"Invalid priority type found: "+typeof e),typeof n=="object"&&".value"in n&&n[".value"]!==null&&(n=n[".value"]),typeof n!="object"||".sv"in n){const t=n;return new $(t,B(e))}if(!(n instanceof Array)&&Yd){const t=[];let s=!1;if(Y(n,(o,a)=>{if(o.substring(0,1)!=="."){const l=B(a);l.isEmpty()||(s=s||!l.getPriority().isEmpty(),t.push(new I(o,l)))}}),t.length===0)return v.EMPTY_NODE;const r=Jt(t,Fd,o=>o.name,vs);if(s){const o=Jt(t,P.getCompare());return new v(r,B(e),new me({".priority":o},{".priority":P}))}else return new v(r,B(e),me.Default)}else{let t=v.EMPTY_NODE;return Y(n,(s,i)=>{if(de(n,s)&&s.substring(0,1)!=="."){const r=B(i);(r.isLeafNode()||!r.isEmpty())&&(t=t.updateImmediateChild(s,r))}}),t.updatePriority(B(e))}}Gd(B);class zd extends mn{constructor(e){super(),this.indexPath_=e,g(!w(e)&&b(e)!==".priority","Can't create PathIndex with empty path or .priority key")}extractChild(e){return e.getChild(this.indexPath_)}isDefinedOn(e){return!e.getChild(this.indexPath_).isEmpty()}compare(e,t){const s=this.extractChild(e.node),i=this.extractChild(t.node),r=s.compareTo(i);return r===0?$e(e.name,t.name):r}makePost(e,t){const s=B(e),i=v.EMPTY_NODE.updateChild(this.indexPath_,s);return new I(t,i)}maxPost(){const e=v.EMPTY_NODE.updateChild(this.indexPath_,Pt);return new I(Ge,e)}toString(){return Tt(this.indexPath_,0).join("/")}}class jd extends mn{compare(e,t){const s=e.node.compareTo(t.node);return s===0?$e(e.name,t.name):s}isDefinedOn(e){return!0}indexedValueChanged(e,t){return!e.equals(t)}minPost(){return I.MIN}maxPost(){return I.MAX}makePost(e,t){const s=B(e);return new I(t,s)}toString(){return".value"}}const qd=new jd;function $r(n){return{type:"value",snapshotNode:n}}function et(n,e){return{type:"child_added",snapshotNode:e,childName:n}}function Nt(n,e){return{type:"child_removed",snapshotNode:e,childName:n}}function Rt(n,e,t){return{type:"child_changed",snapshotNode:e,childName:n,oldSnap:t}}function Qd(n,e){return{type:"child_moved",snapshotNode:e,childName:n}}class Ss{constructor(e){this.index_=e}updateChild(e,t,s,i,r,o){g(e.isIndexed(this.index_),"A node must be indexed if only a child is updated");const a=e.getImmediateChild(t);return a.getChild(i).equals(s.getChild(i))&&a.isEmpty()===s.isEmpty()||(o!=null&&(s.isEmpty()?e.hasChild(t)?o.trackChildChange(Nt(t,a)):g(e.isLeafNode(),"A child remove without an old child only makes sense on a leaf node"):a.isEmpty()?o.trackChildChange(et(t,s)):o.trackChildChange(Rt(t,s,a))),e.isLeafNode()&&s.isEmpty())?e:e.updateImmediateChild(t,s).withIndex(this.index_)}updateFullNode(e,t,s){return s!=null&&(e.isLeafNode()||e.forEachChild(P,(i,r)=>{t.hasChild(i)||s.trackChildChange(Nt(i,r))}),t.isLeafNode()||t.forEachChild(P,(i,r)=>{if(e.hasChild(i)){const o=e.getImmediateChild(i);o.equals(r)||s.trackChildChange(Rt(i,r,o))}else s.trackChildChange(et(i,r))})),t.withIndex(this.index_)}updatePriority(e,t){return e.isEmpty()?v.EMPTY_NODE:e.updatePriority(t)}filtersNodes(){return!1}getIndexedFilter(){return this}getIndex(){return this.index_}}class Ot{constructor(e){this.indexedFilter_=new Ss(e.getIndex()),this.index_=e.getIndex(),this.startPost_=Ot.getStartPost_(e),this.endPost_=Ot.getEndPost_(e),this.startIsInclusive_=!e.startAfterSet_,this.endIsInclusive_=!e.endBeforeSet_}getStartPost(){return this.startPost_}getEndPost(){return this.endPost_}matches(e){const t=this.startIsInclusive_?this.index_.compare(this.getStartPost(),e)<=0:this.index_.compare(this.getStartPost(),e)<0,s=this.endIsInclusive_?this.index_.compare(e,this.getEndPost())<=0:this.index_.compare(e,this.getEndPost())<0;return t&&s}updateChild(e,t,s,i,r,o){return this.matches(new I(t,s))||(s=v.EMPTY_NODE),this.indexedFilter_.updateChild(e,t,s,i,r,o)}updateFullNode(e,t,s){t.isLeafNode()&&(t=v.EMPTY_NODE);let i=t.withIndex(this.index_);i=i.updatePriority(v.EMPTY_NODE);const r=this;return t.forEachChild(P,(o,a)=>{r.matches(new I(o,a))||(i=i.updateImmediateChild(o,v.EMPTY_NODE))}),this.indexedFilter_.updateFullNode(e,i,s)}updatePriority(e,t){return e}filtersNodes(){return!0}getIndexedFilter(){return this.indexedFilter_}getIndex(){return this.index_}static getStartPost_(e){if(e.hasStart()){const t=e.getIndexStartName();return e.getIndex().makePost(e.getIndexStartValue(),t)}else return e.getIndex().minPost()}static getEndPost_(e){if(e.hasEnd()){const t=e.getIndexEndName();return e.getIndex().makePost(e.getIndexEndValue(),t)}else return e.getIndex().maxPost()}}class Xd{constructor(e){this.withinDirectionalStart=t=>this.reverse_?this.withinEndPost(t):this.withinStartPost(t),this.withinDirectionalEnd=t=>this.reverse_?this.withinStartPost(t):this.withinEndPost(t),this.withinStartPost=t=>{const s=this.index_.compare(this.rangedFilter_.getStartPost(),t);return this.startIsInclusive_?s<=0:s<0},this.withinEndPost=t=>{const s=this.index_.compare(t,this.rangedFilter_.getEndPost());return this.endIsInclusive_?s<=0:s<0},this.rangedFilter_=new Ot(e),this.index_=e.getIndex(),this.limit_=e.getLimit(),this.reverse_=!e.isViewFromLeft(),this.startIsInclusive_=!e.startAfterSet_,this.endIsInclusive_=!e.endBeforeSet_}updateChild(e,t,s,i,r,o){return this.rangedFilter_.matches(new I(t,s))||(s=v.EMPTY_NODE),e.getImmediateChild(t).equals(s)?e:e.numChildren()<this.limit_?this.rangedFilter_.getIndexedFilter().updateChild(e,t,s,i,r,o):this.fullLimitUpdateChild_(e,t,s,r,o)}updateFullNode(e,t,s){let i;if(t.isLeafNode()||t.isEmpty())i=v.EMPTY_NODE.withIndex(this.index_);else if(this.limit_*2<t.numChildren()&&t.isIndexed(this.index_)){i=v.EMPTY_NODE.withIndex(this.index_);let r;this.reverse_?r=t.getReverseIteratorFrom(this.rangedFilter_.getEndPost(),this.index_):r=t.getIteratorFrom(this.rangedFilter_.getStartPost(),this.index_);let o=0;for(;r.hasNext()&&o<this.limit_;){const a=r.getNext();if(this.withinDirectionalStart(a))if(this.withinDirectionalEnd(a))i=i.updateImmediateChild(a.name,a.node),o++;else break;else continue}}else{i=t.withIndex(this.index_),i=i.updatePriority(v.EMPTY_NODE);let r;this.reverse_?r=i.getReverseIterator(this.index_):r=i.getIterator(this.index_);let o=0;for(;r.hasNext();){const a=r.getNext();o<this.limit_&&this.withinDirectionalStart(a)&&this.withinDirectionalEnd(a)?o++:i=i.updateImmediateChild(a.name,v.EMPTY_NODE)}}return this.rangedFilter_.getIndexedFilter().updateFullNode(e,i,s)}updatePriority(e,t){return e}filtersNodes(){return!0}getIndexedFilter(){return this.rangedFilter_.getIndexedFilter()}getIndex(){return this.index_}fullLimitUpdateChild_(e,t,s,i,r){let o;if(this.reverse_){const h=this.index_.getCompare();o=(d,p)=>h(p,d)}else o=this.index_.getCompare();const a=e;g(a.numChildren()===this.limit_,"");const l=new I(t,s),c=this.reverse_?a.getFirstChild(this.index_):a.getLastChild(this.index_),u=this.rangedFilter_.matches(l);if(a.hasChild(t)){const h=a.getImmediateChild(t);let d=i.getChildAfterChild(this.index_,c,this.reverse_);for(;d!=null&&(d.name===t||a.hasChild(d.name));)d=i.getChildAfterChild(this.index_,d,this.reverse_);const p=d==null?1:o(d,l);if(u&&!s.isEmpty()&&p>=0)return r?.trackChildChange(Rt(t,s,h)),a.updateImmediateChild(t,s);{r?.trackChildChange(Nt(t,h));const _=a.updateImmediateChild(t,v.EMPTY_NODE);return d!=null&&this.rangedFilter_.matches(d)?(r?.trackChildChange(et(d.name,d.node)),_.updateImmediateChild(d.name,d.node)):_}}else return s.isEmpty()?e:u&&o(c,l)>=0?(r!=null&&(r.trackChildChange(Nt(c.name,c.node)),r.trackChildChange(et(t,s))),a.updateImmediateChild(t,s).updateImmediateChild(c.name,v.EMPTY_NODE)):e}}class bs{constructor(){this.limitSet_=!1,this.startSet_=!1,this.startNameSet_=!1,this.startAfterSet_=!1,this.endSet_=!1,this.endNameSet_=!1,this.endBeforeSet_=!1,this.limit_=0,this.viewFrom_="",this.indexStartValue_=null,this.indexStartName_="",this.indexEndValue_=null,this.indexEndName_="",this.index_=P}hasStart(){return this.startSet_}isViewFromLeft(){return this.viewFrom_===""?this.startSet_:this.viewFrom_==="l"}getIndexStartValue(){return g(this.startSet_,"Only valid if start has been set"),this.indexStartValue_}getIndexStartName(){return g(this.startSet_,"Only valid if start has been set"),this.startNameSet_?this.indexStartName_:Ze}hasEnd(){return this.endSet_}getIndexEndValue(){return g(this.endSet_,"Only valid if end has been set"),this.indexEndValue_}getIndexEndName(){return g(this.endSet_,"Only valid if end has been set"),this.endNameSet_?this.indexEndName_:Ge}hasLimit(){return this.limitSet_}hasAnchoredLimit(){return this.limitSet_&&this.viewFrom_!==""}getLimit(){return g(this.limitSet_,"Only valid if limit has been set"),this.limit_}getIndex(){return this.index_}loadsAllData(){return!(this.startSet_||this.endSet_||this.limitSet_)}isDefault(){return this.loadsAllData()&&this.index_===P}copy(){const e=new bs;return e.limitSet_=this.limitSet_,e.limit_=this.limit_,e.startSet_=this.startSet_,e.startAfterSet_=this.startAfterSet_,e.indexStartValue_=this.indexStartValue_,e.startNameSet_=this.startNameSet_,e.indexStartName_=this.indexStartName_,e.endSet_=this.endSet_,e.endBeforeSet_=this.endBeforeSet_,e.indexEndValue_=this.indexEndValue_,e.endNameSet_=this.endNameSet_,e.indexEndName_=this.indexEndName_,e.index_=this.index_,e.viewFrom_=this.viewFrom_,e}}function Jd(n){return n.loadsAllData()?new Ss(n.getIndex()):n.hasLimit()?new Xd(n):new Ot(n)}function bi(n){const e={};if(n.isDefault())return e;let t;if(n.index_===P?t="$priority":n.index_===qd?t="$value":n.index_===Qe?t="$key":(g(n.index_ instanceof zd,"Unrecognized index type!"),t=n.index_.toString()),e.orderBy=H(t),n.startSet_){const s=n.startAfterSet_?"startAfter":"startAt";e[s]=H(n.indexStartValue_),n.startNameSet_&&(e[s]+=","+H(n.indexStartName_))}if(n.endSet_){const s=n.endBeforeSet_?"endBefore":"endAt";e[s]=H(n.indexEndValue_),n.endNameSet_&&(e[s]+=","+H(n.indexEndName_))}return n.limitSet_&&(n.isViewFromLeft()?e.limitToFirst=n.limit_:e.limitToLast=n.limit_),e}function wi(n){const e={};if(n.startSet_&&(e.sp=n.indexStartValue_,n.startNameSet_&&(e.sn=n.indexStartName_),e.sin=!n.startAfterSet_),n.endSet_&&(e.ep=n.indexEndValue_,n.endNameSet_&&(e.en=n.indexEndName_),e.ein=!n.endBeforeSet_),n.limitSet_){e.l=n.limit_;let t=n.viewFrom_;t===""&&(n.isViewFromLeft()?t="l":t="r"),e.vf=t}return n.index_!==P&&(e.i=n.index_.toString()),e}class Zt extends Mr{reportStats(e){throw new Error("Method not implemented.")}static getListenId_(e,t){return t!==void 0?"tag$"+t:(g(e._queryParams.isDefault(),"should have a tag if it's not a default query."),e._path.toString())}constructor(e,t,s,i){super(),this.repoInfo_=e,this.onDataUpdate_=t,this.authTokenProvider_=s,this.appCheckTokenProvider_=i,this.log_=xt("p:rest:"),this.listens_={}}listen(e,t,s,i){const r=e._path.toString();this.log_("Listen called for "+r+" "+e._queryIdentifier);const o=Zt.getListenId_(e,s),a={};this.listens_[o]=a;const l=bi(e._queryParams);this.restRequest_(r+".json",l,(c,u)=>{let h=u;if(c===404&&(h=null,c=null),c===null&&this.onDataUpdate_(r,h,!1,s),We(this.listens_,o)===a){let d;c?c===401?d="permission_denied":d="rest_error:"+c:d="ok",i(d,null)}})}unlisten(e,t){const s=Zt.getListenId_(e,t);delete this.listens_[s]}get(e){const t=bi(e._queryParams),s=e._path.toString(),i=new re;return this.restRequest_(s+".json",t,(r,o)=>{let a=o;r===404&&(a=null,r=null),r===null?(this.onDataUpdate_(s,a,!1,null),i.resolve(a)):i.reject(new Error(a))}),i.promise}refreshAuthToken(e){}restRequest_(e,t={},s){return t.format="export",Promise.all([this.authTokenProvider_.getToken(!1),this.appCheckTokenProvider_.getToken(!1)]).then(([i,r])=>{i&&i.accessToken&&(t.auth=i.accessToken),r&&r.token&&(t.ac=r.token);const o=(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host+e+"?ns="+this.repoInfo_.namespace+bl(t);this.log_("Sending REST request for "+o);const a=new XMLHttpRequest;a.onreadystatechange=()=>{if(s&&a.readyState===4){this.log_("REST Response for "+o+" received. status:",a.status,"response:",a.responseText);let l=null;if(a.status>=200&&a.status<300){try{l=St(a.responseText)}catch{X("Failed to parse JSON response for "+o+": "+a.responseText)}s(null,l)}else a.status!==401&&a.status!==404&&X("Got unsuccessful REST response for "+o+" Status: "+a.status),s(a.status);s=null}},a.open("GET",o,!0),a.send()})}}class Zd{constructor(){this.rootNode_=v.EMPTY_NODE}getNode(e){return this.rootNode_.getChild(e)}updateSnapshot(e,t){this.rootNode_=this.rootNode_.updateChild(e,t)}}function en(){return{value:null,children:new Map}}function lt(n,e,t){if(w(e))n.value=t,n.children.clear();else if(n.value!==null)n.value=n.value.updateChild(e,t);else{const s=b(e);n.children.has(s)||n.children.set(s,en());const i=n.children.get(s);e=D(e),lt(i,e,t)}}function Jn(n,e){if(w(e))return n.value=null,n.children.clear(),!0;if(n.value!==null){if(n.value.isLeafNode())return!1;{const t=n.value;return n.value=null,t.forEachChild(P,(s,i)=>{lt(n,new O(s),i)}),Jn(n,e)}}else if(n.children.size>0){const t=b(e);return e=D(e),n.children.has(t)&&Jn(n.children.get(t),e)&&n.children.delete(t),n.children.size===0}else return!0}function Zn(n,e,t){n.value!==null?t(e,n.value):eu(n,(s,i)=>{const r=new O(e.toString()+"/"+s);Zn(i,r,t)})}function eu(n,e){n.children.forEach((t,s)=>{e(s,t)})}class tu{constructor(e){this.collection_=e,this.last_=null}get(){const e=this.collection_.get(),t={...e};return this.last_&&Y(this.last_,(s,i)=>{t[s]=t[s]-i}),this.last_=e,t}}const Ii=10*1e3,nu=30*1e3,su=300*1e3;class iu{constructor(e,t){this.server_=t,this.statsToReport_={},this.statsListener_=new tu(e);const s=Ii+(nu-Ii)*Math.random();yt(this.reportStats_.bind(this),Math.floor(s))}reportStats_(){const e=this.statsListener_.get(),t={};let s=!1;Y(e,(i,r)=>{r>0&&de(this.statsToReport_,i)&&(t[i]=r,s=!0)}),s&&this.server_.reportStats(t),yt(this.reportStats_.bind(this),Math.floor(Math.random()*2*su))}}var ae;(function(n){n[n.OVERWRITE=0]="OVERWRITE",n[n.MERGE=1]="MERGE",n[n.ACK_USER_WRITE=2]="ACK_USER_WRITE",n[n.LISTEN_COMPLETE=3]="LISTEN_COMPLETE"})(ae||(ae={}));function ws(){return{fromUser:!0,fromServer:!1,queryId:null,tagged:!1}}function Is(){return{fromUser:!1,fromServer:!0,queryId:null,tagged:!1}}function Ts(n){return{fromUser:!1,fromServer:!0,queryId:n,tagged:!0}}class tn{constructor(e,t,s){this.path=e,this.affectedTree=t,this.revert=s,this.type=ae.ACK_USER_WRITE,this.source=ws()}operationForChild(e){if(w(this.path)){if(this.affectedTree.value!=null)return g(this.affectedTree.children.isEmpty(),"affectedTree should not have overlapping affected paths."),this;{const t=this.affectedTree.subtree(new O(e));return new tn(R(),t,this.revert)}}else return g(b(this.path)===e,"operationForChild called for unrelated child."),new tn(D(this.path),this.affectedTree,this.revert)}}class At{constructor(e,t){this.source=e,this.path=t,this.type=ae.LISTEN_COMPLETE}operationForChild(e){return w(this.path)?new At(this.source,R()):new At(this.source,D(this.path))}}class Ue{constructor(e,t,s){this.source=e,this.path=t,this.snap=s,this.type=ae.OVERWRITE}operationForChild(e){return w(this.path)?new Ue(this.source,R(),this.snap.getImmediateChild(e)):new Ue(this.source,D(this.path),this.snap)}}class tt{constructor(e,t,s){this.source=e,this.path=t,this.children=s,this.type=ae.MERGE}operationForChild(e){if(w(this.path)){const t=this.children.subtree(new O(e));return t.isEmpty()?null:t.value?new Ue(this.source,R(),t.value):new tt(this.source,R(),t)}else return g(b(this.path)===e,"Can't get a merge for a child not on the path of the operation"),new tt(this.source,D(this.path),this.children)}toString(){return"Operation("+this.path+": "+this.source.toString()+" merge: "+this.children.toString()+")"}}class Oe{constructor(e,t,s){this.node_=e,this.fullyInitialized_=t,this.filtered_=s}isFullyInitialized(){return this.fullyInitialized_}isFiltered(){return this.filtered_}isCompleteForPath(e){if(w(e))return this.isFullyInitialized()&&!this.filtered_;const t=b(e);return this.isCompleteForChild(t)}isCompleteForChild(e){return this.isFullyInitialized()&&!this.filtered_||this.node_.hasChild(e)}getNode(){return this.node_}}class ru{constructor(e){this.query_=e,this.index_=this.query_._queryParams.getIndex()}}function ou(n,e,t,s){const i=[],r=[];return e.forEach(o=>{o.type==="child_changed"&&n.index_.indexedValueChanged(o.oldSnap,o.snapshotNode)&&r.push(Qd(o.childName,o.snapshotNode))}),pt(n,i,"child_removed",e,s,t),pt(n,i,"child_added",e,s,t),pt(n,i,"child_moved",r,s,t),pt(n,i,"child_changed",e,s,t),pt(n,i,"value",e,s,t),i}function pt(n,e,t,s,i,r){const o=s.filter(a=>a.type===t);o.sort((a,l)=>lu(n,a,l)),o.forEach(a=>{const l=au(n,a,r);i.forEach(c=>{c.respondsTo(a.type)&&e.push(c.createEvent(l,n.query_))})})}function au(n,e,t){return e.type==="value"||e.type==="child_removed"||(e.prevName=t.getPredecessorChildName(e.childName,e.snapshotNode,n.index_)),e}function lu(n,e,t){if(e.childName==null||t.childName==null)throw ot("Should only compare child_ events.");const s=new I(e.childName,e.snapshotNode),i=new I(t.childName,t.snapshotNode);return n.index_.compare(s,i)}function gn(n,e){return{eventCache:n,serverCache:e}}function Et(n,e,t,s){return gn(new Oe(e,t,s),n.serverCache)}function Vr(n,e,t,s){return gn(n.eventCache,new Oe(e,t,s))}function nn(n){return n.eventCache.isFullyInitialized()?n.eventCache.getNode():null}function He(n){return n.serverCache.isFullyInitialized()?n.serverCache.getNode():null}let Bn;const cu=()=>(Bn||(Bn=new J(zc)),Bn);class L{static fromObject(e){let t=new L(null);return Y(e,(s,i)=>{t=t.set(new O(s),i)}),t}constructor(e,t=cu()){this.value=e,this.children=t}isEmpty(){return this.value===null&&this.children.isEmpty()}findRootMostMatchingPathAndValue(e,t){if(this.value!=null&&t(this.value))return{path:R(),value:this.value};if(w(e))return null;{const s=b(e),i=this.children.get(s);if(i!==null){const r=i.findRootMostMatchingPathAndValue(D(e),t);return r!=null?{path:F(new O(s),r.path),value:r.value}:null}else return null}}findRootMostValueAndPath(e){return this.findRootMostMatchingPathAndValue(e,()=>!0)}subtree(e){if(w(e))return this;{const t=b(e),s=this.children.get(t);return s!==null?s.subtree(D(e)):new L(null)}}set(e,t){if(w(e))return new L(t,this.children);{const s=b(e),r=(this.children.get(s)||new L(null)).set(D(e),t),o=this.children.insert(s,r);return new L(this.value,o)}}remove(e){if(w(e))return this.children.isEmpty()?new L(null):new L(null,this.children);{const t=b(e),s=this.children.get(t);if(s){const i=s.remove(D(e));let r;return i.isEmpty()?r=this.children.remove(t):r=this.children.insert(t,i),this.value===null&&r.isEmpty()?new L(null):new L(this.value,r)}else return this}}get(e){if(w(e))return this.value;{const t=b(e),s=this.children.get(t);return s?s.get(D(e)):null}}setTree(e,t){if(w(e))return t;{const s=b(e),r=(this.children.get(s)||new L(null)).setTree(D(e),t);let o;return r.isEmpty()?o=this.children.remove(s):o=this.children.insert(s,r),new L(this.value,o)}}fold(e){return this.fold_(R(),e)}fold_(e,t){const s={};return this.children.inorderTraversal((i,r)=>{s[i]=r.fold_(F(e,i),t)}),t(e,this.value,s)}findOnPath(e,t){return this.findOnPath_(e,R(),t)}findOnPath_(e,t,s){const i=this.value?s(t,this.value):!1;if(i)return i;if(w(e))return null;{const r=b(e),o=this.children.get(r);return o?o.findOnPath_(D(e),F(t,r),s):null}}foreachOnPath(e,t){return this.foreachOnPath_(e,R(),t)}foreachOnPath_(e,t,s){if(w(e))return this;{this.value&&s(t,this.value);const i=b(e),r=this.children.get(i);return r?r.foreachOnPath_(D(e),F(t,i),s):new L(null)}}foreach(e){this.foreach_(R(),e)}foreach_(e,t){this.children.inorderTraversal((s,i)=>{i.foreach_(F(e,s),t)}),this.value&&t(e,this.value)}foreachChild(e){this.children.inorderTraversal((t,s)=>{s.value&&e(t,s.value)})}}class ce{constructor(e){this.writeTree_=e}static empty(){return new ce(new L(null))}}function Ct(n,e,t){if(w(e))return new ce(new L(t));{const s=n.writeTree_.findRootMostValueAndPath(e);if(s!=null){const i=s.path;let r=s.value;const o=Q(i,e);return r=r.updateChild(o,t),new ce(n.writeTree_.set(i,r))}else{const i=new L(t),r=n.writeTree_.setTree(e,i);return new ce(r)}}}function es(n,e,t){let s=n;return Y(t,(i,r)=>{s=Ct(s,F(e,i),r)}),s}function Ti(n,e){if(w(e))return ce.empty();{const t=n.writeTree_.setTree(e,new L(null));return new ce(t)}}function ts(n,e){return Ve(n,e)!=null}function Ve(n,e){const t=n.writeTree_.findRootMostValueAndPath(e);return t!=null?n.writeTree_.get(t.path).getChild(Q(t.path,e)):null}function Ni(n){const e=[],t=n.writeTree_.value;return t!=null?t.isLeafNode()||t.forEachChild(P,(s,i)=>{e.push(new I(s,i))}):n.writeTree_.children.inorderTraversal((s,i)=>{i.value!=null&&e.push(new I(s,i.value))}),e}function Te(n,e){if(w(e))return n;{const t=Ve(n,e);return t!=null?new ce(new L(t)):new ce(n.writeTree_.subtree(e))}}function ns(n){return n.writeTree_.isEmpty()}function nt(n,e){return Kr(R(),n.writeTree_,e)}function Kr(n,e,t){if(e.value!=null)return t.updateChild(n,e.value);{let s=null;return e.children.inorderTraversal((i,r)=>{i===".priority"?(g(r.value!==null,"Priority writes must always be leaf nodes"),s=r.value):t=Kr(F(n,i),r,t)}),!t.getChild(n).isEmpty()&&s!==null&&(t=t.updateChild(F(n,".priority"),s)),t}}function _n(n,e){return qr(e,n)}function du(n,e,t,s,i){g(s>n.lastWriteId,"Stacking an older write on top of newer ones"),i===void 0&&(i=!0),n.allWrites.push({path:e,snap:t,writeId:s,visible:i}),i&&(n.visibleWrites=Ct(n.visibleWrites,e,t)),n.lastWriteId=s}function uu(n,e,t,s){g(s>n.lastWriteId,"Stacking an older merge on top of newer ones"),n.allWrites.push({path:e,children:t,writeId:s,visible:!0}),n.visibleWrites=es(n.visibleWrites,e,t),n.lastWriteId=s}function hu(n,e){for(let t=0;t<n.allWrites.length;t++){const s=n.allWrites[t];if(s.writeId===e)return s}return null}function fu(n,e){const t=n.allWrites.findIndex(a=>a.writeId===e);g(t>=0,"removeWrite called with nonexistent writeId.");const s=n.allWrites[t];n.allWrites.splice(t,1);let i=s.visible,r=!1,o=n.allWrites.length-1;for(;i&&o>=0;){const a=n.allWrites[o];a.visible&&(o>=t&&pu(a,s.path)?i=!1:ie(s.path,a.path)&&(r=!0)),o--}if(i){if(r)return mu(n),!0;if(s.snap)n.visibleWrites=Ti(n.visibleWrites,s.path);else{const a=s.children;Y(a,l=>{n.visibleWrites=Ti(n.visibleWrites,F(s.path,l))})}return!0}else return!1}function pu(n,e){if(n.snap)return ie(n.path,e);for(const t in n.children)if(n.children.hasOwnProperty(t)&&ie(F(n.path,t),e))return!0;return!1}function mu(n){n.visibleWrites=Yr(n.allWrites,gu,R()),n.allWrites.length>0?n.lastWriteId=n.allWrites[n.allWrites.length-1].writeId:n.lastWriteId=-1}function gu(n){return n.visible}function Yr(n,e,t){let s=ce.empty();for(let i=0;i<n.length;++i){const r=n[i];if(e(r)){const o=r.path;let a;if(r.snap)ie(t,o)?(a=Q(t,o),s=Ct(s,a,r.snap)):ie(o,t)&&(a=Q(o,t),s=Ct(s,R(),r.snap.getChild(a)));else if(r.children){if(ie(t,o))a=Q(t,o),s=es(s,a,r.children);else if(ie(o,t))if(a=Q(o,t),w(a))s=es(s,R(),r.children);else{const l=We(r.children,b(a));if(l){const c=l.getChild(D(a));s=Ct(s,R(),c)}}}else throw ot("WriteRecord should have .snap or .children")}}return s}function zr(n,e,t,s,i){if(!s&&!i){const r=Ve(n.visibleWrites,e);if(r!=null)return r;{const o=Te(n.visibleWrites,e);if(ns(o))return t;if(t==null&&!ts(o,R()))return null;{const a=t||v.EMPTY_NODE;return nt(o,a)}}}else{const r=Te(n.visibleWrites,e);if(!i&&ns(r))return t;if(!i&&t==null&&!ts(r,R()))return null;{const o=function(c){return(c.visible||i)&&(!s||!~s.indexOf(c.writeId))&&(ie(c.path,e)||ie(e,c.path))},a=Yr(n.allWrites,o,e),l=t||v.EMPTY_NODE;return nt(a,l)}}}function _u(n,e,t){let s=v.EMPTY_NODE;const i=Ve(n.visibleWrites,e);if(i)return i.isLeafNode()||i.forEachChild(P,(r,o)=>{s=s.updateImmediateChild(r,o)}),s;if(t){const r=Te(n.visibleWrites,e);return t.forEachChild(P,(o,a)=>{const l=nt(Te(r,new O(o)),a);s=s.updateImmediateChild(o,l)}),Ni(r).forEach(o=>{s=s.updateImmediateChild(o.name,o.node)}),s}else{const r=Te(n.visibleWrites,e);return Ni(r).forEach(o=>{s=s.updateImmediateChild(o.name,o.node)}),s}}function yu(n,e,t,s,i){g(s||i,"Either existingEventSnap or existingServerSnap must exist");const r=F(e,t);if(ts(n.visibleWrites,r))return null;{const o=Te(n.visibleWrites,r);return ns(o)?i.getChild(t):nt(o,i.getChild(t))}}function Eu(n,e,t,s){const i=F(e,t),r=Ve(n.visibleWrites,i);if(r!=null)return r;if(s.isCompleteForChild(t)){const o=Te(n.visibleWrites,i);return nt(o,s.getNode().getImmediateChild(t))}else return null}function Cu(n,e){return Ve(n.visibleWrites,e)}function vu(n,e,t,s,i,r,o){let a;const l=Te(n.visibleWrites,e),c=Ve(l,R());if(c!=null)a=c;else if(t!=null)a=nt(l,t);else return[];if(a=a.withIndex(o),!a.isEmpty()&&!a.isLeafNode()){const u=[],h=o.getCompare(),d=r?a.getReverseIteratorFrom(s,o):a.getIteratorFrom(s,o);let p=d.getNext();for(;p&&u.length<i;)h(p,s)!==0&&u.push(p),p=d.getNext();return u}else return[]}function Su(){return{visibleWrites:ce.empty(),allWrites:[],lastWriteId:-1}}function sn(n,e,t,s){return zr(n.writeTree,n.treePath,e,t,s)}function Ns(n,e){return _u(n.writeTree,n.treePath,e)}function Ri(n,e,t,s){return yu(n.writeTree,n.treePath,e,t,s)}function rn(n,e){return Cu(n.writeTree,F(n.treePath,e))}function bu(n,e,t,s,i,r){return vu(n.writeTree,n.treePath,e,t,s,i,r)}function Rs(n,e,t){return Eu(n.writeTree,n.treePath,e,t)}function jr(n,e){return qr(F(n.treePath,e),n.writeTree)}function qr(n,e){return{treePath:n,writeTree:e}}class wu{constructor(){this.changeMap=new Map}trackChildChange(e){const t=e.type,s=e.childName;g(t==="child_added"||t==="child_changed"||t==="child_removed","Only child changes supported for tracking"),g(s!==".priority","Only non-priority child changes can be tracked.");const i=this.changeMap.get(s);if(i){const r=i.type;if(t==="child_added"&&r==="child_removed")this.changeMap.set(s,Rt(s,e.snapshotNode,i.snapshotNode));else if(t==="child_removed"&&r==="child_added")this.changeMap.delete(s);else if(t==="child_removed"&&r==="child_changed")this.changeMap.set(s,Nt(s,i.oldSnap));else if(t==="child_changed"&&r==="child_added")this.changeMap.set(s,et(s,e.snapshotNode));else if(t==="child_changed"&&r==="child_changed")this.changeMap.set(s,Rt(s,e.snapshotNode,i.oldSnap));else throw ot("Illegal combination of changes: "+e+" occurred after "+i)}else this.changeMap.set(s,e)}getChanges(){return Array.from(this.changeMap.values())}}class Iu{getCompleteChild(e){return null}getChildAfterChild(e,t,s){return null}}const Qr=new Iu;class Os{constructor(e,t,s=null){this.writes_=e,this.viewCache_=t,this.optCompleteServerCache_=s}getCompleteChild(e){const t=this.viewCache_.eventCache;if(t.isCompleteForChild(e))return t.getNode().getImmediateChild(e);{const s=this.optCompleteServerCache_!=null?new Oe(this.optCompleteServerCache_,!0,!1):this.viewCache_.serverCache;return Rs(this.writes_,e,s)}}getChildAfterChild(e,t,s){const i=this.optCompleteServerCache_!=null?this.optCompleteServerCache_:He(this.viewCache_),r=bu(this.writes_,i,t,1,s,e);return r.length===0?null:r[0]}}function Tu(n){return{filter:n}}function Nu(n,e){g(e.eventCache.getNode().isIndexed(n.filter.getIndex()),"Event snap not indexed"),g(e.serverCache.getNode().isIndexed(n.filter.getIndex()),"Server snap not indexed")}function Ru(n,e,t,s,i){const r=new wu;let o,a;if(t.type===ae.OVERWRITE){const c=t;c.source.fromUser?o=ss(n,e,c.path,c.snap,s,i,r):(g(c.source.fromServer,"Unknown source."),a=c.source.tagged||e.serverCache.isFiltered()&&!w(c.path),o=on(n,e,c.path,c.snap,s,i,a,r))}else if(t.type===ae.MERGE){const c=t;c.source.fromUser?o=Au(n,e,c.path,c.children,s,i,r):(g(c.source.fromServer,"Unknown source."),a=c.source.tagged||e.serverCache.isFiltered(),o=is(n,e,c.path,c.children,s,i,a,r))}else if(t.type===ae.ACK_USER_WRITE){const c=t;c.revert?o=Lu(n,e,c.path,s,i,r):o=ku(n,e,c.path,c.affectedTree,s,i,r)}else if(t.type===ae.LISTEN_COMPLETE)o=Du(n,e,t.path,s,r);else throw ot("Unknown operation type: "+t.type);const l=r.getChanges();return Ou(e,o,l),{viewCache:o,changes:l}}function Ou(n,e,t){const s=e.eventCache;if(s.isFullyInitialized()){const i=s.getNode().isLeafNode()||s.getNode().isEmpty(),r=nn(n);(t.length>0||!n.eventCache.isFullyInitialized()||i&&!s.getNode().equals(r)||!s.getNode().getPriority().equals(r.getPriority()))&&t.push($r(nn(e)))}}function Xr(n,e,t,s,i,r){const o=e.eventCache;if(rn(s,t)!=null)return e;{let a,l;if(w(t))if(g(e.serverCache.isFullyInitialized(),"If change path is empty, we must have complete server data"),e.serverCache.isFiltered()){const c=He(e),u=c instanceof v?c:v.EMPTY_NODE,h=Ns(s,u);a=n.filter.updateFullNode(e.eventCache.getNode(),h,r)}else{const c=sn(s,He(e));a=n.filter.updateFullNode(e.eventCache.getNode(),c,r)}else{const c=b(t);if(c===".priority"){g(Re(t)===1,"Can't have a priority with additional path components");const u=o.getNode();l=e.serverCache.getNode();const h=Ri(s,t,u,l);h!=null?a=n.filter.updatePriority(u,h):a=o.getNode()}else{const u=D(t);let h;if(o.isCompleteForChild(c)){l=e.serverCache.getNode();const d=Ri(s,t,o.getNode(),l);d!=null?h=o.getNode().getImmediateChild(c).updateChild(u,d):h=o.getNode().getImmediateChild(c)}else h=Rs(s,c,e.serverCache);h!=null?a=n.filter.updateChild(o.getNode(),c,h,u,i,r):a=o.getNode()}}return Et(e,a,o.isFullyInitialized()||w(t),n.filter.filtersNodes())}}function on(n,e,t,s,i,r,o,a){const l=e.serverCache;let c;const u=o?n.filter:n.filter.getIndexedFilter();if(w(t))c=u.updateFullNode(l.getNode(),s,null);else if(u.filtersNodes()&&!l.isFiltered()){const p=l.getNode().updateChild(t,s);c=u.updateFullNode(l.getNode(),p,null)}else{const p=b(t);if(!l.isCompleteForPath(t)&&Re(t)>1)return e;const m=D(t),E=l.getNode().getImmediateChild(p).updateChild(m,s);p===".priority"?c=u.updatePriority(l.getNode(),E):c=u.updateChild(l.getNode(),p,E,m,Qr,null)}const h=Vr(e,c,l.isFullyInitialized()||w(t),u.filtersNodes()),d=new Os(i,h,r);return Xr(n,h,t,i,d,a)}function ss(n,e,t,s,i,r,o){const a=e.eventCache;let l,c;const u=new Os(i,e,r);if(w(t))c=n.filter.updateFullNode(e.eventCache.getNode(),s,o),l=Et(e,c,!0,n.filter.filtersNodes());else{const h=b(t);if(h===".priority")c=n.filter.updatePriority(e.eventCache.getNode(),s),l=Et(e,c,a.isFullyInitialized(),a.isFiltered());else{const d=D(t),p=a.getNode().getImmediateChild(h);let m;if(w(d))m=s;else{const _=u.getCompleteChild(h);_!=null?ys(d)===".priority"&&_.getChild(Pr(d)).isEmpty()?m=_:m=_.updateChild(d,s):m=v.EMPTY_NODE}if(p.equals(m))l=e;else{const _=n.filter.updateChild(a.getNode(),h,m,d,u,o);l=Et(e,_,a.isFullyInitialized(),n.filter.filtersNodes())}}}return l}function Oi(n,e){return n.eventCache.isCompleteForChild(e)}function Au(n,e,t,s,i,r,o){let a=e;return s.foreach((l,c)=>{const u=F(t,l);Oi(e,b(u))&&(a=ss(n,a,u,c,i,r,o))}),s.foreach((l,c)=>{const u=F(t,l);Oi(e,b(u))||(a=ss(n,a,u,c,i,r,o))}),a}function Ai(n,e,t){return t.foreach((s,i)=>{e=e.updateChild(s,i)}),e}function is(n,e,t,s,i,r,o,a){if(e.serverCache.getNode().isEmpty()&&!e.serverCache.isFullyInitialized())return e;let l=e,c;w(t)?c=s:c=new L(null).setTree(t,s);const u=e.serverCache.getNode();return c.children.inorderTraversal((h,d)=>{if(u.hasChild(h)){const p=e.serverCache.getNode().getImmediateChild(h),m=Ai(n,p,d);l=on(n,l,new O(h),m,i,r,o,a)}}),c.children.inorderTraversal((h,d)=>{const p=!e.serverCache.isCompleteForChild(h)&&d.value===null;if(!u.hasChild(h)&&!p){const m=e.serverCache.getNode().getImmediateChild(h),_=Ai(n,m,d);l=on(n,l,new O(h),_,i,r,o,a)}}),l}function ku(n,e,t,s,i,r,o){if(rn(i,t)!=null)return e;const a=e.serverCache.isFiltered(),l=e.serverCache;if(s.value!=null){if(w(t)&&l.isFullyInitialized()||l.isCompleteForPath(t))return on(n,e,t,l.getNode().getChild(t),i,r,a,o);if(w(t)){let c=new L(null);return l.getNode().forEachChild(Qe,(u,h)=>{c=c.set(new O(u),h)}),is(n,e,t,c,i,r,a,o)}else return e}else{let c=new L(null);return s.foreach((u,h)=>{const d=F(t,u);l.isCompleteForPath(d)&&(c=c.set(u,l.getNode().getChild(d)))}),is(n,e,t,c,i,r,a,o)}}function Du(n,e,t,s,i){const r=e.serverCache,o=Vr(e,r.getNode(),r.isFullyInitialized()||w(t),r.isFiltered());return Xr(n,o,t,s,Qr,i)}function Lu(n,e,t,s,i,r){let o;if(rn(s,t)!=null)return e;{const a=new Os(s,e,i),l=e.eventCache.getNode();let c;if(w(t)||b(t)===".priority"){let u;if(e.serverCache.isFullyInitialized())u=sn(s,He(e));else{const h=e.serverCache.getNode();g(h instanceof v,"serverChildren would be complete if leaf node"),u=Ns(s,h)}u=u,c=n.filter.updateFullNode(l,u,r)}else{const u=b(t);let h=Rs(s,u,e.serverCache);h==null&&e.serverCache.isCompleteForChild(u)&&(h=l.getImmediateChild(u)),h!=null?c=n.filter.updateChild(l,u,h,D(t),a,r):e.eventCache.getNode().hasChild(u)?c=n.filter.updateChild(l,u,v.EMPTY_NODE,D(t),a,r):c=l,c.isEmpty()&&e.serverCache.isFullyInitialized()&&(o=sn(s,He(e)),o.isLeafNode()&&(c=n.filter.updateFullNode(c,o,r)))}return o=e.serverCache.isFullyInitialized()||rn(s,R())!=null,Et(e,c,o,n.filter.filtersNodes())}}class Mu{constructor(e,t){this.query_=e,this.eventRegistrations_=[];const s=this.query_._queryParams,i=new Ss(s.getIndex()),r=Jd(s);this.processor_=Tu(r);const o=t.serverCache,a=t.eventCache,l=i.updateFullNode(v.EMPTY_NODE,o.getNode(),null),c=r.updateFullNode(v.EMPTY_NODE,a.getNode(),null),u=new Oe(l,o.isFullyInitialized(),i.filtersNodes()),h=new Oe(c,a.isFullyInitialized(),r.filtersNodes());this.viewCache_=gn(h,u),this.eventGenerator_=new ru(this.query_)}get query(){return this.query_}}function xu(n){return n.viewCache_.serverCache.getNode()}function Pu(n){return nn(n.viewCache_)}function Bu(n,e){const t=He(n.viewCache_);return t&&(n.query._queryParams.loadsAllData()||!w(e)&&!t.getImmediateChild(b(e)).isEmpty())?t.getChild(e):null}function ki(n){return n.eventRegistrations_.length===0}function Fu(n,e){n.eventRegistrations_.push(e)}function Di(n,e,t){const s=[];if(t){g(e==null,"A cancel should cancel all event registrations.");const i=n.query._path;n.eventRegistrations_.forEach(r=>{const o=r.createCancelEvent(t,i);o&&s.push(o)})}if(e){let i=[];for(let r=0;r<n.eventRegistrations_.length;++r){const o=n.eventRegistrations_[r];if(!o.matches(e))i.push(o);else if(e.hasAnyCallback()){i=i.concat(n.eventRegistrations_.slice(r+1));break}}n.eventRegistrations_=i}else n.eventRegistrations_=[];return s}function Li(n,e,t,s){e.type===ae.MERGE&&e.source.queryId!==null&&(g(He(n.viewCache_),"We should always have a full cache before handling merges"),g(nn(n.viewCache_),"Missing event cache, even though we have a server cache"));const i=n.viewCache_,r=Ru(n.processor_,i,e,t,s);return Nu(n.processor_,r.viewCache),g(r.viewCache.serverCache.isFullyInitialized()||!i.serverCache.isFullyInitialized(),"Once a server snap is complete, it should never go back"),n.viewCache_=r.viewCache,Jr(n,r.changes,r.viewCache.eventCache.getNode(),null)}function Wu(n,e){const t=n.viewCache_.eventCache,s=[];return t.getNode().isLeafNode()||t.getNode().forEachChild(P,(r,o)=>{s.push(et(r,o))}),t.isFullyInitialized()&&s.push($r(t.getNode())),Jr(n,s,t.getNode(),e)}function Jr(n,e,t,s){const i=s?[s]:n.eventRegistrations_;return ou(n.eventGenerator_,e,t,i)}let an;class Zr{constructor(){this.views=new Map}}function Gu(n){g(!an,"__referenceConstructor has already been defined"),an=n}function Uu(){return g(an,"Reference.ts has not been loaded"),an}function Hu(n){return n.views.size===0}function As(n,e,t,s){const i=e.source.queryId;if(i!==null){const r=n.views.get(i);return g(r!=null,"SyncTree gave us an op for an invalid query."),Li(r,e,t,s)}else{let r=[];for(const o of n.views.values())r=r.concat(Li(o,e,t,s));return r}}function eo(n,e,t,s,i){const r=e._queryIdentifier,o=n.views.get(r);if(!o){let a=sn(t,i?s:null),l=!1;a?l=!0:s instanceof v?(a=Ns(t,s),l=!1):(a=v.EMPTY_NODE,l=!1);const c=gn(new Oe(a,l,!1),new Oe(s,i,!1));return new Mu(e,c)}return o}function $u(n,e,t,s,i,r){const o=eo(n,e,s,i,r);return n.views.has(e._queryIdentifier)||n.views.set(e._queryIdentifier,o),Fu(o,t),Wu(o,t)}function Vu(n,e,t,s){const i=e._queryIdentifier,r=[];let o=[];const a=Ae(n);if(i==="default")for(const[l,c]of n.views.entries())o=o.concat(Di(c,t,s)),ki(c)&&(n.views.delete(l),c.query._queryParams.loadsAllData()||r.push(c.query));else{const l=n.views.get(i);l&&(o=o.concat(Di(l,t,s)),ki(l)&&(n.views.delete(i),l.query._queryParams.loadsAllData()||r.push(l.query)))}return a&&!Ae(n)&&r.push(new(Uu())(e._repo,e._path)),{removed:r,events:o}}function to(n){const e=[];for(const t of n.views.values())t.query._queryParams.loadsAllData()||e.push(t);return e}function Ne(n,e){let t=null;for(const s of n.views.values())t=t||Bu(s,e);return t}function no(n,e){if(e._queryParams.loadsAllData())return yn(n);{const s=e._queryIdentifier;return n.views.get(s)}}function so(n,e){return no(n,e)!=null}function Ae(n){return yn(n)!=null}function yn(n){for(const e of n.views.values())if(e.query._queryParams.loadsAllData())return e;return null}let ln;function Ku(n){g(!ln,"__referenceConstructor has already been defined"),ln=n}function Yu(){return g(ln,"Reference.ts has not been loaded"),ln}let zu=1;class Mi{constructor(e){this.listenProvider_=e,this.syncPointTree_=new L(null),this.pendingWriteTree_=Su(),this.tagToQueryMap=new Map,this.queryToTagMap=new Map}}function ks(n,e,t,s,i){return du(n.pendingWriteTree_,e,t,s,i),i?ct(n,new Ue(ws(),e,t)):[]}function ju(n,e,t,s){uu(n.pendingWriteTree_,e,t,s);const i=L.fromObject(t);return ct(n,new tt(ws(),e,i))}function Se(n,e,t=!1){const s=hu(n.pendingWriteTree_,e);if(fu(n.pendingWriteTree_,e)){let r=new L(null);return s.snap!=null?r=r.set(R(),!0):Y(s.children,o=>{r=r.set(new O(o),!0)}),ct(n,new tn(s.path,r,t))}else return[]}function Bt(n,e,t){return ct(n,new Ue(Is(),e,t))}function qu(n,e,t){const s=L.fromObject(t);return ct(n,new tt(Is(),e,s))}function Qu(n,e){return ct(n,new At(Is(),e))}function Xu(n,e,t){const s=Ds(n,t);if(s){const i=Ls(s),r=i.path,o=i.queryId,a=Q(r,e),l=new At(Ts(o),a);return Ms(n,r,l)}else return[]}function cn(n,e,t,s,i=!1){const r=e._path,o=n.syncPointTree_.get(r);let a=[];if(o&&(e._queryIdentifier==="default"||so(o,e))){const l=Vu(o,e,t,s);Hu(o)&&(n.syncPointTree_=n.syncPointTree_.remove(r));const c=l.removed;if(a=l.events,!i){const u=c.findIndex(d=>d._queryParams.loadsAllData())!==-1,h=n.syncPointTree_.findOnPath(r,(d,p)=>Ae(p));if(u&&!h){const d=n.syncPointTree_.subtree(r);if(!d.isEmpty()){const p=eh(d);for(let m=0;m<p.length;++m){const _=p[m],E=_.query,k=ao(n,_);n.listenProvider_.startListening(vt(E),kt(n,E),k.hashFn,k.onComplete)}}}!h&&c.length>0&&!s&&(u?n.listenProvider_.stopListening(vt(e),null):c.forEach(d=>{const p=n.queryToTagMap.get(Cn(d));n.listenProvider_.stopListening(vt(d),p)}))}th(n,c)}return a}function io(n,e,t,s){const i=Ds(n,s);if(i!=null){const r=Ls(i),o=r.path,a=r.queryId,l=Q(o,e),c=new Ue(Ts(a),l,t);return Ms(n,o,c)}else return[]}function Ju(n,e,t,s){const i=Ds(n,s);if(i){const r=Ls(i),o=r.path,a=r.queryId,l=Q(o,e),c=L.fromObject(t),u=new tt(Ts(a),l,c);return Ms(n,o,u)}else return[]}function rs(n,e,t,s=!1){const i=e._path;let r=null,o=!1;n.syncPointTree_.foreachOnPath(i,(d,p)=>{const m=Q(d,i);r=r||Ne(p,m),o=o||Ae(p)});let a=n.syncPointTree_.get(i);a?(o=o||Ae(a),r=r||Ne(a,R())):(a=new Zr,n.syncPointTree_=n.syncPointTree_.set(i,a));let l;r!=null?l=!0:(l=!1,r=v.EMPTY_NODE,n.syncPointTree_.subtree(i).foreachChild((p,m)=>{const _=Ne(m,R());_&&(r=r.updateImmediateChild(p,_))}));const c=so(a,e);if(!c&&!e._queryParams.loadsAllData()){const d=Cn(e);g(!n.queryToTagMap.has(d),"View does not exist, but we have a tag");const p=nh();n.queryToTagMap.set(d,p),n.tagToQueryMap.set(p,d)}const u=_n(n.pendingWriteTree_,i);let h=$u(a,e,t,u,r,l);if(!c&&!o&&!s){const d=no(a,e);h=h.concat(sh(n,e,d))}return h}function En(n,e,t){const i=n.pendingWriteTree_,r=n.syncPointTree_.findOnPath(e,(o,a)=>{const l=Q(o,e),c=Ne(a,l);if(c)return c});return zr(i,e,r,t,!0)}function Zu(n,e){const t=e._path;let s=null;n.syncPointTree_.foreachOnPath(t,(c,u)=>{const h=Q(c,t);s=s||Ne(u,h)});let i=n.syncPointTree_.get(t);i?s=s||Ne(i,R()):(i=new Zr,n.syncPointTree_=n.syncPointTree_.set(t,i));const r=s!=null,o=r?new Oe(s,!0,!1):null,a=_n(n.pendingWriteTree_,e._path),l=eo(i,e,a,r?o.getNode():v.EMPTY_NODE,r);return Pu(l)}function ct(n,e){return ro(e,n.syncPointTree_,null,_n(n.pendingWriteTree_,R()))}function ro(n,e,t,s){if(w(n.path))return oo(n,e,t,s);{const i=e.get(R());t==null&&i!=null&&(t=Ne(i,R()));let r=[];const o=b(n.path),a=n.operationForChild(o),l=e.children.get(o);if(l&&a){const c=t?t.getImmediateChild(o):null,u=jr(s,o);r=r.concat(ro(a,l,c,u))}return i&&(r=r.concat(As(i,n,s,t))),r}}function oo(n,e,t,s){const i=e.get(R());t==null&&i!=null&&(t=Ne(i,R()));let r=[];return e.children.inorderTraversal((o,a)=>{const l=t?t.getImmediateChild(o):null,c=jr(s,o),u=n.operationForChild(o);u&&(r=r.concat(oo(u,a,l,c)))}),i&&(r=r.concat(As(i,n,s,t))),r}function ao(n,e){const t=e.query,s=kt(n,t);return{hashFn:()=>(xu(e)||v.EMPTY_NODE).hash(),onComplete:i=>{if(i==="ok")return s?Xu(n,t._path,s):Qu(n,t._path);{const r=Qc(i,t);return cn(n,t,null,r)}}}}function kt(n,e){const t=Cn(e);return n.queryToTagMap.get(t)}function Cn(n){return n._path.toString()+"$"+n._queryIdentifier}function Ds(n,e){return n.tagToQueryMap.get(e)}function Ls(n){const e=n.indexOf("$");return g(e!==-1&&e<n.length-1,"Bad queryKey."),{queryId:n.substr(e+1),path:new O(n.substr(0,e))}}function Ms(n,e,t){const s=n.syncPointTree_.get(e);g(s,"Missing sync point for query tag that we're tracking");const i=_n(n.pendingWriteTree_,e);return As(s,t,i,null)}function eh(n){return n.fold((e,t,s)=>{if(t&&Ae(t))return[yn(t)];{let i=[];return t&&(i=to(t)),Y(s,(r,o)=>{i=i.concat(o)}),i}})}function vt(n){return n._queryParams.loadsAllData()&&!n._queryParams.isDefault()?new(Yu())(n._repo,n._path):n}function th(n,e){for(let t=0;t<e.length;++t){const s=e[t];if(!s._queryParams.loadsAllData()){const i=Cn(s),r=n.queryToTagMap.get(i);n.queryToTagMap.delete(i),n.tagToQueryMap.delete(r)}}}function nh(){return zu++}function sh(n,e,t){const s=e._path,i=kt(n,e),r=ao(n,t),o=n.listenProvider_.startListening(vt(e),i,r.hashFn,r.onComplete),a=n.syncPointTree_.subtree(s);if(i)g(!Ae(a.value),"If we're adding a query, it shouldn't be shadowed");else{const l=a.fold((c,u,h)=>{if(!w(c)&&u&&Ae(u))return[yn(u).query];{let d=[];return u&&(d=d.concat(to(u).map(p=>p.query))),Y(h,(p,m)=>{d=d.concat(m)}),d}});for(let c=0;c<l.length;++c){const u=l[c];n.listenProvider_.stopListening(vt(u),kt(n,u))}}return o}class xs{constructor(e){this.node_=e}getImmediateChild(e){const t=this.node_.getImmediateChild(e);return new xs(t)}node(){return this.node_}}class Ps{constructor(e,t){this.syncTree_=e,this.path_=t}getImmediateChild(e){const t=F(this.path_,e);return new Ps(this.syncTree_,t)}node(){return En(this.syncTree_,this.path_)}}const ih=function(n){return n=n||{},n.timestamp=n.timestamp||new Date().getTime(),n},xi=function(n,e,t){if(!n||typeof n!="object")return n;if(g(".sv"in n,"Unexpected leaf node or priority contents"),typeof n[".sv"]=="string")return rh(n[".sv"],e,t);if(typeof n[".sv"]=="object")return oh(n[".sv"],e);g(!1,"Unexpected server value: "+JSON.stringify(n,null,2))},rh=function(n,e,t){if(n==="timestamp")return t.timestamp;g(!1,"Unexpected server value: "+n)},oh=function(n,e,t){n.hasOwnProperty("increment")||g(!1,"Unexpected server value: "+JSON.stringify(n,null,2));const s=n.increment;typeof s!="number"&&g(!1,"Unexpected increment value: "+s);const i=e.node();if(g(i!==null&&typeof i<"u","Expected ChildrenNode.EMPTY_NODE for nulls"),!i.isLeafNode())return s;const o=i.getValue();return typeof o!="number"?s:o+s},lo=function(n,e,t,s){return Fs(e,new Ps(t,n),s)},Bs=function(n,e,t){return Fs(n,new xs(e),t)};function Fs(n,e,t){const s=n.getPriority().val(),i=xi(s,e.getImmediateChild(".priority"),t);let r;if(n.isLeafNode()){const o=n,a=xi(o.getValue(),e,t);return a!==o.getValue()||i!==o.getPriority().val()?new $(a,B(i)):n}else{const o=n;return r=o,i!==o.getPriority().val()&&(r=r.updatePriority(new $(i))),o.forEachChild(P,(a,l)=>{const c=Fs(l,e.getImmediateChild(a),t);c!==l&&(r=r.updateImmediateChild(a,c))}),r}}class Ws{constructor(e="",t=null,s={children:{},childCount:0}){this.name=e,this.parent=t,this.node=s}}function vn(n,e){let t=e instanceof O?e:new O(e),s=n,i=b(t);for(;i!==null;){const r=We(s.node.children,i)||{children:{},childCount:0};s=new Ws(i,s,r),t=D(t),i=b(t)}return s}function Ke(n){return n.node.value}function Gs(n,e){n.node.value=e,os(n)}function co(n){return n.node.childCount>0}function ah(n){return Ke(n)===void 0&&!co(n)}function Sn(n,e){Y(n.node.children,(t,s)=>{e(new Ws(t,n,s))})}function uo(n,e,t,s){t&&e(n),Sn(n,i=>{uo(i,e,!0)})}function lh(n,e,t){let s=n.parent;for(;s!==null;){if(e(s))return!0;s=s.parent}return!1}function Ft(n){return new O(n.parent===null?n.name:Ft(n.parent)+"/"+n.name)}function os(n){n.parent!==null&&ch(n.parent,n.name,n)}function ch(n,e,t){const s=ah(t),i=de(n.node.children,e);s&&i?(delete n.node.children[e],n.node.childCount--,os(n)):!s&&!i&&(n.node.children[e]=t.node,n.node.childCount++,os(n))}const dh=/[\[\].#$\/\u0000-\u001F\u007F]/,uh=/[\[\].#$\u0000-\u001F\u007F]/,Fn=10*1024*1024,Us=function(n){return typeof n=="string"&&n.length!==0&&!dh.test(n)},ho=function(n){return typeof n=="string"&&n.length!==0&&!uh.test(n)},hh=function(n){return n&&(n=n.replace(/^\/*\.info(\/|$)/,"/")),ho(n)},Hs=function(n){return n===null||typeof n=="string"||typeof n=="number"&&!pn(n)||n&&typeof n=="object"&&de(n,".sv")},dn=function(n,e,t,s){s&&e===void 0||Wt(Je(n,"value"),e,t)},Wt=function(n,e,t){const s=t instanceof O?new Ad(t,n):t;if(e===void 0)throw new Error(n+"contains undefined "+Le(s));if(typeof e=="function")throw new Error(n+"contains a function "+Le(s)+" with contents = "+e.toString());if(pn(e))throw new Error(n+"contains "+e.toString()+" "+Le(s));if(typeof e=="string"&&e.length>Fn/3&&fn(e)>Fn)throw new Error(n+"contains a string greater than "+Fn+" utf8 bytes "+Le(s)+" ('"+e.substring(0,50)+"...')");if(e&&typeof e=="object"){let i=!1,r=!1;if(Y(e,(o,a)=>{if(o===".value")i=!0;else if(o!==".priority"&&o!==".sv"&&(r=!0,!Us(o)))throw new Error(n+" contains an invalid key ("+o+") "+Le(s)+`.  Keys must be non-empty strings and can't contain ".", "#", "$", "/", "[", or "]"`);kd(s,o),Wt(n,a,s),Dd(s)}),i&&r)throw new Error(n+' contains ".value" child '+Le(s)+" in addition to actual children.")}},fh=function(n,e){let t,s;for(t=0;t<e.length;t++){s=e[t];const r=Tt(s);for(let o=0;o<r.length;o++)if(!(r[o]===".priority"&&o===r.length-1)){if(!Us(r[o]))throw new Error(n+"contains an invalid key ("+r[o]+") in path "+s.toString()+`. Keys must be non-empty strings and can't contain ".", "#", "$", "/", "[", or "]"`)}}e.sort(Od);let i=null;for(t=0;t<e.length;t++){if(s=e[t],i!==null&&ie(i,s))throw new Error(n+"contains a path "+i.toString()+" that is ancestor of another path "+s.toString());i=s}},fo=function(n,e,t,s){const i=Je(n,"values");if(!(e&&typeof e=="object")||Array.isArray(e))throw new Error(i+" must be an object containing the children to replace.");const r=[];Y(e,(o,a)=>{const l=new O(o);if(Wt(i,a,F(t,l)),ys(l)===".priority"&&!Hs(a))throw new Error(i+"contains an invalid value for '"+l.toString()+"', which must be a valid Firebase priority (a string, finite number, server value, or null).");r.push(l)}),fh(i,r)},ph=function(n,e,t){if(pn(e))throw new Error(Je(n,"priority")+"is "+e.toString()+", but must be a valid Firebase priority (a string, finite number, server value, or null).");if(!Hs(e))throw new Error(Je(n,"priority")+"must be a valid Firebase priority (a string, finite number, server value, or null).")},po=function(n,e,t,s){if(!ho(t))throw new Error(Je(n,e)+'was an invalid path = "'+t+`". Paths must be non-empty strings and can't contain ".", "#", "$", "[", or "]"`)},mh=function(n,e,t,s){t&&(t=t.replace(/^\/*\.info(\/|$)/,"/")),po(n,e,t)},Pe=function(n,e){if(b(e)===".info")throw new Error(n+" failed = Can't modify data under /.info/")},gh=function(n,e){const t=e.path.toString();if(typeof e.repoInfo.host!="string"||e.repoInfo.host.length===0||!Us(e.repoInfo.namespace)&&e.repoInfo.host.split(":")[0]!=="localhost"||t.length!==0&&!hh(t))throw new Error(Je(n,"url")+`must be a valid firebase URL and the path can't contain ".", "#", "$", "[", or "]".`)};class _h{constructor(){this.eventLists_=[],this.recursionDepth_=0}}function bn(n,e){let t=null;for(let s=0;s<e.length;s++){const i=e[s],r=i.getPath();t!==null&&!Es(r,t.path)&&(n.eventLists_.push(t),t=null),t===null&&(t={events:[],path:r}),t.events.push(i)}t&&n.eventLists_.push(t)}function mo(n,e,t){bn(n,t),go(n,s=>Es(s,e))}function ee(n,e,t){bn(n,t),go(n,s=>ie(s,e)||ie(e,s))}function go(n,e){n.recursionDepth_++;let t=!0;for(let s=0;s<n.eventLists_.length;s++){const i=n.eventLists_[s];if(i){const r=i.path;e(r)?(yh(n.eventLists_[s]),n.eventLists_[s]=null):t=!1}}t&&(n.eventLists_=[]),n.recursionDepth_--}function yh(n){for(let e=0;e<n.events.length;e++){const t=n.events[e];if(t!==null){n.events[e]=null;const s=t.getEventRunner();_t&&K("event: "+t.toString()),at(s)}}}const Eh="repo_interrupt",Ch=25;class vh{constructor(e,t,s,i){this.repoInfo_=e,this.forceRestClient_=t,this.authTokenProvider_=s,this.appCheckProvider_=i,this.dataUpdateCount=0,this.statsListener_=null,this.eventQueue_=new _h,this.nextWriteId_=1,this.interceptServerDataCallback_=null,this.onDisconnect_=en(),this.transactionQueueTree_=new Ws,this.persistentConnection_=null,this.key=this.repoInfo_.toURLString()}toString(){return(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host}}function Sh(n,e,t){if(n.stats_=gs(n.repoInfo_),n.forceRestClient_||ed())n.server_=new Zt(n.repoInfo_,(s,i,r,o)=>{Pi(n,s,i,r,o)},n.authTokenProvider_,n.appCheckProvider_),setTimeout(()=>Bi(n,!0),0);else{if(typeof t<"u"&&t!==null){if(typeof t!="object")throw new Error("Only objects are supported for option databaseAuthVariableOverride");try{H(t)}catch(s){throw new Error("Invalid authOverride provided: "+s)}}n.persistentConnection_=new ge(n.repoInfo_,e,(s,i,r,o)=>{Pi(n,s,i,r,o)},s=>{Bi(n,s)},s=>{bh(n,s)},n.authTokenProvider_,n.appCheckProvider_,t),n.server_=n.persistentConnection_}n.authTokenProvider_.addTokenChangeListener(s=>{n.server_.refreshAuthToken(s)}),n.appCheckProvider_.addTokenChangeListener(s=>{n.server_.refreshAppCheckToken(s.token)}),n.statsReporter_=rd(n.repoInfo_,()=>new iu(n.stats_,n.server_)),n.infoData_=new Zd,n.infoSyncTree_=new Mi({startListening:(s,i,r,o)=>{let a=[];const l=n.infoData_.getNode(s._path);return l.isEmpty()||(a=Bt(n.infoSyncTree_,s._path,l),setTimeout(()=>{o("ok")},0)),a},stopListening:()=>{}}),$s(n,"connected",!1),n.serverSyncTree_=new Mi({startListening:(s,i,r,o)=>(n.server_.listen(s,r,i,(a,l)=>{const c=o(a,l);ee(n.eventQueue_,s._path,c)}),[]),stopListening:(s,i)=>{n.server_.unlisten(s,i)}})}function _o(n){const t=n.infoData_.getNode(new O(".info/serverTimeOffset")).val()||0;return new Date().getTime()+t}function Gt(n){return ih({timestamp:_o(n)})}function Pi(n,e,t,s,i){n.dataUpdateCount++;const r=new O(e);t=n.interceptServerDataCallback_?n.interceptServerDataCallback_(e,t):t;let o=[];if(i)if(s){const l=Yt(t,c=>B(c));o=Ju(n.serverSyncTree_,r,l,i)}else{const l=B(t);o=io(n.serverSyncTree_,r,l,i)}else if(s){const l=Yt(t,c=>B(c));o=qu(n.serverSyncTree_,r,l)}else{const l=B(t);o=Bt(n.serverSyncTree_,r,l)}let a=r;o.length>0&&(a=st(n,r)),ee(n.eventQueue_,a,o)}function Bi(n,e){$s(n,"connected",e),e===!1&&Nh(n)}function bh(n,e){Y(e,(t,s)=>{$s(n,t,s)})}function $s(n,e,t){const s=new O("/.info/"+e),i=B(t);n.infoData_.updateSnapshot(s,i);const r=Bt(n.infoSyncTree_,s,i);ee(n.eventQueue_,s,r)}function wn(n){return n.nextWriteId_++}function wh(n,e,t){const s=Zu(n.serverSyncTree_,e);return s!=null?Promise.resolve(s):n.server_.get(e).then(i=>{const r=B(i).withIndex(e._queryParams.getIndex());rs(n.serverSyncTree_,e,t,!0);let o;if(e._queryParams.loadsAllData())o=Bt(n.serverSyncTree_,e._path,r);else{const a=kt(n.serverSyncTree_,e);o=io(n.serverSyncTree_,e._path,r,a)}return ee(n.eventQueue_,e._path,o),cn(n.serverSyncTree_,e,t,null,!0),r},i=>(dt(n,"get for query "+H(e)+" failed: "+i),Promise.reject(new Error(i))))}function Ih(n,e,t,s,i){dt(n,"set",{path:e.toString(),value:t,priority:s});const r=Gt(n),o=B(t,s),a=En(n.serverSyncTree_,e),l=Bs(o,a,r),c=wn(n),u=ks(n.serverSyncTree_,e,l,c,!0);bn(n.eventQueue_,u),n.server_.put(e.toString(),o.val(!0),(d,p)=>{const m=d==="ok";m||X("set at "+e+" failed: "+d);const _=Se(n.serverSyncTree_,c,!m);ee(n.eventQueue_,e,_),ke(n,i,d,p)});const h=Ks(n,e);st(n,h),ee(n.eventQueue_,h,[])}function Th(n,e,t,s){dt(n,"update",{path:e.toString(),value:t});let i=!0;const r=Gt(n),o={};if(Y(t,(a,l)=>{i=!1,o[a]=lo(F(e,a),B(l),n.serverSyncTree_,r)}),i)K("update() called with empty data.  Don't do anything."),ke(n,s,"ok",void 0);else{const a=wn(n),l=ju(n.serverSyncTree_,e,o,a);bn(n.eventQueue_,l),n.server_.merge(e.toString(),t,(c,u)=>{const h=c==="ok";h||X("update at "+e+" failed: "+c);const d=Se(n.serverSyncTree_,a,!h),p=d.length>0?st(n,e):e;ee(n.eventQueue_,p,d),ke(n,s,c,u)}),Y(t,c=>{const u=Ks(n,F(e,c));st(n,u)}),ee(n.eventQueue_,e,[])}}function Nh(n){dt(n,"onDisconnectEvents");const e=Gt(n),t=en();Zn(n.onDisconnect_,R(),(i,r)=>{const o=lo(i,r,n.serverSyncTree_,e);lt(t,i,o)});let s=[];Zn(t,R(),(i,r)=>{s=s.concat(Bt(n.serverSyncTree_,i,r));const o=Ks(n,i);st(n,o)}),n.onDisconnect_=en(),ee(n.eventQueue_,R(),s)}function Rh(n,e,t){n.server_.onDisconnectCancel(e.toString(),(s,i)=>{s==="ok"&&Jn(n.onDisconnect_,e),ke(n,t,s,i)})}function Fi(n,e,t,s){const i=B(t);n.server_.onDisconnectPut(e.toString(),i.val(!0),(r,o)=>{r==="ok"&&lt(n.onDisconnect_,e,i),ke(n,s,r,o)})}function Oh(n,e,t,s,i){const r=B(t,s);n.server_.onDisconnectPut(e.toString(),r.val(!0),(o,a)=>{o==="ok"&&lt(n.onDisconnect_,e,r),ke(n,i,o,a)})}function Ah(n,e,t,s){if($n(t)){K("onDisconnect().update() called with empty data.  Don't do anything."),ke(n,s,"ok",void 0);return}n.server_.onDisconnectMerge(e.toString(),t,(i,r)=>{i==="ok"&&Y(t,(o,a)=>{const l=B(a);lt(n.onDisconnect_,F(e,o),l)}),ke(n,s,i,r)})}function kh(n,e,t){let s;b(e._path)===".info"?s=rs(n.infoSyncTree_,e,t):s=rs(n.serverSyncTree_,e,t),mo(n.eventQueue_,e._path,s)}function Dh(n,e,t){let s;b(e._path)===".info"?s=cn(n.infoSyncTree_,e,t):s=cn(n.serverSyncTree_,e,t),mo(n.eventQueue_,e._path,s)}function Lh(n){n.persistentConnection_&&n.persistentConnection_.interrupt(Eh)}function dt(n,...e){let t="";n.persistentConnection_&&(t=n.persistentConnection_.id+":"),K(t,...e)}function ke(n,e,t,s){e&&at(()=>{if(t==="ok")e(null);else{const i=(t||"error").toUpperCase();let r=i;s&&(r+=": "+s);const o=new Error(r);o.code=i,e(o)}})}function Mh(n,e,t,s,i,r){dt(n,"transaction on "+e);const o={path:e,update:t,onComplete:s,status:null,order:pr(),applyLocally:r,retryCount:0,unwatcher:i,abortReason:null,currentWriteId:null,currentInputSnapshot:null,currentOutputSnapshotRaw:null,currentOutputSnapshotResolved:null},a=Vs(n,e,void 0);o.currentInputSnapshot=a;const l=o.update(a.val());if(l===void 0)o.unwatcher(),o.currentOutputSnapshotRaw=null,o.currentOutputSnapshotResolved=null,o.onComplete&&o.onComplete(null,!1,o.currentInputSnapshot);else{Wt("transaction failed: Data returned ",l,o.path),o.status=0;const c=vn(n.transactionQueueTree_,e),u=Ke(c)||[];u.push(o),Gs(c,u);let h;typeof l=="object"&&l!==null&&de(l,".priority")?(h=We(l,".priority"),g(Hs(h),"Invalid priority returned by transaction. Priority must be a valid string, finite number, server value, or null.")):h=(En(n.serverSyncTree_,e)||v.EMPTY_NODE).getPriority().val();const d=Gt(n),p=B(l,h),m=Bs(p,a,d);o.currentOutputSnapshotRaw=p,o.currentOutputSnapshotResolved=m,o.currentWriteId=wn(n);const _=ks(n.serverSyncTree_,e,m,o.currentWriteId,o.applyLocally);ee(n.eventQueue_,e,_),In(n,n.transactionQueueTree_)}}function Vs(n,e,t){return En(n.serverSyncTree_,e,t)||v.EMPTY_NODE}function In(n,e=n.transactionQueueTree_){if(e||Tn(n,e),Ke(e)){const t=Eo(n,e);g(t.length>0,"Sending zero length transaction queue"),t.every(i=>i.status===0)&&xh(n,Ft(e),t)}else co(e)&&Sn(e,t=>{In(n,t)})}function xh(n,e,t){const s=t.map(c=>c.currentWriteId),i=Vs(n,e,s);let r=i;const o=i.hash();for(let c=0;c<t.length;c++){const u=t[c];g(u.status===0,"tryToSendTransactionQueue_: items in queue should all be run."),u.status=1,u.retryCount++;const h=Q(e,u.path);r=r.updateChild(h,u.currentOutputSnapshotRaw)}const a=r.val(!0),l=e;n.server_.put(l.toString(),a,c=>{dt(n,"transaction put response",{path:l.toString(),status:c});let u=[];if(c==="ok"){const h=[];for(let d=0;d<t.length;d++)t[d].status=2,u=u.concat(Se(n.serverSyncTree_,t[d].currentWriteId)),t[d].onComplete&&h.push(()=>t[d].onComplete(null,!0,t[d].currentOutputSnapshotResolved)),t[d].unwatcher();Tn(n,vn(n.transactionQueueTree_,e)),In(n,n.transactionQueueTree_),ee(n.eventQueue_,e,u);for(let d=0;d<h.length;d++)at(h[d])}else{if(c==="datastale")for(let h=0;h<t.length;h++)t[h].status===3?t[h].status=4:t[h].status=0;else{X("transaction at "+l.toString()+" failed: "+c);for(let h=0;h<t.length;h++)t[h].status=4,t[h].abortReason=c}st(n,e)}},o)}function st(n,e){const t=yo(n,e),s=Ft(t),i=Eo(n,t);return Ph(n,i,s),s}function Ph(n,e,t){if(e.length===0)return;const s=[];let i=[];const o=e.filter(a=>a.status===0).map(a=>a.currentWriteId);for(let a=0;a<e.length;a++){const l=e[a],c=Q(t,l.path);let u=!1,h;if(g(c!==null,"rerunTransactionsUnderNode_: relativePath should not be null."),l.status===4)u=!0,h=l.abortReason,i=i.concat(Se(n.serverSyncTree_,l.currentWriteId,!0));else if(l.status===0)if(l.retryCount>=Ch)u=!0,h="maxretry",i=i.concat(Se(n.serverSyncTree_,l.currentWriteId,!0));else{const d=Vs(n,l.path,o);l.currentInputSnapshot=d;const p=e[a].update(d.val());if(p!==void 0){Wt("transaction failed: Data returned ",p,l.path);let m=B(p);typeof p=="object"&&p!=null&&de(p,".priority")||(m=m.updatePriority(d.getPriority()));const E=l.currentWriteId,k=Gt(n),A=Bs(m,d,k);l.currentOutputSnapshotRaw=m,l.currentOutputSnapshotResolved=A,l.currentWriteId=wn(n),o.splice(o.indexOf(E),1),i=i.concat(ks(n.serverSyncTree_,l.path,A,l.currentWriteId,l.applyLocally)),i=i.concat(Se(n.serverSyncTree_,E,!0))}else u=!0,h="nodata",i=i.concat(Se(n.serverSyncTree_,l.currentWriteId,!0))}ee(n.eventQueue_,t,i),i=[],u&&(e[a].status=2,(function(d){setTimeout(d,Math.floor(0))})(e[a].unwatcher),e[a].onComplete&&(h==="nodata"?s.push(()=>e[a].onComplete(null,!1,e[a].currentInputSnapshot)):s.push(()=>e[a].onComplete(new Error(h),!1,null))))}Tn(n,n.transactionQueueTree_);for(let a=0;a<s.length;a++)at(s[a]);In(n,n.transactionQueueTree_)}function yo(n,e){let t,s=n.transactionQueueTree_;for(t=b(e);t!==null&&Ke(s)===void 0;)s=vn(s,t),e=D(e),t=b(e);return s}function Eo(n,e){const t=[];return Co(n,e,t),t.sort((s,i)=>s.order-i.order),t}function Co(n,e,t){const s=Ke(e);if(s)for(let i=0;i<s.length;i++)t.push(s[i]);Sn(e,i=>{Co(n,i,t)})}function Tn(n,e){const t=Ke(e);if(t){let s=0;for(let i=0;i<t.length;i++)t[i].status!==2&&(t[s]=t[i],s++);t.length=s,Gs(e,t.length>0?t:void 0)}Sn(e,s=>{Tn(n,s)})}function Ks(n,e){const t=Ft(yo(n,e)),s=vn(n.transactionQueueTree_,e);return lh(s,i=>{Wn(n,i)}),Wn(n,s),uo(s,i=>{Wn(n,i)}),t}function Wn(n,e){const t=Ke(e);if(t){const s=[];let i=[],r=-1;for(let o=0;o<t.length;o++)t[o].status===3||(t[o].status===1?(g(r===o-1,"All SENT items should be at beginning of queue."),r=o,t[o].status=3,t[o].abortReason="set"):(g(t[o].status===0,"Unexpected transaction status in abort"),t[o].unwatcher(),i=i.concat(Se(n.serverSyncTree_,t[o].currentWriteId,!0)),t[o].onComplete&&s.push(t[o].onComplete.bind(null,new Error("set"),!1,null))));r===-1?Gs(e,void 0):t.length=r+1,ee(n.eventQueue_,Ft(e),i);for(let o=0;o<s.length;o++)at(s[o])}}function Bh(n){let e="";const t=n.split("/");for(let s=0;s<t.length;s++)if(t[s].length>0){let i=t[s];try{i=decodeURIComponent(i.replace(/\+/g," "))}catch{}e+="/"+i}return e}function Fh(n){const e={};n.charAt(0)==="?"&&(n=n.substring(1));for(const t of n.split("&")){if(t.length===0)continue;const s=t.split("=");s.length===2?e[decodeURIComponent(s[0])]=decodeURIComponent(s[1]):X(`Invalid query segment '${t}' in query '${n}'`)}return e}const Wi=function(n,e){const t=Wh(n),s=t.namespace;t.domain==="firebase.com"&&Ee(t.host+" is no longer supported. Please use <YOUR FIREBASE>.firebaseio.com instead"),(!s||s==="undefined")&&t.domain!=="localhost"&&Ee("Cannot parse Firebase url. Please use https://<YOUR FIREBASE>.firebaseio.com"),t.secure||Kc();const i=t.scheme==="ws"||t.scheme==="wss";return{repoInfo:new Nr(t.host,t.secure,s,i,e,"",s!==t.subdomain),path:new O(t.pathString)}},Wh=function(n){let e="",t="",s="",i="",r="",o=!0,a="https",l=443;if(typeof n=="string"){let c=n.indexOf("//");c>=0&&(a=n.substring(0,c-1),n=n.substring(c+2));let u=n.indexOf("/");u===-1&&(u=n.length);let h=n.indexOf("?");h===-1&&(h=n.length),e=n.substring(0,Math.min(u,h)),u<h&&(i=Bh(n.substring(u,h)));const d=Fh(n.substring(Math.min(n.length,h)));c=e.indexOf(":"),c>=0?(o=a==="https"||a==="wss",l=parseInt(e.substring(c+1),10)):c=e.length;const p=e.slice(0,c);if(p.toLowerCase()==="localhost")t="localhost";else if(p.split(".").length<=2)t=p;else{const m=e.indexOf(".");s=e.substring(0,m).toLowerCase(),t=e.substring(m+1),r=s}"ns"in d&&(r=d.ns)}return{host:e,port:l,domain:t,subdomain:s,secure:o,scheme:a,pathString:i,namespace:r}};const Gi="-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz",Gh=(function(){let n=0;const e=[];return function(t){const s=t===n;n=t;let i;const r=new Array(8);for(i=7;i>=0;i--)r[i]=Gi.charAt(t%64),t=Math.floor(t/64);g(t===0,"Cannot push at time == 0");let o=r.join("");if(s){for(i=11;i>=0&&e[i]===63;i--)e[i]=0;e[i]++}else for(i=0;i<12;i++)e[i]=Math.floor(Math.random()*64);for(i=0;i<12;i++)o+=Gi.charAt(e[i]);return g(o.length===20,"nextPushId: Length should be 20."),o}})();class Uh{constructor(e,t,s,i){this.eventType=e,this.eventRegistration=t,this.snapshot=s,this.prevName=i}getPath(){const e=this.snapshot.ref;return this.eventType==="value"?e._path:e.parent._path}getEventType(){return this.eventType}getEventRunner(){return this.eventRegistration.getEventRunner(this)}toString(){return this.getPath().toString()+":"+this.eventType+":"+H(this.snapshot.exportVal())}}class Hh{constructor(e,t,s){this.eventRegistration=e,this.error=t,this.path=s}getPath(){return this.path}getEventType(){return"cancel"}getEventRunner(){return this.eventRegistration.getEventRunner(this)}toString(){return this.path.toString()+":cancel"}}class vo{constructor(e,t){this.snapshotCallback=e,this.cancelCallback=t}onValue(e,t){this.snapshotCallback.call(null,e,t)}onCancel(e){return g(this.hasCancelCallback,"Raising a cancel event on a listener with no cancel callback"),this.cancelCallback.call(null,e)}get hasCancelCallback(){return!!this.cancelCallback}matches(e){return this.snapshotCallback===e.snapshotCallback||this.snapshotCallback.userCallback!==void 0&&this.snapshotCallback.userCallback===e.snapshotCallback.userCallback&&this.snapshotCallback.context===e.snapshotCallback.context}}class $h{constructor(e,t){this._repo=e,this._path=t}cancel(){const e=new re;return Rh(this._repo,this._path,e.wrapCallback(()=>{})),e.promise}remove(){Pe("OnDisconnect.remove",this._path);const e=new re;return Fi(this._repo,this._path,null,e.wrapCallback(()=>{})),e.promise}set(e){Pe("OnDisconnect.set",this._path),dn("OnDisconnect.set",e,this._path,!1);const t=new re;return Fi(this._repo,this._path,e,t.wrapCallback(()=>{})),t.promise}setWithPriority(e,t){Pe("OnDisconnect.setWithPriority",this._path),dn("OnDisconnect.setWithPriority",e,this._path,!1),ph("OnDisconnect.setWithPriority",t);const s=new re;return Oh(this._repo,this._path,e,t,s.wrapCallback(()=>{})),s.promise}update(e){Pe("OnDisconnect.update",this._path),fo("OnDisconnect.update",e,this._path);const t=new re;return Ah(this._repo,this._path,e,t.wrapCallback(()=>{})),t.promise}}class Ys{constructor(e,t,s,i){this._repo=e,this._path=t,this._queryParams=s,this._orderByCalled=i}get key(){return w(this._path)?null:ys(this._path)}get ref(){return new he(this._repo,this._path)}get _queryIdentifier(){const e=wi(this._queryParams),t=ps(e);return t==="{}"?"default":t}get _queryObject(){return wi(this._queryParams)}isEqual(e){if(e=ve(e),!(e instanceof Ys))return!1;const t=this._repo===e._repo,s=Es(this._path,e._path),i=this._queryIdentifier===e._queryIdentifier;return t&&s&&i}toJSON(){return this.toString()}toString(){return this._repo.toString()+Rd(this._path)}}class he extends Ys{constructor(e,t){super(e,t,new bs,!1)}get parent(){const e=Pr(this._path);return e===null?null:new he(this._repo,e)}get root(){let e=this;for(;e.parent!==null;)e=e.parent;return e}}class it{constructor(e,t,s){this._node=e,this.ref=t,this._index=s}get priority(){return this._node.getPriority().val()}get key(){return this.ref.key}get size(){return this._node.numChildren()}child(e){const t=new O(e),s=rt(this.ref,e);return new it(this._node.getChild(t),s,P)}exists(){return!this._node.isEmpty()}exportVal(){return this._node.val(!0)}forEach(e){return this._node.isLeafNode()?!1:!!this._node.forEachChild(this._index,(s,i)=>e(new it(i,rt(this.ref,s),P)))}hasChild(e){const t=new O(e);return!this._node.getChild(t).isEmpty()}hasChildren(){return this._node.isLeafNode()?!1:!this._node.isEmpty()}toJSON(){return this.exportVal()}val(){return this._node.val()}}function j(n,e){return n=ve(n),n._checkNotDeleted("ref"),e!==void 0?rt(n._root,e):n._root}function rt(n,e){return n=ve(n),b(n._path)===null?mh("child","path",e):po("child","path",e),new he(n._repo,F(n._path,e))}function Ui(n){return n=ve(n),new $h(n._repo,n._path)}function Vh(n,e){n=ve(n),Pe("push",n._path),dn("push",e,n._path,!0);const t=_o(n._repo),s=Gh(t),i=rt(n,s),r=rt(n,s);let o;return o=Promise.resolve(r),i.then=o.then.bind(o),i.catch=o.then.bind(o,void 0),i}function Gn(n,e){n=ve(n),Pe("set",n._path),dn("set",e,n._path,!1);const t=new re;return Ih(n._repo,n._path,e,null,t.wrapCallback(()=>{})),t.promise}function fe(n,e){fo("update",e,n._path);const t=new re;return Th(n._repo,n._path,e,t.wrapCallback(()=>{})),t.promise}function Un(n){n=ve(n);const e=new vo(()=>{}),t=new Nn(e);return wh(n._repo,n,t).then(s=>new it(s,new he(n._repo,n._path),n._queryParams.getIndex()))}class Nn{constructor(e){this.callbackContext=e}respondsTo(e){return e==="value"}createEvent(e,t){const s=t._queryParams.getIndex();return new Uh("value",this,new it(e.snapshotNode,new he(t._repo,t._path),s))}getEventRunner(e){return e.getEventType()==="cancel"?()=>this.callbackContext.onCancel(e.error):()=>this.callbackContext.onValue(e.snapshot,null)}createCancelEvent(e,t){return this.callbackContext.hasCancelCallback?new Hh(this,e,t):null}matches(e){return e instanceof Nn?!e.callbackContext||!this.callbackContext?!0:e.callbackContext.matches(this.callbackContext):!1}hasAnyCallback(){return this.callbackContext!==null}}function Kh(n,e,t,s,i){const r=new vo(t,void 0),o=new Nn(r);return kh(n._repo,n,o),()=>Dh(n._repo,n,o)}function So(n,e,t,s){return Kh(n,"value",e)}Gu(he);Ku(he);const Yh="FIREBASE_DATABASE_EMULATOR_HOST",as={};let zh=!1;function jh(n,e,t,s){const i=e.lastIndexOf(":"),r=e.substring(0,i),o=hs(r);n.repoInfo_=new Nr(e,o,n.repoInfo_.namespace,n.repoInfo_.webSocketOnly,n.repoInfo_.nodeAdmin,n.repoInfo_.persistenceKey,n.repoInfo_.includeNamespaceInQueryParams,!0,t),s&&(n.authTokenProvider_=s)}function qh(n,e,t,s,i){let r=s||n.options.databaseURL;r===void 0&&(n.options.projectId||Ee("Can't determine Firebase Database URL. Be sure to include  a Project ID when calling firebase.initializeApp()."),K("Using default host for project ",n.options.projectId),r=`${n.options.projectId}-default-rtdb.firebaseio.com`);let o=Wi(r,i),a=o.repoInfo,l;typeof process<"u"&&oi&&(l=oi[Yh]),l?(r=`http://${l}?ns=${a.namespace}`,o=Wi(r,i),a=o.repoInfo):o.repoInfo.secure;const c=new nd(n.name,n.options,e);gh("Invalid Firebase Database URL",o),w(o.path)||Ee("Database URL must point to the root of a Firebase Database (not including a child path).");const u=Xh(a,n,c,new td(n,t));return new Jh(u,n)}function Qh(n,e){const t=as[e];(!t||t[n.key]!==n)&&Ee(`Database ${e}(${n.repoInfo_}) has already been deleted.`),Lh(n),delete t[n.key]}function Xh(n,e,t,s){let i=as[e.name];i||(i={},as[e.name]=i);let r=i[n.toURLString()];return r&&Ee("Database initialized multiple times. Please make sure the format of the database URL matches with each database() call."),r=new vh(n,zh,t,s),i[n.toURLString()]=r,r}class Jh{constructor(e,t){this._repoInternal=e,this.app=t,this.type="database",this._instanceStarted=!1}get _repo(){return this._instanceStarted||(Sh(this._repoInternal,this.app.options.appId,this.app.options.databaseAuthVariableOverride),this._instanceStarted=!0),this._repoInternal}get _root(){return this._rootInternal||(this._rootInternal=new he(this._repo,R())),this._rootInternal}_delete(){return this._rootInternal!==null&&(Qh(this._repo,this.app.name),this._repoInternal=null,this._rootInternal=null),Promise.resolve()}_checkNotDeleted(e){this._rootInternal===null&&Ee("Cannot call "+e+" on a deleted database.")}}function Zh(n=Nc(),e){const t=Sc(n,"database").getImmediate({identifier:e});if(!t._instanceStarted){const s=al("database");s&&ef(t,...s)}return t}function ef(n,e,t,s={}){n=ve(n),n._checkNotDeleted("useEmulator");const i=`${e}:${t}`,r=n._repoInternal;if(n._instanceStarted){if(i===n._repoInternal.repoInfo_.host&&zt(s,r.repoInfo_.emulatorOptions))return;Ee("connectDatabaseEmulator() cannot initialize or alter the emulator configuration after the database instance has started.")}let o;if(r.repoInfo_.nodeAdmin)s.mockUserToken&&Ee('mockUserToken is not supported by the Admin SDK. For client access with mock users, please use the "firebase" package instead of "firebase-admin".'),o=new Vt(Vt.OWNER);else if(s.mockUserToken){const a=typeof s.mockUserToken=="string"?s.mockUserToken:cl(s.mockUserToken,n.app.options.projectId);o=new Vt(a)}hs(e)&&(ll(e),hl("Database",!0)),jh(r,i,s,o)}function tf(n){Gc(Tc),qt(new bt("database",(e,{instanceIdentifier:t})=>{const s=e.getProvider("app").getImmediate(),i=e.getProvider("auth-internal"),r=e.getProvider("app-check-internal");return qh(s,i,r,t)},"PUBLIC").setMultipleInstances(!0)),je(ai,li,n),je(ai,li,"esm2020")}class nf{constructor(e,t){this.committed=e,this.snapshot=t}toJSON(){return{committed:this.committed,snapshot:this.snapshot.toJSON()}}}function sf(n,e,t){if(n=ve(n),Pe("Reference.transaction",n._path),n.key===".length"||n.key===".keys")throw"Reference.transaction failed: "+n.key+" is a read-only object.";const s=!0,i=new re,r=(a,l,c)=>{let u=null;a?i.reject(a):(u=new it(c,new he(n._repo,n._path),P),i.resolve(new nf(l,u)))},o=So(n,()=>{});return Mh(n._repo,n._path,e,r,o,s),i.promise}ge.prototype.simpleListen=function(n,e){this.sendRequest("q",{p:n},e)};ge.prototype.echo=function(n,e){this.sendRequest("echo",{d:n},e)};tf();const rf={apiKey:"AIzaSyDhDhpFMVbXOq04J2jZkGrfjeovdTT6U2o",authDomain:"tiny-towns-multiplayer.firebaseapp.com",databaseURL:"https://tiny-towns-multiplayer-default-rtdb.europe-west1.firebasedatabase.app",projectId:"tiny-towns-multiplayer",storageBucket:"tiny-towns-multiplayer.firebasestorage.app",messagingSenderId:"374830147876",appId:"1:374830147876:web:93ffbe5825d8d3af982bb1"},of=cr(rf),q=Zh(of);class af{gameId=null;playerId;isHost=!1;localGame;masterBuilderId=null;myName="Unknown";currentRound=1;lastNeighborCounts={};myFinishRank=null;onOpaleyeBonus=null;onStateChange=null;onGameStart=null;constructor(e){this.localGame=e,this.playerId="player_"+Math.random().toString(36).substr(2,9)}async createGame(e,t){const s=j(q,"games"),i=Vh(s);this.gameId=i.key,this.isHost=!0,this.myName=e;const r={status:"LOBBY",hostId:this.playerId,deck:t,currentResource:null,masterBuilderIndex:0,roundNumber:1,playerOrder:[this.playerId],players:{[this.playerId]:{name:e,score:0,isReady:!0,placedRound:0,isGameOver:!1,board:this.serializeBoard()}}};return await Gn(i,r),this.subscribeToGame(),Ui(i).remove(),this.gameId}async joinGame(e,t){const s=j(q,`games/${e}`),i=await Un(s);if(!i.exists())throw new Error("Game not found");const r=i.val();if(t==="Guest"){const u=r.players||{};let h=1;for(;;){const d=`Guest ${h}`;if(!Object.values(u).some(m=>m.name===d)){t=d;break}h++}}this.gameId=e,this.isHost=!1,this.myName=t;const o=j(q,`games/${e}/players/${this.playerId}`);await Gn(o,{name:t,score:0,isReady:!0,placedRound:0,isGameOver:!1,board:this.serializeBoard()});const a=j(q,`games/${e}/playerOrder`),c=(await Un(a)).val()||[];c.includes(this.playerId)||(c.push(this.playerId),await Gn(a,c)),Ui(o).remove(),this.subscribeToGame()}async startGame(){if(!this.gameId)return;const e=j(q,`games/${this.gameId}`),s=(await Un(rt(e,"players"))).val()||{},i=Object.keys(s),r=[...Xe].sort(()=>Math.random()-.5),o={status:"PLAYING",currentResource:null,roundNumber:1,masterBuilderIndex:0,playerOrder:i};i.forEach(a=>{const l=r.pop(),c=r.pop();l&&c&&(o[`players/${a}/monumentOptions`]=[l.name,c.name],o[`players/${a}/monumentChosen`]=!1)}),await fe(e,o)}async selectMonument(e){if(!this.gameId||!this.playerId)return;const t=j(q,`games/${this.gameId}/players/${this.playerId}`);await fe(t,{activeMonument:e,monumentChosen:!0})}async updateDeck(e){!this.isHost||!this.gameId||await fe(j(q,`games/${this.gameId}`),{deck:e})}subscribeToGame(){if(!this.gameId)return;const e=j(q,`games/${this.gameId}`);So(e,t=>{const s=t.val();if(!s)return;s.status==="PLAYING"&&this.localGame.gameRegistry.length===0&&(this.syncDeck(s.deck),this.onGameStart&&this.onGameStart());const i=s.playerOrder||[],r=Array.isArray(i)?i:Object.values(i);if(r.length>0){const o=(s.masterBuilderIndex||0)%r.length;this.masterBuilderId=r[o]}if(s.currentResource===void 0||s.currentResource===""?this.localGame.currentResource=null:this.localGame.currentResource=s.currentResource,this.currentRound=s.roundNumber||1,s.status==="PLAYING"&&s.players&&s.playerOrder&&(this.checkNeighborsForOpaleye(s.players,s.playerOrder),this.updateNeighborFeastHallStats(s.players,s.playerOrder)),s.players&&s.players[this.playerId]){const o=s.players[this.playerId];if(o.finishRank&&(this.myFinishRank=o.finishRank),o.board&&o.board.metadata){const a=new Map;Object.entries(o.board.metadata).forEach(([l,c])=>{a.set(l,c)}),this.localGame.board.metadata=a}}this.onStateChange&&this.onStateChange(s),this.isHost&&s.status==="PLAYING"&&setTimeout(()=>this.checkTurnComplete(s),10)})}async setGlobalResource(e){if(!this.gameId||this.playerId!==this.masterBuilderId)return;const t={};t[`games/${this.gameId}/currentResource`]=e,await fe(j(q),t)}async commitTurn(){if(!this.gameId)return;const e={},t=`games/${this.gameId}/players/${this.playerId}`;e[`${t}/board`]=this.serializeBoard(),e[`${t}/score`]=this.localGame.getScore().total,e[`${t}/placedRound`]=this.currentRound,await fe(j(q),e)}async saveBoardOnly(){if(!this.gameId)return;console.log("Saving board state (Turn not finished)...");const e={},t=`games/${this.gameId}/players/${this.playerId}`;e[`${t}/board`]=this.serializeBoard(),e[`${t}/score`]=this.localGame.getScore().total,await fe(j(q),e)}async declareGameOver(){if(!this.gameId)return;const e=j(q,`games/${this.gameId}/finishedCount`),s=(await sf(e,a=>(a||0)+1)).snapshot.val();this.myFinishRank=s;const i={},r=`games/${this.gameId}/players/${this.playerId}`;i[`${r}/isGameOver`]=!0,i[`${r}/placedRound`]=this.currentRound,i[`${r}/finishRank`]=s;const o=this.localGame.getScore(s).total;i[`${r}/score`]=o,await fe(j(q),i),this.isHost&&setTimeout(()=>{},10)}async checkTurnComplete(e){if(!e||!e.players)return;const t=Object.values(e.players),s=e.roundNumber||1,i=e.playerOrder||[];if(t.every(d=>d.isGameOver===!0)){e.status!=="FINISHED"&&(console.log("GAME OVER FOR EVERYONE"),await fe(j(q,`games/${this.gameId}`),{status:"FINISHED"}));return}const o=e.currentResource!==void 0&&e.currentResource!==null,a=t.every(d=>d.placedRound===s||d.isGameOver===!0),l=(e.masterBuilderIndex||0)%i.length,c=i[l],u=e.players[c]&&e.players[c].isGameOver;let h=!1;if(o&&a?(console.log(`Round ${s} Complete. Rotating.`),h=!0):!o&&u&&(console.log("Current Master Builder is finished. Skipping their turn."),h=!0),h){let d=e.masterBuilderIndex||0,p=d,m=!1;const _=t.filter(k=>!k.isGameOver).length;for(let k=1;k<=i.length;k++){const A=(d+k)%i.length,x=i[A],S=e.players[x];if(S&&!S.isGameOver){if(this.playerHasBuilding(S.board,"FORT IRONWEED")&&_>1){console.log(`Skipping ${S.name} due to Fort Ironweed.`);continue}p=A,m=!0;break}}m||(p=(d+1)%i.length);const E={};E[`games/${this.gameId}/currentResource`]=null,E[`games/${this.gameId}/masterBuilderIndex`]=p,E[`games/${this.gameId}/roundNumber`]=s+1,await fe(j(q),E)}}playerHasBuilding(e,t){return!e||!Array.isArray(e)?!1:e.some(s=>s.some(i=>typeof i=="string"&&i.toUpperCase().includes(t.toUpperCase())))}syncDeck(e){e&&(this.localGame.gameRegistry=mt.filter(t=>e.includes(t.name)),this.localGame.scanForMatches())}serializeBoard(){const e={};return this.localGame.board.metadata.forEach((t,s)=>{e[s]=t}),{grid:this.localGame.board.getGrid(),metadata:e}}checkNeighborsForOpaleye(e,t){const s=t.indexOf(this.playerId);if(s===-1)return;const i=t.length;if(i<2)return;const r=(s-1+i)%i,o=(s+1)%i;new Set([t[r],t[o]]).forEach(l=>{if(l===this.playerId)return;const c=e[l];if(!c||!c.board)return;const u=this.countBuildings(c.board),h=this.lastNeighborCounts[l];h&&Object.keys(u).forEach(d=>{if((u[d]||0)-(h[d]||0)>0){const m=this.localGame.checkOpaleyeMatch(d);m&&this.onOpaleyeBonus&&(console.log(`[Opaleye] Bonus! Building: ${d} at Watch Coords:`,m),this.onOpaleyeBonus(d,m))}}),this.lastNeighborCounts[l]=u})}countBuildings(e){const t={},s=["WOOD","WHEAT","BRICK","GLASS","STONE","NONE"],i=e&&e.grid?e.grid:e;return Array.isArray(i)&&i.forEach(r=>{Array.isArray(r)&&r.forEach(o=>{typeof o=="string"&&!s.includes(o)&&(t[o]=(t[o]||0)+1)})}),t}updateNeighborFeastHallStats(e,t){const s=t.indexOf(this.playerId);if(s===-1||t.length<2){this.localGame.setRightNeighborFeastHallCount(0);return}const i=(s+1)%t.length,r=t[i],o=e[r];if(o&&o.board){const l=this.countBuildings(o.board)["FEAST HALL"]||0;this.localGame.setRightNeighborFeastHallCount(l)}else this.localGame.setRightNeighborFeastHallCount(0)}}class lf{sounds={};muted=!1;constructor(){const e="/tiny-towns/";this.load("place",`${e}sounds/place.mp3`),this.load("build",`${e}sounds/build.mp3`),this.load("error",`${e}sounds/error.mp3`),this.load("fanfare",`${e}sounds/fanfare.mp3`),this.load("click",`${e}sounds/click.mp3`)}load(e,t){const s=new Audio(t);this.sounds[e]=s}play(e){if(this.muted)return;const t=this.sounds[e];t&&(t.currentTime=0,e==="build"&&(t.volume=.5),t.play().catch(s=>console.warn("Audio play failed:",s)))}toggleMute(){return this.muted=!this.muted,this.muted}}function N(n,e="info",t){const s=document.getElementById("toast-container");if(!s)return;e==="error"&&t&&t.play("error");const i=document.createElement("div");i.className=`toast ${e}`,i.textContent=n,s.appendChild(i),setTimeout(()=>{i.remove()},4e3)}function be(n){const e=document.getElementById("resource-palette");e&&(n?(e.style.opacity="1",e.style.pointerEvents="auto"):(e.style.opacity="0.5",e.style.pointerEvents="none"))}function ls(n,e,t,s=[]){const i=document.getElementById("resource-picker-modal"),r=document.getElementById("picker-title"),o=document.getElementById("picker-message"),a=document.getElementById("picker-options");r.textContent=n,o.textContent=e,a.innerHTML="",["WOOD","WHEAT","BRICK","GLASS","STONE"].forEach(c=>{if(s.includes(c))return;const u=document.createElement("div");u.className=`res-btn ${c}`,u.onclick=()=>{i.classList.add("hidden"),t(c)},a.appendChild(u)}),i.classList.remove("hidden")}function cf(n,e){e.innerHTML="<strong>Players:</strong><br>",Object.values(n).forEach(t=>{const s=document.createElement("div");s.textContent=` ${t.name}`,e.appendChild(s)})}function df(n,e){e.innerHTML="",Object.values(n).sort((s,i)=>i.score-s.score).forEach((s,i)=>{const r=document.createElement("li");r.className="leaderboard-row",i===0&&r.classList.add("winner");const o=i+1;r.innerHTML=`
            <div style="display:flex; align-items:center;">
                <div class="rank-badge">${o}</div>
                <div class="player-info">
                    <span class="player-name">${s.name}</span>
                    <span class="player-details">
                        ${s.isGameOver?"Finished":"Playing"} 
                    </span>
                </div>
            </div>
            <div class="final-total">${s.score}</div>
        `,e.appendChild(r)})}function uf(n,e,t,s,i,r,o=[]){s.classList.remove("hidden"),i.innerHTML="";let a=null,l=null;if(o.length>1){const d=o.indexOf(t);if(d!==-1){const p=o.length;a=o[(d-1+p)%p],l=o[(d+1)%p]}}const c=[],u=[];if((o.length>0?o:Object.keys(n)).forEach(d=>{d!==t&&n[d]&&(d===a||d===l?c.push(d):u.push(d))}),c.length>0){const d=document.createElement("div");d.className="opponent-section-title",d.textContent="Your Neighbors",i.appendChild(d),c.forEach(p=>{const m=Hi(p,n[p],e,r,p===a,p===l);i.appendChild(m)})}if(u.length>0){const d=document.createElement("div");d.className="opponent-section-title",d.textContent="Other Towns",d.style.marginTop="15px",i.appendChild(d),u.forEach(p=>{const m=Hi(p,n[p],e,r,!1,!1);i.appendChild(m)})}}function Hi(n,e,t,s,i,r){const o=e.placedRound===t||e.isGameOver,a=o?"done":"thinking",l=n===s,c=document.createElement("div");c.className="opponent-card",l&&(c.style.border="2px solid #ff9800",c.style.background="#fff3e0");const u=document.createElement("div");u.className="opponent-name";const h=l?'<span title="Master Builder" style="font-size:1.2em; margin-right:4px;"></span>':"";let d=i?'<span title="Left Neighbor" style="font-size:1.2em; margin-right:6px;"></span>':"",p=r?'<span title="Right Neighbor" style="font-size:1.2em; margin-left:6px;"></span>':"";u.innerHTML=`
        <div style="display:flex; align-items:center;">
            ${d} ${h} ${e.name} ${p}
        </div>
        <span class="status-dot ${a}" title="${o?"Waiting":"Thinking"}"></span>
    `,c.appendChild(u);const m=document.createElement("div");m.className="mini-board";const _=e.board,E=_&&_.grid?_.grid:_;return E&&Array.isArray(E)&&E.forEach(k=>{k.forEach(A=>{const x=document.createElement("div");if(x.className="mini-cell",A!=="NONE")if(["WOOD","WHEAT","BRICK","GLASS","STONE"].includes(A))x.classList.add(A);else{const S=A.replace(/ /g,"-").replace(/'/g,"").toUpperCase();x.classList.add(S),x.title=A,["COTTAGE","FARM","GRANARY","GREENHOUSE","ORCHARD","WELL","FOUNTAIN","MILLSTONE","SHED","CHAPEL","ABBEY","CLOISTER","TEMPLE","TAVERN","ALMSHOUSE","INN","FEAST-HALL","THEATER","BAKERY","TAILOR","MARKET","FACTORY","BANK","WAREHOUSE","TRADING-POST"].includes(S)||x.classList.add("MONUMENT")}m.appendChild(x)})}),c.appendChild(m),c}function hf(n,e){n.innerHTML="";const t=document.createElement("div");t.className="setup-grid",e.forEach(s=>{const i=document.createElement("div");i.className="setup-group";const r=document.createElement("label");r.className="setup-label",r.textContent=s.label,i.appendChild(r);const o=document.createElement("select");o.className=`setup-select ${s.id}`,o.dataset.category=s.id;const a=document.createElement("option");a.value="RANDOM",a.textContent="Random",o.appendChild(a),s.options.forEach(l=>{const c=document.createElement("option");c.value=l.name,c.textContent=l.name,o.appendChild(c)}),i.appendChild(o),t.appendChild(i)}),n.appendChild(t)}function ff(n,e){const t=document.getElementById("resource-picker-modal"),s=document.getElementById("picker-title"),i=document.getElementById("picker-message"),r=document.getElementById("picker-options");s.textContent="Choose Your Monument",i.textContent="You have been granted two options. Choose one to construct in your town.",r.innerHTML="",r.style.display="flex",r.style.gap="20px",r.style.justifyContent="center",r.style.flexWrap="wrap",n.forEach(o=>{const a=document.createElement("div");a.className="monument-card-choice",a.style.border="2px solid #9c27b0",a.style.borderRadius="8px",a.style.padding="15px",a.style.cursor="pointer",a.style.background="white",a.style.width="180px",a.style.textAlign="center",a.style.transition="transform 0.2s",a.onmouseenter=()=>a.style.transform="scale(1.05)",a.onmouseleave=()=>a.style.transform="scale(1)",a.innerHTML=`
            <h4 style="color:#6a1b9a; margin:0 0 10px 0;">${o.name}</h4>
            <div class="mini-grid" style="margin: 0 auto 10px auto;">
                ${pf(o.pattern)}
            </div>
            <p style="font-size:0.8em; color:#555;">${o.description||"Unique Scoring"}</p>
        `,a.onclick=()=>{r.style.display="",r.style.gap="",r.style.justifyContent="",t.classList.add("hidden"),e(o)},r.appendChild(a)}),t.classList.remove("hidden")}function pf(n){let e='<div style="display:flex; flex-direction:column; gap:2px; align-items:center;">';return n.forEach(t=>{e+='<div style="display:flex; gap:2px;">',t.forEach(s=>{let i="transparent",r="1px solid transparent";s!=="NONE"&&(r="1px solid rgba(0,0,0,0.1)",s==="WOOD"&&(i="#5d4037"),s==="WHEAT"&&(i="#fdd835"),s==="BRICK"&&(i="#ef5350"),s==="GLASS"&&(i="#29b6f6"),s==="STONE"&&(i="#757575")),e+=`<div style="width:15px; height:15px; background:${i}; border:${r}; border-radius:2px;"></div>`}),e+="</div>"}),e+="</div>",e}function bo(n,e){const t=document.getElementById("resource-picker-modal"),s=document.getElementById("picker-title"),i=document.getElementById("picker-message"),r=document.getElementById("picker-options");s.textContent="Grove University Scholarship",i.textContent="Choose a building to construct immediately for free:",r.innerHTML="",r.parentElement&&(r.parentElement.style.maxWidth="600px",r.parentElement.style.width="95%"),r.style.display="flex",r.style.gap="15px",r.style.justifyContent="center",r.style.flexWrap="wrap",r.style.padding="10px",r.style.maxHeight="70vh",r.style.overflowY="auto",n.forEach(o=>{if(o.isMonument)return;const a=document.createElement("div");a.style.border="1px solid #e0e0e0",a.style.borderRadius="12px",a.style.padding="15px 10px",a.style.cursor="pointer",a.style.background="white",a.style.width="110px",a.style.height="130px",a.style.display="flex",a.style.flexDirection="column",a.style.alignItems="center",a.style.justifyContent="space-between",a.style.transition="all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1)",a.style.boxShadow="0 2px 5px rgba(0,0,0,0.05)";let l="#ccc";o.type==="RED"?l="#ef5350":o.type==="BLUE"?l="#42a5f5":o.type==="YELLOW"?l="#fdd835":o.type==="GREEN"?l="#66bb6a":o.type==="GRAY"?l="#bdbdbd":o.type==="ORANGE"?l="#ffca28":o.type==="BLACK"&&(l="#424242"),a.style.borderBottom=`5px solid ${l}`;const c=document.createElement("div");c.style.flex="1",c.style.display="flex",c.style.alignItems="center",c.style.justifyContent="center",c.style.width="100%";const u=document.createElement("div"),h=o.name.replace(/ /g,"-").replace(/'/g,"").toUpperCase();u.className=`mini-cell ${h}`,u.style.width="50px",u.style.height="50px",u.style.transform="none",u.style.margin="0",u.style.backgroundSize="contain",u.style.backgroundRepeat="no-repeat",u.style.backgroundPosition="center",u.style.border="none",c.appendChild(u);const d=document.createElement("span");d.textContent=o.name,d.style.fontSize="0.85em",d.style.fontWeight="600",d.style.color="#333",d.style.textAlign="center",d.style.marginTop="5px",a.appendChild(c),a.appendChild(d),a.onmouseenter=()=>{a.style.transform="translateY(-4px)",a.style.boxShadow="0 8px 15px rgba(0,0,0,0.1)"},a.onmouseleave=()=>{a.style.transform="translateY(0)",a.style.boxShadow="0 2px 5px rgba(0,0,0,0.05)"},a.onclick=()=>{r.style.display="",r.style.gap="",r.style.justifyContent="",r.style.maxHeight="",r.style.overflowY="",r.style.padding="",r.parentElement&&(r.parentElement.style.maxWidth="",r.parentElement.style.width=""),t.classList.add("hidden"),e(o)},r.appendChild(a)}),t.classList.remove("hidden")}function mf(n,e,t){const s=document.getElementById("resource-picker-modal"),i=document.getElementById("picker-title"),r=document.getElementById("picker-message"),o=document.getElementById("picker-options");i.textContent="Opaleye's Watch Setup",r.textContent=`Select exactly ${e} unique buildings to place on your Watch.`,o.innerHTML="",o.parentElement&&(o.parentElement.style.maxWidth="700px",o.parentElement.style.width="95%"),o.style.display="flex",o.style.gap="10px",o.style.justifyContent="center",o.style.flexWrap="wrap";const a=new Set,l="multi-picker-confirm-btn",c=()=>{Array.from(o.children).forEach(p=>{if(p.id===l)return;const m=p.dataset.name;a.has(m)?(p.style.border="3px solid #2e7d32",p.style.background="#e8f5e9",p.style.transform="scale(1.05)"):(p.style.border="1px solid #e0e0e0",p.style.background="white",p.style.transform="scale(1)")});const d=document.getElementById(l);d&&(d.disabled=a.size!==e,d.textContent=a.size!==e?`Select ${a.size}/${e}`:"Confirm Selection",d.style.opacity=a.size!==e?"0.5":"1")};n.forEach(d=>{if(d.isMonument||d.name==="Opaleye's Watch")return;const p=document.createElement("div");p.dataset.name=d.name,p.style.borderRadius="8px",p.style.padding="10px",p.style.cursor="pointer",p.style.width="100px",p.style.height="120px",p.style.display="flex",p.style.flexDirection="column",p.style.alignItems="center",p.style.textAlign="center",p.style.transition="all 0.2s";const m=document.createElement("div"),_=d.name.replace(/ /g,"-").replace(/'/g,"").toUpperCase();m.className=`mini-cell ${_}`,m.style.width="40px",m.style.height="40px",m.style.marginBottom="5px",m.style.backgroundSize="contain",m.style.border="none";const E=document.createElement("span");E.textContent=d.name,E.style.fontSize="0.75em",E.style.fontWeight="bold",p.appendChild(m),p.appendChild(E),p.onclick=()=>{a.has(d.name)?a.delete(d.name):a.size<e&&a.add(d.name),c()},o.appendChild(p)});const u=document.createElement("div");u.style.width="100%",u.style.marginTop="20px",u.style.textAlign="center";const h=document.createElement("button");h.id=l,h.className="primary-btn",h.textContent=`Select 0/${e}`,h.disabled=!0,h.onclick=()=>{o.parentElement&&(o.parentElement.style.maxWidth="",o.parentElement.style.width=""),s.classList.add("hidden"),t(Array.from(a))},u.appendChild(h),o.appendChild(u),s.classList.remove("hidden")}function gf(n,e){const t=document.getElementById("resource-picker-modal"),s=document.getElementById("picker-title"),i=document.getElementById("picker-message"),r=document.getElementById("picker-options");s.textContent="Opaleye's Watch Triggered!",i.innerHTML=`Your neighbor constructed a <strong>${n}</strong>.<br>You may place one immediately!`,r.innerHTML="",r.style.display="flex",r.style.flexDirection="column",r.style.alignItems="center",r.style.gap="20px";const o=document.createElement("div"),a=n.replace(/ /g,"-").replace(/'/g,"").toUpperCase();o.className=`mini-cell ${a}`,o.style.width="80px",o.style.height="80px",o.style.borderRadius="12px",o.style.boxShadow="0 4px 10px rgba(0,0,0,0.1)",o.style.backgroundSize="60%",o.style.border="2px solid #7b1fa2",r.appendChild(o);const l=document.createElement("button");l.className="primary-btn",l.textContent="Select Square to Build",l.onclick=()=>{r.style.display="",r.style.flexDirection="",r.style.alignItems="",r.style.gap="",t.classList.add("hidden"),e()},r.appendChild(l),t.classList.remove("hidden")}function _f(n,e,t){const s=document.getElementById("confirmation-modal"),i=document.getElementById("confirm-title"),r=document.getElementById("confirm-message"),o=document.getElementById("confirm-cancel-btn"),a=document.getElementById("confirm-ok-btn");!s||!i||!r||!o||!a||(i.textContent=n,r.textContent=e,o.onclick=()=>{s.classList.add("hidden")},a.onclick=()=>{s.classList.add("hidden"),t()},s.classList.remove("hidden"))}const C=new qa,ue=new Qa,T=new af(C),G=new lf;let _e=null,Rn=[],Be="",Dt=!1,un=!1,cs="",pe=null,Fe=0,Me=null,le=null;const y={startModal:document.getElementById("start-screen-modal"),landingUI:document.getElementById("landing-ui"),lobbyUI:document.getElementById("lobby-ui"),playerNameInput:document.getElementById("player-name-input"),createGameBtn:document.getElementById("create-game-ui-btn"),joinGameBtn:document.getElementById("join-game-btn"),gameIdInput:document.getElementById("game-id-input"),shareCodeDisplay:document.getElementById("share-code-display"),lobbyPlayerList:document.getElementById("lobby-player-list"),hostSettings:document.getElementById("host-settings"),guestWaitingMsg:document.getElementById("guest-waiting-msg"),startGameBtn:document.getElementById("start-game-btn"),multiplayerResultsModal:document.getElementById("multiplayer-results-modal"),leaderboardList:document.getElementById("leaderboard-list"),mpRestartBtn:document.getElementById("mp-restart-btn"),opponentsSidebar:document.getElementById("opponents-sidebar"),opponentsList:document.getElementById("opponents-list"),copyLinkBtn:document.getElementById("copy-link-btn"),gameOverModal:document.getElementById("game-over-modal"),finalScore:document.getElementById("final-score"),scoreList:document.getElementById("score-breakdown-list"),restartBtn:document.getElementById("restart-btn"),undoBtn:document.getElementById("undo-btn"),confirmBtn:document.getElementById("confirm-btn"),finishGuildBtn:document.getElementById("finish-guild-btn"),finishTownBtn:document.getElementById("finish-town-btn"),muteBtn:document.getElementById("mute-btn")},zs=[{id:"RED",label:"Farm (Red)",options:Ki},{id:"GRAY",label:"Well (Gray)",options:Yi},{id:"YELLOW",label:"Theater (Yellow)",options:ji},{id:"GREEN",label:"Tavern (Green)",options:zi},{id:"ORANGE",label:"Chapel (Orange)",options:Qi},{id:"BLACK",label:"Factory (Black)",options:qi}];T.onStateChange=n=>{try{if(n.status==="LOBBY"&&cf(n.players,y.lobbyPlayerList),n.status==="PLAYING"){y.startModal.classList.contains("hidden")||y.startModal.classList.add("hidden");const e=n.players?n.players[T.playerId]:null;if(e&&e.monumentOptions&&!e.monumentChosen){const c=document.getElementById("resource-picker-modal");if(c&&c.classList.contains("hidden")){const u=e.monumentOptions.map(h=>Xe.find(d=>d.name===h)).filter(h=>!!h);u.length>0&&ff(u,h=>{T.selectMonument(h.name)})}return}if(e&&e.activeMonument&&!C.activeMonument){const c=Xe.find(d=>d.name===e.activeMonument),h=(n.deck||[]).map(d=>mt.find(p=>p.name===d)).filter(d=>!!d);c&&(C.setMonument(c,h),ue.renderDeck(C.gameRegistry))}let t="Unknown";const s=n.playerOrder||[],i=Array.isArray(s)?s:Object.values(s);if(n.players&&uf(n.players,n.roundNumber||1,T.playerId,y.opponentsSidebar,y.opponentsList,wf(n),i),i.length>0&&n.players){const c=(n.masterBuilderIndex||0)%i.length,u=i[c];n.players[u]&&(t=n.players[u].name)}const r=T.masterBuilderId===T.playerId,o=n.currentResource!==void 0&&n.currentResource!==null,a=n.roundNumber||1,l=n.players?n.players[T.playerId]:null;l&&(Dt=Number(l.placedRound)===Number(a)),o?Dt?(Be="Waiting for other players to finish placing...",be(!1)):(Be="",be(!1)):r?(Be="YOU are the Master Builder! Choose a resource.",be(!0)):(Be=`Waiting for ${t} to choose a resource...`,be(!1))}n.status==="FINISHED"&&(y.gameOverModal.classList.add("hidden"),df(n.players,y.leaderboardList),y.multiplayerResultsModal.classList.remove("hidden")),C.currentResource=n.currentResource||null,U()}catch(e){console.error("Error in onStateChange:",e)}};T.onGameStart=()=>{y.startModal.classList.add("hidden"),U(),ue.renderDeck(C.gameRegistry)};ue.onResourceSelect=n=>{_e||(!C.currentResource||le&&le.type==="SELECT_RESOURCE"?(le={type:"SELECT_RESOURCE",data:n},C.currentResource=n,U()):console.log("Blocked: Resource already active:",C.currentResource))};ue.onCellClick=(n,e)=>{const s=C.board.getGrid()[n][e];if(pe){if(s!=="NONE"){N("You must choose an EMPTY square!","error",G);return}try{console.log(`[Main] Executing Free Build: ${pe}`),C.placeFreeBuilding(n,e,pe),Me&&(console.log(`[Main] Removing from Opaleye at ${Me.r},${Me.c}`),C.removeOpaleyeItem(Me.r,Me.c,pe),Me=null),pe=null,T.saveBoardOnly(),G.play("build"),U(),Ut(),N("Building constructed!","success")}catch(i){console.error("Error placing building:",i),N("Error placing building.","error",G)}return}if(Fe>0){if(!(s!=="NONE"&&!["WOOD","WHEAT","BRICK","GLASS","STONE"].includes(s))){N("You must select an existing building to replace!","error",G);return}bo(C.gameRegistry,r=>{try{C.replaceBuilding(n,e,r.name),Fe--,Fe>0?N("Replaced! Select one more building or click 'Done'.","success"):(N("Replacements complete.","success"),Ro()),T.saveBoardOnly(),U()}catch{N("Error replacing building.","error",G)}});return}if(s&&s.toUpperCase()==="WAREHOUSE"){Sf(n,e);return}try{_e?Cf(n,e):yf(n,e)}catch(i){N(i.message,"error",G)}};ue.onSwapClick=vf;async function yf(n,e){if(Dt){N("You have already placed a resource this turn!","error",G);return}if(le?.type==="SELECT_RESOURCE"){N("Please confirm your resource selection first!","error",G);return}if(!C.currentResource){N("Waiting for Master Builder...","info");return}const t=T.masterBuilderId===T.playerId;if(C.board.getGrid()[n][e].toUpperCase()==="COTTAGE"&&C.hasStatueOfBondmaker()){const r=C.board.getMetadata(n,e);if(r&&r.storedResource){N("This Cottage is already holding a resource!","error",G);return}if(t){N("The Bondmaker only works when OTHER players name a resource!","error",G);return}}try{C.placeResource(n,e),G.play("click"),await T.commitTurn(),U(),Ut()}catch(r){N(r.message,"error",G)}}ue.onBuildClick=n=>{_e=n,Rn=bf(n),U()};ue.onCancelClick=()=>{To(),U()};y.undoBtn.onclick=()=>{N("Undo not yet supported in Multiplayer!","info")};y.confirmBtn.onclick=async()=>{if(le)try{if(le.type==="SELECT_RESOURCE"){const n=le.data;await T.setGlobalResource(n),N(`Confirmed! Everyone must place ${n}.`,"success")}le=null,U()}catch(n){N("Error confirming: "+n,"error",G)}};y.mpRestartBtn.onclick=()=>{location.reload()};y.muteBtn.onclick=()=>{const n=G.toggleMute();y.muteBtn.textContent=n?"":""};y.createGameBtn.onclick=async()=>{const n=y.playerNameInput.value||"Host";try{const e=Io(),t=await T.createGame(n,e.map(s=>s.name));wo(t,!0)}catch(e){console.error("Firebase Error:",e),N("Error creating game.","error",G)}};y.joinGameBtn.onclick=async()=>{const n=y.playerNameInput.value||"Guest",e=y.gameIdInput.value.trim();if(!e){N("Please enter a code!","error",G);return}try{await T.joinGame(e,n),wo(e,!1)}catch(t){N("Could not join game: "+t,"error",G)}};y.startGameBtn.onclick=async()=>{const n=Ef();await T.updateDeck(n.map(e=>e.name)),await T.startGame()};y.shareCodeDisplay.onclick=()=>{const n=y.shareCodeDisplay.innerText.replace("Code: ","");navigator.clipboard.writeText(n),N("Code copied!","success")};y.restartBtn.onclick=()=>{location.reload()};y.copyLinkBtn.onclick=()=>{if(!cs)return;const n=`${window.location.origin}${window.location.pathname}?gameId=${cs}`;navigator.clipboard.writeText(n).then(()=>{N("Invite Link copied!","success")})};function wo(n,e){cs=n,y.landingUI.classList.add("hidden"),y.lobbyUI.classList.remove("hidden"),y.shareCodeDisplay.innerText=`Code: ${n}`,e?(y.hostSettings.classList.remove("hidden"),y.guestWaitingMsg.classList.add("hidden"),hf(document.getElementById("setup-container"),zs)):(y.hostSettings.classList.add("hidden"),y.guestWaitingMsg.classList.remove("hidden"))}function Ef(){const n=[ds],e=document.querySelectorAll(".setup-select");return e.length===0?Io():(e.forEach(t=>{const s=t.dataset.category;if(!s)return;const i=zs.find(o=>o.id===s);if(!i)return;let r;t.value==="RANDOM"?r=No(i.options):r=i.options.find(o=>o.name===t.value),r&&n.push(r)}),n)}function Io(){const n=[ds];return zs.forEach(e=>{n.push(No(e.options))}),n}function Cf(n,e){const s=C.board.getGrid()[n][e],i=Rn.some(c=>c.row===n&&c.col===e),r=_e?_e.buildingName.toUpperCase():"",l=(C.hasObeliskAbility()||r==="SHED")&&s==="NONE";if(i||l){if(s&&s.toUpperCase().replace("_"," ")==="TRADING POST"){N("Cannot build on Trading Post.","error",G);return}const c=C.constructBuilding(_e,n,e);if(T.saveBoardOnly(),To(),c.type==="TRIGGER_EFFECT"){if(c.effectType==="FACTORY")ls("Setup Factory","Choose a resource to store on your Factory:",u=>{C.setBuildingStorage(n,e,u),T.saveBoardOnly(),U()});else if(c.effectType==="BANK"){const u=C.getForbiddenResources();ls("Setup Bank",`Choose a resource to store on your Bank.
You will NOT be able to pick this resource as Master Builder!`,h=>{C.setBuildingStorage(n,e,h),T.saveBoardOnly(),U()},u)}else if(c.effectType==="ARCHITECTS_GUILD"){Fe=2,N("Architect's Guild: Select a building to replace (2 remaining).","info"),Be="Select a building to replace (or click Resource to skip)",T.saveBoardOnly(),U();return}else if(c.effectType==="GROVE_UNIVERSITY"){bo(C.gameRegistry,u=>{pe=u.name,N(`Select an empty square to build the ${u.name}.`,"success"),U()});return}else if(c.effectType==="OPALEYE_WATCH"){mf(C.gameRegistry,3,u=>{C.initializeOpaleye(n,e,u),T.saveBoardOnly(),U(),N("Opaleye's Watch prepared!","success")});return}}G.play("build"),U(),Ut()}}function vf(){ls("Factory Swap","Select the resource you want to use this turn:",async n=>{const e=C.currentResource;C.currentResource=n,N(`Factory activated! Swapped ${e} for ${n}.`,"success"),U()})}function Sf(n,e){if(Dt||!C.currentResource)return;const t=C.getWarehouseContents(n,e),s=t.length<3,i=C.currentResource,r=document.getElementById("resource-picker-modal"),o=document.getElementById("picker-options"),a=document.getElementById("picker-title"),l=document.getElementById("picker-message");if(a.textContent="Warehouse Manager",l.textContent=`Current Resource: ${i}`,o.innerHTML="",s){const c=document.createElement("button");c.className="primary-btn",c.style.width="100%",c.style.marginBottom="20px",c.innerHTML=` <strong>Store ${i}</strong> <br><span style="font-size:0.8em; font-weight:normal">(Ends Turn)</span>`,c.onclick=()=>{C.storeInWarehouse(n,e,i),$i(!0),r.classList.add("hidden")},o.appendChild(c)}else{const c=document.createElement("p");c.textContent="Warehouse Full (Max 3)",c.style.color="#d32f2f",c.style.fontWeight="bold",c.style.textAlign="center",o.appendChild(c)}if(t.length>0){const c=document.createElement("div");c.style.borderTop="1px solid #ddd",c.style.margin="15px 0",o.appendChild(c);const u=document.createElement("p");u.innerHTML=`Swap <strong>${i}</strong> for:`,u.style.textAlign="center",o.appendChild(u);const h=document.createElement("div");h.style.display="flex",h.style.gap="15px",h.style.justifyContent="center",t.forEach((d,p)=>{const m=document.createElement("div");m.style.display="flex",m.style.flexDirection="column",m.style.alignItems="center";const _=document.createElement("div");_.className=`res-btn ${d}`,_.textContent=d[0],_.style.cursor="pointer",_.onclick=()=>{const E=C.swapInWarehouse(n,e,p,i);E&&(C.currentResource=E,N(`Swapped! Place ${E} on the board.`,"success"),$i(!1),r.classList.add("hidden"))},m.appendChild(_),h.appendChild(m)}),o.appendChild(h)}r.classList.remove("hidden")}async function $i(n){try{n?await T.commitTurn():await T.saveBoardOnly(),U(),Ut()}catch(e){N("Error saving warehouse: "+e,"error",G)}}function To(){_e=null,Rn=[]}function bf(n){const e=[];return n.pattern.forEach((t,s)=>{t.forEach((i,r)=>{i!=="NONE"&&e.push({row:n.row+s,col:n.col+r})})}),e}function No(n){return n[Math.floor(Math.random()*n.length)]}function U(){let n=!1;if(C.currentResource&&!Dt){const l=T.masterBuilderId===T.playerId,c=C.canFactorySwap(C.currentResource);!l&&c&&(n=!0)}ue.toggleFactoryAction(n,C.currentResource||"");let e=[];T.masterBuilderId===T.playerId&&!C.currentResource&&(e=C.getForbiddenResources()),Fe>0?(y.finishGuildBtn.classList.remove("hidden"),y.finishGuildBtn.textContent=`Done Replacing (${Fe} left)`,be(!1),Be="Architect's Guild: Select a building to replace."):y.finishGuildBtn.classList.contains("hidden")||y.finishGuildBtn.classList.add("hidden");let s=Be;le&&le.type==="SELECT_RESOURCE"?(y.confirmBtn.classList.remove("hidden"),y.undoBtn.classList.add("hidden"),y.undoBtn.disabled=!0,be(!0),s=`Selected ${le.data}. Click Confirm or choose another.`):(y.confirmBtn.classList.add("hidden"),y.undoBtn.classList.add("hidden")),pe&&(s=` BONUS: Click an empty square for your ${pe}!`,be(!1));const i=T.myFinishRank||void 0,r=C.getScore(i),o=r.total+r.penaltyCount,a=i?` (Rank: ${i})`:"";document.getElementById("score-display").innerHTML=`Score: ${o} <span style="font-size:12px; color:#999">(-${r.penaltyCount} empty)</span>${a}`,un?y.finishTownBtn.classList.add("hidden"):y.finishTownBtn.classList.remove("hidden"),ue.render(C,_e,Rn,s,e)}function Ut(){if(!un&&C.checkGameOver()&&!_e){G.play("fanfare");const n=C.getScore();y.finalScore.textContent=n.total.toString(),y.scoreList.innerHTML="",Object.entries(n.breakdown).forEach(([e,t])=>{t!==0&&hn(e,t)}),n.penaltyCount>0&&hn("Empty Spaces",-n.penaltyCount,!0),y.gameOverModal.classList.remove("hidden"),T.declareGameOver(),un=!0,be(!1)}}function hn(n,e,t=!1){const s=document.createElement("li");s.className="score-item",t&&(s.classList.add("penalty-text"),s.style.color="#ef5350"),s.style.display="flex",s.style.justifyContent="space-between",s.innerHTML=`<span>${n.toLowerCase()}</span><strong>${e}</strong>`,y.scoreList.appendChild(s)}function wf(n){const e=n.playerOrder||[],t=Array.isArray(e)?e:Object.values(e);if(t.length>0){const s=(n.masterBuilderIndex||0)%t.length;return t[s]}return null}y.finishGuildBtn.onclick=()=>{Ro()};y.finishTownBtn.onclick=()=>{_f("Finish Town?","Are you sure you want to finish your town? You won't be able to place any more buildings.",()=>{T.declareGameOver().then(()=>{G.play("fanfare"),un=!0,U(),N("Town Finished!","success");const n=C.getScore(T.myFinishRank||void 0);y.finalScore.textContent=n.total.toString(),y.scoreList.innerHTML="",Object.entries(n.breakdown).forEach(([e,t])=>{t!==0&&hn(e,t)}),n.penaltyCount>0&&hn("Empty Spaces",-n.penaltyCount,!0),document.getElementById("game-over-modal").classList.remove("hidden")})})};T.onOpaleyeBonus=(n,e)=>{console.log(`[Main] Opaleye Bonus Received: ${n}`,e),gf(n,()=>{pe=n,Me=e,U(),N(`Select an empty square for your ${n}.`,"info")})};function Ro(){Fe=0,y.finishGuildBtn.classList.add("hidden"),T.commitTurn(),U(),Ut()}(function(){const t=new URLSearchParams(window.location.search).get("gameId");t&&(y.gameIdInput.value=t,y.playerNameInput.focus(),N(`Invite code ${t} detected! Enter your name to join.`,"success"),y.createGameBtn.parentElement?.classList.add("hidden"))})();window.setMonument=n=>{const e=Xe.find(s=>s.name.toUpperCase().includes(n.toUpperCase()));if(!e){console.error(`Could not find monument matching "${n}". Available:`,Xe.map(s=>s.name));return}console.log(`Force-switching monument to: ${e.name}`);const t=C.gameRegistry.filter(s=>!s.isMonument);C.setMonument(e,t),ue.renderDeck(C.gameRegistry),U(),T.gameId&&T.selectMonument(e.name),N(`Debug: Switched to ${e.name}`,"success")};console.log(" DEBUG MODE: Type setMonument('Statue') in console to switch monuments.");
