(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=t(i);fetch(i.href,r)}})();class mo{type="FACTORY";description="Stores a resource. Allows swapping that resource when chosen by others.";canSwap(e,t){return e===t}}const f={WOOD:"WOOD",WHEAT:"WHEAT",BRICK:"BRICK",GLASS:"GLASS",STONE:"STONE",NONE:"NONE"},Q={COTTAGE:"COTTAGE",TAVERN:"TAVERN",BARRETT_CASTLE:"BARRETT_CASTLE"};class _o{amount;constructor(e){this.amount=e}getFedPositions(e,t,s){return Array(this.amount).fill({r:-1,c:-1})}}class go{getFedPositions(e,t,s){const i=[];return[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]].forEach(([o,a])=>{const l=e+o,c=t+a;l>=0&&l<4&&c>=0&&c<4&&i.push({r:l,c})}),i}}class yo{getFedPositions(e,t,s){const o=new Set,a=[],l=(c,d)=>{const h=s[c][d];return h===Q.COTTAGE||h===Q.BARRETT_CASTLE};for(let c=0;c<4;c++)for(let d=0;d<4;d++){const h=`${c},${d}`;if(o.has(h)||!l(c,d))continue;const u=[],p=[{r:c,c:d}];for(o.add(h);p.length>0;){const _=p.pop();u.push(_);const g=[[-1,0],[1,0],[0,-1],[0,1]];for(const[w,M]of g){const E=_.r+w,b=_.c+M,x=`${E},${b}`;E>=0&&E<4&&b>=0&&b<4&&!o.has(x)&&l(E,b)&&(o.add(x),p.push({r:E,c:b}))}}a.push(u)}return a.length===0?[]:(a.sort((c,d)=>d.length-c.length),a[0])}}class Eo{getFedPositions(e,t,s){const i=[];for(let r=0;r<4;r++)r!==t&&i.push({r:e,c:r});for(let r=0;r<4;r++)r!==e&&i.push({r,c:t});return i}}class be{points;requiresFood;constructor(e,t=!1){this.points=e,this.requiresFood=t}score(e){return this.requiresFood&&!e.fedState?0:this.points}}class Co{targetTypes;pointsPerNeighbor;constructor(e,t){this.targetTypes=e,this.pointsPerNeighbor=t}score(e){let t=0;const s=[[-1,0],[1,0],[0,-1],[0,1]];for(const[i,r]of s){const o=e.row+i,a=e.col+r;if(o>=0&&o<4&&a>=0&&a<4){const l=e.grid[o][a];this.targetTypes.includes(l)&&(t+=this.pointsPerNeighbor)}}return t}}class vo{score(e){const t=new Set;for(let s=0;s<4;s++)s!==e.col&&this.addIfBuilding(t,e.grid[e.row][s]);for(let s=0;s<4;s++)s!==e.row&&this.addIfBuilding(t,e.grid[s][e.col]);return t.size}addIfBuilding(e,t){["NONE","WOOD","WHEAT","BRICK","GLASS","STONE"].includes(t)||e.add(t)}}class So{score(e){let t=0;return Object.values(e.counts).forEach(s=>{s===1&&(t+=1)}),t}}class Io{multiplier;constructor(e){this.multiplier=e}score(e){const t=new Set,s=[[-1,0],[1,0],[0,-1],[0,1]],i=["NONE","WOOD","WHEAT","BRICK","GLASS","STONE"];for(const[r,o]of s){const a=e.row+r,l=e.col+o;if(a>=0&&a<4&&l>=0&&l<4){const c=e.grid[a][l];i.includes(c)||t.add(c)}}return t.size*this.multiplier}}class bo{score(e){const t=`${e.row},${e.col}`,s=e.metadata.get(t);return s&&s.savedScore||0}}class wo{score(e){let t=0;for(const s of e.validBuildingNames){const i=s.toUpperCase();e.counts[i]||t++}return t*2}}class To{score(e){let t=0;const s=new Set,i=["NONE","WOOD","WHEAT","BRICK","GLASS","STONE"],r=[[-1,0],[1,0],[0,-1],[0,1]];for(let o=0;o<4;o++)for(let a=0;a<4;a++){const l=`${o},${a}`,c=e.grid[o][a];if(s.has(l)||i.includes(c))continue;let d=0;const h=[{r:o,c:a}];for(s.add(l);h.length>0;){const u=h.pop();d++;for(const[p,_]of r){const g=u.r+p,w=u.c+_,M=`${g},${w}`;g>=0&&g<4&&w>=0&&w<4&&!s.has(M)&&e.grid[g][w]===c&&(s.add(M),h.push({r:g,c:w}))}}d>t&&(t=d)}return 1+t}}class No{score(e){let t=0;for(let s=0;s<4;s++)for(let i=0;i<4;i++){const r=e.grid[s][i],o=`${s},${i}`;r==="COTTAGE"&&(e.allFedPositions.has(o)||t++)}return t*3}}class Ro{targetTypes;scoreAmount;constructor(e,t){this.targetTypes=e,this.scoreAmount=t}score(e){const t=[[-1,0],[1,0],[0,-1],[0,1]];for(const[s,i]of t){const r=e.row+s,o=e.col+i;if(r>=0&&r<4&&o>=0&&o<4){const a=e.grid[r][o];if(this.targetTypes.includes(a))return this.scoreAmount}}return 0}}class Ni{targetCategories;scoreAmount;constructor(e,t){this.targetCategories=e,this.scoreAmount=t}score(e){const t=[[-1,0],[1,0],[0,-1],[0,1]];for(const[s,i]of t){const r=e.row+s,o=e.col+i;if(r>=0&&r<4&&o>=0&&o<4){const a=e.grid[r][o],l=e.registry.find(c=>c.name.toUpperCase()===a.toUpperCase());if(l&&this.targetCategories.includes(l.type))return this.scoreAmount}}return 0}}class Ao{score(e){let t=0;const s=e.grid[e.row][e.col];for(let i=0;i<4;i++)i!==e.col&&e.grid[e.row][i]===s&&t++;for(let i=0;i<4;i++)i!==e.row&&e.grid[i][e.col]===s&&t++;return t}}class Oo{score(e){let t=1;const s=["1,1","1,2","2,1","2,2"],i=`${e.row},${e.col}`,r=e.grid[e.row][e.col];return s.forEach(o=>{if(o===i)return;const[a,l]=o.split(",").map(Number);e.grid[a][l]===r&&t++}),t}}class Do{score(e){const t=e.grid[e.row][e.col],s=e.counts[t]||e.counts[t.toUpperCase()]||0;return s===0?0:s%2!==0?-1:({2:5,4:15,6:26,8:40}[s]??s*5)/s}}class ko{score(e){const t=e.grid[e.row][e.col];for(let s=0;s<4;s++)if(s!==e.col&&e.grid[e.row][s]===t)return 0;for(let s=0;s<4;s++)if(s!==e.row&&e.grid[s][e.col]===t)return 0;return 3}}class Po{score(e){return e.fedCottageCount}}class Lo{requiredNeighbors;scoreAmount;constructor(e,t){this.requiredNeighbors=e,this.scoreAmount=t}score(e){let t=0;const s=[[-1,0],[1,0],[0,-1],[0,1]];for(const[i,r]of s){const o=e.row+i,a=e.col+r;o>=0&&o<4&&a>=0&&a<4&&e.allFedPositions.has(`${o},${a}`)&&t++}return t>=this.requiredNeighbors?this.scoreAmount:0}}class Mo{targetName;constructor(e){this.targetName=e}score(e){const t=[{r:0,c:0},{r:0,c:3},{r:3,c:0},{r:3,c:3}];let s=0;return t.forEach(i=>{e.grid[i.r][i.c]===this.targetName&&s++}),s}}class xo{restrictedCategories;scoreAmount;constructor(e,t){this.restrictedCategories=e,this.scoreAmount=t}score(e){const t=[[-1,0],[1,0],[0,-1],[0,1]];for(const[s,i]of t){const r=e.row+s,o=e.col+i;if(r>=0&&r<4&&o>=0&&o<4){const a=e.grid[r][o],l=e.registry.find(c=>c.name.toUpperCase()===a.toUpperCase());if(l&&this.restrictedCategories.includes(l.type))return 0}}return this.scoreAmount}}const Yn={name:"Cottage",type:"BLUE",pattern:[[f.NONE,f.WHEAT],[f.BRICK,f.GLASS]],scorer:new be(3,!0),feedCost:1,description:"3 points if fed."},Bo=[Yn],Fo={name:"Farm",type:"RED",pattern:[[f.WHEAT,f.WHEAT],[f.WOOD,f.WOOD]],feeder:new _o(4),description:"Feeds 4 cottages anywhere on the board."},Wo={name:"Granary",type:"RED",pattern:[[f.WHEAT,f.WHEAT],[f.WOOD,f.BRICK]],feeder:new go,description:"Feeds all buildings in the 8 squares surrounding it."},Go={name:"Greenhouse",type:"RED",pattern:[[f.WHEAT,f.GLASS],[f.WOOD,f.WOOD]],feeder:new yo,description:"Feeds one contiguous group of Cottages."},Uo={name:"Orchard",type:"RED",description:"Feeds Cottages in the same row and column.",pattern:[[f.STONE,f.WHEAT],[f.WHEAT,f.WOOD]],feeder:new Eo},Ri=[Fo,Wo,Go,Uo],Ho={name:"Well",type:"GRAY",pattern:[[f.WOOD,f.STONE]],description:"1 point for each adjacent cottage.",scorer:new Co([Q.COTTAGE,Q.BARRETT_CASTLE],1)},$o={name:"Fountain",type:"GRAY",description:"2 points if adjacent to a Cottage.",pattern:[[f.WOOD,f.STONE]],scorer:new Ro([Q.COTTAGE,Q.BARRETT_CASTLE],2)},Vo={name:"Millstone",type:"GRAY",description:"2 points if adjacent to a Red or Yellow building.",pattern:[[f.WOOD,f.STONE]],scorer:new Ni(["RED","YELLOW"],2)},Ko={name:"Shed",type:"GRAY",description:"Worth 1 point. (Standard placement rules apply).",pattern:[[f.WOOD,f.STONE]],scorer:new be(1)},Ai=[Ho,$o,Vo,Ko],zo={name:"Almshouse",type:"GREEN",pattern:[[f.STONE,f.STONE,f.GLASS]],description:"Score increasing points for each Almshouse you have built.",scorer:new Do},Yo={name:"Inn",type:"GREEN",pattern:[[f.WHEAT,f.STONE,f.GLASS]],description:"Get 3 points if not in a row or column with another Inn.",scorer:new ko},jo={name:"Feast Hall",type:"GREEN",pattern:[[f.WOOD,f.WOOD,f.GLASS]],description:"Get 2 points, and an extra 1 if you have more Feast Halls than the player on your right.",scorer:new be(2)},qo={name:"Tavern",type:"GREEN",pattern:[[f.BRICK,f.BRICK,f.GLASS]],description:"Score increasing points for each Tavern you have built."},Oi=[qo,Yo,zo,jo],Qo={name:"Theater",type:"YELLOW",pattern:[[f.NONE,f.STONE,f.NONE],[f.WOOD,f.GLASS,f.WOOD]],scorer:new vo,description:"1 point for each unique building type in the same row and column."},Xo={name:"Bakery",type:"YELLOW",description:"3 points if adjacent to a Food (Red) building.",pattern:[[f.NONE,f.WHEAT,f.NONE],[f.BRICK,f.GLASS,f.BRICK]],scorer:new Ni(["RED"],3)},Jo={name:"Market",type:"YELLOW",description:"1 point for each other Market in the same row or column.",pattern:[[f.NONE,f.WOOD,f.NONE],[f.STONE,f.GLASS,f.STONE]],scorer:new Ao},Zo={name:"Tailor",type:"YELLOW",description:"1 point. +1 point for each other Tailor in the 4 center squares.",pattern:[[f.NONE,f.WHEAT,f.NONE],[f.STONE,f.GLASS,f.STONE]],scorer:new Oo},Di=[Qo,Xo,Jo,Zo],ea={name:"Factory",type:"BLACK",pattern:[[f.WOOD,f.NONE,f.NONE,f.NONE],[f.BRICK,f.STONE,f.STONE,f.BRICK]],description:"Place 1 resource on the factory, whenever another player chooses that resource, play a different one instead.",effect:new mo},ta={name:"Trading Post",type:"BLACK",description:"1 point. Counts as a WILD (any) resource for future buildings.",pattern:[[f.STONE,f.STONE,f.NONE],[f.WOOD,f.WOOD,f.BRICK]],scorer:new be(1)},na={name:"Bank",type:"BLACK",description:"4 points. Place a resource on this building - you can no longer select this resource as master builder.",pattern:[[f.STONE,f.STONE,f.NONE],[f.WOOD,f.WOOD,f.BRICK]],scorer:new be(4)},sa={name:"Warehouse",type:"BLACK",description:"-1 for each resource on this building. YADA YADA YADA",pattern:[[f.STONE,f.STONE,f.NONE],[f.WOOD,f.WOOD,f.BRICK]],scorer:new be(1)},ki=[ea,ta,na,sa],ia={name:"Chapel",type:"ORANGE",pattern:[[f.NONE,f.NONE,f.GLASS],[f.STONE,f.GLASS,f.STONE]],description:"Scores 1 point for each fed cottage.",scorer:new Po},ra={name:"Abbey",type:"ORANGE",pattern:[[f.NONE,f.NONE,f.GLASS],[f.BRICK,f.STONE,f.STONE]],description:"3 points if not adjacent to a black, green or yellow building.",scorer:new xo(["BLACK","GREEN","YELLOW"],3)},oa={name:"Cloister",type:"ORANGE",pattern:[[f.NONE,f.NONE,f.GLASS],[f.WOOD,f.BRICK,f.STONE]],description:"Scores 1 point for each cloister in a corner of your town.",scorer:new Mo("CLOISTER")},aa={name:"Temple",type:"ORANGE",pattern:[[f.NONE,f.NONE,f.GLASS],[f.BRICK,f.BRICK,f.STONE]],description:"4 points if adjacent to 2 or more fed cottages.",scorer:new Lo(2,4)},Pi=[ia,ra,oa,aa],la={name:"Archive",type:"PURPLE",pattern:[[f.WHEAT,f.WHEAT],[f.BRICK,f.GLASS]],scorer:new So,isMonument:!0},ca={name:"Barrett Castle",type:"PURPLE",pattern:[[f.WHEAT,f.NONE,f.NONE,f.STONE],[f.WOOD,f.GLASS,f.GLASS,f.BRICK]],scorer:new be(5,!0),feedCost:1,countsAs:[Q.COTTAGE],isMonument:!0},ha={name:"Obelisk of the Crescent",type:"PURPLE",pattern:[[f.WHEAT,f.NONE,f.NONE],[f.BRICK,f.GLASS,f.BRICK]],isMonument:!0},ua={name:"Mandras",type:"PURPLE",pattern:[[f.WHEAT,f.GLASS],[f.BRICK,f.WOOD]],scorer:new Io(2),isMonument:!0},da={name:"Shrine of the Elder Tree",type:"PURPLE",pattern:[[f.BRICK,f.WHEAT,f.STONE],[f.WOOD,f.GLASS,f.WOOD]],isMonument:!0,scorer:new bo},fa={name:"Baths",type:"PURPLE",pattern:[[f.NONE,f.WHEAT,f.NONE],[f.STONE,f.GLASS,f.WOOD],[f.BRICK,f.NONE,f.BRICK]],isMonument:!0,scorer:new wo},pa={name:"Forum",type:"PURPLE",pattern:[[f.NONE,f.NONE,f.WHEAT,f.NONE],[f.BRICK,f.BRICK,f.STONE,f.WOOD]],isMonument:!0,scorer:new To},ma={name:"Mausoleum",type:"PURPLE",pattern:[[f.WOOD,f.WOOD],[f.BRICK,f.STONE]],isMonument:!0,scorer:new No},_a={name:"Cathedral",type:"PURPLE",pattern:[[f.NONE,f.WHEAT],[f.STONE,f.GLASS]],isMonument:!0,scorer:new be(2,!1)},ga=[la,ca,ha,ua,da,fa,pa,ma,_a],it=[...Bo,...Ri,...Ai,...Oi,...Di,...ki,...Pi,...ga];class Os{grid;size=4;metadata=new Map;constructor(){this.grid=Array(this.size).fill(null).map(()=>Array(this.size).fill(f.NONE))}place(e,t,s){if(!this.isValid(e,t))throw new Error(`Invalid coordinate: ${e}, ${t}`);if(this.grid[e][t]!==f.NONE)throw new Error("Spot already occupied");this.grid[e][t]=s}placeBuilding(e,t,s){this.isValid(e,t)&&(this.grid[e][t]=s)}constructBuilding(e,t,s,i){if(!e.some(o=>o.row===t&&o.col===s)&&this.grid[t][s]!=="NONE")throw new Error("Building must be placed on one of the pattern squares.");this.clear(e),this.grid[t][s]=i}clear(e){e.forEach(({row:t,col:s})=>{this.isValid(t,s)&&(this.grid[t][s]=f.NONE,this.metadata.delete(`${t},${s}`))})}getGrid(){return this.grid.map(e=>[...e])}isValid(e,t){return e>=0&&e<this.size&&t>=0&&t<this.size}remove(e,t){this.isValid(e,t)&&(this.grid[e][t]="NONE",this.metadata.delete(`${e},${t}`))}setMetadata(e,t,s){this.metadata.set(`${e},${t}`,s)}getMetadata(e,t){return this.metadata.get(`${e},${t}`)}}class ya{static rotate(e){return e[0].map((t,s)=>e.map(i=>i[s]).reverse())}static flip(e){return e.map(t=>[...t].reverse())}static getSymmetries(e){const t=new Set;let s=e;for(let i=0;i<4;i++)t.add(JSON.stringify(s)),t.add(JSON.stringify(this.flip(s))),s=this.rotate(s);return Array.from(t).map(i=>JSON.parse(i))}static findMatches(e,t){const s=this.getSymmetries(t.pattern),i=[];for(const r of s){const o=r.length,a=r[0].length;for(let l=0;l<=4-o;l++)for(let c=0;c<=4-a;c++)this.isMatch(e,r,l,c)&&i.push({row:l,col:c,pattern:r})}return i}static isMatch(e,t,s,i){return t.every((r,o)=>r.every((a,l)=>{const c=e[s+o][i+l];return!!(a==="NONE"||c===a||c&&c.toUpperCase().replace("_"," ")==="TRADING POST")}))}}class Ea{static calculateScore(e,t,s){const o={},a=E=>s.find(b=>b.name.toUpperCase()===E.toUpperCase()),l={};let c=0,d=0;const h=new Set;for(let E=0;E<4;E++)for(let b=0;b<4;b++){const x=e[E][b];if(!this.isBuilding(x)){c++;continue}l[x]=(l[x]||0)+1;const q=a(x);if(q&&q.feeder){const ie=q.feeder.getFedPositions(E,b,e);ie.length>0&&ie[0].r===-1?d+=ie.length:ie.forEach(fe=>h.add(`${fe.r},${fe.c}`))}}const u=new Set;let p=0;for(let E=0;E<4;E++)for(let b=0;b<4;b++){const x=e[E][b];if(!this.isBuilding(x))continue;const q=a(x);if(q&&q.feedCost){const ie=`${E},${b}`;let fe=!1;h.has(ie)?fe=!0:d>=q.feedCost&&(d-=q.feedCost,fe=!0),fe&&(u.add(ie),x===Q.COTTAGE&&p++,x===Q.BARRETT_CASTLE&&(p+=2))}}const _=s.map(E=>E.name);for(let E=0;E<4;E++)for(let b=0;b<4;b++){const x=e[E][b];if(!this.isBuilding(x))continue;const q=a(x);if(q&&q.scorer){const ie={grid:e,row:E,col:b,counts:l,fedState:u.has(`${E},${b}`),metadata:t,validBuildingNames:_,allFedPositions:u,registry:s,fedCottageCount:p},fe=q.scorer.score(ie);o[x]=(o[x]||0)+fe}}if(l[Q.TAVERN]){const E=[0,2,5,9,14,20],b=Math.min(l[Q.TAVERN],5);o[Q.TAVERN]=E[b]}let g=0;Object.values(o).forEach(E=>g+=E);const M=(l.CATHEDRAL||0)>0?0:c;return{total:g-M,breakdown:o,penaltyCount:M}}static isBuilding(e){return!["NONE","WOOD","WHEAT","BRICK","GLASS","STONE"].includes(e)}}class Ca{board;currentResource=null;availableMatches=[];activeMonument=null;gameRegistry=[];lastMove=null;constructor(){this.board=new Os}start(){if(this.board=new Os,this.currentResource=null,this.lastMove=null,this.availableMatches=[],this.gameRegistry.length===0){const e=it.filter(s=>s.isMonument),t=it.filter(s=>!s.isMonument);this.activeMonument=e[Math.floor(Math.random()*e.length)],this.gameRegistry=[...t,this.activeMonument]}}placeResource(e,t){if(!this.currentResource)throw new Error("No resource selected");this.board.place(e,t,this.currentResource),this.lastMove={r:e,c:t},this.currentResource=null,this.scanForMatches()}constructBuilding(e,t,s){const i=[];let r=0,o=!1;if(e.pattern.forEach((l,c)=>{l.forEach((d,h)=>{d&&d!=="NONE"&&i.push({row:e.row+c,col:e.col+h})})}),e.buildingName.toUpperCase()==="SHRINE OF THE ELDER TREE"){o=!0;const c=this.countBuildingsOnBoard()+1;c<6?r=c:r=8}i.forEach(l=>{const c=this.board.getGrid()[l.row][l.col];c&&c.toUpperCase().replace("_"," ")==="TRADING POST"||this.board.remove(l.row,l.col)}),this.board.placeBuilding(t,s,e.buildingName),o&&this.board.setMetadata(t,s,{savedScore:r}),this.lastMove=null,this.scanForMatches();const a=it.find(l=>l.name.toUpperCase()===e.buildingName.toUpperCase());return a&&a.effect?{type:"TRIGGER_EFFECT",effectType:a.effect.type}:{type:"SUCCESS"}}undo(){this.lastMove&&(this.board.remove(this.lastMove.r,this.lastMove.c),this.lastMove=null,this.scanForMatches())}canUndo(){return this.lastMove!==null}scanForMatches(){this.availableMatches=[];const e=this.board.getGrid(),t=e.some(s=>s.some(i=>this.gameRegistry.find(o=>o.name.toUpperCase()===i.toUpperCase())?.isMonument));for(const s of this.gameRegistry){if(t&&s.isMonument)continue;ya.findMatches(e,s).forEach(r=>{this.availableMatches.push({...r,buildingName:s.name.toUpperCase()})})}}checkGameOver(){const t=this.board.getGrid().some(i=>i.some(r=>r==="NONE")),s=this.availableMatches.length>0;return!t&&!s}getScore(){return Ea.calculateScore(this.board.getGrid(),this.board.metadata,this.gameRegistry)}countBuildingsOnBoard(){const e=this.board.getGrid();let t=0;const s=["WOOD","WHEAT","BRICK","GLASS","STONE","NONE"];return e.forEach(i=>{i.forEach(r=>{s.includes(r)||t++})}),t}hasObeliskAbility(){return this.board.getGrid().some(t=>t.some(s=>s.toUpperCase().includes("OBELISK")))}findEffectBuildings(e){const t=this.board.getGrid(),s=[];return t.forEach((i,r)=>{i.forEach((o,a)=>{if(["WOOD","WHEAT","BRICK","GLASS","STONE","NONE"].includes(o))return;const l=this.gameRegistry.find(c=>c.name.toUpperCase()===o.toUpperCase());if(l&&l.effect&&l.effect.type===e){const c=this.board.getMetadata(r,a);c&&c.storedResource&&s.push({r,c:a,storedRes:c.storedResource})}})}),s}setBuildingStorage(e,t,s){this.board.setMetadata(e,t,{storedResource:s})}canFactorySwap(e){const s=this.findEffectBuildings("FACTORY").find(i=>i.storedRes===e);return s?{r:s.r,c:s.c}:null}}class va{boardEl=document.getElementById("board");buildMenuEl=document.getElementById("build-menu");msgLabel=document.getElementById("message");paletteEl=document.getElementById("resource-palette");scoreEl=document.getElementById("score-display");undoBtn=document.getElementById("undo-btn");deckDisplayEl=document.getElementById("deck-display");factoryBar=document.getElementById("factory-action-bar");swapBtn=document.getElementById("factory-swap-btn");swapResLabel=document.getElementById("swap-res-name");onCellClick=()=>{};onResourceSelect=()=>{};onBuildClick=()=>{};onCancelClick=()=>{};onSwapClick=()=>{};constructor(){this.swapBtn.onclick=()=>this.onSwapClick()}render(e,t,s,i){this.renderHeader(e),this.renderBoard(e,t,s,i),this.renderSidebar(e,t),this.renderControls(e,t)}renderHeader(e){const t=e.getScore(),s=t.total+t.penaltyCount;this.scoreEl.innerHTML=`Score: ${s} <span style="font-size:12px; color:#999">(-${t.penaltyCount} empty)</span>`}renderBoard(e,t,s,i){const r=e.board.getGrid(),o=["WOOD","WHEAT","BRICK","GLASS","STONE"];this.boardEl.children.length===0&&r.forEach((l,c)=>{l.forEach((d,h)=>{const u=document.createElement("div");u.dataset.r=c.toString(),u.dataset.c=h.toString(),u.onclick=()=>this.onCellClick(c,h),this.boardEl.appendChild(u)})}),Array.from(this.boardEl.children).forEach(l=>{const c=parseInt(l.dataset.r),d=parseInt(l.dataset.c),h=r[c][d];if(l.className="cell",l.style.backgroundColor="",l.innerHTML="",h==="NONE")l.classList.add("empty");else if(o.includes(h))l.classList.add(h),l.textContent=h;else{const p=e.gameRegistry.find(_=>_.name.toUpperCase()===h.toUpperCase());if(p){if(l.classList.add("constructed"),p.isMonument)l.classList.add("MONUMENT");else{const _=h.replace(/ /g,"-").replace(/'/g,"").toUpperCase();l.classList.add(_)}p.color&&(l.style.backgroundColor=p.color)}}const u=e.board.getMetadata(c,d);if(u&&u.storedResource){const p=document.createElement("div");p.className=`stored-resource-icon ${u.storedResource}`,p.title=`Stored: ${u.storedResource}`,l.appendChild(p)}if(t){const p=s.some(E=>E.row===c&&E.col===d),_=e.hasObeliskAbility(),g=t.buildingName.toUpperCase()==="SHED",w=(_||g)&&h==="NONE",M=h&&h.toUpperCase().replace("_"," ")==="TRADING POST";(p&&!M||w)&&l.classList.add("match-highlight")}h==="NONE"&&e.currentResource&&!t?(l.onmouseenter=()=>{l.classList.add("ghost",e.currentResource)},l.onmouseleave=()=>{l.classList.remove("ghost","WOOD","WHEAT","BRICK","GLASS","STONE")}):(l.onmouseenter=null,l.onmouseleave=null)}),t?(this.msgLabel.textContent=`Select a highlighted square to build your ${t.buildingName}!`,this.msgLabel.style.color="#d32f2f"):i?(this.msgLabel.textContent=i,i.includes("Waiting")?this.msgLabel.style.color="#d32f2f":i.includes("YOU")?this.msgLabel.style.color="#2e7d32":this.msgLabel.style.color="#333"):e.availableMatches.length>0?(this.msgLabel.textContent="Matches available!",this.msgLabel.style.color="#333"):e.currentResource?(this.msgLabel.textContent=`Place ${e.currentResource}...`,this.msgLabel.style.color="#333"):(this.msgLabel.textContent="Select a Resource...",this.msgLabel.style.color="#1976d2")}renderSidebar(e,t){if(this.buildMenuEl.innerHTML="",e.availableMatches.length===0){const s=document.createElement("p");s.textContent="No patterns found.",s.style.color="#777",s.style.fontStyle="italic",this.buildMenuEl.appendChild(s)}else e.availableMatches.forEach(s=>{const i=document.createElement("button");i.textContent=`Build ${s.buildingName}`;const r=s.buildingName.replace(/ /g,"-").replace(/'/g,"").toUpperCase();i.className=`build-btn ${r}`,i.onclick=()=>this.onBuildClick(s);const o=[];s.pattern&&Array.isArray(s.pattern)?s.pattern.forEach((a,l)=>{a.forEach((c,d)=>{c&&c!=="NONE"&&o.push({row:s.row+l,col:s.col+d})})}):o.push({row:s.row,col:s.col}),i.onmouseenter=()=>this.togglePreview(o,!0),i.onmouseleave=()=>this.togglePreview(o,!1),this.buildMenuEl.appendChild(i)});if(t){const s=document.createElement("button");s.textContent="Cancel Construction",s.className="secondary-btn",s.style.marginTop="10px",s.style.width="100%",s.onclick=()=>this.onCancelClick(),this.buildMenuEl.appendChild(s)}}togglePreview(e,t){e.forEach(s=>{const i=`div[data-r="${s.row}"][data-c="${s.col}"]`,r=this.boardEl.querySelector(i);r&&(t?r.classList.add("preview-target"):r.classList.remove("preview-target"))})}renderControls(e,t){this.paletteEl.innerHTML="",[f.WOOD,f.WHEAT,f.BRICK,f.GLASS,f.STONE].forEach(i=>{const r=document.createElement("div");let o=`res-btn ${i}`;e.currentResource===i&&!t&&(o+=" selected"),r.className=o,r.textContent=i.charAt(0),r.onclick=()=>this.onResourceSelect(i),this.paletteEl.appendChild(r)}),e.canUndo()&&!t?this.undoBtn.removeAttribute("disabled"):this.undoBtn.setAttribute("disabled","true")}renderDeck(e){this.deckDisplayEl&&(this.deckDisplayEl.innerHTML="",e.forEach(t=>{const s=document.createElement("div");t.isMonument?s.className="building-card MONUMENT":s.className=`building-card ${t.name.toUpperCase()}`;const i=document.createElement("header");i.className="card-header";const r=document.createElement("span");r.textContent=t.name;const o=document.createElement("div"),a=t.name.replace(/ /g,"-").replace(/'/g,"").toUpperCase();o.className=`card-icon ${a}`,i.appendChild(r),i.appendChild(o),s.appendChild(i);const l=document.createElement("div");l.className="card-body";const c=document.createElement("div");c.className="mini-pattern";const d=t.pattern[0].length;c.style.gridTemplateColumns=`repeat(${d}, 15px)`,t.pattern.forEach(u=>{u.forEach(p=>{const _=document.createElement("div"),g=p==="NONE"?"pattern-empty":p;_.className=`pattern-cell ${g}`,c.appendChild(_)})});const h=document.createElement("div");h.className="card-text",h.textContent=t.description||"Unique scoring rules.",l.appendChild(c),l.appendChild(h),s.appendChild(l),this.deckDisplayEl.appendChild(s)}))}toggleFactoryAction(e,t=""){e?(this.factoryBar.classList.remove("hidden"),this.swapResLabel.textContent=t):this.factoryBar.classList.add("hidden")}}const Sa=()=>{};var Ds={};const Li={NODE_ADMIN:!1,SDK_VERSION:"${JSCORE_VERSION}"};const m=function(n,e){if(!n)throw Ye(e)},Ye=function(n){return new Error("Firebase Database ("+Li.SDK_VERSION+") INTERNAL ASSERT FAILED: "+n)};const Mi=function(n){const e=[];let t=0;for(let s=0;s<n.length;s++){let i=n.charCodeAt(s);i<128?e[t++]=i:i<2048?(e[t++]=i>>6|192,e[t++]=i&63|128):(i&64512)===55296&&s+1<n.length&&(n.charCodeAt(s+1)&64512)===56320?(i=65536+((i&1023)<<10)+(n.charCodeAt(++s)&1023),e[t++]=i>>18|240,e[t++]=i>>12&63|128,e[t++]=i>>6&63|128,e[t++]=i&63|128):(e[t++]=i>>12|224,e[t++]=i>>6&63|128,e[t++]=i&63|128)}return e},Ia=function(n){const e=[];let t=0,s=0;for(;t<n.length;){const i=n[t++];if(i<128)e[s++]=String.fromCharCode(i);else if(i>191&&i<224){const r=n[t++];e[s++]=String.fromCharCode((i&31)<<6|r&63)}else if(i>239&&i<365){const r=n[t++],o=n[t++],a=n[t++],l=((i&7)<<18|(r&63)<<12|(o&63)<<6|a&63)-65536;e[s++]=String.fromCharCode(55296+(l>>10)),e[s++]=String.fromCharCode(56320+(l&1023))}else{const r=n[t++],o=n[t++];e[s++]=String.fromCharCode((i&15)<<12|(r&63)<<6|o&63)}}return e.join("")},jn={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:typeof atob=="function",encodeByteArray(n,e){if(!Array.isArray(n))throw Error("encodeByteArray takes an array as a parameter");this.init_();const t=e?this.byteToCharMapWebSafe_:this.byteToCharMap_,s=[];for(let i=0;i<n.length;i+=3){const r=n[i],o=i+1<n.length,a=o?n[i+1]:0,l=i+2<n.length,c=l?n[i+2]:0,d=r>>2,h=(r&3)<<4|a>>4;let u=(a&15)<<2|c>>6,p=c&63;l||(p=64,o||(u=64)),s.push(t[d],t[h],t[u],t[p])}return s.join("")},encodeString(n,e){return this.HAS_NATIVE_SUPPORT&&!e?btoa(n):this.encodeByteArray(Mi(n),e)},decodeString(n,e){return this.HAS_NATIVE_SUPPORT&&!e?atob(n):Ia(this.decodeStringToByteArray(n,e))},decodeStringToByteArray(n,e){this.init_();const t=e?this.charToByteMapWebSafe_:this.charToByteMap_,s=[];for(let i=0;i<n.length;){const r=t[n.charAt(i++)],a=i<n.length?t[n.charAt(i)]:0;++i;const c=i<n.length?t[n.charAt(i)]:64;++i;const h=i<n.length?t[n.charAt(i)]:64;if(++i,r==null||a==null||c==null||h==null)throw new ba;const u=r<<2|a>>4;if(s.push(u),c!==64){const p=a<<4&240|c>>2;if(s.push(p),h!==64){const _=c<<6&192|h;s.push(_)}}}return s},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let n=0;n<this.ENCODED_VALS.length;n++)this.byteToCharMap_[n]=this.ENCODED_VALS.charAt(n),this.charToByteMap_[this.byteToCharMap_[n]]=n,this.byteToCharMapWebSafe_[n]=this.ENCODED_VALS_WEBSAFE.charAt(n),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[n]]=n,n>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(n)]=n,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(n)]=n)}}};class ba extends Error{constructor(){super(...arguments),this.name="DecodeBase64StringError"}}const xi=function(n){const e=Mi(n);return jn.encodeByteArray(e,!0)},Pt=function(n){return xi(n).replace(/\./g,"")},Tn=function(n){try{return jn.decodeString(n,!0)}catch(e){console.error("base64Decode failed: ",e)}return null};function wa(n){return Bi(void 0,n)}function Bi(n,e){if(!(e instanceof Object))return e;switch(e.constructor){case Date:const t=e;return new Date(t.getTime());case Object:n===void 0&&(n={});break;case Array:n=[];break;default:return e}for(const t in e)!e.hasOwnProperty(t)||!Ta(t)||(n[t]=Bi(n[t],e[t]));return n}function Ta(n){return n!=="__proto__"}function Na(){if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global;throw new Error("Unable to locate global object.")}const Ra=()=>Na().__FIREBASE_DEFAULTS__,Aa=()=>{if(typeof process>"u"||typeof Ds>"u")return;const n=Ds.__FIREBASE_DEFAULTS__;if(n)return JSON.parse(n)},Oa=()=>{if(typeof document>"u")return;let n;try{n=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch{return}const e=n&&Tn(n[1]);return e&&JSON.parse(e)},Fi=()=>{try{return Sa()||Ra()||Aa()||Oa()}catch(n){console.info(`Unable to get __FIREBASE_DEFAULTS__ due to: ${n}`);return}},Da=n=>Fi()?.emulatorHosts?.[n],ka=n=>{const e=Da(n);if(!e)return;const t=e.lastIndexOf(":");if(t<=0||t+1===e.length)throw new Error(`Invalid host ${e} with no separate hostname and port!`);const s=parseInt(e.substring(t+1),10);return e[0]==="["?[e.substring(1,t-1),s]:[e.substring(0,t),s]},Wi=()=>Fi()?.config;class ne{constructor(){this.reject=()=>{},this.resolve=()=>{},this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}wrapCallback(e){return(t,s)=>{t?this.reject(t):this.resolve(s),typeof e=="function"&&(this.promise.catch(()=>{}),e.length===1?e(t):e(t,s))}}}function qn(n){try{return(n.startsWith("http://")||n.startsWith("https://")?new URL(n).hostname:n).endsWith(".cloudworkstations.dev")}catch{return!1}}async function Pa(n){return(await fetch(n,{credentials:"include"})).ok}function La(n,e){if(n.uid)throw new Error('The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.');const t={alg:"none",type:"JWT"},s=e||"demo-project",i=n.iat||0,r=n.sub||n.user_id;if(!r)throw new Error("mockUserToken must contain 'sub' or 'user_id' field!");const o={iss:`https://securetoken.google.com/${s}`,aud:s,iat:i,exp:i+3600,auth_time:i,sub:r,user_id:r,firebase:{sign_in_provider:"custom",identities:{}},...n};return[Pt(JSON.stringify(t)),Pt(JSON.stringify(o)),""].join(".")}const rt={};function Ma(){const n={prod:[],emulator:[]};for(const e of Object.keys(rt))rt[e]?n.emulator.push(e):n.prod.push(e);return n}function xa(n){let e=document.getElementById(n),t=!1;return e||(e=document.createElement("div"),e.setAttribute("id",n),t=!0),{created:t,element:e}}let ks=!1;function Ba(n,e){if(typeof window>"u"||typeof document>"u"||!qn(window.location.host)||rt[n]===e||rt[n]||ks)return;rt[n]=e;function t(u){return`__firebase__banner__${u}`}const s="__firebase__banner",r=Ma().prod.length>0;function o(){const u=document.getElementById(s);u&&u.remove()}function a(u){u.style.display="flex",u.style.background="#7faaf0",u.style.position="fixed",u.style.bottom="5px",u.style.left="5px",u.style.padding=".5em",u.style.borderRadius="5px",u.style.alignItems="center"}function l(u,p){u.setAttribute("width","24"),u.setAttribute("id",p),u.setAttribute("height","24"),u.setAttribute("viewBox","0 0 24 24"),u.setAttribute("fill","none"),u.style.marginLeft="-6px"}function c(){const u=document.createElement("span");return u.style.cursor="pointer",u.style.marginLeft="16px",u.style.fontSize="24px",u.innerHTML=" &times;",u.onclick=()=>{ks=!0,o()},u}function d(u,p){u.setAttribute("id",p),u.innerText="Learn more",u.href="https://firebase.google.com/docs/studio/preview-apps#preview-backend",u.setAttribute("target","__blank"),u.style.paddingLeft="5px",u.style.textDecoration="underline"}function h(){const u=xa(s),p=t("text"),_=document.getElementById(p)||document.createElement("span"),g=t("learnmore"),w=document.getElementById(g)||document.createElement("a"),M=t("preprendIcon"),E=document.getElementById(M)||document.createElementNS("http://www.w3.org/2000/svg","svg");if(u.created){const b=u.element;a(b),d(w,g);const x=c();l(E,M),b.append(E,_,w,x),document.body.appendChild(b)}r?(_.innerText="Preview backend disconnected.",E.innerHTML=`<g clip-path="url(#clip0_6013_33858)">
<path d="M4.8 17.6L12 5.6L19.2 17.6H4.8ZM6.91667 16.4H17.0833L12 7.93333L6.91667 16.4ZM12 15.6C12.1667 15.6 12.3056 15.5444 12.4167 15.4333C12.5389 15.3111 12.6 15.1667 12.6 15C12.6 14.8333 12.5389 14.6944 12.4167 14.5833C12.3056 14.4611 12.1667 14.4 12 14.4C11.8333 14.4 11.6889 14.4611 11.5667 14.5833C11.4556 14.6944 11.4 14.8333 11.4 15C11.4 15.1667 11.4556 15.3111 11.5667 15.4333C11.6889 15.5444 11.8333 15.6 12 15.6ZM11.4 13.6H12.6V10.4H11.4V13.6Z" fill="#212121"/>
</g>
<defs>
<clipPath id="clip0_6013_33858">
<rect width="24" height="24" fill="white"/>
</clipPath>
</defs>`):(E.innerHTML=`<g clip-path="url(#clip0_6083_34804)">
<path d="M11.4 15.2H12.6V11.2H11.4V15.2ZM12 10C12.1667 10 12.3056 9.94444 12.4167 9.83333C12.5389 9.71111 12.6 9.56667 12.6 9.4C12.6 9.23333 12.5389 9.09444 12.4167 8.98333C12.3056 8.86111 12.1667 8.8 12 8.8C11.8333 8.8 11.6889 8.86111 11.5667 8.98333C11.4556 9.09444 11.4 9.23333 11.4 9.4C11.4 9.56667 11.4556 9.71111 11.5667 9.83333C11.6889 9.94444 11.8333 10 12 10ZM12 18.4C11.1222 18.4 10.2944 18.2333 9.51667 17.9C8.73889 17.5667 8.05556 17.1111 7.46667 16.5333C6.88889 15.9444 6.43333 15.2611 6.1 14.4833C5.76667 13.7056 5.6 12.8778 5.6 12C5.6 11.1111 5.76667 10.2833 6.1 9.51667C6.43333 8.73889 6.88889 8.06111 7.46667 7.48333C8.05556 6.89444 8.73889 6.43333 9.51667 6.1C10.2944 5.76667 11.1222 5.6 12 5.6C12.8889 5.6 13.7167 5.76667 14.4833 6.1C15.2611 6.43333 15.9389 6.89444 16.5167 7.48333C17.1056 8.06111 17.5667 8.73889 17.9 9.51667C18.2333 10.2833 18.4 11.1111 18.4 12C18.4 12.8778 18.2333 13.7056 17.9 14.4833C17.5667 15.2611 17.1056 15.9444 16.5167 16.5333C15.9389 17.1111 15.2611 17.5667 14.4833 17.9C13.7167 18.2333 12.8889 18.4 12 18.4ZM12 17.2C13.4444 17.2 14.6722 16.6944 15.6833 15.6833C16.6944 14.6722 17.2 13.4444 17.2 12C17.2 10.5556 16.6944 9.32778 15.6833 8.31667C14.6722 7.30555 13.4444 6.8 12 6.8C10.5556 6.8 9.32778 7.30555 8.31667 8.31667C7.30556 9.32778 6.8 10.5556 6.8 12C6.8 13.4444 7.30556 14.6722 8.31667 15.6833C9.32778 16.6944 10.5556 17.2 12 17.2Z" fill="#212121"/>
</g>
<defs>
<clipPath id="clip0_6083_34804">
<rect width="24" height="24" fill="white"/>
</clipPath>
</defs>`,_.innerText="Preview backend running in this workspace."),_.setAttribute("id",p)}document.readyState==="loading"?window.addEventListener("DOMContentLoaded",h):h()}function Fa(){return typeof navigator<"u"&&typeof navigator.userAgent=="string"?navigator.userAgent:""}function Gi(){return typeof window<"u"&&!!(window.cordova||window.phonegap||window.PhoneGap)&&/ios|iphone|ipod|ipad|android|blackberry|iemobile/i.test(Fa())}function Wa(){return typeof navigator=="object"&&navigator.product==="ReactNative"}function Ga(){return Li.NODE_ADMIN===!0}function Ua(){try{return typeof indexedDB=="object"}catch{return!1}}function Ha(){return new Promise((n,e)=>{try{let t=!0;const s="validate-browser-context-for-indexeddb-analytics-module",i=self.indexedDB.open(s);i.onsuccess=()=>{i.result.close(),t||self.indexedDB.deleteDatabase(s),n(!0)},i.onupgradeneeded=()=>{t=!1},i.onerror=()=>{e(i.error?.message||"")}}catch(t){e(t)}})}const $a="FirebaseError";class It extends Error{constructor(e,t,s){super(t),this.code=e,this.customData=s,this.name=$a,Object.setPrototypeOf(this,It.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,Ui.prototype.create)}}class Ui{constructor(e,t,s){this.service=e,this.serviceName=t,this.errors=s}create(e,...t){const s=t[0]||{},i=`${this.service}/${e}`,r=this.errors[e],o=r?Va(r,s):"Error",a=`${this.serviceName}: ${o} (${i}).`;return new It(i,a,s)}}function Va(n,e){return n.replace(Ka,(t,s)=>{const i=e[s];return i!=null?String(i):`<${s}?>`})}const Ka=/\{\$([^}]+)}/g;function ut(n){return JSON.parse(n)}function B(n){return JSON.stringify(n)}const Hi=function(n){let e={},t={},s={},i="";try{const r=n.split(".");e=ut(Tn(r[0])||""),t=ut(Tn(r[1])||""),i=r[2],s=t.d||{},delete t.d}catch{}return{header:e,claims:t,data:s,signature:i}},za=function(n){const e=Hi(n),t=e.claims;return!!t&&typeof t=="object"&&t.hasOwnProperty("iat")},Ya=function(n){const e=Hi(n).claims;return typeof e=="object"&&e.admin===!0};function se(n,e){return Object.prototype.hasOwnProperty.call(n,e)}function Ge(n,e){if(Object.prototype.hasOwnProperty.call(n,e))return n[e]}function Nn(n){for(const e in n)if(Object.prototype.hasOwnProperty.call(n,e))return!1;return!0}function Lt(n,e,t){const s={};for(const i in n)Object.prototype.hasOwnProperty.call(n,i)&&(s[i]=e.call(t,n[i],i,n));return s}function Mt(n,e){if(n===e)return!0;const t=Object.keys(n),s=Object.keys(e);for(const i of t){if(!s.includes(i))return!1;const r=n[i],o=e[i];if(Ps(r)&&Ps(o)){if(!Mt(r,o))return!1}else if(r!==o)return!1}for(const i of s)if(!t.includes(i))return!1;return!0}function Ps(n){return n!==null&&typeof n=="object"}function ja(n){const e=[];for(const[t,s]of Object.entries(n))Array.isArray(s)?s.forEach(i=>{e.push(encodeURIComponent(t)+"="+encodeURIComponent(i))}):e.push(encodeURIComponent(t)+"="+encodeURIComponent(s));return e.length?"&"+e.join("&"):""}class qa{constructor(){this.chain_=[],this.buf_=[],this.W_=[],this.pad_=[],this.inbuf_=0,this.total_=0,this.blockSize=512/8,this.pad_[0]=128;for(let e=1;e<this.blockSize;++e)this.pad_[e]=0;this.reset()}reset(){this.chain_[0]=1732584193,this.chain_[1]=4023233417,this.chain_[2]=2562383102,this.chain_[3]=271733878,this.chain_[4]=3285377520,this.inbuf_=0,this.total_=0}compress_(e,t){t||(t=0);const s=this.W_;if(typeof e=="string")for(let h=0;h<16;h++)s[h]=e.charCodeAt(t)<<24|e.charCodeAt(t+1)<<16|e.charCodeAt(t+2)<<8|e.charCodeAt(t+3),t+=4;else for(let h=0;h<16;h++)s[h]=e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3],t+=4;for(let h=16;h<80;h++){const u=s[h-3]^s[h-8]^s[h-14]^s[h-16];s[h]=(u<<1|u>>>31)&4294967295}let i=this.chain_[0],r=this.chain_[1],o=this.chain_[2],a=this.chain_[3],l=this.chain_[4],c,d;for(let h=0;h<80;h++){h<40?h<20?(c=a^r&(o^a),d=1518500249):(c=r^o^a,d=1859775393):h<60?(c=r&o|a&(r|o),d=2400959708):(c=r^o^a,d=3395469782);const u=(i<<5|i>>>27)+c+l+d+s[h]&4294967295;l=a,a=o,o=(r<<30|r>>>2)&4294967295,r=i,i=u}this.chain_[0]=this.chain_[0]+i&4294967295,this.chain_[1]=this.chain_[1]+r&4294967295,this.chain_[2]=this.chain_[2]+o&4294967295,this.chain_[3]=this.chain_[3]+a&4294967295,this.chain_[4]=this.chain_[4]+l&4294967295}update(e,t){if(e==null)return;t===void 0&&(t=e.length);const s=t-this.blockSize;let i=0;const r=this.buf_;let o=this.inbuf_;for(;i<t;){if(o===0)for(;i<=s;)this.compress_(e,i),i+=this.blockSize;if(typeof e=="string"){for(;i<t;)if(r[o]=e.charCodeAt(i),++o,++i,o===this.blockSize){this.compress_(r),o=0;break}}else for(;i<t;)if(r[o]=e[i],++o,++i,o===this.blockSize){this.compress_(r),o=0;break}}this.inbuf_=o,this.total_+=t}digest(){const e=[];let t=this.total_*8;this.inbuf_<56?this.update(this.pad_,56-this.inbuf_):this.update(this.pad_,this.blockSize-(this.inbuf_-56));for(let i=this.blockSize-1;i>=56;i--)this.buf_[i]=t&255,t/=256;this.compress_(this.buf_);let s=0;for(let i=0;i<5;i++)for(let r=24;r>=0;r-=8)e[s]=this.chain_[i]>>r&255,++s;return e}}function Ue(n,e){return`${n} failed: ${e} argument `}const Qa=function(n){const e=[];let t=0;for(let s=0;s<n.length;s++){let i=n.charCodeAt(s);if(i>=55296&&i<=56319){const r=i-55296;s++,m(s<n.length,"Surrogate pair missing trail surrogate.");const o=n.charCodeAt(s)-56320;i=65536+(r<<10)+o}i<128?e[t++]=i:i<2048?(e[t++]=i>>6|192,e[t++]=i&63|128):i<65536?(e[t++]=i>>12|224,e[t++]=i>>6&63|128,e[t++]=i&63|128):(e[t++]=i>>18|240,e[t++]=i>>12&63|128,e[t++]=i>>6&63|128,e[t++]=i&63|128)}return e},Zt=function(n){let e=0;for(let t=0;t<n.length;t++){const s=n.charCodeAt(t);s<128?e++:s<2048?e+=2:s>=55296&&s<=56319?(e+=4,t++):e+=3}return e};function we(n){return n&&n._delegate?n._delegate:n}class dt{constructor(e,t,s){this.name=e,this.instanceFactory=t,this.type=s,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(e){return this.instantiationMode=e,this}setMultipleInstances(e){return this.multipleInstances=e,this}setServiceProps(e){return this.serviceProps=e,this}setInstanceCreatedCallback(e){return this.onInstanceCreated=e,this}}const Te="[DEFAULT]";class Xa{constructor(e,t){this.name=e,this.container=t,this.component=null,this.instances=new Map,this.instancesDeferred=new Map,this.instancesOptions=new Map,this.onInitCallbacks=new Map}get(e){const t=this.normalizeInstanceIdentifier(e);if(!this.instancesDeferred.has(t)){const s=new ne;if(this.instancesDeferred.set(t,s),this.isInitialized(t)||this.shouldAutoInitialize())try{const i=this.getOrInitializeService({instanceIdentifier:t});i&&s.resolve(i)}catch{}}return this.instancesDeferred.get(t).promise}getImmediate(e){const t=this.normalizeInstanceIdentifier(e?.identifier),s=e?.optional??!1;if(this.isInitialized(t)||this.shouldAutoInitialize())try{return this.getOrInitializeService({instanceIdentifier:t})}catch(i){if(s)return null;throw i}else{if(s)return null;throw Error(`Service ${this.name} is not available`)}}getComponent(){return this.component}setComponent(e){if(e.name!==this.name)throw Error(`Mismatching Component ${e.name} for Provider ${this.name}.`);if(this.component)throw Error(`Component for ${this.name} has already been provided`);if(this.component=e,!!this.shouldAutoInitialize()){if(Za(e))try{this.getOrInitializeService({instanceIdentifier:Te})}catch{}for(const[t,s]of this.instancesDeferred.entries()){const i=this.normalizeInstanceIdentifier(t);try{const r=this.getOrInitializeService({instanceIdentifier:i});s.resolve(r)}catch{}}}}clearInstance(e=Te){this.instancesDeferred.delete(e),this.instancesOptions.delete(e),this.instances.delete(e)}async delete(){const e=Array.from(this.instances.values());await Promise.all([...e.filter(t=>"INTERNAL"in t).map(t=>t.INTERNAL.delete()),...e.filter(t=>"_delete"in t).map(t=>t._delete())])}isComponentSet(){return this.component!=null}isInitialized(e=Te){return this.instances.has(e)}getOptions(e=Te){return this.instancesOptions.get(e)||{}}initialize(e={}){const{options:t={}}=e,s=this.normalizeInstanceIdentifier(e.instanceIdentifier);if(this.isInitialized(s))throw Error(`${this.name}(${s}) has already been initialized`);if(!this.isComponentSet())throw Error(`Component ${this.name} has not been registered yet`);const i=this.getOrInitializeService({instanceIdentifier:s,options:t});for(const[r,o]of this.instancesDeferred.entries()){const a=this.normalizeInstanceIdentifier(r);s===a&&o.resolve(i)}return i}onInit(e,t){const s=this.normalizeInstanceIdentifier(t),i=this.onInitCallbacks.get(s)??new Set;i.add(e),this.onInitCallbacks.set(s,i);const r=this.instances.get(s);return r&&e(r,s),()=>{i.delete(e)}}invokeOnInitCallbacks(e,t){const s=this.onInitCallbacks.get(t);if(s)for(const i of s)try{i(e,t)}catch{}}getOrInitializeService({instanceIdentifier:e,options:t={}}){let s=this.instances.get(e);if(!s&&this.component&&(s=this.component.instanceFactory(this.container,{instanceIdentifier:Ja(e),options:t}),this.instances.set(e,s),this.instancesOptions.set(e,t),this.invokeOnInitCallbacks(s,e),this.component.onInstanceCreated))try{this.component.onInstanceCreated(this.container,e,s)}catch{}return s||null}normalizeInstanceIdentifier(e=Te){return this.component?this.component.multipleInstances?e:Te:e}shouldAutoInitialize(){return!!this.component&&this.component.instantiationMode!=="EXPLICIT"}}function Ja(n){return n===Te?void 0:n}function Za(n){return n.instantiationMode==="EAGER"}class el{constructor(e){this.name=e,this.providers=new Map}addComponent(e){const t=this.getProvider(e.name);if(t.isComponentSet())throw new Error(`Component ${e.name} has already been registered with ${this.name}`);t.setComponent(e)}addOrOverwriteComponent(e){this.getProvider(e.name).isComponentSet()&&this.providers.delete(e.name),this.addComponent(e)}getProvider(e){if(this.providers.has(e))return this.providers.get(e);const t=new Xa(e,this);return this.providers.set(e,t),t}getProviders(){return Array.from(this.providers.values())}}var O;(function(n){n[n.DEBUG=0]="DEBUG",n[n.VERBOSE=1]="VERBOSE",n[n.INFO=2]="INFO",n[n.WARN=3]="WARN",n[n.ERROR=4]="ERROR",n[n.SILENT=5]="SILENT"})(O||(O={}));const tl={debug:O.DEBUG,verbose:O.VERBOSE,info:O.INFO,warn:O.WARN,error:O.ERROR,silent:O.SILENT},nl=O.INFO,sl={[O.DEBUG]:"log",[O.VERBOSE]:"log",[O.INFO]:"info",[O.WARN]:"warn",[O.ERROR]:"error"},il=(n,e,...t)=>{if(e<n.logLevel)return;const s=new Date().toISOString(),i=sl[e];if(i)console[i](`[${s}]  ${n.name}:`,...t);else throw new Error(`Attempted to log a message with an invalid logType (value: ${e})`)};class $i{constructor(e){this.name=e,this._logLevel=nl,this._logHandler=il,this._userLogHandler=null}get logLevel(){return this._logLevel}set logLevel(e){if(!(e in O))throw new TypeError(`Invalid value "${e}" assigned to \`logLevel\``);this._logLevel=e}setLogLevel(e){this._logLevel=typeof e=="string"?tl[e]:e}get logHandler(){return this._logHandler}set logHandler(e){if(typeof e!="function")throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=e}get userLogHandler(){return this._userLogHandler}set userLogHandler(e){this._userLogHandler=e}debug(...e){this._userLogHandler&&this._userLogHandler(this,O.DEBUG,...e),this._logHandler(this,O.DEBUG,...e)}log(...e){this._userLogHandler&&this._userLogHandler(this,O.VERBOSE,...e),this._logHandler(this,O.VERBOSE,...e)}info(...e){this._userLogHandler&&this._userLogHandler(this,O.INFO,...e),this._logHandler(this,O.INFO,...e)}warn(...e){this._userLogHandler&&this._userLogHandler(this,O.WARN,...e),this._logHandler(this,O.WARN,...e)}error(...e){this._userLogHandler&&this._userLogHandler(this,O.ERROR,...e),this._logHandler(this,O.ERROR,...e)}}const rl=(n,e)=>e.some(t=>n instanceof t);let Ls,Ms;function ol(){return Ls||(Ls=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function al(){return Ms||(Ms=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const Vi=new WeakMap,Rn=new WeakMap,Ki=new WeakMap,pn=new WeakMap,Qn=new WeakMap;function ll(n){const e=new Promise((t,s)=>{const i=()=>{n.removeEventListener("success",r),n.removeEventListener("error",o)},r=()=>{t(_e(n.result)),i()},o=()=>{s(n.error),i()};n.addEventListener("success",r),n.addEventListener("error",o)});return e.then(t=>{t instanceof IDBCursor&&Vi.set(t,n)}).catch(()=>{}),Qn.set(e,n),e}function cl(n){if(Rn.has(n))return;const e=new Promise((t,s)=>{const i=()=>{n.removeEventListener("complete",r),n.removeEventListener("error",o),n.removeEventListener("abort",o)},r=()=>{t(),i()},o=()=>{s(n.error||new DOMException("AbortError","AbortError")),i()};n.addEventListener("complete",r),n.addEventListener("error",o),n.addEventListener("abort",o)});Rn.set(n,e)}let An={get(n,e,t){if(n instanceof IDBTransaction){if(e==="done")return Rn.get(n);if(e==="objectStoreNames")return n.objectStoreNames||Ki.get(n);if(e==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return _e(n[e])},set(n,e,t){return n[e]=t,!0},has(n,e){return n instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in n}};function hl(n){An=n(An)}function ul(n){return n===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(e,...t){const s=n.call(mn(this),e,...t);return Ki.set(s,e.sort?e.sort():[e]),_e(s)}:al().includes(n)?function(...e){return n.apply(mn(this),e),_e(Vi.get(this))}:function(...e){return _e(n.apply(mn(this),e))}}function dl(n){return typeof n=="function"?ul(n):(n instanceof IDBTransaction&&cl(n),rl(n,ol())?new Proxy(n,An):n)}function _e(n){if(n instanceof IDBRequest)return ll(n);if(pn.has(n))return pn.get(n);const e=dl(n);return e!==n&&(pn.set(n,e),Qn.set(e,n)),e}const mn=n=>Qn.get(n);function fl(n,e,{blocked:t,upgrade:s,blocking:i,terminated:r}={}){const o=indexedDB.open(n,e),a=_e(o);return s&&o.addEventListener("upgradeneeded",l=>{s(_e(o.result),l.oldVersion,l.newVersion,_e(o.transaction),l)}),t&&o.addEventListener("blocked",l=>t(l.oldVersion,l.newVersion,l)),a.then(l=>{r&&l.addEventListener("close",()=>r()),i&&l.addEventListener("versionchange",c=>i(c.oldVersion,c.newVersion,c))}).catch(()=>{}),a}const pl=["get","getKey","getAll","getAllKeys","count"],ml=["put","add","delete","clear"],_n=new Map;function xs(n,e){if(!(n instanceof IDBDatabase&&!(e in n)&&typeof e=="string"))return;if(_n.get(e))return _n.get(e);const t=e.replace(/FromIndex$/,""),s=e!==t,i=ml.includes(t);if(!(t in(s?IDBIndex:IDBObjectStore).prototype)||!(i||pl.includes(t)))return;const r=async function(o,...a){const l=this.transaction(o,i?"readwrite":"readonly");let c=l.store;return s&&(c=c.index(a.shift())),(await Promise.all([c[t](...a),i&&l.done]))[0]};return _n.set(e,r),r}hl(n=>({...n,get:(e,t,s)=>xs(e,t)||n.get(e,t,s),has:(e,t)=>!!xs(e,t)||n.has(e,t)}));class _l{constructor(e){this.container=e}getPlatformInfoString(){return this.container.getProviders().map(t=>{if(gl(t)){const s=t.getImmediate();return`${s.library}/${s.version}`}else return null}).filter(t=>t).join(" ")}}function gl(n){return n.getComponent()?.type==="VERSION"}const On="@firebase/app",Bs="0.14.7";const le=new $i("@firebase/app"),yl="@firebase/app-compat",El="@firebase/analytics-compat",Cl="@firebase/analytics",vl="@firebase/app-check-compat",Sl="@firebase/app-check",Il="@firebase/auth",bl="@firebase/auth-compat",wl="@firebase/database",Tl="@firebase/data-connect",Nl="@firebase/database-compat",Rl="@firebase/functions",Al="@firebase/functions-compat",Ol="@firebase/installations",Dl="@firebase/installations-compat",kl="@firebase/messaging",Pl="@firebase/messaging-compat",Ll="@firebase/performance",Ml="@firebase/performance-compat",xl="@firebase/remote-config",Bl="@firebase/remote-config-compat",Fl="@firebase/storage",Wl="@firebase/storage-compat",Gl="@firebase/firestore",Ul="@firebase/ai",Hl="@firebase/firestore-compat",$l="firebase",Vl="12.8.0";const Dn="[DEFAULT]",Kl={[On]:"fire-core",[yl]:"fire-core-compat",[Cl]:"fire-analytics",[El]:"fire-analytics-compat",[Sl]:"fire-app-check",[vl]:"fire-app-check-compat",[Il]:"fire-auth",[bl]:"fire-auth-compat",[wl]:"fire-rtdb",[Tl]:"fire-data-connect",[Nl]:"fire-rtdb-compat",[Rl]:"fire-fn",[Al]:"fire-fn-compat",[Ol]:"fire-iid",[Dl]:"fire-iid-compat",[kl]:"fire-fcm",[Pl]:"fire-fcm-compat",[Ll]:"fire-perf",[Ml]:"fire-perf-compat",[xl]:"fire-rc",[Bl]:"fire-rc-compat",[Fl]:"fire-gcs",[Wl]:"fire-gcs-compat",[Gl]:"fire-fst",[Hl]:"fire-fst-compat",[Ul]:"fire-vertex","fire-js":"fire-js",[$l]:"fire-js-all"};const xt=new Map,zl=new Map,kn=new Map;function Fs(n,e){try{n.container.addComponent(e)}catch(t){le.debug(`Component ${e.name} failed to register with FirebaseApp ${n.name}`,t)}}function Bt(n){const e=n.name;if(kn.has(e))return le.debug(`There were multiple attempts to register component ${e}.`),!1;kn.set(e,n);for(const t of xt.values())Fs(t,n);for(const t of zl.values())Fs(t,n);return!0}function Yl(n,e){const t=n.container.getProvider("heartbeat").getImmediate({optional:!0});return t&&t.triggerHeartbeat(),n.container.getProvider(e)}function jl(n){return n==null?!1:n.settings!==void 0}const ql={"no-app":"No Firebase App '{$appName}' has been created - call initializeApp() first","bad-app-name":"Illegal App name: '{$appName}'","duplicate-app":"Firebase App named '{$appName}' already exists with different options or config","app-deleted":"Firebase App named '{$appName}' already deleted","server-app-deleted":"Firebase Server App has been deleted","no-options":"Need to provide options, when not being deployed to hosting via source.","invalid-app-argument":"firebase.{$appName}() takes either no argument or a Firebase App instance.","invalid-log-argument":"First argument to `onLog` must be null or a function.","idb-open":"Error thrown when opening IndexedDB. Original error: {$originalErrorMessage}.","idb-get":"Error thrown when reading from IndexedDB. Original error: {$originalErrorMessage}.","idb-set":"Error thrown when writing to IndexedDB. Original error: {$originalErrorMessage}.","idb-delete":"Error thrown when deleting from IndexedDB. Original error: {$originalErrorMessage}.","finalization-registry-not-supported":"FirebaseServerApp deleteOnDeref field defined but the JS runtime does not support FinalizationRegistry.","invalid-server-app-environment":"FirebaseServerApp is not for use in browser environments."},ge=new Ui("app","Firebase",ql);class Ql{constructor(e,t,s){this._isDeleted=!1,this._options={...e},this._config={...t},this._name=t.name,this._automaticDataCollectionEnabled=t.automaticDataCollectionEnabled,this._container=s,this.container.addComponent(new dt("app",()=>this,"PUBLIC"))}get automaticDataCollectionEnabled(){return this.checkDestroyed(),this._automaticDataCollectionEnabled}set automaticDataCollectionEnabled(e){this.checkDestroyed(),this._automaticDataCollectionEnabled=e}get name(){return this.checkDestroyed(),this._name}get options(){return this.checkDestroyed(),this._options}get config(){return this.checkDestroyed(),this._config}get container(){return this._container}get isDeleted(){return this._isDeleted}set isDeleted(e){this._isDeleted=e}checkDestroyed(){if(this.isDeleted)throw ge.create("app-deleted",{appName:this._name})}}const Xl=Vl;function zi(n,e={}){let t=n;typeof e!="object"&&(e={name:e});const s={name:Dn,automaticDataCollectionEnabled:!0,...e},i=s.name;if(typeof i!="string"||!i)throw ge.create("bad-app-name",{appName:String(i)});if(t||(t=Wi()),!t)throw ge.create("no-options");const r=xt.get(i);if(r){if(Mt(t,r.options)&&Mt(s,r.config))return r;throw ge.create("duplicate-app",{appName:i})}const o=new el(i);for(const l of kn.values())o.addComponent(l);const a=new Ql(t,s,o);return xt.set(i,a),a}function Jl(n=Dn){const e=xt.get(n);if(!e&&n===Dn&&Wi())return zi();if(!e)throw ge.create("no-app",{appName:n});return e}function Be(n,e,t){let s=Kl[n]??n;t&&(s+=`-${t}`);const i=s.match(/\s|\//),r=e.match(/\s|\//);if(i||r){const o=[`Unable to register library "${s}" with version "${e}":`];i&&o.push(`library name "${s}" contains illegal characters (whitespace or "/")`),i&&r&&o.push("and"),r&&o.push(`version name "${e}" contains illegal characters (whitespace or "/")`),le.warn(o.join(" "));return}Bt(new dt(`${s}-version`,()=>({library:s,version:e}),"VERSION"))}const Zl="firebase-heartbeat-database",ec=1,ft="firebase-heartbeat-store";let gn=null;function Yi(){return gn||(gn=fl(Zl,ec,{upgrade:(n,e)=>{switch(e){case 0:try{n.createObjectStore(ft)}catch(t){console.warn(t)}}}}).catch(n=>{throw ge.create("idb-open",{originalErrorMessage:n.message})})),gn}async function tc(n){try{const t=(await Yi()).transaction(ft),s=await t.objectStore(ft).get(ji(n));return await t.done,s}catch(e){if(e instanceof It)le.warn(e.message);else{const t=ge.create("idb-get",{originalErrorMessage:e?.message});le.warn(t.message)}}}async function Ws(n,e){try{const s=(await Yi()).transaction(ft,"readwrite");await s.objectStore(ft).put(e,ji(n)),await s.done}catch(t){if(t instanceof It)le.warn(t.message);else{const s=ge.create("idb-set",{originalErrorMessage:t?.message});le.warn(s.message)}}}function ji(n){return`${n.name}!${n.options.appId}`}const nc=1024,sc=30;class ic{constructor(e){this.container=e,this._heartbeatsCache=null;const t=this.container.getProvider("app").getImmediate();this._storage=new oc(t),this._heartbeatsCachePromise=this._storage.read().then(s=>(this._heartbeatsCache=s,s))}async triggerHeartbeat(){try{const t=this.container.getProvider("platform-logger").getImmediate().getPlatformInfoString(),s=Gs();if(this._heartbeatsCache?.heartbeats==null&&(this._heartbeatsCache=await this._heartbeatsCachePromise,this._heartbeatsCache?.heartbeats==null)||this._heartbeatsCache.lastSentHeartbeatDate===s||this._heartbeatsCache.heartbeats.some(i=>i.date===s))return;if(this._heartbeatsCache.heartbeats.push({date:s,agent:t}),this._heartbeatsCache.heartbeats.length>sc){const i=ac(this._heartbeatsCache.heartbeats);this._heartbeatsCache.heartbeats.splice(i,1)}return this._storage.overwrite(this._heartbeatsCache)}catch(e){le.warn(e)}}async getHeartbeatsHeader(){try{if(this._heartbeatsCache===null&&await this._heartbeatsCachePromise,this._heartbeatsCache?.heartbeats==null||this._heartbeatsCache.heartbeats.length===0)return"";const e=Gs(),{heartbeatsToSend:t,unsentEntries:s}=rc(this._heartbeatsCache.heartbeats),i=Pt(JSON.stringify({version:2,heartbeats:t}));return this._heartbeatsCache.lastSentHeartbeatDate=e,s.length>0?(this._heartbeatsCache.heartbeats=s,await this._storage.overwrite(this._heartbeatsCache)):(this._heartbeatsCache.heartbeats=[],this._storage.overwrite(this._heartbeatsCache)),i}catch(e){return le.warn(e),""}}}function Gs(){return new Date().toISOString().substring(0,10)}function rc(n,e=nc){const t=[];let s=n.slice();for(const i of n){const r=t.find(o=>o.agent===i.agent);if(r){if(r.dates.push(i.date),Us(t)>e){r.dates.pop();break}}else if(t.push({agent:i.agent,dates:[i.date]}),Us(t)>e){t.pop();break}s=s.slice(1)}return{heartbeatsToSend:t,unsentEntries:s}}class oc{constructor(e){this.app=e,this._canUseIndexedDBPromise=this.runIndexedDBEnvironmentCheck()}async runIndexedDBEnvironmentCheck(){return Ua()?Ha().then(()=>!0).catch(()=>!1):!1}async read(){if(await this._canUseIndexedDBPromise){const t=await tc(this.app);return t?.heartbeats?t:{heartbeats:[]}}else return{heartbeats:[]}}async overwrite(e){if(await this._canUseIndexedDBPromise){const s=await this.read();return Ws(this.app,{lastSentHeartbeatDate:e.lastSentHeartbeatDate??s.lastSentHeartbeatDate,heartbeats:e.heartbeats})}else return}async add(e){if(await this._canUseIndexedDBPromise){const s=await this.read();return Ws(this.app,{lastSentHeartbeatDate:e.lastSentHeartbeatDate??s.lastSentHeartbeatDate,heartbeats:[...s.heartbeats,...e.heartbeats]})}else return}}function Us(n){return Pt(JSON.stringify({version:2,heartbeats:n})).length}function ac(n){if(n.length===0)return-1;let e=0,t=n[0].date;for(let s=1;s<n.length;s++)n[s].date<t&&(t=n[s].date,e=s);return e}function lc(n){Bt(new dt("platform-logger",e=>new _l(e),"PRIVATE")),Bt(new dt("heartbeat",e=>new ic(e),"PRIVATE")),Be(On,Bs,n),Be(On,Bs,"esm2020"),Be("fire-js","")}lc("");var cc="firebase",hc="12.8.0";Be(cc,hc,"app");var Hs={};const $s="@firebase/database",Vs="1.1.0";let qi="";function uc(n){qi=n}class dc{constructor(e){this.domStorage_=e,this.prefix_="firebase:"}set(e,t){t==null?this.domStorage_.removeItem(this.prefixedName_(e)):this.domStorage_.setItem(this.prefixedName_(e),B(t))}get(e){const t=this.domStorage_.getItem(this.prefixedName_(e));return t==null?null:ut(t)}remove(e){this.domStorage_.removeItem(this.prefixedName_(e))}prefixedName_(e){return this.prefix_+e}toString(){return this.domStorage_.toString()}}class fc{constructor(){this.cache_={},this.isInMemoryStorage=!0}set(e,t){t==null?delete this.cache_[e]:this.cache_[e]=t}get(e){return se(this.cache_,e)?this.cache_[e]:null}remove(e){delete this.cache_[e]}}const Qi=function(n){try{if(typeof window<"u"&&typeof window[n]<"u"){const e=window[n];return e.setItem("firebase:sentinel","cache"),e.removeItem("firebase:sentinel"),new dc(e)}}catch{}return new fc},Re=Qi("localStorage"),pc=Qi("sessionStorage");const Fe=new $i("@firebase/database"),mc=(function(){let n=1;return function(){return n++}})(),Xi=function(n){const e=Qa(n),t=new qa;t.update(e);const s=t.digest();return jn.encodeByteArray(s)},bt=function(...n){let e="";for(let t=0;t<n.length;t++){const s=n[t];Array.isArray(s)||s&&typeof s=="object"&&typeof s.length=="number"?e+=bt.apply(null,s):typeof s=="object"?e+=B(s):e+=s,e+=" "}return e};let ot=null,Ks=!0;const _c=function(n,e){m(!0,"Can't turn on custom loggers persistently."),Fe.logLevel=O.VERBOSE,ot=Fe.log.bind(Fe)},G=function(...n){if(Ks===!0&&(Ks=!1,ot===null&&pc.get("logging_enabled")===!0&&_c()),ot){const e=bt.apply(null,n);ot(e)}},wt=function(n){return function(...e){G(n,...e)}},Pn=function(...n){const e="FIREBASE INTERNAL ERROR: "+bt(...n);Fe.error(e)},ce=function(...n){const e=`FIREBASE FATAL ERROR: ${bt(...n)}`;throw Fe.error(e),new Error(e)},V=function(...n){const e="FIREBASE WARNING: "+bt(...n);Fe.warn(e)},gc=function(){typeof window<"u"&&window.location&&window.location.protocol&&window.location.protocol.indexOf("https:")!==-1&&V("Insecure Firebase access from a secure page. Please use https in calls to new Firebase().")},en=function(n){return typeof n=="number"&&(n!==n||n===Number.POSITIVE_INFINITY||n===Number.NEGATIVE_INFINITY)},yc=function(n){if(document.readyState==="complete")n();else{let e=!1;const t=function(){if(!document.body){setTimeout(t,Math.floor(10));return}e||(e=!0,n())};document.addEventListener?(document.addEventListener("DOMContentLoaded",t,!1),window.addEventListener("load",t,!1)):document.attachEvent&&(document.attachEvent("onreadystatechange",()=>{document.readyState==="complete"&&t()}),window.attachEvent("onload",t))}},He="[MIN_NAME]",Ae="[MAX_NAME]",ke=function(n,e){if(n===e)return 0;if(n===He||e===Ae)return-1;if(e===He||n===Ae)return 1;{const t=zs(n),s=zs(e);return t!==null?s!==null?t-s===0?n.length-e.length:t-s:-1:s!==null?1:n<e?-1:1}},Ec=function(n,e){return n===e?0:n<e?-1:1},Je=function(n,e){if(e&&n in e)return e[n];throw new Error("Missing required key ("+n+") in object: "+B(e))},Xn=function(n){if(typeof n!="object"||n===null)return B(n);const e=[];for(const s in n)e.push(s);e.sort();let t="{";for(let s=0;s<e.length;s++)s!==0&&(t+=","),t+=B(e[s]),t+=":",t+=Xn(n[e[s]]);return t+="}",t},Ji=function(n,e){const t=n.length;if(t<=e)return[n];const s=[];for(let i=0;i<t;i+=e)i+e>t?s.push(n.substring(i,t)):s.push(n.substring(i,i+e));return s};function U(n,e){for(const t in n)n.hasOwnProperty(t)&&e(t,n[t])}const Zi=function(n){m(!en(n),"Invalid JSON number");const e=11,t=52,s=(1<<e-1)-1;let i,r,o,a,l;n===0?(r=0,o=0,i=1/n===-1/0?1:0):(i=n<0,n=Math.abs(n),n>=Math.pow(2,1-s)?(a=Math.min(Math.floor(Math.log(n)/Math.LN2),s),r=a+s,o=Math.round(n*Math.pow(2,t-a)-Math.pow(2,t))):(r=0,o=Math.round(n/Math.pow(2,1-s-t))));const c=[];for(l=t;l;l-=1)c.push(o%2?1:0),o=Math.floor(o/2);for(l=e;l;l-=1)c.push(r%2?1:0),r=Math.floor(r/2);c.push(i?1:0),c.reverse();const d=c.join("");let h="";for(l=0;l<64;l+=8){let u=parseInt(d.substr(l,8),2).toString(16);u.length===1&&(u="0"+u),h=h+u}return h.toLowerCase()},Cc=function(){return!!(typeof window=="object"&&window.chrome&&window.chrome.extension&&!/^chrome/.test(window.location.href))},vc=function(){return typeof Windows=="object"&&typeof Windows.UI=="object"};function Sc(n,e){let t="Unknown Error";n==="too_big"?t="The data requested exceeds the maximum size that can be accessed with a single request.":n==="permission_denied"?t="Client doesn't have permission to access the desired data.":n==="unavailable"&&(t="The service is unavailable");const s=new Error(n+" at "+e._path.toString()+": "+t);return s.code=n.toUpperCase(),s}const Ic=new RegExp("^-?(0*)\\d{1,10}$"),bc=-2147483648,wc=2147483647,zs=function(n){if(Ic.test(n)){const e=Number(n);if(e>=bc&&e<=wc)return e}return null},je=function(n){try{n()}catch(e){setTimeout(()=>{const t=e.stack||"";throw V("Exception was thrown by user callback.",t),e},Math.floor(0))}},Tc=function(){return(typeof window=="object"&&window.navigator&&window.navigator.userAgent||"").search(/googlebot|google webmaster tools|bingbot|yahoo! slurp|baiduspider|yandexbot|duckduckbot/i)>=0},at=function(n,e){const t=setTimeout(n,e);return typeof t=="number"&&typeof Deno<"u"&&Deno.unrefTimer?Deno.unrefTimer(t):typeof t=="object"&&t.unref&&t.unref(),t};class Nc{constructor(e,t){this.appCheckProvider=t,this.appName=e.name,jl(e)&&e.settings.appCheckToken&&(this.serverAppAppCheckToken=e.settings.appCheckToken),this.appCheck=t?.getImmediate({optional:!0}),this.appCheck||t?.get().then(s=>this.appCheck=s)}getToken(e){if(this.serverAppAppCheckToken){if(e)throw new Error("Attempted reuse of `FirebaseServerApp.appCheckToken` after previous usage failed.");return Promise.resolve({token:this.serverAppAppCheckToken})}return this.appCheck?this.appCheck.getToken(e):new Promise((t,s)=>{setTimeout(()=>{this.appCheck?this.getToken(e).then(t,s):t(null)},0)})}addTokenChangeListener(e){this.appCheckProvider?.get().then(t=>t.addTokenListener(e))}notifyForInvalidToken(){V(`Provided AppCheck credentials for the app named "${this.appName}" are invalid. This usually indicates your app was not initialized correctly.`)}}class Rc{constructor(e,t,s){this.appName_=e,this.firebaseOptions_=t,this.authProvider_=s,this.auth_=null,this.auth_=s.getImmediate({optional:!0}),this.auth_||s.onInit(i=>this.auth_=i)}getToken(e){return this.auth_?this.auth_.getToken(e).catch(t=>t&&t.code==="auth/token-not-initialized"?(G("Got auth/token-not-initialized error.  Treating as null token."),null):Promise.reject(t)):new Promise((t,s)=>{setTimeout(()=>{this.auth_?this.getToken(e).then(t,s):t(null)},0)})}addTokenChangeListener(e){this.auth_?this.auth_.addAuthTokenListener(e):this.authProvider_.get().then(t=>t.addAuthTokenListener(e))}removeTokenChangeListener(e){this.authProvider_.get().then(t=>t.removeAuthTokenListener(e))}notifyForInvalidToken(){let e='Provided authentication credentials for the app named "'+this.appName_+'" are invalid. This usually indicates your app was not initialized correctly. ';"credential"in this.firebaseOptions_?e+='Make sure the "credential" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':"serviceAccount"in this.firebaseOptions_?e+='Make sure the "serviceAccount" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':e+='Make sure the "apiKey" and "databaseURL" properties provided to initializeApp() match the values provided for your app at https://console.firebase.google.com/.',V(e)}}class kt{constructor(e){this.accessToken=e}getToken(e){return Promise.resolve({accessToken:this.accessToken})}addTokenChangeListener(e){e(this.accessToken)}removeTokenChangeListener(e){}notifyForInvalidToken(){}}kt.OWNER="owner";const Jn="5",er="v",tr="s",nr="r",sr="f",ir=/(console\.firebase|firebase-console-\w+\.corp|firebase\.corp)\.google\.com/,rr="ls",or="p",Ln="ac",ar="websocket",lr="long_polling";class cr{constructor(e,t,s,i,r=!1,o="",a=!1,l=!1,c=null){this.secure=t,this.namespace=s,this.webSocketOnly=i,this.nodeAdmin=r,this.persistenceKey=o,this.includeNamespaceInQueryParams=a,this.isUsingEmulator=l,this.emulatorOptions=c,this._host=e.toLowerCase(),this._domain=this._host.substr(this._host.indexOf(".")+1),this.internalHost=Re.get("host:"+e)||this._host}isCacheableHost(){return this.internalHost.substr(0,2)==="s-"}isCustomHost(){return this._domain!=="firebaseio.com"&&this._domain!=="firebaseio-demo.com"}get host(){return this._host}set host(e){e!==this.internalHost&&(this.internalHost=e,this.isCacheableHost()&&Re.set("host:"+this._host,this.internalHost))}toString(){let e=this.toURLString();return this.persistenceKey&&(e+="<"+this.persistenceKey+">"),e}toURLString(){const e=this.secure?"https://":"http://",t=this.includeNamespaceInQueryParams?`?ns=${this.namespace}`:"";return`${e}${this.host}/${t}`}}function Ac(n){return n.host!==n.internalHost||n.isCustomHost()||n.includeNamespaceInQueryParams}function hr(n,e,t){m(typeof e=="string","typeof type must == string"),m(typeof t=="object","typeof params must == object");let s;if(e===ar)s=(n.secure?"wss://":"ws://")+n.internalHost+"/.ws?";else if(e===lr)s=(n.secure?"https://":"http://")+n.internalHost+"/.lp?";else throw new Error("Unknown connection type: "+e);Ac(n)&&(t.ns=n.namespace);const i=[];return U(t,(r,o)=>{i.push(r+"="+o)}),s+i.join("&")}class Oc{constructor(){this.counters_={}}incrementCounter(e,t=1){se(this.counters_,e)||(this.counters_[e]=0),this.counters_[e]+=t}get(){return wa(this.counters_)}}const yn={},En={};function Zn(n){const e=n.toString();return yn[e]||(yn[e]=new Oc),yn[e]}function Dc(n,e){const t=n.toString();return En[t]||(En[t]=e()),En[t]}class kc{constructor(e){this.onMessage_=e,this.pendingResponses=[],this.currentResponseNum=0,this.closeAfterResponse=-1,this.onClose=null}closeAfter(e,t){this.closeAfterResponse=e,this.onClose=t,this.closeAfterResponse<this.currentResponseNum&&(this.onClose(),this.onClose=null)}handleResponse(e,t){for(this.pendingResponses[e]=t;this.pendingResponses[this.currentResponseNum];){const s=this.pendingResponses[this.currentResponseNum];delete this.pendingResponses[this.currentResponseNum];for(let i=0;i<s.length;++i)s[i]&&je(()=>{this.onMessage_(s[i])});if(this.currentResponseNum===this.closeAfterResponse){this.onClose&&(this.onClose(),this.onClose=null);break}this.currentResponseNum++}}}const Ys="start",Pc="close",Lc="pLPCommand",Mc="pRTLPCB",ur="id",dr="pw",fr="ser",xc="cb",Bc="seg",Fc="ts",Wc="d",Gc="dframe",pr=1870,mr=30,Uc=pr-mr,Hc=25e3,$c=3e4;class Me{constructor(e,t,s,i,r,o,a){this.connId=e,this.repoInfo=t,this.applicationId=s,this.appCheckToken=i,this.authToken=r,this.transportSessionId=o,this.lastSessionId=a,this.bytesSent=0,this.bytesReceived=0,this.everConnected_=!1,this.log_=wt(e),this.stats_=Zn(t),this.urlFn=l=>(this.appCheckToken&&(l[Ln]=this.appCheckToken),hr(t,lr,l))}open(e,t){this.curSegmentNum=0,this.onDisconnect_=t,this.myPacketOrderer=new kc(e),this.isClosed_=!1,this.connectTimeoutTimer_=setTimeout(()=>{this.log_("Timed out trying to connect."),this.onClosed_(),this.connectTimeoutTimer_=null},Math.floor($c)),yc(()=>{if(this.isClosed_)return;this.scriptTagHolder=new es((...r)=>{const[o,a,l,c,d]=r;if(this.incrementIncomingBytes_(r),!!this.scriptTagHolder)if(this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null),this.everConnected_=!0,o===Ys)this.id=a,this.password=l;else if(o===Pc)a?(this.scriptTagHolder.sendNewPolls=!1,this.myPacketOrderer.closeAfter(a,()=>{this.onClosed_()})):this.onClosed_();else throw new Error("Unrecognized command received: "+o)},(...r)=>{const[o,a]=r;this.incrementIncomingBytes_(r),this.myPacketOrderer.handleResponse(o,a)},()=>{this.onClosed_()},this.urlFn);const s={};s[Ys]="t",s[fr]=Math.floor(Math.random()*1e8),this.scriptTagHolder.uniqueCallbackIdentifier&&(s[xc]=this.scriptTagHolder.uniqueCallbackIdentifier),s[er]=Jn,this.transportSessionId&&(s[tr]=this.transportSessionId),this.lastSessionId&&(s[rr]=this.lastSessionId),this.applicationId&&(s[or]=this.applicationId),this.appCheckToken&&(s[Ln]=this.appCheckToken),typeof location<"u"&&location.hostname&&ir.test(location.hostname)&&(s[nr]=sr);const i=this.urlFn(s);this.log_("Connecting via long-poll to "+i),this.scriptTagHolder.addTag(i,()=>{})})}start(){this.scriptTagHolder.startLongPoll(this.id,this.password),this.addDisconnectPingFrame(this.id,this.password)}static forceAllow(){Me.forceAllow_=!0}static forceDisallow(){Me.forceDisallow_=!0}static isAvailable(){return Me.forceAllow_?!0:!Me.forceDisallow_&&typeof document<"u"&&document.createElement!=null&&!Cc()&&!vc()}markConnectionHealthy(){}shutdown_(){this.isClosed_=!0,this.scriptTagHolder&&(this.scriptTagHolder.close(),this.scriptTagHolder=null),this.myDisconnFrame&&(document.body.removeChild(this.myDisconnFrame),this.myDisconnFrame=null),this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null)}onClosed_(){this.isClosed_||(this.log_("Longpoll is closing itself"),this.shutdown_(),this.onDisconnect_&&(this.onDisconnect_(this.everConnected_),this.onDisconnect_=null))}close(){this.isClosed_||(this.log_("Longpoll is being closed."),this.shutdown_())}send(e){const t=B(e);this.bytesSent+=t.length,this.stats_.incrementCounter("bytes_sent",t.length);const s=xi(t),i=Ji(s,Uc);for(let r=0;r<i.length;r++)this.scriptTagHolder.enqueueSegment(this.curSegmentNum,i.length,i[r]),this.curSegmentNum++}addDisconnectPingFrame(e,t){this.myDisconnFrame=document.createElement("iframe");const s={};s[Gc]="t",s[ur]=e,s[dr]=t,this.myDisconnFrame.src=this.urlFn(s),this.myDisconnFrame.style.display="none",document.body.appendChild(this.myDisconnFrame)}incrementIncomingBytes_(e){const t=B(e).length;this.bytesReceived+=t,this.stats_.incrementCounter("bytes_received",t)}}class es{constructor(e,t,s,i){this.onDisconnect=s,this.urlFn=i,this.outstandingRequests=new Set,this.pendingSegs=[],this.currentSerial=Math.floor(Math.random()*1e8),this.sendNewPolls=!0;{this.uniqueCallbackIdentifier=mc(),window[Lc+this.uniqueCallbackIdentifier]=e,window[Mc+this.uniqueCallbackIdentifier]=t,this.myIFrame=es.createIFrame_();let r="";this.myIFrame.src&&this.myIFrame.src.substr(0,11)==="javascript:"&&(r='<script>document.domain="'+document.domain+'";<\/script>');const o="<html><body>"+r+"</body></html>";try{this.myIFrame.doc.open(),this.myIFrame.doc.write(o),this.myIFrame.doc.close()}catch(a){G("frame writing exception"),a.stack&&G(a.stack),G(a)}}}static createIFrame_(){const e=document.createElement("iframe");if(e.style.display="none",document.body){document.body.appendChild(e);try{e.contentWindow.document||G("No IE domain setting required")}catch{const s=document.domain;e.src="javascript:void((function(){document.open();document.domain='"+s+"';document.close();})())"}}else throw"Document body has not initialized. Wait to initialize Firebase until after the document is ready.";return e.contentDocument?e.doc=e.contentDocument:e.contentWindow?e.doc=e.contentWindow.document:e.document&&(e.doc=e.document),e}close(){this.alive=!1,this.myIFrame&&(this.myIFrame.doc.body.textContent="",setTimeout(()=>{this.myIFrame!==null&&(document.body.removeChild(this.myIFrame),this.myIFrame=null)},Math.floor(0)));const e=this.onDisconnect;e&&(this.onDisconnect=null,e())}startLongPoll(e,t){for(this.myID=e,this.myPW=t,this.alive=!0;this.newRequest_(););}newRequest_(){if(this.alive&&this.sendNewPolls&&this.outstandingRequests.size<(this.pendingSegs.length>0?2:1)){this.currentSerial++;const e={};e[ur]=this.myID,e[dr]=this.myPW,e[fr]=this.currentSerial;let t=this.urlFn(e),s="",i=0;for(;this.pendingSegs.length>0&&this.pendingSegs[0].d.length+mr+s.length<=pr;){const o=this.pendingSegs.shift();s=s+"&"+Bc+i+"="+o.seg+"&"+Fc+i+"="+o.ts+"&"+Wc+i+"="+o.d,i++}return t=t+s,this.addLongPollTag_(t,this.currentSerial),!0}else return!1}enqueueSegment(e,t,s){this.pendingSegs.push({seg:e,ts:t,d:s}),this.alive&&this.newRequest_()}addLongPollTag_(e,t){this.outstandingRequests.add(t);const s=()=>{this.outstandingRequests.delete(t),this.newRequest_()},i=setTimeout(s,Math.floor(Hc)),r=()=>{clearTimeout(i),s()};this.addTag(e,r)}addTag(e,t){setTimeout(()=>{try{if(!this.sendNewPolls)return;const s=this.myIFrame.doc.createElement("script");s.type="text/javascript",s.async=!0,s.src=e,s.onload=s.onreadystatechange=function(){const i=s.readyState;(!i||i==="loaded"||i==="complete")&&(s.onload=s.onreadystatechange=null,s.parentNode&&s.parentNode.removeChild(s),t())},s.onerror=()=>{G("Long-poll script failed to load: "+e),this.sendNewPolls=!1,this.close()},this.myIFrame.doc.body.appendChild(s)}catch{}},Math.floor(1))}}const Vc=16384,Kc=45e3;let Ft=null;typeof MozWebSocket<"u"?Ft=MozWebSocket:typeof WebSocket<"u"&&(Ft=WebSocket);class Z{constructor(e,t,s,i,r,o,a){this.connId=e,this.applicationId=s,this.appCheckToken=i,this.authToken=r,this.keepaliveTimer=null,this.frames=null,this.totalFrames=0,this.bytesSent=0,this.bytesReceived=0,this.log_=wt(this.connId),this.stats_=Zn(t),this.connURL=Z.connectionURL_(t,o,a,i,s),this.nodeAdmin=t.nodeAdmin}static connectionURL_(e,t,s,i,r){const o={};return o[er]=Jn,typeof location<"u"&&location.hostname&&ir.test(location.hostname)&&(o[nr]=sr),t&&(o[tr]=t),s&&(o[rr]=s),i&&(o[Ln]=i),r&&(o[or]=r),hr(e,ar,o)}open(e,t){this.onDisconnect=t,this.onMessage=e,this.log_("Websocket connecting to "+this.connURL),this.everConnected_=!1,Re.set("previous_websocket_failure",!0);try{let s;Ga(),this.mySock=new Ft(this.connURL,[],s)}catch(s){this.log_("Error instantiating WebSocket.");const i=s.message||s.data;i&&this.log_(i),this.onClosed_();return}this.mySock.onopen=()=>{this.log_("Websocket connected."),this.everConnected_=!0},this.mySock.onclose=()=>{this.log_("Websocket connection was disconnected."),this.mySock=null,this.onClosed_()},this.mySock.onmessage=s=>{this.handleIncomingFrame(s)},this.mySock.onerror=s=>{this.log_("WebSocket error.  Closing connection.");const i=s.message||s.data;i&&this.log_(i),this.onClosed_()}}start(){}static forceDisallow(){Z.forceDisallow_=!0}static isAvailable(){let e=!1;if(typeof navigator<"u"&&navigator.userAgent){const t=/Android ([0-9]{0,}\.[0-9]{0,})/,s=navigator.userAgent.match(t);s&&s.length>1&&parseFloat(s[1])<4.4&&(e=!0)}return!e&&Ft!==null&&!Z.forceDisallow_}static previouslyFailed(){return Re.isInMemoryStorage||Re.get("previous_websocket_failure")===!0}markConnectionHealthy(){Re.remove("previous_websocket_failure")}appendFrame_(e){if(this.frames.push(e),this.frames.length===this.totalFrames){const t=this.frames.join("");this.frames=null;const s=ut(t);this.onMessage(s)}}handleNewFrameCount_(e){this.totalFrames=e,this.frames=[]}extractFrameCount_(e){if(m(this.frames===null,"We already have a frame buffer"),e.length<=6){const t=Number(e);if(!isNaN(t))return this.handleNewFrameCount_(t),null}return this.handleNewFrameCount_(1),e}handleIncomingFrame(e){if(this.mySock===null)return;const t=e.data;if(this.bytesReceived+=t.length,this.stats_.incrementCounter("bytes_received",t.length),this.resetKeepAlive(),this.frames!==null)this.appendFrame_(t);else{const s=this.extractFrameCount_(t);s!==null&&this.appendFrame_(s)}}send(e){this.resetKeepAlive();const t=B(e);this.bytesSent+=t.length,this.stats_.incrementCounter("bytes_sent",t.length);const s=Ji(t,Vc);s.length>1&&this.sendString_(String(s.length));for(let i=0;i<s.length;i++)this.sendString_(s[i])}shutdown_(){this.isClosed_=!0,this.keepaliveTimer&&(clearInterval(this.keepaliveTimer),this.keepaliveTimer=null),this.mySock&&(this.mySock.close(),this.mySock=null)}onClosed_(){this.isClosed_||(this.log_("WebSocket is closing itself"),this.shutdown_(),this.onDisconnect&&(this.onDisconnect(this.everConnected_),this.onDisconnect=null))}close(){this.isClosed_||(this.log_("WebSocket is being closed"),this.shutdown_())}resetKeepAlive(){clearInterval(this.keepaliveTimer),this.keepaliveTimer=setInterval(()=>{this.mySock&&this.sendString_("0"),this.resetKeepAlive()},Math.floor(Kc))}sendString_(e){try{this.mySock.send(e)}catch(t){this.log_("Exception thrown from WebSocket.send():",t.message||t.data,"Closing connection."),setTimeout(this.onClosed_.bind(this),0)}}}Z.responsesRequiredToBeHealthy=2;Z.healthyTimeout=3e4;class pt{static get ALL_TRANSPORTS(){return[Me,Z]}static get IS_TRANSPORT_INITIALIZED(){return this.globalTransportInitialized_}constructor(e){this.initTransports_(e)}initTransports_(e){const t=Z&&Z.isAvailable();let s=t&&!Z.previouslyFailed();if(e.webSocketOnly&&(t||V("wss:// URL used, but browser isn't known to support websockets.  Trying anyway."),s=!0),s)this.transports_=[Z];else{const i=this.transports_=[];for(const r of pt.ALL_TRANSPORTS)r&&r.isAvailable()&&i.push(r);pt.globalTransportInitialized_=!0}}initialTransport(){if(this.transports_.length>0)return this.transports_[0];throw new Error("No transports available")}upgradeTransport(){return this.transports_.length>1?this.transports_[1]:null}}pt.globalTransportInitialized_=!1;const zc=6e4,Yc=5e3,jc=10*1024,qc=100*1024,Cn="t",js="d",Qc="s",qs="r",Xc="e",Qs="o",Xs="a",Js="n",Zs="p",Jc="h";class Zc{constructor(e,t,s,i,r,o,a,l,c,d){this.id=e,this.repoInfo_=t,this.applicationId_=s,this.appCheckToken_=i,this.authToken_=r,this.onMessage_=o,this.onReady_=a,this.onDisconnect_=l,this.onKill_=c,this.lastSessionId=d,this.connectionCount=0,this.pendingDataMessages=[],this.state_=0,this.log_=wt("c:"+this.id+":"),this.transportManager_=new pt(t),this.log_("Connection created"),this.start_()}start_(){const e=this.transportManager_.initialTransport();this.conn_=new e(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,null,this.lastSessionId),this.primaryResponsesRequired_=e.responsesRequiredToBeHealthy||0;const t=this.connReceiver_(this.conn_),s=this.disconnReceiver_(this.conn_);this.tx_=this.conn_,this.rx_=this.conn_,this.secondaryConn_=null,this.isHealthy_=!1,setTimeout(()=>{this.conn_&&this.conn_.open(t,s)},Math.floor(0));const i=e.healthyTimeout||0;i>0&&(this.healthyTimeout_=at(()=>{this.healthyTimeout_=null,this.isHealthy_||(this.conn_&&this.conn_.bytesReceived>qc?(this.log_("Connection exceeded healthy timeout but has received "+this.conn_.bytesReceived+" bytes.  Marking connection healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()):this.conn_&&this.conn_.bytesSent>jc?this.log_("Connection exceeded healthy timeout but has sent "+this.conn_.bytesSent+" bytes.  Leaving connection alive."):(this.log_("Closing unhealthy connection after timeout."),this.close()))},Math.floor(i)))}nextTransportId_(){return"c:"+this.id+":"+this.connectionCount++}disconnReceiver_(e){return t=>{e===this.conn_?this.onConnectionLost_(t):e===this.secondaryConn_?(this.log_("Secondary connection lost."),this.onSecondaryConnectionLost_()):this.log_("closing an old connection")}}connReceiver_(e){return t=>{this.state_!==2&&(e===this.rx_?this.onPrimaryMessageReceived_(t):e===this.secondaryConn_?this.onSecondaryMessageReceived_(t):this.log_("message on old connection"))}}sendRequest(e){const t={t:"d",d:e};this.sendData_(t)}tryCleanupConnection(){this.tx_===this.secondaryConn_&&this.rx_===this.secondaryConn_&&(this.log_("cleaning up and promoting a connection: "+this.secondaryConn_.connId),this.conn_=this.secondaryConn_,this.secondaryConn_=null)}onSecondaryControl_(e){if(Cn in e){const t=e[Cn];t===Xs?this.upgradeIfSecondaryHealthy_():t===qs?(this.log_("Got a reset on secondary, closing it"),this.secondaryConn_.close(),(this.tx_===this.secondaryConn_||this.rx_===this.secondaryConn_)&&this.close()):t===Qs&&(this.log_("got pong on secondary."),this.secondaryResponsesRequired_--,this.upgradeIfSecondaryHealthy_())}}onSecondaryMessageReceived_(e){const t=Je("t",e),s=Je("d",e);if(t==="c")this.onSecondaryControl_(s);else if(t==="d")this.pendingDataMessages.push(s);else throw new Error("Unknown protocol layer: "+t)}upgradeIfSecondaryHealthy_(){this.secondaryResponsesRequired_<=0?(this.log_("Secondary connection is healthy."),this.isHealthy_=!0,this.secondaryConn_.markConnectionHealthy(),this.proceedWithUpgrade_()):(this.log_("sending ping on secondary."),this.secondaryConn_.send({t:"c",d:{t:Zs,d:{}}}))}proceedWithUpgrade_(){this.secondaryConn_.start(),this.log_("sending client ack on secondary"),this.secondaryConn_.send({t:"c",d:{t:Xs,d:{}}}),this.log_("Ending transmission on primary"),this.conn_.send({t:"c",d:{t:Js,d:{}}}),this.tx_=this.secondaryConn_,this.tryCleanupConnection()}onPrimaryMessageReceived_(e){const t=Je("t",e),s=Je("d",e);t==="c"?this.onControl_(s):t==="d"&&this.onDataMessage_(s)}onDataMessage_(e){this.onPrimaryResponse_(),this.onMessage_(e)}onPrimaryResponse_(){this.isHealthy_||(this.primaryResponsesRequired_--,this.primaryResponsesRequired_<=0&&(this.log_("Primary connection is healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()))}onControl_(e){const t=Je(Cn,e);if(js in e){const s=e[js];if(t===Jc){const i={...s};this.repoInfo_.isUsingEmulator&&(i.h=this.repoInfo_.host),this.onHandshake_(i)}else if(t===Js){this.log_("recvd end transmission on primary"),this.rx_=this.secondaryConn_;for(let i=0;i<this.pendingDataMessages.length;++i)this.onDataMessage_(this.pendingDataMessages[i]);this.pendingDataMessages=[],this.tryCleanupConnection()}else t===Qc?this.onConnectionShutdown_(s):t===qs?this.onReset_(s):t===Xc?Pn("Server Error: "+s):t===Qs?(this.log_("got pong on primary."),this.onPrimaryResponse_(),this.sendPingOnPrimaryIfNecessary_()):Pn("Unknown control packet command: "+t)}}onHandshake_(e){const t=e.ts,s=e.v,i=e.h;this.sessionId=e.s,this.repoInfo_.host=i,this.state_===0&&(this.conn_.start(),this.onConnectionEstablished_(this.conn_,t),Jn!==s&&V("Protocol version mismatch detected"),this.tryStartUpgrade_())}tryStartUpgrade_(){const e=this.transportManager_.upgradeTransport();e&&this.startUpgrade_(e)}startUpgrade_(e){this.secondaryConn_=new e(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,this.sessionId),this.secondaryResponsesRequired_=e.responsesRequiredToBeHealthy||0;const t=this.connReceiver_(this.secondaryConn_),s=this.disconnReceiver_(this.secondaryConn_);this.secondaryConn_.open(t,s),at(()=>{this.secondaryConn_&&(this.log_("Timed out trying to upgrade."),this.secondaryConn_.close())},Math.floor(zc))}onReset_(e){this.log_("Reset packet received.  New host: "+e),this.repoInfo_.host=e,this.state_===1?this.close():(this.closeConnections_(),this.start_())}onConnectionEstablished_(e,t){this.log_("Realtime connection established."),this.conn_=e,this.state_=1,this.onReady_&&(this.onReady_(t,this.sessionId),this.onReady_=null),this.primaryResponsesRequired_===0?(this.log_("Primary connection is healthy."),this.isHealthy_=!0):at(()=>{this.sendPingOnPrimaryIfNecessary_()},Math.floor(Yc))}sendPingOnPrimaryIfNecessary_(){!this.isHealthy_&&this.state_===1&&(this.log_("sending ping on primary."),this.sendData_({t:"c",d:{t:Zs,d:{}}}))}onSecondaryConnectionLost_(){const e=this.secondaryConn_;this.secondaryConn_=null,(this.tx_===e||this.rx_===e)&&this.close()}onConnectionLost_(e){this.conn_=null,!e&&this.state_===0?(this.log_("Realtime connection failed."),this.repoInfo_.isCacheableHost()&&(Re.remove("host:"+this.repoInfo_.host),this.repoInfo_.internalHost=this.repoInfo_.host)):this.state_===1&&this.log_("Realtime connection lost."),this.close()}onConnectionShutdown_(e){this.log_("Connection shutdown command received. Shutting down..."),this.onKill_&&(this.onKill_(e),this.onKill_=null),this.onDisconnect_=null,this.close()}sendData_(e){if(this.state_!==1)throw"Connection is not connected";this.tx_.send(e)}close(){this.state_!==2&&(this.log_("Closing realtime connection."),this.state_=2,this.closeConnections_(),this.onDisconnect_&&(this.onDisconnect_(),this.onDisconnect_=null))}closeConnections_(){this.log_("Shutting down all connections"),this.conn_&&(this.conn_.close(),this.conn_=null),this.secondaryConn_&&(this.secondaryConn_.close(),this.secondaryConn_=null),this.healthyTimeout_&&(clearTimeout(this.healthyTimeout_),this.healthyTimeout_=null)}}class _r{put(e,t,s,i){}merge(e,t,s,i){}refreshAuthToken(e){}refreshAppCheckToken(e){}onDisconnectPut(e,t,s){}onDisconnectMerge(e,t,s){}onDisconnectCancel(e,t){}reportStats(e){}}class gr{constructor(e){this.allowedEvents_=e,this.listeners_={},m(Array.isArray(e)&&e.length>0,"Requires a non-empty array")}trigger(e,...t){if(Array.isArray(this.listeners_[e])){const s=[...this.listeners_[e]];for(let i=0;i<s.length;i++)s[i].callback.apply(s[i].context,t)}}on(e,t,s){this.validateEventType_(e),this.listeners_[e]=this.listeners_[e]||[],this.listeners_[e].push({callback:t,context:s});const i=this.getInitialEvent(e);i&&t.apply(s,i)}off(e,t,s){this.validateEventType_(e);const i=this.listeners_[e]||[];for(let r=0;r<i.length;r++)if(i[r].callback===t&&(!s||s===i[r].context)){i.splice(r,1);return}}validateEventType_(e){m(this.allowedEvents_.find(t=>t===e),"Unknown event: "+e)}}class Wt extends gr{static getInstance(){return new Wt}constructor(){super(["online"]),this.online_=!0,typeof window<"u"&&typeof window.addEventListener<"u"&&!Gi()&&(window.addEventListener("online",()=>{this.online_||(this.online_=!0,this.trigger("online",!0))},!1),window.addEventListener("offline",()=>{this.online_&&(this.online_=!1,this.trigger("online",!1))},!1))}getInitialEvent(e){return m(e==="online","Unknown event type: "+e),[this.online_]}currentlyOnline(){return this.online_}}const ei=32,ti=768;class N{constructor(e,t){if(t===void 0){this.pieces_=e.split("/");let s=0;for(let i=0;i<this.pieces_.length;i++)this.pieces_[i].length>0&&(this.pieces_[s]=this.pieces_[i],s++);this.pieces_.length=s,this.pieceNum_=0}else this.pieces_=e,this.pieceNum_=t}toString(){let e="";for(let t=this.pieceNum_;t<this.pieces_.length;t++)this.pieces_[t]!==""&&(e+="/"+this.pieces_[t]);return e||"/"}}function T(){return new N("")}function C(n){return n.pieceNum_>=n.pieces_.length?null:n.pieces_[n.pieceNum_]}function Ce(n){return n.pieces_.length-n.pieceNum_}function R(n){let e=n.pieceNum_;return e<n.pieces_.length&&e++,new N(n.pieces_,e)}function ts(n){return n.pieceNum_<n.pieces_.length?n.pieces_[n.pieces_.length-1]:null}function eh(n){let e="";for(let t=n.pieceNum_;t<n.pieces_.length;t++)n.pieces_[t]!==""&&(e+="/"+encodeURIComponent(String(n.pieces_[t])));return e||"/"}function mt(n,e=0){return n.pieces_.slice(n.pieceNum_+e)}function yr(n){if(n.pieceNum_>=n.pieces_.length)return null;const e=[];for(let t=n.pieceNum_;t<n.pieces_.length-1;t++)e.push(n.pieces_[t]);return new N(e,0)}function D(n,e){const t=[];for(let s=n.pieceNum_;s<n.pieces_.length;s++)t.push(n.pieces_[s]);if(e instanceof N)for(let s=e.pieceNum_;s<e.pieces_.length;s++)t.push(e.pieces_[s]);else{const s=e.split("/");for(let i=0;i<s.length;i++)s[i].length>0&&t.push(s[i])}return new N(t,0)}function v(n){return n.pieceNum_>=n.pieces_.length}function $(n,e){const t=C(n),s=C(e);if(t===null)return e;if(t===s)return $(R(n),R(e));throw new Error("INTERNAL ERROR: innerPath ("+e+") is not within outerPath ("+n+")")}function th(n,e){const t=mt(n,0),s=mt(e,0);for(let i=0;i<t.length&&i<s.length;i++){const r=ke(t[i],s[i]);if(r!==0)return r}return t.length===s.length?0:t.length<s.length?-1:1}function ns(n,e){if(Ce(n)!==Ce(e))return!1;for(let t=n.pieceNum_,s=e.pieceNum_;t<=n.pieces_.length;t++,s++)if(n.pieces_[t]!==e.pieces_[s])return!1;return!0}function X(n,e){let t=n.pieceNum_,s=e.pieceNum_;if(Ce(n)>Ce(e))return!1;for(;t<n.pieces_.length;){if(n.pieces_[t]!==e.pieces_[s])return!1;++t,++s}return!0}class nh{constructor(e,t){this.errorPrefix_=t,this.parts_=mt(e,0),this.byteLength_=Math.max(1,this.parts_.length);for(let s=0;s<this.parts_.length;s++)this.byteLength_+=Zt(this.parts_[s]);Er(this)}}function sh(n,e){n.parts_.length>0&&(n.byteLength_+=1),n.parts_.push(e),n.byteLength_+=Zt(e),Er(n)}function ih(n){const e=n.parts_.pop();n.byteLength_-=Zt(e),n.parts_.length>0&&(n.byteLength_-=1)}function Er(n){if(n.byteLength_>ti)throw new Error(n.errorPrefix_+"has a key path longer than "+ti+" bytes ("+n.byteLength_+").");if(n.parts_.length>ei)throw new Error(n.errorPrefix_+"path specified exceeds the maximum depth that can be written ("+ei+") or object contains a cycle "+Ne(n))}function Ne(n){return n.parts_.length===0?"":"in property '"+n.parts_.join(".")+"'"}class ss extends gr{static getInstance(){return new ss}constructor(){super(["visible"]);let e,t;typeof document<"u"&&typeof document.addEventListener<"u"&&(typeof document.hidden<"u"?(t="visibilitychange",e="hidden"):typeof document.mozHidden<"u"?(t="mozvisibilitychange",e="mozHidden"):typeof document.msHidden<"u"?(t="msvisibilitychange",e="msHidden"):typeof document.webkitHidden<"u"&&(t="webkitvisibilitychange",e="webkitHidden")),this.visible_=!0,t&&document.addEventListener(t,()=>{const s=!document[e];s!==this.visible_&&(this.visible_=s,this.trigger("visible",s))},!1)}getInitialEvent(e){return m(e==="visible","Unknown event type: "+e),[this.visible_]}}const Ze=1e3,rh=300*1e3,ni=30*1e3,oh=1.3,ah=3e4,lh="server_kill",si=3;class oe extends _r{constructor(e,t,s,i,r,o,a,l){if(super(),this.repoInfo_=e,this.applicationId_=t,this.onDataUpdate_=s,this.onConnectStatus_=i,this.onServerInfoUpdate_=r,this.authTokenProvider_=o,this.appCheckTokenProvider_=a,this.authOverride_=l,this.id=oe.nextPersistentConnectionId_++,this.log_=wt("p:"+this.id+":"),this.interruptReasons_={},this.listens=new Map,this.outstandingPuts_=[],this.outstandingGets_=[],this.outstandingPutCount_=0,this.outstandingGetCount_=0,this.onDisconnectRequestQueue_=[],this.connected_=!1,this.reconnectDelay_=Ze,this.maxReconnectDelay_=rh,this.securityDebugCallback_=null,this.lastSessionId=null,this.establishConnectionTimer_=null,this.visible_=!1,this.requestCBHash_={},this.requestNumber_=0,this.realtime_=null,this.authToken_=null,this.appCheckToken_=null,this.forceTokenRefresh_=!1,this.invalidAuthTokenCount_=0,this.invalidAppCheckTokenCount_=0,this.firstConnection_=!0,this.lastConnectionAttemptTime_=null,this.lastConnectionEstablishedTime_=null,l)throw new Error("Auth override specified in options, but not supported on non Node.js platforms");ss.getInstance().on("visible",this.onVisible_,this),e.host.indexOf("fblocal")===-1&&Wt.getInstance().on("online",this.onOnline_,this)}sendRequest(e,t,s){const i=++this.requestNumber_,r={r:i,a:e,b:t};this.log_(B(r)),m(this.connected_,"sendRequest call when we're not connected not allowed."),this.realtime_.sendRequest(r),s&&(this.requestCBHash_[i]=s)}get(e){this.initConnection_();const t=new ne,i={action:"g",request:{p:e._path.toString(),q:e._queryObject},onComplete:o=>{const a=o.d;o.s==="ok"?t.resolve(a):t.reject(a)}};this.outstandingGets_.push(i),this.outstandingGetCount_++;const r=this.outstandingGets_.length-1;return this.connected_&&this.sendGet_(r),t.promise}listen(e,t,s,i){this.initConnection_();const r=e._queryIdentifier,o=e._path.toString();this.log_("Listen called for "+o+" "+r),this.listens.has(o)||this.listens.set(o,new Map),m(e._queryParams.isDefault()||!e._queryParams.loadsAllData(),"listen() called for non-default but complete query"),m(!this.listens.get(o).has(r),"listen() called twice for same path/queryId.");const a={onComplete:i,hashFn:t,query:e,tag:s};this.listens.get(o).set(r,a),this.connected_&&this.sendListen_(a)}sendGet_(e){const t=this.outstandingGets_[e];this.sendRequest("g",t.request,s=>{delete this.outstandingGets_[e],this.outstandingGetCount_--,this.outstandingGetCount_===0&&(this.outstandingGets_=[]),t.onComplete&&t.onComplete(s)})}sendListen_(e){const t=e.query,s=t._path.toString(),i=t._queryIdentifier;this.log_("Listen on "+s+" for "+i);const r={p:s},o="q";e.tag&&(r.q=t._queryObject,r.t=e.tag),r.h=e.hashFn(),this.sendRequest(o,r,a=>{const l=a.d,c=a.s;oe.warnOnListenWarnings_(l,t),(this.listens.get(s)&&this.listens.get(s).get(i))===e&&(this.log_("listen response",a),c!=="ok"&&this.removeListen_(s,i),e.onComplete&&e.onComplete(c,l))})}static warnOnListenWarnings_(e,t){if(e&&typeof e=="object"&&se(e,"w")){const s=Ge(e,"w");if(Array.isArray(s)&&~s.indexOf("no_index")){const i='".indexOn": "'+t._queryParams.getIndex().toString()+'"',r=t._path.toString();V(`Using an unspecified index. Your data will be downloaded and filtered on the client. Consider adding ${i} at ${r} to your security rules for better performance.`)}}}refreshAuthToken(e){this.authToken_=e,this.log_("Auth token refreshed"),this.authToken_?this.tryAuth():this.connected_&&this.sendRequest("unauth",{},()=>{}),this.reduceReconnectDelayIfAdminCredential_(e)}reduceReconnectDelayIfAdminCredential_(e){(e&&e.length===40||Ya(e))&&(this.log_("Admin auth credential detected.  Reducing max reconnect time."),this.maxReconnectDelay_=ni)}refreshAppCheckToken(e){this.appCheckToken_=e,this.log_("App check token refreshed"),this.appCheckToken_?this.tryAppCheck():this.connected_&&this.sendRequest("unappeck",{},()=>{})}tryAuth(){if(this.connected_&&this.authToken_){const e=this.authToken_,t=za(e)?"auth":"gauth",s={cred:e};this.authOverride_===null?s.noauth=!0:typeof this.authOverride_=="object"&&(s.authvar=this.authOverride_),this.sendRequest(t,s,i=>{const r=i.s,o=i.d||"error";this.authToken_===e&&(r==="ok"?this.invalidAuthTokenCount_=0:this.onAuthRevoked_(r,o))})}}tryAppCheck(){this.connected_&&this.appCheckToken_&&this.sendRequest("appcheck",{token:this.appCheckToken_},e=>{const t=e.s,s=e.d||"error";t==="ok"?this.invalidAppCheckTokenCount_=0:this.onAppCheckRevoked_(t,s)})}unlisten(e,t){const s=e._path.toString(),i=e._queryIdentifier;this.log_("Unlisten called for "+s+" "+i),m(e._queryParams.isDefault()||!e._queryParams.loadsAllData(),"unlisten() called for non-default but complete query"),this.removeListen_(s,i)&&this.connected_&&this.sendUnlisten_(s,i,e._queryObject,t)}sendUnlisten_(e,t,s,i){this.log_("Unlisten on "+e+" for "+t);const r={p:e},o="n";i&&(r.q=s,r.t=i),this.sendRequest(o,r)}onDisconnectPut(e,t,s){this.initConnection_(),this.connected_?this.sendOnDisconnect_("o",e,t,s):this.onDisconnectRequestQueue_.push({pathString:e,action:"o",data:t,onComplete:s})}onDisconnectMerge(e,t,s){this.initConnection_(),this.connected_?this.sendOnDisconnect_("om",e,t,s):this.onDisconnectRequestQueue_.push({pathString:e,action:"om",data:t,onComplete:s})}onDisconnectCancel(e,t){this.initConnection_(),this.connected_?this.sendOnDisconnect_("oc",e,null,t):this.onDisconnectRequestQueue_.push({pathString:e,action:"oc",data:null,onComplete:t})}sendOnDisconnect_(e,t,s,i){const r={p:t,d:s};this.log_("onDisconnect "+e,r),this.sendRequest(e,r,o=>{i&&setTimeout(()=>{i(o.s,o.d)},Math.floor(0))})}put(e,t,s,i){this.putInternal("p",e,t,s,i)}merge(e,t,s,i){this.putInternal("m",e,t,s,i)}putInternal(e,t,s,i,r){this.initConnection_();const o={p:t,d:s};r!==void 0&&(o.h=r),this.outstandingPuts_.push({action:e,request:o,onComplete:i}),this.outstandingPutCount_++;const a=this.outstandingPuts_.length-1;this.connected_?this.sendPut_(a):this.log_("Buffering put: "+t)}sendPut_(e){const t=this.outstandingPuts_[e].action,s=this.outstandingPuts_[e].request,i=this.outstandingPuts_[e].onComplete;this.outstandingPuts_[e].queued=this.connected_,this.sendRequest(t,s,r=>{this.log_(t+" response",r),delete this.outstandingPuts_[e],this.outstandingPutCount_--,this.outstandingPutCount_===0&&(this.outstandingPuts_=[]),i&&i(r.s,r.d)})}reportStats(e){if(this.connected_){const t={c:e};this.log_("reportStats",t),this.sendRequest("s",t,s=>{if(s.s!=="ok"){const r=s.d;this.log_("reportStats","Error sending stats: "+r)}})}}onDataMessage_(e){if("r"in e){this.log_("from server: "+B(e));const t=e.r,s=this.requestCBHash_[t];s&&(delete this.requestCBHash_[t],s(e.b))}else{if("error"in e)throw"A server-side error has occurred: "+e.error;"a"in e&&this.onDataPush_(e.a,e.b)}}onDataPush_(e,t){this.log_("handleServerMessage",e,t),e==="d"?this.onDataUpdate_(t.p,t.d,!1,t.t):e==="m"?this.onDataUpdate_(t.p,t.d,!0,t.t):e==="c"?this.onListenRevoked_(t.p,t.q):e==="ac"?this.onAuthRevoked_(t.s,t.d):e==="apc"?this.onAppCheckRevoked_(t.s,t.d):e==="sd"?this.onSecurityDebugPacket_(t):Pn("Unrecognized action received from server: "+B(e)+`
Are you using the latest client?`)}onReady_(e,t){this.log_("connection ready"),this.connected_=!0,this.lastConnectionEstablishedTime_=new Date().getTime(),this.handleTimestamp_(e),this.lastSessionId=t,this.firstConnection_&&this.sendConnectStats_(),this.restoreState_(),this.firstConnection_=!1,this.onConnectStatus_(!0)}scheduleConnect_(e){m(!this.realtime_,"Scheduling a connect when we're already connected/ing?"),this.establishConnectionTimer_&&clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=setTimeout(()=>{this.establishConnectionTimer_=null,this.establishConnection_()},Math.floor(e))}initConnection_(){!this.realtime_&&this.firstConnection_&&this.scheduleConnect_(0)}onVisible_(e){e&&!this.visible_&&this.reconnectDelay_===this.maxReconnectDelay_&&(this.log_("Window became visible.  Reducing delay."),this.reconnectDelay_=Ze,this.realtime_||this.scheduleConnect_(0)),this.visible_=e}onOnline_(e){e?(this.log_("Browser went online."),this.reconnectDelay_=Ze,this.realtime_||this.scheduleConnect_(0)):(this.log_("Browser went offline.  Killing connection."),this.realtime_&&this.realtime_.close())}onRealtimeDisconnect_(){if(this.log_("data client disconnected"),this.connected_=!1,this.realtime_=null,this.cancelSentTransactions_(),this.requestCBHash_={},this.shouldReconnect_()){this.visible_?this.lastConnectionEstablishedTime_&&(new Date().getTime()-this.lastConnectionEstablishedTime_>ah&&(this.reconnectDelay_=Ze),this.lastConnectionEstablishedTime_=null):(this.log_("Window isn't visible.  Delaying reconnect."),this.reconnectDelay_=this.maxReconnectDelay_,this.lastConnectionAttemptTime_=new Date().getTime());const e=Math.max(0,new Date().getTime()-this.lastConnectionAttemptTime_);let t=Math.max(0,this.reconnectDelay_-e);t=Math.random()*t,this.log_("Trying to reconnect in "+t+"ms"),this.scheduleConnect_(t),this.reconnectDelay_=Math.min(this.maxReconnectDelay_,this.reconnectDelay_*oh)}this.onConnectStatus_(!1)}async establishConnection_(){if(this.shouldReconnect_()){this.log_("Making a connection attempt"),this.lastConnectionAttemptTime_=new Date().getTime(),this.lastConnectionEstablishedTime_=null;const e=this.onDataMessage_.bind(this),t=this.onReady_.bind(this),s=this.onRealtimeDisconnect_.bind(this),i=this.id+":"+oe.nextConnectionId_++,r=this.lastSessionId;let o=!1,a=null;const l=function(){a?a.close():(o=!0,s())},c=function(h){m(a,"sendRequest call when we're not connected not allowed."),a.sendRequest(h)};this.realtime_={close:l,sendRequest:c};const d=this.forceTokenRefresh_;this.forceTokenRefresh_=!1;try{const[h,u]=await Promise.all([this.authTokenProvider_.getToken(d),this.appCheckTokenProvider_.getToken(d)]);o?G("getToken() completed but was canceled"):(G("getToken() completed. Creating connection."),this.authToken_=h&&h.accessToken,this.appCheckToken_=u&&u.token,a=new Zc(i,this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,e,t,s,p=>{V(p+" ("+this.repoInfo_.toString()+")"),this.interrupt(lh)},r))}catch(h){this.log_("Failed to get token: "+h),o||(this.repoInfo_.nodeAdmin&&V(h),l())}}}interrupt(e){G("Interrupting connection for reason: "+e),this.interruptReasons_[e]=!0,this.realtime_?this.realtime_.close():(this.establishConnectionTimer_&&(clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=null),this.connected_&&this.onRealtimeDisconnect_())}resume(e){G("Resuming connection for reason: "+e),delete this.interruptReasons_[e],Nn(this.interruptReasons_)&&(this.reconnectDelay_=Ze,this.realtime_||this.scheduleConnect_(0))}handleTimestamp_(e){const t=e-new Date().getTime();this.onServerInfoUpdate_({serverTimeOffset:t})}cancelSentTransactions_(){for(let e=0;e<this.outstandingPuts_.length;e++){const t=this.outstandingPuts_[e];t&&"h"in t.request&&t.queued&&(t.onComplete&&t.onComplete("disconnect"),delete this.outstandingPuts_[e],this.outstandingPutCount_--)}this.outstandingPutCount_===0&&(this.outstandingPuts_=[])}onListenRevoked_(e,t){let s;t?s=t.map(r=>Xn(r)).join("$"):s="default";const i=this.removeListen_(e,s);i&&i.onComplete&&i.onComplete("permission_denied")}removeListen_(e,t){const s=new N(e).toString();let i;if(this.listens.has(s)){const r=this.listens.get(s);i=r.get(t),r.delete(t),r.size===0&&this.listens.delete(s)}else i=void 0;return i}onAuthRevoked_(e,t){G("Auth token revoked: "+e+"/"+t),this.authToken_=null,this.forceTokenRefresh_=!0,this.realtime_.close(),(e==="invalid_token"||e==="permission_denied")&&(this.invalidAuthTokenCount_++,this.invalidAuthTokenCount_>=si&&(this.reconnectDelay_=ni,this.authTokenProvider_.notifyForInvalidToken()))}onAppCheckRevoked_(e,t){G("App check token revoked: "+e+"/"+t),this.appCheckToken_=null,this.forceTokenRefresh_=!0,(e==="invalid_token"||e==="permission_denied")&&(this.invalidAppCheckTokenCount_++,this.invalidAppCheckTokenCount_>=si&&this.appCheckTokenProvider_.notifyForInvalidToken())}onSecurityDebugPacket_(e){this.securityDebugCallback_?this.securityDebugCallback_(e):"msg"in e&&console.log("FIREBASE: "+e.msg.replace(`
`,`
FIREBASE: `))}restoreState_(){this.tryAuth(),this.tryAppCheck();for(const e of this.listens.values())for(const t of e.values())this.sendListen_(t);for(let e=0;e<this.outstandingPuts_.length;e++)this.outstandingPuts_[e]&&this.sendPut_(e);for(;this.onDisconnectRequestQueue_.length;){const e=this.onDisconnectRequestQueue_.shift();this.sendOnDisconnect_(e.action,e.pathString,e.data,e.onComplete)}for(let e=0;e<this.outstandingGets_.length;e++)this.outstandingGets_[e]&&this.sendGet_(e)}sendConnectStats_(){const e={};let t="js";e["sdk."+t+"."+qi.replace(/\./g,"-")]=1,Gi()?e["framework.cordova"]=1:Wa()&&(e["framework.reactnative"]=1),this.reportStats(e)}shouldReconnect_(){const e=Wt.getInstance().currentlyOnline();return Nn(this.interruptReasons_)&&e}}oe.nextPersistentConnectionId_=0;oe.nextConnectionId_=0;class I{constructor(e,t){this.name=e,this.node=t}static Wrap(e,t){return new I(e,t)}}class tn{getCompare(){return this.compare.bind(this)}indexedValueChanged(e,t){const s=new I(He,e),i=new I(He,t);return this.compare(s,i)!==0}minPost(){return I.MIN}}let Ot;class Cr extends tn{static get __EMPTY_NODE(){return Ot}static set __EMPTY_NODE(e){Ot=e}compare(e,t){return ke(e.name,t.name)}isDefinedOn(e){throw Ye("KeyIndex.isDefinedOn not expected to be called.")}indexedValueChanged(e,t){return!1}minPost(){return I.MIN}maxPost(){return new I(Ae,Ot)}makePost(e,t){return m(typeof e=="string","KeyIndex indexValue must always be a string."),new I(e,Ot)}toString(){return".key"}}const We=new Cr;class Dt{constructor(e,t,s,i,r=null){this.isReverse_=i,this.resultGenerator_=r,this.nodeStack_=[];let o=1;for(;!e.isEmpty();)if(e=e,o=t?s(e.key,t):1,i&&(o*=-1),o<0)this.isReverse_?e=e.left:e=e.right;else if(o===0){this.nodeStack_.push(e);break}else this.nodeStack_.push(e),this.isReverse_?e=e.right:e=e.left}getNext(){if(this.nodeStack_.length===0)return null;let e=this.nodeStack_.pop(),t;if(this.resultGenerator_?t=this.resultGenerator_(e.key,e.value):t={key:e.key,value:e.value},this.isReverse_)for(e=e.left;!e.isEmpty();)this.nodeStack_.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack_.push(e),e=e.left;return t}hasNext(){return this.nodeStack_.length>0}peek(){if(this.nodeStack_.length===0)return null;const e=this.nodeStack_[this.nodeStack_.length-1];return this.resultGenerator_?this.resultGenerator_(e.key,e.value):{key:e.key,value:e.value}}}class W{constructor(e,t,s,i,r){this.key=e,this.value=t,this.color=s??W.RED,this.left=i??K.EMPTY_NODE,this.right=r??K.EMPTY_NODE}copy(e,t,s,i,r){return new W(e??this.key,t??this.value,s??this.color,i??this.left,r??this.right)}count(){return this.left.count()+1+this.right.count()}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||!!e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min_(){return this.left.isEmpty()?this:this.left.min_()}minKey(){return this.min_().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,s){let i=this;const r=s(e,i.key);return r<0?i=i.copy(null,null,null,i.left.insert(e,t,s),null):r===0?i=i.copy(null,t,null,null,null):i=i.copy(null,null,null,null,i.right.insert(e,t,s)),i.fixUp_()}removeMin_(){if(this.left.isEmpty())return K.EMPTY_NODE;let e=this;return!e.left.isRed_()&&!e.left.left.isRed_()&&(e=e.moveRedLeft_()),e=e.copy(null,null,null,e.left.removeMin_(),null),e.fixUp_()}remove(e,t){let s,i;if(s=this,t(e,s.key)<0)!s.left.isEmpty()&&!s.left.isRed_()&&!s.left.left.isRed_()&&(s=s.moveRedLeft_()),s=s.copy(null,null,null,s.left.remove(e,t),null);else{if(s.left.isRed_()&&(s=s.rotateRight_()),!s.right.isEmpty()&&!s.right.isRed_()&&!s.right.left.isRed_()&&(s=s.moveRedRight_()),t(e,s.key)===0){if(s.right.isEmpty())return K.EMPTY_NODE;i=s.right.min_(),s=s.copy(i.key,i.value,null,null,s.right.removeMin_())}s=s.copy(null,null,null,null,s.right.remove(e,t))}return s.fixUp_()}isRed_(){return this.color}fixUp_(){let e=this;return e.right.isRed_()&&!e.left.isRed_()&&(e=e.rotateLeft_()),e.left.isRed_()&&e.left.left.isRed_()&&(e=e.rotateRight_()),e.left.isRed_()&&e.right.isRed_()&&(e=e.colorFlip_()),e}moveRedLeft_(){let e=this.colorFlip_();return e.right.left.isRed_()&&(e=e.copy(null,null,null,null,e.right.rotateRight_()),e=e.rotateLeft_(),e=e.colorFlip_()),e}moveRedRight_(){let e=this.colorFlip_();return e.left.left.isRed_()&&(e=e.rotateRight_(),e=e.colorFlip_()),e}rotateLeft_(){const e=this.copy(null,null,W.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight_(){const e=this.copy(null,null,W.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip_(){const e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth_(){const e=this.check_();return Math.pow(2,e)<=this.count()+1}check_(){if(this.isRed_()&&this.left.isRed_())throw new Error("Red node has red child("+this.key+","+this.value+")");if(this.right.isRed_())throw new Error("Right child of ("+this.key+","+this.value+") is red");const e=this.left.check_();if(e!==this.right.check_())throw new Error("Black depths differ");return e+(this.isRed_()?0:1)}}W.RED=!0;W.BLACK=!1;class ch{copy(e,t,s,i,r){return this}insert(e,t,s){return new W(e,t,null)}remove(e,t){return this}count(){return 0}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}check_(){return 0}isRed_(){return!1}}class K{constructor(e,t=K.EMPTY_NODE){this.comparator_=e,this.root_=t}insert(e,t){return new K(this.comparator_,this.root_.insert(e,t,this.comparator_).copy(null,null,W.BLACK,null,null))}remove(e){return new K(this.comparator_,this.root_.remove(e,this.comparator_).copy(null,null,W.BLACK,null,null))}get(e){let t,s=this.root_;for(;!s.isEmpty();){if(t=this.comparator_(e,s.key),t===0)return s.value;t<0?s=s.left:t>0&&(s=s.right)}return null}getPredecessorKey(e){let t,s=this.root_,i=null;for(;!s.isEmpty();)if(t=this.comparator_(e,s.key),t===0){if(s.left.isEmpty())return i?i.key:null;for(s=s.left;!s.right.isEmpty();)s=s.right;return s.key}else t<0?s=s.left:t>0&&(i=s,s=s.right);throw new Error("Attempted to find predecessor key for a nonexistent key.  What gives?")}isEmpty(){return this.root_.isEmpty()}count(){return this.root_.count()}minKey(){return this.root_.minKey()}maxKey(){return this.root_.maxKey()}inorderTraversal(e){return this.root_.inorderTraversal(e)}reverseTraversal(e){return this.root_.reverseTraversal(e)}getIterator(e){return new Dt(this.root_,null,this.comparator_,!1,e)}getIteratorFrom(e,t){return new Dt(this.root_,e,this.comparator_,!1,t)}getReverseIteratorFrom(e,t){return new Dt(this.root_,e,this.comparator_,!0,t)}getReverseIterator(e){return new Dt(this.root_,null,this.comparator_,!0,e)}}K.EMPTY_NODE=new ch;function hh(n,e){return ke(n.name,e.name)}function is(n,e){return ke(n,e)}let Mn;function uh(n){Mn=n}const vr=function(n){return typeof n=="number"?"number:"+Zi(n):"string:"+n},Sr=function(n){if(n.isLeafNode()){const e=n.val();m(typeof e=="string"||typeof e=="number"||typeof e=="object"&&se(e,".sv"),"Priority must be a string or number.")}else m(n===Mn||n.isEmpty(),"priority of unexpected type.");m(n===Mn||n.getPriority().isEmpty(),"Priority nodes can't have a priority of their own.")};let ii;class F{static set __childrenNodeConstructor(e){ii=e}static get __childrenNodeConstructor(){return ii}constructor(e,t=F.__childrenNodeConstructor.EMPTY_NODE){this.value_=e,this.priorityNode_=t,this.lazyHash_=null,m(this.value_!==void 0&&this.value_!==null,"LeafNode shouldn't be created with null/undefined value."),Sr(this.priorityNode_)}isLeafNode(){return!0}getPriority(){return this.priorityNode_}updatePriority(e){return new F(this.value_,e)}getImmediateChild(e){return e===".priority"?this.priorityNode_:F.__childrenNodeConstructor.EMPTY_NODE}getChild(e){return v(e)?this:C(e)===".priority"?this.priorityNode_:F.__childrenNodeConstructor.EMPTY_NODE}hasChild(){return!1}getPredecessorChildName(e,t){return null}updateImmediateChild(e,t){return e===".priority"?this.updatePriority(t):t.isEmpty()&&e!==".priority"?this:F.__childrenNodeConstructor.EMPTY_NODE.updateImmediateChild(e,t).updatePriority(this.priorityNode_)}updateChild(e,t){const s=C(e);return s===null?t:t.isEmpty()&&s!==".priority"?this:(m(s!==".priority"||Ce(e)===1,".priority must be the last token in a path"),this.updateImmediateChild(s,F.__childrenNodeConstructor.EMPTY_NODE.updateChild(R(e),t)))}isEmpty(){return!1}numChildren(){return 0}forEachChild(e,t){return!1}val(e){return e&&!this.getPriority().isEmpty()?{".value":this.getValue(),".priority":this.getPriority().val()}:this.getValue()}hash(){if(this.lazyHash_===null){let e="";this.priorityNode_.isEmpty()||(e+="priority:"+vr(this.priorityNode_.val())+":");const t=typeof this.value_;e+=t+":",t==="number"?e+=Zi(this.value_):e+=this.value_,this.lazyHash_=Xi(e)}return this.lazyHash_}getValue(){return this.value_}compareTo(e){return e===F.__childrenNodeConstructor.EMPTY_NODE?1:e instanceof F.__childrenNodeConstructor?-1:(m(e.isLeafNode(),"Unknown node type"),this.compareToLeafNode_(e))}compareToLeafNode_(e){const t=typeof e.value_,s=typeof this.value_,i=F.VALUE_TYPE_ORDER.indexOf(t),r=F.VALUE_TYPE_ORDER.indexOf(s);return m(i>=0,"Unknown leaf type: "+t),m(r>=0,"Unknown leaf type: "+s),i===r?s==="object"?0:this.value_<e.value_?-1:this.value_===e.value_?0:1:r-i}withIndex(){return this}isIndexed(){return!0}equals(e){if(e===this)return!0;if(e.isLeafNode()){const t=e;return this.value_===t.value_&&this.priorityNode_.equals(t.priorityNode_)}else return!1}}F.VALUE_TYPE_ORDER=["object","boolean","number","string"];let Ir,br;function dh(n){Ir=n}function fh(n){br=n}class ph extends tn{compare(e,t){const s=e.node.getPriority(),i=t.node.getPriority(),r=s.compareTo(i);return r===0?ke(e.name,t.name):r}isDefinedOn(e){return!e.getPriority().isEmpty()}indexedValueChanged(e,t){return!e.getPriority().equals(t.getPriority())}minPost(){return I.MIN}maxPost(){return new I(Ae,new F("[PRIORITY-POST]",br))}makePost(e,t){const s=Ir(e);return new I(t,new F("[PRIORITY-POST]",s))}toString(){return".priority"}}const k=new ph;const mh=Math.log(2);class _h{constructor(e){const t=r=>parseInt(Math.log(r)/mh,10),s=r=>parseInt(Array(r+1).join("1"),2);this.count=t(e+1),this.current_=this.count-1;const i=s(this.count);this.bits_=e+1&i}nextBitIsOne(){const e=!(this.bits_&1<<this.current_);return this.current_--,e}}const Gt=function(n,e,t,s){n.sort(e);const i=function(l,c){const d=c-l;let h,u;if(d===0)return null;if(d===1)return h=n[l],u=t?t(h):h,new W(u,h.node,W.BLACK,null,null);{const p=parseInt(d/2,10)+l,_=i(l,p),g=i(p+1,c);return h=n[p],u=t?t(h):h,new W(u,h.node,W.BLACK,_,g)}},r=function(l){let c=null,d=null,h=n.length;const u=function(_,g){const w=h-_,M=h;h-=_;const E=i(w+1,M),b=n[w],x=t?t(b):b;p(new W(x,b.node,g,null,E))},p=function(_){c?(c.left=_,c=_):(d=_,c=_)};for(let _=0;_<l.count;++_){const g=l.nextBitIsOne(),w=Math.pow(2,l.count-(_+1));g?u(w,W.BLACK):(u(w,W.BLACK),u(w,W.RED))}return d},o=new _h(n.length),a=r(o);return new K(s||e,a)};let vn;const Le={};class re{static get Default(){return m(Le&&k,"ChildrenNode.ts has not been loaded"),vn=vn||new re({".priority":Le},{".priority":k}),vn}constructor(e,t){this.indexes_=e,this.indexSet_=t}get(e){const t=Ge(this.indexes_,e);if(!t)throw new Error("No index defined for "+e);return t instanceof K?t:null}hasIndex(e){return se(this.indexSet_,e.toString())}addIndex(e,t){m(e!==We,"KeyIndex always exists and isn't meant to be added to the IndexMap.");const s=[];let i=!1;const r=t.getIterator(I.Wrap);let o=r.getNext();for(;o;)i=i||e.isDefinedOn(o.node),s.push(o),o=r.getNext();let a;i?a=Gt(s,e.getCompare()):a=Le;const l=e.toString(),c={...this.indexSet_};c[l]=e;const d={...this.indexes_};return d[l]=a,new re(d,c)}addToIndexes(e,t){const s=Lt(this.indexes_,(i,r)=>{const o=Ge(this.indexSet_,r);if(m(o,"Missing index implementation for "+r),i===Le)if(o.isDefinedOn(e.node)){const a=[],l=t.getIterator(I.Wrap);let c=l.getNext();for(;c;)c.name!==e.name&&a.push(c),c=l.getNext();return a.push(e),Gt(a,o.getCompare())}else return Le;else{const a=t.get(e.name);let l=i;return a&&(l=l.remove(new I(e.name,a))),l.insert(e,e.node)}});return new re(s,this.indexSet_)}removeFromIndexes(e,t){const s=Lt(this.indexes_,i=>{if(i===Le)return i;{const r=t.get(e.name);return r?i.remove(new I(e.name,r)):i}});return new re(s,this.indexSet_)}}let et;class y{static get EMPTY_NODE(){return et||(et=new y(new K(is),null,re.Default))}constructor(e,t,s){this.children_=e,this.priorityNode_=t,this.indexMap_=s,this.lazyHash_=null,this.priorityNode_&&Sr(this.priorityNode_),this.children_.isEmpty()&&m(!this.priorityNode_||this.priorityNode_.isEmpty(),"An empty node cannot have a priority")}isLeafNode(){return!1}getPriority(){return this.priorityNode_||et}updatePriority(e){return this.children_.isEmpty()?this:new y(this.children_,e,this.indexMap_)}getImmediateChild(e){if(e===".priority")return this.getPriority();{const t=this.children_.get(e);return t===null?et:t}}getChild(e){const t=C(e);return t===null?this:this.getImmediateChild(t).getChild(R(e))}hasChild(e){return this.children_.get(e)!==null}updateImmediateChild(e,t){if(m(t,"We should always be passing snapshot nodes"),e===".priority")return this.updatePriority(t);{const s=new I(e,t);let i,r;t.isEmpty()?(i=this.children_.remove(e),r=this.indexMap_.removeFromIndexes(s,this.children_)):(i=this.children_.insert(e,t),r=this.indexMap_.addToIndexes(s,this.children_));const o=i.isEmpty()?et:this.priorityNode_;return new y(i,o,r)}}updateChild(e,t){const s=C(e);if(s===null)return t;{m(C(e)!==".priority"||Ce(e)===1,".priority must be the last token in a path");const i=this.getImmediateChild(s).updateChild(R(e),t);return this.updateImmediateChild(s,i)}}isEmpty(){return this.children_.isEmpty()}numChildren(){return this.children_.count()}val(e){if(this.isEmpty())return null;const t={};let s=0,i=0,r=!0;if(this.forEachChild(k,(o,a)=>{t[o]=a.val(e),s++,r&&y.INTEGER_REGEXP_.test(o)?i=Math.max(i,Number(o)):r=!1}),!e&&r&&i<2*s){const o=[];for(const a in t)o[a]=t[a];return o}else return e&&!this.getPriority().isEmpty()&&(t[".priority"]=this.getPriority().val()),t}hash(){if(this.lazyHash_===null){let e="";this.getPriority().isEmpty()||(e+="priority:"+vr(this.getPriority().val())+":"),this.forEachChild(k,(t,s)=>{const i=s.hash();i!==""&&(e+=":"+t+":"+i)}),this.lazyHash_=e===""?"":Xi(e)}return this.lazyHash_}getPredecessorChildName(e,t,s){const i=this.resolveIndex_(s);if(i){const r=i.getPredecessorKey(new I(e,t));return r?r.name:null}else return this.children_.getPredecessorKey(e)}getFirstChildName(e){const t=this.resolveIndex_(e);if(t){const s=t.minKey();return s&&s.name}else return this.children_.minKey()}getFirstChild(e){const t=this.getFirstChildName(e);return t?new I(t,this.children_.get(t)):null}getLastChildName(e){const t=this.resolveIndex_(e);if(t){const s=t.maxKey();return s&&s.name}else return this.children_.maxKey()}getLastChild(e){const t=this.getLastChildName(e);return t?new I(t,this.children_.get(t)):null}forEachChild(e,t){const s=this.resolveIndex_(e);return s?s.inorderTraversal(i=>t(i.name,i.node)):this.children_.inorderTraversal(t)}getIterator(e){return this.getIteratorFrom(e.minPost(),e)}getIteratorFrom(e,t){const s=this.resolveIndex_(t);if(s)return s.getIteratorFrom(e,i=>i);{const i=this.children_.getIteratorFrom(e.name,I.Wrap);let r=i.peek();for(;r!=null&&t.compare(r,e)<0;)i.getNext(),r=i.peek();return i}}getReverseIterator(e){return this.getReverseIteratorFrom(e.maxPost(),e)}getReverseIteratorFrom(e,t){const s=this.resolveIndex_(t);if(s)return s.getReverseIteratorFrom(e,i=>i);{const i=this.children_.getReverseIteratorFrom(e.name,I.Wrap);let r=i.peek();for(;r!=null&&t.compare(r,e)>0;)i.getNext(),r=i.peek();return i}}compareTo(e){return this.isEmpty()?e.isEmpty()?0:-1:e.isLeafNode()||e.isEmpty()?1:e===Tt?-1:0}withIndex(e){if(e===We||this.indexMap_.hasIndex(e))return this;{const t=this.indexMap_.addIndex(e,this.children_);return new y(this.children_,this.priorityNode_,t)}}isIndexed(e){return e===We||this.indexMap_.hasIndex(e)}equals(e){if(e===this)return!0;if(e.isLeafNode())return!1;{const t=e;if(this.getPriority().equals(t.getPriority()))if(this.children_.count()===t.children_.count()){const s=this.getIterator(k),i=t.getIterator(k);let r=s.getNext(),o=i.getNext();for(;r&&o;){if(r.name!==o.name||!r.node.equals(o.node))return!1;r=s.getNext(),o=i.getNext()}return r===null&&o===null}else return!1;else return!1}}resolveIndex_(e){return e===We?null:this.indexMap_.get(e.toString())}}y.INTEGER_REGEXP_=/^(0|[1-9]\d*)$/;class gh extends y{constructor(){super(new K(is),y.EMPTY_NODE,re.Default)}compareTo(e){return e===this?0:1}equals(e){return e===this}getPriority(){return this}getImmediateChild(e){return y.EMPTY_NODE}isEmpty(){return!1}}const Tt=new gh;Object.defineProperties(I,{MIN:{value:new I(He,y.EMPTY_NODE)},MAX:{value:new I(Ae,Tt)}});Cr.__EMPTY_NODE=y.EMPTY_NODE;F.__childrenNodeConstructor=y;uh(Tt);fh(Tt);const yh=!0;function P(n,e=null){if(n===null)return y.EMPTY_NODE;if(typeof n=="object"&&".priority"in n&&(e=n[".priority"]),m(e===null||typeof e=="string"||typeof e=="number"||typeof e=="object"&&".sv"in e,"Invalid priority type found: "+typeof e),typeof n=="object"&&".value"in n&&n[".value"]!==null&&(n=n[".value"]),typeof n!="object"||".sv"in n){const t=n;return new F(t,P(e))}if(!(n instanceof Array)&&yh){const t=[];let s=!1;if(U(n,(o,a)=>{if(o.substring(0,1)!=="."){const l=P(a);l.isEmpty()||(s=s||!l.getPriority().isEmpty(),t.push(new I(o,l)))}}),t.length===0)return y.EMPTY_NODE;const r=Gt(t,hh,o=>o.name,is);if(s){const o=Gt(t,k.getCompare());return new y(r,P(e),new re({".priority":o},{".priority":k}))}else return new y(r,P(e),re.Default)}else{let t=y.EMPTY_NODE;return U(n,(s,i)=>{if(se(n,s)&&s.substring(0,1)!=="."){const r=P(i);(r.isLeafNode()||!r.isEmpty())&&(t=t.updateImmediateChild(s,r))}}),t.updatePriority(P(e))}}dh(P);class Eh extends tn{constructor(e){super(),this.indexPath_=e,m(!v(e)&&C(e)!==".priority","Can't create PathIndex with empty path or .priority key")}extractChild(e){return e.getChild(this.indexPath_)}isDefinedOn(e){return!e.getChild(this.indexPath_).isEmpty()}compare(e,t){const s=this.extractChild(e.node),i=this.extractChild(t.node),r=s.compareTo(i);return r===0?ke(e.name,t.name):r}makePost(e,t){const s=P(e),i=y.EMPTY_NODE.updateChild(this.indexPath_,s);return new I(t,i)}maxPost(){const e=y.EMPTY_NODE.updateChild(this.indexPath_,Tt);return new I(Ae,e)}toString(){return mt(this.indexPath_,0).join("/")}}class Ch extends tn{compare(e,t){const s=e.node.compareTo(t.node);return s===0?ke(e.name,t.name):s}isDefinedOn(e){return!0}indexedValueChanged(e,t){return!e.equals(t)}minPost(){return I.MIN}maxPost(){return I.MAX}makePost(e,t){const s=P(e);return new I(t,s)}toString(){return".value"}}const vh=new Ch;function wr(n){return{type:"value",snapshotNode:n}}function $e(n,e){return{type:"child_added",snapshotNode:e,childName:n}}function _t(n,e){return{type:"child_removed",snapshotNode:e,childName:n}}function gt(n,e,t){return{type:"child_changed",snapshotNode:e,childName:n,oldSnap:t}}function Sh(n,e){return{type:"child_moved",snapshotNode:e,childName:n}}class rs{constructor(e){this.index_=e}updateChild(e,t,s,i,r,o){m(e.isIndexed(this.index_),"A node must be indexed if only a child is updated");const a=e.getImmediateChild(t);return a.getChild(i).equals(s.getChild(i))&&a.isEmpty()===s.isEmpty()||(o!=null&&(s.isEmpty()?e.hasChild(t)?o.trackChildChange(_t(t,a)):m(e.isLeafNode(),"A child remove without an old child only makes sense on a leaf node"):a.isEmpty()?o.trackChildChange($e(t,s)):o.trackChildChange(gt(t,s,a))),e.isLeafNode()&&s.isEmpty())?e:e.updateImmediateChild(t,s).withIndex(this.index_)}updateFullNode(e,t,s){return s!=null&&(e.isLeafNode()||e.forEachChild(k,(i,r)=>{t.hasChild(i)||s.trackChildChange(_t(i,r))}),t.isLeafNode()||t.forEachChild(k,(i,r)=>{if(e.hasChild(i)){const o=e.getImmediateChild(i);o.equals(r)||s.trackChildChange(gt(i,r,o))}else s.trackChildChange($e(i,r))})),t.withIndex(this.index_)}updatePriority(e,t){return e.isEmpty()?y.EMPTY_NODE:e.updatePriority(t)}filtersNodes(){return!1}getIndexedFilter(){return this}getIndex(){return this.index_}}class yt{constructor(e){this.indexedFilter_=new rs(e.getIndex()),this.index_=e.getIndex(),this.startPost_=yt.getStartPost_(e),this.endPost_=yt.getEndPost_(e),this.startIsInclusive_=!e.startAfterSet_,this.endIsInclusive_=!e.endBeforeSet_}getStartPost(){return this.startPost_}getEndPost(){return this.endPost_}matches(e){const t=this.startIsInclusive_?this.index_.compare(this.getStartPost(),e)<=0:this.index_.compare(this.getStartPost(),e)<0,s=this.endIsInclusive_?this.index_.compare(e,this.getEndPost())<=0:this.index_.compare(e,this.getEndPost())<0;return t&&s}updateChild(e,t,s,i,r,o){return this.matches(new I(t,s))||(s=y.EMPTY_NODE),this.indexedFilter_.updateChild(e,t,s,i,r,o)}updateFullNode(e,t,s){t.isLeafNode()&&(t=y.EMPTY_NODE);let i=t.withIndex(this.index_);i=i.updatePriority(y.EMPTY_NODE);const r=this;return t.forEachChild(k,(o,a)=>{r.matches(new I(o,a))||(i=i.updateImmediateChild(o,y.EMPTY_NODE))}),this.indexedFilter_.updateFullNode(e,i,s)}updatePriority(e,t){return e}filtersNodes(){return!0}getIndexedFilter(){return this.indexedFilter_}getIndex(){return this.index_}static getStartPost_(e){if(e.hasStart()){const t=e.getIndexStartName();return e.getIndex().makePost(e.getIndexStartValue(),t)}else return e.getIndex().minPost()}static getEndPost_(e){if(e.hasEnd()){const t=e.getIndexEndName();return e.getIndex().makePost(e.getIndexEndValue(),t)}else return e.getIndex().maxPost()}}class Ih{constructor(e){this.withinDirectionalStart=t=>this.reverse_?this.withinEndPost(t):this.withinStartPost(t),this.withinDirectionalEnd=t=>this.reverse_?this.withinStartPost(t):this.withinEndPost(t),this.withinStartPost=t=>{const s=this.index_.compare(this.rangedFilter_.getStartPost(),t);return this.startIsInclusive_?s<=0:s<0},this.withinEndPost=t=>{const s=this.index_.compare(t,this.rangedFilter_.getEndPost());return this.endIsInclusive_?s<=0:s<0},this.rangedFilter_=new yt(e),this.index_=e.getIndex(),this.limit_=e.getLimit(),this.reverse_=!e.isViewFromLeft(),this.startIsInclusive_=!e.startAfterSet_,this.endIsInclusive_=!e.endBeforeSet_}updateChild(e,t,s,i,r,o){return this.rangedFilter_.matches(new I(t,s))||(s=y.EMPTY_NODE),e.getImmediateChild(t).equals(s)?e:e.numChildren()<this.limit_?this.rangedFilter_.getIndexedFilter().updateChild(e,t,s,i,r,o):this.fullLimitUpdateChild_(e,t,s,r,o)}updateFullNode(e,t,s){let i;if(t.isLeafNode()||t.isEmpty())i=y.EMPTY_NODE.withIndex(this.index_);else if(this.limit_*2<t.numChildren()&&t.isIndexed(this.index_)){i=y.EMPTY_NODE.withIndex(this.index_);let r;this.reverse_?r=t.getReverseIteratorFrom(this.rangedFilter_.getEndPost(),this.index_):r=t.getIteratorFrom(this.rangedFilter_.getStartPost(),this.index_);let o=0;for(;r.hasNext()&&o<this.limit_;){const a=r.getNext();if(this.withinDirectionalStart(a))if(this.withinDirectionalEnd(a))i=i.updateImmediateChild(a.name,a.node),o++;else break;else continue}}else{i=t.withIndex(this.index_),i=i.updatePriority(y.EMPTY_NODE);let r;this.reverse_?r=i.getReverseIterator(this.index_):r=i.getIterator(this.index_);let o=0;for(;r.hasNext();){const a=r.getNext();o<this.limit_&&this.withinDirectionalStart(a)&&this.withinDirectionalEnd(a)?o++:i=i.updateImmediateChild(a.name,y.EMPTY_NODE)}}return this.rangedFilter_.getIndexedFilter().updateFullNode(e,i,s)}updatePriority(e,t){return e}filtersNodes(){return!0}getIndexedFilter(){return this.rangedFilter_.getIndexedFilter()}getIndex(){return this.index_}fullLimitUpdateChild_(e,t,s,i,r){let o;if(this.reverse_){const h=this.index_.getCompare();o=(u,p)=>h(p,u)}else o=this.index_.getCompare();const a=e;m(a.numChildren()===this.limit_,"");const l=new I(t,s),c=this.reverse_?a.getFirstChild(this.index_):a.getLastChild(this.index_),d=this.rangedFilter_.matches(l);if(a.hasChild(t)){const h=a.getImmediateChild(t);let u=i.getChildAfterChild(this.index_,c,this.reverse_);for(;u!=null&&(u.name===t||a.hasChild(u.name));)u=i.getChildAfterChild(this.index_,u,this.reverse_);const p=u==null?1:o(u,l);if(d&&!s.isEmpty()&&p>=0)return r?.trackChildChange(gt(t,s,h)),a.updateImmediateChild(t,s);{r?.trackChildChange(_t(t,h));const g=a.updateImmediateChild(t,y.EMPTY_NODE);return u!=null&&this.rangedFilter_.matches(u)?(r?.trackChildChange($e(u.name,u.node)),g.updateImmediateChild(u.name,u.node)):g}}else return s.isEmpty()?e:d&&o(c,l)>=0?(r!=null&&(r.trackChildChange(_t(c.name,c.node)),r.trackChildChange($e(t,s))),a.updateImmediateChild(t,s).updateImmediateChild(c.name,y.EMPTY_NODE)):e}}class os{constructor(){this.limitSet_=!1,this.startSet_=!1,this.startNameSet_=!1,this.startAfterSet_=!1,this.endSet_=!1,this.endNameSet_=!1,this.endBeforeSet_=!1,this.limit_=0,this.viewFrom_="",this.indexStartValue_=null,this.indexStartName_="",this.indexEndValue_=null,this.indexEndName_="",this.index_=k}hasStart(){return this.startSet_}isViewFromLeft(){return this.viewFrom_===""?this.startSet_:this.viewFrom_==="l"}getIndexStartValue(){return m(this.startSet_,"Only valid if start has been set"),this.indexStartValue_}getIndexStartName(){return m(this.startSet_,"Only valid if start has been set"),this.startNameSet_?this.indexStartName_:He}hasEnd(){return this.endSet_}getIndexEndValue(){return m(this.endSet_,"Only valid if end has been set"),this.indexEndValue_}getIndexEndName(){return m(this.endSet_,"Only valid if end has been set"),this.endNameSet_?this.indexEndName_:Ae}hasLimit(){return this.limitSet_}hasAnchoredLimit(){return this.limitSet_&&this.viewFrom_!==""}getLimit(){return m(this.limitSet_,"Only valid if limit has been set"),this.limit_}getIndex(){return this.index_}loadsAllData(){return!(this.startSet_||this.endSet_||this.limitSet_)}isDefault(){return this.loadsAllData()&&this.index_===k}copy(){const e=new os;return e.limitSet_=this.limitSet_,e.limit_=this.limit_,e.startSet_=this.startSet_,e.startAfterSet_=this.startAfterSet_,e.indexStartValue_=this.indexStartValue_,e.startNameSet_=this.startNameSet_,e.indexStartName_=this.indexStartName_,e.endSet_=this.endSet_,e.endBeforeSet_=this.endBeforeSet_,e.indexEndValue_=this.indexEndValue_,e.endNameSet_=this.endNameSet_,e.indexEndName_=this.indexEndName_,e.index_=this.index_,e.viewFrom_=this.viewFrom_,e}}function bh(n){return n.loadsAllData()?new rs(n.getIndex()):n.hasLimit()?new Ih(n):new yt(n)}function ri(n){const e={};if(n.isDefault())return e;let t;if(n.index_===k?t="$priority":n.index_===vh?t="$value":n.index_===We?t="$key":(m(n.index_ instanceof Eh,"Unrecognized index type!"),t=n.index_.toString()),e.orderBy=B(t),n.startSet_){const s=n.startAfterSet_?"startAfter":"startAt";e[s]=B(n.indexStartValue_),n.startNameSet_&&(e[s]+=","+B(n.indexStartName_))}if(n.endSet_){const s=n.endBeforeSet_?"endBefore":"endAt";e[s]=B(n.indexEndValue_),n.endNameSet_&&(e[s]+=","+B(n.indexEndName_))}return n.limitSet_&&(n.isViewFromLeft()?e.limitToFirst=n.limit_:e.limitToLast=n.limit_),e}function oi(n){const e={};if(n.startSet_&&(e.sp=n.indexStartValue_,n.startNameSet_&&(e.sn=n.indexStartName_),e.sin=!n.startAfterSet_),n.endSet_&&(e.ep=n.indexEndValue_,n.endNameSet_&&(e.en=n.indexEndName_),e.ein=!n.endBeforeSet_),n.limitSet_){e.l=n.limit_;let t=n.viewFrom_;t===""&&(n.isViewFromLeft()?t="l":t="r"),e.vf=t}return n.index_!==k&&(e.i=n.index_.toString()),e}class Ut extends _r{reportStats(e){throw new Error("Method not implemented.")}static getListenId_(e,t){return t!==void 0?"tag$"+t:(m(e._queryParams.isDefault(),"should have a tag if it's not a default query."),e._path.toString())}constructor(e,t,s,i){super(),this.repoInfo_=e,this.onDataUpdate_=t,this.authTokenProvider_=s,this.appCheckTokenProvider_=i,this.log_=wt("p:rest:"),this.listens_={}}listen(e,t,s,i){const r=e._path.toString();this.log_("Listen called for "+r+" "+e._queryIdentifier);const o=Ut.getListenId_(e,s),a={};this.listens_[o]=a;const l=ri(e._queryParams);this.restRequest_(r+".json",l,(c,d)=>{let h=d;if(c===404&&(h=null,c=null),c===null&&this.onDataUpdate_(r,h,!1,s),Ge(this.listens_,o)===a){let u;c?c===401?u="permission_denied":u="rest_error:"+c:u="ok",i(u,null)}})}unlisten(e,t){const s=Ut.getListenId_(e,t);delete this.listens_[s]}get(e){const t=ri(e._queryParams),s=e._path.toString(),i=new ne;return this.restRequest_(s+".json",t,(r,o)=>{let a=o;r===404&&(a=null,r=null),r===null?(this.onDataUpdate_(s,a,!1,null),i.resolve(a)):i.reject(new Error(a))}),i.promise}refreshAuthToken(e){}restRequest_(e,t={},s){return t.format="export",Promise.all([this.authTokenProvider_.getToken(!1),this.appCheckTokenProvider_.getToken(!1)]).then(([i,r])=>{i&&i.accessToken&&(t.auth=i.accessToken),r&&r.token&&(t.ac=r.token);const o=(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host+e+"?ns="+this.repoInfo_.namespace+ja(t);this.log_("Sending REST request for "+o);const a=new XMLHttpRequest;a.onreadystatechange=()=>{if(s&&a.readyState===4){this.log_("REST Response for "+o+" received. status:",a.status,"response:",a.responseText);let l=null;if(a.status>=200&&a.status<300){try{l=ut(a.responseText)}catch{V("Failed to parse JSON response for "+o+": "+a.responseText)}s(null,l)}else a.status!==401&&a.status!==404&&V("Got unsuccessful REST response for "+o+" Status: "+a.status),s(a.status);s=null}},a.open("GET",o,!0),a.send()})}}class wh{constructor(){this.rootNode_=y.EMPTY_NODE}getNode(e){return this.rootNode_.getChild(e)}updateSnapshot(e,t){this.rootNode_=this.rootNode_.updateChild(e,t)}}function Ht(){return{value:null,children:new Map}}function qe(n,e,t){if(v(e))n.value=t,n.children.clear();else if(n.value!==null)n.value=n.value.updateChild(e,t);else{const s=C(e);n.children.has(s)||n.children.set(s,Ht());const i=n.children.get(s);e=R(e),qe(i,e,t)}}function xn(n,e){if(v(e))return n.value=null,n.children.clear(),!0;if(n.value!==null){if(n.value.isLeafNode())return!1;{const t=n.value;return n.value=null,t.forEachChild(k,(s,i)=>{qe(n,new N(s),i)}),xn(n,e)}}else if(n.children.size>0){const t=C(e);return e=R(e),n.children.has(t)&&xn(n.children.get(t),e)&&n.children.delete(t),n.children.size===0}else return!0}function Bn(n,e,t){n.value!==null?t(e,n.value):Th(n,(s,i)=>{const r=new N(e.toString()+"/"+s);Bn(i,r,t)})}function Th(n,e){n.children.forEach((t,s)=>{e(s,t)})}class Nh{constructor(e){this.collection_=e,this.last_=null}get(){const e=this.collection_.get(),t={...e};return this.last_&&U(this.last_,(s,i)=>{t[s]=t[s]-i}),this.last_=e,t}}const ai=10*1e3,Rh=30*1e3,Ah=300*1e3;class Oh{constructor(e,t){this.server_=t,this.statsToReport_={},this.statsListener_=new Nh(e);const s=ai+(Rh-ai)*Math.random();at(this.reportStats_.bind(this),Math.floor(s))}reportStats_(){const e=this.statsListener_.get(),t={};let s=!1;U(e,(i,r)=>{r>0&&se(this.statsToReport_,i)&&(t[i]=r,s=!0)}),s&&this.server_.reportStats(t),at(this.reportStats_.bind(this),Math.floor(Math.random()*2*Ah))}}var ee;(function(n){n[n.OVERWRITE=0]="OVERWRITE",n[n.MERGE=1]="MERGE",n[n.ACK_USER_WRITE=2]="ACK_USER_WRITE",n[n.LISTEN_COMPLETE=3]="LISTEN_COMPLETE"})(ee||(ee={}));function as(){return{fromUser:!0,fromServer:!1,queryId:null,tagged:!1}}function ls(){return{fromUser:!1,fromServer:!0,queryId:null,tagged:!1}}function cs(n){return{fromUser:!1,fromServer:!0,queryId:n,tagged:!0}}class $t{constructor(e,t,s){this.path=e,this.affectedTree=t,this.revert=s,this.type=ee.ACK_USER_WRITE,this.source=as()}operationForChild(e){if(v(this.path)){if(this.affectedTree.value!=null)return m(this.affectedTree.children.isEmpty(),"affectedTree should not have overlapping affected paths."),this;{const t=this.affectedTree.subtree(new N(e));return new $t(T(),t,this.revert)}}else return m(C(this.path)===e,"operationForChild called for unrelated child."),new $t(R(this.path),this.affectedTree,this.revert)}}class Et{constructor(e,t){this.source=e,this.path=t,this.type=ee.LISTEN_COMPLETE}operationForChild(e){return v(this.path)?new Et(this.source,T()):new Et(this.source,R(this.path))}}class Oe{constructor(e,t,s){this.source=e,this.path=t,this.snap=s,this.type=ee.OVERWRITE}operationForChild(e){return v(this.path)?new Oe(this.source,T(),this.snap.getImmediateChild(e)):new Oe(this.source,R(this.path),this.snap)}}class Ve{constructor(e,t,s){this.source=e,this.path=t,this.children=s,this.type=ee.MERGE}operationForChild(e){if(v(this.path)){const t=this.children.subtree(new N(e));return t.isEmpty()?null:t.value?new Oe(this.source,T(),t.value):new Ve(this.source,T(),t)}else return m(C(this.path)===e,"Can't get a merge for a child not on the path of the operation"),new Ve(this.source,R(this.path),this.children)}toString(){return"Operation("+this.path+": "+this.source.toString()+" merge: "+this.children.toString()+")"}}class ve{constructor(e,t,s){this.node_=e,this.fullyInitialized_=t,this.filtered_=s}isFullyInitialized(){return this.fullyInitialized_}isFiltered(){return this.filtered_}isCompleteForPath(e){if(v(e))return this.isFullyInitialized()&&!this.filtered_;const t=C(e);return this.isCompleteForChild(t)}isCompleteForChild(e){return this.isFullyInitialized()&&!this.filtered_||this.node_.hasChild(e)}getNode(){return this.node_}}class Dh{constructor(e){this.query_=e,this.index_=this.query_._queryParams.getIndex()}}function kh(n,e,t,s){const i=[],r=[];return e.forEach(o=>{o.type==="child_changed"&&n.index_.indexedValueChanged(o.oldSnap,o.snapshotNode)&&r.push(Sh(o.childName,o.snapshotNode))}),tt(n,i,"child_removed",e,s,t),tt(n,i,"child_added",e,s,t),tt(n,i,"child_moved",r,s,t),tt(n,i,"child_changed",e,s,t),tt(n,i,"value",e,s,t),i}function tt(n,e,t,s,i,r){const o=s.filter(a=>a.type===t);o.sort((a,l)=>Lh(n,a,l)),o.forEach(a=>{const l=Ph(n,a,r);i.forEach(c=>{c.respondsTo(a.type)&&e.push(c.createEvent(l,n.query_))})})}function Ph(n,e,t){return e.type==="value"||e.type==="child_removed"||(e.prevName=t.getPredecessorChildName(e.childName,e.snapshotNode,n.index_)),e}function Lh(n,e,t){if(e.childName==null||t.childName==null)throw Ye("Should only compare child_ events.");const s=new I(e.childName,e.snapshotNode),i=new I(t.childName,t.snapshotNode);return n.index_.compare(s,i)}function nn(n,e){return{eventCache:n,serverCache:e}}function lt(n,e,t,s){return nn(new ve(e,t,s),n.serverCache)}function Tr(n,e,t,s){return nn(n.eventCache,new ve(e,t,s))}function Vt(n){return n.eventCache.isFullyInitialized()?n.eventCache.getNode():null}function De(n){return n.serverCache.isFullyInitialized()?n.serverCache.getNode():null}let Sn;const Mh=()=>(Sn||(Sn=new K(Ec)),Sn);class A{static fromObject(e){let t=new A(null);return U(e,(s,i)=>{t=t.set(new N(s),i)}),t}constructor(e,t=Mh()){this.value=e,this.children=t}isEmpty(){return this.value===null&&this.children.isEmpty()}findRootMostMatchingPathAndValue(e,t){if(this.value!=null&&t(this.value))return{path:T(),value:this.value};if(v(e))return null;{const s=C(e),i=this.children.get(s);if(i!==null){const r=i.findRootMostMatchingPathAndValue(R(e),t);return r!=null?{path:D(new N(s),r.path),value:r.value}:null}else return null}}findRootMostValueAndPath(e){return this.findRootMostMatchingPathAndValue(e,()=>!0)}subtree(e){if(v(e))return this;{const t=C(e),s=this.children.get(t);return s!==null?s.subtree(R(e)):new A(null)}}set(e,t){if(v(e))return new A(t,this.children);{const s=C(e),r=(this.children.get(s)||new A(null)).set(R(e),t),o=this.children.insert(s,r);return new A(this.value,o)}}remove(e){if(v(e))return this.children.isEmpty()?new A(null):new A(null,this.children);{const t=C(e),s=this.children.get(t);if(s){const i=s.remove(R(e));let r;return i.isEmpty()?r=this.children.remove(t):r=this.children.insert(t,i),this.value===null&&r.isEmpty()?new A(null):new A(this.value,r)}else return this}}get(e){if(v(e))return this.value;{const t=C(e),s=this.children.get(t);return s?s.get(R(e)):null}}setTree(e,t){if(v(e))return t;{const s=C(e),r=(this.children.get(s)||new A(null)).setTree(R(e),t);let o;return r.isEmpty()?o=this.children.remove(s):o=this.children.insert(s,r),new A(this.value,o)}}fold(e){return this.fold_(T(),e)}fold_(e,t){const s={};return this.children.inorderTraversal((i,r)=>{s[i]=r.fold_(D(e,i),t)}),t(e,this.value,s)}findOnPath(e,t){return this.findOnPath_(e,T(),t)}findOnPath_(e,t,s){const i=this.value?s(t,this.value):!1;if(i)return i;if(v(e))return null;{const r=C(e),o=this.children.get(r);return o?o.findOnPath_(R(e),D(t,r),s):null}}foreachOnPath(e,t){return this.foreachOnPath_(e,T(),t)}foreachOnPath_(e,t,s){if(v(e))return this;{this.value&&s(t,this.value);const i=C(e),r=this.children.get(i);return r?r.foreachOnPath_(R(e),D(t,i),s):new A(null)}}foreach(e){this.foreach_(T(),e)}foreach_(e,t){this.children.inorderTraversal((s,i)=>{i.foreach_(D(e,s),t)}),this.value&&t(e,this.value)}foreachChild(e){this.children.inorderTraversal((t,s)=>{s.value&&e(t,s.value)})}}class te{constructor(e){this.writeTree_=e}static empty(){return new te(new A(null))}}function ct(n,e,t){if(v(e))return new te(new A(t));{const s=n.writeTree_.findRootMostValueAndPath(e);if(s!=null){const i=s.path;let r=s.value;const o=$(i,e);return r=r.updateChild(o,t),new te(n.writeTree_.set(i,r))}else{const i=new A(t),r=n.writeTree_.setTree(e,i);return new te(r)}}}function Fn(n,e,t){let s=n;return U(t,(i,r)=>{s=ct(s,D(e,i),r)}),s}function li(n,e){if(v(e))return te.empty();{const t=n.writeTree_.setTree(e,new A(null));return new te(t)}}function Wn(n,e){return Pe(n,e)!=null}function Pe(n,e){const t=n.writeTree_.findRootMostValueAndPath(e);return t!=null?n.writeTree_.get(t.path).getChild($(t.path,e)):null}function ci(n){const e=[],t=n.writeTree_.value;return t!=null?t.isLeafNode()||t.forEachChild(k,(s,i)=>{e.push(new I(s,i))}):n.writeTree_.children.inorderTraversal((s,i)=>{i.value!=null&&e.push(new I(s,i.value))}),e}function ye(n,e){if(v(e))return n;{const t=Pe(n,e);return t!=null?new te(new A(t)):new te(n.writeTree_.subtree(e))}}function Gn(n){return n.writeTree_.isEmpty()}function Ke(n,e){return Nr(T(),n.writeTree_,e)}function Nr(n,e,t){if(e.value!=null)return t.updateChild(n,e.value);{let s=null;return e.children.inorderTraversal((i,r)=>{i===".priority"?(m(r.value!==null,"Priority writes must always be leaf nodes"),s=r.value):t=Nr(D(n,i),r,t)}),!t.getChild(n).isEmpty()&&s!==null&&(t=t.updateChild(D(n,".priority"),s)),t}}function sn(n,e){return Dr(e,n)}function xh(n,e,t,s,i){m(s>n.lastWriteId,"Stacking an older write on top of newer ones"),i===void 0&&(i=!0),n.allWrites.push({path:e,snap:t,writeId:s,visible:i}),i&&(n.visibleWrites=ct(n.visibleWrites,e,t)),n.lastWriteId=s}function Bh(n,e,t,s){m(s>n.lastWriteId,"Stacking an older merge on top of newer ones"),n.allWrites.push({path:e,children:t,writeId:s,visible:!0}),n.visibleWrites=Fn(n.visibleWrites,e,t),n.lastWriteId=s}function Fh(n,e){for(let t=0;t<n.allWrites.length;t++){const s=n.allWrites[t];if(s.writeId===e)return s}return null}function Wh(n,e){const t=n.allWrites.findIndex(a=>a.writeId===e);m(t>=0,"removeWrite called with nonexistent writeId.");const s=n.allWrites[t];n.allWrites.splice(t,1);let i=s.visible,r=!1,o=n.allWrites.length-1;for(;i&&o>=0;){const a=n.allWrites[o];a.visible&&(o>=t&&Gh(a,s.path)?i=!1:X(s.path,a.path)&&(r=!0)),o--}if(i){if(r)return Uh(n),!0;if(s.snap)n.visibleWrites=li(n.visibleWrites,s.path);else{const a=s.children;U(a,l=>{n.visibleWrites=li(n.visibleWrites,D(s.path,l))})}return!0}else return!1}function Gh(n,e){if(n.snap)return X(n.path,e);for(const t in n.children)if(n.children.hasOwnProperty(t)&&X(D(n.path,t),e))return!0;return!1}function Uh(n){n.visibleWrites=Rr(n.allWrites,Hh,T()),n.allWrites.length>0?n.lastWriteId=n.allWrites[n.allWrites.length-1].writeId:n.lastWriteId=-1}function Hh(n){return n.visible}function Rr(n,e,t){let s=te.empty();for(let i=0;i<n.length;++i){const r=n[i];if(e(r)){const o=r.path;let a;if(r.snap)X(t,o)?(a=$(t,o),s=ct(s,a,r.snap)):X(o,t)&&(a=$(o,t),s=ct(s,T(),r.snap.getChild(a)));else if(r.children){if(X(t,o))a=$(t,o),s=Fn(s,a,r.children);else if(X(o,t))if(a=$(o,t),v(a))s=Fn(s,T(),r.children);else{const l=Ge(r.children,C(a));if(l){const c=l.getChild(R(a));s=ct(s,T(),c)}}}else throw Ye("WriteRecord should have .snap or .children")}}return s}function Ar(n,e,t,s,i){if(!s&&!i){const r=Pe(n.visibleWrites,e);if(r!=null)return r;{const o=ye(n.visibleWrites,e);if(Gn(o))return t;if(t==null&&!Wn(o,T()))return null;{const a=t||y.EMPTY_NODE;return Ke(o,a)}}}else{const r=ye(n.visibleWrites,e);if(!i&&Gn(r))return t;if(!i&&t==null&&!Wn(r,T()))return null;{const o=function(c){return(c.visible||i)&&(!s||!~s.indexOf(c.writeId))&&(X(c.path,e)||X(e,c.path))},a=Rr(n.allWrites,o,e),l=t||y.EMPTY_NODE;return Ke(a,l)}}}function $h(n,e,t){let s=y.EMPTY_NODE;const i=Pe(n.visibleWrites,e);if(i)return i.isLeafNode()||i.forEachChild(k,(r,o)=>{s=s.updateImmediateChild(r,o)}),s;if(t){const r=ye(n.visibleWrites,e);return t.forEachChild(k,(o,a)=>{const l=Ke(ye(r,new N(o)),a);s=s.updateImmediateChild(o,l)}),ci(r).forEach(o=>{s=s.updateImmediateChild(o.name,o.node)}),s}else{const r=ye(n.visibleWrites,e);return ci(r).forEach(o=>{s=s.updateImmediateChild(o.name,o.node)}),s}}function Vh(n,e,t,s,i){m(s||i,"Either existingEventSnap or existingServerSnap must exist");const r=D(e,t);if(Wn(n.visibleWrites,r))return null;{const o=ye(n.visibleWrites,r);return Gn(o)?i.getChild(t):Ke(o,i.getChild(t))}}function Kh(n,e,t,s){const i=D(e,t),r=Pe(n.visibleWrites,i);if(r!=null)return r;if(s.isCompleteForChild(t)){const o=ye(n.visibleWrites,i);return Ke(o,s.getNode().getImmediateChild(t))}else return null}function zh(n,e){return Pe(n.visibleWrites,e)}function Yh(n,e,t,s,i,r,o){let a;const l=ye(n.visibleWrites,e),c=Pe(l,T());if(c!=null)a=c;else if(t!=null)a=Ke(l,t);else return[];if(a=a.withIndex(o),!a.isEmpty()&&!a.isLeafNode()){const d=[],h=o.getCompare(),u=r?a.getReverseIteratorFrom(s,o):a.getIteratorFrom(s,o);let p=u.getNext();for(;p&&d.length<i;)h(p,s)!==0&&d.push(p),p=u.getNext();return d}else return[]}function jh(){return{visibleWrites:te.empty(),allWrites:[],lastWriteId:-1}}function Kt(n,e,t,s){return Ar(n.writeTree,n.treePath,e,t,s)}function hs(n,e){return $h(n.writeTree,n.treePath,e)}function hi(n,e,t,s){return Vh(n.writeTree,n.treePath,e,t,s)}function zt(n,e){return zh(n.writeTree,D(n.treePath,e))}function qh(n,e,t,s,i,r){return Yh(n.writeTree,n.treePath,e,t,s,i,r)}function us(n,e,t){return Kh(n.writeTree,n.treePath,e,t)}function Or(n,e){return Dr(D(n.treePath,e),n.writeTree)}function Dr(n,e){return{treePath:n,writeTree:e}}class Qh{constructor(){this.changeMap=new Map}trackChildChange(e){const t=e.type,s=e.childName;m(t==="child_added"||t==="child_changed"||t==="child_removed","Only child changes supported for tracking"),m(s!==".priority","Only non-priority child changes can be tracked.");const i=this.changeMap.get(s);if(i){const r=i.type;if(t==="child_added"&&r==="child_removed")this.changeMap.set(s,gt(s,e.snapshotNode,i.snapshotNode));else if(t==="child_removed"&&r==="child_added")this.changeMap.delete(s);else if(t==="child_removed"&&r==="child_changed")this.changeMap.set(s,_t(s,i.oldSnap));else if(t==="child_changed"&&r==="child_added")this.changeMap.set(s,$e(s,e.snapshotNode));else if(t==="child_changed"&&r==="child_changed")this.changeMap.set(s,gt(s,e.snapshotNode,i.oldSnap));else throw Ye("Illegal combination of changes: "+e+" occurred after "+i)}else this.changeMap.set(s,e)}getChanges(){return Array.from(this.changeMap.values())}}class Xh{getCompleteChild(e){return null}getChildAfterChild(e,t,s){return null}}const kr=new Xh;class ds{constructor(e,t,s=null){this.writes_=e,this.viewCache_=t,this.optCompleteServerCache_=s}getCompleteChild(e){const t=this.viewCache_.eventCache;if(t.isCompleteForChild(e))return t.getNode().getImmediateChild(e);{const s=this.optCompleteServerCache_!=null?new ve(this.optCompleteServerCache_,!0,!1):this.viewCache_.serverCache;return us(this.writes_,e,s)}}getChildAfterChild(e,t,s){const i=this.optCompleteServerCache_!=null?this.optCompleteServerCache_:De(this.viewCache_),r=qh(this.writes_,i,t,1,s,e);return r.length===0?null:r[0]}}function Jh(n){return{filter:n}}function Zh(n,e){m(e.eventCache.getNode().isIndexed(n.filter.getIndex()),"Event snap not indexed"),m(e.serverCache.getNode().isIndexed(n.filter.getIndex()),"Server snap not indexed")}function eu(n,e,t,s,i){const r=new Qh;let o,a;if(t.type===ee.OVERWRITE){const c=t;c.source.fromUser?o=Un(n,e,c.path,c.snap,s,i,r):(m(c.source.fromServer,"Unknown source."),a=c.source.tagged||e.serverCache.isFiltered()&&!v(c.path),o=Yt(n,e,c.path,c.snap,s,i,a,r))}else if(t.type===ee.MERGE){const c=t;c.source.fromUser?o=nu(n,e,c.path,c.children,s,i,r):(m(c.source.fromServer,"Unknown source."),a=c.source.tagged||e.serverCache.isFiltered(),o=Hn(n,e,c.path,c.children,s,i,a,r))}else if(t.type===ee.ACK_USER_WRITE){const c=t;c.revert?o=ru(n,e,c.path,s,i,r):o=su(n,e,c.path,c.affectedTree,s,i,r)}else if(t.type===ee.LISTEN_COMPLETE)o=iu(n,e,t.path,s,r);else throw Ye("Unknown operation type: "+t.type);const l=r.getChanges();return tu(e,o,l),{viewCache:o,changes:l}}function tu(n,e,t){const s=e.eventCache;if(s.isFullyInitialized()){const i=s.getNode().isLeafNode()||s.getNode().isEmpty(),r=Vt(n);(t.length>0||!n.eventCache.isFullyInitialized()||i&&!s.getNode().equals(r)||!s.getNode().getPriority().equals(r.getPriority()))&&t.push(wr(Vt(e)))}}function Pr(n,e,t,s,i,r){const o=e.eventCache;if(zt(s,t)!=null)return e;{let a,l;if(v(t))if(m(e.serverCache.isFullyInitialized(),"If change path is empty, we must have complete server data"),e.serverCache.isFiltered()){const c=De(e),d=c instanceof y?c:y.EMPTY_NODE,h=hs(s,d);a=n.filter.updateFullNode(e.eventCache.getNode(),h,r)}else{const c=Kt(s,De(e));a=n.filter.updateFullNode(e.eventCache.getNode(),c,r)}else{const c=C(t);if(c===".priority"){m(Ce(t)===1,"Can't have a priority with additional path components");const d=o.getNode();l=e.serverCache.getNode();const h=hi(s,t,d,l);h!=null?a=n.filter.updatePriority(d,h):a=o.getNode()}else{const d=R(t);let h;if(o.isCompleteForChild(c)){l=e.serverCache.getNode();const u=hi(s,t,o.getNode(),l);u!=null?h=o.getNode().getImmediateChild(c).updateChild(d,u):h=o.getNode().getImmediateChild(c)}else h=us(s,c,e.serverCache);h!=null?a=n.filter.updateChild(o.getNode(),c,h,d,i,r):a=o.getNode()}}return lt(e,a,o.isFullyInitialized()||v(t),n.filter.filtersNodes())}}function Yt(n,e,t,s,i,r,o,a){const l=e.serverCache;let c;const d=o?n.filter:n.filter.getIndexedFilter();if(v(t))c=d.updateFullNode(l.getNode(),s,null);else if(d.filtersNodes()&&!l.isFiltered()){const p=l.getNode().updateChild(t,s);c=d.updateFullNode(l.getNode(),p,null)}else{const p=C(t);if(!l.isCompleteForPath(t)&&Ce(t)>1)return e;const _=R(t),w=l.getNode().getImmediateChild(p).updateChild(_,s);p===".priority"?c=d.updatePriority(l.getNode(),w):c=d.updateChild(l.getNode(),p,w,_,kr,null)}const h=Tr(e,c,l.isFullyInitialized()||v(t),d.filtersNodes()),u=new ds(i,h,r);return Pr(n,h,t,i,u,a)}function Un(n,e,t,s,i,r,o){const a=e.eventCache;let l,c;const d=new ds(i,e,r);if(v(t))c=n.filter.updateFullNode(e.eventCache.getNode(),s,o),l=lt(e,c,!0,n.filter.filtersNodes());else{const h=C(t);if(h===".priority")c=n.filter.updatePriority(e.eventCache.getNode(),s),l=lt(e,c,a.isFullyInitialized(),a.isFiltered());else{const u=R(t),p=a.getNode().getImmediateChild(h);let _;if(v(u))_=s;else{const g=d.getCompleteChild(h);g!=null?ts(u)===".priority"&&g.getChild(yr(u)).isEmpty()?_=g:_=g.updateChild(u,s):_=y.EMPTY_NODE}if(p.equals(_))l=e;else{const g=n.filter.updateChild(a.getNode(),h,_,u,d,o);l=lt(e,g,a.isFullyInitialized(),n.filter.filtersNodes())}}}return l}function ui(n,e){return n.eventCache.isCompleteForChild(e)}function nu(n,e,t,s,i,r,o){let a=e;return s.foreach((l,c)=>{const d=D(t,l);ui(e,C(d))&&(a=Un(n,a,d,c,i,r,o))}),s.foreach((l,c)=>{const d=D(t,l);ui(e,C(d))||(a=Un(n,a,d,c,i,r,o))}),a}function di(n,e,t){return t.foreach((s,i)=>{e=e.updateChild(s,i)}),e}function Hn(n,e,t,s,i,r,o,a){if(e.serverCache.getNode().isEmpty()&&!e.serverCache.isFullyInitialized())return e;let l=e,c;v(t)?c=s:c=new A(null).setTree(t,s);const d=e.serverCache.getNode();return c.children.inorderTraversal((h,u)=>{if(d.hasChild(h)){const p=e.serverCache.getNode().getImmediateChild(h),_=di(n,p,u);l=Yt(n,l,new N(h),_,i,r,o,a)}}),c.children.inorderTraversal((h,u)=>{const p=!e.serverCache.isCompleteForChild(h)&&u.value===null;if(!d.hasChild(h)&&!p){const _=e.serverCache.getNode().getImmediateChild(h),g=di(n,_,u);l=Yt(n,l,new N(h),g,i,r,o,a)}}),l}function su(n,e,t,s,i,r,o){if(zt(i,t)!=null)return e;const a=e.serverCache.isFiltered(),l=e.serverCache;if(s.value!=null){if(v(t)&&l.isFullyInitialized()||l.isCompleteForPath(t))return Yt(n,e,t,l.getNode().getChild(t),i,r,a,o);if(v(t)){let c=new A(null);return l.getNode().forEachChild(We,(d,h)=>{c=c.set(new N(d),h)}),Hn(n,e,t,c,i,r,a,o)}else return e}else{let c=new A(null);return s.foreach((d,h)=>{const u=D(t,d);l.isCompleteForPath(u)&&(c=c.set(d,l.getNode().getChild(u)))}),Hn(n,e,t,c,i,r,a,o)}}function iu(n,e,t,s,i){const r=e.serverCache,o=Tr(e,r.getNode(),r.isFullyInitialized()||v(t),r.isFiltered());return Pr(n,o,t,s,kr,i)}function ru(n,e,t,s,i,r){let o;if(zt(s,t)!=null)return e;{const a=new ds(s,e,i),l=e.eventCache.getNode();let c;if(v(t)||C(t)===".priority"){let d;if(e.serverCache.isFullyInitialized())d=Kt(s,De(e));else{const h=e.serverCache.getNode();m(h instanceof y,"serverChildren would be complete if leaf node"),d=hs(s,h)}d=d,c=n.filter.updateFullNode(l,d,r)}else{const d=C(t);let h=us(s,d,e.serverCache);h==null&&e.serverCache.isCompleteForChild(d)&&(h=l.getImmediateChild(d)),h!=null?c=n.filter.updateChild(l,d,h,R(t),a,r):e.eventCache.getNode().hasChild(d)?c=n.filter.updateChild(l,d,y.EMPTY_NODE,R(t),a,r):c=l,c.isEmpty()&&e.serverCache.isFullyInitialized()&&(o=Kt(s,De(e)),o.isLeafNode()&&(c=n.filter.updateFullNode(c,o,r)))}return o=e.serverCache.isFullyInitialized()||zt(s,T())!=null,lt(e,c,o,n.filter.filtersNodes())}}class ou{constructor(e,t){this.query_=e,this.eventRegistrations_=[];const s=this.query_._queryParams,i=new rs(s.getIndex()),r=bh(s);this.processor_=Jh(r);const o=t.serverCache,a=t.eventCache,l=i.updateFullNode(y.EMPTY_NODE,o.getNode(),null),c=r.updateFullNode(y.EMPTY_NODE,a.getNode(),null),d=new ve(l,o.isFullyInitialized(),i.filtersNodes()),h=new ve(c,a.isFullyInitialized(),r.filtersNodes());this.viewCache_=nn(h,d),this.eventGenerator_=new Dh(this.query_)}get query(){return this.query_}}function au(n){return n.viewCache_.serverCache.getNode()}function lu(n){return Vt(n.viewCache_)}function cu(n,e){const t=De(n.viewCache_);return t&&(n.query._queryParams.loadsAllData()||!v(e)&&!t.getImmediateChild(C(e)).isEmpty())?t.getChild(e):null}function fi(n){return n.eventRegistrations_.length===0}function hu(n,e){n.eventRegistrations_.push(e)}function pi(n,e,t){const s=[];if(t){m(e==null,"A cancel should cancel all event registrations.");const i=n.query._path;n.eventRegistrations_.forEach(r=>{const o=r.createCancelEvent(t,i);o&&s.push(o)})}if(e){let i=[];for(let r=0;r<n.eventRegistrations_.length;++r){const o=n.eventRegistrations_[r];if(!o.matches(e))i.push(o);else if(e.hasAnyCallback()){i=i.concat(n.eventRegistrations_.slice(r+1));break}}n.eventRegistrations_=i}else n.eventRegistrations_=[];return s}function mi(n,e,t,s){e.type===ee.MERGE&&e.source.queryId!==null&&(m(De(n.viewCache_),"We should always have a full cache before handling merges"),m(Vt(n.viewCache_),"Missing event cache, even though we have a server cache"));const i=n.viewCache_,r=eu(n.processor_,i,e,t,s);return Zh(n.processor_,r.viewCache),m(r.viewCache.serverCache.isFullyInitialized()||!i.serverCache.isFullyInitialized(),"Once a server snap is complete, it should never go back"),n.viewCache_=r.viewCache,Lr(n,r.changes,r.viewCache.eventCache.getNode(),null)}function uu(n,e){const t=n.viewCache_.eventCache,s=[];return t.getNode().isLeafNode()||t.getNode().forEachChild(k,(r,o)=>{s.push($e(r,o))}),t.isFullyInitialized()&&s.push(wr(t.getNode())),Lr(n,s,t.getNode(),e)}function Lr(n,e,t,s){const i=s?[s]:n.eventRegistrations_;return kh(n.eventGenerator_,e,t,i)}let jt;class Mr{constructor(){this.views=new Map}}function du(n){m(!jt,"__referenceConstructor has already been defined"),jt=n}function fu(){return m(jt,"Reference.ts has not been loaded"),jt}function pu(n){return n.views.size===0}function fs(n,e,t,s){const i=e.source.queryId;if(i!==null){const r=n.views.get(i);return m(r!=null,"SyncTree gave us an op for an invalid query."),mi(r,e,t,s)}else{let r=[];for(const o of n.views.values())r=r.concat(mi(o,e,t,s));return r}}function xr(n,e,t,s,i){const r=e._queryIdentifier,o=n.views.get(r);if(!o){let a=Kt(t,i?s:null),l=!1;a?l=!0:s instanceof y?(a=hs(t,s),l=!1):(a=y.EMPTY_NODE,l=!1);const c=nn(new ve(a,l,!1),new ve(s,i,!1));return new ou(e,c)}return o}function mu(n,e,t,s,i,r){const o=xr(n,e,s,i,r);return n.views.has(e._queryIdentifier)||n.views.set(e._queryIdentifier,o),hu(o,t),uu(o,t)}function _u(n,e,t,s){const i=e._queryIdentifier,r=[];let o=[];const a=Se(n);if(i==="default")for(const[l,c]of n.views.entries())o=o.concat(pi(c,t,s)),fi(c)&&(n.views.delete(l),c.query._queryParams.loadsAllData()||r.push(c.query));else{const l=n.views.get(i);l&&(o=o.concat(pi(l,t,s)),fi(l)&&(n.views.delete(i),l.query._queryParams.loadsAllData()||r.push(l.query)))}return a&&!Se(n)&&r.push(new(fu())(e._repo,e._path)),{removed:r,events:o}}function Br(n){const e=[];for(const t of n.views.values())t.query._queryParams.loadsAllData()||e.push(t);return e}function Ee(n,e){let t=null;for(const s of n.views.values())t=t||cu(s,e);return t}function Fr(n,e){if(e._queryParams.loadsAllData())return rn(n);{const s=e._queryIdentifier;return n.views.get(s)}}function Wr(n,e){return Fr(n,e)!=null}function Se(n){return rn(n)!=null}function rn(n){for(const e of n.views.values())if(e.query._queryParams.loadsAllData())return e;return null}let qt;function gu(n){m(!qt,"__referenceConstructor has already been defined"),qt=n}function yu(){return m(qt,"Reference.ts has not been loaded"),qt}let Eu=1;class _i{constructor(e){this.listenProvider_=e,this.syncPointTree_=new A(null),this.pendingWriteTree_=jh(),this.tagToQueryMap=new Map,this.queryToTagMap=new Map}}function Gr(n,e,t,s,i){return xh(n.pendingWriteTree_,e,t,s,i),i?Qe(n,new Oe(as(),e,t)):[]}function Cu(n,e,t,s){Bh(n.pendingWriteTree_,e,t,s);const i=A.fromObject(t);return Qe(n,new Ve(as(),e,i))}function me(n,e,t=!1){const s=Fh(n.pendingWriteTree_,e);if(Wh(n.pendingWriteTree_,e)){let r=new A(null);return s.snap!=null?r=r.set(T(),!0):U(s.children,o=>{r=r.set(new N(o),!0)}),Qe(n,new $t(s.path,r,t))}else return[]}function Nt(n,e,t){return Qe(n,new Oe(ls(),e,t))}function vu(n,e,t){const s=A.fromObject(t);return Qe(n,new Ve(ls(),e,s))}function Su(n,e){return Qe(n,new Et(ls(),e))}function Iu(n,e,t){const s=ms(n,t);if(s){const i=_s(s),r=i.path,o=i.queryId,a=$(r,e),l=new Et(cs(o),a);return gs(n,r,l)}else return[]}function Qt(n,e,t,s,i=!1){const r=e._path,o=n.syncPointTree_.get(r);let a=[];if(o&&(e._queryIdentifier==="default"||Wr(o,e))){const l=_u(o,e,t,s);pu(o)&&(n.syncPointTree_=n.syncPointTree_.remove(r));const c=l.removed;if(a=l.events,!i){const d=c.findIndex(u=>u._queryParams.loadsAllData())!==-1,h=n.syncPointTree_.findOnPath(r,(u,p)=>Se(p));if(d&&!h){const u=n.syncPointTree_.subtree(r);if(!u.isEmpty()){const p=Tu(u);for(let _=0;_<p.length;++_){const g=p[_],w=g.query,M=Vr(n,g);n.listenProvider_.startListening(ht(w),Ct(n,w),M.hashFn,M.onComplete)}}}!h&&c.length>0&&!s&&(d?n.listenProvider_.stopListening(ht(e),null):c.forEach(u=>{const p=n.queryToTagMap.get(on(u));n.listenProvider_.stopListening(ht(u),p)}))}Nu(n,c)}return a}function Ur(n,e,t,s){const i=ms(n,s);if(i!=null){const r=_s(i),o=r.path,a=r.queryId,l=$(o,e),c=new Oe(cs(a),l,t);return gs(n,o,c)}else return[]}function bu(n,e,t,s){const i=ms(n,s);if(i){const r=_s(i),o=r.path,a=r.queryId,l=$(o,e),c=A.fromObject(t),d=new Ve(cs(a),l,c);return gs(n,o,d)}else return[]}function $n(n,e,t,s=!1){const i=e._path;let r=null,o=!1;n.syncPointTree_.foreachOnPath(i,(u,p)=>{const _=$(u,i);r=r||Ee(p,_),o=o||Se(p)});let a=n.syncPointTree_.get(i);a?(o=o||Se(a),r=r||Ee(a,T())):(a=new Mr,n.syncPointTree_=n.syncPointTree_.set(i,a));let l;r!=null?l=!0:(l=!1,r=y.EMPTY_NODE,n.syncPointTree_.subtree(i).foreachChild((p,_)=>{const g=Ee(_,T());g&&(r=r.updateImmediateChild(p,g))}));const c=Wr(a,e);if(!c&&!e._queryParams.loadsAllData()){const u=on(e);m(!n.queryToTagMap.has(u),"View does not exist, but we have a tag");const p=Ru();n.queryToTagMap.set(u,p),n.tagToQueryMap.set(p,u)}const d=sn(n.pendingWriteTree_,i);let h=mu(a,e,t,d,r,l);if(!c&&!o&&!s){const u=Fr(a,e);h=h.concat(Au(n,e,u))}return h}function ps(n,e,t){const i=n.pendingWriteTree_,r=n.syncPointTree_.findOnPath(e,(o,a)=>{const l=$(o,e),c=Ee(a,l);if(c)return c});return Ar(i,e,r,t,!0)}function wu(n,e){const t=e._path;let s=null;n.syncPointTree_.foreachOnPath(t,(c,d)=>{const h=$(c,t);s=s||Ee(d,h)});let i=n.syncPointTree_.get(t);i?s=s||Ee(i,T()):(i=new Mr,n.syncPointTree_=n.syncPointTree_.set(t,i));const r=s!=null,o=r?new ve(s,!0,!1):null,a=sn(n.pendingWriteTree_,e._path),l=xr(i,e,a,r?o.getNode():y.EMPTY_NODE,r);return lu(l)}function Qe(n,e){return Hr(e,n.syncPointTree_,null,sn(n.pendingWriteTree_,T()))}function Hr(n,e,t,s){if(v(n.path))return $r(n,e,t,s);{const i=e.get(T());t==null&&i!=null&&(t=Ee(i,T()));let r=[];const o=C(n.path),a=n.operationForChild(o),l=e.children.get(o);if(l&&a){const c=t?t.getImmediateChild(o):null,d=Or(s,o);r=r.concat(Hr(a,l,c,d))}return i&&(r=r.concat(fs(i,n,s,t))),r}}function $r(n,e,t,s){const i=e.get(T());t==null&&i!=null&&(t=Ee(i,T()));let r=[];return e.children.inorderTraversal((o,a)=>{const l=t?t.getImmediateChild(o):null,c=Or(s,o),d=n.operationForChild(o);d&&(r=r.concat($r(d,a,l,c)))}),i&&(r=r.concat(fs(i,n,s,t))),r}function Vr(n,e){const t=e.query,s=Ct(n,t);return{hashFn:()=>(au(e)||y.EMPTY_NODE).hash(),onComplete:i=>{if(i==="ok")return s?Iu(n,t._path,s):Su(n,t._path);{const r=Sc(i,t);return Qt(n,t,null,r)}}}}function Ct(n,e){const t=on(e);return n.queryToTagMap.get(t)}function on(n){return n._path.toString()+"$"+n._queryIdentifier}function ms(n,e){return n.tagToQueryMap.get(e)}function _s(n){const e=n.indexOf("$");return m(e!==-1&&e<n.length-1,"Bad queryKey."),{queryId:n.substr(e+1),path:new N(n.substr(0,e))}}function gs(n,e,t){const s=n.syncPointTree_.get(e);m(s,"Missing sync point for query tag that we're tracking");const i=sn(n.pendingWriteTree_,e);return fs(s,t,i,null)}function Tu(n){return n.fold((e,t,s)=>{if(t&&Se(t))return[rn(t)];{let i=[];return t&&(i=Br(t)),U(s,(r,o)=>{i=i.concat(o)}),i}})}function ht(n){return n._queryParams.loadsAllData()&&!n._queryParams.isDefault()?new(yu())(n._repo,n._path):n}function Nu(n,e){for(let t=0;t<e.length;++t){const s=e[t];if(!s._queryParams.loadsAllData()){const i=on(s),r=n.queryToTagMap.get(i);n.queryToTagMap.delete(i),n.tagToQueryMap.delete(r)}}}function Ru(){return Eu++}function Au(n,e,t){const s=e._path,i=Ct(n,e),r=Vr(n,t),o=n.listenProvider_.startListening(ht(e),i,r.hashFn,r.onComplete),a=n.syncPointTree_.subtree(s);if(i)m(!Se(a.value),"If we're adding a query, it shouldn't be shadowed");else{const l=a.fold((c,d,h)=>{if(!v(c)&&d&&Se(d))return[rn(d).query];{let u=[];return d&&(u=u.concat(Br(d).map(p=>p.query))),U(h,(p,_)=>{u=u.concat(_)}),u}});for(let c=0;c<l.length;++c){const d=l[c];n.listenProvider_.stopListening(ht(d),Ct(n,d))}}return o}class ys{constructor(e){this.node_=e}getImmediateChild(e){const t=this.node_.getImmediateChild(e);return new ys(t)}node(){return this.node_}}class Es{constructor(e,t){this.syncTree_=e,this.path_=t}getImmediateChild(e){const t=D(this.path_,e);return new Es(this.syncTree_,t)}node(){return ps(this.syncTree_,this.path_)}}const Ou=function(n){return n=n||{},n.timestamp=n.timestamp||new Date().getTime(),n},gi=function(n,e,t){if(!n||typeof n!="object")return n;if(m(".sv"in n,"Unexpected leaf node or priority contents"),typeof n[".sv"]=="string")return Du(n[".sv"],e,t);if(typeof n[".sv"]=="object")return ku(n[".sv"],e);m(!1,"Unexpected server value: "+JSON.stringify(n,null,2))},Du=function(n,e,t){if(n==="timestamp")return t.timestamp;m(!1,"Unexpected server value: "+n)},ku=function(n,e,t){n.hasOwnProperty("increment")||m(!1,"Unexpected server value: "+JSON.stringify(n,null,2));const s=n.increment;typeof s!="number"&&m(!1,"Unexpected increment value: "+s);const i=e.node();if(m(i!==null&&typeof i<"u","Expected ChildrenNode.EMPTY_NODE for nulls"),!i.isLeafNode())return s;const o=i.getValue();return typeof o!="number"?s:o+s},Kr=function(n,e,t,s){return Cs(e,new Es(t,n),s)},zr=function(n,e,t){return Cs(n,new ys(e),t)};function Cs(n,e,t){const s=n.getPriority().val(),i=gi(s,e.getImmediateChild(".priority"),t);let r;if(n.isLeafNode()){const o=n,a=gi(o.getValue(),e,t);return a!==o.getValue()||i!==o.getPriority().val()?new F(a,P(i)):n}else{const o=n;return r=o,i!==o.getPriority().val()&&(r=r.updatePriority(new F(i))),o.forEachChild(k,(a,l)=>{const c=Cs(l,e.getImmediateChild(a),t);c!==l&&(r=r.updateImmediateChild(a,c))}),r}}class vs{constructor(e="",t=null,s={children:{},childCount:0}){this.name=e,this.parent=t,this.node=s}}function Ss(n,e){let t=e instanceof N?e:new N(e),s=n,i=C(t);for(;i!==null;){const r=Ge(s.node.children,i)||{children:{},childCount:0};s=new vs(i,s,r),t=R(t),i=C(t)}return s}function Xe(n){return n.node.value}function Yr(n,e){n.node.value=e,Vn(n)}function jr(n){return n.node.childCount>0}function Pu(n){return Xe(n)===void 0&&!jr(n)}function an(n,e){U(n.node.children,(t,s)=>{e(new vs(t,n,s))})}function qr(n,e,t,s){t&&e(n),an(n,i=>{qr(i,e,!0)})}function Lu(n,e,t){let s=n.parent;for(;s!==null;){if(e(s))return!0;s=s.parent}return!1}function Rt(n){return new N(n.parent===null?n.name:Rt(n.parent)+"/"+n.name)}function Vn(n){n.parent!==null&&Mu(n.parent,n.name,n)}function Mu(n,e,t){const s=Pu(t),i=se(n.node.children,e);s&&i?(delete n.node.children[e],n.node.childCount--,Vn(n)):!s&&!i&&(n.node.children[e]=t.node,n.node.childCount++,Vn(n))}const xu=/[\[\].#$\/\u0000-\u001F\u007F]/,Bu=/[\[\].#$\u0000-\u001F\u007F]/,In=10*1024*1024,Is=function(n){return typeof n=="string"&&n.length!==0&&!xu.test(n)},Qr=function(n){return typeof n=="string"&&n.length!==0&&!Bu.test(n)},Fu=function(n){return n&&(n=n.replace(/^\/*\.info(\/|$)/,"/")),Qr(n)},Xr=function(n){return n===null||typeof n=="string"||typeof n=="number"&&!en(n)||n&&typeof n=="object"&&se(n,".sv")},Xt=function(n,e,t,s){s&&e===void 0||ln(Ue(n,"value"),e,t)},ln=function(n,e,t){const s=t instanceof N?new nh(t,n):t;if(e===void 0)throw new Error(n+"contains undefined "+Ne(s));if(typeof e=="function")throw new Error(n+"contains a function "+Ne(s)+" with contents = "+e.toString());if(en(e))throw new Error(n+"contains "+e.toString()+" "+Ne(s));if(typeof e=="string"&&e.length>In/3&&Zt(e)>In)throw new Error(n+"contains a string greater than "+In+" utf8 bytes "+Ne(s)+" ('"+e.substring(0,50)+"...')");if(e&&typeof e=="object"){let i=!1,r=!1;if(U(e,(o,a)=>{if(o===".value")i=!0;else if(o!==".priority"&&o!==".sv"&&(r=!0,!Is(o)))throw new Error(n+" contains an invalid key ("+o+") "+Ne(s)+`.  Keys must be non-empty strings and can't contain ".", "#", "$", "/", "[", or "]"`);sh(s,o),ln(n,a,s),ih(s)}),i&&r)throw new Error(n+' contains ".value" child '+Ne(s)+" in addition to actual children.")}},Wu=function(n,e){let t,s;for(t=0;t<e.length;t++){s=e[t];const r=mt(s);for(let o=0;o<r.length;o++)if(!(r[o]===".priority"&&o===r.length-1)){if(!Is(r[o]))throw new Error(n+"contains an invalid key ("+r[o]+") in path "+s.toString()+`. Keys must be non-empty strings and can't contain ".", "#", "$", "/", "[", or "]"`)}}e.sort(th);let i=null;for(t=0;t<e.length;t++){if(s=e[t],i!==null&&X(i,s))throw new Error(n+"contains a path "+i.toString()+" that is ancestor of another path "+s.toString());i=s}},Jr=function(n,e,t,s){const i=Ue(n,"values");if(!(e&&typeof e=="object")||Array.isArray(e))throw new Error(i+" must be an object containing the children to replace.");const r=[];U(e,(o,a)=>{const l=new N(o);if(ln(i,a,D(t,l)),ts(l)===".priority"&&!Xr(a))throw new Error(i+"contains an invalid value for '"+l.toString()+"', which must be a valid Firebase priority (a string, finite number, server value, or null).");r.push(l)}),Wu(i,r)},Gu=function(n,e,t){if(en(e))throw new Error(Ue(n,"priority")+"is "+e.toString()+", but must be a valid Firebase priority (a string, finite number, server value, or null).");if(!Xr(e))throw new Error(Ue(n,"priority")+"must be a valid Firebase priority (a string, finite number, server value, or null).")},Zr=function(n,e,t,s){if(!Qr(t))throw new Error(Ue(n,e)+'was an invalid path = "'+t+`". Paths must be non-empty strings and can't contain ".", "#", "$", "[", or "]"`)},Uu=function(n,e,t,s){t&&(t=t.replace(/^\/*\.info(\/|$)/,"/")),Zr(n,e,t)},xe=function(n,e){if(C(e)===".info")throw new Error(n+" failed = Can't modify data under /.info/")},Hu=function(n,e){const t=e.path.toString();if(typeof e.repoInfo.host!="string"||e.repoInfo.host.length===0||!Is(e.repoInfo.namespace)&&e.repoInfo.host.split(":")[0]!=="localhost"||t.length!==0&&!Fu(t))throw new Error(Ue(n,"url")+`must be a valid firebase URL and the path can't contain ".", "#", "$", "[", or "]".`)};class $u{constructor(){this.eventLists_=[],this.recursionDepth_=0}}function cn(n,e){let t=null;for(let s=0;s<e.length;s++){const i=e[s],r=i.getPath();t!==null&&!ns(r,t.path)&&(n.eventLists_.push(t),t=null),t===null&&(t={events:[],path:r}),t.events.push(i)}t&&n.eventLists_.push(t)}function eo(n,e,t){cn(n,t),to(n,s=>ns(s,e))}function J(n,e,t){cn(n,t),to(n,s=>X(s,e)||X(e,s))}function to(n,e){n.recursionDepth_++;let t=!0;for(let s=0;s<n.eventLists_.length;s++){const i=n.eventLists_[s];if(i){const r=i.path;e(r)?(Vu(n.eventLists_[s]),n.eventLists_[s]=null):t=!1}}t&&(n.eventLists_=[]),n.recursionDepth_--}function Vu(n){for(let e=0;e<n.events.length;e++){const t=n.events[e];if(t!==null){n.events[e]=null;const s=t.getEventRunner();ot&&G("event: "+t.toString()),je(s)}}}const Ku="repo_interrupt",zu=25;class Yu{constructor(e,t,s,i){this.repoInfo_=e,this.forceRestClient_=t,this.authTokenProvider_=s,this.appCheckProvider_=i,this.dataUpdateCount=0,this.statsListener_=null,this.eventQueue_=new $u,this.nextWriteId_=1,this.interceptServerDataCallback_=null,this.onDisconnect_=Ht(),this.transactionQueueTree_=new vs,this.persistentConnection_=null,this.key=this.repoInfo_.toURLString()}toString(){return(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host}}function ju(n,e,t){if(n.stats_=Zn(n.repoInfo_),n.forceRestClient_||Tc())n.server_=new Ut(n.repoInfo_,(s,i,r,o)=>{yi(n,s,i,r,o)},n.authTokenProvider_,n.appCheckProvider_),setTimeout(()=>Ei(n,!0),0);else{if(typeof t<"u"&&t!==null){if(typeof t!="object")throw new Error("Only objects are supported for option databaseAuthVariableOverride");try{B(t)}catch(s){throw new Error("Invalid authOverride provided: "+s)}}n.persistentConnection_=new oe(n.repoInfo_,e,(s,i,r,o)=>{yi(n,s,i,r,o)},s=>{Ei(n,s)},s=>{qu(n,s)},n.authTokenProvider_,n.appCheckProvider_,t),n.server_=n.persistentConnection_}n.authTokenProvider_.addTokenChangeListener(s=>{n.server_.refreshAuthToken(s)}),n.appCheckProvider_.addTokenChangeListener(s=>{n.server_.refreshAppCheckToken(s.token)}),n.statsReporter_=Dc(n.repoInfo_,()=>new Oh(n.stats_,n.server_)),n.infoData_=new wh,n.infoSyncTree_=new _i({startListening:(s,i,r,o)=>{let a=[];const l=n.infoData_.getNode(s._path);return l.isEmpty()||(a=Nt(n.infoSyncTree_,s._path,l),setTimeout(()=>{o("ok")},0)),a},stopListening:()=>{}}),bs(n,"connected",!1),n.serverSyncTree_=new _i({startListening:(s,i,r,o)=>(n.server_.listen(s,r,i,(a,l)=>{const c=o(a,l);J(n.eventQueue_,s._path,c)}),[]),stopListening:(s,i)=>{n.server_.unlisten(s,i)}})}function no(n){const t=n.infoData_.getNode(new N(".info/serverTimeOffset")).val()||0;return new Date().getTime()+t}function hn(n){return Ou({timestamp:no(n)})}function yi(n,e,t,s,i){n.dataUpdateCount++;const r=new N(e);t=n.interceptServerDataCallback_?n.interceptServerDataCallback_(e,t):t;let o=[];if(i)if(s){const l=Lt(t,c=>P(c));o=bu(n.serverSyncTree_,r,l,i)}else{const l=P(t);o=Ur(n.serverSyncTree_,r,l,i)}else if(s){const l=Lt(t,c=>P(c));o=vu(n.serverSyncTree_,r,l)}else{const l=P(t);o=Nt(n.serverSyncTree_,r,l)}let a=r;o.length>0&&(a=ze(n,r)),J(n.eventQueue_,a,o)}function Ei(n,e){bs(n,"connected",e),e===!1&&Zu(n)}function qu(n,e){U(e,(t,s)=>{bs(n,t,s)})}function bs(n,e,t){const s=new N("/.info/"+e),i=P(t);n.infoData_.updateSnapshot(s,i);const r=Nt(n.infoSyncTree_,s,i);J(n.eventQueue_,s,r)}function ws(n){return n.nextWriteId_++}function Qu(n,e,t){const s=wu(n.serverSyncTree_,e);return s!=null?Promise.resolve(s):n.server_.get(e).then(i=>{const r=P(i).withIndex(e._queryParams.getIndex());$n(n.serverSyncTree_,e,t,!0);let o;if(e._queryParams.loadsAllData())o=Nt(n.serverSyncTree_,e._path,r);else{const a=Ct(n.serverSyncTree_,e);o=Ur(n.serverSyncTree_,e._path,r,a)}return J(n.eventQueue_,e._path,o),Qt(n.serverSyncTree_,e,t,null,!0),r},i=>(At(n,"get for query "+B(e)+" failed: "+i),Promise.reject(new Error(i))))}function Xu(n,e,t,s,i){At(n,"set",{path:e.toString(),value:t,priority:s});const r=hn(n),o=P(t,s),a=ps(n.serverSyncTree_,e),l=zr(o,a,r),c=ws(n),d=Gr(n.serverSyncTree_,e,l,c,!0);cn(n.eventQueue_,d),n.server_.put(e.toString(),o.val(!0),(u,p)=>{const _=u==="ok";_||V("set at "+e+" failed: "+u);const g=me(n.serverSyncTree_,c,!_);J(n.eventQueue_,e,g),Ie(n,i,u,p)});const h=Ns(n,e);ze(n,h),J(n.eventQueue_,h,[])}function Ju(n,e,t,s){At(n,"update",{path:e.toString(),value:t});let i=!0;const r=hn(n),o={};if(U(t,(a,l)=>{i=!1,o[a]=Kr(D(e,a),P(l),n.serverSyncTree_,r)}),i)G("update() called with empty data.  Don't do anything."),Ie(n,s,"ok",void 0);else{const a=ws(n),l=Cu(n.serverSyncTree_,e,o,a);cn(n.eventQueue_,l),n.server_.merge(e.toString(),t,(c,d)=>{const h=c==="ok";h||V("update at "+e+" failed: "+c);const u=me(n.serverSyncTree_,a,!h),p=u.length>0?ze(n,e):e;J(n.eventQueue_,p,u),Ie(n,s,c,d)}),U(t,c=>{const d=Ns(n,D(e,c));ze(n,d)}),J(n.eventQueue_,e,[])}}function Zu(n){At(n,"onDisconnectEvents");const e=hn(n),t=Ht();Bn(n.onDisconnect_,T(),(i,r)=>{const o=Kr(i,r,n.serverSyncTree_,e);qe(t,i,o)});let s=[];Bn(t,T(),(i,r)=>{s=s.concat(Nt(n.serverSyncTree_,i,r));const o=Ns(n,i);ze(n,o)}),n.onDisconnect_=Ht(),J(n.eventQueue_,T(),s)}function ed(n,e,t){n.server_.onDisconnectCancel(e.toString(),(s,i)=>{s==="ok"&&xn(n.onDisconnect_,e),Ie(n,t,s,i)})}function Ci(n,e,t,s){const i=P(t);n.server_.onDisconnectPut(e.toString(),i.val(!0),(r,o)=>{r==="ok"&&qe(n.onDisconnect_,e,i),Ie(n,s,r,o)})}function td(n,e,t,s,i){const r=P(t,s);n.server_.onDisconnectPut(e.toString(),r.val(!0),(o,a)=>{o==="ok"&&qe(n.onDisconnect_,e,r),Ie(n,i,o,a)})}function nd(n,e,t,s){if(Nn(t)){G("onDisconnect().update() called with empty data.  Don't do anything."),Ie(n,s,"ok",void 0);return}n.server_.onDisconnectMerge(e.toString(),t,(i,r)=>{i==="ok"&&U(t,(o,a)=>{const l=P(a);qe(n.onDisconnect_,D(e,o),l)}),Ie(n,s,i,r)})}function sd(n,e,t){let s;C(e._path)===".info"?s=$n(n.infoSyncTree_,e,t):s=$n(n.serverSyncTree_,e,t),eo(n.eventQueue_,e._path,s)}function id(n,e,t){let s;C(e._path)===".info"?s=Qt(n.infoSyncTree_,e,t):s=Qt(n.serverSyncTree_,e,t),eo(n.eventQueue_,e._path,s)}function rd(n){n.persistentConnection_&&n.persistentConnection_.interrupt(Ku)}function At(n,...e){let t="";n.persistentConnection_&&(t=n.persistentConnection_.id+":"),G(t,...e)}function Ie(n,e,t,s){e&&je(()=>{if(t==="ok")e(null);else{const i=(t||"error").toUpperCase();let r=i;s&&(r+=": "+s);const o=new Error(r);o.code=i,e(o)}})}function so(n,e,t){return ps(n.serverSyncTree_,e,t)||y.EMPTY_NODE}function Ts(n,e=n.transactionQueueTree_){if(e||un(n,e),Xe(e)){const t=ro(n,e);m(t.length>0,"Sending zero length transaction queue"),t.every(i=>i.status===0)&&od(n,Rt(e),t)}else jr(e)&&an(e,t=>{Ts(n,t)})}function od(n,e,t){const s=t.map(c=>c.currentWriteId),i=so(n,e,s);let r=i;const o=i.hash();for(let c=0;c<t.length;c++){const d=t[c];m(d.status===0,"tryToSendTransactionQueue_: items in queue should all be run."),d.status=1,d.retryCount++;const h=$(e,d.path);r=r.updateChild(h,d.currentOutputSnapshotRaw)}const a=r.val(!0),l=e;n.server_.put(l.toString(),a,c=>{At(n,"transaction put response",{path:l.toString(),status:c});let d=[];if(c==="ok"){const h=[];for(let u=0;u<t.length;u++)t[u].status=2,d=d.concat(me(n.serverSyncTree_,t[u].currentWriteId)),t[u].onComplete&&h.push(()=>t[u].onComplete(null,!0,t[u].currentOutputSnapshotResolved)),t[u].unwatcher();un(n,Ss(n.transactionQueueTree_,e)),Ts(n,n.transactionQueueTree_),J(n.eventQueue_,e,d);for(let u=0;u<h.length;u++)je(h[u])}else{if(c==="datastale")for(let h=0;h<t.length;h++)t[h].status===3?t[h].status=4:t[h].status=0;else{V("transaction at "+l.toString()+" failed: "+c);for(let h=0;h<t.length;h++)t[h].status=4,t[h].abortReason=c}ze(n,e)}},o)}function ze(n,e){const t=io(n,e),s=Rt(t),i=ro(n,t);return ad(n,i,s),s}function ad(n,e,t){if(e.length===0)return;const s=[];let i=[];const o=e.filter(a=>a.status===0).map(a=>a.currentWriteId);for(let a=0;a<e.length;a++){const l=e[a],c=$(t,l.path);let d=!1,h;if(m(c!==null,"rerunTransactionsUnderNode_: relativePath should not be null."),l.status===4)d=!0,h=l.abortReason,i=i.concat(me(n.serverSyncTree_,l.currentWriteId,!0));else if(l.status===0)if(l.retryCount>=zu)d=!0,h="maxretry",i=i.concat(me(n.serverSyncTree_,l.currentWriteId,!0));else{const u=so(n,l.path,o);l.currentInputSnapshot=u;const p=e[a].update(u.val());if(p!==void 0){ln("transaction failed: Data returned ",p,l.path);let _=P(p);typeof p=="object"&&p!=null&&se(p,".priority")||(_=_.updatePriority(u.getPriority()));const w=l.currentWriteId,M=hn(n),E=zr(_,u,M);l.currentOutputSnapshotRaw=_,l.currentOutputSnapshotResolved=E,l.currentWriteId=ws(n),o.splice(o.indexOf(w),1),i=i.concat(Gr(n.serverSyncTree_,l.path,E,l.currentWriteId,l.applyLocally)),i=i.concat(me(n.serverSyncTree_,w,!0))}else d=!0,h="nodata",i=i.concat(me(n.serverSyncTree_,l.currentWriteId,!0))}J(n.eventQueue_,t,i),i=[],d&&(e[a].status=2,(function(u){setTimeout(u,Math.floor(0))})(e[a].unwatcher),e[a].onComplete&&(h==="nodata"?s.push(()=>e[a].onComplete(null,!1,e[a].currentInputSnapshot)):s.push(()=>e[a].onComplete(new Error(h),!1,null))))}un(n,n.transactionQueueTree_);for(let a=0;a<s.length;a++)je(s[a]);Ts(n,n.transactionQueueTree_)}function io(n,e){let t,s=n.transactionQueueTree_;for(t=C(e);t!==null&&Xe(s)===void 0;)s=Ss(s,t),e=R(e),t=C(e);return s}function ro(n,e){const t=[];return oo(n,e,t),t.sort((s,i)=>s.order-i.order),t}function oo(n,e,t){const s=Xe(e);if(s)for(let i=0;i<s.length;i++)t.push(s[i]);an(e,i=>{oo(n,i,t)})}function un(n,e){const t=Xe(e);if(t){let s=0;for(let i=0;i<t.length;i++)t[i].status!==2&&(t[s]=t[i],s++);t.length=s,Yr(e,t.length>0?t:void 0)}an(e,s=>{un(n,s)})}function Ns(n,e){const t=Rt(io(n,e)),s=Ss(n.transactionQueueTree_,e);return Lu(s,i=>{bn(n,i)}),bn(n,s),qr(s,i=>{bn(n,i)}),t}function bn(n,e){const t=Xe(e);if(t){const s=[];let i=[],r=-1;for(let o=0;o<t.length;o++)t[o].status===3||(t[o].status===1?(m(r===o-1,"All SENT items should be at beginning of queue."),r=o,t[o].status=3,t[o].abortReason="set"):(m(t[o].status===0,"Unexpected transaction status in abort"),t[o].unwatcher(),i=i.concat(me(n.serverSyncTree_,t[o].currentWriteId,!0)),t[o].onComplete&&s.push(t[o].onComplete.bind(null,new Error("set"),!1,null))));r===-1?Yr(e,void 0):t.length=r+1,J(n.eventQueue_,Rt(e),i);for(let o=0;o<s.length;o++)je(s[o])}}function ld(n){let e="";const t=n.split("/");for(let s=0;s<t.length;s++)if(t[s].length>0){let i=t[s];try{i=decodeURIComponent(i.replace(/\+/g," "))}catch{}e+="/"+i}return e}function cd(n){const e={};n.charAt(0)==="?"&&(n=n.substring(1));for(const t of n.split("&")){if(t.length===0)continue;const s=t.split("=");s.length===2?e[decodeURIComponent(s[0])]=decodeURIComponent(s[1]):V(`Invalid query segment '${t}' in query '${n}'`)}return e}const vi=function(n,e){const t=hd(n),s=t.namespace;t.domain==="firebase.com"&&ce(t.host+" is no longer supported. Please use <YOUR FIREBASE>.firebaseio.com instead"),(!s||s==="undefined")&&t.domain!=="localhost"&&ce("Cannot parse Firebase url. Please use https://<YOUR FIREBASE>.firebaseio.com"),t.secure||gc();const i=t.scheme==="ws"||t.scheme==="wss";return{repoInfo:new cr(t.host,t.secure,s,i,e,"",s!==t.subdomain),path:new N(t.pathString)}},hd=function(n){let e="",t="",s="",i="",r="",o=!0,a="https",l=443;if(typeof n=="string"){let c=n.indexOf("//");c>=0&&(a=n.substring(0,c-1),n=n.substring(c+2));let d=n.indexOf("/");d===-1&&(d=n.length);let h=n.indexOf("?");h===-1&&(h=n.length),e=n.substring(0,Math.min(d,h)),d<h&&(i=ld(n.substring(d,h)));const u=cd(n.substring(Math.min(n.length,h)));c=e.indexOf(":"),c>=0?(o=a==="https"||a==="wss",l=parseInt(e.substring(c+1),10)):c=e.length;const p=e.slice(0,c);if(p.toLowerCase()==="localhost")t="localhost";else if(p.split(".").length<=2)t=p;else{const _=e.indexOf(".");s=e.substring(0,_).toLowerCase(),t=e.substring(_+1),r=s}"ns"in u&&(r=u.ns)}return{host:e,port:l,domain:t,subdomain:s,secure:o,scheme:a,pathString:i,namespace:r}};const Si="-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz",ud=(function(){let n=0;const e=[];return function(t){const s=t===n;n=t;let i;const r=new Array(8);for(i=7;i>=0;i--)r[i]=Si.charAt(t%64),t=Math.floor(t/64);m(t===0,"Cannot push at time == 0");let o=r.join("");if(s){for(i=11;i>=0&&e[i]===63;i--)e[i]=0;e[i]++}else for(i=0;i<12;i++)e[i]=Math.floor(Math.random()*64);for(i=0;i<12;i++)o+=Si.charAt(e[i]);return m(o.length===20,"nextPushId: Length should be 20."),o}})();class dd{constructor(e,t,s,i){this.eventType=e,this.eventRegistration=t,this.snapshot=s,this.prevName=i}getPath(){const e=this.snapshot.ref;return this.eventType==="value"?e._path:e.parent._path}getEventType(){return this.eventType}getEventRunner(){return this.eventRegistration.getEventRunner(this)}toString(){return this.getPath().toString()+":"+this.eventType+":"+B(this.snapshot.exportVal())}}class fd{constructor(e,t,s){this.eventRegistration=e,this.error=t,this.path=s}getPath(){return this.path}getEventType(){return"cancel"}getEventRunner(){return this.eventRegistration.getEventRunner(this)}toString(){return this.path.toString()+":cancel"}}class ao{constructor(e,t){this.snapshotCallback=e,this.cancelCallback=t}onValue(e,t){this.snapshotCallback.call(null,e,t)}onCancel(e){return m(this.hasCancelCallback,"Raising a cancel event on a listener with no cancel callback"),this.cancelCallback.call(null,e)}get hasCancelCallback(){return!!this.cancelCallback}matches(e){return this.snapshotCallback===e.snapshotCallback||this.snapshotCallback.userCallback!==void 0&&this.snapshotCallback.userCallback===e.snapshotCallback.userCallback&&this.snapshotCallback.context===e.snapshotCallback.context}}class pd{constructor(e,t){this._repo=e,this._path=t}cancel(){const e=new ne;return ed(this._repo,this._path,e.wrapCallback(()=>{})),e.promise}remove(){xe("OnDisconnect.remove",this._path);const e=new ne;return Ci(this._repo,this._path,null,e.wrapCallback(()=>{})),e.promise}set(e){xe("OnDisconnect.set",this._path),Xt("OnDisconnect.set",e,this._path,!1);const t=new ne;return Ci(this._repo,this._path,e,t.wrapCallback(()=>{})),t.promise}setWithPriority(e,t){xe("OnDisconnect.setWithPriority",this._path),Xt("OnDisconnect.setWithPriority",e,this._path,!1),Gu("OnDisconnect.setWithPriority",t);const s=new ne;return td(this._repo,this._path,e,t,s.wrapCallback(()=>{})),s.promise}update(e){xe("OnDisconnect.update",this._path),Jr("OnDisconnect.update",e,this._path);const t=new ne;return nd(this._repo,this._path,e,t.wrapCallback(()=>{})),t.promise}}class Rs{constructor(e,t,s,i){this._repo=e,this._path=t,this._queryParams=s,this._orderByCalled=i}get key(){return v(this._path)?null:ts(this._path)}get ref(){return new de(this._repo,this._path)}get _queryIdentifier(){const e=oi(this._queryParams),t=Xn(e);return t==="{}"?"default":t}get _queryObject(){return oi(this._queryParams)}isEqual(e){if(e=we(e),!(e instanceof Rs))return!1;const t=this._repo===e._repo,s=ns(this._path,e._path),i=this._queryIdentifier===e._queryIdentifier;return t&&s&&i}toJSON(){return this.toString()}toString(){return this._repo.toString()+eh(this._path)}}class de extends Rs{constructor(e,t){super(e,t,new os,!1)}get parent(){const e=yr(this._path);return e===null?null:new de(this._repo,e)}get root(){let e=this;for(;e.parent!==null;)e=e.parent;return e}}class vt{constructor(e,t,s){this._node=e,this.ref=t,this._index=s}get priority(){return this._node.getPriority().val()}get key(){return this.ref.key}get size(){return this._node.numChildren()}child(e){const t=new N(e),s=St(this.ref,e);return new vt(this._node.getChild(t),s,k)}exists(){return!this._node.isEmpty()}exportVal(){return this._node.val(!0)}forEach(e){return this._node.isLeafNode()?!1:!!this._node.forEachChild(this._index,(s,i)=>e(new vt(i,St(this.ref,s),k)))}hasChild(e){const t=new N(e);return!this._node.getChild(t).isEmpty()}hasChildren(){return this._node.isLeafNode()?!1:!this._node.isEmpty()}toJSON(){return this.exportVal()}val(){return this._node.val()}}function z(n,e){return n=we(n),n._checkNotDeleted("ref"),e!==void 0?St(n._root,e):n._root}function St(n,e){return n=we(n),C(n._path)===null?Uu("child","path",e):Zr("child","path",e),new de(n._repo,D(n._path,e))}function Ii(n){return n=we(n),new pd(n._repo,n._path)}function md(n,e){n=we(n),xe("push",n._path),Xt("push",e,n._path,!0);const t=no(n._repo),s=ud(t),i=St(n,s),r=St(n,s);let o;return o=Promise.resolve(r),i.then=o.then.bind(o),i.catch=o.then.bind(o,void 0),i}function wn(n,e){n=we(n),xe("set",n._path),Xt("set",e,n._path,!1);const t=new ne;return Xu(n._repo,n._path,e,null,t.wrapCallback(()=>{})),t.promise}function pe(n,e){Jr("update",e,n._path);const t=new ne;return Ju(n._repo,n._path,e,t.wrapCallback(()=>{})),t.promise}function bi(n){n=we(n);const e=new ao(()=>{}),t=new dn(e);return Qu(n._repo,n,t).then(s=>new vt(s,new de(n._repo,n._path),n._queryParams.getIndex()))}class dn{constructor(e){this.callbackContext=e}respondsTo(e){return e==="value"}createEvent(e,t){const s=t._queryParams.getIndex();return new dd("value",this,new vt(e.snapshotNode,new de(t._repo,t._path),s))}getEventRunner(e){return e.getEventType()==="cancel"?()=>this.callbackContext.onCancel(e.error):()=>this.callbackContext.onValue(e.snapshot,null)}createCancelEvent(e,t){return this.callbackContext.hasCancelCallback?new fd(this,e,t):null}matches(e){return e instanceof dn?!e.callbackContext||!this.callbackContext?!0:e.callbackContext.matches(this.callbackContext):!1}hasAnyCallback(){return this.callbackContext!==null}}function _d(n,e,t,s,i){const r=new ao(t,void 0),o=new dn(r);return sd(n._repo,n,o),()=>id(n._repo,n,o)}function gd(n,e,t,s){return _d(n,"value",e)}du(de);gu(de);const yd="FIREBASE_DATABASE_EMULATOR_HOST",Kn={};let Ed=!1;function Cd(n,e,t,s){const i=e.lastIndexOf(":"),r=e.substring(0,i),o=qn(r);n.repoInfo_=new cr(e,o,n.repoInfo_.namespace,n.repoInfo_.webSocketOnly,n.repoInfo_.nodeAdmin,n.repoInfo_.persistenceKey,n.repoInfo_.includeNamespaceInQueryParams,!0,t),s&&(n.authTokenProvider_=s)}function vd(n,e,t,s,i){let r=s||n.options.databaseURL;r===void 0&&(n.options.projectId||ce("Can't determine Firebase Database URL. Be sure to include  a Project ID when calling firebase.initializeApp()."),G("Using default host for project ",n.options.projectId),r=`${n.options.projectId}-default-rtdb.firebaseio.com`);let o=vi(r,i),a=o.repoInfo,l;typeof process<"u"&&Hs&&(l=Hs[yd]),l?(r=`http://${l}?ns=${a.namespace}`,o=vi(r,i),a=o.repoInfo):o.repoInfo.secure;const c=new Rc(n.name,n.options,e);Hu("Invalid Firebase Database URL",o),v(o.path)||ce("Database URL must point to the root of a Firebase Database (not including a child path).");const d=Id(a,n,c,new Nc(n,t));return new bd(d,n)}function Sd(n,e){const t=Kn[e];(!t||t[n.key]!==n)&&ce(`Database ${e}(${n.repoInfo_}) has already been deleted.`),rd(n),delete t[n.key]}function Id(n,e,t,s){let i=Kn[e.name];i||(i={},Kn[e.name]=i);let r=i[n.toURLString()];return r&&ce("Database initialized multiple times. Please make sure the format of the database URL matches with each database() call."),r=new Yu(n,Ed,t,s),i[n.toURLString()]=r,r}class bd{constructor(e,t){this._repoInternal=e,this.app=t,this.type="database",this._instanceStarted=!1}get _repo(){return this._instanceStarted||(ju(this._repoInternal,this.app.options.appId,this.app.options.databaseAuthVariableOverride),this._instanceStarted=!0),this._repoInternal}get _root(){return this._rootInternal||(this._rootInternal=new de(this._repo,T())),this._rootInternal}_delete(){return this._rootInternal!==null&&(Sd(this._repo,this.app.name),this._repoInternal=null,this._rootInternal=null),Promise.resolve()}_checkNotDeleted(e){this._rootInternal===null&&ce("Cannot call "+e+" on a deleted database.")}}function wd(n=Jl(),e){const t=Yl(n,"database").getImmediate({identifier:e});if(!t._instanceStarted){const s=ka("database");s&&Td(t,...s)}return t}function Td(n,e,t,s={}){n=we(n),n._checkNotDeleted("useEmulator");const i=`${e}:${t}`,r=n._repoInternal;if(n._instanceStarted){if(i===n._repoInternal.repoInfo_.host&&Mt(s,r.repoInfo_.emulatorOptions))return;ce("connectDatabaseEmulator() cannot initialize or alter the emulator configuration after the database instance has started.")}let o;if(r.repoInfo_.nodeAdmin)s.mockUserToken&&ce('mockUserToken is not supported by the Admin SDK. For client access with mock users, please use the "firebase" package instead of "firebase-admin".'),o=new kt(kt.OWNER);else if(s.mockUserToken){const a=typeof s.mockUserToken=="string"?s.mockUserToken:La(s.mockUserToken,n.app.options.projectId);o=new kt(a)}qn(e)&&(Pa(e),Ba("Database",!0)),Cd(r,i,s,o)}function Nd(n){uc(Xl),Bt(new dt("database",(e,{instanceIdentifier:t})=>{const s=e.getProvider("app").getImmediate(),i=e.getProvider("auth-internal"),r=e.getProvider("app-check-internal");return vd(s,i,r,t)},"PUBLIC").setMultipleInstances(!0)),Be($s,Vs,n),Be($s,Vs,"esm2020")}oe.prototype.simpleListen=function(n,e){this.sendRequest("q",{p:n},e)};oe.prototype.echo=function(n,e){this.sendRequest("echo",{d:n},e)};Nd();const Rd={apiKey:"AIzaSyDhDhpFMVbXOq04J2jZkGrfjeovdTT6U2o",authDomain:"tiny-towns-multiplayer.firebaseapp.com",databaseURL:"https://tiny-towns-multiplayer-default-rtdb.europe-west1.firebasedatabase.app",projectId:"tiny-towns-multiplayer",storageBucket:"tiny-towns-multiplayer.firebasestorage.app",messagingSenderId:"374830147876",appId:"1:374830147876:web:93ffbe5825d8d3af982bb1"},Ad=zi(Rd),Y=wd(Ad);class Od{gameId=null;playerId;isHost=!1;localGame;masterBuilderId=null;myName="Unknown";currentRound=1;onStateChange=null;onGameStart=null;constructor(e){this.localGame=e,this.playerId="player_"+Math.random().toString(36).substr(2,9)}async createGame(e,t){const s=z(Y,"games"),i=md(s);this.gameId=i.key,this.isHost=!0,this.myName=e;const r={status:"LOBBY",hostId:this.playerId,deck:t,currentResource:null,masterBuilderIndex:0,roundNumber:1,playerOrder:[this.playerId],players:{[this.playerId]:{name:e,score:0,isReady:!0,placedRound:0,isGameOver:!1,board:this.serializeBoard()}}};return await wn(i,r),this.subscribeToGame(),Ii(i).remove(),this.gameId}async joinGame(e,t){const s=z(Y,`games/${e}`);if(!(await bi(s)).exists())throw new Error("Game not found");this.gameId=e,this.isHost=!1,this.myName=t;const r=z(Y,`games/${e}/players/${this.playerId}`);await wn(r,{name:t,score:0,isReady:!0,placedRound:0,isGameOver:!1,board:this.serializeBoard()});const o=z(Y,`games/${e}/playerOrder`),l=(await bi(o)).val()||[];l.includes(this.playerId)||(l.push(this.playerId),await wn(o,l)),Ii(r).remove(),this.subscribeToGame()}async startGame(){!this.isHost||!this.gameId||await pe(z(Y,`games/${this.gameId}`),{status:"PLAYING"})}async updateDeck(e){!this.isHost||!this.gameId||await pe(z(Y,`games/${this.gameId}`),{deck:e})}subscribeToGame(){if(!this.gameId)return;const e=z(Y,`games/${this.gameId}`);gd(e,t=>{const s=t.val();if(!s)return;s.status==="PLAYING"&&this.localGame.gameRegistry.length===0&&(this.syncDeck(s.deck),this.onGameStart&&this.onGameStart());const i=s.playerOrder||[],r=Array.isArray(i)?i:Object.values(i);if(r.length>0){const o=(s.masterBuilderIndex||0)%r.length;this.masterBuilderId=r[o]}s.currentResource===void 0||s.currentResource===""?this.localGame.currentResource=null:this.localGame.currentResource=s.currentResource,this.currentRound=s.roundNumber||1,this.onStateChange&&this.onStateChange(s),this.isHost&&s.status==="PLAYING"&&setTimeout(()=>this.checkTurnComplete(s),10)})}async setGlobalResource(e){if(!this.gameId||this.playerId!==this.masterBuilderId)return;const t={};t[`games/${this.gameId}/currentResource`]=e,await pe(z(Y),t)}async commitTurn(){if(!this.gameId)return;const e={},t=`games/${this.gameId}/players/${this.playerId}`;e[`${t}/board`]=this.serializeBoard(),e[`${t}/score`]=this.localGame.getScore().total,e[`${t}/placedRound`]=this.currentRound,await pe(z(Y),e)}async saveBoardOnly(){if(!this.gameId)return;console.log("Saving board state (Turn not finished)...");const e={},t=`games/${this.gameId}/players/${this.playerId}`;e[`${t}/board`]=this.serializeBoard(),e[`${t}/score`]=this.localGame.getScore().total,await pe(z(Y),e)}async declareGameOver(){if(!this.gameId)return;const e={},t=`games/${this.gameId}/players/${this.playerId}`;e[`${t}/isGameOver`]=!0,e[`${t}/placedRound`]=this.currentRound,await pe(z(Y),e),this.isHost&&setTimeout(()=>{},10)}async checkTurnComplete(e){if(!e||!e.players)return;const t=Object.values(e.players),s=e.roundNumber||1,i=e.playerOrder||[];if(t.every(u=>u.isGameOver===!0)){e.status!=="FINISHED"&&(console.log("GAME OVER FOR EVERYONE"),await pe(z(Y,`games/${this.gameId}`),{status:"FINISHED"}));return}const o=e.currentResource!==void 0&&e.currentResource!==null,a=t.every(u=>u.placedRound===s||u.isGameOver===!0),l=(e.masterBuilderIndex||0)%i.length,c=i[l],d=e.players[c]&&e.players[c].isGameOver;let h=!1;if(o&&a?(console.log(`Round ${s} Complete. Rotating.`),h=!0):!o&&d&&(console.log("Current Master Builder is finished. Skipping their turn."),h=!0),h){let u=e.masterBuilderIndex||0,p=!1;for(let g=1;g<=i.length;g++){const w=(u+g)%i.length,M=i[w],E=e.players[M];if(E&&!E.isGameOver){u=u+g,p=!0;break}}p||u++;const _={};_[`games/${this.gameId}/currentResource`]=null,_[`games/${this.gameId}/masterBuilderIndex`]=u,_[`games/${this.gameId}/roundNumber`]=s+1,await pe(z(Y),_)}}syncDeck(e){e&&(this.localGame.gameRegistry=it.filter(t=>e.includes(t.name)),this.localGame.scanForMatches())}serializeBoard(){return this.localGame.board.getGrid()}}const L=new Ca,he=new va,H=new Od(L);let ae=null,fn=[],nt="",Jt=!1,wi=!1,zn="";const S={startModal:document.getElementById("start-screen-modal"),landingUI:document.getElementById("landing-ui"),lobbyUI:document.getElementById("lobby-ui"),playerNameInput:document.getElementById("player-name-input"),createGameBtn:document.getElementById("create-game-ui-btn"),joinGameBtn:document.getElementById("join-game-btn"),gameIdInput:document.getElementById("game-id-input"),shareCodeDisplay:document.getElementById("share-code-display"),lobbyPlayerList:document.getElementById("lobby-player-list"),hostSettings:document.getElementById("host-settings"),guestWaitingMsg:document.getElementById("guest-waiting-msg"),startGameBtn:document.getElementById("start-game-btn"),multiplayerResultsModal:document.getElementById("multiplayer-results-modal"),leaderboardList:document.getElementById("leaderboard-list"),mpRestartBtn:document.getElementById("mp-restart-btn"),opponentsSidebar:document.getElementById("opponents-sidebar"),opponentsList:document.getElementById("opponents-list"),copyLinkBtn:document.getElementById("copy-link-btn"),monumentGrid:document.getElementById("monument-pattern-grid"),monumentDesc:document.getElementById("monument-desc"),gameOverModal:document.getElementById("game-over-modal"),finalScore:document.getElementById("final-score"),scoreList:document.getElementById("score-breakdown-list"),restartBtn:document.getElementById("restart-btn"),undoBtn:document.getElementById("undo-btn")},As=[{id:"RED",label:"Farm (Red)",options:Ri},{id:"GRAY",label:"Well (Gray)",options:Ai},{id:"YELLOW",label:"Theater (Yellow)",options:Di},{id:"GREEN",label:"Tavern (Green)",options:Oi},{id:"ORANGE",label:"Chapel (Orange)",options:Pi},{id:"BLACK",label:"Factory (Black)",options:ki},{id:"PURPLE",label:"Monument",options:it.filter(n=>n.isMonument)}];H.onStateChange=n=>{try{if(n.status==="LOBBY"&&kd(n.players),n.status==="PLAYING"){S.startModal.classList.contains("hidden")||(S.startModal.classList.add("hidden"),ue(),he.renderDeck(L.gameRegistry)),n.players&&Wd(n.players,n.roundNumber||1);let e="Unknown";const t=n.playerOrder||[],s=Array.isArray(t)?t:Object.values(t);if(s.length>0&&n.players){const l=(n.masterBuilderIndex||0)%s.length,c=s[l];n.players[c]&&(e=n.players[c].name)}const i=H.masterBuilderId===H.playerId,r=n.currentResource!==void 0&&n.currentResource!==null,o=n.roundNumber||1,a=n.players?n.players[H.playerId]:null;a&&(Jt=Number(a.placedRound)===Number(o)),r?Jt?(nt="Waiting for other players to finish placing...",st(!1)):(nt="",st(!1)):i?(nt="YOU are the Master Builder! Choose a resource.",st(!0)):(nt=`Waiting for ${e} to choose a resource...`,st(!1))}n.status==="FINISHED"&&(S.gameOverModal.classList.add("hidden"),Fd(n.players),S.multiplayerResultsModal.classList.remove("hidden")),L.currentResource=n.currentResource||null,ue()}catch(e){console.error("Error in onStateChange:",e)}};H.onGameStart=()=>{S.startModal.classList.add("hidden"),ue(),he.renderDeck(L.gameRegistry)};he.onResourceSelect=n=>{console.log("Clicked resource:",n),console.log("Current game state resource:",L.currentResource),!ae&&(L.currentResource?console.log("Blocked: Resource already active:",L.currentResource):(console.log("Sending request to set resource..."),H.setGlobalResource(n)))};he.onCellClick=(n,e)=>{try{ae?Ld(n,e):Dd(n,e)}catch(t){j(t.message,"error")}};he.onSwapClick=Md;async function Dd(n,e){if(Jt){j("You have already placed a resource this turn!","error");return}if(!L.currentResource){j("Waiting for Master Builder...","info");return}try{L.placeResource(n,e),await H.commitTurn(),ue(),fo()}catch(t){j(t.message,"error")}}he.onBuildClick=n=>{ae=n,fn=xd(n),ue()};he.onCancelClick=()=>{ho(),ue()};S.undoBtn.onclick=()=>{j("Undo not yet supported in Multiplayer!","info")};S.mpRestartBtn.onclick=()=>{location.reload()};S.createGameBtn.onclick=async()=>{const n=S.playerNameInput.value||"Host";try{const e=co(),t=await H.createGame(n,e.map(s=>s.name));lo(t,!0)}catch(e){console.error("Firebase Error:",e),j("Error creating game. Check console for details.","error")}};S.joinGameBtn.onclick=async()=>{const n=S.playerNameInput.value||"Guest",e=S.gameIdInput.value.trim();if(!e){j("Please enter a code!","error");return}try{await H.joinGame(e,n),lo(e,!1)}catch(t){j("Could not join game: "+t,"error")}};S.startGameBtn.onclick=async()=>{const n=Pd();await H.updateDeck(n.map(e=>e.name)),await H.startGame()};S.shareCodeDisplay.onclick=()=>{const n=S.shareCodeDisplay.innerText.replace("Code: ","");navigator.clipboard.writeText(n),j("Code copied!","success")};S.restartBtn.onclick=()=>{location.reload()};S.copyLinkBtn.onclick=()=>{if(!zn)return;const n=`${window.location.origin}${window.location.pathname}?gameId=${zn}`;navigator.clipboard.writeText(n).then(()=>{j("Invite Link copied!","success")})};function lo(n,e){zn=n,S.landingUI.classList.add("hidden"),S.lobbyUI.classList.remove("hidden"),S.shareCodeDisplay.innerText=`Code: ${n}`,e?(S.hostSettings.classList.remove("hidden"),S.guestWaitingMsg.classList.add("hidden"),Bd()):(S.hostSettings.classList.add("hidden"),S.guestWaitingMsg.classList.remove("hidden"))}function kd(n){S.lobbyPlayerList.innerHTML="<strong>Players:</strong><br>",Object.values(n).forEach(e=>{const t=document.createElement("div");t.textContent=` ${e.name}`,S.lobbyPlayerList.appendChild(t)})}function Pd(){const n=[Yn],e=document.querySelectorAll(".setup-select");return e.length===0?co():(e.forEach(t=>{const s=t.dataset.category;if(!s)return;const i=As.find(o=>o.id===s);if(!i)return;let r;t.value==="RANDOM"?r=uo(i.options):r=i.options.find(o=>o.name===t.value),r&&n.push(r)}),n)}function co(){const n=[Yn];return As.forEach(e=>{n.push(uo(e.options))}),n}function Ld(n,e){const s=L.board.getGrid()[n][e],i=fn.some(c=>c.row===n&&c.col===e),r=ae?ae.buildingName.toUpperCase():"",l=(L.hasObeliskAbility()||r==="SHED")&&s==="NONE";if(i||l){if(s&&s.toUpperCase().replace("_"," ")==="TRADING POST"){j("Cannot build on Trading Post.","error");return}const c=L.constructBuilding(ae,n,e);H.saveBoardOnly(),c.type==="TRIGGER_EFFECT"&&c.effectType==="FACTORY"&&po("Setup Factory","Choose a resource to store permanently on your Factory:",d=>{L.setBuildingStorage(n,e,d),H.saveBoardOnly(),ue()}),ho(),ue(),fo()}}function Md(){po("Factory Swap","Select the resource you want to use this turn:",async n=>{const e=L.currentResource;L.currentResource=n,j(`Factory activated! Swapped ${e} for ${n}.`,"success"),ue()})}function ho(){ae=null,fn=[]}function xd(n){const e=[];return n.pattern.forEach((t,s)=>{t.forEach((i,r)=>{i!=="NONE"&&e.push({row:n.row+s,col:n.col+r})})}),e}function uo(n){return n[Math.floor(Math.random()*n.length)]}function ue(){let n=!1;if(L.currentResource&&!Jt){const e=H.masterBuilderId===H.playerId,t=L.canFactorySwap(L.currentResource);!e&&t&&(n=!0)}he.toggleFactoryAction(n,L.currentResource||""),he.render(L,ae,fn,nt)}function fo(){if(!wi&&L.checkGameOver()&&!ae){const n=L.getScore();S.finalScore.textContent=n.total.toString(),S.scoreList.innerHTML="",Object.entries(n.breakdown).forEach(([e,t])=>{t!==0&&Ti(e,t)}),n.penaltyCount>0&&Ti("Empty Spaces",-n.penaltyCount,!0),S.gameOverModal.classList.remove("hidden"),H.declareGameOver(),wi=!0,st(!1)}}function Ti(n,e,t=!1){const s=document.createElement("li");s.className="score-item",t&&(s.classList.add("penalty-text"),s.style.color="#ef5350"),s.style.display="flex",s.style.justifyContent="space-between",s.innerHTML=`<span>${n.toLowerCase()}</span><strong>${e}</strong>`,S.scoreList.appendChild(s)}function Bd(){const n=document.getElementById("setup-container");n.innerHTML="";const e=document.createElement("div");e.className="setup-grid",As.forEach(t=>{const s=document.createElement("div");s.className="setup-group";const i=document.createElement("label");i.className="setup-label",i.textContent=t.label,s.appendChild(i);const r=document.createElement("select");r.className=`setup-select ${t.id}`,r.dataset.category=t.id;const o=document.createElement("option");o.value="RANDOM",o.textContent="Random",r.appendChild(o),t.options.forEach(a=>{const l=document.createElement("option");l.value=a.name,l.textContent=a.name,r.appendChild(l)}),s.appendChild(r),e.appendChild(s)}),n.appendChild(e)}function st(n){const e=document.getElementById("resource-palette");e&&(n?(e.style.opacity="1",e.style.pointerEvents="auto"):(e.style.opacity="0.5",e.style.pointerEvents="none"))}function Fd(n){S.leaderboardList.innerHTML="",Object.values(n).sort((t,s)=>s.score-t.score).forEach((t,s)=>{const i=document.createElement("li");i.className="leaderboard-row",s===0&&i.classList.add("winner");const r=s+1;i.innerHTML=`
            <div style="display:flex; align-items:center;">
                <div class="rank-badge">${r}</div>
                <div class="player-info">
                    <span class="player-name">${t.name}</span>
                    <span class="player-details">
                        ${t.isGameOver?"Finished":"Playing"} 
                    </span>
                </div>
            </div>
            <div class="final-total">${t.score}</div>
        `,S.leaderboardList.appendChild(i)})}function j(n,e="info"){const t=document.getElementById("toast-container");if(!t)return;const s=document.createElement("div");s.className=`toast ${e}`,s.textContent=n,t.appendChild(s),setTimeout(()=>{s.remove()},4e3)}function Wd(n,e){S.opponentsSidebar.classList.remove("hidden"),S.opponentsList.innerHTML="",Object.keys(n).forEach(t=>{if(t===H.playerId)return;const s=n[t],i=s.placedRound===e||s.isGameOver,r=i?"done":"thinking",o=document.createElement("div");o.className="opponent-card";const a=document.createElement("div");a.className="opponent-name",a.innerHTML=`
            ${s.name}
            <span class="status-dot ${r}" title="${i?"Waiting":"Thinking"}"></span>
        `,o.appendChild(a);const l=document.createElement("div");l.className="mini-board",s.board&&Array.isArray(s.board)&&s.board.forEach(c=>{c.forEach(d=>{const h=document.createElement("div");h.className="mini-cell",d!=="NONE"&&(["WOOD","WHEAT","BRICK","GLASS","STONE"].includes(d)?h.classList.add(d):(h.classList.add(d),h.title=d,["COTTAGE","FARM","GRANARY","GREENHOUSE","ORCHARD","WELL","FOUNTAIN","MILLSTONE","SHED","CHAPEL","ABBEY","CLOISTER","TEMPLE","TAVERN","ALMSHOUSE","INN","FEAST-HALL","THEATER","BAKERY","TAILOR","MARKET","FACTORY","BANK","WAREHOUSE","TRADING-POST"].includes(d)||h.classList.add("MONUMENT"))),l.appendChild(h)})}),o.appendChild(l),S.opponentsList.appendChild(o)})}function po(n,e,t){const s=document.getElementById("resource-picker-modal"),i=document.getElementById("picker-title"),r=document.getElementById("picker-message"),o=document.getElementById("picker-options");i.textContent=n,r.textContent=e,o.innerHTML="",["WOOD","WHEAT","BRICK","GLASS","STONE"].forEach(l=>{const c=document.createElement("div");c.className=`res-btn ${l}`,c.onclick=()=>{s.classList.add("hidden"),t(l)},o.appendChild(c)}),s.classList.remove("hidden")}(function(){const t=new URLSearchParams(window.location.search).get("gameId");t&&(console.log("Invite code detected:",t),S.gameIdInput.value=t,S.playerNameInput.focus(),j(`Invite code ${t} detected! Enter your name to join.`,"success"),S.createGameBtn.parentElement?.classList.add("hidden"))})();
